define("dropbox",["modules/core/controller_registry","modules/clean/browse_interface","modules/clean/react/previews/preview_linkfile","modules/clean/base64","modules/clean/previews/file_view_rams_common","modules/core/uri","modules/clean/file_events","modules/clean/previews/preview_actions_helper","modules/clean/em_string","modules/core/exception","libs","modules/clean/uirequest","modules/clean/history","modules/clean/sharing/shared_link_modal","external/underscore","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","external/swfobject","modules/clean/display_format","modules/clean/search/search_helpers","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/notifications/file_watcher","modules/clean/previews/pdf_loader","modules/constants/viewer","modules/clean/sharing/sharing_constants","modules/clean/sharing/get_editable_link_prompt","modules/clean/people/experiments/link_profile_service_modal","modules/clean/account/email","modules/clean/dbmodal","modules/clean/events/rollback","external/backbone","modules/clean/react/previews/preview_image_zoom","modules/clean/sharing/api","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/components/role_picker","external/plupload_dev","modules/clean/react/previews/preview_video","external/keymaster","modules/clean/image_size","modules/clean/viewer","modules/constants/python","modules/clean/sprite","modules/clean/dbmodal_loading","modules/clean/undo","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/video_util","modules/clean/react/previews/preview_flippable","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/activity/comment_count_bubble","modules/clean/db_bubble","external/flash_detect","external/purify","modules/clean/sharing/share_inband","modules/core/visibility","modules/dirty/react/file_viewer/controller","modules/constants/env","modules/clean/sharing/shared_folder_settings_modal","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","external/modernizr","modules/clean/teams/team_folder_modal","modules/clean/components/ajax_form","modules/clean/react/invite/invite_form_react","modules/clean/browse_events","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/core/i18n","modules/constants/request","modules/clean/top_notif","modules/core/dom","modules/clean/web_timing_logger","modules/clean/payments/credit_card_util","modules/clean/react/previews/preview_image","modules/clean/form","modules/core/cookies","modules/clean/clipboard","modules/clean/payments/cash","modules/clean/browse/browse_drag_utils","modules/clean/account/email_verify_reasons","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/search/search_type","external/jquery_ui","modules/clean/contacts/cache","modules/clean/frame_messenger","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/filepath","modules/core/html","modules/clean/static_urls"],function(bX,fi,bI,ak,bV,G,aH,m,bU,eb,cl,by,eD,aI,bx,cE,b8,ah,c3,aF,ap,z,fk,aa,ax,a9,d0,B,b,cX,c8,at,ek,di,e6,an,ed,eq,dn,p,a7,e3,ai,cM,aX,cx,cD,X,cR,az,bO,b6,bt,M,W,dC,c2,a5,aC,eX,c0,dP,bc,e0,fj,ae,bF,a0,bA,d,dW,ch,ab,dN,cq,o,da,bl,aK,cv,C,eg,e5,cz,bb,bw,t,dS,cN,er,aY,c4,eC,eG,eo,et,ba,bs,b1,H,aA,fg,aN){var E={};var S=bI.PreviewLinkfile;var cP=m.LegacyFilePreviewActions;var eV=m.LegacyFileViewerActions;var ca=eb.alertd;var cL=eb.assert;var eM=eb.reportException;var eN=eb.stackTrace;var dl=z.Job;var eB=z.ModalProgress;var cy=b.LinkProfileServiceModal;var av=cX.ChangeEmail;var d4=cX.EmailVerification;var d7=c8.DBModal;var d1=c8.DBModalStack;var dm=c8.DBUserModal;var aW=di.PreviewImageZoom;var bm=e6.SharingApi;var cr=e6.UserlessSharingApi;var d2=dn.RolePickerState;var ej=a7.PreviewVideo;var aG=ai.image_best_fit_size;var bP=cR.NotServer;var d8=cR.NotClients;var d5=M.PreviewFlippable;var c7=a5.CommentCountBubbleFactory;var dM=cq.SimpleModal;var bk=da.LinkedProfileServices;var ea=da.ProfileServicesLinkingHandler;var bd=bl.ungettext;var eA=bl._;var dI=bl.N_;var F=bl.E_;var e9=bl.render_sentences;var e7=cv.TopNotificationBar;var eP=cv.EUCookieNotificationBar;var r=cv.ExpiredIOSNotificationBar;var ef=cv.PackratUnlimitedOptInNotificationBar;var ci=cv.DfBAdminEarlyAccessSharingControlsBar;var ce=cv.DfBAdminEarlyAccessFtsBar;var aR=cv.LocaleSwitchBar;var eY=cv.SuperInactiveRecoverBar;var x=cz.PreviewImage;var bj=dS.Cash;var fe=dS.CashUtil;var dJ=aY.HierarchicalNavBar;var ff=c4.DfBTransitionInfoFetcher;var cK=eo.ContactsCache;var b0=eo.DefaultContactsCache;var eh,e4,de;INLINE_JS.$=$;INLINE_JS.$u=bx;Function.prototype.defer=Function.prototype.defer.wrap(function(j){var i;i=$A(arguments).slice(1);this.__tb__=eN();return j.apply(this,i)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(T){var j,fl,i;j=$A(arguments).slice(1);try{return T.apply(this,j)}catch(i){fl=i;return cL(0,fl.toString())}});eh=E.Jcached={cache:{},set:function(j,T,i){var fl;fl=eh.cache[j];if(fl==null){fl=eh.cache[j]={}}fl.value=T;return fl.expires=i?new Date().getTime()+i:0},get:function(i){var j;j=eh.cache[i];if((j==null)||new Date().getTime()>j.expires){delete eh.cache[i];return false}return j.value}};Function.prototype.cached=function(i){var T,j;j=Math.random();T=this;return function(){var fl;fl=eh.get(j);if(fl!==false){return fl}fl=T();eh.set(j,fl,i);return fl}};Array.prototype.sort_by_key=function(j,T){var i;if(T==null){T=false}i=T?-1:1;return this.sort(function(fl,fm){fl=j(fl);fm=j(fm);if(fl<fm){return i*-1}else{if(fl>fm){return i*1}else{return 0}}})};Array.prototype.contains=function(i){return this.indexOf(i)!==-1};Array.prototype.remove=function(j,i){i=i||j+1;return this.splice(j,i-j)};Array.prototype.removeItem=function(j){var i;i=this.indexOf(j);if(i>=0){return this.remove(i)}else{return false}};Array.prototype.dict_by=function(fl){var fo,fp,fn,T,fm;fm={};for(fo=fn=0,T=this.length;fn<T;fo=++fn){fp=this[fo];fm[this[fo][fl]]=this[fo]}return fm};Array.prototype.unique=function(){var fn,fm,T,i,fl;fn={};for(T=0,i=this.length;T<i;T++){fm=this[T];if(typeof fm!=="string"){return this}fn[fm]=0}fl=[];for(fm in fn){fl.push(fm)}return fl};String.prototype.widthSplit=function(fl){var i,T,j,fm;if(fl==null){fl=15}i=[];T=this;fm=0;j=T.substring(fm,fm+fl);while(j!==""){i.push(j);fm+=fl;j=T.substring(fm,fm+fl)}return i};Object.extend(Effect.Transitions,{EaseIn:function(i){return Math.pow(i,2)},EaseOut:function(i){return Math.pow(i,0.5)}});(function(T){var i,j;j=function(fq){var fl,ft,fn,fm,fp,fo,fs,fr,fu;if(fq){if(Object.isArray(fq)){fl=[];for(fn=0,fp=fq.length;fn<fp;fn++){ft=fq[fn];fl.push(fg.escape(ft).toHTML())}fq=new fg(fl.join(""))}else{if(fq.top||fq.bottom||fq.before||fq.after){fr=["top","bottom","before","after"];for(fm=0,fo=fr.length;fm<fo;fm++){fs=fr[fm];fu=fq[fs];if(fu){fq[fs]=arguments.callee(fu)}}}else{if(d6.isElm(fq)||fq.toElement||fq.toHTML){}else{fq=fg.escape(fq)}}}}return fq};return Element.addMethods({db_observe:function(fm,fl,fn){return fm.observe(fl,function(fo){return fn(fo,fm)})},smoothScrollIntoView:function(fo,fn){var fs,fm,fl,fr,fq,fp;if(fn==null){fn={}}fs={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};fn=Object.extend(fs,fn);fl=fo.viewportOffset(fo);fm=fo.getDimensions();fp=document.viewport.getDimensions();fq=fn.padding||0;if(fl.top>fq&&(fl.top+fm.height)<(fp.height-fq)){return}fr=fl.top<fq?-1*Math.floor(fp.height/4):-1*Math.floor(3*fp.height/4);fn.offset=fn.offset||fr;return new Effect.ScrollTo(fo,fn)},__sert:function(fl,fm){return Element.insert(fl,j(fm))},__date:function(fl,fm){return Element.update(fl,j(fm))},replace:i=function(fl,fm){return T(fl,j(fm))}})})(Element.replace);e4=function(i){if(i!=null?i.target:void 0){try{return document.activeElement=i.target===document?null:i.target}catch(j){}}};de=function(i){try{return document.activeElement=null}catch(j){}};if(document.addEventListener){document.addEventListener("focus",e4,true);document.addEventListener("blur",de,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(j,i){var T;if(i==null){i="0"}T=this;while(T.length<j){T=i+T}return T.toString()};String.prototype.reverse=function(){var T,j,i;i=this.split("");j=i.reverse();T=j.join("");return T};String.prototype.count=function(i){return(this.length-this.gsub(i,"").length)/i.length};String.prototype.repeat=function(i){return(new Array(i+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,fn,fl){var fu,fs,fx,fw,fz,fy,fp,T,i,fv,fq,fm,fo,ft,fr;if(fl==null){fl={}}this.orig_req={url:fn,options:fl};this.start_time=b6.time();fl.method=fl.method||"post";fl.evalJS=false;fl.suppress_nonstandard_headers=true;fl.parameters=fl.parameters||{};fl.parameters.t=bw.read(aK.JS_CSRF_COOKIE);fl.parameters.is_xhr=true;if(fl.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fl.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fl.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fl.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fl.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&fn.indexOf("/")===0){fl.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fl.parameters.restrict=Ajax.DBRequest.restrict}fs=fl.cleanUp||(function(){});this.subject_user=fl.subject_user||fl.job_user;if(fl.job){this.job_id=d6.nonce();fl.parameters.job_id=this.job_id;ec.watch(this,fl.dont_hide_progress_on_complete)}if(!fl.no_watch){ar.watch(this,!!fl.job)}fv=fl.onFailure;fq=fl.onSuccess;i=fl.onComplete;T=(function(j){return function(fB){var fA,fC;if(fl.parameters.xhr_retry||!fl.allow_retries){return false}if((fA=fB.status)===0||fA===500||fA===502||fA===503){j.orig_req.options.parameters.xhr_retry=true;j.orig_req.options.onFailure=fv;j.orig_req.options.onSuccess=fq;fC=new Ajax.DBRequest(j.orig_req.url,j.orig_req.options);return true}return false}})(this);fl.onFailure=function(fB){var fC,fA,j;if(dl.handled(fB.request.job_id)){return}if(T(fB)){return}if(!fl.noAutonotify){if(!Constants.IS_PROD&&fB.status===500&&fB.getHeader("X-Debug-Url")){fn=fB.getHeader("X-Debug-Url");fC=eA("There was a problem completing this request.")+(' <a href="'+fn+'" target="_blank">View debug</a>');ah.error(new fg(fC))}else{ah.error()}}fs(false);if(fv){fv(fB)}if(fB.status===403){j=d6.session_storage_get("reload-timestamp");if(!j||b6.time()-j>30*1000){d6.session_storage_set("reload-timestamp",b6.time());location.reload(true)}}return cL(fl.noAutonotify||((fA=fB.status)===403||fA===404||fA===502),"Ajax "+fB.status+" on "+fB.request.url)};fl.onComplete=(function(j){return function(fA){if(fA.responseText.length&&i){if(fA.responseText.indexOf("async_task_started:")!==0){return i(fA)}}}})(this);fl.onSuccess=(function(j){return function(fA){var fB,fK,fQ,fS,fJ,fO,fP,fD,fM,fC,fE,fI,fL,fG,fN,fR,fH,fF;fF=b6.time()-fA.request.start_time;if(dl.handled(fA.request.job_id)){return}if(!fA.responseText.length){if(!fl.job){if(T(fA)){return}if(!fl.noAutonotify){if(!fA||fA.status!==0){ah.error()}}if(fv){fv(fA)}}}else{if(fA.responseText.indexOf("err:")===0){if(!fl.noAutonotify){fD=fA.responseText.substr(4);if(fl.html_in_error_msg){fD=new fg(fD)}ah.error(fD)}if(fv){fv(fA)}}else{if(fA.responseText.indexOf("async_task_started:")===0){j.async_task_id=fA.responseText.split(":")[1];ec.watch(j)}else{if(fq){if(fA.responseText.indexOf("ok:")===0){ah.success(fA.responseText.substr(3))}fq(fA)}}fH=fA.getHeader("X-Server-Response-Time")||"-1";if(fl.log_timing){eg.log_ajax_transition.defer(fF,void 0,void 0,void 0,fH,fn=be.absolutize(j.url))}fK=bF("#cprofile");if(!fl.no_watch&&fK.length){fG=Constants.REQUEST_ID+"-"+(fA.getHeader("X-Dropbox-Request-Id"));fn=fA.request.url.replace(/[^\/]*\/\/[^\/]+/,"").replace(/\?.*$/,"");fC={request_id:fG};fL=fA.request.url;if(fL.indexOf(Constants.BLOCK_CLUSTER)!==-1){fC.block=1}else{fE=Constants.BATCH_THUMB_ENDPOINTS;for(fO=0,fP=fE.length;fO<fP;fO++){fJ=fE[fO];if(fL.indexOf(fJ)!==-1){fC.block=1;break}}}fB=function(fY,fW,fV,fX){var fU,fT;if(fX){fU=bF('<a target="_blank" />')}else{fU=bF("<a />")}fT=fU.attr("href",String(G({authority:Constants.WEBSERVER,path:fW,query:fV}))).text(fY+" ");return fT};fM=[["svg","/profile/cprofile/svg",true],["pstats","/profile/cprofile/pstats",false],["callgrind","/profile/cprofile/callgrind",false],["IO","/profile/ioprofile",true],["DB","/profile/dbprofile",true]];fR=(function(){var fT,fU,fV;fV=[];for(fT=0,fU=fM.length;fT<fU;fT++){fQ=fM[fT];fV.push(fB(fQ[0],fQ[1],fC,fQ[2]))}return fV})();fN=bF('<div class="ajax">').text("Ajax: "+fn+" ("+fH+"ms)").prepend(fR);fS=fK.find(".ajax");if(fS.length>=10){fS.last().remove()}fK.prepend(fN)}if(bF("#gandalf_panel").length&&fA.request.url.substring(0,14)!=="/gandalf_panel"){if((fI=window.gandalf_panel)!=null){fI.add(fA.request.url,fA.getHeader("X-Dropbox-Request-Id"))}}}}return fs(true)}})(this);fl.onException=function(fA,fB){var fC,j;if(window.console){throw fB}fC=("Error with AJAX callback for: "+fn+" :::: ")+fB.toString();j=eN();j.pop();return eM(fC,b1.get_href(),"",j.join("\n"))};if(fl.job){fn+=(fn.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fl.subject_user&&!((fo=fl.parameters)!=null?fo[a9.UID_PARAM_NAME]:void 0)){fn=G.parse(fn).updateQuery(a9.UID_PARAM_NAME,fl.subject_user).toString()}fu=$H({url:fn});if(fl.parameters){fu.update(fl.parameters);ft=fu.keys();for(fx=0,fy=ft.length;fx<fy;fx++){fz=ft[fx];fr=["passwd","password","oauth","ccn","host_id"];for(fw=0,fp=fr.length;fw<fp;fw++){fm=fr[fw];if(fz.indexOf(fm)!==-1){fu.unset(fz)}}}fu.unset("t")}fl.onSuccess.__tb_ajax_info__=fl.onFailure.__tb_ajax_info__=Object.toJSON(fu);return $super(fn,fl)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(d6.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cF=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bF;if(!Function.prototype.bind){Function.prototype.bind=function(i){var fm,fl,j,T;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fm=Array.prototype.slice.call(arguments,1);T=this;j=function(){};fl=function(){return T.apply((this instanceof j&&i?this:i),fm.concat(Array.prototype.slice.call(arguments)))};j.prototype=this.prototype;fl.prototype=new j();return fl}}jQuery.fn.curry=function(){var i,T,j;T=arguments[0],j=arguments[1],i=3<=arguments.length?cF.call(arguments,2):[];if(j==null){j=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var fl;fl=1<=arguments.length?cF.call(arguments,0):[];return T.apply(j,cF.call(i).concat(cF.call(fl)))}};jQuery.fn.stripTags=function(i){if(typeof monkey_check==="function"){monkey_check()}return i.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return C.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(j,i){if(typeof monkey_check==="function"){monkey_check()}C.clone_position(this,j,i);return this};jQuery.format=function(j,i){if(typeof monkey_check==="function"){monkey_check()}return j.replace(/\{([^}]+)\}/g,function(fl,T){if(T in i){return i[T]}else{return fl}})};jQuery.cachedScript=function(j,i){if(typeof monkey_check==="function"){monkey_check()}i=bF.extend(i||{},{dataType:"script",cache:true,url:j});return jQuery.ajax(i)};jQuery.browser=b1;jQuery.addSubjectParam=function(T,i){var j;if(typeof monkey_check==="function"){monkey_check()}if(T.subject_user&&!((j=T.data)!=null?j[a9.UID_PARAM_NAME]:void 0)){return i[a9.UID_PARAM_NAME]=String(T.subject_user)}};jQuery.ajaxPrefilter(function(i,fl,T){var j;if(!fl.noDropboxDefaults){j={t:bw.read(aK.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(fl,j);if(jQuery.ajaxSettings.restrict!=null){j.restrict=jQuery.ajaxSettings.restrict}i.data=bF.param(bF.extend(fl.data,j),true);return false}});jQuery.ajax.retryOnce=function(fl,i,j){var T;if(typeof monkey_check==="function"){monkey_check()}if(i!=="abort"&&((T=fl.status)===0||T===500||T===502||T===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var eI,dj,be,d6,dA;d6=INLINE_JS.Util=E.Util={scroll_to_thumb:function(i){var fm,fl,T,j;fl=i.cumulativeOffset().top;fm=i.getHeight();j=C.scroll_offsets().top;T=C.viewport_dimensions().height;if(fl<j||fl+fm>j+T){return C.scroll_to(0,fl-T/2)}},decode_sort_key:function(T){var fn,fl,i,fm;fm=[];for(fl=0,i=T.length;fl<i;fl++){fn=T[fl];if(typeof fn==="string"){fm.push(ak.decode(fn))}else{fm.push(fn)}}return fm},sort_by_rank_or_key:function(i,j){if((i.sort_rank!=null)&&(j.sort_rank!=null)){return i.sort_rank-j.sort_rank}cL((i.sort_key!=null)&&(j.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(i,j)},sort_by_key:function(i,j){return this._sort_by_key(i,j)},_sort_by_key:function(fl,fq){var fo,fn,fp,T,fm;T=fl.sort_key;fm=fq.sort_key;for(fo=fn=0,fp=T.length;0<=fp?fn<fp:fn>fp;fo=0<=fp?++fn:--fn){if(fm[fo]==null){return 1}if(typeof T[fo]!==typeof fm[fo]){if(typeof T[fo]==="string"){return 1}else{return -1}}else{if(T[fo]!==fm[fo]){if(T[fo]>fm[fo]){return 1}else{return -1}}}}if(fm.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(i,fn,fm,T){var fo,fq,fr,fl,fp;fl=$$(fm);fp=[];for(fo=0,fq=fl.length;fo<fq;fo++){fr=fl[fo];fp.push((function(j){var fs;if(i!==j){cx.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}fs=fn?"arrow-up-gray":"arrow-down-gray";return cx.src(j.down("img"),"web",fs)}})(fr))}return fp},add_sort_arrow_mouseover_j:function(i,fn,fm,T){var fo,fq,fr,fl,fp;fl=bF(fm);fp=[];for(fo=0,fq=fl.length;fo<fq;fo++){fr=fl[fo];fp.push((function(j){var fs;if(i.attr("data-sort")!==bF(j).attr("data-sort")){cx.src(bF(j).find("img")[0],"web","downtick-spacer");return bF(j).removeClass("bolded")}else{bF(j).addClass("bolded");if(bF(j).hasClass("noarrow")){return}fs=fn?"arrow-up-gray":"arrow-down-gray";return cx.src(bF(j).find("img")[0],"web",fs)}})(fr))}return fp},one_line_fit:function(i){var T,j;T=$$(i);if(T.length<2){return}j=(function(fl){return function(){var fu,fs,fq,fn,fo,ft,fp,fr,fm;fq=T[0];ft=T[T.length-1];fn=fq.cumulativeOffset().top;fp=ft.cumulativeOffset().top;if(fn!==fp){fu=parseInt(fq.getStyle("font-size"),10);fm=fu-1;if(fm<8){return}for(fo=0,fr=T.length;fo<fr;fo++){fs=T[fo];fs.style.fontSize=fm+"px"}return j()}}})(this);return j()},nice_list:function(j){var fn,fm,fl,i,T;if(!j){return""}else{if(j.length===1){return j[0]}else{if(j.length===2){return eA("%(x)s and %(y)s").format({x:j[0],y:j[1]})}}}T=eA("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cL(T.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fm=T[0];fl=T[1];i=T[2];fn=T[3];return[fm,j.slice(0,-1).join(fl),i,j[j.length-1],fn].join("")},list_em_snippet:function(fl,T){var fr,fo,fn,fm,fq,fp;fm="";T-=new bU("...").length;for(fo=fn=0,fq=fl.length;0<=fq?fn<fq:fn>fq;fo=0<=fq?++fn:--fn){fp=fl[fo];if(fo!==0){fp=", "+fp}fr=new bU(fp).length;if(fr>T){break}T-=fr;fm+=fp}return{str:fm,snipped:fl.length-fo}},start_of_day:function(i){var j;j=new Date();j.setTime(i.getTime());j.setHours(0);j.setMinutes(0);j.setSeconds(0);j.setMilliseconds(0);return j},to_iso8601_date:function(fl,j,T){var i;if(j==null){j=false}if(T==null){T=false}if(j){i=fl.getUTCFullYear().toString()+"-"+(fl.getUTCMonth()+1).toString().lpad(2)+"-"+fl.getUTCDate().toString().lpad(2);if(T){i+=" "+fl.getUTCHours().toString().lpad(2)+":"+fl.getUTCMinutes().toString().lpad(2)+":"+fl.getUTCSeconds().toString().lpad(2)}}else{i=fl.getFullYear().toString()+"-"+(fl.getMonth()+1).toString().lpad(2)+"-"+fl.getDate().toString().lpad(2);if(T){i+=" "+fl.getHours().toString().lpad(2)+":"+fl.getMinutes().toString().lpad(2)+":"+fl.getSeconds().toString().lpad(2)}}return i},to_mysql_date:function(fm,i,T){var j,fn,fl;j=fm.getFullYear().toString()+"-"+(fm.getMonth()+1).toString().lpad(2)+"-"+fm.getDate().toString().lpad(2);fl=fm.getHours().toString().lpad(2)+":"+fm.getMinutes().toString().lpad(2)+":"+fm.getSeconds().toString().lpad(2);fn="."+fm.getMilliseconds().toString().lpad(3);if(!i){return j}if(!T){return j+" "+fl}return j+" "+fl+fn},from_mysql_date:function(j){var fl,fn,T,fp,i,fo,fm;fp=j.split(" ");fl=fp[0];fo=fp.length>1?fp[1]:false;fn=fl.split("-");cL(fn.length===3,"weird date format on "+this+", expected yyyy-mm-dd");T=new Date(fn[0],parseInt(fn[1],10)-1,fn[2]);if(fo){fm=fo.split(":");cL(fm.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");T.setHours(fm[0]);T.setMinutes(fm[1]);i=fm[2].split(".");T.setSeconds(i[0]);if(i.length>1){T.setMilliseconds(i[1])}}return T},make_table:function(i,fp){var T,fo,fq,j,fm,fl,fn;fq=new Element("table",fp);j=new Element("tbody");fq.__sert(j);for(fo in i){fn=i[fo];fl=new Element("tr");fm=new Element("td").insert(fo);T=new Element("td").insert(fn);fl.__sert(fm);fl.__sert(T);j.__sert(fl)}return fq},validate_email:function(i){var j;j=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return j.test(i)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(T){var j,i;i=this.scried;j=i[T];if(!j){j=$(T);i[T]=j}return j},urlquote:function(i){return i.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var j,i;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(j=$("ieconsole"))!=null?j.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(i=console.log)!=null?i.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(T,j){var i;i=this.childElementWithIndex(T,j);return i[0]},childElementWithIndex:function(fr,fn){var fp,fq,fo,fm,T,fl;fp=0;fl=fr.childNodes;for(fo=fm=0,T=fl.length;fm<T;fo=++fm){fq=fl[fo];if(fq.nodeType===1&&fp++===fn){return[fq,fo]}}return[false,false]},disableSelection:function(i){i.onselectstart=function(){return false};i.unselectable="on";i.style.MozUserSelect="none";return i.style.cursor="default"},enableSelection:function(i){i.onselectstart=function(){return true};i.unselectable="off";i.style.MozUserSelect="";return i.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(i,fp,fn,fm){var T,fl,j,fo;if(!fn){fn=function(fq,fr){return fq-fr}}T=i.length;fl=0;while(T>fl){j=Math.floor(T/2+fl/2);fo=fn(i[j],fp);if(fo>0){T=j}else{if(fo<0){fl=j+1}else{return j}}}if(fm){return fl}else{return -1}},nonce:function(){var T,i,j;T=new Date();j=T.getTime().toString();i=Math.floor(Math.random()*1000000).toString().lpad(6);return j+i},focus:function(j){if(j){j=$(j);try{return j.focus()}catch(i){}}},sumStyles:function(fn,fo){var T,fl,fm,i;fl=0;if(fn){for(fm=0,i=fo.length;fm<i;fm++){T=fo[fm];fl+=parseInt(fn.getStyle(T),10)||0}}return fl},async_load_script:function(j){var i;i=function(){var fl,T;T=document.createElement("script");T.src=j;T.type="text/javascript";T.async=true;fl=document.getElementsByTagName("script")[0];return fl.parentNode.insertBefore(T,fl)};if(document.readyState==="complete"){return i()}else{if(window.attachEvent!=null){return window.attachEvent("onload",i)}else{return window.addEventListener("load",i,false)}}},smart_window_load:function(i){if(document.readyState==="complete"){return i.defer()}else{return Event.observe(window,"load",i)}},isNumber:function(i){return !isNaN(Number(i,10))},shorten_url:function(i,j){return new Ajax.DBRequest("/shorten_url",{parameters:{url:i},onSuccess:function(T){return j(T.responseText)}})},falsy_to_empty:function(i){return i||""},preloaded_images:{},preload_image:function(fl,T,j){var i;if(this.preloaded_images[fl]){return}i=new Image();if(T!=null){Element.extend(i).observe("error",T)}if(j!=null){Element.extend(i).observe("load",j)}i.src=fl;return this.preloaded_images[fl]=i},get_preloaded_image:function(i){if(this.preloaded_images[i]){return this.preloaded_images[i].clone()}else{return new Element("img",{src:i})}},clear_selected:function(){var i;if(window.getSelection){i=window.getSelection();if(i.removeAllRanges){return i.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(i){var T,j;T=20;j=C.viewport_dimensions();return i>j.width-T},freshbutton_overlay:function(j,i){var fl,T;T=j instanceof jQuery&&j||bF(j);fl=i instanceof jQuery&&i||bF(i);T.on("mouseover",(function(fm){return function(){return fl.addClass("hovered")}})(this));T.on("mouseout",(function(fm){return function(){fl.removeClass("hovered");return fl.removeClass("pressed")}})(this));T.on("mousedown",(function(fm){return function(){fl.removeClass("hovered");return fl.addClass("pressed")}})(this));return T.on("mouseup",(function(fm){return function(){return fl.removeClass("pressed")}})(this))},isElm:function(i){if(typeof HTMLElement==="object"){return i instanceof HTMLElement}else{return i&&typeof i==="object"&&i.nodeType===1&&typeof i.nodeName==="string"}},_track_twitter_chars_left:function(j,T){var i;clearInterval(this.chars_left_interval);i=(function(fl){return function(){var fm,fn;fm=$("twitter-chars");fn=T-$F(j).strip().length;if(fn<0){fm.addClassName("too-long")}else{fm.removeClassName("too-long")}return fm.__date(fn)}})(this);return this.chars_left_interval=setInterval(i,250)},session_storage_set:function(i,j){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(i,JSON.stringify(j))},session_storage_get:function(i){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(i))}},pdf_plugins:function(){var T,j,i;i=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return T=(function(){var fm,fl,fo,fn;fo=window.navigator.plugins;fn=[];for(fm=0,fl=fo.length;fm<fl;fm++){j=fo[fm];if(i.test(j.name)){fn.push(j)}}return fn})()},get_window_location:function(){return window.location}};d6.scrollLeft=d6.scrollLeft.cached(50);d6.scrollTop=d6.scrollTop.cached(50);if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var T,i,fn,fm,fl;if(d6.ie8){fm=$$("#page-header a, #page-footer a");fl=[];for(T=0,i=fm.length;T<i;T++){fn=fm[T];if(fn.target==="_blank"){fl.push(fn.target="")}else{fl.push(void 0)}}return fl}});dj=__CONDITIONAL_JS__.Trace=E.Trace=(function(){var i;i=[];return{log:function(){var j;j=b6.time()+": "+$A(arguments).join(" ");return i.push(j)},get:function(){return i.join("\n")}}})();eI=E.T=function(){return dj.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var i;eI("dom:loaded");i=function(){var fl,j,T,fm;T=$("page-content");if(T){fm=C.viewport_dimensions();j=$(document.body);fl="absolutize";if(fm.width<T.getWidth()){return j.addClassName(fl)}else{return j.removeClassName(fl)}}};Event.observe(window,"resize",bx.debounce(i,150));return i()});Event.observe(window,"load",function(){return eI("window:load")});be=E.URLUtil={absolutize:function(i){if(i.startsWith("https://")||i.startsWith("http://")){return i}else{if(i.charAt(0)==="/"){return window.location.protocol+"//"+window.location.host+i}else{return cL(0,"absolutize is confused by "+i)}}}};dA=E.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var i,j;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}j=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;i=Math.abs(this.max_delta_y)<Math.abs(j-this.old_y);if(i){this.max_delta_y=j-this.old_y;return this.old_y=j}},start_capture:function(i){this.scroll_container=i;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(i){if(i==null){i=false}cL(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(i){return this.last_nonzero_velocity}return this.velocity}};var dv;dv=E.DomUtil={fromElm:function(i){return $(i).innerHTML},updateFromElm:function(j,i){j=$(j);i=$(i);return j.update(this.fromElm(i))},fillVal:function(fq,fo){var fn,T,fp,fl,fm,j;fp=$$("."+fo);fm=[];for(fn=0,T=fp.length;fn<T;fn++){j=fp[fn];j=$(j);if(j.tagName==="INPUT"){j.value=fq;fm.push(j.defaultValue=fq)}else{if(j.innerHTML===""&&((fl=j.tagName)==="A"||fl==="B"||fl==="INPUT"||fl==="I"||fl==="LABEL"||fl==="SELECT"||fl==="SPAN"||fl==="TEXTAREA")){d6.log("Filling an empty value; this may look broken in IE7",j)}fm.push(j.innerHTML=fq)}}return fm}};var ar;ar=E.RequestWatcher={reqs:[],working_msg:eA("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(j,T){var i;i=this.reqs;if(!i.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(T){j.skip_message=true}return i.push([j,b6.time()])},check_up:function(){return this.scan(false)},remove:function(i){return this.scan(i)},scan:function(fo){var fs,fn,fp,T,fm,j,fl,fr,fq;T=b6.time();fm=[];fl=this.reqs;for(fn=0,fp=fl.length;fn<fp;fn++){j=fl[fn];fr=j[0];fq=j[1];fs=T-fq;if(fr.transport.readyState===4){this.clearWorkingMessage();continue}if(fs>4000&&!fr.skip_message){fr.skip_message=true;if(ah.isShown()&&ah.current()===!X.undo_notification){this.last_notification=ah.success(this.working_msg)}}if(fs>this.TIMEOUT*1000&&fr.job){fr.transport.abort()}if(fr!==fo){fm.push([fr,fq])}else{fr.transport.abort()}}this.reqs=fm;if(!fm.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ah.isShown()&&ah.current()===this.last_notification){return ah.clear()}}};bF(function(){var j,i,fl,T;fl=Prototype.Browser;T=[];for(j in fl){i=fl[j];if(i===true){T.push(bF(document.body).addClass(j.toLowerCase()))}}return T});var dL,a3,cF=[].slice;dL=E.HTML5_HISTORY=Modernizr.history;bF((function(i){return function(){return eD.init()}})(this));a3=E.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(i){return window.location.href=i},_replace_location:function(i){return window.location.replace(i)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(i,j){this.callback_map[i]=j;if(!this.watch_timer){return this.init()}},check_hash:function(){var j,T,fl,fn,fm,i;fn=this._get_location().split("#")[1];if(fn!=null){fn=fn.replace(/%27/g,"'")}if(this.last_hash===fn){return}this.last_hash=fn;if(this.last_prefix&&fn===""){fn=this.last_prefix+":"}else{if(!fn){return}}i=fn.split(":");fm=i.first();this.last_prefix=fm;fl=this.callback_map[fm];if(fl!=null){T=(function(){var fq,fo,fr,fp;fr=i.slice(1);fp=[];for(fq=0,fo=fr.length;fq<fo;fq++){j=fr[fq];fp.push(decodeURIComponent(j))}return fp})();fl.apply(null,T)}return $(document).fire("db:hash_change",{hash:fn})},_prepare_hash:function(T){var j,i;i=$A(T).map(d6.falsy_to_empty);j=i.map(encodeURIComponent);return j.join(":")},set_hash:function(){var i,j;i=1<=arguments.length?cF.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j)},replace_hash:function(){var i,j;i=1<=arguments.length?cF.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j,true)},_set_hash:function(j,i){if(j===""){j="/"}this.last_hash=j;if(!i){return this._set_location("#"+j)}else{return this._replace_location("#"+j)}}};var aZ;aZ=E.SharingUtil=(function(){function i(){}i.success_string_for_recipients=function(j){var T;if(j.length===1){if(j[0].indexOf("@")===-1){T=eA("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:j[0]})}else{T=eA("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:j[0]})}}else{if(j.length===2){if(j[0].indexOf("@")===-1){if(j[1].indexOf("@")===-1){T=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:j[0],recipient_second:j[1]})}}else{if(j[1].indexOf("@")===-1){T=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:j[0],recipient_second:j[1]})}}}else{if(j[0].indexOf("@")===-1){T=eA("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}else{T=eA("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}}}return T};return i})();var s;s=INLINE_JS.SharingModals=E.SharingModals=(function(){function i(){}i.show_shared_folder_options_modal=function(fm,j,T,fl){if(T==null){T=true}if(fl==null){fl=true}return d1.push(new dg(j,fm,T,fl))};i.show_share_inband_modal=function(fl,T,j,fm){return eF.createAndShowInbandModal(T,fl,true,j,true,false,fm)};i.show_shared_folder_wizard=function(j){return new ep(j,{element_id:"share-a-folder-wizard-modal"}).show()};i.get_select_role_modal=function(){return new cI({element_id:"select-role-modal"})};i.start_wizard_without_user=function(){if(cM.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=i.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cM.get_viewer().get_users()[0])}};i.start_wizard_for_user=function(j){if(d4.get_for_user(j).verified_or_show(er.SHARE_FOLDER)){return i.show_shared_folder_wizard(j)}};i.show_share_existing_modal=function(fl,j){var T;if(d4.get_for_user(j).verified_or_show()){T=new cp(j,{folder_name:fl,element_id:"invite-to-new-sf-wizard-modal-"+j.id});return T.show()}};i.show_shmodel_or_invite_modal=function(T,fm,j,fl){if(d4.get_for_user(j).verified_or_show()){return new dY(j,{path:T,existing_sf:fm,element_id:"create-link-or-invite-wizard-modal",target_item:fl}).show()}};i.show_unshare_team_sf_modal=function(T,j,fm){var fl;fl=new b5(T,{element_id:"unshare-confirm-modal",team_shared_folder:true,nested_shared_folder:false,ns_id:j,folder_path:fm});return fl.show()};i.show_ignore_modal=function(fl,T,j){var fn,fm,fo;cL(j,"Share ignore did not get an ns_id");fo=eA("Permanently remove '%(folder_name)s'").format({folder_name:bU.em_snippet(T,15)});fn={ns_id:j};fm=new dm(fl,{element_id:"ignore-confirm",title:fo});fm.on_confirm_button_click=function(fr){var fq,fp,fs;fr.preventDefault();fq=bF(fr.target);fp=fq.closest("form");fs=function(ft){ah.success(eA("Removed shared folder successfully."));document.fire(aH.SF_IGNORE,{target_ns_id:j,user_id:fl.id});return fm.hide()};return bT.ajax_submit(fp[0],false,fs,void 0,fq[0],fn)};return fm.show()};i.show_rejoin_modal=function(fl,T,j){var fn,fm,fo;cL(j,"Rejoin didn't get an ns_id");fo=eA("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bU.em_snippet(T,13)});fn={ns_id:j};fm=new dm(fl,{element_id:"rejoin-confirm",title:fo});fm.on_confirm_button_click=function(fr){var fq,fp,fs;fr.preventDefault();fq=bF(fr.target);fp=fq.closest("form");fs=function(fu){var ft;ft=fu.responseText;T=aA.filename(ft);ah.success(eA("Rejoined shared folder successfully."));document.fire(aH.SF_REJOIN,{target_ns_id:j,user_id:fl.id,filename:T,mount_point:ft});return fm.hide()};return bT.ajax_submit(fp[0],false,fs,void 0,fq[0],fn)};return fm.show()};i.show_invites=function(){return d1.push(new cD({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};i.show_shared_subfolder_modal=function(T,fm){var fp,fn,fo,j,fl;fo=bU.em_snippet(aA.filename(T),14);fn=eA("Can't share folder");j="'%(parent_shared_folder)s' ".format({parent_shared_folder:fo});dv.fillVal(j.escapeHTML(),"parent_shared_folder_name");fp=eA("Share '%(parent_shared_folder)s' folder");fl=fp.format({parent_shared_folder:fo});($("share_parent_folder_button")).value=fl;fb.show(eA("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bF("#share_parent_folder_button").on("click",(function(fq){return function(fr){fb.hide();return fq.show_shared_folder_options_modal(T,fm)}})(this));return fb.show(fn,$("share_subfolder"))};return i})();var df;df=E.InviteFormController=(function(){function i(fm,fl,T,j,fq,fp){var fo,fn;this.user=fm;this.$form=fl;this.members=T;this.invitees=j;this.new_style_groups=fq;this.team_only=this.$form.data("team-only");fn={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fo=Autocompleter.TeamTokenizer;fn.team_only=this.team_only}else{fo=Autocompleter.ContactsTokenizer;fn.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){fn.include_new_style_groups=true}this.sharing_options_auto_completer=new fo(this.user,fp+"-new-collab-input",fp+"-new-whobulk",fp+"-hidden-input",fn);cj._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new h(this.$form)}}i.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};i.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};i.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};i.prototype.reset_options=function(){return bF(this.sharing_options_auto_completer.get_entry_container()).hide()};i.prototype.set_team_only=function(j){this.team_only=j;return this.sharing_options_auto_completer.setTeamOnly(j)};i.prototype.get_token_count=function(){return this.sharing_options_auto_completer.getTokenCount()};i.prototype.extract_invitees=function(){var fo,fl,fm,T,fp,j,fn;fp={};fn=["emails","fb_ids","group_ids","new_style_group_ids"];for(fm=0,j=fn.length;fm<j;fm++){fl=fn[fm];T=this.$form.find("input[name="+fl+"]");fp[fl]=[(function(){var fr,fq,fs;fs=[];for(fr=0,fq=T.length;fr<fq;fr++){fo=T[fr];fs.push(bF(fo).val())}return fs})()]}return fp};i.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};i.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return i})();var aP,dg,R,ew,bv,fd,c6,dB,aV,eR,dw,cw,dR,bM,aJ,b5,fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dR=E.SharedFolderBaseModal=(function(i){fc(j,i);function j(fl,T){this.user=fl;this.options=T;j.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.nested_shared_folder=this.options.nested_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bm(this.user)}j.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return j})(d7);dg=E.ExistingSharedFolderOptionsModal=(function(j){fc(i,j);function i(fq,fm,fl,fn,T){var fp,fo;this.user=fq;if(fl==null){fl=true}if(fn==null){fn=true}this.restore_modal=T;this.__show_modal=b3(this.__show_modal,this);this.__x_click_handler=b3(this.__x_click_handler,this);cL(fm!=null,"Missing folder path");this.path=aA.normalize(fm);fo=eA("Shared folder options for '%(folder)s'");fo=fo.format({folder:bU.em_snippet(aA.filename(fm),13)});fp={};fp[a9.UID_PARAM_NAME]=this.user.id;fp.max_results=20;fp.show_invite_form=fl;fp.show_folder_settings=fn;d1.register(aP.MODAL_DONE_VIEWING_EVENT,(function(fr){return function(){return typeof fr.restore_modal==="function"?fr.restore_modal():void 0}})(this));i.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fo,endpoint_url:G({path:"/share_options"+this.path}).toString(),parameters:fp})}i.prototype.__x_click_handler=function(fl){var T;i.__super__.__x_click_handler.apply(this,arguments);T={path:this.path};ba.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,T);return typeof this.restore_modal==="function"?this.restore_modal():void 0};i.prototype.__show_modal=function(fl){var T;i.__super__.__show_modal.apply(this,arguments);T={path:this.path};return ba.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,T)};return i})(cD);aP=E.ExistingSharedFolderOptionsContent=(function(){i.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";i.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function i(fn,fl,fm,fo,j,T){this.$root=fn;this.options=fo;this.show_invite_form=j;this.allows_editor_manage_membership=T;this.show_email_verification=b3(this.show_email_verification,this);this.show_golden_gate_warning=b3(this.show_golden_gate_warning,this);this.show_folder_settings=b3(this.show_folder_settings,this);this.show_m2_folder_settings=b3(this.show_m2_folder_settings,this);this.toggle_from_invite_mode=b3(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=b3(this.toggle_to_invite_mode,this);this.toggle_get_link_button_visibility=b3(this.toggle_get_link_button_visibility,this);this.show_leave_folder_modal=b3(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=b3(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=b3(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=b3(this.show_unshare_folder_modal,this);this.show_uninvite_modal=b3(this.show_uninvite_modal,this);this.show_transfer_user_modal=b3(this.show_transfer_user_modal,this);this.show_kick_group_modal=b3(this.show_kick_group_modal,this);this.show_kick_user_modal=b3(this.show_kick_user_modal,this);this.update_tf_access=b3(this.update_tf_access,this);this.update_sf_perms=b3(this.update_sf_perms,this);this.reinvite_user=b3(this.reinvite_user,this);this.submit_invitations=b3(this.submit_invitations,this);this.maybe_load_more=b3(this.maybe_load_more,this);this.extract_user_data_and_call=b3(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=b3(this.extract_invitee_data_and_call,this);this.create_m2_inband_modal=b3(this.create_m2_inband_modal,this);this._disable_token_for_sf=b3(this._disable_token_for_sf,this);this.user=cM.get_viewer().get_user_by_id(fl);this.path=aA.normalize(fm);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fp){C.controller(bF(fp.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=20;this.$root.find(".member-container").on("scroll",(function(fp){return function(fs){var fr,fq;fr=bF(fs.currentTarget);fq=fr.find("#sf-members");if(fr.scrollTop()+fr.innerHeight()>=fq.innerHeight()){return fp.maybe_load_more()}}})(this));this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$root;bf.register_all();c5.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.nested_shared_folder=this.$root.data("nested-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");if(this.$root.find(".get-editable-link").length>0){B.showInstance(dC.createElement(B,{onDismiss:eF.dismissM2Prompt,shouldShow:ct.simple_sharing_show_m2_prompt,targetedButton:this.$root.find(".get-editable-link").get(0)}));ba.SimpleSharingLogger.log(this.user.id,29)}this.has_show_invite_form=false;this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();d1.trigger(i.CONTENT_LOADED_EVENT)}i.prototype.listen=function(){var fl,T,fm,j,fn;this.$root.find(".confirm-button").click((function(fo){return function(fp){fp.preventDefault();return fo.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fo){return function(fp){fp.preventDefault();return fo.toggle_from_invite_mode()}})(this));if(this.show_invite_form){this.get_link_button=this.$root.find(".get-editable-link-invite");this.$invite_input=this.$root.find("#sharing-options-new-collab-input");fn=["focus","keypress","contextmenu"];for(fm=0,j=fn.length;fm<j;fm++){T=fn[fm];this.$invite_input.off(T);this.$invite_input.on(T,this.toggle_to_invite_mode)}this.$invite_input.keyup(this.toggle_get_link_button_visibility);if(this.$invite_input[0]){this.$invite_input[0].on("token:remove",this.toggle_get_link_button_visibility);this.$invite_input[0].on("token:add",this.toggle_get_link_button_visibility)}fl=this.$root.find("#custom-message-wizard");fl.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".change-m2-settings-link").on("click",this.show_m2_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new df(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fo.user,fo.log_extras);return fo.show_leave_folder_modal()}})(this));this.$root.on("click",".get-editable-link",(function(fo){return function(fq){var fp;bF(document).trigger("collab:m2:prompt:dismiss");return fo.create_m2_inband_modal(fq,fp=false)}})(this));this.$root.on("click",".get-editable-link-invite",(function(fo){return function(fq){var fp;bF(document).trigger("collab:m2:prompt:dismiss");return fo.create_m2_inband_modal(fq,fp=true)}})(this));this.$root.on("click","a.owner-leave-folder",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fo.user,fo.log_extras);return fo.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fo){return function(fp){return fo.extract_user_data_and_call(fp,fo.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fo){return function(fr){var fp,fq,fs;fr.preventDefault();fp=bF(fr.currentTarget);fs=fp.data("group-name");fq=fp.data("group-gid");return fo.show_kick_group_modal(fs,fq)}})(this));this.$root.on("click","a.make-owner",(function(fo){return function(fp){return fo.extract_user_data_and_call(fp,fo.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fo){return function(fq){var fp,fr;fq.preventDefault();fp=bF(fq.currentTarget);fr=fp.data("email");return window.location=G({scheme:"mailto",path:fr}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fo){return function(fp){return fo.extract_invitee_data_and_call(fp,fo.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fo){return function(fp){return fo.extract_invitee_data_and_call(fp,fo.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fo.user,fo.log_extras);return fo.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fo.user,fo.log_extras);return fo.show_unshare_folder_modal()}})(this));this.$root.on("click","a.unshare_folder_link",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fo.user,fo.log_extras);return fo.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fo){return function(fp){fp.preventDefault();return fo._disable_token_for_sf(function(){return d1.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fo){return function(fp){var fq;fp.preventDefault();fq=function(){var fr;fr=d7.get_containing_modal(fo.$root);if(fr&&fr instanceof cD){return fr.fetch()}};return fo._disable_token_for_sf(fq)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fo){return function(fp){fp.preventDefault();return fo.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fo){return function(fp){fp.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_done_button",fo.user,fo.log_extras);d1.trigger(i.MODAL_DONE_VIEWING_EVENT);return d1.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fo){return function(fq){var fp;fp=bF(fq.currentTarget);return fo.update_sf_perms(fp.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fo){return function(fq){var fp;fp=bF(fq.currentTarget);return fo.update_tf_access(!fp.prop("checked"))}})(this))};i.prototype._disable_token_for_sf=function(j){return cE.WebRequest({url:G({path:"/sm/disable_token_at_path"+aA.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(T){return function(){bF(document).trigger(dN.UPDATE);ah.success(eA("Link removed"));ba.SimpleSharingLogger.log(T.user.id,25);return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(){return ah.error(eA("An error occurred when removing link"))}})(this)})};i.prototype.create_m2_inband_modal=function(T,j){T.preventDefault();d1.pop();if(j){ba.SimpleSharingLogger.log(this.user.id,32)}else{ba.SimpleSharingLogger.log(this.user.id,30)}return eF.createAndShowM2InbandModal(this.user,this.path)};i.prototype.extract_invitee_data_and_call=function(fm,fl){var j,fn,T;fm.preventDefault();j=bF(fm.currentTarget);T=j.data("email-or-fbname");fn=j.data("invite-id");return fl(T,this.ns_id,fn)};i.prototype.extract_user_data_and_call=function(fo,fn){var T,fm,fl,j;fo.preventDefault();T=bF(fo.currentTarget);fl=T.data("display-name");fm=T.data("email");j=T.data("user-id");return fn(fl,fm,j)};i.prototype.maybe_load_more=function(){var T,j,fl;j=this.$root.closest("body").length;if(!j){return}if((this.num_total==null)||(this.start>=this.num_total)){bF("#more-members-spinner").hide();return}bF("#more-members-spinner").show();fl={};fl[a9.UID_PARAM_NAME]=this.user.id;fl.start=this.start;fl.max_results=this.max_results;T=G({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new by(this.$root,T,{data:fl,success:(function(fm){return function(fq,fn,fr){var fp,fo;if(((fo=fq.data)!=null?fo.options:void 0)!=null){fp=fq.data.options;if((fm.members!=null)&&(fp.folder_members!=null)){Array.prototype.push.apply(fm.members,fp.folder_members)}if((fm.invitees!=null)&&(fp.folder_invitees!=null)){Array.prototype.push.apply(fm.invitees,fp.folder_invitees)}if((fm.new_style_groups!=null)&&(fp.new_style_groups!=null)){return Array.prototype.push.apply(fm.new_style_groups,fp.new_style_groups)}}}})(this),error:(function(fm){return function(fp,fn,fo){return ah.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};i.prototype.submit_invitations=function(){var fm,fl,fo,T,fn,j;this.invite_form_controller.tokenize();fo=this.invite_form_controller.extract_invitees();fn=this.invite_form_controller.get_custom_message();fm=this.invite_form_controller.get_access_type();T=bx.clone(this.log_extras);T.access_type=fm;ba.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,T);j=(function(fp){return function(fr){var fq;fq=d7.get_containing_modal(fp.$root);if(fq&&fq instanceof cD){fq.fetch()}else{d1.pop()}ah.success(fr.responseText);return document.fire(aH.SF_INVITE,{target_ns_id:fp.ns_id,user_id:fp.user.id})}})(this);fl=(function(fp){return function(fq){return eK.show_validation_error(fq,fp.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fo,fn,fm,j,fl)};i.prototype.reinvite_user=function(fl,j,T){return this.sharing_api.reinvite_user(j,T,(function(fm){return function(ft){var fq,fr,fs,fp,fn,fo;fp=JSON.parse(ft.responseText);fn=fp.status;if(fn==="OK"){fo=eA("%(email_or_fbname)s was reinvited successfully");fo=fo.format({email_or_fbname:fl});return ah.success(fo)}else{fs=fp.reason;if(fs==="ACCEPTED"){fq=eA("That invitation has already been accepted.")}else{if(fs==="DECLINED"){fq=eA("That invitation has already been declined.")}else{fq=eA("You no longer have permission to perform this action.")}}ah.error(fq);if(fp.reload){fr=d7.get_containing_modal(fm.$root);if(fr&&fr instanceof cD){return fr.fetch()}}}}})(this))};i.prototype.update_sf_perms=function(T){var fl,fm,j;this.$root.find("#change-sf-perm-saving").show();fl=(T?1:0);j=(function(fn){return function(fo){if(T){ah.success(eA("Editors can now manage membership of this folder."))}else{ah.success(eA("Editors can no longer manage membership of this folder."))}return fn.$root.find("#change-sf-perm-saving").hide()}})(this);fm=(function(fn){return function(fo){if(fo.responseText.indexOf("err:")===0){ah.error(fo.responseText.substr(4))}else{ah.error(eA("Error updating your preference! Please try again."))}return fn.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,fl,j,fm)};i.prototype.update_tf_access=function(T){var fl,j;j=(function(fm){return function(fn){if(T){return ah.success(eA("Team members can now change folder contents."))}else{return ah.success(eA("Team members can no longer change folder contents."))}}})(this);fl=(function(fm){return function(fn){return ah.error(eA("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,T,j,fl)};i.prototype.show_kick_user_modal=function(fl,T,j){return d1.push(new eR(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:fl,folder_path:this.path,user_id:j}))};i.prototype.show_kick_group_modal=function(j,T){return d1.push(new aV(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:j,folder_path:this.path,group_id:T}))};i.prototype.show_transfer_user_modal=function(fl,T,j){return d1.push(new bM(this.user,{element_id:"transfer-confirm-modal",user_id:j,user_name:fl,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_uninvite_modal=function(fl,j,T){return d1.push(new aJ(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:fl,ns_id:j,invite_id:T,folder_path:this.path}))};i.prototype.show_unshare_folder_modal=function(){return d1.push(new b5(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,nested_shared_folder:this.nested_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_access_request_link_modal=function(){return d1.push(new dh(this.user.id,this.path,void 0,true))};i.prototype.show_owner_leave_folder_warning=function(){return ah.error(eA("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};i.prototype.show_leave_folder_modal=function(){return d1.push(new dw(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.toggle_get_link_button_visibility=function(){var fo,fn,fm,fl,T,j;fn=((fm=this.invite_form_controller)!=null?fm.get_token_count():void 0)===0;fo=((fl=this.$invite_input)!=null?fl.val():void 0)==="";if(fn&&fo){return(T=this.get_link_button)!=null?T.show():void 0}else{return(j=this.get_link_button)!=null?j.hide():void 0}};i.prototype.toggle_to_invite_mode=function(){var j;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if((j=this.sf_access_type)!=null){j.show()}this.toggle_get_link_button_visibility();if(!this.has_show_invite_form&&this.get_link_button.length>0){ba.SimpleSharingLogger.log(this.user.id,31)}this.has_show_invite_form=true;return bF(document).trigger("collab:m2:prompt:hide")};i.prototype.toggle_from_invite_mode=function(){var T,j;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((T=this.sf_access_type)!=null){T.hide()}if((j=this.invite_form_controller)!=null){j.reset_autocompleter()}return this.toggle_get_link_button_visibility()};i.prototype.show_m2_folder_settings=function(T){var fl,j;j=this.path;fl=function(){var fm;fm=new dg(ct.active_user,j);return fm.show()};d1.pop();return ae.showInstance(dC.createElement(ae,{user:this.user,fq_path:this.path,is_shared_folder:true,ns_id:this.ns_id,initial_allows_editor_manage_membership:this.allows_editor_manage_membership,done_callback:fl}))};i.prototype.show_folder_settings=function(j){ba.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);j.preventDefault();d1.register(ew.SAVED_PERMISSIONS,(function(T){return function(fm,fl){if(fl!=null){return T.set_team_only(fl)}}})(this));return d1.push(new ew(this.user,this.path,this.ns_id))};i.prototype.show_golden_gate_warning=function(j){j.preventDefault();return d1.push(new c6(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype.show_email_verification=function(j){d1.pop();return d4.get_for_user(this.user).show()};i.prototype.set_team_only=function(j){var T;this.invite_form_controller.set_team_only(j);T=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(j){return T.addClass("team-only")}else{return T.removeClass("team-only")}};return i})();dw=E.LeaveFolderModal=(function(i){fc(j,i);function j(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fl){var T;fl.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,T,(function(fm){return function(){var fn;fn=eA("You removed yourself from '%(msg)s'.").format({msg:bU.em_snippet(aA.filename(fm.path),25)});ah.success(fn);document.fire(aH.SF_LEAVE,{target_ns_id:fm.ns_id,folder_deleted:!T,user_id:fm.user.id});return d1.clear()}})(this))};j.prototype.on_show=function(){j.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};j.prototype.before_show=function(){var T;T=eA("Leave the shared folder '%(folder_name)s'");T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),14)});return this.format({".db-modal-title-text":T})};return j})(dR);b5=E.UnshareFolderModal=(function(j){fc(i,j);function i(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return i.__super__.constructor.apply(this,arguments)}i.prototype.on_confirm_button_click=function(fl){var T;fl.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,T,(function(fm){return function(){var fn;fn=eA("Unshared folder '%(folder_name)s'");fn=fn.format({folder_name:bU.em_snippet(aA.filename(fm.path),25)});ah.success(fn);document.fire(aH.SF_UNSHARE,{target_ns_id:fm.ns_id,user_id:fm.user.id});return d1.clear()}})(this))};i.prototype.on_show=function(){i.__super__.on_show.apply(this,arguments);this.$modal_window.find(".tsf_unshare_desc").hide();this.$modal_window.find(".nestedsf_unshare_desc").hide();this.$modal_window.find(".regular_unshare_desc").hide();if(this.team_shared_folder){return this.$modal_window.find(".tsf_unshare_desc").show()}else{if(this.nested_shared_folder){return this.$modal_window.find(".nestedsf_unshare_desc").show()}else{return this.$modal_window.find(".regular_unshare_desc").show()}}};i.prototype.before_show=function(){var T;if(this.nested_shared_folder){T=eA("Reset membership for '%(folder_name)s'")}else{T=eA("Unshare '%(folder_name)s'")}T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),21)});return this.format({".db-modal-title-text":T})};return i})(dR);aJ=E.UninviteModal=(function(j){fc(i,j);function i(T,fl){this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.email_or_fbname=fl.email_or_fbname;this.ns_id=fl.ns_id;this.invite_id=fl.invite_id;i.__super__.constructor.call(this,T,fl)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(fl){return function(fr){var fp,fq,fo,fm,fn;fo=JSON.parse(fr.responseText);fm=fo.status;if(fm==="OK"){fn=eA("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:fl.email_or_fbname});ah.success(fn)}else{fq=fo.reason;if(fq==="ACCEPTED"){fp=eA("That invitation has already been accepted.")}else{if(fq==="DECLINED"){fp=eA("That invitation has already been declined.")}}ah.error(fp)}return d1.pop()}})(this))};i.prototype.before_show=function(T){var fl;fl=eA("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bU.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":aA.filename(this.path),".db-modal-title-text":fl})};return i})(dR);eR=E.KickUserModal=(function(i){fc(j,i);function j(fl,T){this.user=fl;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(fm){var T,fl;fm.preventDefault();T=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,T,(function(fn){return function(){ah.success(eA("User removed successfully."));bZ.reload_folder_info_if_two_account();return d1.pop()}})(this));fl={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:T};return ba.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,fl)};j.prototype.before_show=function(T){var fl;fl=eA("Remove %(person_name)s from this folder?");fl=fl.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":fl})};return j})(dR);aV=E.KickGroupModal=(function(i){fc(j,i);function j(fl,T){this.user=fl;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.group_id=this.options.group_id;this.group_name=this.options.group_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(fl){return function(){ah.success(eA("Group removed successfully."));bZ.reload_folder_info_if_two_account();return d1.pop()}})(this))};j.prototype.before_show=function(){var T;T=eA("Remove %(group_name)s from this folder?");T=T.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":T})};return j})(dR);cw=E.MakeOwnerModal=(function(j){fc(i,j);function i(fl,T){this.user=fl;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.member_uid=this.options.member_uid;this.member_name=this.options.member_name;this.ns_id=this.options.ns_id;this.access_type=this.options.access_type;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(fl){return function(){ah.success(eA("%(name)s now is the owner.").format({name:fl.member_name}));return d1.pop()}})(this))};i.prototype.before_show=function(){var T;T=eA("Make %(name)s the owner of this folder?");T=T.format({name:bU.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":T})};return i})(dR);bM=E.TransferOwnershipModal=(function(j){fc(i,j);function i(fl,T){this.user=fl;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(fl){return function(fm){ah.success(eA("Ownership changed successfully"));return d1.pop()}})(this))};i.prototype.before_show=function(){var T;T=eA("Make %(person_name)s the owner of this folder?");T=T.format({person_name:bU.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":T})};return i})(dR);ew=E.ExistingSharedFolderPermissionsModal=(function(i){fc(j,i);j.SAVED_PERMISSIONS="existing_sf_permissions:saved";function j(fp,fn,T,fo){var fm,fl;this.user=fp;this.path=fn;this.ns_id=T;this.on_hide=fo;fm={ns_id:this.ns_id,folder_name:this.path};fm[a9.UID_PARAM_NAME]=this.user.id;fl=eA("'%(folder_name)s' settings");fl=fl.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fl,endpoint_url:"/share_ajax/folder_settings",parameters:fm})}return j})(cD);c6=c6=(function(i){fc(j,i);function j(fn,T){var fm,fl;this.user=fn;this.ns_id=T;fm={ns_id:this.ns_id};fm[a9.UID_PARAM_NAME]=this.user.id;fl=eA("Confirm converting to Golden Gate folder");j.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fl,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fm})}return j})(cD);dB=E.GoldenGateWarningModalContents=(function(){function i(j,T,fl){this.$form=j;this.ns_id=fl;this._submit=b3(this._submit,this);this.user=cM.get_viewer().get_user_by_id(T);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._submit=function(j){return d1.push(new bv(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype._cancel=function(j){return d1.pop()};return i})();bv=bv=(function(j){fc(i,j);function i(fn,T){var fm,fl;this.user=fn;this.ns_id=T;fm={ns_id:this.ns_id};fm[a9.UID_PARAM_NAME]=this.user.id;fl=eA("Confirm converting to Golden Gate folder");i.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fl,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fm})}return i})(cD);fd=E.GoldenGateConfirmModalContents=(function(j){fc(i,j);function i(T,fl,fm){this.$form=T;this.ns_id=fm;this.user=cM.get_viewer().get_user_by_id(fl);new ch(this.$form,null,{should_submit_once:true});this.$form.on(ch.SUCCESS_EVENT,(function(fn){return function(){return cE.WebRequest({url:"/share_ajax/enable_golden_gate_step_two",subject_user:fn.user,data:{ns_id:fn.ns_id},success:function(){ah.success("Golden Gate enabled for this folder");return location.reload()}})}})(this));this._listen()}i.prototype._listen=function(){return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(T){return d1.pop()};return i})(cD);R=E.ExistingSharedFolderPermissionsContent=(function(){function i(j,T,fl){this.$form=j;this.ns_id=fl;this._submit=b3(this._submit,this);this.user=cM.get_viewer().get_user_by_id(T);this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d1.pop()};i.prototype._submit=function(fo){var fp,j,fn,fl,fm,T;fo.preventDefault();j=this.$form.find("input[name=audience]:checked").val();fn=this.$form.find("input[name=inviter]:checked").val();T=this.$form.find("input[name=shared_link_policy]:checked").val();fp=(fm=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fm.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,j,fn,T,fp,(function(fq){return function(fs){var fr,ft;fr=JSON.parse(fs.responseText);ft=fr.team_only_invite;ah.success(fr.message);d1.trigger(ew.SAVED_PERMISSIONS,ft);return d1.pop()}})(this));false;fl={ns_id:this.ns_id,audience:j,inviter:fn};return ba.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,fl)};return i})();var a1,dY,a2,eK,cp,cB,al,ep,db,cf,bS,cZ,cY,cW,cU,fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};a1=E.BaseShareAFolderWizardModal=(function(i){fc(j,i);j.prototype.base_title=null;j.prototype.personal_title=null;j.prototype.work_title=null;function j(T,fl){this.user=T;this.options=fl;j.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}j.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=this.base_title;if(cM.get_viewer().is_paired){if(this.user.role==="personal"){T=this.personal_title}else{T=this.work_title.format({team_name:cM.get_viewer().team_name})}}return this.format({".db-modal-title-text":T})};return j})(d7);ep=E.ShareAFolderWizardModal=(function(i){fc(j,i);function j(T,fl){this.user=T;this.options=fl;j.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Share a folder");this.personal_title=eA("Share a folder from your personal Dropbox");this.work_title=eA("Share a folder from your %(team_name)s Dropbox")}j.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fl){fl.preventDefault();s.start_wizard_without_user();return T.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(T){return function(fl){bF(fl.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(T.$modal_window.find("input#create-new-sf").is(":checked")){return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",T.user)}}})(this))};j.prototype.on_confirm_button_click=function(fq){var fn,fp,T,fm,fo,fl;fq.preventDefault();fp=this.$modal_window.find("input#create-new-sf").is(":checked");if(fp){fm=null;if(this.user.role==="work"){fo="shared-folder-type-wizard-modal";fl=d7.get_template(fo);if(fl.length){fm=new bS(this.user,{element_id:fo})}}if(fm===null){fm=new cf(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();T={selection:"new_folder"};ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T);return fm.show()}fn=this.$modal_window.find(".ajax-loading-indicator").show();return bF.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(fr){return function(fs){var ft;fs=JSON.parse(fs);if(fs===true){fm=new db(fr.user,{element_id:"share-existing-folder-wizard-modal"});T.has_existing_folder=true}else{ft=eA("You don't have any existing folders. Please create and share a new folder.");fm=new cf(fr.user,{element_id:"share-new-folder-wizard-modal",error_msg:ft});T.has_existing_folder=false}fr.hide();return fm.show()}})(this),error:(function(fr){return function(){return ah.error()}})(this),complete:(function(fr){return function(){return fn.hide()}})(this)},T={selection:"existing_folder"},ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T))};return j})(a1);bS=E.SharedFolderTypeWizardModal=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;i.__super__.constructor.call(this,this.user,this.options);this.work_title=eA("Share a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fl){fl.preventDefault();s.start_wizard_for_user(T.user);return T.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(T){return function(fl){bF(fl.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(T.$modal_window.find("input#team-folder-option").is(":checked")){return ba.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",T.user)}}})(this))};i.prototype.on_confirm_button_click=function(fo){var T,fm,fn,fl;fo.preventDefault();T=(function(fp){return function(fs,fq){var fr;fs.preventDefault();fq.hide();fr=new fp.constructor(fp.user,fp.options);return fr.show()}})(this);fm=this.$modal_window.find("input#team-folder-option").is(":checked");if(fm){fn=new dW({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:T});fl="team_folder"}else{fn=new cf(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:T});fl="shared_folder"}ba.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:fl});this.hide();return fn.show()};return i})(a1);eK=E.InlineModalValidationError=(function(){function i(){}i.show_validation_error=function(fq,fm){var fn,fo,fl,T,fp,j;if(fq.responseText.indexOf("err:{")===0){j=fq.responseText.substr(4);fp=JSON.parse(j);for(fo in fp){fn=fp[fo];if("message_text" in fn){T=fm.find("span.error-message");if(T.length===0){T=bF("<span/>").addClass("error-message");fm.prepend(T)}T.text(fn.message_text);return}}fm.find("span.error-message").remove();return ah.error()}else{fm.find("span.error-message").remove();if(fq.responseText.indexOf("err:")===0){fl=fq.responseText.substr(4);return ah.error(fl)}else{return ah.error()}}};return i})();cZ=E.TeamSharedFolderWizardModalPage1=(function(i){fc(j,i);function j(T,fl){this.user=T;this.options=fl;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=eA("Now, let's set up your team");this.options.vertical_offset=5}j.prototype.on_show=function(){var fm,fl,T,fn;fn=this.$modal_window.find(".suggestion-input");for(fl=0,T=fn.length;fl<T;fl++){fm=fn[fl];c5.register($(fm))}this.$modal_window.find("#validate-team-name").submit((function(fo){return function(fp){fp.preventDefault();return fo.on_confirm_button_click(fp)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return ba.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};j.prototype.on_confirm_button_click=function(fn){var fl,T,fm;fn.preventDefault();fm=this.$modal_window.find("#new-team-shared-folder-name-input").val();T=(function(fo){return function(){var fp;fp=new cY(fo.user,{team_name:fm,element_id:"team-shared-folder-wizard-modal-page2"});fo.hide();return fp.show()}})(this);fl=(function(fo){return function(fp){ba.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fo.user);return eK.show_validation_error(fp,fo.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fm,T,fl)};j.prototype.__fix_position=function(fl){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);cY=E.TeamSharedFolderWizardModalPage2=(function(i){fc(j,i);function j(T,fl){this.user=T;this.options=fl;this.__fix_position=b3(this.__fix_position,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=eA("Invite teammates");this.folder_name=this.options.team_name}j.prototype.before_show=function(){var T;T=eA("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":T})};j.prototype.on_show=function(){ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(T){return function(fl){fl.preventDefault();return T.on_confirm_button_click(fl)}})(this))};j.prototype.on_confirm_button_click=function(fo){var fm,fl,fn,fq,T,fp;fo.preventDefault();fq={emails:[]};ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(T=fn=1;fn<=10;T=++fn){fm=this.$modal_window.find("#new-team-shared-folder-email"+T).val();if(fm){fq.emails.push(fm)}}fl=d4.getForRole(ct.active_user.role);if(!fl.verified_or_show()){ba.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return fl.send_email("share_folder",(function(fr){return function(){var fs;fs=new cW(fr.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:fr.folder_name,invitees:fq,from_email_verification:true});fr.hide();return fs.show()}})(this))}else{ba.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fp=new cW(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fq,from_email_verification:true});this.hide();return fp.show()}};j.prototype.__fix_position=function(fl){var T;T=this.$modal_window.find(".db-modal");T.css;return{margin:"0",position:"fixed"}};return j})(a1);cW=E.TeamSharedFolderWizardModalPage3=(function(i){fc(j,i);function j(T,fl){this.user=T;this.options=fl;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=eA("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}j.prototype.on_show=function(){var fp,fn,fm,fl,fr,fq,fo,T;ba.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fs){return function(ft){ft.preventDefault();return fs.on_close_button_click(ft)}})(this));fr="";fq=true;fn=false;fl="all";fo=false;fp=null;T=(function(fs){return function(fv){var ft,fu;ft=JSON.parse(fv.responseText);ah.success(ft.success_msg);fu=new cU(fs.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fs.options.folder_name,invitees:fs.options.invitees,from_email_verification:true});fs.hide();return fu.show()}})(this);fm=(function(fs){return function(ft){return fs.hide()}})(this);return this.sharing_api.share_folder(fq,this.options.folder_name,this.options.invitees,fr,fn,fl,fo,fp,false,T,fm)};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.hide()};j.prototype.__fix_position=function(fl){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);cU=E.TeamSharedFolderWizardModalPage4=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;this.__fix_position=b3(this.__fix_position,this);i.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=eA("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}i.prototype.before_show=function(){var T;T=this.$modal_window.find("#back_to_home");T.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};i.prototype.on_show=function(){return ba.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};i.prototype.__fix_position=function(fl){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return i})(a1);cf=E.ShareNewFolderWizardModal=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;this.options.focus="#new-shared-folder-wizard input[type=text]";i.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Create a new shared folder");this.personal_title=eA("Create a shared folder in your personal Dropbox");this.work_title=eA("Create a shared folder in your %(team_name)s Dropbox")}i.prototype.on_show=function(){var fm,fl,T,fn;fn=this.$modal_window.find(".suggestion-input");for(fl=0,T=fn.length;fl<T;fl++){fm=fn[fl];c5.register($(fm))}this.$modal_window.find("#validate-folder-name").submit((function(fo){return function(fp){fp.preventDefault();return fo.on_confirm_button_click(fp)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fo){return function(fp){if(fo.options.back_fn){return fo.options.back_fn(fp,fo)}else{fp.preventDefault();fo.hide();return s.start_wizard_for_user(fo.user)}}})(this))};i.prototype.on_confirm_button_click=function(fn){var fm,fo,fl,T;fn.preventDefault();fo=this.$modal_window.find("#new-shared-folder-name-input").val();fl={folder_name:fo};ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,fl);bF(document).trigger("db:share_new_folder:next");T=(function(fp){return function(){var fq;fq=new cp(fp.user,{folder_name:fo,element_id:"invite-to-new-sf-wizard-modal-"+fp.user.id});fp.hide();fq.new_folder=true;fq.show();return ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fp.user,fl)}})(this);fm=(function(fp){return function(fq){var fr;fr=ch.extract_errors(fq.responseText);ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fp.user,fl);if(fr===false){}else{if(typeof fr==="string"){return ah.error(fr)}else{bF("#new-shared-folder-name-input .error-message").remove();return ch.fill_errors(bF("#validate-folder-name"),fr)}}}})(this);return this.sharing_api.validate_new_sf_path(fo,T,fm)};return i})(a1);db=E.ShareExistingFolderWizardModal=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;this._hide=b3(this._hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Choose folder to share");this.personal_title=eA("Choose a folder from your personal Dropbox");this.work_title=eA("Choose a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bF("#"+this.treeview_id).parent().attr("id");b2.schedule_reset();b2.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(T){return function(){var fl;bF(document).on("db:treeview_selected",function(fn,fm){return T.folder_name=fm});fl=bF(".first-treeview-link");if(!d6.ie){return fl.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(T){return function(fl){fl.preventDefault();T.hide();return s.start_wizard_for_user(T.user)}})(this))};i.prototype._hide=function(){b2.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return i.__super__._hide.apply(this,arguments)};i.prototype.on_hide=function(){return bF(document).off("db:treeview_selected")};i.prototype.on_confirm_button_click=function(fn){var fm,fl,T;fl={folder_name:this.folder_name};fn.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,fl);return s.show_shared_folder_options_modal(this.folder_name,this.user)}else{T=(function(fo){return function(){var fp;fp=new cp(fo.user,{folder_name:fo.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fo.user.id});fo.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fo.user,fl);fp.new_folder=false;return fp.show()}})(this);fm=(function(fo){return function(fp){return eK.show_validation_error(fp,fo.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,T,fm)}};return i})(a1);a2=E.CreateOrShareNewFolderWizardModal=(function(i){fc(j,i);function j(T,fl){this.user=T;this.options=fl;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this._extract_invitees=b3(this._extract_invitees,this);this._toggle_send_button_state=b3(this._toggle_send_button_state,this);j.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bm(this.user);this.state="Create"}j.prototype.on_show=function(){var fl,fm,fo,fn,T;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fo="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fm=fo+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fm);fl={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fm,fo+"-new-whobulk",fo+"-hidden-input",fl);if((fn=this.file_name_input)!=null){fn.keyup(this._toggle_send_button_state)}if((T=this.collab_input)!=null){T.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};j.prototype._toggle_send_button_state=function(){var fn,fm,fl,T;T=((fm=this.autocompleter)!=null?fm.token_manager.tokens.length:void 0)===0;T=T&&this.collab_input.val()==="";fn=this.file_name_input.val();fl=fn==="";this.$send_button.prop("disabled",fl);if(T){this.$send_button.text(eA("Create folder"));return this.state="Create"}else{this.$send_button.text(eA("Share folder"));return this.state="Share"}};j.prototype._extract_invitees=function(){var fq,fm,fp,fn,fl,fr,T,fo;fp=this.$modal_window.find(".tokenized_autocompleter_container");fr={};fo=["emails","fb_ids","group_ids","new_style_group_ids"];for(fn=0,T=fo.length;fn<T;fn++){fm=fo[fn];fl=fp.find("input[name="+fm+"]");fr[fm]=(function(){var ft,fs,fu;fu=[];for(ft=0,fs=fl.length;ft<fs;ft++){fq=fl[ft];fu.push(bF(fq).val())}return fu})()}return fr};j.prototype.on_confirm_button_click=function(fv){var fm,fs,fp,fx,fq,ft,fn,fo,T,fr,fu,fw,fl;fv.preventDefault();T=this.file_name_input.val();fx=eA("We can\u2019t create folder '%(folder_name)s'");fx=fx.format({folder_name:T});fp=function(){return ah.error(fx)};if(this.state==="Create"){fl="/cmd/new"+d6.urlquote(this.destination_dir);fr={to_path:T};fr[a9.UID_PARAM_NAME]=this.user.id;fw=function(){var fy;fy=eA("Created new folder '%(folder_name)s'");fy=fy.format({folder_name:T});return ah.success(fy)};new cE.WebRequest({url:fl,data:fr,success:fw,error:fp})}else{this.autocompleter.tokenize_emails_input(true);ft=this._extract_invitees();fw=function(){var fy;fy=eA("Shared new folder '%(folder_name)s'");fy=fy.format({folder_name:T});return ah.success(fy)};fo="";fs=false;fn="all";fu=false;fm=null;fq=this.destination_dir+"/"+T;this.sharing_api.share_path(fq,ft,fo,fs,fn,fu,fm,false,fw,fp)}return this.hide()};return j})(d7);dY=E.CreateLinkOrInviteToFolderWizardModal=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eA("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.options.path),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var T,fl,fm;T="edu_modal";fm=(fl=this.options.target_item)!=null?fl:null;ba.ShmodelUILogger.log("view",T,fm);this.$modal_window.find(".option-to-share-folder").on("click",(function(fn){return function(fp){var fo;if(fn.options.existing_sf){ba.ShmodelUILogger.log("sf_options",T,fm);fo=new dg(ct.active_user,fn.options.path)}else{ba.ShmodelUILogger.log("sf_invite",T,fm);fo=new cp(fn.user,{folder_name:fn.options.path,element_id:"invite-to-new-sf-wizard-modal-"+fn.user.id})}fn.hide();return fo.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(fn){return function(fo){ba.ShmodelUILogger.log("token_share",T,fm);dx.shmodel(fn.options.path,"create_link_or_invite_to_folder_modal");return fn.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(fn){return function(fo){fo.preventDefault();ba.ShmodelUILogger.log("clicked_learn_more",T,fm);return window.open("/help/274","_blank")}})(this))};return i})(d7);cp=E.InviteToNewSharedFolderWizardModal=(function(j){fc(i,j);function i(T,fl){this.user=T;this.options=fl;this.insert_folder_settings=b3(this.insert_folder_settings,this);this.share_folder=b3(this.share_folder,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.show_settings_modal=b3(this.show_settings_modal,this);this.show_m2_settings_modal=b3(this.show_m2_settings_modal,this);this._toggle_get_link_button_visibility=b3(this._toggle_get_link_button_visibility,this);this.options.focus=".new-collab-input";i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user);this.folder_name=this.options.folder_name;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false;this.has_inviter_restriction=this.options.has_inviter_restriction}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eA("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var fl,fn,fm,T,fp,fo;fo=this.$modal_window.find(".suggestion-input");for(fm=0,T=fo.length;fm<T;fm++){fn=fo[fm];c5.register($(fn))}fl=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fp="invite-wizard-"+this.user.id;this.invite_form_controller=new df(this.user,fl,[],[],[],fp);this.insert_folder_settings(this.invite_form_controller.team_only?"team":"")}else{this.invite_form_controller.listen()}this.get_link_button=this.$modal_window.find(".get-editable-link-invite");if(this.get_link_button.length>0){B.showInstance(dC.createElement(B,{onDismiss:eF.dismissM2Prompt,shouldShow:ct.simple_sharing_show_m2_prompt,targetedButton:this.get_link_button.get(0)}));ba.SimpleSharingLogger.log(this.user.id,27)}this.collab_input=this.$modal_window.find(".new-collab-input");this.collab_input.focus();this.collab_input.keyup(this._toggle_get_link_button_visibility);if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_get_link_button_visibility);this.collab_input[0].on("token:add",this._toggle_get_link_button_visibility)}this.$modal_window.find(".change-new-folder-settings").on("click",(function(fq){return function(fr){fr.preventDefault();return fq.show_settings_modal()}})(this));this.$modal_window.find(".m2-settings-link").on("click",(function(fq){return function(fr){fr.preventDefault();return fq.show_m2_settings_modal()}})(this));this.$modal_window.find(".get-editable-link-invite").on("click",(function(fq){return function(fv){var fw,fu,fs,fr,ft;fv.preventDefault();bF(document).trigger("collab:m2:prompt:dismiss");fr=fq.$modal_window.find(".m2-settings-link");if(fr.length>0){fq.inviter_restriction=fq.has_inviter_restriction?"me":"all"}ba.SimpleSharingLogger.log(fq.user.id,28);fw=fq.$modal_window.find(".get-link-invite-loading");if(fw!=null){fw.show()}ft=function(fz){var fB,fA,fD,fy,fx,fC;if(fw!=null){fw.hide()}fy=bb.parse_response(fz),fC=fy[0],fD=fy[1];if(fC){return eF.createAndShowM2InbandModal(fq.user,fq.folder_name)}else{fx=bb.parse_error(fD),fA=fx[0],fB=fx[1];if(fA){return ah.error(fB)}else{return ah.error(eA("Failed to create link."))}}};fs=function(){if(fw!=null){fw.hide()}return ah.error(eA("Failed to create link."))};fu={path:fq.folder_name,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:true,folder_settings:1,shared_link_policy:fq.shared_link_policy_restriction,audience:fq.audience_restriction,inviter:fq.inviter_restriction};if(fq.audience_restriction||fq.inviter_restriction){fu.custom_folder_settings=1}return cE.FormWebRequest({subject_user:fq.user.id,url:"/share_ajax/existing_no_recipient",data:fu,success:ft.bind(fq),error:fs.bind(fq),skipErrorHandling:true})}})(this));this.log_extras={path:this.folder_name};return ba.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras)};i.prototype._toggle_get_link_button_visibility=function(){var fo,fn,fm,fl,T;if(this.shared_link_policy_restriction==="1"){if((fm=this.get_link_button)!=null){fm.hide()}return}fn=this.invite_form_controller.get_token_count()===0;fo=this.collab_input&&this.collab_input.val()==="";if(fn&&fo){return(fl=this.get_link_button)!=null?fl.show():void 0}else{return(T=this.get_link_button)!=null?T.hide():void 0}};i.prototype.show_m2_settings_modal=function(){var fl,T;fl=this.folder_name;T=function(fm){var fn;fn=new i(ct.active_user,{folder_name:fl,element_id:"invite-to-new-share-file-wizard-modal-"+ct.active_user.id,has_inviter_restriction:!fm});return fn.show()};d1.pop();return ae.showInstance(dC.createElement(ae,{user:this.user,fq_path:this.folder_name,is_shared_folder:false,initial_allows_editor_manage_membership:!this.has_inviter_restriction,done_callback:T}))};i.prototype.show_settings_modal=function(){var fl,T;T=eA("'%(folder_name)s' settings");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),13)});fl={folder_name:this.folder_name};if(this.audience_restriction){fl.audience=this.audience_restriction}if(this.inviter_restriction){fl.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){fl.shared_link_policy=this.shared_link_policy_restriction}fl[a9.UID_PARAM_NAME]=this.user.id;d1.register(cB.SAVED_PERMISSIONS,(function(fm){return function(fo,fn){fm.insert_folder_settings(fn.audience,fn.inviter,fn.shared_link_policy);return fm.invite_form_controller.reset_options()}})(this));return d1.push(new cD({element_id:"folder-permissions-modal",title:T,endpoint_url:"/share_ajax/default_folder_settings",parameters:fl}))};i.prototype.on_confirm_button_click=function(fn){var fm,fp,fl,T,fo;fn.preventDefault();this.invite_form_controller.tokenize();fp=this.invite_form_controller.extract_invitees();fo=this.invite_form_controller.get_custom_message();fm=this.invite_form_controller.get_access_type();fl=this.$modal_window.find("input#allow_other_members_to_share");if(fl.length>0){this.inviter_restriction=fl.is(":checked")?"all":"me"}T=this.$modal_window.find(".m2-settings-link");if(T.length>0){this.inviter_restriction=this.has_inviter_restriction?"me":"all"}return this.share_folder(fp,fo,fm,true,false)};i.prototype.share_folder=function(fp,fm,T,fq,fo,fl){var fu,fn,fr,ft,fs;if(fq==null){fq=true}if(fo==null){fo=false}if(fl==null){fl=false}fn=(function(fv){return function(fw){return eK.show_validation_error(fw,fv.$modal_window.find(".tokenized_autocompleter_container"))}})(this);ft=(function(fv){return function(fy){var fx,fw;fw=JSON.parse(fy.responseText);ah.success(fw.success_msg);if(fv.progress_ever_blocked_by_verify){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fv.user,fr)}document.fire(aH.SF_NEW,{sf_info:bZ.decode_sort_key(fw.sf_info)});if(fq){fv.hide()}if(fl){fx=new dg(fv.user,aA.normalize(fv.folder_name));return fx.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,fr);this.$modal_window.find(".confirm-button").prop("disabled",true);fs=eA("Verification email sent to %(email)s").format({email:this.user.email});fu=d4.get_for_user(this.user);fu.send_email("share_folder",function(){return ah.success(fs)});bF("#resend-email-verification-link").click(function(){return fu.send_email("share_folder",function(){return ah.success(fs)})});this.$modal_window.find(".email-verify-message").show();return fu.ensure_polling((function(fv){return function(){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fv.user,fr);ah.success(eA("Email verified. Try sharing your folder again."));fv.$modal_window.find(".confirm-button").prop("disabled",false);return fv.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,fp,fm,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,T,fo,ft,fn);fr={path:this.folder_name,access_type:T};ba.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,fr);return bF(document).trigger("db:invite_to_new_folder:share")}};i.prototype.insert_folder_settings=function(T,fl,fn){var fm;this.audience_restriction=T;this.inviter_restriction=fl;this.shared_link_policy_restriction=fn;fm=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(ct.inside_team_folder){fm.addClass("in-team-folder");fm.removeClass("team-only")}else{fm.removeClass("in-team-folder");if(this.audience_restriction==="team"){fm.addClass("team-only")}else{fm.removeClass("team-only")}if(this.user.role==="work"){this.invite_form_controller.set_team_only(this.audience_restriction==="team")}}return this._toggle_get_link_button_visibility()};return i})(d7);al=E.NewSharedFolderPermissionsModal=(function(i){fc(j,i);function j(fl,fp,T,fm){var fo,fn;this.user=fl;this.path=fp;this.saved_state=T;this.done_callback=fm;fo={folder_name:this.path,audience:this.saved_state.audience?this.saved_state.audience:void 0,inviter:this.saved_state.inviter?this.saved_state.inviter:void 0,shared_link_policy:this.saved_state.shared_link_policy?this.saved_state.shared_link_policy:void 0,is_file:false};fo[a9.UID_PARAM_NAME]=this.user.id;fn=eA("\u2018%(folder_name)s\u2019 settings");fn=fn.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});d1.register(cB.SAVED_PERMISSIONS,(function(fq){return function(fs,fr){return fq.done_callback.bind(null,fr.audience,fr.inviter,fr.shared_link_policy)()}})(this));j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fn,endpoint_url:"/share_ajax/default_folder_settings",parameters:fo})}return j})(cD);cB=E.NewSharedFolderPermissionsContent=(function(){i.SAVED_PERMISSIONS="new_sf_permissions:saved";function i(j){this.$form=j;this._submit=b3(this._submit,this);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d1.pop()};i.prototype._submit=function(fm){var T,fl,j;fm.preventDefault();T=this.$form.find("input[name=audience]:checked").val();fl=this.$form.find("input[name=inviter]:checked").val();j=this.$form.find("input[name=shared_link_policy]:checked").val();d1.trigger(i.SAVED_PERMISSIONS,{audience:T,inviter:fl,shared_link_policy:j});return d1.pop()};return i})();var dx;dx=E.SharingShmodel=(function(){function i(){}i.shmodel=function(T,j){return new dh(ct.active_user.id,T,j).show()};return i})();var bZ;bZ=INLINE_JS.Sharing=E.Sharing={init:function(fn,fm,T,fl,j,i){this.show_inbox=j;this.simple_sharing_enabled=i;this._decode_sort_keys(fm);this._state={sf_info:fm,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:T,delay_reload_folder:false};if(cM.get_viewer().is_paired){this.role_picker=C.controller(bF("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bO.set_during_login_callback((function(fo){return function(fq,fp){return fo._reload_folder_info(function(){return fp()},function(fr){fp(eA("Error displaying shared folders"));return window.location.reload()})}})(this))}this._listen();this._tmpl=fg.tmpl("sf_list_item_tmpl");if(!fn){this._display_spinner()}else{this._render()}if(T||!fn){cE.WebRequest({url:"/share_ajax/list_folders",dataType:"json",data:{start:fl},success:(function(fo){return function(fp){fo._load_and_render_sf_list(fp);return eg.mark_time_to_interactive()}})(this),error:(function(fo){return function(fp){return fo._sf_list_error()}})(this)})}this.refresh_inbox_counts(true);this._display_view();return bF(document).on(bm.REQUEST_SUCCEEDED_EVENT,(function(fo){return function(fp,fq){if(fq.request_url==="/share_ajax/cancel_invite"||fq.request_url==="/share_ajax/invite_more"||fq.request_url==="/share_ajax/kick_user"){return fo._reload_folder_info()}}})(this))},_load_and_render_sf_list:function(i){this._decode_sort_keys(i);if(this._state.sf_loading){this._state.sf_info.current.push.apply(this._state.sf_info.current,i.current);this._state.sf_info.past.push.apply(this._state.sf_info.past,i.past);this._state.sf_loading=false}this._hide_spinner();this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ah.error(eA("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(i){return[i.current,i.past].each((function(j){return function(T){return T.each(function(fl){return j.decode_sort_key(fl)})}})(this))},decode_sort_key:function(i){cL((i.encoded_sort_key!=null)&&(i.sort_key==null),"expected encoded sort keys on each elm");i.sort_key=d6.decode_sort_key(i.encoded_sort_key);delete i.encoded_sort_key;return i},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(T,i){var j;if(!this.is_share_page()){return}j=(function(fl){return function(fm){var fn;fn=JSON.parse(fm.responseText);fl._decode_sort_keys(fn);fl._state.sf_info=fn;fl._render();return typeof T==="function"?T():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cr().get_folder_info(j,i)}},refresh_inbox_counts:function(i){return new cr().get_inbox_counts((function(j){return function(T){return j._update_inbox_counts(T,i)}})(this))},_update_inbox_counts:function(j,fm){var fp,T,i,fo,fn,fl;fl=0;for(fo in j){fp=j[fo];fl+=fp}bF("#inbox-count").text(fl);bF("#inbox-count").toggleClass("show",fl>0);if(!this.is_share_page()){return}T=function(fr,fq){var fs;for(fo in fr){fs=fr[fo];if(fq[fo]!==fr[fo]){return false}}return true};if((!fm)&&this._state&&T(this._state.inbox_counts,j)){return}this._state.inbox_counts=j;if(fl){i=new Element("a",{id:"new-invites-link",href:"#"});i.__sert(cx.make("web","email_32",{"class":"link-img"}));fn=bd("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",fl);fn+=" \n";fn=fn.format({total_count:fl});i.__sert(fn);i.observe("click",(function(fq){return function(fr){Event.stop(fr);return fq.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(i)}else{$("invites-box").hide()}if(fl>0&&this.show_inbox){this.show_inbox=false;return this.show_invites()}},register_accept:function(i){bF(i).closest(".sf-invite-action").addClass("loading");new by(bF(i),i.action,{data:bT.collect_form_vars(i),complete:(function(j){return function(fl,T){bF(i).closest(".sf-invite-action").removeClass("loading");j.refresh_inbox_counts();return j._reload_folder_info()}})(this),success:(function(j){return function(fo,T,fq){var fm,fn,fp,fl;fo=(fl=JSON.parse(fq.responseText))!=null?fl.data:void 0;fm=bF(i).closest(".sf-invite-action");fm.addClass("sf-accepted");if(fo!=null?fo.redirect:void 0){if(j._state&&j._state.current_total_count>1){fn=fm.find(".view-folder-button");return fn.click(function(){return window.location.href=fo!=null?fo.redirect:void 0})}else{return window.location.href=fo!=null?fo.redirect:void 0}}else{fp=bF(i).closest(".invitation-row").attr("data-invite-id");return j._remove_invite_row(fp)}}})(this)});return false},register_decline:function(j,fl,fm){var i,T;i=bF(j).closest("form");if((T=i.closest(".sf-invite-action"))!=null){T.addClass("loading")}if(i.length){new by(i,i[0].action,{data:bT.collect_form_vars(i[0]),complete:(function(fn){return function(fq,fo){var fp;if((fp=i.closest(".sf-invite-action"))!=null){fp.removeClass("loading")}fn._remove_invite_row(fl);fn.refresh_inbox_counts();fn._reload_folder_info();if(fm){return fm()}}})(this)})}return false},_remove_invite_row:function(fm){var i,fl,T,j;i=bF("#invites-container");fl=i.find('[data-invite-id="'+fm+'"]');if(fl){j=fl.parent("tbody");fl.remove();if(j.children().length===0){i.find(".invitation-table-container").hide();i.find(".message-bottom").removeClass("message-bottom");i.find(".message-top").removeClass("message-top");if(i.find(".invites-message").length===0){T=d7.get_containing_modal(i);return T!=null?T.hide():void 0}}}},_listen:function(){var T,j,i;this.listen_modals();T=(function(fl){return function(fo,fw,fq){var fr,fn,fv,fp,fs,fu,fm,ft,fx;fm=fl._get_current_sf_list_info(fq),fu=fm[0],fv=fm[1];cL(fw,"SF _transfer w/o target_ns_id");for(fr=fp=0,fs=fu.length;fp<fs;fr=++fp){fn=fu[fr];if(fn.target_ns_id===fw&&fn.user_id===fo){ft=fn;fx=fr;break}}cL(fx!=null,"SF _transfer w/o js obj");return[ft,fx]}})(this);i=(function(fl){return function(fq,fw,ft){var fv,fm,fs,fp,fr,fx,fu,fo,fn;fm=fl._get_current_sf_list_info(fw),fv=fm[0],fn=fm[1];fs=fl._get_current_sf_list_info(ft),fu=fs[0],fo=fs[1];fp=T(fq.memo.user_id,fq.memo.target_ns_id,fw),fr=fp[0],fx=fp[1];fv.splice(fx,1);fl._empty_check(fw);if(fq.memo.filename!=null){fr.filename=fq.memo.filename}if(fq.memo.mount_point!=null){fr.mount_point=fq.memo.mount_point}fu.push(fr);return fl._render()}})(this);j=(function(fl){return function(fr,fo){var ft,fp,fn,fq,fs,fm;fp=fl._get_current_sf_list_info(fo),ft=fp[0],fm=fp[1];fn=T(fr.memo.user_id,fr.memo.target_ns_id,fo),fq=fn[0],fs=fn[1];ft.splice(fs,1);return fl._render()}})(this);document.observe(aH.SF_UNSHARE,(function(fl){return function(fm){return j(fm,"#sf-current")}})(this));document.observe(aH.SF_LEAVE,(function(fl){return function(fm){return i(fm,"#sf-current","#sf-past")}})(this));document.observe(aH.SF_REJOIN,(function(fl){return function(fm){i(fm,"#sf-past","#sf-current");return fl._reload_folder_info()}})(this));document.observe(aH.SF_IGNORE,(function(fl){return function(fm){return j(fm,"#sf-past")}})(this));document.observe(aH.SF_NEW,(function(fl){return function(fn){var fm;fm=fn.memo.sf_info;cL(fm,"SF_NEW without info");if(fl._state.sf_loading){return fl._reload_folder_info()}else{fl._state.sf_info.current.push(fm);return fl._render()}}})(this));$("create-share").observe("click",(function(fl){return function(fm){ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fm);return s.start_wizard_without_user()}}})(this));bF("#learn-more-link").click((function(fl){return function(fm){return ba.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(fl){return function(fm){Event.stop(fm);return fl.show_invites()}})(this))}bF("#sf-current, #sf-past").each((function(fl){return function(fm,fn){var fo;fo=["#sf-current","#sf-past"][fm];bF(".sf-list",fn).on("click","a.options-link",function(fr){var fp,fv,ft,fx,fs,fy,fw,fu,fq;fr.preventDefault();fv=bF(fr.target).closest("a.options-link");fs=fv.attr("data-type");fp=fv.attr("data-filename");fx=fv.attr("data-mount");fu=parseInt(fv.attr("data-nsid"),10);fq=cM.get_viewer().get_user_by_id(fv.attr("data-user_id"));fw=bF(fr.target).closest("li.sf-folder").data("role");fy=fv.attr("data-sf-perm-role");if(fs==="normal"){if(fl.simple_sharing_enabled){if(d4.get_for_user(fq).verified_or_show()){eF.createAndShowInbandModal(fq,fx,true,fu,true,false,fy)}}else{s.show_shared_folder_options_modal(fx,fq)}}else{if(fs==="remove"){s.show_ignore_modal(fq,fp,fu)}else{if(fs==="rejoin"){s.show_rejoin_modal(fq,fp,fu)}}}ft={option_type:fs};if(fu){ft.ns_id=fu}if(fx){ft.path=fx}return ba.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fq.id,ft,true)});bF(".sf-sort",fn).on("click","a.sort-option",function(fr){var fq,fp,fs;fr.preventDefault();fq=bF(fr.target).closest("a.sort-option");fs={SF_BY_NAME:fl._name_cmp,SF_BY_MODIFIED:fl._modified_cmp};fp=fs[fq.attr("data-sort")];if(fl._state.cmp[fo]===fp){fl._state.is_ascending[fo]=!fl._state.is_ascending[fo]}else{fl._state.cmp[fo]=fp;fl._state.is_ascending[fo]=true}d6.add_sort_arrow_mouseover_j(fq,fl._state.is_ascending[fo],fo+" .sf-sort a.sort-option",true);return fl._render_list_id(fo)});return d6.add_sort_arrow_mouseover_j(bF(".modified-sorter",fn),fl._state.is_ascending[fo],fo+" .sf-sort a.sort-option",false)}})(this));return bF(".empty-share-button").click((function(fl){return function(fm){fm.preventDefault();ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return s.start_wizard_without_user()}})(this))},listen_modals:function(){return bF("#new-or-existing-sf li").click((function(i){return function(T){var j;bF("#new-or-existing-sf li").removeClass("active");j=bF(T.target).closest("li");j.find("input").prop("checked",true);return j.addClass("active")}})(this))},_showing_two_accounts:function(){var i;return cM.get_viewer().is_paired&&((i=this.role_picker)!=null?i.get_state():void 0)===d2.ALL},_render:function(){this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bF("#sf-current").hasClass("empty-list")&&bF("#sf-past").hasClass("empty-list")){bF("#page-content").addClass("no-shares");return bF("#empty-content").show()}else{bF("#page-content").removeClass("no-shares");return bF("#empty-content").hide()}},_render_list_id:function(fl){var ft,fq,fs,T,fn,fo,fp,i,fm,fr;i=this._get_current_sf_list_info(fl),fo=i[0],fs=i[1];fr=this._showing_two_accounts();ft=(function(j){return function(fu,fw){var fv;fv=j._state.is_ascending[fl]?1:-1;return fv*j._state.cmp[fl](fu,fw,fr)}})(this);fo.sort(ft);fp=bF(".sf-list",fl);fp.empty();for(T=0,fn=fo.length;T<fn;T++){fm=fo[T];if(this._should_render(fm)){fq=this._tmpl({options_str:eA("Options"),remove_str:eA("Remove"),rejoin_str:eA("Rejoin"),is_past:fs,sf:fm,Sprite:cx,Emstring:bU,Util:d6,_:eA});fp.append(fq.toHTML())}}return this._empty_check(fl)},_should_render:function(i){if(this.role_picker!=null){return this.role_picker.is_role_visible(i.role)}else{return true}},_empty_check:function(fl){var T,j,i;j=this._get_current_sf_list_info(fl),T=j[0],i=j[1];if(bF(".sf-list",fl).children().length){return bF(fl).removeClass("empty-list")}else{return bF(fl).addClass("empty-list")}},_get_current_sf_list_info:function(i){switch(i){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cL(false,"invalid sf list id")}},_name_cmp:function(j,T,i){if(i){return d6.sort_by_key(j,T)}else{return d6.sort_by_rank_or_key(j,T)}},_modified_cmp:function(j,T,i){return j.modified_ts-T.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var T,j,i;this._state.current_total_count=0;j=this._state.inbox_counts;for(i in j){T=j[i];this._state.current_total_count+=T}if(this._state.current_total_count>0){return s.show_invites()}},_display_view:(function(i){return function(){return bF("#sf-view").show()}})(this),_hide_view:(function(i){return function(){return bF("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return bF(".sf-spinner").show()},_hide_spinner:function(){return bF(".sf-spinner").hide()}};var br;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fl,fm,T,fq){var fp,j,fo,i,fn;this.user=fl;this.baseInitialize(fm,T,fq);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;j=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}fn=this.options.include_team===true;i=this.options.include_new_style_groups===true;fo=this.options.include_me===true;this.profile_services=bk.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new ea();this._autocompleter_profile_services_item_tmpl=fg.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;fp=(function(fr){return function(fs){if(fr.options.include_from_linked_accounts&&fr.options.viewer){fs=fs.includeForViewer(fr.options.viewer)}else{fs=fs.includeForUser(fr.user.id)}if(fr.options.contact_filter){fs=fr.options.contact_filter(fs)}else{if(!j){fs=fs.excludeFacebook()}if(!i){fs=fs.excludeNewStyleGroups()}if(!fn){fs=fs.excludeTeamMembers()}if(!fo){fs=fs.excludeMe()}}return fr.setContacts(fs)}})(this);(function(){var fr;return b0.load_contacts(fr=false,(function(fs){fp(fs);return b0.register_for_updates("autocompleter_contacts",fp)}))}).defer();return this.options.onShow=function(fr,fs){if(!fs.style.position||fs.style.position==="absolute"){fs.style.position="absolute";bF(fs).clonePosition(bF(fr),{setHeight:false,setTop:false,setLeft:false})}return bF(fs).fadeTo(150,1)}},link_callback:function(i){return ea.show_import_notifications(i)},getToken:function(){var i;i=this.getTokenBounds();return this.element.value.substring(i[0],i[1])},listen:function(){var i;this.install_profile_services_link_listener();i=(function(j){return function(T){if(j.profile_services.has_connected_services()){return}if(bF(j.element).val()){return}j.activate();setTimeout(function(){var fl;return(fl=j.get_entry_container())!=null?fl.show():void 0},300);return true}})(this);return bF(this.element).click(i)},install_profile_services_link_listener:function(){var i;Event.stopObserving(this.element,"blur");i=(function(j){return function(fl){var T;T=j.get_entry_container();if(bF(fl.target).hasClass("new-collab-input")&&bF(T).hasClass("people-default-show-import-shmodal-experiment")){return}if(!bF(fl.target).closest("li").hasClass("profile-services-link-handler")){if(bF(T).hasClass("people-default-show-import-shmodal-experiment")){bF(T).removeClass("people-default-show-import-shmodal-experiment");ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_LINK_DISMISS,j.user.id)}return T!=null?T.hide():void 0}}})(this);bF(this.element).closest(".db-modal-box").click(i);return bF(this.element).closest("#modal-box").click(i)},get_entry_container:function(){var i;return(i=this.element.up(".tokenized_autocompleter_container"))!=null?i.down(".autocomplete"):void 0},profile_services_show:function(){var fl,T,j,i;fl=this.get_entry_container();if(((T=fl.firstChild)!=null?(j=T.firstChild)!=null?j.value:void 0:void 0)>0){this.old_display=fl.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((i=$("flash_copy_container"))!=null){i.hide()}return this.element.focus()},profile_services_render_buttons:function(){var i;i=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(i.join(""))+"</ul>")},get_profile_services_button_list:function(){var T,fm,j,fo,fn,fl;fl=[];fn=c2.contact_services();for(fm=0,j=fn.length;fm<j;fm++){fo=fn[fm];cL(this.profile_services.is_updated,"profile_services has not been updated");T="";if(this.profile_services.service_is_connected(fo)){T=eA("Connected")}else{if(this.profile_services.service_was_connected(fo)){T=eA("Reconnect")}}fl.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fo,email_provider_img:c2.to_img(fo),email_provider_name:c2.to_name(fo),bottom_text:T}).toHTML())}return fl},update_import_contacts_link:(function(i){return function(j){i.profile_services=j;if(i.profile_services.has_unconnected_services(true)){return bF(i.element).closest("form").find(".import-contacts-link").show()}else{return bF(i.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bF(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bF("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(i){this.options.array=i.contacts;this.options.larray=i.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var T,j,i;j=this.getCurrentEntry();T=this.options.array[j.value];if(T.type===W.FB||T.type===W.NEW_STYLE_GROUP){j.innerHTML=T.name}else{j.innerHTML=T.email}if(this.options.tokens.length>1){i=this.options.tokens[0]+" "}else{i=""}j.innerHTML+=i;this.active=false;this.updateElement(j);return bF(this.element).trigger("db:autocompleted")}},br=function(i,j){var T;T=bF("<div>");T.addClass(i);if(typeof j==="string"||j instanceof String){T.text(j)}else{T.append(j)}return T},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(j){var i;if(j==null){j={}}i={choices:5,selector:(function(T){return function(){var fo,fD,fC,fw,fy,fP,fq,f3,f4,fr,fN,fZ,fH,fY,fA,fx,fO,fM,fX,fv,fW,fV,fp,fL,fz,ft,fs,f2,fI,fR,fJ,fQ,fl,fU,f0,fu,fB,fK,fm,fS,fE,fG,fT,fn,f1,fF;fE=[];fN=T.getToken().toLowerCase();fV=T.options.array.length;fy=T.options.array;fR=T.options.larray;fS=[];if(fN.indexOf(" ")===-1){fS.push("\\s+")}if(fN.indexOf("+")===-1){fS.push("\\+")}if(fN.indexOf("@")===-1){fS.push("@")}if(fN.indexOf(".")===-1){fS.push("\\.")}if(fN.indexOf("&lt;")===-1){fS.push("&lt;")}fm=RegExp("("+fS.join("|")+")");fO=0;while(fN.length>0&&fO<fV){fw=fy[fO];fI=fR[fO];fZ=-1;fr=[];fQ=[];fx="";switch(fw.type){case W.EMAIL:fr.push(fw.name,fw.email_snippet);fQ.push(fI.name,fI.email);fx="/static/images/icons/mail28-vflHfHPJ0.png";break;case W.FB:fr.push(fw.name);fQ.push(fI.name);if(bZ.use_fb_profile_pics){fx="https://graph.facebook.com/"+fI.fb_id+"/picture"}else{fx="/static/images/icons/fb24-vflGnjfAv.png"}break;case W.NEW_STYLE_GROUP:fr.push(fw.name,fw.members);fQ.push(fI.name,"");fx="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fD=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fw.name);fC=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fw.name);fH=bF("<span class='group-icon'>").css("border-color",fD).css("color",fD).text(fC)}break;default:cL(false,"should never get here due to type: "+(fw.type+", "+fw.name+", "+fw.email+", "+fw))}for(fv=fY=0,fz=fQ.length;fY<fz;fv=++fY){fJ=fQ[fv];f0=fS.length?fJ.split(fm):[fJ];fq=0;for(fX=0,ft=f0.length;fX<ft;fX++){fU=f0[fX];if(!fU){continue}if(fU.indexOf(fN)===0){fZ=fq;break}fq+=fU.length}if(fZ!==-1){fK=((fN.length/fU.length)*9.4).toFixed(0);if(fw.sort_key!=null){fK+=fw.sort_key}fp=document.createTextNode(fr[fv].substr(0,fZ));fl=bF("<strong>").text(fr[fv].substr(fZ,fN.length));fT=document.createTextNode(fr[fv].substr(fZ+fN.length));fr[fv]=[fp,fl,fT];break}}if(fw.type===W.FB){fr.push(eA("Facebook message"))}if(fZ!==-1){if(fx){fA=bF('<img width="28px" height="28px">').attr("src",fx)}else{if(fH){fA=fH}}fu=br("autocomplete-line",fr[0]);fF=br("autocomplete-line autocomplete-secondary",fr[1]);fL=br("autocomplete-left",fA);fn=br(null,[fu,fF]);f2=bF("<li>").attr("value",fO).append(fL,fn);fE.push([fK,f2])}fO++}fE.sort(function(f6,f5){if(f6[0]<f5[0]){return 1}else{if(f6[0]>f5[0]){return -1}else{return 0}}});T._num_query_results=fE.length;fE=fE.slice(0,T.options.choices);fG=bF("<ul>");for(fW=0,fs=fE.length;fW<fs;fW++){f1=fE[fW];fG.append(f1[1])}T._num_contacts_shown=fE.length;if(!bF(T.element).hasClass("no-profile-services-link-handler")){if(T.profile_services.has_unconnected_services(true)){fP=bF(T.element).closest(".tokenized_autocompleter_container");fB=fP.attr("data-provider");fM=fB===c2.GOOGLE?eA("Select from your Gmail contacts"):fB===c2.YAHOO?eA("Select from your Yahoo contacts"):eA("Select from your contacts");f3=false;if((fB===c2.GOOGLE||fB===c2.YAHOO)&&!T.profile_services.service_is_connected(fB)){f3=true}else{if(T.profile_services.has_connected_services()){f3=false;fM=eA("Import Contacts")}}if(f3){f4=T._autocompleter_profile_services_item_tmpl({email_provider_num:fB,email_provider_img:c2.to_img(fB),email_provider_name:fM,bottom_text:""}).toHTML();fG.append(f4)}else{fA=cx.make("web","user_add");fu=br("autocomplete-line autocomplete-line-center",fM);fL=br("autocomplete-left",fA);fn=br(null,[fu]);f2=bF("<li>").addClass("profile-services-link-handler").append(fL,fn);fG.append(f2)}}}fo=fG.wrap("<span>").parent().html();T.old_contents=fo;return fo}})(this)};return this.options=Object.extend(i,j)}});var cO;cO=E.Token=Class.create({initialize:function(j,i,T,fl){this.element=$(j);this.token_manager=T;this.hidden_input=i;this.element.token=this;this.selected=false;this.info=fl;return bF(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var i;this.token_manager.token=this;if((i=this.hidden_input)!=null){i.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(i){if(i&&i.preventDefault){i.preventDefault()}if(this.detect(i)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(i){return this.token_manager.remove(this)},detect:function(fl){var j,T,i;T=fl.target?fl.target:fl.srcElement;i=T.token;j=T;while((i==null)&&j.parentNode){j=j.parentNode;i=j.token}return(i!=null)&&i.element===this.element}});var Q;Q=E.TokenManager=Class.create({initialize:function(T,fl,j,i){this.contact_search_logger=i;this.shift_boundary_right_func=fl;this.shift_boundary_left_func=j;this.element=T;this.tokens=[];return this.token=null},add:function(i){this.tokens.push(i);return this.element.fire("token:add",i.info)},populate:function(){var fp,fm,j,fl,T,fo,fn;fn=this.element.select(".token");fl=[];for(fm=0,j=fn.length;fm<j;fm++){fo=fn[fm];fp=fo.hasClassName("token-warn");T=new cO(fo,null,this,{external:fp});fl.push(this.add(T))}return fl},remove:function(j){var i;if(j==null){j=this.token}if(j!=null){this.contact_search_logger.flag_record_as_removed(j.info.value);i=this.tokens.indexOf(j);this.tokens.splice(i,1);j.element.remove();if(this.token===j&&i<this.tokens.length){this.tokens[i].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",j.info)}},removeAll:function(){var fm,j,fl,T,fn;fn=this.tokens.slice(0);this.tokens.clear();fl=[];for(fm=0,j=fn.length;fm<j;fm++){T=fn[fm];T.element.remove();fl.push(this.element.fire("token:remove",T.info))}return fl},shift_left:function(){var i;i=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(i>0){if(this.token){this.token.deselect()}return this.tokens[i-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var i;i=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(i+1<this.tokens.length){return this.tokens[i+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var d9;d9=E.HiddenInput=Class.create({initialize:function(i,T,j){this.element=$(i);this.auto_complete_element=T;this.token_manager=j;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(i){switch(i.keyCode){case Event.KEY_LEFT:i.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,i,fl,fn,T,j){var fm;this.user=i;$super(this.user,fl,fn,j);this.contact_search_logger=new ba.ContactSearchLogger;this.token_manager=new Q(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new d9(T,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bF(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fo,fp){bF(fp).clonePosition(bF(fo.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fp.show()};this.options.onHide=function(fo,fp){fp.hide();if(bF(fp).hasClass("people-default-show-import-shmodal-experiment")){return bF(fp).removeClass("people-default-show-import-shmodal-experiment")}};this.max_textbox_height=270;if(j.max_textbox_height!=null){this.max_textbox_height=j.max_textbox_height}this.members=[];if(j.members!=null){this.members=j.members}this.invitees=[];if(j.invitees!=null){this.invitees=j.invitees}this.new_style_groups=[];if(j.new_style_groups!=null){this.new_style_groups=j.new_style_groups}this.contacts_only=false;if(j.contacts_only!=null){this.contacts_only=j.contacts_only}if(eD.get_url().indexOf("/referrals")!==-1){fm=bF("#retrieve-contacts-button")}else{fm=bF(this.element).closest("form").find(".tokenizer-submit-button")[0]}bF(fm).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bF(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!j.hide_import_contacts){this.import_links=bF(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(j){var i,T;i=j.findElement("li");this.index=i.autocompleteIndex;T=this.selectEntry();if(!T){return this.hide()}},onBlur:function($super,i){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(i)},onFocus:function(i){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(i){return this.tokenize_emails_input(true)},clearTokens:function(i){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var j,i;j=bF(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fm,T,fl;fl=[];for(fm=0,T=j.length;fm<T;fm++){i=j[fm];fl.push(bF(i).val())}return fl})()).join(", ")},check_populated:function(){var j,i;j=$(this.element.parentNode);i=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(j.hasClassName("populated")&&i){return j.removeClassName("populated")}else{if(!j.hasClassName("populated")&&!i){return j.addClassName("populated")}}},clean_email_addr:function(fn,fm){var T,fl,j;for(fl=0,j=fn.length;fl<j;fl++){T=fn[fl];fm=fm.sub(T,"")}return fm.strip()},get_regexp_from_delimiters:function(fn){var T,fm,fl,j;fm="";for(fl=0,j=fn.length;fl<j;fl++){T=fn[fl];fm+=T+"|"}return new RegExp("["+fm+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(fl,T,i){var fm,j;j=true;fm=T;if(i===W.FB){fm=fl}if(i===W.EMAIL&&!d6.validate_email(T)){j=false}else{if(cT.call(this.members,T)>=0){j=false;fm=eA("Already member")}else{if(cT.call(this.invitees,T)>=0){j=false;fm=eA("Already invited")}else{if(i===W.NEW_STYLE_GROUP){if(cT.call(this.new_style_groups,T)>=0){j=false;fm=eA("Already member group")}else{j=true;fm=eA("Group")}}}}}if(T===this.user.email||T===this.user.id){fm=eA("You");j=!this.contacts_only}if(!fl&&T){fl=T.toString()}return{display:fl,value:T,type:i,valid:j,bubble_title:fm}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(j){var i,T;i=j.match(this.COMPOUND_EMAIL_REGEX);if(i){T=this.createTokenInfo(i[0],i[2],W.EMAIL);return T}return null},tokenize_emails_input:function(fs,fl){var fy,fq,fm,fw,T,fA,fz,fx,fB,ft,fr,fD,fC,fp,fv,fu,fn,fE,fo;fq=this.options.tokens;fu=this.get_regexp_from_delimiters(fq);if(this.options.single_token){fw=[this.element.value]}else{fw=this.element.value.split(fu)}fE="";if(!fs){fE=fw[fw.length-1];fv=this.clean_email_addr(fq,fE);fw=fw.slice(0,fw.length-1);if((fp=fE[fE.length-1])===" "||fp===">"){if(fv.match(this.COMPOUND_EMAIL_REGEX)||d6.validate_email(fv)){fw.push(fv);fE=""}}}fy=false;fo=[];if(fw.length>0){for(fA=0,fB=fw.length;fA<fB;fA++){fm=fw[fA];fn=this.parse_compound_email(fm);if(fn!=null?fn.valid:void 0){fy=true;this.set_input_size(1);if(this.addContact(fn)){fD={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fn.value,contact_name:fn.display,did_select_suggestion:false};this.contact_search_logger.add_record(fD)}}else{fo.push(fm)}}}fw=fo;if(!this.options.single_token){fC=[];for(fz=0,ft=fw.length;fz<ft;fz++){fm=fw[fz];fC.push.apply(fC,fm.split(" "))}fw=fC}if(fw.length>0){for(fx=0,fr=fw.length;fx<fr;fx++){fm=fw[fx];fm=this.clean_email_addr(fq,fm);if(fm){fn=this.createTokenInfo(fm,fm,W.EMAIL);if(fn.valid){fy=true}else{if(fl){continue}}this.set_input_size(1);if(this.addContact(fn)){fD={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fm,did_select_suggestion:false};this.contact_search_logger.add_record(fD)}}}}if(this.element.value!==fE){this.element.value=fE}T=this.element.up("form");if(fy){bT.clear_errors(T)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var j,i;j=this.element;i=function(){return j.focus()};return i},set_input_size:function(i){if((i==null)||i<0){i=20}return this.element.setStyle({width:i+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fv,fC,fp,fm,fy,fw,fD,fA,fo,fq,fz,fB,fl,fu,ft,T,fr,fn,fs,fx;ft=$(this.element.parentNode.parentNode);fr=parseInt(ft.getStyle("width"),10)-15;T=parseInt(ft.getStyle("height"),10);if(T!==this.textbox_height){this.textbox_height=T;if(T>=this.max_textbox_height){ft.setStyle({"overflow-y":"auto"})}else{ft.setStyle({"overflow-y":"hidden"})}}fD=fr;fv=bF(".tokenizer-link",ft.parentNode);if(fv.length>0){fD-=fv.width()}fs=this.token_manager.tokens;fq=false;fx=0;for(fy=0,fA=fs.length;fy<fA;fy++){fn=fs[fy];fm=fn.element;fp=parseInt(fm.getStyle("width"),10)+parseInt(fm.getStyle("margin-right"),10);fB=fx+fp;if(fB>fr){fx=fp;fq=true}else{if(fp>fr){fx=0;fq=true}else{fx=fB}}}fz=fD-fx;fC=this.element.value.length*7;if(fC>fz){fz=fr}this.set_input_size(fz);if(this.import_links.length&&this.import_links_visible){if(fq||fr-fx-fC<1.25*this.import_links_width){this.import_links_visible=false;fl=this.import_links;fu=[];for(fw=0,fo=fl.length;fw<fo;fw++){fm=fl[fw];fu.push(bF(fm).fadeOut(100))}return fu}}},onKeyPress:function(T){var j,i;this.dynamically_resize_input();if(this.active){switch(T.keyCode){case 44:case 188:case 59:case 186:if(!T.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(T);return}this.selectEntry();this.hide();this.active=false;Event.stop(T);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(T);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(T);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(T);return}}else{this.tokenize_emails_input(false);if(T.keyCode===Event.KEY_TAB||T.keyCode===Event.KEY_RETURN){if(this.element.value&&T.preventDefault){T.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((j=T.keyCode)===Event.KEY_LEFT||j===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((i=T.keyCode)===Event.KEY_LEFT||i===Event.KEY_RIGHT||i===Event.KEY_UP||i===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var T,fm,fl,j,fn,fo;if(this.active){fo=this.element.value;fn=this.options.tokens;for(fl=0,j=fn.length;fl<j;fl++){T=fn[fl];fm=fo.indexOf(T);if(fm!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fo.substr(0,fm);this.selectEntry();this.hide();this.active=false;this.element.value=fo.substr(fm+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(i){if(i==null){i=this.getCurrentEntry()}return bF(i).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(j){var i;if(j==null){j=this.getCurrentEntry()}return j.value===0&&((i=j.id)!=null?i.length:void 0)!==0},selectEntry:function(){var T,fo,i,fm,fl,fn,fq,fp,j;fo=this.getCurrentEntry();if(this.has_selected_profile_services(fo)){ba.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(fo)){fn="suggestion";if(bF(this.get_entry_container()).hasClass("people-default-show-import-shmodal-experiment")){fn=fn+" people-default-show-import-shmodal-experiment";ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_CLICK,this.user.id,{provider:i})}i=fo.id.split("_")[0];cL((cT.call(c2.contact_services(),i)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fp=c2.to_name(i);if(this.profile_services.service_is_connected(i)){ah.success(eA("You're already connected to %(service_name)s").format({service_name:fp}));return}if(cT.call(c2.contact_services(),i)>=0){return this.link_handler.auth_service_with_user(i,this.user.id,((function(fr){return function(fs){return fr.link_callback(fs)}})(this)),fn)}else{return cL(false,"Should never get here. entry_value: "+i)}}else{T=this.options.array[fo.value];fm=T.type===W.FB?T.fb_id:T.type===W.NEW_STYLE_GROUP?T.group_id:T.email;this.set_input_size(1);fq=this.element.value;j=this.createTokenInfo(T.name.strip(),fm,T.type);if(this.addContact(j)){fl={sort_variant:b0.sort_variant,context:"legacy_tokenizer",search_expr:fq,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:T.type,contact_id:fm,contact_name:T.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(fl)}bT.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(fn){var ft,fp,fz,fC,fl,fx,fy,fA,fr,fo,fu,fq,fv,fB,fD,T,fm,fs,fw;fw=this.token_manager.tokens;for(fz=0,fA=fw.length;fz<fA;fz++){fq=fw[fz];if(fn.value===fq.info.value){return false}}this.element.value="";switch(fn.type){case W.FB:fx="fb_ids";fC=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case W.EMAIL:fx="emails";fC=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case W.NEW_STYLE_GROUP:fx="new_style_group_ids";fC=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case W.INVALID:fx="invalids";fC=new Element("span",{"class":"hidden"});break;default:cL(false,"should never get here due to type: "+fn.type)}fv=this.getTokenClass(fn);fs=bF("<span class='x'>").addClass(fv);fs.on("click",function(i){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(i);return false});fD=new Element("input",{type:"hidden",name:fx,value:fn.value.toString()});fq=new Element("a",{"class":"title_bubble token "+fv,href:"#",tabindex:"-1",title:fn.bubble_title});fl=new Element("span");if(this.options.wrap_name){T=new Element("div",{"class":"token-display-text"});T.__sert(fn.display);fB=T;ft=1}else{fB=fn.display;ft=0}fo=[fD,fC,fB];for(fy=0,fr=fo.length;fy<fr;fy++){fp=fo[fy];fl.__sert(fp)}bF(fl).append(fs);fq.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fl))));if((fu=$(fq).down(5).next(ft))!=null){fu.innerHTML="&nbsp;"}fm=new cO(fq,this.hidden_input,this.token_manager,fn);this.token_manager.add(fm);this.element.up().__sert({before:fq});return true},getTokenClass:function(i){if(!i.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,i,fl,fm,T,j){$super(i,fl,fm,T,j);this.warn_only=!j.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};this.suspended_contacts={};this.pending_contacts={};return this.reloadContacts(true)},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(i){this.warn_only=!i;return this.reloadContacts()},reloadContacts:function(i){if(i==null){i=false}return b0.load_contacts(i=i,(function(j){return function(T){return j.setContacts(T)}})(this))},setContacts:function($super,fn){var T,fl,j,fm;this.team_contacts={};this.team_contacts[cM.get_viewer().work_email]=1;if(!bF(this.element).hasClass("team-admin")){fn=fn.excludeSuspended()}fn=fn.sortByTeamFirst();fm=fn.contacts;for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}if(T.team&&T.join_state==="pending"){this.pending_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(fn))}else{return $super(fn)}},createTokenInfo:function(fn,fl,j){var fp,fo,fm,i,T;T=true;fo=false;fp=fl;i=false;if(j===W.FB){fp=fn}if(j===W.EMAIL&&!d6.validate_email(fl)){T=false}else{if(cT.call(this.members,fl)>=0){T=false;fp=eA("Already member")}else{if(cT.call(this.invitees,fl)>=0){T=false;fp=eA("Already invited")}else{if((this.options.exclude_emails!=null)&&cT.call(this.options.exclude_emails,fl)>=0){T=false;fp=eA("You cannot choose this member")}else{if(j===W.EMAIL&&!this.team_contacts[fl]&&!this.pending_contacts[fl]){T=this.warn_only;fo=true}else{if(j===W.FB){T=this.warn_only;fo=true}else{if(j===W.NEW_STYLE_GROUP){if(cT.call(this.new_style_groups,fl)>=0){T=false;fp=eA("Already member group")}else{T=true;fp=eA("Group")}}}}}}}}if(fl===this.user.email||fl===this.user.id){fp=eA("You");T=!this.contacts_only}if(this.suspended_contacts[fl]){fp=eA("Suspended user");i=true}if(!fn&&fl){fn=fl.toString()}return fm={display:fn,value:fl,type:j,valid:T,external:fo,bubble_title:fp,suspended:i}},getTokenClass:function(i){if(!i.valid){return"token-error"}if(i.suspended){return"token-warn token-suspended"}if(i.external){return"token-warn"}return"token-valid"},notifyExternal:function(j){var i,T,fl;fl=j.memo;if(fl.external){T=this.token_manager.tokens.filter(function(fm){return fm.info.external});i=T?T.length:0;return this.element.fire("sf:token:external",{count:i})}}});var h;h=E.TeamSharedFolderInviteController=(function(){function i(j){var T;this.element=$(j[0]);T=this.element.down(".new-collab-input");T.observe("sf:token:external",this.handle_external.bind(this))}i.prototype.handle_external=function(T){var j,fl;j=T.memo.count;fl=this.element.down(".external-invite-message");if(j>1){dv.fillVal(j,"external-invite-num");if(fl!=null){fl.removeClassName("single")}return fl!=null?fl.show():void 0}else{if(j===1){if(fl!=null){fl.addClassName("single")}return fl!=null?fl.show():void 0}else{return fl!=null?fl.hide():void 0}}};return i})();var am;am=INLINE_JS.SharingModel=E.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(j,i,T){this.filename=j;this.c2d_vars=i;this.c2d_url=T!=null?T:"/sm/c2d";this.init_logger();bF(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(fl){return function(){var fo,fn,fm;fn=$("login-create-an-account");if(fn){fn.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bF("#download_button_link[data-dl-link]").on("click",fl.download_zip);fl.set_viewport_size();fo=function(fq,fp){return fl.do_c2d(fp.id)};bF("#c2d-modal .login-form").on("db:login:success",fo);bF("#c2d-modal .register-form").on("db:register:success",fo);fm=G.parse(window.location.href);if(fm.getQuery()["force_dl"]){fm.updateQuery({force_dl:0,dl:1});return window.location=fm.toString()}}})(this))},init_folder:function(j,fl,T,i){this.is_folder=true;this.gallery_enabled=j;this.gallery_showing=fl;this.file_viewer_files=T;this.file_view_mode=i;return on_script_loaded((function(fm){return function(){fm.load_thumbs();bF("#gallery-toggle").click(function(){return fm.switch_mode("gallery")});bF("#list-toggle").click(function(){return fm.switch_mode("list")});bF(".file-link").click(function(fn){return fm.open_file_viewer(bF(fn.currentTarget).data("mediaIndex"))});return bF(document).on(aH.FILE_ACTIVITY_UPDATE,function(fo,fn,fp){return bF("[data-file-activity-key='"+fp.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fq;return(fq=this.reactComponent)!=null?fq.setProps({unresolvedCommentCount:fp.unresolvedCommentCount(),unseenCommentCount:fp.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(i){if(!bx.isNumber(i)||i<0){return}n.show(this.file_viewer_files[i],cM.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});n.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(i){return function(){return bF("#add_to_my_dropbox_link").on("click",function(){return i.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(j){var T,i;i=j.icon.split("_");i.pop();T=i.join("_");return"/static/images/icons128/"+T+".png"},init_logger:function(){on_script_loaded((function(i){return function(){var j;j=$("login-hover-link");if(j){j.observe("click",function(){return aQ.log(aQ.CLICK_SIGN_IN)});j.observe("click",function(){return dK.log("click_sign_in")})}if($("download_button_link")){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,$("download_button_link"))}j=$("add_to_my_dropbox_link");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j);dK.attachLogListener("click_add_to_my_dropbox",j)}if($$(".remove-link").length){aQ.attachLogListener(aQ.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aQ.attachLogListener(aQ.CLICK_FILENAME,$$(".shmodel-filename")[0])}j=$("default_content_download_button");if(j){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,j)}j=$("default_content_a2md");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j)}j=bF("#login-create-an-account")[0];aQ.attachLogListener(aQ.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,j);j=bF("#login-hover-cont .login-form")[0];aQ.attachLogListener(aQ.LOGIN_THRU_DEFAULT_DROPDOWN,j);return bF("#share-button").click(function(T){return aQ.log(aQ.CLICK_SHARE)})}})(this));return document.observe(aM.ACTIONS_ADDED,(function(i){return function(){var fm,fl,j,T;T=$("view_original");if(T){aQ.attachLogListener("shmodel_lightbox_click_vieworiginal",T)}fl=$("lightbox_share_link");if(fl){aQ.attachLogListener("shmodel_lightbox_click_getlink",fl)}j=bF("lightbox-share-link");if(j[0]){aQ.attachLogListener("shmodel_lightbox_click_getlink",j[0])}fm=$("lightbox_download_link");if(fm){return aQ.attachLogListener("shmodel_lightbox_click_download",fm)}}})(this))},set_team_only_shmodel:function(j,i){this.team_only_shmodel=j;return this.owner_name=i},_resize_album_view:function(){var i;i=Math.floor((C.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:i+"px"})},load_thumbs:function(){var j,i;i=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");j=function(T){if(!T.src.endsWith(cx.SPACER)){return T.addClassName("thumbnail")}};return bs.batch_load_thumbs(i,this.THUMBS_BATCH_SIZE,j)},switch_mode:function(fp){var fm,fq,fl,T,fo,j,fn;fn=$A(["gallery","list"]);for(fl=0,T=fn.length;fl<T;fl++){j=fn[fl];fq=$(j+"-view-container");fm=$(j+"-toggle");if(fp===j){fq.show();fm.addClassName("selected")}else{fq.hide();fm.removeClassName("selected")}}if(history.replaceState){fo=window.location.pathname;if(fp==="list"){fo+="?lst"}history.replaceState({},"",fo)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var i;if($(document.body).hasClassName("mobile")){i=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(i)}},toggle_dropdown:function(fl,fm,T){var i,j;if(fl){Event.extend(fl).preventDefault()}if(!fm.visible()){if(this.is_album){return eT.show(fm,T,null,true)}else{j=$$(".nav-header").first().getHeight();i=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(i<0&&d6.ie8){i=4}return eT.show(fm,T,j-i,true)}}},prepare_confirm_remove_modal:function(j,fl,i,fn,fs,fo,fr,fp){var T,fm,fq;if(i){fq=fn?eA("Unshare?"):eA("Unshare album?");T=bF("#album-disable-token-modal")[0];dv.fillVal(j.escapeHTML(),"album_unshare_name")}else{if(fo){fq=eA("Remove link created by %(name)s").format({name:fr});if(fl){fm=eA('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fm=eA('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fm=fm.format({fname:bU.em_snippet(j,17),owner:fr,owner_email:fp})}else{fq=eA("Remove link to '%(name)s'").format({name:bU.em_snippet(j,17)});if(fl){fm=eA("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fm=eA("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}T=bF("#disable-token-modal")[0];dv.fillVal(fm,"disable-token-desc")}return{title:fq,contents:T}},confirm_remove:function(j,fn,T,i,fl,fr,fo,fq,fp){var fm;if(T==null){T=false}if(i==null){i=false}if(fl==null){fl=false}if(fr==null){fr=null}if(fo==null){fo=false}if(fq==null){fq=null}if(fp==null){fp=null}cL(fn,"confirm_remove missing tkey");cL(j,"confirm_remove missing name");cL(fr,"confirm_remove missing user_id");cL(!fo||!i,"admin removal of collections not supported");cL(!fo||fq,"missing link owner name for admin removal");cL(!fo||fp,"missing link owner email for admin removal");if(!cM.get_viewer().is_uid_signed_in(fr)){bO.show_modal({user_id:fr,on_success:(function(fs){return function(){return fs.confirm_remove(j,fn,T,i,fl,fr,fo,fq,fp)}})(this)});return}fm=am.prepare_confirm_remove_modal(j,T,i,fl,fr,fo,fq,fp);return fb.show(fm.title,fm.contents,{token:fn,name:j,is_album:i,user_id:fr})},confirm_remove_from_event_gid:function(i,fq,T,fp,fm,fo,fn,j){var fl;if(fm==null){fm=false}if(fo==null){fo=null}if(fn==null){fn=null}if(j==null){j=null}cL(fq,"confirm_remove missing event gid");cL(i,"confirm_remove missing name");cL(fp,"confirm_remove missing user_id");cL(cM.get_viewer().is_uid_signed_in(fp),"user not logged in");cL(!fm||fo,"missing link owner name for admin removal");cL(!fm||fn,"missing link owner email for admin removal");fl=am.prepare_confirm_remove_modal(i,T,false,false,fp,fm,fo,fn);return fb.show(fl.title,fl.contents,{name:i,user_id:fp,activity_log_event_gid_dbase64:fq,redirect_to_member_id:j})},do_remove:function(fl){var i,T,j;cL(fl.token||fl.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");i=bF("#modal-content input").first();i.attr("disabled",true);bF("#modal-content").addClass("ajax-loading");j=window.location.pathname;if((j==="/links"||j==="/links/your_links"||j==="/recents")||j.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+fl.token,{subject_user:fl.user_id,onSuccess:(function(fm){return function(){var fn;fb.hide();if(fl.is_album){fn=eA("Unshared '%(name)s'")}else{fn=eA("Removed link for '%(name)s'")}fn=fn.format({name:fl.name});ah.success(fn);return document.fire(aH.LINKS_REMOVE,{token:fl.token})}})(this),onComplete:(function(fm){return function(){i.attr("disabled",false);return bF("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(fl.token){T=G({path:"/sm/disable/"+fl.token})}else{T=G({path:"/sm/disable_by_event_gid/"+fl.activity_log_event_gid_dbase64});T.updateQuery("redirect_to_member_id",fl.redirect_to_member_id).toString()}return bT.postRequest(T.updateQuery(a9.UID_PARAM_NAME,fl.user_id).toString())}},show_shmodal_onload:function(T,fl,j,i){if(i==null){i=null}return bF((function(fm){return function(){eD.remove_query_param("m");if(!cM.get_viewer().is_uid_signed_in(i)){bO.show_modal({user_id:i,on_success:function(){return fm.show_shmodal_onload(T,fl,j,i)}});return}if((i!=null)&&d4.get_for_user(cM.get_viewer().get_user_by_id(i)).verified_or_show()){return fm.show_shmodal(T,fl,j,i)}else{if(i==null){cL(cM.get_viewer().is_paired,"Expected viewer to be paired.");return fm.show_share_shmodel_role_chooser(T,fl,j)}}}})(this))},show_shmodal:function(fq,fw,j,fv){var fu,fs,ft,fr,fn,fm,fp,fo,T,fl;this.url=fq;this.short_url=fw;if(!cM.get_viewer().is_uid_signed_in(fv)){bO.show_modal({user_id:fv,on_success:(function(i){return function(){return i.show_shmodal(i.url,i.short_url,j,fv)}})(this)});return}fl=cM.get_viewer().get_user_by_id(fv);if(d4.get_for_user(fl).verified_or_show()){fo="shmodal-user-"+fv;fb.show(this._get_shmodal_title(fl.is_team),dv.fromElm($(fo)));fn={};fn[a9.UID_PARAM_NAME]=fv;bT.add_vars("shmodal-send-form",fn);if(this._get_thumbnail_type()){T=$$(".shmodal-image");for(fm=0,fp=T.length;fm<fp;fm++){fr=T[fm];fr.addClassName("thumbnail")}}if(j==="contacts"){ft=Autocompleter.ContactsTokenizer}else{ft=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new ft(fl,fo+"-new-collab-input",fo+"-new-whobulk",fo+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:j==="team_only",user_id:fv});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fu=t.clipboard_overlay(this.url,bF("#"+fo+"-copy-link"),am.copied_to_clipboard);fu.css({position:"fixed",zIndex:1001});fu.children().height(fu.height());clearInterval(this.follow_freshbutton);fs=(function(i){return function(){return fu.clonePosition(bF("#"+fo+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(fs,500)}else{$(fo+"-copy-link").hide()}}cj._create($("modal").down(".custom-message-container"));cj._create($("modal").down(".fb-post-sickinput"));cj._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(this.short_url,fv);$(fo+"-new-collab-input").focus();return aQ.log("shmodal_show")}},configure_dropdown:function(){var fn,fl,j,fm,T;fm=$$(".dropdown-menu-container");for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];T=fn.down(".dropdown-menu-trigger");if(T!=null){T.observe("click",(function(i){return function(fp){var fo;fo=fp.target.up(".dropdown-menu-container");return fo.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(i){return function(ft){var fs,fq,fp,fo,fr;if(ft.target.hasClassName("dropdown-menu-trigger")||ft.target.up(".dropdown-menu-trigger")){return}fo=$$(".dropdown-shown");fr=[];for(fq=0,fp=fo.length;fq<fp;fq++){fs=fo[fq];fr.push(fs.removeClassName("dropdown-shown"))}return fr}})(this))},copied_to_clipboard:function(){ah.success(eA("Link copied to clipboard"));fb.hide();aQ.log("shmodal_copy_link");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(fl){var fm,fv,ft,fr,fw,fx,fq,fs,fp,fo,fu,T,fn;cL(fl,"Must pass the shmodal send form into get_shmodel_send_recipients");fm=fl.select('input[name="emails"]');fv=fl.select('input[name="fb_ids"]');ft=fl.select('input[name="group_ids"]');fo=fl.select('input[name="new_style_group_ids"]');T=[];fn=[fm,fv,ft,fo];for(fr=0,fs=fn.length;fr<fs;fr++){fx=fn[fr];for(fq=0,fp=fx.length;fq<fp;fq++){fw=fx[fq];fu=fw.up().innerHTML.stripTags().escapeHTML();T.push(fu.substring(0,fu.indexOf("&")))}}return T},close_embedded_fileviewer:function(j){var i;j.preventDefault();i=new et();i.configureParentMessaging(function(){},["parent-ready"]);i.startListening();return i.postMessageToParent("close-fileviewer")},send_shmodel_link:function(fl){var T,j,fm,i;T=$("shmodal-send-form");cL(T,"Couldn't find the shmodal send form.");i=this.get_shmodel_send_recipients(T);fm=(function(fn){return function(fo){var fp;fp=aZ.success_string_for_recipients(i);ah.success(fp);fb.hide();return aQ.log("shmodal_send")}})(this);j=(function(fn){return function(fo){return bT.remove_loading()}})(this);return bT.ajax_submit(T,"/sm/share",fm,j,T.down(".tokenizer-submit-button"))},show_content:function(T){var fl,j,fm,fn;$("shmodal-title-text").__date(dr.to_title_str(T));fm=dr.list;for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];if(fn!==T){$(dr.to_toggle_str(fn)).removeClassName("toggled");$(dr.to_content_str(fn)).hide()}}$(dr.to_content_str(T)).show();$(dr.to_toggle_str(T)).addClassName("toggled");return bF("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(dr.SEND)},show_fb_content:function(){return this.show_content(dr.FB)},show_twitter_content:function(){return this.show_content(dr.TWITTER)},start_fb_post:function(fm,j){var fn,T,i,fl;T=(function(fo){return function(){return eq.do_auth(fo.do_fb_post.curry(fm,j),j)}})(this);fn=bF("#modal:visible, #modal-overlay:visible");i=function(){return fn.show()};if(eq.authed_user_id===j){return this.do_fb_post(fm,j)}else{if(cM.get_viewer().is_uid_associated(eq.authed_user_id)){fn.hide();fl=new ed(cM.get_viewer().get_user_by_id(j),i,T.bind(this));return fl.show()}else{return T()}}},start_twitter_post:function(i){if(cG.is_authed(i)){return this.do_twitter_post(i)}else{return cG.do_auth(this.do_twitter_post,i)}},do_fb_post:function(j,i){eq.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};eq.custom_show_complete=function(){fb.hide();ah.success(eA("Successfully posted to Facebook"));aQ.log("shmodal_fb_post");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})};return eq.post($F("shmodal-fb-post-input"),j,null,null,null,function(){return fb.hide()},i)},do_twitter_post:function(i){var j;j=$F("shmodal-twitter-post-input");if(!j){ah.error(eA("Please enter a Twitter post"));return}else{if(j.length>140){ah.error(eA("Your post must be 140 characters or less"));return}}cG.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};return cG.custom_post(j,(function(T){return function(){fb.hide();ah.success(eA("Successfully posted to Twitter"));aQ.log("shmodal_tweet");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})}})(this),i)},_get_shmodal_title:function(i){if(i==null){i=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(j){return function(){return j.show_send_content()}})(this)),((function(j){return function(){return j.show_fb_content()}})(this)),((function(j){return function(){return j.show_twitter_content()}})(this)),i)},generate_title_content:function(j,fq,fn,fs,fl){var fm,fo,i,fr,T,fp;if(fl==null){fl=false}fr=bF("<div/>",{id:"shmodal-title"});T=bF("<div/>",{id:"shmodal-title-text",text:j});fr.append(T);if(!fl){i=bF("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});i.html(cx.make("web","email_20"));i.on("click",fq);fo=bF("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fo.html(cx.make("web","fb_20"));fo.on("click",fn);fp=bF("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fp.html(cx.make("web","twitter_20"));fp.on("click",fs);fr.append([i,fo,fp])}fm=bF("<div/>",{"class":"clear"});fr.append(fm);return fr[0]},_get_shmodal_title_text:function(){var j,i;if(this.is_folder){j=eA("Share link to \u2018%(folder_name)s\u2019");return j=j.format({folder_name:bU.em_snippet(this.filename,15)})}else{i=this._get_thumbnail_type();if(i===cS.CATEGORY_TO_TRANSLATION.IMAGE){return eA("Share this image")}else{if(i===cS.CATEGORY_TO_TRANSLATION.VIDEO){return eA("Share this video")}else{return eA("Share '%(filename)s'").format({filename:bU.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var j,i;if(this.filename.indexOf(".")===-1){return false}i=aA.file_extension(this.filename).toLowerCase();j=cS.EXTENSION_TO_CATEGORY[i];if(j&&(j==="IMAGE"||j==="VIDEO")){return cS.CATEGORY_TO_TRANSLATION[j]}return false},_populate_twitter_info:function(T,i){var fl,j;fl=this.is_folder?eA("Just shared some files using @Dropbox"):(j=this._get_thumbnail_type(),j&&j===cS.CATEGORY_TO_TRANSLATION.IMAGE?eA("Just shared an image using @Dropbox"):eA("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(fl+" "+T);d6._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cG.is_authed(i)){return cG.get_user_info(function(fm){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fm.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fm.name);$("shmodal-twitter-profile").down(".username").__date("@"+fm.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},i)}},download_zip:function(fl){var j,T,fm,i,fn;j=bF("#download_button_link").attr("data-dl-link");fn=bF("#download_button_link").attr("data-test-link");i=bF("#download_button_link").attr("data-owner")==="true";fm=(function(fo){return function(fp){var fq;if(fp==="OK"){window.location=j}else{if(fp.indexOf("err:")===0){if(i){fq=eA("The zip file is too large.")}else{fq=eA("The zip file is too large. Please add it to your Dropbox.")}ah.error(fq)}else{ah.error(eA("Failed to download zip file."))}}return false}})(this);T=(function(fo){return function(fp){ah.error(eA("Failed to download zip file."));return false}})(this);if(fn&&bF.support.cors===true){bF.ajax({url:fn,type:"POST",success:fm,error:T})}else{window.location=j}return false},show_share_shmodel_role_chooser:function(j,T,i){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dz({element_id:"share-shmodel-select-role-modal",link_url:j,short_url:T,tokenizer_type:i})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(j,T,i,fm){var fl;fl=(function(fn){return function(){var fo;fb.hide();bF("#role-selector option").removeClass("disabled");fo=cM.get_viewer().get_uid_by_role(fm);cM.get_viewer().sign_in_user_by_id(fo);ba.ShmodelUILogger.log("via-shmodel-viewer");return am.show_shmodal(j,T,i,fo)}})(this);if(!cM.get_viewer().is_role_signed_in(fm)){return bO.show_modal({role:fm,on_success:fl})}else{return fl()}},show_c2d_modal:function(fo,j){var fn,i,fm,T,fl;if(fo==null){fo=""}if(j==null){j=false}if(fo){if(fo===Constants.ROLE_PERSONAL){cL(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cM.get_viewer().is_role_signed_in(fo)){bO.show_modal({role:fo,on_success:(function(fp){return function(){return fp.show_c2d_modal(fo)}})(this)});return}}else{if(cM.get_viewer().is_paired){new aT({element_id:"select-role-modal"}).show();return}}ba.WebMiscActivityLogger.log("show-c2d-modal",{filename:this.filename,auth_google:bF.find(".auth-google")!=null});if(fo){T="#c2d-modal-"+fo}else{T="#c2d-modal"}fl=this._c2d_modal_msg(fo,cM.get_viewer().team_name);fn=this._c2d_modal_button_msg(fo,cM.get_viewer().team_name);i=this._c2d_modal_desc(fo,cM.get_viewer().team_name);if(j){i=this._c2d_modal_team_only_desc(cM.get_viewer().team_name)+"<br/><br/>"+i}fm=this._c2d_modal_login_desc(fo,cM.get_viewer().team_name);dv.fillVal(i,"c2d-desc");dv.fillVal(fm,"c2d-login-desc");bF(".c2d-submit-button").val(fn);bF(".c2d-login-register-desc").hide();if(this.is_album){bF(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bF(".c2d-login-register-folder-desc").show()}else{bF(".c2d-login-register-file-desc").show()}}return fb.show(fl,bF(T)[0],false,false,false,false)},_c2d_modal_msg:function(fl,j){var i,T;if(fl==null){fl=""}if(j==null){j=""}if(this.c2d_vars.title){return T=this.c2d_vars.title}else{if(fl===Constants.ROLE_PERSONAL){T=eA("Save '%(filename)s' to my personal Dropbox");return T.format({filename:bU.em_snippet(this.filename,10)})}else{if(fl===Constants.ROLE_WORK){T=eA("Save '%(filename)s' to my %(team_name)s Dropbox");i=Math.max(10,15-new bU(j).length);return T.format({filename:bU.em_snippet(this.filename,i),team_name:j})}else{T=eA("Save '%(filename)s' to my Dropbox");return T.format({filename:bU.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){return j=eA("Save to my personal Dropbox")}else{if(T===Constants.ROLE_WORK){j=eA("Save to my %(team_name)s Dropbox");return j.format({team_name:i})}else{return eA("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(i){var j;if(this.is_album){j=eA("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){j=eA("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{j=eA("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return j.format({owner_name:this.owner_name,team_name:i})},_c2d_modal_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){j=eA("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eA("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){j=eA("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eA("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){j=eA("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eA("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eA("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eA("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eA("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}else{if(this.is_album){return eA("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return eA("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return eA("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){return j=eA("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return j=eA("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return j=eA("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eA("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eA("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eA("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}}},do_c2d:function(i){var j;cL(i,"Must specify a user_id for saving to Dropbox.");j=eA("Saving to your Dropbox...");if(cM.get_viewer().is_paired){if(cM.get_viewer().get_user_by_id(i).is_team){j=eA("Saving to your %(team_name)s Dropbox...");j=j.format({team_name:cM.get_viewer().team_name})}else{j=eA("Saving to your personal Dropbox...")}}ah.success(j);fb.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:j,subject_user:i,onSuccess:(function(T){return function(fl){if(fl.responseText){return b1.redirect(fl.responseText)}}})(this)})},c2d_show_twofactor_error:function(j){var i;i=$("c2d-twofactor-error");i.__date(j);return i.show()},c2d_hide_twofactor_error:function(i){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(eA("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(eA("Unfortunately, your carrier isn\u2019t supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(eA("That isn\u2019t a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(eA("That phone number doesn\u2019t appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(eA("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(eA("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var dr;dr=E.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",eA("Share on Facebook"),eA("Share on Twitter")],to_content_str:function(i){return this._content_str[i]},to_toggle_str:function(i){return this._toggle_str[i]},to_title_str:function(i){if(i===0){return am._get_shmodal_title_text()}return this._title_str[i]},to_focus_str:function(i){return this._focus_str[i]}};var Z,dh,bL,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;dh=INLINE_JS.ShareLinkModal=E.ShareLinkModal=(function(i){fc(j,i);function j(T,fn,fl,fp,fo){var fm,fq;this.user_id=T;if(fp==null){fp=false}if(fo==null){fo=void 0}this.before_show=b3(this.before_show,this);this.show=b3(this.show,this);this.prompt_login_then_show=b3(this.prompt_login_then_show,this);fq={origin:fl};fq[a9.UID_PARAM_NAME]=this.user_id;if(fo){fm=G({path:"/sm/get_link_modal_content/"+fo}).toString()}else{fm=G({path:"/sm/share_link"+fn}).toString()}j.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fm,parameters:fq})}j.prototype.prompt_login_then_show=function(){var T;T=(function(fl){return function(){fb.hide();bF("#role-selector option").removeClass("disabled");cM.get_viewer().sign_in_user_by_id(fl.user_id);ba.ShmodelUILogger.log("via-shmodel-viewer");return fl.show()}})(this);if(!cM.get_viewer().is_uid_signed_in(this.user_id)){return bO.show_modal({user_id:this.user_id,on_success:T})}else{return T()}};j.prototype.show=function(){var T;T=cM.get_viewer().get_user_by_id(this.user_id);if(d4.get_for_user(T).verified_or_show(er.SHMODAL)){return j.__super__.show.call(this)}};j.prototype.before_show=function(){var fn,fm,T,fl;fl=this.$modal_window.find(".share-link-modal-content").length;if(fl){fn={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};T=bF("<img />",fn);fm=bF("<div />",{"class":"loading-spinner"}).append(T);return this.$modal_window.find(".dynamic-content").html(fm)}};return j})(cD);bL=E.ShareLinkModalContent=(function(){function i(fn,fp,fu,fq,j,T,ft,fm,fr){var fl,fo,fs,fv;this.owner_id=fn;this.tkey=fp;this.fq_path=fu;this.link=fq;this.filename=j;this.tokenizer_type=T;this.tokenizer_ctx_str=ft;this.fq_path_of_restricting_sf=fr;this._send_link=b3(this._send_link,this);this._show_shared_link_settings_modal=b3(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=b3(this._show_shared_folder_settings_modal,this);this._select_all_text=b3(this._select_all_text,this);this._toggle_send_link_button=b3(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=b3(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=b3(this._toggle_close_button_text,this);this._toggle_comment_option=b3(this._toggle_comment_option,this);this._listen=b3(this._listen,this);this._init_autocompleter=b3(this._init_autocompleter,this);this.$content=bF(".share-link-modal-content");this.modal=d7.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=o.create_contacts_list(fm)}fs={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aH.LINKS_ADD,fs);this.modal.set_title(eA("Share link to \u2018%(filename)s\u2019").format({filename:bU.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this.$custom_message_textarea=this.$content.find("#share-link-modal-custom-message");this.$comment_option_container=this.$content.find(".add-message-as-comment-container");this._init_autocompleter();this._listen();if((fl=this.$share_link_url_input[0])!=null){fl.select()}if(((fo=az.getGandalfRule("people-link-profile-on-share-experiment"))===null||fo==="CONTROL")&&az.isGandalfInVariant("people-default-show-import-shmodal-experiment","EXPERIMENT")&&this.tokenizer_type!=="shared_folder"){fv=(function(fw){return function(fx){var fy;fy=bF(fw.autocompleter.element).closest(".tokenized_autocompleter_container").attr("data-provider");fw.autocompleter.activate();bF(fw.autocompleter.get_entry_container()).addClass("people-default-show-import-shmodal-experiment");if(container.find("#autocompleter_item_tmpl")!=null){return ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_SHOW,fw.owner_id,{provider:fy})}}})(this);bk.get_linked_profile_services_for_user(this.owner_id,fv)}}i.prototype._init_autocompleter=function(){var j,T;j={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}}T=(function(fl){return function(fm){return function(){return fl.autocompleter.contact_search_logger.log_records(fl.owner_id,fm)}}})(this);this.modal.logger_keydown_close_handler=T(true);this.modal.$overlay.on("click",T(true));this.modal.$db_modal_x.on("click",T(true));this.$send_link_button.on("click",T(false));this.$cancel_button.on("click",T(true));cj.init();return this.$collab_input.focus()};i.prototype._listen=function(){var fm,fl,T,j,fo,fn;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fp){return function(fq){return d1.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if(this.$comment_option_container.length>0){this.$custom_message_textarea.on("input",this._toggle_comment_option)}if((fm=this.$collab_input)!=null){fm.keyup(this._toggle_send_link_button)}if((fl=this.$collab_input)!=null){fl.on("input",this._toggle_send_link_button)}if((T=this.$collab_input[0])!=null){T.observe("token:remove",this._toggle_send_link_button)}if((j=this.$collab_input[0])!=null){j.observe("token:add",this._toggle_close_button_text)}if((fo=this.$collab_input[0])!=null){fo.observe("token:remove",this._toggle_close_button_text)}return(fn=this.$collab_input[0])!=null?fn.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};i.prototype._toggle_comment_option=function(T){var j;j=this.$custom_message_textarea.val().length;if(j>0){return this.$comment_option_container.css("visibility","visible")}else{return this.$comment_option_container.css("visibility","hidden")}};i.prototype._toggle_close_button_text=function(fl){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;if(j){return this.$cancel_button.text(eA("Close"))}else{return this.$cancel_button.text(eA("Cancel"))}};i.prototype._toggle_recipients_outside_team_warning=function(fl){var j,T;j=bF(".external-recipient-warning-message");if(j.length){T=fl.memo.count;if(fl.memo.shared_folder_warning){if(T>0){return j.show()}else{return j.hide()}}else{if(T>1){j.find(".external-recpient-num").text(T);return j.removeClass("single").show()}else{if(T===1){return j.addClass("single").show()}else{return j.hide()}}}}};i.prototype._toggle_send_link_button=function(fl){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;j=j&&bF.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",j)};i.prototype._select_all_text=function(j){return bF(j.currentTarget)[0].select()};i.prototype._show_shared_folder_settings_modal=function(T){var j;T.preventDefault();j=cM.get_viewer().get_user_by_id(this.owner_id);return s.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,j)};i.prototype._show_shared_link_settings_modal=function(T){var j;T.preventDefault();j=new dX(this.owner_id,this.tkey);return d1.push(j)};i.prototype._send_link=function(fn){var fl,T,fm,j,fo;fm=this.$content.find(".share-link-modal-send-form")[0];j=this.get_shmodel_send_recipients(fm);fo=(function(fp){return function(fq){var fr;fr=aZ.success_string_for_recipients(j);ah.success(fr);d1.pop();return aQ.log("shmodal_send")}})(this);T=(function(fp){return function(fq){return bT.remove_loading()}})(this);fl=this.$content.find(".tokenizer-submit-button")[0];return bT.ajax_submit(fm,"/sm/share",fo,T,fl)};i.prototype.get_shmodel_send_recipients=function(fl){var fm,fv,ft,fr,fw,fx,fq,fs,fp,fo,fu,T,fn;cL(fl,"Must pass the shmodal send form into get_shmodel_send_recipients");fm=fl.select('input[name="emails"]');fv=fl.select('input[name="fb_ids"]');ft=fl.select('input[name="group_ids"]');fo=fl.select('input[name="new_style_group_ids"]');T=[];fn=[fm,fv,ft,fo];for(fr=0,fs=fn.length;fr<fs;fr++){fx=fn[fr];for(fq=0,fp=fx.length;fq<fp;fq++){fw=fx[fq];fu=fw.up().innerHTML.stripTags().escapeHTML();T.push(fu.substring(0,fu.indexOf("&")))}}return T};return i})();Z=INLINE_JS.QuickSend=E.QuickSend={_files:{},_uploading_fileids:{},init:function(i,T,fl){var j;this.owner_id=i;this.tokenizer_ctx_str=T;this.keep_visible=fl;this.$content=bF("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((j=this.$collab_input)!=null){j.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bF("#browse-files").addClass("quicksend-collapsed");Z._update_location();this.has_autocompleter_inited=false;ba.SharedFolderActivityLogger.log("web","quick_send_displayed",ct.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fm;return(fm=Z.$import_services)!=null?fm.hide():void 0},100)});bF("#quick-send-top-choose-button-send").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-choose-button").click(function(){return bF("#quick-send-file-box").click()});bF(".quick-send-choose-file-link").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-file-box").on("change",function(){var fn,fm;fm=bF("#quick-send-file-box")[0].files;fn=function(){if(!ct.active_user){ct.active_user=cM.get_viewer().get_user_by_id(Z.owner_id)}return bp.upload(Z.DEST_FOLDER+"/",fm)};return Z.get_folder_name(fn)});document.on(cC.COMPLETE_EVT,Z._file_upload_completed);document.on(cC.ERROR_EVT,Z._file_upload_errored);return document.on(dN.UPDATE,Z._update_location)},_cancel_button_clicked:function(i){ba.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",ct.active_user,{});return Z._reset()},_init_autocompleter:function(){var i;if(Z.has_autocompleter_inited){return}Z.has_autocompleter_inited=true;i={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:Z.owner_id,max_textbox_height:30,viewer:cM.get_viewer(),include_from_linked_accounts:true};return Z.autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_id(Z.owner_id),Z.collab_input_id,Z.tokenizer_ctx_str+"-new-whobulk",Z.tokenizer_ctx_str+"-hidden-input",i)},_send_link:function(fp){var fm,fl,fn,T,j,fq,fr,i,fo;ba.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",ct.active_user,{});Z.autocompleter.tokenize_emails_input(true);i=Z.autocompleter.getTokenCount();T=bF(".quick-send-left-form")[0];j=[];fr=0;for(fn in Z._files){fr+=1;fl=Z._files[fn];j.push(fl.fq_path)}fq={num_recipients:i,num_files:fr};ba.SharedFolderActivityLogger.log("web","quick_send_send_attempted",ct.active_user,fq);fo=(function(fs){return function(ft){Z._reset();Z._toggle_top_area_view();return ba.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",ct.active_user,{})}})(this);fm=(function(fs){return function(ft){return ba.SharedFolderActivityLogger.log("web","quick_send_send_failed",ct.active_user,{})}})(this);return bT.ajax_submit(T,"/sm/quick_send",fo,fm,null,{fq_paths:j.join(",")})},_update_file_area_view:function(){if(Object.keys(Z._files).length){bF("#quick-send-drop-area").hide();bF("#quick-send-files-area").show()}else{bF("#quick-send-drop-area").show();bF("#quick-send-files-area").hide()}return Z._toggle_send_button_state()},_toggle_top_area_view:function(){bF("#quick-send-top-part-send").hide();bF("#quick-send-top-part-confirm").show();return setTimeout(function(){bF("#quick-send-top-part-send").show();return bF("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var i;i=Z.keep_visible||!!ct.inside_root_folder;return Z._toggle_quick_send_module(i)},_toggle_quick_send_module:function(T){var i,j;if(Z._visible===T){return}j=Z.$content;if(T){Z._visible=true;j.show();return Z._update_collapsed_state()}else{Z._visible=false;j.hide();j.removeClass("collapsed expanded");i=bF("#browse-files");return i.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fm){var j,fl,i,T;fl=Z.$content;T=fm?"collapsed":"expanded";if(fl.hasClass(T)){return}i=fm?"expanded":"collapsed";fl.removeClass(i);fl.addClass(T);j=bF("#browse-files");T=fm?"quicksend-collapsed":"quicksend-expanded";i=fm?"quicksend-expanded":"quicksend-collpased";j.removeClass(i);j.addClass(T);if(!fm){return Z._init_autocompleter()}},_update_collapsed_state:function(){var i;i=Object.keys(Z._files).length;return Z._update_collapsed_view(i===0)},_remove_file:function(j,i){var T;T=false;if(j in Z._uploading_fileids){T=true;document.fire(cC.CANCEL_EVT,{file:i});bF(document).trigger(cC.CANCEL_EVT,{file:i});delete Z._uploading_fileids[j]}if(j in Z._files){$(j).remove();delete Z._files[j];Z._update_upload_list_scroll();Z._update_file_area_view();return Z._update_collapsed_state()}},_reset:function(){var j,fl,T,i;Z.autocompleter.clearTokens();T=bF(".quick-send-left-form")[0];T.reset();i=[];for(fl in Z._files){j=Z._files[fl];i.push(Z._remove_file(fl,j.file_obj))}return i},_has_added_fq_path:function(T){var i,j;for(j in Z._files){i=Z._files[j];if(i.fq_path===T){return true}}return false},_update_upload_list_scroll:function(){var j,i;j=Object.keys(Z._files).length;i=bF("#quick-send-upload-files-list");if(j<3){return i.removeClass("scroll")}else{i.addClass("scroll");return i.scrollTop=i.scrollHeight}},_add_file:function(fm,i){var fn,fs,fl,fr,fp,fq,T,j,ft,fo;fq={size:fm.bytes,source:i};ba.SharedFolderActivityLogger.log("web","quick_send_file_added",ct.active_user,fq);fs=fm.dest||Z.DEST_FOLDER;ft=aF.format_bytes(fm.bytes||0);fn=fg.tmpl("upload_list_item_tmpl");fl=fn({file:fm,icon:aA.file_icon(fm.name),filename_snippet:bU.em_snippet(fm.name,d3.FILENAME_SNIPPET_LENGTH),size:ft,dest:fs,dest_snippet:bU.em_snippet(eA("Dropbox")+fs,d3.DEST_SNIPPET_LENGTH,0),Sprite:cx});j=c0.sanitize(fl.toHTML());bF("#quick-send-upload-files-list").append(j);fr=bF("#"+fm.id);Z._update_upload_list_scroll();fr.find(".dest-col").hide();fr.find(".time-col").hide();fo=fr.find(".status-col").find("a.small-x-button");fp=fm.id;fo.on("click",function(fu){return Z._remove_file(fp,fm)});T=fr.find(".remove-link");T.on("click",function(fu){return Z._remove_file(fp,fm)});fr.on("mouseenter",(function(fu){return function(fv){fr.find(".status-col").hide();return T.show()}})(this));fr.on("mouseleave",(function(fu){return function(fv){fr.find(".status-col").show();return T.hide()}})(this));Z._files[fm.id]={file_div:fl,fq_path:fm.fq_path,bytes:fm.size,file_obj:fm};Z._update_file_area_view();return Z._update_collapsed_state()},_toggle_send_button_state:function(){var j,T,i;i=((j=Z.autocompleter)!=null?j.token_manager.tokens.length:void 0)===0;i=i&&Z.$collab_input.val()==="";T=Object.keys(Z._files).length===0||Object.keys(Z._uploading_fileids).length>0;return Z.$send_button.prop("disabled",i||T)},_file_upload_errored:function(T){var j,i;j=T.memo.file;if(j.id in Z._uploading_fileids){i={message:T.memo.message};ba.SharedFolderActivityLogger.log("web","quick_send_file_errored",ct.active_user,i);return delete Z._uploading_fileids[j.id]}},_file_upload_completed:function(j){var i;i=j.memo.file;if(i.id in Z._uploading_fileids){ba.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",ct.active_user,{});delete Z._uploading_fileids[i.id];return Z._toggle_send_button_state()}},get_folder_name:function(T){var j,i;if(Z.DEST_FOLDER){T();return}i=function(fm){var fl;fl=JSON.parse(fm);Z.DEST_FOLDER=fl.folder_name;return T()};j=function(){return ah.error(eA("We couldn\u2019t upload your file. Please try again."))};return cE.WebRequest({url:"/share/quick_send_folder_name",data:{},subject_user:Z.owner_id,success:i,error:j})},is_quicksend_dest:function(i){var j;j=aA.normalize(i);return j===Z.DEST_FOLDER},add_external_file:function(i){var T,j;j=i.dest+i.name;if(Z._has_added_fq_path(j)){ah.success(eA("You\u2019ve already added this file."));document.fire(cC.CANCEL_EVT,{file:i});bF(document).trigger(cC.CANCEL_EVT,{file:i});return}i.fq_path=j;i.bytes=i.size;Z._uploading_fileids[i.id]=true;Z._add_file(i,"external");T=bF("#"+i.id);return T.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(i){var j;if(i.dir){ah.error(eA("Please select files instead of folders."));return}if(Z._has_added_fq_path(i.fq_path)){ah.success(eA("You\u2019ve already added this file."));return}i.name=i.filename;Z._add_file(i,"dropbox");j=bF("#"+i.id);j.find(".upload-progress-bar").css({width:"100%"});j.addClass("complete");return setTimeout(function(){var T;T=j.find(".status-col");T.empty();return T.append(cx.make("web","s_check"))},0)}};var dX,cu,fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dX=E.SharedLinkSettingsModal=(function(j){fc(i,j);function i(T,fm,fl){var fn;this.owner_id=T;this.tkey=fm;this.dismiss_callback=fl;fn={tkey:this.tkey};fn[a9.UID_PARAM_NAME]=this.owner_id;i.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:fn});if(this.dismiss_callback){this.on_hide=this.dismiss_callback}}return i})(cD);cu=E.SharedLinkSettingsModalContent=(function(){function i(T,fl,j,fn){var fo,fm;this.owner_id=T;this.tkey=fl;this.filename=j;this.saved_password_placeholder_value=fn;this._save_settings=b3(this._save_settings,this);this._toggle_password_input=b3(this._toggle_password_input,this);this._enable_password_input_for_editing=b3(this._enable_password_input_for_editing,this);this._date_change_callback=b3(this._date_change_callback,this);this._show_calendar=b3(this._show_calendar,this);this._hide_calendar=b3(this._hide_calendar,this);this._future_date=b3(this._future_date,this);this._enable_save_button=b3(this._enable_save_button,this);this._custom_expiry_click_handler=b3(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=b3(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=b3(this._show_custom_expiry_label,this);this._toggle_expiration=b3(this._toggle_expiration,this);this._expiry_picker_callback=b3(this._expiry_picker_callback,this);this._listen=b3(this._listen,this);this._detect_and_handle_blur_when_password_empty=b3(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=b3(this._is_clicked,this);this._change_password_click=b3(this._change_password_click,this);this._init_expiration_section=b3(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bF(".sharing-settings-modal-content");this.modal=d7.get_containing_modal(this.$content);if(!this.modal){return}fm=eA("'%(filename)s' permissions").format({filename:bU.em_snippet(this.filename,18)});this.modal.set_title(fm);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fo=true)}this._init_expiration_section();this._listen()}i.prototype._init_expiration_section=function(){var j;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bF("#expiration-yes").prop("checked",true);j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(j);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};i.prototype._change_password_click=function(j){j.preventDefault();return this._enable_password_input_for_editing()};i.prototype._is_clicked=function(j,T){return j.is(T.target)||j.has(T.target).length};i.prototype._detect_and_handle_blur_when_password_empty=function(j){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,j)){return}return this._show_password_input(true)};i.prototype._listen=function(){if(this.loaded_with_saved_password){bF(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(j){return function(T){return d1.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bF(window).on(bA.CHANGED,this._expiry_picker_callback)};i.prototype._expiry_picker_callback=function(fm,fl){var j,T;if(fl.clicked_val===fl.old_val){return}j=fl.clicked_val;if(j!=="custom"){T=this._future_date(parseInt(j));return this._set_expiration(T)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};i.prototype._toggle_expiration=function(fl){var T,j;if(bF(fl.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();C.controller(bF(".expiration-picker")).set_value(30);j=30;T=this._future_date(j);this._set_expiration(T);return this._set_selected_date_text(T)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};i.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bF(window).on("click",this._custom_expiry_click_handler)};i.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bF(window).off("click",this._custom_expiry_click_handler)};i.prototype._custom_expiry_click_handler=function(j){if(this._is_clicked(this.$calendar,j)){return}if(this.$selected_date_box.is(j.target)||this.$selected_date_box.has(j.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};i.prototype._enable_save_button=function(j){return this.$save_button.removeAttr("disabled")};i.prototype._future_date=function(j){var T;T=d6.start_of_day(new Date());T.setDate(T.getDate()+j);return T};i.prototype._hide_calendar=function(){return this.$calendar.hide()};i.prototype._show_calendar=function(){var fl,T,j;bF(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{j=this._future_date(30)}T={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:j,onDateChange:bF.proxy(this._date_change_callback,this)};this.calendar=new I("expiration-calendar-container",T)}else{this.$calendar.show()}fl=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:fl})};i.prototype._posix_time_to_date=function(j){return new Date(j*1000)};i.prototype._set_selected_date_text=function(j){return this.$selected_date.text(N.localize(j))};i.prototype._set_expiration=function(T){var j,fl;cL(T.getMilliseconds()===0);cL(T.getSeconds()===0);cL(T.getMinutes()===0);cL(T.getHours()===0);fl=(T.getTime()+this.MS_PER_DAY)/1000;j=fl-1;return this.$expiry_posix.val(j)};i.prototype._date_change_callback=function(j){this._set_selected_date_text(j);this._set_expiration(j);this._enable_save_button();return this._hide_calendar()};i.prototype._show_password_input=function(fo){var fn,fl,T,fm,j;if(fo==null){fo=false}fn=this.$content.find("label[for=audience-password]").position().left;fm=this.$content.find("#audience-password").position().left;fl=fn-fm+10;this.$password.show().css({left:fl});this.$password_input.val("");if(fo){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");j="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(j).show();T=this.$password.position();return this.$change_password.css({left:T.left,top:T.top}).show()}else{return this._enable_password_input_for_editing()}};i.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(eA("Set password")).show();this.$password_input.focus();return this._enable_save_button()};i.prototype._toggle_password_input=function(j){var T;if(bF(j.currentTarget).attr("id")==="audience-password"){return this._show_password_input(T=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};i.prototype._save_settings=function(fm){var T,j,fl,fn;if(this.$password_input.data("is-saved-password")==="yes"){fl={type:"hidden",name:"password",value:this.saved_password_placeholder_value};T=bF("<input />",fl);this.$form.append(T);this.$password_input.attr("name","inoperative_password")}fn=(function(fo){return function(fp){d1.pop();return ah.success(eA("Settings saved."))}})(this);j=(function(fo){return function(fp){if(fo.$password.length&&fo.$password.is(":visible")){fo.$password_input.focus()}return bT.remove_loading()}})(this);return bT.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",fn,j,this.$save_button[0])};return i})();var eF;eF=E.SimpleSharing=(function(){function i(){}i.createAndShowInbandModalFromBrowseFile=function(j,T){return i.createAndShowInbandModal(j,T.fq_path,T.dir,T.target_ns,T.is_shared_folder(),T.could_be_shared_folder(),parseInt(T.sf_perm_role))};i.createAndShowInbandModalFromFile=function(j,T){return i.createAndShowInbandModal(j,T.fq_path,false,T.ns_id,false,false,d0.ACCESS_READER)};i.createAndShowM2InbandModal=function(T,fl){var fm,j;j=function(fn,fp,fo){return d1.push(new dX(fn,fp,fo))};fm=function(fo){var fn;fn=new dg(ct.active_user,fo);return fn.show()};return aI.showInstance(aI({needsFetchingTokenInfo:true,user:T,fqPath:fl,isDir:true,canReaderSync:false,isSharedFolder:true,couldBeSharedFolder:false,canEdit:true,editableLinksM2Enabled:true,showSharedLinkSettingsModal:j,onGoBackButtonClicked:fm}))};i.createAndShowInbandModal=function(j,fm,fl,fn,T,fp,fr){var fq,fo;fq=function(ft,fv,fs,fu){return window.INLINE_JS.DBModalStack.push(new ew(ft,fv,fs,fu))};fo=function(fu,fw,fv,ft,fs){return window.INLINE_JS.DBModalStack.push(new al(fu,fw,fv,ft,fs))};return dP.ShareInband.createAndShowModal(j,fm,{show_dfb_existing_folder_settings_modal:fq,show_dfb_new_folder_settings_modal:fo},Boolean(fl),fn,T,fp,parseInt(fr),ct.simple_sharing_react_member_list_enabled,ct.simple_sharing_individual_files_enabled)};i.dismissM2Prompt=function(){ct.simple_sharing_show_m2_prompt=false;return cE.WebRequest({url:"/simple_sharing_ajax/dismiss_m2_prompt"})};return i})();var ez,eu;eu=E.FoshmodalPanes=Object.clone(dr);eu.to_title_str=function(){var i,j,fn,T,fl,fm;if(ez.sharing_collection){fl=bU.em_snippet(ez.collection_to_share.name,18,1);return eA("Share '%(snippeted_name)s'").format({snippeted_name:fl})}else{i=ez._selection;T=c9.categorize_files(i),j=T[0],fn=T[1];if(j&&fn){fm=bd("Share %(file_count)s item","Share %(file_count)s items",i.length)}else{if(j){fm=bd("Share %(file_count)s photo","Share %(file_count)s photos",i.length)}else{fm=bd("Share %(file_count)s video","Share %(file_count)s videos",i.length)}}fm=fm.format({file_count:i.length});return fm}};ez=INLINE_JS.Foshmodal=E.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:eu.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=eu.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eU.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bF(".link-image").attr("src","static/images/empty_album_big.png");bT.remove_loading(bF("#modal").find(".tokenizer-submit-button")[0]);bT.remove_loading(bF("#modal").find(".foshmodal-copy-link")[0]);bT.remove_loading(bF("#shmodal-twitter-post-submit")[0]);return bT.remove_loading(bF("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(i){var j;cL(this._selection.length,"This should never be called with an empty selection");cL(this.current_tkey!=null,"Missing tkey");cL(this.current_shmodel_url!=null,"Missing shmodel url");cL(this.current_short_url!=null,"Missing short url");cL(i!=null,"Missing collection info");i.is_anonymous=this.creating_anonymous_collection();i.share_tkey=this.current_tkey;i.shmodel_url=this.current_shmodel_url;i.short_url=this.current_short_url;return j=new ad(i)},set_shmodel_url:function(j,i){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof j==="function"?j():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(T){return function(fm){var fl;fl=JSON.parse(fm.responseText);T.current_shmodel_url=fl.token_link;T.current_short_url=fl.short_link;T.current_tkey=fl.tkey;if(typeof j==="function"){j()}return typeof T.callback_for_when_we_have_shmodel_url==="function"?T.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof i==="function"?i():void 0}})}},attach_collection_to_token:function(j,i){cL(this.collection_to_share!=null,"Should get called only when there is an existing collection");cL(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof j==="function"){j(this.collection_to_share.gid)}return}cL(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,j,i)},create_collection_and_attach_to_token:function(fn,i){var T,fm,fl,j;cL(this.sharing_collection===false,"Should not get called when we already have a collection");cL(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fm=(function(fo){return function(fp){var fq;fq=JSON.parse(fp.responseText);fo.create_album_from_selected_photos(fq);return typeof fn==="function"?fn(fq.gid):void 0}})(this);T=function(fo){return typeof i==="function"?i(fo):void 0};fl={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fq,fo,fr,fp;fr=this._selection;fp=[];for(fq=0,fo=fr.length;fq<fo;fq++){j=fr[fq];fp.push(j.item_counter)}return fp}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fm,onFailure:T,parameters:fl})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ah.error(eA("Please enter a name for this album"));this.unlock();return true}if(cJ.collection_name_in_use(this.current_album_name)){ah.error(eA("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(T){var j,i;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}j=$("shmodal-send-form");cL(j,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}i=(function(fl){return function(fm){fl.unlock();if(!fm.responseText.startsWith("err:")){ah.error(eA("We couldn't send this album. Please try again."));fb.hide();return fl.refresh()}}})(this);if(this.sharing_collection){this.send_collection(j,i)}else{this.send_selection(j,i)}return g.log_interaction(el.SEND,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var fl,j,T,i,fm;fl=this.get_current_display_name();i=am.get_shmodel_send_recipients($("shmodal-send-form"));j=i[0].split(" ")[0];if(i.length===1){fm=eA("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:fl,first_name_of_recipient:j})}else{if(i.length===2){T=i[1].split(" ")[0];fm=eA("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:fl,first_name_of_recipient:j,first_name_of_second_recipient:T})}else{fm=eA("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:fl,first_name_of_recipient:j,num_other_recipients:i.length-1})}}return fm},send_selection:function(T,j){var fm,fl,i;fm=(function(fn){return function(fo){var fp;fp=JSON.parse(fo.responseText);fn.create_album_from_selected_photos(fp);ah.success(fn.get_send_success_text());fn.refresh();return fb.hide()}})(this);fl={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fp,fn,fq,fo;fq=this._selection;fo=[];for(fp=0,fn=fq.length;fp<fn;fp++){i=fq[fp];fo.push(i.item_counter)}return fo}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};if(this.creating_anonymous_collection()){fl.collection_name=""}else{if(this.current_album_name.trim().length===0){fl.collection_name=cJ.get_default_album_name()}}return bT.ajax_submit(T,"/collection_create_and_send_link",fm,j,T.down(".tokenizer-submit-button"),fl)},send_collection:function(j,i){var T;cL(this.current_tkey!=null,"tkey should be set");cL(this.current_shmodel_url!=null,"shmodel url should be set");T=(function(fl){return function(){ah.success(fl.get_send_success_text());fb.hide();return fl.refresh()}})(this);return this.collection_to_share.send_link(j,this.current_tkey,this.current_shmodel_url,this.current_short_url,T,i)},get_link_button_onclick:function(){var i,T,j;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}j=$("modal").down(".tokenizer-submit-button");T=(function(fl){return function(fn){var fm;fm=fl.get_current_display_name();if(FlashDetect.installed){ah.success(eA("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fm}))}fl.show_get_link_modal(fl.current_shmodel_url,fm,fn);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(fl.collection_to_share!=null){cA.log_share("share_link",fn,fl.num_photos_to_share,fl.creating_anonymous_collection(),!fl.sharing_collection)}return fl.refresh()}})(this);i=(function(fl){return function(fm){fl.unlock();bT.remove_loading(j);if(!fm.responseText.startsWith("err")){ah.error(eA("We couldn't create a link to this album. Please try again."));fb.hide();return fl.refresh()}}})(this);if(this.sharing_collection){bT.add_loading(j);this.attach_collection_to_token(T,i)}else{if(this.alert_if_album_name_invalid()){return}bT.add_loading(j);this.create_collection_and_attach_to_token(T,i)}return g.log_interaction(el.GET_LINK,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var i,j;if(FlashDetect.installed){i=t.clipboard_overlay(this.current_shmodel_url,bF("#foshmodal-copy-link"),ez.get_link_button_onclick.bind(this));i.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);j=(function(T){return function(){return i.clonePosition(bF("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(j,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(fn,j){var fm,T,i,fl;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(fn,j);return}fm=bF("#modal:visible, #modal-overlay:visible");i=function(){return fm.show()};T=(function(fo){return function(){fo.lock();setTimeout(fo.unlock.bind(fo),750);return eq.do_auth((function(){return fo.do_fb_post(j)}),j)}})(this);if(eq.authed_user_id===j){this.do_fb_post(j)}else{if(cM.get_viewer().is_uid_associated(eq.authed_user_id)){this.unlock();fm.hide();fl=new ed(cM.get_viewer().get_user_by_id(j),i,T.bind(this));fl.show()}else{T()}}return g.log_interaction(el.FB_SHARE,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(j,i){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(j,i);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cG.is_authed(i)){this.do_twitter_post(i)}else{setTimeout(this.unlock.bind(this),750);cG.do_auth(((function(T){return function(){return T.do_twitter_post(i)}})(this)),i)}return g.log_interaction(el.TWITTER_SHARE,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(i){var j,T;j=(function(fl){return function(){ah.error(eA("We couldn't share this album on Facebook. Please try again."));fb.hide();return fl.refresh()}})(this);T=(function(fl){return function(fn){var fm;eq.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};eq.progress_container=$("modal").down(".modal-buttons");fm=fl.get_current_display_name();eq.custom_show_complete=function(){fb.hide();ah.success(eA("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fm}));return fl.refresh()};eq.post($F("shmodal-fb-post-input"),fl.current_shmodel_url,null,null,null,j,i);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cA.log_share("share_facebook",fn,fl.num_photos_to_share,fl.creating_anonymous_collection(),!fl.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},do_twitter_post:function(i){var fl,j,T;fl=$F("shmodal-twitter-post-input");if(!fl){ah.error(eA("Please enter a tweet"));this.unlock();return}if(fl.length>140){ah.error(eA("Your tweet must be 140 characters or less"));this.unlock();return}T=(function(fm){return function(fn){cG.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};cG.custom_post(fl,function(){fb.hide();ah.success(eA("Your tweet has been posted!"));return fm.refresh()},i);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cA.log_share("share_twitter",fn,fm.num_photos_to_share,fm.creating_anonymous_collection(),!fm.sharing_collection)}})(this);j=(function(fm){return function(){ah.error(eA("We couldn't share this album on Twitter. Please try again."));fb.hide();return fm.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},show_get_link_modal:function(j,i,T){var fl;fb.show(eA("Link to %(album_name)s").format({album_name:i.escapeHTML()}),$("get-link-modal"));fl=$("get-link-modal").down(".link-input");fl.setValue(j);fl.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(j,"_blank");return fb.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(T!=null){cJ.flash_sidebar_album(T)}return fb.hide()}},update_current_album_name_text:function(i){this.current_album_name=$(eu.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===eu.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fm){var j,fl,T,i;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(fm){if(this.num_photos_to_share===1){j=fm}else{j=eA("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fm,album_desc:c9.file_desc(i)})}}else{if(i.length===1){T=i[0];if(T.preview_type==="photo"){fl=eA("Photo from %(date_taken)s")}else{fl=eA("Video from %(date_taken)s")}j=fl.format({date_taken:b6.nice_date_with_month_name(new Date(T.time_taken),true,true,true)})}else{j=c9.file_desc(i)}}return $(eu.to_content_str(eu.FB)).down(".link-name").__date(j)},set_current_album_name_text:function(j,i){$(eu.to_content_str(j)).down(".album-name-input").value=i;if(j===eu.FB){return this.set_fb_post_title(i)}},show_content:function(fn){var fl,T,j,fm;if(this.working){return}$("shmodal-title-text").__date(eu.to_title_str());fm=eu.list;for(T=0,j=fm.length;T<j;T++){fl=fm[T];if(fl!==fn){$(eu.to_toggle_str(fl)).removeClassName("toggled");$(eu.to_content_str(fl)).hide()}}$(eu.to_content_str(fn)).show();$(eu.to_toggle_str(fn)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(fn,this.current_album_name)}switch(fn){case eu.FB:$("shmodal-fb-post-input").focus();break;case eu.TWITTER:$("shmodal-twitter-post-input").focus();break;case eu.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=fn},_get_foshmodal_title:function(){return am.generate_title_content(eu.to_title_str(),((function(i){return function(){return i.show_content(eu.SEND)}})(this)),((function(i){return function(){return i.show_content(eu.FB)}})(this)),((function(i){return function(){return i.show_content(eu.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return c9.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var i,fl,j,fm,T;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(i.length===1){T=c9.categorize_files(i),j=T[0],fm=T[1];if(j){fl=eA("Just shared a photo using @Dropbox")}else{if(fm){fl=eA("Just shared a video using @Dropbox")}else{cL(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{fl=eA("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(fl+" "+this.current_short_url)},update_shmodal_image_text:function(){var fp,fq,fm,fr,fn,fu,T,fs,fo,fl,ft;if(this.sharing_collection){fu=this.collection_to_share.num_items;ft=c9.album_desc(this.collection_to_share,false,true)}else{fu=this._selection.length;ft=c9.file_desc(this._selection,false,true)}if(fu>1){T=$$(".shmodal-image");fo=[];for(fq=0,fr=T.length;fq<fr;fq++){fp=T[fq];fp.down("span").__date(ft);fo.push(fp.down(".share-file-count").show())}return fo}else{fs=$$(".shmodal-image");fl=[];for(fm=0,fn=fs.length;fm<fn;fm++){fp=fs[fm];fl.push(fp.down(".share-file-count").hide())}return fl}},show:function(fq,fz){var fs,fp,fw,fx,fo,fm,fu,fn,fl,fr,T,fv,ft,fy;this.unlock();fb.onHide=(function(i){return function(){var fA,j;if((fA=$("flash_copy_container"))!=null){fA.remove()}if((j=i.send_link_autocompleter)!=null){j.hide()}bF("#modal").find(".new-collab-input").val("");clearInterval(i.follow_freshbutton);bQ.disable_selection();delete fb.onHide;return fb.hide()}})(this);this.sharing_collection=fz;fy=this.sharing_collection?fq.thumbnail_url_256:fq[0].thumbnail_url;T=$$(".link_image");for(fp=0,fu=T.length;fp<fu;fp++){fw=T[fp];if(fy!=null){fw.src=fy}else{fw.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=eu.SEND;this.have_real_tkey=this.sharing_collection&&(fq.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fq;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fq.sort(function(j,i){return j.time_taken-i.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fv=$$(".save-as-album-checkbox");for(fo=0,fn=fv.length;fo<fn;fo++){fs=fv[fo];fs.checked=false;fr=(function(i){return function(fH){var fI,fC,fA,fD,fB,fG,fF,fE,j;if(fH.target.checked){$("shmodal").addClassName("saving-as-album");i.current_album_name=i.previous_album_name||cJ.get_default_album_name();i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fI=$(eu.to_content_str(i.current_foshmodal_pane)).down(".album-name-input");fI.focus();fI.select();fG=$$(".save-as-album-checkbox");fE=[];for(fC=0,fD=fG.length;fC<fD;fC++){fs=fG[fC];fE.push(fs.checked=true)}return fE}else{$("shmodal").removeClassName("saving-as-album");i.previous_album_name=i.current_album_name;i.current_album_name="";i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fF=$$(".save-as-album-checkbox");j=[];for(fA=0,fB=fF.length;fA<fB;fA++){fs=fF[fA];j.push(fs.checked=false)}return j}}})(this);fs.observe("change",fr);if(b1.msie_version_at_most(8)){fs.observe("click",fr)}}ft=$$(".album-name-input");for(fm=0,fl=ft.length;fm<fl;fm++){fx=ft[fm];fx.observe("keyup",this.update_current_album_name_text.bind(this))}}bQ.enable_selection();fb.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(i){return function(){i.initialize_get_link_button();return i.set_twitter_message()}})(this)),(function(){ah.error(eA("This request could not be completed.  Please try again."));return fb.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();V.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return d6._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var eE,aq,c1,dT,cC,d3,bp,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};cC=INLINE_JS.Upload=E.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var T,j,fl,i;fl={"MSIE 8.0":"flash","MSIE 9.0":"flash"};j="html5";for(T in fl){i=fl[T];if(navigator.userAgent.indexOf(T)!==-1){j=i}}return j})(),choose_button_id:"choose-button",set_dest:function(i){dv.fillVal(i,"dest-folder");return this.current_dest=i},init:function(T,fl,fm,j){var i;this.set_dest(T);i=this.initPLU(fm,j);if(!fl){an.window_load(i)}else{i()}bF("#flash-upload-container > .moxie-shim").each(function(fn){if(fn.observe){d6.freshbutton_overlay(fn,$("choose-button"));return d6.freshbutton_overlay(fn,$("add-button"))}});return aq.clear()},init_basic:function(){d6.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(i){return document.fire(cC.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(T){var j,i,fl;j=$("modal").cumulativeOffset();fl=T.clientY-j.top-3;i=T.clientX-j.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:fl+"px",left:i+"px"})});return $("file-box").observe("change",function(){var fm,T,fn,fl,i,j;fb.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();T=$("file-box").getValue().split("\\").pop();fl=cx.make("web",aA.file_icon(T));$("basic-upload-status").down(".icon").__date(fl);fm=eA("Uploading %(filename)s").format({filename:bU.em_snippet(T,25)});$("basic-upload-status").down(".file-desc").__date(fm);$("basic-upload-status").show();$("basic-uploading-message").show();fn=$("file-box").files;j=0;if(fn){i=fn[0].lastModifiedDate;if(i){j=Math.round(Date.parse(i)/1000)||0}}if(!j){j=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=j;return $("basic-upload-form").submit()})},initPLU:function(j,i){return(function(T){return function(){var fm,fl;fm={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:T.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:T.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(j){j()}return T.uploaderLoaded()},Error:T.uploadError.bind(T)},init:{FilesAdded:T.fileQueued.bind(T),UploadProgress:T.uploadProgress.bind(T),FileUploaded:T.uploadSuccess.bind(T),BeforeUpload:T.prepareFileForUploading.bind(T),ChunkUploaded:T.chunkUploaded.bind(T),UploadComplete:aq.finished.bind(aq),Refresh:function(){if(T.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bF("#flash-upload-container").clonePosition(bF("#add-button"));bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aN.UrlConstants.MOXIE_SWF_URL};if(i!=null){bF.extend(fm,i)}fl=new p.Uploader(fm);T.PLU=fl;return T.PLU.init()}})(this)},reset:function(){if(aq.uploading&&aq.current_file){this.PLU.removeFile(aq.current_file)}return c1.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return c1.show()}},updatePostParams:function(T){var j,i;i=this.PLU.settings.multipart_params;for(j in T){if(T.hasOwnProperty(j)){i[j]=T[j]}}return this.PLU.settings.multipart_params=i},fileQueued:function(fm,fo){var fn,T,i,fl;for(T=0,i=fo.length;T<i;T++){fn=fo[T];if((typeof fn.getNative==="function"?(fl=fn.getNative())!=null?fl.dest:void 0:void 0)===void 0){fn.dest=cC.current_dest}else{fn.dest=fn.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fo});bF(document).trigger(this.QUEUE_EVT,{files:fo});if(Z.is_quicksend_dest(fn.dest)){return}return this.show_upload()},uploadNext:function(){var fm,T,i,j,fn,fl;j=aq.next();i=(bx.contains(cC.APPLE_PACKAGE_EXTENSIONS,aA.file_extension_for_logging(j.name))&&j.size%34===0)||(aA.file_extension_for_logging(j.name)===""&&j.size%34===0&&j.size<=3400);if(i){j.status=p.FAILED;T={file:j,code:cC.APPLE_PACKAGE_ERROR,message:eA("Can\u2019t Upload"),tooltip_text:eA('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,T);return false}fn={dest:aq.next().dest,t:bw.read(aK.JS_CSRF_COOKIE)};fn[a9.UID_PARAM_NAME]=ct.active_user;if((fl=aA.file_extension(j.name,fm=true))==="url"||fl==="webloc"||fl==="website"){fn.overwrite=0}cC.updatePostParams(fn);this.PLU.start();aq.last_update_time=0;aq.last_update_size=0;return true},pause:function(){return cC.PLU.stop()},uploadProgress:function(j,i){if(!aq.cancelled_files[i.id]){document.fire(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size});return bF(document).trigger(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size})}},generateUploadId:function(){var T,fm,fl,fn;T="";for(fm=fl=0;fl<=15;fm=++fl){T+=String.fromCharCode(Math.floor(Math.random()*256))}fn=ak.encode(T);fn=fn.replace(/\+/g,"-");fn=fn.replace(/\//g,"_");fn=fn.replace(/\=*$/,"");return fn},chunkUploaded:function(j,T,fl){var i;i=JSON.parse(fl.response||"");return this.updatePostParams({offset:i.offset})},prepareFileForUploading:function(){var i;i=aq.next();return this.updatePostParams({reported_total_size:i.size,dest:i.dest,t:bw.read(aK.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fm,fl,T){var j,fn,i;try{i=JSON.parse(T.response)}catch(fn){j=fn;i=null}if(T.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:fl,message:eA("Quota exceeded"),tooltip_text:eA("Your upload failed because you are over quota.")});return bF(document).trigger(this.ERROR_EVT,{file:fl,message:eA("Quota exceeded"),tooltip_text:eA("Your upload failed because you are over quota.")})}else{if(T.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:fl,message:eA("Empty File")});return bF(document).trigger(this.CANCEL_EVT,{file:fl,message:eA("Empty File")})}else{if(T.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:fl,message:eA("File Ignored")});return bF(document).trigger(this.CANCEL_EVT,{file:fl,message:eA("File Ignored")})}else{if((i!=null?i.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:fl});return bF(document).trigger(this.COMPLETE_EVT,{file:fl})}else{document.fire(this.ERROR_EVT,{file:fl});return bF(document).trigger(this.ERROR_EVT,{file:fl})}}}}},uploadComplete:function(j,i){document.fire(this.COMPLETE_EVT,{file:i});return bF(document).trigger(this.COMPLETE_EVT,{file:i})},uploadError:function(fm,i){var fl,T,j;if((j=i.file.id,cT.call(aq.file_ids(),j)<0)&&i.code!==cC.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[i.file]});bF(document).trigger(this.QUEUE_EVT,{files:[i.file]})}T=(function(){switch(i.code){case p.FILE_SIZE_ERROR:return eA("File too large");default:return eA("Upload Error")}})();this.show_upload();fl={file:i.file,error_code:i.code,message:T};if(i!=null?i.tooltip_text:void 0){fl.tooltip_text=i.tooltip_text}document.fire(this.ERROR_EVT,fl);return bF(document).trigger(this.ERROR_EVT,fl)},grabURL:function(){var i;i=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(i)){$("url").value=i}return true},treeview_handler:function(j,i){var T;dv.fillVal(j,"dest-folder");T=$("basic-uploader-url");if(T){T.href=T.href.replace(/(\/upload)(.*)(\?basic=1)/,function(fn,fm,fo,fl){return fm+d6.urlquote(j)+fl})}return aq.clear()},new_folder:function(){b2.hide();fb.show(eA("Create new folder..."),dv.fromElm("create-folder"),{action:this.do_new_folder.bind(this,ct.active_user),wit_group:"new-folder-confirm"});if(!d6.ie){return bF("#first-treeview-link").trigger("click")}},do_new_folder:function(i){var T,j;if(!fb.vars.selected_path){ah.error(eA("Please select a parent folder."));return}j=$F("entered-name");T=fb.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+d6.urlquote(T)+"?to_path="+d6.urlquote(j),{subject_user:i,onSuccess:(function(fl){return function(fm){fl.treeview_handler(aA.normalize(T)+"/"+j);return b2.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cC.PLU.runtime==="flash"){bF("#flash-upload-container").clonePosition(bF("#choose-button"));bF("#flash-upload-container > .moxie-shim")[0].style.top="0px";bF("#flash-upload-container > .moxie-shim")[0].style.left="0px";bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bF("#"+this.choose_button_id).click((function(i){return function(j){return bF("#"+i.PLU.id+"_html5").click()}})(this));return bF("#add-button").click((function(i){return function(j){return bF("#choose-button").click()}})(this))}}};aq=E.FileQueue={init:function(){return aq._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,aq._file_queued.bind(this));document.observe(cC.QUEUE_ERROR_EVT,aq._file_queue_errored.bind(this));document.observe(cC.UPDATE_EVT,aq._file_updated.bind(this));document.observe(cC.COMPLETE_EVT,aq._file_completed.bind(this));document.observe(cC.ERROR_EVT,aq._file_errored.bind(this));return document.observe(cC.CANCEL_EVT,aq._file_cancelled.bind(this))},_file_queued:function(fo){var fm,T,i,fn,fl;fn=fo.memo.files;fl=[];for(T=0,i=fn.length;T<i;T++){fm=fn[T];this.files[fm.id]=fm;if(!aq.uploading){this._start_uploading()}this.current_file=fm;fl.push(eI("File queued:",fm.name))}return fl},_file_queue_errored:function(i){this._file_queued(i);return setTimeout(((function(j){return function(){return j._file_errored(i)}})(this)),250)},_file_updated:function(fq){var fl,i,j,T,fo,fn,fm,fp,fr;T=fq.memo.file;fn=fq.memo.percent_complete;fo=fn*T.size;fr=fo+this.completed_size();j=new Date().getTime();if(this.last_update_time){fm=(j-this.last_update_time)/1000;if(cC.PLU.total.bytesPerSec){this.average_bps=cC.PLU.total.bytesPerSec}else{i=fo-this.last_update_size;fl=i/fm;this.average_bps=((fr-i)*this.average_bps+i*fl)/fr}fp=(this.queue_size()-fr)/this.average_bps;this.formatted_time=b6.format_time(fp+this.num_left())}this.current_file=T;this.last_update_time=new Date().getTime();return this.last_update_size=fo},_file_completed:function(j){var i;i=j.memo.file;this.completed_files[i.id]=true;eI("File completed:",i.name);return this._check_if_finished(i)},_file_errored:function(j){var i;i=j.memo.file;this.errored_files[i.id]=true;eE.update_errors();c1.update_errors();eI("File errored:",i.name);return this._check_if_finished(i)},_file_cancelled:function(j){var i;i=j.memo.file;this.cancelled_files[i.id]=true;if(i.status===p.UPLOADING){cC.PLU.stop();cC.PLU.removeFile(i);cC.PLU.start()}else{cC.PLU.removeFile(i)}eI("File cancelled:",i.name);return this._check_if_finished(i)},_start_uploading:function(){var i;this.uploading=cC.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=i=(function(j){return function(){return eA("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(i){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cC.uploadNext()}},_finished_uploading:function(){var j,T,fl,i;this.uploading=false;if(!this.num_files()){eE.cancelled()}else{if(this.errors()){eE.errored();c1.errored()}else{eE.completed();c1.completed()}}i=$("inline-upload-status").visible();ct.select_fq_paths=[];if(ct.inside_dir){for(fl in this.completed_files){T=this.files[fl];j=aA.normalize(T.dest);ct.select_fq_paths.push(j+"/"+T.name)}ct.force_reload()}else{if(ct.in_search_mode()){cb.force_reload()}}if(i){c1.show()}fb.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return bx(this.files).filter((function(i){return function(j){return !(i.cancelled_files[j.id]||i.errored_files[j.id]||i.completed_files[j.id])}})(this))[0]},cancels:function(){return bx(this.cancelled_files).keys().length},errors:function(){return bx(this.errored_files).keys().length},queue_size:function(){var fl,fo,T,i,fn,fm;fm=0;fn=this.file_ids();for(T=0,i=fn.length;T<i;T++){fo=fn[T];fl=this.files[fo];if(!this.errored_files[fo]&&!this.cancelled_files[fo]&&typeof fl.size!=="undefined"){fm+=fl.size}}return fm},completed_size:function(){var fn,T,i,fm,fl;fl=0;fm=bx(this.completed_files).keys();for(T=0,i=fm.length;T<i;T++){fn=fm[T];if(typeof this.files[fn].size!=="undefined"){fl+=this.files[fn].size}}return fl},file_ids:function(){return bx(this.files).map((function(i){return function(j,T){return T}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return bx(this.file_ids()).filter((function(i){return function(j){return !(i.cancelled_files[j]||i.errored_files[j]||i.completed_files[j])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof fb!=="undefined"&&fb!==null){return fb.onHide=null}}};aq.clear();d3=E.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){d3._tmpl=fg.tmpl("upload_list_item_tmpl");return d3._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,d3._file_queued);document.observe(cC.QUEUE_ERROR_EVT,d3._file_queue_errored);document.observe(cC.UPDATE_EVT,d3._file_updated);document.observe(cC.COMPLETE_EVT,d3._file_completed);document.observe(cC.ERROR_EVT,d3._file_errored);return document.observe(cC.CANCEL_EVT,d3._file_cancelled)},_file_queued:function(fo){var fm,T,i,fn,fl;fn=fo.memo.files;fl=[];for(T=0,i=fn.length;T<i;T++){fm=fn[T];fl.push((function(fp){var fv,j,fs,fu,ft,fw,fq,fr;fv=fp.dest;if(Z.is_quicksend_dest(fv)){Z.add_external_file(fp);return}fw=aF.format_bytes(fp.size||0);j=d3._tmpl({file:fp,icon:aA.file_icon(fp.name),filename_snippet:bU.em_snippet(fp.name,d3.FILENAME_SNIPPET_LENGTH),size:fw,dest:fv,dest_snippet:bU.em_snippet(eA("Dropbox")+fv,d3.DEST_SNIPPET_LENGTH,0),Sprite:cx});$("upload-files-list").__sert(j);fu=$(fp.id);ft=aq.num_files();if(dx.show_share_button_in_file_uploader){fs=bF("#"+fp.id);fs.find(".dest-col").hide()}fq=$("upload-files-list");if(ft<=6){fq.removeClassName("scroll")}else{fq.addClassName("scroll")}fq.scrollTop=fq.scrollHeight;fu.down(".dest").observe("click",function(){ct.reload_fqpath(fu.readAttribute("data-dest"),true);return fb.hide()});fr=fu.down(".status-col").down("a.small-x-button");fr.stopObserving("click");fr.observe("click",function(fx){document.fire(cC.CANCEL_EVT,{file:fp});return bF(document).trigger(cC.CANCEL_EVT,{file:fp})});return fu.down(".upload-progress-bar").setStyle({width:"0"})})(fm))}return fl},_file_queue_errored:function(i){d3._file_queued(i);return d3._file_errored(i)},_file_updated:function(fl){var T,fm,j,i;T=fl.memo.file;fm=$(T.id);if(aq.num_files()===1){i=eA("%(time_left)s left").format({time_left:aq.formatted_time});fm.down(".time-col").__date(i)}j=parseInt(T.percent,10)+"%";if(j==="100%"){fm.down(".time-col").__date();fm.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fm.down(".upload-progress-bar").setStyle({width:j})},_file_completed:function(j){var i,T,fl;i=j.memo.file;i.completed=true;fl=$(i.id);fl.addClassName("complete");if(dx.show_share_button_in_file_uploader&&!Z.is_quicksend_dest(i.dest)){T=bF("#"+i.id);T.find(".share-link").show();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",ct.active_user,{});T.on("click",function(fo){var fn,fm;fb.hide();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",ct.active_user,{});fn=i.dest+"/"+i.name;fm="file_uploader";return dx.shmodel(fn,fm)})}setTimeout(function(){return fl.down(".status-col").__date(cx.make("web","s_check"))},0);return fl.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(j){var i,T;i=j.memo.file;T=$(i.id);if(T){return d3._actual_file_errored(j)}else{return setTimeout((function(fl){return function(){return d3._actual_file_errored(j)}})(this),0)}},_actual_file_errored:function(fm){var i,T,j,fn,fl;j=fm.memo.file;fn=$(j.id);fn.addClassName("error");fn.down(".dest-col").hide();fn.down(".time-col").__date();fn.down(".status-col").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));fn.down(".upload-progress-bar").setStyle({width:"100%"});if(Z.is_quicksend_dest(j.dest)){return}T=fm.memo.message||eA("Upload Error");i=void 0;if(fm.memo.tooltip_text){i=fm.memo.tooltip_text}else{i=eA('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bF(document).on("click","a#basic_link",function(){dD.show_basic_upload();return false})}fn.down(".error-msg").__date(T);fl=fn.down(".error-details");fl.observe("mouseover",function(){return ei.show(fl,i)});return fn.down(".error-col").show()},_file_cancelled:function(j){var i,T;i=j.memo.file;T=$(i.id);T.addClassName("cancelled");T.down(".dest-col").__date(eA(j.memo.message||"Canceled"));T.down(".time-col").__date();T.down(".status-col").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return T.down(".upload-progress-bar").setStyle({width:"100%"})}};eE=E.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return eE._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,eE._file_queued.bind(this));return document.observe(cC.UPDATE_EVT,eE._file_updated.bind(this))},_file_queued:function(j){var i;i=new Element("a",{"class":"small-x-button"});i.observe("click",function(){var fn,fo,fl,T,fm;aq.all_cancelled=true;fn=aq.file_ids().slice(0);fm=[];for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];if(!aq.completed_files[fo]&&!aq.errored_files[fo]){document.fire(cC.CANCEL_EVT,{file:aq.files[fo]});fm.push(bF(document).trigger(cC.CANCEL_EVT,{file:aq.files[fo]}))}else{fm.push(void 0)}}return fm});return this.elem.down(".status").__date(i)},_file_updated:function(fl){var T,j,i;if(aq.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");T=bd("%d file","%d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(T);j=eA("- %(size)s").format({size:aF.format_bytes(cC.PLU.total.size)});this.elem.down(".size").__date(j);if(aq.formatted_time){i=eA("%(time_left)s left").format({time_left:aq.formatted_time});this.elem.down(".time-left").__date(i)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(aq.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cC.PLU.runtime==="flash"){return bF("#flash-upload-container").clonePosition(bF("#add-button"))}}},update_errors:function(){var i;i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return $("bulk-upload-status").down(".num-errors").__date(i)},completed:function(){var j,i;$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("complete");j=bd("Uploaded %d file","Uploaded %d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(j);i=eA("- %(size)s").format({size:aF.format_bytes(aq.completed_size())});this.elem.down(".size").__date(i);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cx.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var i;$("hide-button").hide();$("done-button").show();this.completed();i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return this.elem.down(".num-errors").__date(i)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(eA("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return this.elem.down(".upload-progress-bar").style.width="100%"}}};c1=E.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,c1._file_queued.bind(this));return document.observe(cC.UPDATE_EVT,c1._file_updated.bind(this))},_file_queued:function(T){var j,i;j=$("inline-upload-status");j.removeClassName("error");j.removeClassName("complete");j.down(".icon").__date(cx.make("web","s_sync"));j.down(".file-desc").__date(eA("Starting upload..."));j.down(".num-errors").__date();i=bd("%d file","%d files",aq.num_left()).format(aq.num_left());j.down(".view-details").__date(i);j.down(".status").__date();return j.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fo){var fn,T,fl,fm,j,i;fn=$("inline-upload-status");T=fo.memo.file;fn.down(".icon").__date(cx.make("web","s_sync"));fl=eA("Uploading %(filename)s").format({filename:bU.em_snippet(T.name,this.FILENAME_SNIPPET_LENGTH)});fn.down(".file-desc").__date(fl);if(aq.num_left()>1){i=bd("%d file left","%d files left",aq.num_left()-1).format(aq.num_left()-1);fn.down(".view-details").__date(i)}else{fn.down(".view-details").__date(eA("View details"))}if(aq.formatted_time){j=eA("%(time_left)s left").format({time_left:aq.formatted_time});fn.down(".status").__date(j)}fm=T.percent+"%";return fn.down(".inline-upload-progress").style.width=fm},update_errors:function(){var i,j;i=$("inline-upload-status");j=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return i.down(".num-errors").__date(j)},add_x_button:function(){var i,j;j=new Element("a",{"class":"small-x-button"});j.observe("click",function(){c1.hide();return cC.reset()});i=$("inline-upload-status");return i.down(".status").__date(j)},completed:function(){var j,i;j=$("inline-upload-status");j.addClassName("complete");j.removeClassName("error");j.down(".icon").__date(cx.make("web","s_check"));if(aq.num_files()>1){i=eA("Uploaded %(num_files)d files").format({num_files:aq.num_non_cancelled_files()})}else{i=eA("Uploaded %(filename)s").format({filename:bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}j.down(".file-desc").__date(i);j.down(".num-errors").__date();j.down(".view-details").__date(eA("View details"));this.add_x_button();return j.down(".inline-upload-progress").style.width="100%"},errored:function(){var T,j,i,fl;T=$("inline-upload-status");T.addClassName("error");T.removeClassName("complete");T.down(".icon").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));j=void 0;if(aq.num_files()>1){j=eA("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:aq.num_non_cancelled_files()-aq.errors(),num_files:aq.num_non_cancelled_files()});T.down(".file-desc").__date(j);fl=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());T.down(".num-errors").__date(fl)}else{if(aq.current_file!=null){i=bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)}j=i?eA("Unable to upload %(filename)s").format({filename:i}):eA("Unable to upload file");T.down(".file-desc").__date(j);T.down(".num-errors").__date()}T.down(".view-details").__date(eA("View details"));this.add_x_button();return T.down(".inline-upload-progress").style.width="100%"},show:function(i){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bp=E.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bp.supported()&&ct.inside_dir&&!(ct.in_search_mode()&&cb.fulltext_search_enabled)},browse_indicators_enabled:function(){var fm,T,i,fl;if(!bp.enabled()){return false}fl=["modal-overlay"];if(cC.choose_button_id.startsWith("wizard-")){fl.push("wizard-overlay")}for(T=0,i=fl.length;T<i;T++){fm=fl[T];if($(fm).visible()){return false}}return true},modal_indicators_enabled:function(){var i;return bp.enabled()&&bF("#modal #upload-modal-dropzone").length&&bF("#modal").visible()&&((i=bF("#modal").offset())!=null?i.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(i){return bF(i).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(j){var i;if(!bp._drop_indicators){if(bp.modal_indicators_enabled()){i=$("upload-modal-dropzone");bF(i).clonePosition(bF("#modal"),{setLeft:false,setTop:false});bF(i).fadeIn(500);bp._show_border_drop_indicators()}else{if(bp.browse_indicators_enabled()){bR._add_drop_indicators(j)}else{return}}$("drag-status").removeClassName("active");return bp._drop_indicators=true}},hide_drop_indicators:function(){if(bp._drop_indicators){bp._hide_border_drop_indicators();bR._remove_drop_indicators();if(!bp._notifications_cleared){ah.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bp._drop_indicators=false;bp._drop_dest_folder=null;return bp._notifications_cleared=false}),500)}return bp._notifications_cleared=true},folder_dragover:function(i){var j;if(bp.browse_indicators_enabled()&&bp._drop_indicators){if(dT.disabled){if(bp._drop_dest_folder==null){j=eA("You can't upload files because you're out of space.");ah.error(j,60);bp._notifications_cleared=false;bp._show_border_drop_indicators()}}else{if(i!==bp._drop_dest_folder){if(i===ct.containing_fq_path()){if(ct.inside_read_only_shared_folder){j=eA("You don't have permission to add to this folder.");ah.error(j,60)}else{j=eA("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dD.upload_plain_snippet()});ah.success(new fg(j),60);bp._show_border_drop_indicators()}bp._notifications_cleared=false}else{ah.clear();bp._hide_border_drop_indicators()}}}return bp._drop_dest_folder=i}},supports_recursive_upload:function(i){var j;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(i!=null?(j=i[0])!=null?j.webkitGetAsEntry:void 0:void 0)},upload:function(fm,fo,T){var fn,fl,i,fp;if(T==null){T=null}if(ct.inside_read_only_shared_folder){return}if(dT.disabled){fp=eA("You can't upload files because you're out of space.");return ah.error(fp)}else{if(bp.supports_recursive_upload(T)){return bp._recursive_upload(fm,T)}else{for(fl=0,i=fo.length;fl<i;fl++){fn=fo[fl];fn.dest=fm}return bp._upload(fo,T)}}},_recursive_upload:function(fu,fs){var fw,fr,i,fl,fm,ft,fq,fx,T,fv,fn,fp,fo;T=[];fo=[];fr=function(j,fy){j.dest=fu+aA.parent_dir(fy.fullPath);return T.push(j)};for(fn=0,fp=fs.length;fn<fp;fn++){fv=fs[fn];ft=fv.webkitGetAsEntry();if(ft!==null){if(ft.isDirectory){if(Z.is_quicksend_dest(fu)){ah.error(eA("Please select files instead of folders."))}else{fo.push(ft)}}else{fr(fv.getAsFile(),ft)}}}fm=0;fx=0;i=function(j,fz){var fy;fy=eA('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fz.name});ah.error(new fg(fy));return bF("#use-advanced-uploader").on("click",function(fA){fA.preventDefault();return dD.show_upload()})};fw=3000;fq=0;fl=function(){var j;while(fo.length){ft=fo.pop();if(ft!==null){if(ft.isDirectory){(function(fz){var fy;fy=fz.createReader();fm+=1;return fy.readEntries(function(fA){var fD,fB,fC;if(fA.length!==0){for(fB=0,fC=fA.length;fB<fC;fB++){fD=fA[fB];fo.push(fD)}return fy.readEntries(arguments.callee)}else{return fm-=1}},function(fA){fm-=1;return i(fA,fz)})})(ft)}else{fx+=1;j=function(fy){return function(fz){fr(fz,fy);return fx-=1}};ft.file(j(ft),function(fy){fx-=1;return i(fy,ft)})}}}if(T.length>fw&&!fq){fq=1;ah.error(eA("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fw}));return}if(fm||fx){return fl.defer()}else{if(T.length){return bp._upload(T)}}};return fl()},_upload:function(fl,j){var i,T;if(j==null){j=null}if(j){i=this._parse_upload_items(j)}T=function(){var fp,fn,fm,fq,fo;fo=[];for(fn=0,fm=fl.length;fn<fm;fn++){fp=fl[fn];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(i!=null?(fq=i[fp.name])!=null?fq.isDirectory:void 0:void 0)){fp.is_directory=true}fp.id=p.guid();fo.push(cC.PLU.addFile(fp))}return fo};if($("modal").visible()){return T()}else{dD.show_upload(T);return fb.hide(null,true)}},_parse_upload_items:function(T){var fm,fn,fl,i;fm={};for(fl=0,i=T.length;fl<i;fl++){fn=T[fl];if(fn.getAsEntry){fn=fn.getAsEntry()}else{if(fn.webkitGetAsEntry){fn=fn.webkitGetAsEntry()}}fm[fn.name]=fn}return fm}};dT=E.OverQuotaUploads={disabled:false,init:function(i){this.disabled=i;if(this.disabled){return bF("body").addClass("uploads-disabled")}}};var dD;dD=INLINE_JS.FileOps=E.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(fl){var fn,T,i,fm;fm=fb.vars.apps;for(T=0,i=fm.length;T<i;T++){fn=fm[T];if(fn.app_id!==fl){continue}return fn}return null},create_album_from_folder:function(j,i){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:j,album_name:i},job:true,job_user:cM.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:eA("Creating album..."),onSuccess:function(T){var fl;fl=JSON.parse(T.responseText);return window.location.href=fl.url}})},dir_handler:function(fl,T){var j,i;if(typeof T==="string"){T=$(T)}j=$$(".treeview .highlight")[0];if(j){j.removeClassName("highlight")}i=T.up("div");i.addClassName("highlight");fb.selected_div=i;if(fb.shown()){T.blur()}document.fire("db:dir_click",{path:fl});return fb.vars.selected_path=fl},show_folder_pick:function(fn,fl,T,fm,i){var j;dv.fillVal(aA.filename(fl).escapeHTML(),"folder-pick-file");b2.move("copy-move-treeview","folder-pick-treeview",{user:ct.active_user});j=(i?eA("Move"):eA("Copy"));dv.fillVal(j,"folder-pick-action-text");fb.show(fn,$("folder-pick"),{fq_path:fl,action:T,folder:fm});return bF("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fo,fn,fl,fm){var j,i,T;T=a6.profile_files(fl);i=a6.profile_summary(T);dv.fillVal(i,"bulk-folder-pick-file");b2.move("copy-move-treeview","bulk-folder-pick-treeview",{user:ct.active_user});if(fn==="move"){j=eA("Move")}else{if(fn==="copy"){j=eA("Copy")}else{j=eA("Restore")}}dv.fillVal(j,"bulk-folder-pick-action-text");fb.show(fo,$("bulk-folder-pick"),{files:fl,action:fm});return bF("#first-treeview-link").trigger("click")},show_copy:function(i,j){var T;T=(j?eA("Copy folder to..."):eA("Copy file to..."));b2.set_params({disable_read_only:true});return dD.show_folder_pick(T,i,dD.do_copy,j,false)},show_copy_bulk:function(i){var j;j=bd("Copy %(item_count)s item to...","Copy %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dD.show_bulk_folder_pick(j,"copy",i,dD.do_bulk_copy)},show_compress_bulk:function(i,j){b2.set_params({disable_read_only:true});return dM.show({title_text:bd("Compress file?","Compress files?",j.length),body_html:bd("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",j.length).format({file_count:j.length,filename:bx.escape(j.first().filename)}),confirm_text:eA("Compress"),cancel_text:eA("Cancel"),confirm_callback:function(){return dD.do_bulk_compress(i,j)}})},do_bulk_compress:function(i,T){var j;ah.clear();j=T.pluck("fq_path");return cE.WebProgressRequest({url:"/cmd/compress",data:{files:j},subject_user:i,progress_text:eA("Compressing..."),success:function(fo){var fn,fm,fl;fl=JSON.parse(fo);fn=fl.compressed_files;cL(fn.length>0,"Must have at least 1 compressed file");fm=bx.escape(aA.filename(fn.first().fq_path));ah.success(bd("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",fn.length).format({file_count:fn.length,filename:fm}));return bF(document).trigger(aH.COMPRESS,{original_files:T,compressed_files:fn})}})},show_move_bulk:function(i){var j;j=bd("Move %(item_count)s item to...","Move %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dD.show_bulk_folder_pick(j,"move",i,dD.do_bulk_move)},show_move:function(i,j){var T;T=(j?eA("Move folder to..."):eA("Move file to..."));b2.set_params({disable_read_only:true});return dD.show_folder_pick(T,i,dD.do_move,j,true)},show_delete:function(i,T,fl,j,fo,fn){var fm;if(fo==null){fo=null}if(fn==null){fn=false}if(fn){fm=eA("Are you sure you want to delete the shared folder \u2018<strong>%(items)s</strong>\u2019? This shared folder will stay shared with other members and you can rejoin it later.").format({items:aA.filename(T).escapeHTML()})}else{if(fo){fm=eA("Are you sure you want to delete <strong>%(items)s</strong> from the shared folder \u2018%(sf_name)s\u2019?").format({items:aA.filename(T).escapeHTML(),sf_name:fo.escapeHTML()})}else{fm=eA("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(T).escapeHTML()})}}return dM.show({title_text:fl?eA("Delete folder?"):eA("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fm+"</div>",confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:function(){if(j){return dD.do_nonbrowse_delete(i,[T])}else{return dD.do_delete(i,T)}}})},show_bulk_delete:function(i,j,fl){var T;if(fl==null){fl=null}if(fl){T=bd("Are you sure you want to delete %(item_count)s item from the shared folder \u2018%(sf_name)s\u2019?","Are you sure you want to delete %(item_count)s items from the shared folder \u2018%(sf_name)s\u2019?",j.length).format({item_count:j.length,sf_name:fl.escapeHTML()})}else{T=bd("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",j.length).format({item_count:j.length})}return dM.show({title_text:bd("Delete %(item_count)s item?","Delete %(item_count)s items?",j.length).format({item_count:j.length}),body_html:T,confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dD.do_bulk_delete(i,j)}})},show_purge:function(i,j){return dM.show({title_text:j?eA("Permanently delete folder?"):eA("Permanently delete file?"),body_html:eA("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(i).escapeHTML()}),confirm_text:eA("Permanently delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dD.do_purge(ct.find_file(i))}})},show_bulk_purge:function(i){return dM.show({title_text:bd("Permanently delete %d item?","Permanently delete %d items?",i.length).format(i.length),body_html:bd("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",i.length).format({item_count:i.length}),confirm_text:eA("Permanently delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dD.do_bulk_purge(i)}})},show_bulk_restore:function(j,i){return dM.show({title_text:bd("Restore %d item...","Restore %d items...",j.length).format(j.length),body_html:bd("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",j.length).format({item_count:j.length}),confirm_text:eA("Restore"),cancel_text:eA("Cancel"),confirm_callback:function(){return dD.do_bulk_restore(j)}})},wrap_strong:function(i){if(ct.containing_fq_path()===""){return i.escapeHTML()}else{return"<strong>"+i.escapeHTML()+"</strong>"}},upload_snippet:function(T){var i,j;if(T==null){T=1000}if(cM.get_viewer().is_paired&&ct.active_user.is_team){j=bU.em_snippet(cM.get_viewer().team_name,T).escapeHTML()}if(ct.containing_fq_path()===""){if(cM.get_viewer().is_paired){if(ct.active_user.is_team){return eA(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:j})}else{return eA(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return eA(" upload to your Dropbox")}}else{i=bU.em_snippet(aA.filename(ct.containing_fq_path()),T).escapeHTML();if(cM.get_viewer().is_paired){if(ct.active_user.is_team){return eA(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i,team_name:j})}else{return eA(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}else{return eA(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}},upload_short_snippet:function(T){var j,i;if(T==null){T=1000}i=ct.containing_fq_path();if(!i){return eA("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}j=bU.em_snippet(aA.filename(i),T);return eA("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:j})},upload_plain_snippet:function(i){if(i==null){i=1000}return this.upload_snippet(i).replace("<strong>","'").replace("</strong>","'")},show_upload:function(fr,i,fp){var fm,fn,fo,fq,fl,T;fm=ct.containing_fq_path();if(dT.disabled){dv.fillVal(this.wrap_strong(aA.filename(fm)),"disabled-upload-foldername");fl=this.upload_short_snippet(20);fb.show(fl,$("disabled-upload-modal"),{},false);return}bF(document).trigger(this.SHOW_UPLOAD_EVT,{source:i,has_callback:fr!=null});if((!FlashDetect.versionAtLeast(9))&&cC.runtimes==="flash"){dD.show_basic_upload();$("enhanced-upload-toggle").hide();return}dv.fillVal(this.upload_snippet(20),"upload-foldername");dv.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bp.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}fl=this.upload_short_snippet(20);fb.show(fl,dv.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,aq.num_files());T=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(fn=0,fo=T.length;fn<fo;fn++){fq=T[fn];if(fq!=null){fq.observe("click",function(){dD.show_basic_upload();return false})}}if(!aq.num_files()){cC.init(aA.normalize(fm),true,fr,fp)}else{cC.set_dest(aA.normalize(fm))}return c1.hide()},show_basic_upload:function(){dv.fillVal(this.upload_snippet(20),"basic-upload-foldername");fb.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dD.show_upload();return false});cC.set_dest(aA.normalize(ct.containing_fq_path()));return cC.init_basic()},show_undelete:function(i){var j,T,fl;dv.fillVal(i.filename.escapeHTML(),"undelete_filename");j=cx.make("web",i.icon,{});j.addClassName("link-img");j.style.backgroundColor="transparent";T=dD.build_revisions_uri(i.fq_path,ct.active_user,{undelete:1});$$(".undelete-icon").invoke("update",j);$$(".undelete-other-versions")[0].href=T;$$(".undelete-link")[0].href=T;fl=eA("Restore file?");return fb.show(fl,$("undelete-modal"),{file:i})},do_undelete:function(j){var i,T;i=fb.vars.file;T=eA("Restored '%(file_name)s'").format({file_name:i.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[i.fq_path]},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:function(fl){fb.hide();ah.success(T);return document.fire(aH.RESTORE,{files:[i]})}});return false},do_copy:function(T,j){var i;T=T||fb.vars.fq_path;j=j||fb.vars.selected_path;i=ct.find_file(T);cL(i,"Trying to copy a file we couldn't find.");return dD.do_bulk_copy([i],j)},do_bulk_copy:function(fq,fl){var fo,fp,fn,fm,T;ct.pre_action_selection=eW.get_selected_fq_paths();fq=fq||fb.vars.files;cL(fq.length>0,"Tried to copy 0 files");if(typeof fl==="undefined"){if(typeof fb.vars.selected_path==="undefined"){ah.error(eA("You need to select a destination for the file."));return}else{fl=fb.vars.selected_path}}fl=aA.normalize(fl);fn=0;for(fm=0,T=fq.length;fm<T;fm++){fo=fq[fm];if(fo.dir){if((fl+"/").indexOf(fo.fq_path+"/")===0){ah.error(eA("You cannot copy a folder into itself."));return}}}fp=fq.pluck("fq_path");ah.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fp,to_path:fl},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eA("Copying..."),onSuccess:function(fw){var fs,fv,i,ft,fu,fx,fr,j;fs=fw.responseText.evalJSON().changesets;fv=fp.length;fx=bU.em_snippet(aA.filename(fl),dD.NOTIFICATION_SNIPPET_LEN).escapeHTML();fr=bd("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fv);fr=fr.format({count:fv,location:fx});X.notifyWithUndo(new fg(fr),fs,dD.do_rollback);i=[];j=fw.responseText.evalJSON().new_browse_files;for(ft=0,fu=j.length;ft<fu;ft++){fo=j[ft];i.push(fo.fq_path)}ct.select_fq_paths=i;$("reload-link").observe("click",function(){return a4.set_path_url(null,fl)});b2.schedule_reset();return document.fire(aH.COPY,{files:fq,to_fq_path:fl})}})},bulk_move_error:function(i,fq){var fo,fl,fr,fm,fs,fn,j,T,fp;fr=ct.find_file(fq);fm=a6.profile_files(i);T=void 0;fn=void 0;fp=void 0;if(fr){fn=fr.dir;T=fr.fq_path;fp=fr.target_ns||fr.ns_id}else{if(ct.inside_dir&&ct.can_get_details_from_fq_path(fq)){fl=ct.details_from_fq_path(fq);fn=true;T=fl.fq_path;fp=fl.ns_id}else{fn=true;T=fq;fp=void 0}}fs=i.pluck("fq_path").collect(aA.normalize);if(-1!==fs.indexOf(aA.normalize(T))){return eA("You cannot copy a folder into itself.")}fo=j=function(ft){var fu;fu=aA.parent_dir(ft.fq_path);return fu===(T||"/")};if(i.all(fo)){return bd("That file already exists in that folder.","Those files already exist in that folder.",i.length)}if(!fn){return eA("You cannot put files inside one another.")}if(fm.target_namespaces>0&&fp&&fp!==Constants.root_ns&&fr){if(fm.sandboxes>0){if(fr.is_sandbox()){return eA("You're not allowed to put an application folder inside another application folder.")}else{if(fr.is_shared_folder()){return eA("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fm.shared_folders>0){if(fr.is_sandbox()){return eA("You're not allowed to put a shared folder inside an application folder.")}else{if(fr.allows_nesting&&fm.team_shared_folders===0){return}else{if(fr.is_shared_folder()){return eA("You're not allowed to put a shared folder inside another shared folder.")}}}}}return eA("You're not allowed to nest special folders.")}if(ct.public_folder_enabled){if(T==="/Public"&&fm.target_namespaces>0){return eA("You're not allowed to move shared folders to your Public folder.")}}if(fm.public_folder>0){return eA("You're not allowed to move your Public folder.")}if(fm.deleted>0){return eA("Moving deleted folders or files isn\u2019t allowed.")}},do_move:function(T,j){var i;T=T||fb.vars.fq_path;j=j||fb.vars.selected_path;i=ct.find_file(T);cL(i,"Trying to move a file we couldn't find.");return dD.do_bulk_move([i],j)},do_nonbrowse_move:function(fl,fm,j){var i,T;i=bF.Deferred();T="/cmd/move";new Ajax.DBRequest(T,{parameters:{files:fm,to_path:j},subject_user:fl,job:true,html_in_error_msg:true,progress_text:eA("Moving\u2026"),onSuccess:i.resolve,onFailure:i.reject});return i.promise()},do_bulk_move:function(fl,fn){var j,T,fm,i;ct.pre_action_selection=eW.get_selected_fq_paths();fl=fl||fb.vars.files;if(!fl){return}cL(fl.length>0,"Tried to move 0 files");i=fn||fb.vars.selected_path||"";i=aA.normalize(i);j=dD.bulk_move_error(fl,i);if(j){ah.error(j);return}T=fl.pluck("fq_path");ah.clear();fm=function(fr){var fq,fp,fo,fs;fq=fr.responseText.evalJSON().changesets;fp=T.length;fo=bU.em_snippet(aA.filename(i),dD.NOTIFICATION_SNIPPET_LEN).escapeHTML();fs=bd('Moved %(count)d item to \u2018<a id="reload-link">%(location)s</a>\u2019.','Moved %(count)d items to \u2018<a id="reload-link">%(location)s</a>\u2019.',fp);fs=fs.format({count:fp,location:fo});X.notifyWithUndo(new fg(fs),fq,dD.do_rollback);$("reload-link").observe("click",function(){return a4.set_path_url(null,i)});b2.schedule_reset();return document.fire(aH.MOVE,{files:fl,to_fq_path:i})};return dD.do_nonbrowse_move(ct.active_user.id,T,i).then(fm)},do_rollback:function(i){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(i)},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:function(j){var T;T=eA("Undo complete.");ah.success(T);cL(ct.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(ct.in_search_mode()){cb.select_fq_paths=ct.pre_action_selection;cb.force_reload()}else{ct.select_fq_paths=ct.pre_action_selection;ct.force_reload()}return ct.pre_action_selection=false}})},do_bulk_delete:function(i,fl){var j,T;ct.pre_action_selection=eW.get_selected_fq_paths();fl=fl||fb.vars.files;cL(fl.length>0,"Tried to delete 0 files");T=(function(){var fn,fm,fo;fo=[];for(fn=0,fm=fl.length;fn<fm;fn++){j=fl[fn];fo.push(j.fq_path)}return fo})();ah.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:T},subject_user:i,job:true,html_in_error_msg:true,progress_text:eA("Deleting..."),onSuccess:function(fm){var fo,fn;fn=fm.responseText.evalJSON();fo=bd("Deleted %d item.","Deleted %d items.",T.length).format(T.length);X.notifyWithUndo(fo,fn.changesets,dD.do_rollback);b2.schedule_reset();return document.fire(aH.DELETE,{files:fl})}})},do_delete:function(i,T){var j;j=ct.find_file(T||fb.vars.fq_path);cL(j,"Trying to delete a file we couldn't find.");return dD.do_bulk_delete(i,[j])},do_nonbrowse_delete:function(j,fl){var i,T;i=bF.Deferred();T=bd("Deleted %(file_count)s item","Deleted %(file_count)s items",fl.length);T=T.format({file_count:fl.length});ah.success(T);new Ajax.DBRequest("/cmd/delete",{parameters:{files:fl},subject_user:j,html_in_error_msg:true,onSuccess:function(fm){document.fire(aH.DELETE,{fq_paths:fl});return i.resolve(fm)},onFailure:function(fm){ah.error(eA("Failed to perform the delete. Please try again later."));return i.reject(fm)}});return i.promise()},do_nonbrowse_rename:function(T,fl,j){var i;i=bF.Deferred();new Ajax.DBRequest("/cmd/rename"+encodeURIComponent(fl),{parameters:{to_path:j},subject_user:T,html_in_error_msg:true,onSuccess:function(fm){return i.resolve(fm)},onFailure:function(fm){return i.reject(fm)}});return i.promise()},do_purge:function(i){cL(i,"Trying to purge a file we couldn't find.");return dD.do_bulk_purge([i])},do_bulk_purge:function(j){var i,T;cL(j.length>0,"Tried to purge 0 files");i=j.collect(function(fl){return fl.fq_path});T=bd("Permanently deleted %d item","Permanently deleted %d items",i.length).format(i.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:i},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eA("Deleting..."),onSuccess:function(fl){ah.success(T);b2.schedule_reset();return document.fire(aH.PURGE,{files:j})}})},do_bulk_restore:function(T){var j,fl,i;T=T||fb.vars.files;i=fb.vars.user;cL(T.length>0,"Tried to restore 0 files");j=T.collect(function(fm){return fm.fq_path});fl=bd("Restored %d item","Restored %d items",j.length,{comment:"meaning, successfully restored x files and folders"}).format(j.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:j},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:function(fm){ah.success(fl);b2.schedule_reset();return document.fire(aH.RESTORE,{files:T})}})},do_folder_restore:function(j,i){var T;T=function(fl){var fn,fm;fn=eA("Restoring '%(folder_name)s'").format({folder_name:aA.filename(j)});fm=fl.responseText;if(fm.startsWith("err:")){fm=fm.substring(4);bF("#async-result").html(fm);ah.error(new fg(fm),60)}else{fn=eA("Restored '%(folder_name)s'").format({folder_name:aA.filename(j)});bF("#status-of-files").text(eA("Restored files"));ah.success(fn,60)}bF("#restore-done-heading").text(fn);bF(".pre-restore").hide();return bF(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[j]},job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:T,onFailure:T,subject_user:i})},do_bulk_download:function(fm){var fn,fl,T,i;fn=new Element("form",{action:G({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(a9.UID_PARAM_NAME,ct.active_user.id).toString(),method:"post"});for(T=0,i=fm.length;T<i;T++){fl=fm[T];bT.add_vars(fn,{files:fl.fq_path})}bT.add_vars(fn,{parent_path:ct.block_hash_param||"/",w:ct.block_hash});$(document.body).__sert(fn);return fn.submit()},do_bulk_photo_view:function(T,i){var fn,fm,j,fl;if(i==="carousel"||i==="carousel_as_dropbox_photos"){fl={};fl[a9.UID_PARAM_NAME]=cM.get_viewer().personal_user.id;fn=String(G({scheme:"https",authority:fj.WEBSERVER,path:"/app/view_in_timeline",query:fl}))}else{fn=String(G({scheme:"https",authority:fj.WEBSERVER,path:"/photos"}))}fm=new Element("form",{action:fn,method:"post"});bT.add_vars(fm,{t:bw.read(aK.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fp,fo,fq;fq=[];for(fp=0,fo=T.length;fp<fo;fp++){j=T[fp];fq.push(j.ns_id)}return fq})()),ns_paths:JSON.stringify((function(){var fp,fo,fq;fq=[];for(fp=0,fo=T.length;fp<fo;fp++){j=T[fp];fq.push(j.ns_path)}return fq})())});$(document.body).__sert(fm);return fm.submit()},build_revisions_uri:function(T,i,j){if(j==null){j={}}j[a9.UID_PARAM_NAME]=String(i);if(az.getGandalfRule("revision-history-web")){return G({path:"/history"+T}).updateQuery(j)}else{return G({path:"/revisions"+T}).updateQuery(j)}}};var bT,dk={}.hasOwnProperty;bT=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=E.Forms={submitOnlyOnce:function(){var i;i=bT.submitted!==true;bT.submitted=true;return i},disable:function(i){if(i){return setTimeout((function(){return i.disabled=true}),0)}},enable:function(i){if(i){return setTimeout((function(){return i.disabled=false}),0)}},show_button_on_change:function(i,fl){var T,fm,fn,j;T=bF(i);T.hide();if(fl==null){fl=T.closest("form")}fm=fl[0];if(this.next_id==null){this.next_id=0}fn=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[fn]=this.collect_form_vars(fm);T.attr("data-id",fn);fl.data("button-id",fn);j=(function(fo){return function(){var fr,fp,fq;T.hide();fp=fo.collect_form_vars(fm);if(Object.keys(fp).length!==Object.keys(fo.initial_vars[fn]).length){T.show()}fq=[];for(fr in fp){if(fp[fr]!==fo.initial_vars[fn][fr]){fq.push(T.show())}else{fq.push(void 0)}}return fq}})(this);fl.change(j);fl.find("input").filter(":text").on("input",j);return fl.find("textarea").on("input",j)},add_vars:function(T,fl){var fm,i,j;T=$(T);j=[];for(i in fl){if(!dk.call(fl,i)){continue}fm=new Element("input",{type:"hidden",name:i});fm.setValue(fl[i]);j.push(T.__sert(fm))}return j},collect_form_vars:function(fo,fn){var fq,fm,fl,j,T,fp;if(fn==null){fn=false}fo=fo||$(document.body);fm=fo.select("input").concat(fo.select("textarea")).concat(fo.select("select"));T={};for(fl=0,j=fm.length;fl<j;fl++){fq=fm[fl];if(fq.name&&fq.name!=="t"){fp=fq.getValue();if(fp||fn){if(typeof fp!=="string"){fp=fp.join(",")}if(T[fq.name]!=null){if(typeof T[fq.name]==="string"){T[fq.name]=[T[fq.name],fp]}else{T[fq.name].push(fp)}}else{T[fq.name]=fp}}}}return T},add_loading:function(T,i){var j;if(T){T=$(T);j=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});j.addClassName("text-img ajax_submit_loading");if(i==="after"){return bF(T).after(j)}else{return bF(T).before(j)}}},remove_loading:function(i){return bF(".ajax_submit_loading").remove()},ui_form_submit:function(j,i){i=i||j.action;if(j.ajax_submitted){return false}j.ajax_submitted=true;return new by(bF(j),i,{data:bT.collect_form_vars(j),success:(function(T){return function(fo,fl,fp){var fn,fm;fm=bF(j).data("button-id");if(fm!=null){fn=bF(j).find("*[type='submit'][data-id='"+fm+"']");T.initial_vars[fm]=T.collect_form_vars(j);return fn.hide()}}})(this),complete:(function(T){return function(fm,fl){return j.ajax_submitted=false}})(this)})},ajax_submit_obj:function(ft){var fq,fs,T,fl,j,fm,fo,fp,fn,fr,i;fl=ft.form,i=ft.url,fr=ft.success_callback,T=ft.fail_callback,fq=ft.button,fo=ft.more_vars,fp=ft.position,fm=ft.job,j=ft.html_response,fs=ft.complete_callback,fn=ft.progress_text;return bT.ajax_submit(fl,i,fr,T,fq,fo,fp,fm,j,fs,fn)},ajax_submit:function(fm,T,fw,fl,ft,fr,fu,fn,j,fy,fp){var fx,fs,fv,fq,fo;if(j==null){j=false}if(fm.ajax_submitted){return false}fm.ajax_submitted=true;fo=bF(fm).find(".suggestion-input");for(fs=0,fv=fo.length;fs<fv;fs++){fx=fo[fs];c5.blank(fx.identify())()}if(ft){bT.add_loading(ft,fu)}fq=bT.collect_form_vars(fm);if(fr){Object.extend(fq,fr)}new Ajax.DBRequest(T||fm.action,{noAutonotify:true,parameters:fq,job:fn,progress_text:fp,evalJSON:false,onSuccess:function(i){bT.remove_loading();if(fw&&typeof fw==="function"){return fw(i)}},onFailure:function(fA){var i,fz;if(fA){if(fA.responseText.indexOf("err:")===0){i=fA.responseText.substr(4);if(i.indexOf("{")===0){fz=i.evalJSON(true);bT.fill_errors(fm,fz)}else{if(j){i=new fg(i)}ah.error(i)}}else{ah.error()}bT.remove_loading();if(fl&&typeof fl==="function"){return fl(fA)}}},onComplete:function(fB){var fA,fz,i;i=fm.select(".suggestion-input");for(fA=0,fz=i.length;fA<fz;fA++){fx=i[fA];c5.blur_elm(fx)}fm.ajax_submitted=false;if(fy&&typeof fy==="function"){return fy(fB)}}});return false},clear_errors:function(i){i=i||$(document.body);this.hide_errors(i);return i.select(".error-removable").invoke("remove")},fill_errors:function(fn,fm){var T,fp,j,fl,fo,i;fm=fm||{};fn=fn||$(document.body);bT.clear_errors(fn);for(fo in fm){if(!dk.call(fm,fo)){continue}fp=fn.down("[data-error-field-name='"+fo+"']")||fn.down("[name='"+fo+"']");if(fp){T=new Element("br",{"class":"error-removable"});j=new Element("span",{"class":"error-message error-removable"});fl=fm[fo];cL(fl.message_html||fl.message_text,"Error message must have a message_html or message_text property");if(fl.message_html){j.update(fl.message_html)}else{j.__date(fl.message_text)}bF(fp).before(j);bF(fp).before(T);i=bF(fn).find("input[name='"+fo+"'], textarea[name='"+fo+"']");if(i){i.addClass("input-error")}}}return this.show_errors(fn)},value:function(fm){var fn,fl,T,j,fo;T=$$('input[name="'+fm+'"]');fo=null;for(fn=0,j=T.length;fn<j;fn++){fl=T[fn];fo=$(fl).getValue()||fo}return fo},postRequest:function(T,fl,i){var j;if(fl==null){fl={}}if(i==null){i={}}cL(T!=null,"postRequest missing action");fl.t=bw.read(aK.JS_CSRF_COOKIE);j=new Element("form",{action:T,method:"POST"});if(i.target){j.target=i.target}document.body.appendChild(j);bT.add_vars(j,fl);return j.submit()},hide_errors:function(fm){var fo,fl,j,T,fn;fo=this.get_errors(fm);T=[];for(fl=0,j=fo.length;fl<j;fl++){fn=fo[fl];if(fn.down("span.error-message")){T.push(fn.hide())}else{T.push(void 0)}}return T},show_errors:function(fl){var fn,T,j,fm;fn=this.get_errors(fl);for(T=0,j=fn.length;T<j;T++){fm=fn[T];if(fm.down("span.error-message")){fm.show()}}return bF(".sick-input").find("label").css("top","")},get_errors:function(j){var T,i;i=".error-bubble, .error-plain-text";T=j?j.select(i):$$(i);return T}};bF(function(){return bT.show_errors()});var V;V=E.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(fn,fo){var fl,j,fm,T;if(fo==null){fo=document.body}fm=$(fo).getElementsByClassName("act_as_block");T=[];for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];T.push(this.resize(fn))}return T},resize:function(fm){var i,T,fl,j;fm=$(fm);T=fm.up();i=d6.sumStyles(fm,this.elm_list);fl=d6.sumStyles(T,this.parent_list);fm.style.width="1px";j=T.getWidth()-i-fl;if(j>0){return fm.style.width=j+"px"}}};var bf;bf=E.BrowseStyleRows={register_all:function(){var T,j,fl,fm;fl=$$(".bs-row");for(T=0,j=fl.length;T<j;T++){fm=fl[T];this.register(fm)}Event.observe(document,"click",this.kill_current.bind(this));return bF(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(j){var i;j=$(j);j.db_observe("mouseover",this.mouseover.bind(this));j.db_observe("mouseout",this.mouseout.bind(this));i=j.down(".action-button");if(i){return i.db_observe("click",this.click.bind(this))}},mouseover:function(j,i){if(!i.hasClassName("no-hover")){return i.addClassName("hover")}},mouseout:function(j,i){return i.removeClassName("hover")},click:function(fl,j){var i,fm,T;if(fl.target.tagName==="A"){return}fm=j.up(".bs-row");Event.stop(fl);if(fm.hasClassName("selected")){this.kill_current(false);return}bF(document).trigger("dropdown-opened");this.kill_current(false);T=$(fl.target);if(!T.match(".bs-actions-list *")){fm.addClassName("selected")}i=(T.hasClassName("bs-row")?T:T.up(".bs-row"));return i.style.zIndex=9},kill_current:function(fn){var fo,fl,j,fm,T;fm=$$(".bs-row.selected");T=[];for(fl=0,j=fm.length;fl<j;fl++){fo=fm[fl];fo.removeClassName("selected");T.push(fo.style.zIndex="")}return T}};var em;em=E.Bubble={make:function(fv,fG,fy,ft,fp){var fm,fw,fD,fl,T,fF,fA,fu,fs,fn,fr,fx,fC,fq,i,fo,j,fE,fB,fz;if(fG==null){fG="left"}fp=fp!=null?fp:{};if(["left","right"].contains(fG)){fy=fy||"middle";cL(["top","middle","bottom"].contains(fy),"expected tail position ['top', 'middle', 'bottom'], got "+fy)}else{if(["bottom","top"].contains(fG)){fy=fy||"center";cL(["left","center","right"].contains(fy),"expected tail position ['left', 'center', 'right'], got "+fy)}else{if(!["none"].contains(fG)){cL(false,"unexpected tail side, got "+fG)}}}fx=new Element("table");if(fp.style==="titled"){fx.addClassName("bluebubble");fC="bluebubble"}else{fx.addClassName("bubble");fC="bubble"}if(ft){fx.style.width=ft+"px"}i=new Element("tbody");fE=new Element("tr");fo=new Element("td");fo.addClassName("tl");fr=new Element("td");fr.addClassName("t");if(fp.style==="titled"){if(ft){fr.style.width=(ft-42)+"px"}}j=new Element("td");j.addClassName("tr");if(fG==="top"){fq=new Element("img",{src:"/static/images/"+fC+"_arrow_top.png"});fq.addClassName("tarrow");if(fp.style==="titled"){fq.addClassName("arrow-"+fy);fw=new Element("div");fw.addClassName("arrow-container");if(ft){fw.style.width=(ft-42)+"px"}fw.__sert(fq);fr.__sert(fw)}else{fr.style.textAlign=fy;fr.__sert(fq)}}fE.__sert(fo);fE.__sert(fr);fE.__sert(j);i.__sert(fE);fB=new Element("tr");fu=new Element("td");fu.addClassName("l");if(fG==="left"){if(fp.style==="titled"){fm=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fm=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fm.addClassName("arrow");fu.__sert(fm);fu.vAlign=fy}fA=new Element("td");fA.addClassName("c");fA.update(fv);fs=new Element("td");fs.addClassName("r");if(fG==="right"){fn=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});fn.addClassName("rarrow");fs.__sert(fn);fs.vAlign=fy}fB.__sert(fu);fB.__sert(fA);fB.__sert(fs);i.__sert(fB);fz=new Element("tr");T=new Element("td");T.addClassName("bl");fD=new Element("td");fD.addClassName("b");if(fG==="bottom"){fl=new Element("img",{src:"/static/images/"+fC+"_arrow_bottom.png"});fl.addClassName("barrow");if(fp.style==="titled"){fl.addClassName("arrow-"+fy);fw=new Element("div");fw.addClassName("arrow-container");if(ft){fw.style.width=(ft-42)+"px"}fw.__sert(fl);fD.__sert(fw)}else{fD.style.textAlign=fy;fD.__sert(fl)}}fF=new Element("td");fF.addClassName("br");fz.__sert(T);fz.__sert(fD);fz.__sert(fF);i.__sert(fz);fx.__sert(i);return fx}};var eT;eT=INLINE_JS.FreshDropdown=E.FreshDropdown={show:function(fo,fl,T,j){var fn,fm,fp,i;if(j==null){j=false}bF(document).trigger("dropdownOpened",[1]);fn=bF(fl);if(!T){T=fn[0].offsetHeight+10}this.hide_all();fm=bF(fo).show();i=fm[0].offsetWidth;fp=fn[0].offsetWidth;fm.clonePosition(fn,{setHeight:false,setWidth:false,offsetLeft:-1*(i-fp)+22,offsetTop:T});if(j){fm.width(i)}fn.addClass("pressed");return((function(fq){return function(){return document.observe("click",eT.hide_all)}})(this)).defer()},hide_all:function(T){var j,i;i=bF(".freshdropdown-menu");j=0;i.each(function(){if(bF(this).is(":visible")){return j+=1}});i.hide();bF(document).trigger("dropdownClosed",[j]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eT.hide_all)}};var ac;ac=E.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&ac.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=G.parse(window.location.href).fragment}},report:function(){clearInterval(ac.interval);return cL(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var dO;dO=E.LoginDropdown={init:function(){var i;i=bF("#login-hover-link");if(!(i.length>0)){return}this.login_link=i;return this.register()},register:function(i){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(i){return this.clicking=true},click:function(i){i.preventDefault();if(this.clicking&&i.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bF(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bF("input[name='login_email']").focus()},unclick:function(j){var i;if(j){i=bF(j.target);if(i[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bF(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var fb;fb=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=E.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fu,fq,fr,fw,T,fs,fo,fp,fv){var j,fm,ft,i,fl,fn;if(fr==null){fr=false}if(fw==null){fw=false}if(T==null){T=false}if(fs==null){fs=false}if(fo==null){fo=""}if(fp==null){fp=true}if(fv==null){fv=false}if(fb.shown()){fb._cleanup()}T=T||this.width;fm="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fm).invoke("hide");if(aq.uploading&&!fs){ca(eA("You can't do this while uploading."));return false}cL(fq,"Missing modal content!");fl=this.vars._prev_scope;this.vars=fr||{};this.vars._prev_scope=fl;$("modal").setStyle({width:T+"px",margin:"0 0 0 "+(Math.floor(-T/2).toString())+"px"});this.vars.extra_class="";if(fo){$("modal").addClassName(fo);this.vars.extra_class=fo}if(!fs){if(aq.num_files()){cC.reset();aq.clear()}i=d6.childElement($("modal-content"),0);if(i&&i!==fq){$("grave-yard").__sert(i)}j=new Element("div");j.update(fq);$("modal-content").__sert(j);if(fq.show){fq.show()}Element.show("modal")}bF("#modal-overlay").off("click");if(fp){bF("#modal-overlay").on("click",function(fx){fb.hide(null,false,true);fx.preventDefault();return fx.stopPropagation()})}else{bF("#modal-overlay").on("click",function(fx){fx.preventDefault();return fx.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:(T+20)+"px",margin:"0 0 0 "+(Math.floor(-T/2-10).toString())+"px"});bF("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fw){$("modal-content").select("#"+fw.id).first().focus()}else{if(!d6.ie){ft=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(ft){ft.focus()}}}if(!this.track_id){this.track_resizes()}if(fu){if(d6.isElm(fu)){bF("#modal-title").html(fu)}else{bF("#modal-title").text(fu)}bF("#modal-title").show();fn=bF("#modal-title").text();eI("Modal.show:",fn)}else{bF("#modal-title").hide();eI("Modal.show")}V.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fv;bF("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;C.scroll_lock_document()}bF(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var T,i,j,fm,fl;T=bF("#modal");i=T.height();fl=T.width();j=C.viewport_dimensions();fm=C.viewport_offset(T);return fm.left>0&&fm.top>0&&fm.left+fl<j.width&&fm.top+i<j.height},fix_position:function(T){var j,i;i=document.viewport.getScrollOffsets().top+this.vertical_offset;j=parseInt($("modal").getStyle("height"),10);if(j+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(j+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:i+"px"});return $("modal-behind").setStyle({position:"absolute",height:(j+20)+"px",top:(i-10)+"px"})}},keydown:function(fl){var fm,i,T,j;T=fl.keyCode||fl.which||fl.charCode;if(T===27||(T===8&&!C.focus_in_input())){fl.preventDefault();this.hide(null,false,true)}if(T===9&&!C.focus_in_input()){i=$("modal").down("input[type=text], input[type=email]");j=$("modal").down(".modal-tabs");fm=j;while(fm&&fm.next()){fm=fm.next();if(fm.visible()){i=fm.down("input[type=text], input[type=email]");break}}if(i){fl.preventDefault();return i.focus()}}},shown:function(){return $("modal").visible()},hide:function(T,i,j){if(T){Event.stop(T)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(j);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!i&&!aq.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(aq.uploading){c1.show()}}fb._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return eI("Modal.hide")},_cleanup:function(){bF(document).trigger("modalClosed",[1]);if(this.scroll_locked){return C.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&bx.some(bF("#modal form"),function(i){return i.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var i;i=$("modal").getHeight();if(this.old_height!==i||$("modal-behind").getHeight()<i){this.old_height=i;return this.fix_position()}},vars:{}};var cj;cj=E.SickInput={init:function(){var fn,fl,j,fm,T;fm=$$(".sick-input");T=[];for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];if(!fn.hasClassName("sickified")){T.push(this._create(fn))}}return T},_create:function(fl){var j,T,i;if(fl==null){return}T=fl.identify();i=fl.down("input")||fl.down("textarea")||fl.down("select");i.observe("focus",function(){return fl.addClassName("focused")});i.observe("blur",function(){return fl.removeClassName("focused")});j=function(){if(fl.hasClassName("populated")&&i.getValue()===""){fl.removeClassName("populated")}else{if(!fl.hasClassName("populated")&&i.getValue()!==""){fl.addClassName("populated")}}if(T in cj._handler_map){return cj._handler_map[T]()}};bT.show_errors();j();return setInterval(j,100)},_handler_map:{},add_interval_handler:function(j,i){var T;T=j.identify();return this._handler_map[T]=i},remove_interval_handler:function(j,i){var T;T=j.identify();if(this._handler_map[T]===i){return delete this._handler_map[T]}}};var c5;c5=E.SuggestionInput={register:function(j){var i;j=$(j);i=j.up("form");if(c5.defaulted(j)||j.getValue()===""){j.setValue(j.title)}else{j.addClassName("suggestion-input-unfaded")}j.observe("blur",this.blur.bind(this));j.observe("focus",this.focus.bind(this));j.observe("db:value_change",this.focus.bind(this));if(i){if(!j.id){j.id="r_elm_id_"+(Math.random().toString())}return i.observe("submit",c5.blank(j.id).bind(this))}},register_all:function(){var fm,T,j,fn,fl;fn=$$(".suggestion-input");fl=[];for(fm=0,j=fn.length;fm<j;fm++){T=fn[fm];fl.push(this.register(T))}return fl},blank:function(i){return(function(j){return function(){var T;T=$(i);if(!T){return}if(j.defaulted(T)){return T.setValue("")}}})(this)},defaulted:function(i){i=$(i);return i.getValue()===i.title},do_blank:function(i){return this.blank(i)()},clear:function(i){var j;j={target:i};return this.focus(j)},focus:function(i){var j;j=$(i.target);if(!j){return}if(this.defaulted(j)){j.addClassName("suggestion-input-unfaded");return j.setValue("")}},blur_elm:function(i){if(i.getValue()===""){i.removeClassName("suggestion-input-unfaded");i.setValue(i.title)}return i.blur()},blur:function(i){var j;j=$(i.target);if(!j){return}return this.blur_elm(j)},reset:function(j){var i;i=$(j);if(!i){return}i.removeClassName("suggestion-input-unfaded");i.setValue(i.title);i.defaulted=true;return i.blur()},setValue:function(i,j){var T;T=$(i);if(!T){return}T.addClassName("suggestion-input-unfaded");T.setValue(j);return T.defaulted=false}};var bo;bo=E.TitleBubble=(function(){var T,j,fo,fl,fm,i,fn;fn=0;T=0;i=function(fp){return fn=fp};fm=function(fv){var fA,fy,fs,fw,fr,fp,fx,fu,fq,ft,fz;fw=bF(fv.currentTarget);fz=fw.attr("title");if(fz!=null?fz.length:void 0){fw.attr("data-title",fz);fw.removeAttr("title")}fs=parseInt(fw.data("title-delay"));fy="title-bubble-"+(T++);fw.data("bubble-id",fy);fA=bF("<div/>",{id:fy,"class":"title_bubble_container"});if(!fs){fA.css({opacity:0});fA.addClass("has-transition")}if(fw.hasClass("white")){fA.addClass("white")}if(fw.hasClass("black")){fA.addClass("black")}fA.text(fw.attr("data-title"));fx=fw.attr("data-title-html");fA.html(fx);fq=fw.attr("data-title-hide-tail")!=="yes";if(fq){ft=bF("<div/>",{"class":"tail"});fA.append(ft)}bF(document.body).append(fA);fp=fo(fw[0],fA[0]);fr=j(fp,fA[0],fw[0]);fA.clonePosition(fw,{setWidth:false,setHeight:false,offsetTop:fr.top-fn,offsetLeft:fr.left});fA.addClass("position-"+fp);if(fq){ft.clonePosition(fw,{setWidth:false,setHeight:false,setTop:false,offsetLeft:fr.left+fr.tail_offset_left+(bF(fA).outerWidth()/2)})}fu=function(){var fB;if(!((fA.data("pending-delay"))&&(fw.data("bubble-id")===fy))){return}fB=(parseInt(fw.data("title-fade-time")))||400;return fA.fadeIn(fB)};if(fs){fA.hide();fA.data("pending-delay",true);return setTimeout(fu,fs)}else{return fA.css({opacity:""})}};fo=function(ft,fp){var fs,fr,fq;ft=$(ft);fq=ft.getAttribute("data-title-position");fs=document.viewport.getDimensions();fr=ft.viewportOffset();if(!(fq==="above"||fq==="below"||fq==="right"||fq==="left")){fq="above"}if(fq==="left"){if(fr.left<fp.width){return"right"}}else{if(fq==="right"){if(fs.width-(fr.left+ft.getWidth())<fp.width){return"left"}}else{if(fq==="below"){if(fs.height-(fr.top+ft.getHeight())<fp.height){return"above"}}else{if(fq==="above"){if(fr.top<fp.height){return"below"}}}}}return fq};j=function(fr,fy,fu){var fw,fs,fz,fv,fx,ft,fp,fB,fA,fq;fy=$(fy);fu=$(fu);fz=document.viewport.getDimensions();fw=fy.getDimensions();fv=fu.viewportOffset();fs=6;fx=0;ft=0;fA=0;fq=0;if(fr==="below"||fr==="above"){if(fr==="below"){ft=fu.getHeight()+fs}else{ft=(-1*fw.height)-fs}fp=fu.getWidth()/2-fw.width/2;if(fv.left+fp+fw.width>fz.width){fx=fz.width-fv.left-fw.width;fA=fp-fx-5}else{fx=fp;fA=-5}}if(fr==="left"||fr==="right"){if(fr==="right"){fx=fu.getWidth()+fs}else{fx=(-1*fw.width)-fs}fB=fu.getHeight()/2-fw.height/2;if(fv.top+fB+fw.height>fz.height){ft=fz.height-fv.top-fw.height;fq=fB-ft-5}else{ft=fB;fq=-5}}return{left:fx,top:ft,tail_offset_left:fA,tail_offset_top:fq}};fl=function(fq){var fp,fr,fs;fs=bF(fq!=null?fq.currentTarget:void 0);fp=bF("#"+fs.data("bubble-id"));if(fp.data("pending-delay")){fp.removeData("pending-delay");fr=(parseInt(fs.data("title-fade-time")))||400;return fp.fadeOut(fr,function(){return fp.remove()})}else{return fp.remove()}};return{init:function(){bF(document).on("mouseenter",".title_bubble",fm);bF(document).on("mouseleave",".title_bubble",fl).on("mouseup",".title_bubble",fl);bF(document).on("mouseenter",".title_bubble_sticky",fm);return bF(document).on("mouseleave",".title_bubble_sticky",fl)},set_vertical_space:i,hide_all:function(){return bF(".title_bubble_container").remove()}}})();var ei;ei=INLINE_JS.Tooltip=E.Tooltip={attach:function(fn,T,i,j){var fm,fl;if(j==null){j={}}fn=$(fn);i=(i?$(i):null);fm=em.make(T,fn.tail_position,j.tail_position,j.width,j);fm.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fm);if(fn.match("#modal-content *")||fn.match(".db-modal-content *")){fm.style.zIndex="13001"}else{fm.style.zIndex=""}if(fn.tail_position==="right"){fl=(d6.ie?32:12);fm.style.marginLeft=-(fm.getWidth()+fn.getWidth()+fl)+"px"}fn.tooltip=fm;fn.out_target=(i?true:false);fn.observe("mouseout",this.mouseout("target",fn));fn.observe("mouseover",this.mouseover("target",fn));fn.out_trigger=(i?false:true);if(i){i.observe("mouseout",this.mouseout("trigger",fn));i.observe("mouseover",this.mouseover("trigger",fn))}fn.out_tooltip=true;fm.observe("mouseout",this.mouseout("tooltip",fn));return fm.observe("mouseover",this.mouseover("tooltip",fn))},update:function(j,i){if(j.tooltip){return $(j.tooltip).update(i)}},mouseover:function(i,j){return function(){return j["out_"+i]=false}},mouseout:function(i,j){return function(){j["out_"+i]=true;return ei.hide_if_out.defer(j)}},show_by:function(j){var T,i;T=bF(j.tooltip);j=bF(j);T.show();i=Math.floor(T[0].offsetHeight/2);return T.clonePosition(j,{setWidth:false,setHeight:false,offsetTop:Math.floor(j[0].offsetHeight/2)-i,offsetLeft:j[0].offsetWidth+1})},hide_if_out:function(i){var j;if(!i.out_target||!i.out_trigger||!i.out_tooltip){return}j=$(i.tooltip);return j.hide()},show:function(fm,fl,j,i,T){if(i==null){i="left"}fm=$(fm);if(!fm.tail_position){fm.tail_position=i}j=(j?$(j):null);if(!fm.tooltip){this.attach(fm,fl,j,T)}return this.show_by(fm)}};var b2;b2=INLINE_JS.TreeView=E.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(i){return this.ajax_params=i},init:function(T,i,fl){var j;if(fl==null){fl="treeview"}this.tv[fl]={};j=this.tv[fl];j.autohide=(i===null?true:i);j.handler=T;j.viewdiv=$(fl);j.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bE.ADD,(function(fm){return function(fn){return fm.schedule_reset()}})(this));document.observe(bE.REMOVE,(function(fm){return function(fn){return fm.schedule_reset()}})(this));return document.observe(bE.MOVE,(function(fm){return function(fn){return fm.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(fn){var T,fo,fl,j,fp,i,fm;T={url:"/ajax_subtreeview",type:"post",data:bF.extend({},this.ajax_params),success:(function(fq){return function(fr){var fs,ft;fs=[];for(ft in fq.tv){if(fq.tv.hasOwnProperty(ft)){fq.tv[ft].viewdiv.down(".treeview-folders").update(fr);if(fn&&fn.onSuccess){fs.push(fn.onSuccess(fr))}else{fs.push(void 0)}}else{fs.push(void 0)}}return fs}})(this)};if(fn!=null?fn.user:void 0){if(fn.user.id!==((fo=this.user)!=null?fo.id:void 0)){fp=bF("<p />",{id:"treeview-loading"});i=bF("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fp.append(i);fm=" "+eA("Loading your folders");fp.append(fm);bF("#dest-treeview .treeview-folders").html(fp);this.user=fn.user}T.subject_user=fn.user;j=cM.get_role_title(fn.user);if(cM.get_viewer().is_paired){if(fn.user.is_team){fl="s_briefcase"}else{fl="s_house"}}else{fl="dropbox"}if(!j){j=eA("Dropbox")}bF("#first-treeview-link span").text(j);cx.replace(bF("#root-img")[0],"web",this.role_icon,fl);this.role_icon=fl}else{bF("#first-treeview-link span").text(eA("Dropbox"))}return bF.ajax(T)},toggle:function(T,j){var i;Event.stop(T);i=this.tv[j||"treeview"];if(i.shown){i.shown=false;this.hide(T,j)}else{i.shown=true;this.show(T.target,j)}return false},hide:function(T,j){var i;i=this.tv[j||"treeview"];if(!T||!$(T.target).descendantOf(i.viewdiv)){i.viewdiv.hide();Event.stopObserving(window,"click",i.hidefunc);return i.shown=false}},show:function(T,j){var fl,i;i=this.tv[j||"treeview"];T=$(T);T.blur();fl=T.cumulativeOffset();i.viewdiv.setStyle({top:(fl.top+T.getHeight())+"px",left:(fl.left-4)+"px"});i.viewdiv.show();return Event.observe(window,"click",i.hidefunc)},toggleNode:function(j){var i;j=$(j);i=j.down("img");if(i.className.match("bullet_plus")){cx.replace(i,"web","bullet_plus","bullet_minus")}else{cx.replace(i,"web","bullet_minus","bullet_plus")}j.up().next("div").toggle();j.blur();return false},toggleNodeAjax:function(fl,i,j){var T,fm;if(fl.fetched_children){return this.toggleNode(fl)}fl=$(fl);T=fl.down("img");fm=cx._get(T);T.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bF.ajax({url:"/ajax_subtreeview"+i,type:"post",data:bF.extend({},this.ajax_params),subject_user:j,success:(function(fn){return function(fo){var fp;fp=new Element("div",{style:"display: none;"}).update(fo);fl.up().__sert({after:fp});fl.fetched_children=true;cx._set(T,fm);return fn.toggleNode(fl)}})(this),complete:function(){if(/loading/.match(T.src)){return cx._set(T,fm)}}});return false},handle:function(T,j){var fl,i;fl=$H(this.tv).keys();i=$(j).ancestors().find(function(fm){return fl.include(fm.id)});if(!i){return}i=this.tv[i.id];bF(document).trigger("db:treeview_selected",[T]);if(i.handler){i.handler(T,j)}if(i.autohide){this.hide(i.id)}return false},move:function(T,fl,j){var i;i=$(T);if(!this.loaded){this.reset({onSuccess:(function(fm){return function(){fm.loaded=1;return fm.move(T,fl,j)}})(this),user:j!=null?j.user:void 0})}else{if(j&&j.onSuccess){j.onSuccess()}}cL(i,"Couldn't find tree_id");cL($(fl),"Couldn't find location_id");$(fl).appendChild(i);return i.show()}};var aS;aS=E.ULSelectMenu=(function(){var fl,fp,T,fq,fr,fm,fo,i,fn,j,fs;fl=function(ft){return ft.removeClassName("shown")};fs=function(ft){return ft.toggleClassName("shown")};fo=function(){return this.removeClassName("hover")};fm=function(){return this.addClassName("hover")};i=function(fy,fx){var fw,fu,fv,ft;fv=[];for(fw=0,fu=fx.length;fw<fu;fw++){ft=fx[fw];fv.push(fy.insert(ft))}return fv};fq=function(fv,ft,fu){i(fv,fu);if(fv.firstChild!==ft){return fv.__sert({top:ft})}};fn=function(fu,fv){var ft;ft="selected";bF(fu).find("."+ft).removeClass(ft);return bF(fv).addClass(ft)};j=function(fw,fy){var fz,fv,ft,fx,fu;fx=fw.select("li");fu=[];for(fv=0,ft=fx.length;fv<ft;fv++){fz=fx[fv];if(fz.getAttribute("data-value")===fy){fu.push(fn(fw,fz))}else{fu.push(void 0)}}return fu};fr=function(ft,fv,fu){return function(fw){if(!ft.hasClassName("selected")){fn(fv,ft);fv.fire("db:change",ft.getAttribute("data-value"));return fl(fv)}else{fq(fv,ft,fu);return fs(fv)}}};fp=function(fv){var fz,fx,fy,fB,fw,fu,fA,ft;fB=fv.select("li");cL(fB.length,"Empty list of options "+fv.identify());fw=void 0;if(fB.length===1){fv.addClassName("one")}else{for(fx=0,fy=fB.length;fx<fy;fx++){fz=fB[fx];fA=fz.getAttribute("data-value");cL(fA,fz.identify()+" missing data value");fz.observe("click",fr(fz,fv,fB));fz.observe("mouseenter",fm);fz.observe("mouseleave",fo);if(fz.hasClassName("selected")){fw=fz}}$(document.body).observe("click",function(fC){if($(fC.target).up(".ul_select_menu")===fv){return}return fl(fv)})}if(!fw){fw=fB[0]}fw.addClassName("selected");ft=new Element("span");fu=fw.getDimensions();ft.setStyle({width:fu.width+"px",height:fu.height+"px",position:"relative",display:"inline-block"});return fv.wrap(ft)};T=function(){var fx,fv,ft,fw,fu;fw=$$(".ul_select_menu");fu=[];for(fv=0,ft=fw.length;fv<ft;fv++){fx=fw[fv];fu.push(fp(fx))}return fu};bF(T);return{init:function(ft){return fp(ft)},set_selected_by_value:j}})();var I;I=E.DBCalendar=Class.create({initialize:function(j,i){this.options=i||{};this.container=$(j);cL(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=d6.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=d6.start_of_day(this.options.first_day||this.today)}this.view_date=d6.start_of_day(this.options.selected_date||this.today);this.selected_date=d6.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(j,i){Event.stop(j);this.view_date.setMonth(i);return this.render()},is_valid_date:function(fl,fn,fm,T,i){var j;fl=parseInt(fl,10);fn=parseInt(fn,10);fm=parseInt(fm,10);T=parseInt(T,10);i=parseInt(i,10);T=T||1970;i=i||(new Date()).getFullYear()+1;fn+=1;if(fm<T){return false}if(fm>i){return false}if(fn<1||fn>12){return false}if(fl<=0){return false}if(fn===2){j=((fm%4)===0)&&(((fm%100)!==0)||((fm%400)===0));if(j){return fl<=29}else{return fl<=28}}else{if(fn===4||fn===6||fn===9||fn===11){return fl<=30}else{return fl<=31}}},change_date:function(i,fl,j){var T;if(!this.is_valid_date(i,fl,j)){return}T=j!==this.view_date.getFullYear()||fl!==this.view_date.getMonth();this.selected_date=new Date(j,fl,i);if(T){this.view_date.setMonth(fl);this.view_date.setFullYear(j);this.render()}else{bF(this.container).find(".selected").removeClass("selected");bF(this.container).find("a#day"+i+"-"+fl).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var fl,fr,fp,fn,fm,j,fo,T,fq,i;fr=this.render_days();fn=bF(".current-month",fr);fo=fn.first().data("date");j=fn.last().data("date");i=fo<=this.options.first_day;fq=j>=this.options.last_day;fl=new Element("div");fl.addClassName("calendar clearfix");if(!fq){this._next_month=(function(fs){return this._change_month(fs,this.view_date.getMonth()+1)}).bind(this);fm=new Element("a");fm.addClassName("changemonth next");fm.update(cx.make("web","arrowright",{}));Event.observe(fm,"click",this._next_month);fl.__sert(fm)}if(!i){this._prev_month=(function(fs){return this._change_month(fs,this.view_date.getMonth()-1)}).bind(this);T=new Element("a");T.addClassName("changemonth prev");T.update(cx.make("web","arrowleft",{}));Event.observe(T,"click",this._prev_month);fl.__sert(T)}fp=new Element("h5");fp.update(eA("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:b6.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));fl.__sert(fp);fl.__sert(fr);return this.container.__date(fl)},render_days:function(){var fr,fn,fq,fl,fo,fp,fs,T,fm;fn=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);T=fn.getDay();fr=new Element("div");fr.addClassName("days");for(fq=fo=fm=T;fm<=0?fo<0:fo>0;fq=fm<=0?++fo:--fo){fs=new Date(fn.getFullYear(),fn.getMonth(),fn.getDate());fs.setDate(fs.getDate()-fq);fr.__sert(this.render_day(fs,true))}fl=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fl.getMonth()===this.view_date.getMonth()){fr.__sert(this.render_day(fl));fl=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fl.getDate()+1)}fp=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(fp.getDay()!==6){fp=new Date(fp.getFullYear(),fp.getMonth(),fp.getDate()+1);fr.__sert(this.render_day(fp,true))}return fr},render_day:function(j,fl){var i,T;T=!fl;if(this.options.last_day){fl=fl||j>this.options.last_day}if(this.options.first_day){fl=fl||j<this.options.first_day}i=new Element(fl?"span":"a");bF(i).data("date",j);if(T){i.addClassName("current-month")}i.update(j.getDate());i.addClassName("date");i.writeAttribute("id","day"+j.getDate()+"-"+j.getMonth());if(this.selected_date.getDate()===j.getDate()&&this.selected_date.getMonth()===j.getMonth()&&this.selected_date.getFullYear()===j.getFullYear()){i.addClassName("selected")}if(fl){i.addClassName("inactive")}else{this._handler=(function(fn){var fm;fm=fn.target.identify().substr(3).split("-");return this.change_date(fm[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(i,"click",this._handler)}return i}});var aU;aU=E.DatePickerInput=Class.create({initialize:function(i,T){var fn,fl,fm,j;this.container=i;this.options={};Object.extend(this.options,T||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");j=(this.input.value?d6.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fm=d6.from_mysql_date(this.container.getAttribute("data-first"))}fn=this.options.disable_future!=null?this.options.disable_future:true;fl=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fm,disable_future:fn,disable_past:fl,selected_date:j});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(j)},show_cal:function(j){var i;if(j){Event.stop(j)}i=$(j.target);if(i.match(".cal-container")||i.up(".cal-container")){return}bF(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(i){this.input.value=d6.to_mysql_date(i,false);this.display.update(N.localize(i));return this.hide_cal()}});var fh;fh=E.TextInputDatePicker=Class.create({initialize:function(fl,T){var fn,fm,j,i;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,T||{});this.input=$(fl);cL(this.input,"Couldn't find the element "+fl.toString());j=new Date();i=(this.input.value?d6.from_mysql_date(this.input.value):false);fm=new Date(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate());this.cal_icon=cx.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+fl,style:"display: none; position: absolute; z-index: 1"});this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fm,selected_date:i});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));fn=bF(this.input);bF(this.cal_container).clonePosition(fn,{setWidth:false,setHeight:false,offsetTop:fn[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(i){if(i){Event.stop(i)}return this.cal_container.toggle()},hide_cal:function(i){if(i){Event.stop(i)}return this.cal_container.hide()},onDateChange:function(i){if(this.options.choose_eod){i.setTime(d6.start_of_day(i).getTime()+86399999)}this.input.value=d6.to_mysql_date(i,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});an.window_load(V.register.bind(V));bF(cj.init.bind(cj));bF(c5.register_all.bind(c5));Event.observe(window,"scroll",function(){return bo.hide_all()});bF(function(){ac.interval=setInterval(ac.check.bind(ac),500);dO.init();return bo.init()});var bg,fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;bg=INLINE_JS.ChangeNameModal=E.ChangeNameModal=(function(i){fc(j,i);function j(){j.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(T){return function(fo){var fn,fl,fm;fo.preventDefault();fn=bF(fo.target);fl=fn.closest("form");fm=function(){T.hide();return location.reload()};return bT.ajax_submit(fl[0],false,fm,null,fn[0])}})(this)}return j})(d7);var bW,es,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;es=E.ManageAliasModal=(function(j){fc(i,j);function i(T){this.options=T;this._poll_until_verified=b3(this._poll_until_verified,this);this._get_params_from_target=b3(this._get_params_from_target,this);this._on_load=b3(this._on_load,this);this._show_action_panel=b3(this._show_action_panel,this);this._input_enter_handler=b3(this._input_enter_handler,this);this.resend_verify=b3(this.resend_verify,this);this.remove_alias=b3(this.remove_alias,this);this.add_alias=b3(this.add_alias,this);this.refresh_alias=b3(this.refresh_alias,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.options)}i.prototype.before_show=function(T){i.__super__.before_show.call(this,T);this.polling=0;T.find(".alias-action").on("click",this._show_action_panel);T.find(".alias-action-submit").on("click",this.add_alias);T.find("form").submit(function(){return false});return T.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};i.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};i.prototype.refresh_alias=function(fl,T){if(fl==null){fl=true}if(fl){bT.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fm){return function(fn){fm.$modal_window.find(".dynamic-content").html(fn.responseText);fm._on_load(fn);if(typeof T==="function"){return T()}}})(this),onFailure:(function(fm){return function(fn){return fm.hide()}})(this)})};i.prototype.add_alias=function(fn){var fm,T,fl,fo;fn.preventDefault();T=bF(fn.currentTarget).closest("form");fm=T.find(".alias-action-submit");fo={};fo[a9.UID_PARAM_NAME]=this.options.subject_user.id;fl=(function(fp){return function(){var fq;fp.$modal_window.find(".alias-action-inputs input").val("");fp.polling=0;fq=fp.polling?null:fp._poll_until_verified;return fp.refresh_alias(true,fq)}})(this);return bT.ajax_submit(T[0],false,fl,false,fm[0],fo,"before")};i.prototype.remove_alias=function(T){var fl;T.preventDefault();fl=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:fl,onSuccess:(function(fm){return function(fn){return fm.refresh_alias()}})(this)})};i.prototype.resend_verify=function(T){var fl;T.preventDefault();fl=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:fl,onSuccess:(function(fm){return function(fn){return fm.refresh_alias()}})(this)})};i.prototype._input_enter_handler=function(T){T.preventDefault();T.stopPropagation();if(T.which===13){return this.add_alias(T)}};i.prototype._show_action_panel=function(fm){var fl,T;fm.preventDefault();T=bF(fm.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();fl=this.$modal_window.find("#"+T).show();return fl.find("input:visible:enabled:first").focus()};i.prototype._on_load=function(T){bf.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(fl){return function(fm){return fl.remove_alias(fm)}})(this));return this.$dynamic.on("click",".alias-verify",(function(fl){return function(fm){return fl.resend_verify(fm)}})(this))};i.prototype._get_params_from_target=function(fm){var T,fl,fn;T=bF(fm);fn=T.data("alias-type");fl=T.closest(".alias-row").find(".alias-text").text();return{alias:fl,alias_type:fn}};i.prototype._poll_until_verified=function(){var fm,fn,fl,T;fn=5;fm=60;fl=(function(fo){return function(){return fo.refresh_alias(false,fo._poll_until_verified)}})(this);T=this.$dynamic.find(".alias-verify").length;if(T&&this.polling<fm){this.polling++;return setTimeout(fl,fn*1000)}else{return this.polling=0}};return i})(d7);bW=INLINE_JS.AliasManager=E.AliasManager={show:function(fm){var T,fl,j,i;i=cM.get_viewer().get_user_by_role(fm);if(i==null){return}if(!i.is_email_verified){if(fm===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}j=cM.get_viewer().is_paired?fm:"";fl=eA("Manage your %(role_show)s contact methods").format({role_show:j});T=new es({element_id:"manage-alias",title:fl,subject_user:i,role:i.role});T.show()}};var dy;dy=INLINE_JS.BonusTable=E.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(i){this.user_id=i;if(dy._inited){return}dy._inited=true;$("bonus-loading").show();dy._tmpl=fg.tmpl("bonus_row_tmpl");dy.listen();return dy.get_next_page()},_render:function(fm){var fl,T,j,fn;fl=[];for(T=0,j=fm.length;T<j;T++){fn=fm[T];fl.push(dy._tmpl({row:fn,Sprite:cx}))}return $("bonus-table").__sert(fl)},get_next_page:function(){if(dy._fetching_page){return}dy._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dy._next_page,{onSuccess:function(j){var fl,i,T;fl=j.responseText.evalJSON();T=fl.rows;i=fl.has_more;dy._render(T);$("bonus-loading").hide();if(i){dy._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dy._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(j){var i,fl,T;fl=bF(j.currentTarget);T=eA("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");i=bF(em.make(T,"right","middle"));Element.absolutize(i[0]);fl.append(i);i.clonePosition(fl,{setWidth:false,setHeight:false});return i.css({width:"200px",left:(parseInt(i.css("left"),10)-210)+"px",top:(parseInt(i.css("top"),10)-55)+"px"})},_max_referral_out:function(fo){var T,fm,j,fn,fl;fn=bF(".reached-max-referral-bonus .bubble");fl=[];for(fm=0,j=fn.length;fm<j;fm++){T=fn[fm];fl.push(T.remove())}return fl},listen:function(){bF("#load-more-bonus").on("click",dy.get_next_page.bind(dy));bF(document).on("mouseenter",".reached-max-referral-bonus",dy._max_referral_over);return bF(document).on("mouseleave",".reached-max-referral-bonus",dy._max_referral_out)},toggle:function(){if(bF("#bonus-list").is(":visible")){this.hide();return bF("#space-earned-link").text(eA("View all space earned"))}else{this.show();return bF("#space-earned-link").text(eA("Hide space earned"))}},show:function(){return bF("#bonus-list").slideDown(150)},hide:function(){return bF("#bonus-list").slideUp(150)}};var D,v,c;D=INLINE_JS.DowngradeReasons=E.DowngradeReasons={reasons:{},addReason:function(i){return this.reasons[i]=true},addReasons:function(T){var fn,fl,j,fm;fm=[];for(fn=0,j=T.length;fn<j;fn++){fl=T[fn];fm.push(this.addReason(fl))}return fm},change:function(fn,T,j){var fo,fq,fp,fl,fm,i;fn=parseInt(fn,10);fq=$(T);cL(fq,"Couldn't find container for DowngradeReason");fo=false;fm=this.reasons;for(fl in fm){fp=fm[fl];i=$(j+fl);cL(i,"Couldn't find container for ",j+fl);if(fp&&parseInt(fl,10)===fn){i.show();fo=true}else{i.hide()}}if(fo){return fq.show()}else{return fq.hide()}}};v=E.DowngradeReasons2={init:function(){var fl,j,T,fm;fm=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];bF(T).change(function(fn){var i;i=fn.target.id.indexOf("other")>=0;return v.change(i,fn.target.getValue())})}return bF(".shared-additional-info").attr("name","shared_additional_info")},change:function(T,i){var j;bF(".downgrade-other-reason .error-message").hide();if(T){return}j="#downgrade-info-"+i;bF(".downgrade-info").hide();bF(j).show();bF(".downgrade-info textarea").removeAttr("name");bF(j+" textarea").attr("name","additional_info");return bF("input[name=other_reason_id]").removeAttr("checked")}};c=E.DowngradeSurvey={init:function(){var i;i="#downgrade-survey-form";return bF(""+i).on("submit",(function(j){return function(fm){var fl,T;T=bF(i+" input[name=other_reason_id]:checked").length;fl=bF(i+" input[id=downgrade-radio-8]");if(fl.is(":checked")&&T===0){bF(".downgrade-other-reason .error-message").show();return fm.preventDefault()}}})(this))}};var cc;cc=INLINE_JS.GetSpace=E.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(T,j,fl){var i;cc._current_space=T;cc._why_msg=j;cc._twitter_url=fl;$("space-actions").on("click",".space-action",cc.perform_action);i=G.parse(window.location.href).fragment;if(i){return cc.highlight_offer(i)}},highlight_offer:function(j){var i,T;i=bF("#"+j);T=i.css("background-color");return i.css("background-color",cc.offer_highlight_color).delay(2000).animate({"background-color":T}).queue(function(){return i.css("background-color","")})},perform_action:function(j){var T,i;i={contact_sales:cc._contact_sales,contact_support:cc._contact_support,teams:cc._teams,upgrade:cc._upgrade,plans:cc._plans,refer:cc._refer,get_started:cc._get_started,fb_link:cc._fb_link,twitter_link:cc._twitter_link,twitter_follow:cc._twitter_follow,why_like:cc._why_like,mailbox_link:cc._mailbox_link};T=$(j.target);if(!T.hasClassName("space-action")){T=T.up(".space-action")}return i[T.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return eq.do_auth(function(){cc._refresh_link_bonuses();return cc._completed($("fb_link"))},cM.get_viewer().personal_user.id)},_twitter_link:function(){return cG.do_auth(function(){cc._refresh_link_bonuses();cG.set_is_authed(cM.get_viewer().personal_user.id,true);return cc._completed($("twitter_link"))},cM.get_viewer().personal_user.id)},_twitter_follow:function(){if(cG.is_authed(cM.get_viewer().personal_user.id)){return cc.follow_dropbox()}else{return cG.do_auth(cc.follow_dropbox,cM.get_viewer().personal_user.id)}},_why_like:function(){fb.show(eA("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return d6._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cG.is_authed(cM.get_viewer().personal_user.id)){cc._refresh_link_bonuses();cG.set_is_authed(cM.get_viewer().personal_user.id,true)}return cG.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(eA("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(eA("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){cc._completed($("twitter_link"))}return cc._completed($("twitter_follow"))}},cM.get_viewer().personal_user.id)},submit_why:function(){cc._why_msg=$F("why-i-like-input");return bT.ajax_submit($("why-i-like-form"),false,(function(){fb.hide();return cc._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(j){var i;j.addClassName("completed");j.down(".icon-col").__date(Element("img",{src:"/static/images/check_36-vflimxFPn.png"}));bF(j).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bF(j).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);i=parseInt(j.down(".space").readAttribute("data-space"),10);cc._current_space+=i;$("current-space").__date(aF.format_bytes(cc._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bz;bz=E.Help={toggle_more_help:false,show_os:function(j,T,i){T=$(T);$$(".os-filter").invoke("removeClassName","selected");T.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+i).invoke("show");return Event.stop(j)},vote:function(i,j){new Ajax.DBRequest("/help/"+i+"/vote/"+j);bF("#help-vote-cont").fadeOut();return ah.success(eA("Thanks for your feedback!"))}};var ev,dV,ag,u,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;dV=INLINE_JS.Hosts=E.Hosts={attach_host_listener:function(fm,T){var j,fl,fn,i;j=bF("#"+fm);fn=j.data("host-ids");fl=j.data("display-name");i=function(){return new ag(fn,fl,T,null,null).show()};bF(".unlink-host-link",j).on("click",i);return j.on("dblclick",(function(){return dV.edit(fn,fm)}))},edit:function(fo,fl){var T,fp,fq,fn,fm,j;fq=bF("#"+fl+" .host-item .sprite-text");if(fq.data("editing")==="true"){return false}fq.data("editing","true");fp=fq.text();fq.data("previous",fp);fo=bx.values(fo);fn=bF('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fp);j=bF('<input type="button" class="button">').val(eA("Save"));j.on("click",function(){return dV.doneEditing(fo,fl)});T=bF('<input type="button" class="button grayed">').val(eA("Cancel"));T.on("click",function(){return dV.cancelEditing(fl)});fq.empty();fq.append(fn,"&nbsp;",j,"&nbsp;",T);fm=bF("input",fq);fm.on("keydown",function(){return dV.checkKey(fo,fl)});fm.focus();return false},doneEditing:function(T,j){var fl,i;fl=bF("#"+j+" .host-item .sprite-text");i=bF("input",fl).val();return bF.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(T),name:i},type:"POST"}).success(function(fm){return dV.unedit(fl,JSON.parse(fm).display_name)})},cancelEditing:function(i){var j;j=bF("#"+i+" .host-item .sprite-text");return dV.unedit(j,j.data("previous"))},unedit:function(j,i){j.data("editing","false");return j.text(i)},dismiss:function(T,j,fl,i,fm){new bF.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:T,user_id:j,team_id:fl},subject_user:fm,success:function(fn){return i.remove()}});return false},checkKey:function(j,i){return function(T){T=T||window.event;if(T.keyCode===Event.KEY_RETURN){dV.doneEditing(j,i)}if(T.keyCode===Event.KEY_ESC){return dV.cancelEditing(i)}}},show_device_unlink_modal:function(j,T,i,fp,fm,fl){var fo,fn;fo=bF("#unlink-device-modal-"+fm);fn={both:bx.values(fp),personal:[fp[Constants.ROLE_PERSONAL]],work:[fp[Constants.ROLE_WORK]]};fb.show(i,fo[0]);if(bx.values(fp).length>1){fo.addClass("show-selector")}return bF("form input[type=submit]",fo).on("click",function(fq){fq.preventDefault();fp=fn[bF(".unlink-select select",fo).val()];bT.add_vars(bF("form",fo)[0],{user_ids:JSON.stringify(fp),app_id:T,device_id:JSON.stringify(j),device_name:fl});return bF("form",fo).submit()})}};ev=E.DeleteFailuresModal=(function(i){fc(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};j.prototype.on_show=function(fl){var T;T=bd("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(T)};return j})(d7);u=INLINE_JS.show_delete_failures_modal=E.show_delete_failures_modal=function(T,j,i){var fl;fl=new ev({element_id:"delete-failures-modal"});fl.host_id=T;fl.name=j;fl.num_failures=i;fl.show();return false};ag=INLINE_JS.UnlinkHostModal=E.UnlinkHostModal=(function(j){fc(i,j);function i(T,fo,fm,fl,fn){this.host_ids=T;this.name=fo;this.delete_support_type=fm;this.owner_id=fl;this.team_id=fn;this.on_show=b3(this.on_show,this);this._set_delete_text=b3(this._set_delete_text,this);this.fail_callback=b3(this.fail_callback,this);this.success_callback=b3(this.success_callback,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=bx(this.host_ids).values().length>1}i.prototype.on_confirm_button_click=function(fn){var fl,fm,T;fn.preventDefault();fm=this.$modal_window.find(".unlink_host_form")[0];fl=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");T={host_ids:JSON.stringify(this.get_selected_hosts())};return bT.ajax_submit(fm,false,this.success_callback,this.fail_callback,fl,T)};i.prototype.success_callback=function(){return window.location.reload()};i.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};i.prototype._set_delete_text=function(T){return this.$modal_window.find(".delete_data_label").text(T)};i.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};i.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};i.prototype.on_show=function(fl){var T;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(fm){return function(fn){if(fm._get_unlink_select()===Constants.ROLE_PERSONAL){return fm.$modal_window.find(".new_client").hide()}else{return fm.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eA("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cM.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(fm){return function(fn){if(fm._get_unlink_select()===Constants.ROLE_WORK){return fm.$modal_window.find(".new_client").hide()}else{return fm.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eA("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(eA("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fm){return function(fn){if(fm._get_unlink_select()===Constants.ROLE_PERSONAL){return fm._set_delete_text(eA("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fm._get_unlink_select()===Constants.ROLE_WORK){return fm._set_delete_text(eA("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cM.get_viewer().team_name}))}else{return fm._set_delete_text(eA("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){T="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(eA("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:T}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};i.prototype.get_selected_hosts=function(){var T;if(bx.values(this.host_ids).length===1){return bx.values(this.host_ids)}T=bF(".unlink-choice").val();if(T==="both"){return bx.values(this.host_ids)}else{return[this.host_ids[T]]}};return i})(d7);var eL;eL=E.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(j,T){var i;if(T.hasAttribute("data-div")){j.preventDefault();i=T.readAttribute("data-div");return eD.push_state("/news/"+i)}});return eD.add_callback("/news",eL.history_change)},change_tab:function(i){var j;j=$$("#nav a[data-div="+i+"]").first();if($(j)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(j).addClassName("selected");return $(i).addClassName("selected")}},history_change:function(i){i=i||eL.DEFAULT_TAB;return eL.change_tab(i)}};var dH;dH=E.Recover={init:function(){var i;i=$("recover-form");return i.observe("submit",this.form_submit.bind(this))},form_submit:function(i){this.clear_error();i.preventDefault();return bT.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(j){var i;i=JSON.parse(j.responseText);if(i.status==="error"){this.show_error(i.msg)}if(i.status==="ok"){this.show_hosts(i)}if(i.status==="redirect"){return window.location.href=i.url}},show_hosts:function(fq){var fp,fm,fl,fn,T,j,fo;bT.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fq.filename);fm=$("trusted-hosts");fm.update();fo=fq.hosts;for(fl=0,T=fo.length;fl<T;fl++){fp=fo[fl];j=new Element("li");fn="lnx";if(fp.platform==="mac"){fn="osx"}if(fp.platform==="win"){fn="win"}j.__sert(cx.make("web",fn));j.__sert(new fg(fp.display_name.escapeHTML()));fm.appendChild(j)}$("login-step").hide();return $("hosts-step").show()},show_error:function(i){$("error-messages").update(i);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var dq;dq=E.Restore={next:function(i,fl){var T,j;j=bF("ul.selected");T=j.next("ul");T.addClass("selected");j.removeClass("selected");if(T.next("ul").length){bF("#next-page").show()}else{bF("#next-page").hide()}bF("#prev-page").show();return dq.inc_page(1)},prev:function(i,fl){var T,j;j=bF("ul.selected");T=j.prev("ul");T.addClass("selected");j.removeClass("selected");if(T.prev("ul").length){bF("#prev-page").show()}else{bF("#prev-page").hide()}bF("#next-page").show();return dq.inc_page(-1)},inc_page:function(T){var j,i;j=parseInt(bF("#page_num").text(),10);i=j+T;return bF("#page_num").text(i)},init:function(fl,i,j){var T;T=cM.get_viewer().get_user_by_id(j);bF("#next-page").on("click",function(fm){dq.next(fm);return false});bF("#prev-page").on("click",function(fm){dq.prev(fm);return false});bF("#restore-submit-button").on("click",function(fm){dD.do_folder_restore(fl,T);return false});bF("#restore-cancel-button").on("click",function(fm){return b1.redirect(i)});return bF("#restore-back-button").on("click",function(fm){return b1.redirect(i)})}};var cg,dz,cI,aT,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;cg=E.SelectRoleModal=(function(i){fc(j,i);function j(){this.on_show=b3(this.on_show,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=null;j.prototype.on_show=function(){return bF(".role-options li").click((function(T){return function(fm){var fl,fn;fl=bF(fm.target).closest("li");fn=fl.data("role");cL(T.on_select_role,"missing on_select_role implementation");T.on_select_role(fn);return T.hide()}})(this))};return j})(d7);cI=E.SharedFolderSelectRoleModal=(function(i){fc(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fl){var T;T=function(){bZ.role_picker.ensure_role_is_visible(fl);return s.start_wizard_for_user(cM.get_viewer().get_user_by_role(fl))};if(fl===bO.logged_out_role){return bO.show_modal({role:fl,on_success:T})}else{return T()}};return j})(cg);aT=E.ShmodelC2DSelectRoleModal=(function(i){fc(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fl){var T;T=function(){return am.show_c2d_modal(fl)};if(!cM.get_viewer().is_role_signed_in(fl)){return bO.show_modal({role:fl,on_success:T})}else{return T()}};return j})(cg);dz=E.ShareShmodelSelectRoleModal=(function(i){fc(j,i);function j(){this.on_select_role=b3(this.on_select_role,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(T){return am.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,T)};return j})(cg);var cQ;cQ=E.TabController=Class.create({initialize:function(T,j){var i;i=$(T);cL(i,T+" is missing.");this.container=i;this.options={killEvent:true};Object.extend(this.options,j);return this.listen()},listen:function(){var fo,fl,j,fn,T,fm;fm=this;fn=this.container.select("a");T=[];for(fl=0,j=fn.length;fl<j;fl++){fo=fn[fl];cL(fo.id&&fo.id.length>0,"Element is missing an id");T.push(fo.observe("click",(function(i){return this.click(i)}).bindAsEventListener(fm)))}return T},click:function(i){if(this.options.killEvent){Event.stop(i)}return this.toggle($(i.target))},toggle:function(j){var fm,i,fl,fn,T;T=this.container.down("a.selected");if(T){fn=$(T.id+"-content");if(fn){fn.hide()}}this.container.select(".selected").invoke("removeClassName","selected");i=false;if(!j){j=this.container.down("a");i=true}j.addClassName("selected");fm=$(j.id+"-content");if(fm){fm.show()}if(this.options.onTabChange){this.options.onTabChange(j,T)}if(this.options.url_prefix){fl=this.options.url_prefix;if(!i){fl+="/"+j.id}return eD.push_state(fl)}}});var dQ;dQ=E.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bF((function(i){return function(){i.add_auto_completer=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(j){return j.excludeTeamMembers().excludeFacebook().excludeNewStyleGroups().excludeMe()}});i.add_auto_completer.clearTokens();i.tokenAdd=bF.proxy(i._tokenAdd,i);i.tokenRemove=bF.proxy(i._tokenRemove,i);bF("#team-invite-new-collab-input")[0].on("token:add",i.tokenAdd);bF("#team-invite-new-collab-input")[0].on("token:remove",i.tokenRemove);i.reset_licenses();i.update_free_licenses_message();i.initialized=true;i.setup_tab_support(bF);return cj.init()}})(this))},set_emails:function(i){if(i==null){return}return bF((function(j){return function(){var fl,fo,fn,T,fm;j.init();fm=[];for(fn=0,T=i.length;fn<T;fn++){fl=i[fn];fo=j.add_auto_completer.createTokenInfo(null,fl,W.EMAIL);fm.push(j.add_auto_completer.addContact(fo))}return fm}})(this))},rebind_modal_submit_autocompleter:function(){var i,j;i=this.invite_modal.$modal_window;j=i.find(".tokenizer-submit-button");j.on("mousedown",(function(T){return function(){return T.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(i)},setup_tab_support:function(i){return i.find("#team-invite-new-collab-input").first().on("keyup change",function(){var j;j=i.find(".new-collab-input").first();if(j.val()!==""){return j.attr("tabindex",-1)}else{return j.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T,j,i;i=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(T=(j=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof j.get_total_licenses==="function"?j.get_total_licenses():void 0:void 0)!=null?T:this.total_licenses;this.update_used_licenses(i);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(i){this.available_licenses--;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(i){this.available_licenses++;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(j){var fl,T,i;if(window.active_team_member_table){fl=window.active_team_member_table.data.users;for(i in fl){T=fl[i];if(T.email===j){return true}}}},update_license_count:function(){var i,j;i=bF("#license-count-message");if(this.available_licenses<0){j=eA("You need more licenses for this invitation.");i.addClass("over")}else{if(this.available_licenses===0){j=eA("You have no remaining licenses.");i.removeClass("over")}else{if(this.available_licenses>0){j=bd("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});i.removeClass("over")}else{j="You have \u00a0 remaining licenses."}}}return i.text(j)},init_modal_licenses:function(T,j,i){if(!this.invite_modal){this.invite_modal=new w(i)}this.total_licenses=T;this.is_trial=j;return bF("body").trigger("invite-modal-initialized")},update_used_licenses:function(i){this.used_licenses=i;return this.reset_licenses()},init_form_licenses:function(T,i,j){this.total_licenses=T;this.used_licenses=i;this.is_trial=j;return dQ.reset_licenses()},add_total_licenses:function(i){i=i||0;if(i>0){this.total_licenses+=i;this.available_licenses+=i;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(i)}}},on_add_licenses_exit:function(T,i){var j;if((j=this.invite_modal)!=null?j.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(i)},reset_modal:function(){var i;i=this.invite_modal.$modal_window;c5.reset(i.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens();this.add_auto_completer.update.hide()}this.reset_modal_licenses();return i.find(".new-collab-input").val("")},on_add_licenses_click:function(j){var i;j.preventDefault();if(this.is_trial){if((i=this.invite_modal)!=null){i.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){d1.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bF.proxy(this.on_add_licenses_exit,this);d1.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return d1.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var i;i=this.invite_as_limited();bF(".team-invite-add-licenses").toggle(!i);bF("#license-count-message").toggle(!i);return bF("#license-free-message").toggle(i)},invite_as_limited:function(){var i;i=bF('input[name="membership_type"]');return i&&i.is(":checked")}};var w,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;w=E.InviteModal=(function(j){fc(i,j);function i(T){this.transition_view_model=T;this._reset=b3(this._reset,this);this._update_form_pricing_information=b3(this._update_form_pricing_information,this);this._update_remaining_licenses_message=b3(this._update_remaining_licenses_message,this);this._make_transition_info_request=b3(this._make_transition_info_request,this);this._handle_token_change=b3(this._handle_token_change,this);this._licenses_total=b3(this._licenses_total,this);this.is_making_transition_info_request=b3(this.is_making_transition_info_request,this);this.on_hide=b3(this.on_hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input",title:eA("Invite team members")});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new ff([this.transition_view_model]);this.probability=Math.random()}this.skip_reset=false;this.making_transition_info_request=false;this.transition_info_callback=null}i.prototype.on_confirm_button_click=function(fl){var T;if(dQ.invite_as_limited()){T=0}else{T=this.add_qty}return dU.add_users(fl,T)};i.prototype.on_show=function(){var fl,T;this._reset();T=bF('input[name="membership_type"]');if(T!=null){T.attr("checked",false)}if(T!=null){T.click((function(fm){return function(){dQ.update_free_licenses_message();return fm._updated_charges_messages(dQ.invite_as_limited())}})(this))}fl=bF("#team-invite-wizard .team-invite-add-licenses");fl.on("click",bF.proxy(dQ.on_add_licenses_click,dQ));bF(window).on("token:changed",this._handle_token_change);if(dQ.initialized){dQ.update_license_count();dQ.update_free_licenses_message()}return d1.register(d1.CLEAR,function(){return dQ.reset_modal()})};i.prototype.on_hide=function(){return bF(window).off("token:changed",this._handle_token_change)};i.prototype.is_making_transition_info_request=function(){return this.making_transition_info_request};i.prototype._licenses_to_add=function(){return -1*dQ.available_licenses};i.prototype._licenses_total=function(){return dQ.total_licenses+this._licenses_to_add()};i.prototype._getInvitesCount=function(){return dQ.total_licenses-dQ.used_licenses-dQ.available_licenses};i.prototype._handle_token_change=function(fl,T){this._updateConfirmButton();this._update_remaining_licenses_message(T.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fm){return function(){fm._make_transition_info_request();return fm.fetch_transition_timeout_id=null}})(this),100)}};i.prototype._make_transition_info_request=function(){var fm,fl,T,fn;this.making_transition_info_request=true;fl=Math.floor(Math.random()*1000000);this.current_callback_token=fl;fm=this._licenses_to_add();T=this._licenses_total();fn=(function(fo){return function(fp){return fo._update_form_pricing_information(fl,fm,T,fp!=null?fp[0]:void 0)}})(this);if(fm>0){return this.transition_info_fetcher.get(fn,{total_users:this._licenses_total()})}else{return fn(null)}};i.prototype._update_remaining_licenses_message=function(T){var fl;this.remaining_licenses=T;fl=this._get_remaining_licenses_message(this.remaining_licenses);return this.$modal_window.find("#license-count-message").text(fl)};i.prototype._get_remaining_licenses_message=function(T){var fl;if(T<0){fl=eA("You need more licenses for this invitation.")}else{if(T===0){fl=eA("After this invitation, you'll have no remaining licenses.")}else{fl=bd("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",T).format({count:T})}}return fl};i.prototype._update_form_pricing_information=function(fn,fo,T,fr){var fl,fq,fp,fm;if(fn!==this.current_callback_token){return}if(fr&&fo>0){this.add_qty=fo;fl=this.transition_view_model.state.currency;fp=fr.current_total.amount;fq=fe.formatCurrency(fp,fl);fm=fe.formatCurrency(fr.recurring_total.amount,fl);bF(".new-amount").text(fq);bF(".add-qty").text(fo);bF(".recurring-amount").text(fm);bF(".total-qty").text(T);bF("#expected_price").val(fp);this._updated_charges_messages(dQ.invite_as_limited())}else{this._reset()}return this.making_transition_info_request=false};i.prototype._updateConfirmButton=function(){var T;T=bd("Send invite","Send invites",this._getInvitesCount());return bF(".team-invite-buttons .confirm-button").val(T)};i.prototype._reset=function(){this.add_qty=0;bF(".charges-section").hide();bF("#expected_price").val(0);return this._updateConfirmButton()};i.prototype._updated_charges_messages=function(T){if(this.inline_add_license&&this.add_qty>0&&!T){bF(".charges-section").show();return bF(".team-invite-buttons .confirm-button").val(eA("Invite and buy"))}else{bF(".charges-section").hide();return this._updateConfirmButton()}};return i})(d7);var bJ,aw,aB,U,ee,eZ,bu,eJ,dU,fa,bh,cs,q,b3=function(i,j){return function(){return i.apply(j,arguments)}},fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty;dU=INLINE_JS.Team=E.Team={_use_async_reset:false,team_id:cM.get_viewer().team_id,set_team_id:function(i){this.team_id=i},setup_beta_modal_listeners:function(){var fp,fs,fq,T,fo,fl,fr,fm,fn;fs=bF(".feature-list .enroll-button");T=bF(".feature-list .feedback-button");for(fo=0,fr=fs.length;fo<fr;fo++){fp=fs[fo];fq=bF(fp).data("feature");bF(fp).click((function(i){return function(){return new aw(i).show()}})(fq));fp.disabled=false}fn=[];for(fl=0,fm=T.length;fl<fm;fl++){fp=T[fl];fq=bF(fp).data("feature");fn.push(bF(fp).click((function(i){return function(){return new aB(i).show()}})(fq)))}return fn},invite_modal_show:function(i){if(!dQ.invite_modal){return bF("body").one("invite-modal-initialized",(function(j){return function(){return j.invite_modal_show(i)}})(this))}if(!this.invite_modal_already_initialized){dQ.invite_modal.show();dQ.init();this.invite_modal_already_initialized=true}else{dQ.invite_modal.show();dQ.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dQ.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dQ.set_emails(i)},init_admin:function(){bo.set_vertical_space(2);return bF("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bF(".team_name_change_notice .hide_link").click((function(i){return function(j){return i.hide_team_name_change_banner()}})(this))},add_users:function(fl,j){var fm,T,i;Event.stop(fl);T=$("team-invite-form");cL(T,"Couldn't find the team invite form.");fm=bF(T).find("input[name='emails']");if(fm.length===0){ah.error(eA("You haven't included anyone to invite! Please invite at least one person."));return}i=(function(fn){return function(){var fo;fo=bT.collect_form_vars(T);bF.extend(fo,{team_id:fn.team_id});bT.add_loading(fl.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:fo,subject_user:cM.get_viewer().work_user,progress_text:eA("Inviting members..."),noAutonotify:true,onSuccess:function(fu){var fs,fr,fq,ft,fp;bT.remove_loading();dQ.reset_modal();dQ.add_total_licenses(j);dQ.invite_modal.hide();ft=bF(".team_admin_members_table");fq=JSON.parse(fu.responseText);if(fq){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fq!=null?fq.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fq!=null?fq.num_invited:void 0)}}}fs=(function(){var fw,fv;fw=fq!=null?fq.users:void 0;fv=[];for(fr in fw){fp=fw[fr];fv.push(fp)}return fv})();if(fs.length===1){return ah.success(eA("Invited %(user_email)s.").format({user_email:fs[0].email}))}else{if(fs.length>1){return ah.success(eA("Invited %(user_count)d people.").format({user_count:fs.length}))}else{return ah.error(bd("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fm.length).format({num_skipped:fm.length}))}}}else{return ah.error()}},onFailure:function(fr){var fp,fq;if(fr){if(fr.responseText.indexOf("err:")===0){fp=fr.responseText.substr(4);if(fp.indexOf("{")===0){fq=fp.evalJSON(true);bT.fill_errors(T,fq)}else{fp=new fg(fp);ah.error(fp)}}else{ah.error()}}bT.remove_loading();return bF("input[type='submit']").prop("disabled",false)},cleanUp:function(){bT.remove_loading();dQ.reset_modal();return dQ.invite_modal.hide()}})}})(this);return setTimeout(function(){if(!dQ.invite_modal.is_making_transition_info_request()){return i()}},100)},show_demo_signup_modal:function(T,fl,fm,j,fn){var i,fq,fp,fo;this.webinar_key=T;this.webinar_iso_datetime=fl;this.webinar_date=fm;this.webinar_title=j;this.tab_url=fn;fo=eA("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fq=new U({element_id:"demo-signup-modal",title:fo});fq.show();fq.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fq.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fq.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fq.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fp=fq.$modal_window.find("input[name=retURL]");fp.attr("value",fp.val()+"#"+this.tab_url);i=fq.$modal_window.find("#demo-signup-form")[0];return i.on("submit",fq.on_confirm_button_click)},show_unsuspend_modal:function(fl,i,j,T){var fm;fm=new bu({element_id:"dfe-unsuspend-modal",focus:"confirm"});fm.user_name=fl||j;fm.email=j;fm.user_id=i;fm.team_id=this.team_id;fm.refresh_cb=T;fm.show();return false},show_remove_or_deactivate_modal:function(j,T,fq,fl,fm,fo,i,fn){var fp;fp=new ee({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});fp.user_name=T||fl;fp.email=fl;fp.user_id=fq;fp.team_id=this.team_id;fp.invited=fm;fp.limited=fo;fp.hide_transfer_wipe=i;fp.refresh_cb=fn;fp.show();return false},show_remove_modal:function(fl,fm,fr,fn,fo,i,j,T,fp){var fq;fq=new eZ({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fq.user_name=fm||fn;fq.email=fn;fq.user_id=fr;fq.team_id=this.team_id;fq.invited=fo;fq.num_api_apps=i;fq.hide_transfer_setting=j;fq.hide_remote_wipe_setting=T;fq.refresh_cb=fp;fq.show();return false},remove_user:function(fl,fm){var T,j,i;alert("in remove_user");Event.stop(fl);j=bF("input[type=submit]","#remove-user-modal");j.attr("disabled",1);i=fb.vars.user_id;if(fm){T=true}else{T=bF("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:i,should_disable:T},onSuccess:(function(fn){return function(fr){var fq,fp,fo;fo=JSON.parse(fr.responseText);if((fq=window.active_team_member_table)!=null){fq.remove_user(fb.vars.user_id)}if((fp=window.removed_team_member_table)!=null){fp.add_users(fo)}fn.decrement_used_licenses();return ah.success(eA("User removed."))}})(this),cleanUp:function(){fb.hide();return j.removeAttr("disabled")}})},show_reinvite_modal:function(T,fl,i,j){var fm;dv.fillVal(j,"reinvite-user-email");dv.fillVal(fl,"reinvite-user-team");fm=eA("Resend invite to '%(email_address)s'").format({email_address:bU.em_snippet(j,18)});return fb.show(fm,$("reinvite-user-modal"),{user_id:i,button:T})},email_verification:this.email_verification=new d4("work"),show_email_verification_modal:function(){return this.email_verification.show_verify_modal(null,er.NEW_DFB_TEAM)},reinvite_user:function(j){var i;Event.stop(j);i=fb.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(fo){var fl,fn,fm,T;ah.success(eA("Invite sent."));if((fn=$("team-member-info"))!=null){fn.update(fo.responseText)}fl=window.active_team_member_table;if(fl){T=fl.data.users[i];T.invite_expired=false;fm={};fm[i]=T;return fl.update_user_data(fm)}},cleanUp:function(){return fb.hide()}})},show_request_license_modal:function(j,i){var T;T=eA("Send upgrade request?");return fb.show(T,$("request-license-modal"),{user_id:i,button:j})},request_license:function(j){var i;Event.stop(j);i=fb.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){bF("#request_license_text").hide();bF("#request-license-section").hide();return ah.success(eA("Request sent."))},cleanUp:function(){return fb.hide()}})},show_user_activity_log_modal:function(i,T,fl){var j;j=bF("#activity-log-modal");j.find(".activity-log-email").text(T);j.find(".activity-log-name").text(fl);j.find("#activity-log-user-message").show();return fb.show(eA("Create activity report"),j[0],{user_id:i})},show_team_activity_log_modal:function(j,T){var i;i=bF("#activity-log-modal");i.find(".activity-log-email").text(j);i.find(".activity-log-name").text(T);i.find("#activity-log-team-message").show();return fb.show(eA("Create full activity report"),i[0])},generate_activity_log:function(fp){var fn,fl,fo,fm,i,T,j;Event.stop(fp);fl=bF("#activity-log-modal");fo=fl.find("input[name='from_date']").val();i=fl.find("input[name='to_date']").val();if(fo>i){ah.error(eA("Your start date is after your end date."));return}fm=this.team_id;j=fb.vars.user_id;T=new Date().getTimezoneOffset().toString();fn=bF(".activity-report-generator .freshbutton-blue");fn.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fo,to_date:i,team_id:fm,user_id:j,tzoffset:T},onSuccess:function(fq){return ah.success(eA("Report started. We'll email you when it's ready."))},cleanUp:function(){fb.hide();return fn.prop("disabled",false)}})},show_reset_password_modal:function(j,T,i){var fl;bF("#reset-password-modal .member-name").text(T);fl=eA("Reset password for '%(user_name)s'").format({user_name:T});return fb.show(fl,$("reset-password-modal"),{user_id:i,button:j})},reset_password:function(j){var i;Event.stop(j);i=fb.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){return ah.success(eA("User's password reset."))},cleanUp:function(){return fb.hide()}})},show_reset_all_passwords_modal:function(){return fb.show(eA("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(i){return this._use_async_reset=i},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cM.get_viewer().work_user,progress_text:eA("Resetting all passwords..."),onSuccess:function(i){return ah.success(eA("All passwords reset."))},cleanUp:function(){return fb.hide()}})},show_admin_status_modal:function(T,fp,fr,fm,fq,fn){var j,i,fl,fo;i=fq.strip()||fm;fl=void 0;j=void 0;fo=void 0;if(fn){fo=eA("Add admin permissions for '%(person_name)s'").format({person_name:i.escapeHTML()});fl=eA("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eA("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fo=eA("Remove admin privileges from '%(person_name)s'").format({person_name:i.escapeHTML()});fl=eA("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eA("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}dv.fillVal(fm,"admin-status-email");dv.fillVal(fl,"admin-status-action");dv.fillVal(j,"admin-status-button-action");fb.show(fo,$("admin-status-modal"),{user_id:fr,button:T,admin_on:fn});return false},set_admin_status:function(j){var i;Event.stop(j);i=fb.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:i,on:(fb.vars.admin_on?"yes":"no")},onSuccess:function(fl){var fm,T;fm=(fb.vars.admin_on?eA("User's admin status granted."):eA("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){T=JSON.parse(fl.responseText);window.active_team_member_table.update_user_data(T);return ah.success(fm)}else{if(fb.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(fb.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(fb.vars.user_id)}}}},cleanUp:function(){return fb.hide()}})},show_disable_2fa_modal:function(T,i,j){bF("#disable-2fa-modal .member-name").text(j);return fb.show(eA("Disable two-step verification"),$("disable-2fa-modal"),{user_id:i,elm:T})},show_reset_2fa_modal:function(T,i,j){bF("#reset-2fa-modal .member-name").text(j);return fb.show(eA("Reset two-step verification"),$("reset-2fa-modal"),{user_id:i,user_name:j,elm:T})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:fb.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eA("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eA("Two-step verification reset for %(user_name)s").format({user_name:fb.vars.user_name}));return fb.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:fb.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eA("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eA("Two-step verification disabled."));return fb.hide()}})},show_sso_preview_email:function(i){return fb.show(eA("Email preview"),$(i))},show_sso_sample_email:function(i){return fb.show(eA("Sample email"),$(i))},show_user_message_modal:function(T,j,i){var fl;dv.fillVal(i,"user-message-email");fl=eA("Send email to '%(user_name)s'").format({user_name:T});$("user-message").value="";fb.show(fl,$("user-message-modal"),{user_name:T,user_id:j});return d6.focus.defer("user-message")},send_user_message:function(){var j,i;i=fb.vars.user_id;j=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:i,team_id:this.team_id,message:j},onSuccess:function(){var T;T=fb.vars.user_name;ah.success(eA("Message successfully sent to %(user_name)s.").format({user_name:T}));return fb.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bF(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bF(".pin_notice").hide()},hide_pin_banner_with_user_id:function(i,j){var T;T=function(fl){return bF(j).closest("span").removeClass("on").addClass("off")};if(i===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:T})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:i},onSuccess:T})}},get_pin_with_user_id:function(i,T,j){var fl;if(j==null){j=null}if(j===null){j=function(fn,fm){bF(fm).closest("span").find(".pin-value").text(fn.pin+" -");return bF(fm).closest("span").removeClass("off").addClass("on")}}fl=function(fn){var fm;fm=JSON.parse(fn.responseText);return j(fm,T)};if(i===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:fl})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:i},onSuccess:fl})}},send_team_message:function(j){var i;Event.stop(j);i=$F("team-message").strip();if(i){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:i},onSuccess:function(T){ah.success(eA("Message successfully sent to team."));return fb.hide()}})}},show_security_message_modal:function(){return new fa().show()},send_team_security_message:function(T){var j,i;Event.stop(T);i=$F("team-security-message").strip();j=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:j.serialize(true),onSuccess:function(fl){ah.success(eA("Message successfully sent."));return fb.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(i,j){this.used_licenses=i;return this.total_licenses=j},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(i,j){$("migration-url").value=j;fb.show(eA("Migration link for '%(email)s'").format({email:bU.em_snippet(i,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(j,i,T){bo.hide_all();bF("#end-session-modal .member-name").text(bF("#member-name").text());return fb.show(eA("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:j,user_id:i,elm:T})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:fb.vars.login_id,team_id:this.team_id,user_id:fb.vars.user_id},onSuccess:function(){fb.hide();dU.remove_closest_row(fb.vars.elm);return ah.success(eA("Web session closed."))}})},unlink_device:function(i,fl,fp,j,fq,T,fm){var fo,fn;bo.hide_all();fo=$("unlink-device-modal-"+T);fn=eA("Unlink %(device_name)s").format({device_name:fp});return fb.show(fn,fo,{app_id:fl,user_id:fq,elm:fm,device_id:i,display_name:fp})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:fb.vars.app_id,team_id:this.team_id,user_id:fb.vars.user_id,device_id:JSON.stringify(fb.vars.device_id)},subject_user:cM.get_viewer().work_user,onSuccess:function(){fb.hide();dU.remove_closest_row(fb.vars.elm);return ah.success(eA("%(device_name)s unlinked.").format({device_name:fb.vars.display_name}))}})},disable_app:function(j,T,i,fl){bo.hide_all();bF("#disable-app-modal .app-name").text(T);bF("#disable-app-modal .member-name").text(bF("#member-name").text());return fb.show(eA("Disable '%(app_name)s'?").format({app_name:T}),$("disable-app-modal"),{app_id:j,user_id:i,elm:fl})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fb.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:fb.vars.user_id},subject_user:cM.get_viewer().work_user,onSuccess:function(i){fb.hide();dU.remove_closest_row(fb.vars.elm);return ah.success(i.responseText)}})},remove_closest_row:function(fl){var T,j,i;T=bF(fl).closest(".team_admin_table_row");j=bF(T).closest(".team_admin_table");if(j.find(".team_admin_table_row").length===1){i=j.prev(".team_admin_table_title");if(!i.length){i=bF(".team_apps_table_panel")}i.remove();return j.remove()}else{return T.remove()}},submit_report_form:function(i){bF(i.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};aw=E.BetaEnrollConfirmationModal=(function(j){fc(i,j);function i(T){this.feature_name=T;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}i.prototype.on_confirm_button_click=function(T){bF("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return i})(d7);aB=E.BetaFeedbackModal=(function(j){fc(i,j);function i(T){this.feature_name=T;this.success=b3(this.success,this);i.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(fl){return function(fp){var fo,fn,fm;fp.preventDefault();fo=bF(fp.target);fn=fo.closest("form");fm={feature_name:fl.feature_name};return bT.ajax_submit(fn[0],false,fl.success,fl.error,fo[0],fm)}})(this)}i.prototype.success=function(T){ah.success(eA("Thank you for your feedback."));return this.$modal_window.hide()};i.prototype.error=function(T){if(T.status!==200){return ah.error(eA("Failed to submit feedback. Please try again."))}};return i})(d7);U=E.DemoSignupModal=(function(i){fc(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fo){var fw,ft,fp,T,fr,fm,fv,fu,fl,fs,fq,fn;fo.preventDefault();fq=$("demo-signup-form");fu=$("1210");fm=bF(fq).find("input[name='first_name']").val();bF(fu).find("input[name='FirstName']").attr("value",fm);fv=bF(fq).find("input[name='last_name']").val();bF(fu).find("input[name='LastName']").attr("value",fv);fr=bF(fq).find("input[name='email']").val();bF(fu).find("input[name='Email']").attr("value",fr);fs=bF(fq).find("input[name='phone_number']").val();bF(fu).find("input[name='Phone']").attr("value",fs);fw=bF(fq).find("input[name='company_name']").val();bF(fu).find("input[name='Company']").attr("value",fw);fp=bF(fq).find("select[name='company_size']");ft=fp.find("option:selected").val();bF(fu).find("input[name='Company_size__c']").attr("value",ft);T=$(this.$modal_window.find(".confirm-button")[0]);fn=(function(fx){return function(fy){fx.$modal_window.hide();return fu.submit()}})(this);fl=bT.collect_form_vars(fq,true);return bT.ajax_submit(fq,false,fn,false,T,fl,true)};j.prototype.on_show=function(T){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return cj.init()};return j})(d7);bJ=E.AccountTransferBaseModal=(function(j){fc(i,j);function i(T,fm,fl){this.file_action_selector=fm;this.transfer_choice_selector=fl;this._clearInput=b3(this._clearInput,this);this._markInputInvalid=b3(this._markInputInvalid,this);this._markInputValid=b3(this._markInputValid,this);this._tokenRemove=b3(this._tokenRemove,this);this._tokenAdd=b3(this._tokenAdd,this);this._selectChange=b3(this._selectChange,this);this._isTransferSelected=b3(this._isTransferSelected,this);this.checkAndApproveMemberRemoval=b3(this.checkAndApproveMemberRemoval,this);this.on_cancel_button_click=b3(this.on_cancel_button_click,this);this.execute_form=b3(this.execute_form,this);this.get_cancel_button=b3(this.get_cancel_button,this);this.get_confirm_button=b3(this.get_confirm_button,this);this.get_button_class=b3(this.get_button_class,this);this.set_modal_class=b3(this.set_modal_class,this);this.handleAjaxFailure=b3(this.handleAjaxFailure,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,T,this.file_action_selector,this.transfer_choice_selector)}i.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(T){return function(fl){return fl.excludeNonTeam().excludeNewStyleGroups().excludeByEmail(T.email?[T.email.toLowerCase()]:[])}})(this),exclude_emails:[this.email]});this.tokenAdd=bF.proxy(this._tokenAdd,this);this.tokenRemove=bF.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bF.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};i.prototype.handleAjaxFailure=function(T){if(T.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};i.prototype.set_modal_class=function(fn){var fl,T,fm;fl="suspending deleting approve_transfer_to_suspended";T=this.get_form();T.removeClass(fl);if(fn!=null){T.addClass(fn)}if((fm=bF(".suspend_option_content"))!=null){fm.removeClass("title_bubble limited")}if((this.limited!=null)&&this.limited){bF(".suspend_option_content").addClass("title_bubble limited");return bF(".suspend_option_content").attr("data-title","Limited members can not be suspended")}};i.prototype.get_button_class=function(){var T;T=this.get_form();if(T.hasClass("suspending")){return".confirm_deactivate_button"}else{if(T.hasClass("deleting")){return".confirm_delete_button"}else{if(T.hasClass("approve_transfer_to_suspended")){return".confirm_transfer_to_suspended_button"}}}};i.prototype.get_confirm_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .confirm-button"))}else{return $(this.$modal_window.find(".confirm-button"))}};i.prototype.get_cancel_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .cancel-button"))}else{return $(this.$modal_window.find(".cancel-button"))}};i.prototype.execute_form=function(){var T,fl;fl=this.get_form()[0];T=this.get_confirm_button();return bT.ajax_submit(fl,false,this.success_callback,this.handleAjaxFailure,T)};i.prototype.on_cancel_button_click=function(fl){var T;fl.preventDefault();T=this.get_form();if(T.hasClass("approve_transfer_to_suspended")){this.reset_button_click(this.$confirm_button,this.on_confirm_button_click);return this.reset_button_click(this.$cancel_button,this.on_cancel_button_click)}else{return i.__super__.on_cancel_button_click.apply(this,arguments)}};i.prototype.reset_button_click=function(T,fl){T.off("click");if(fl!=null){return T.on("click",fl)}};i.prototype.checkAndApproveMemberRemoval=function(fm){var T,fl;if(!bF("#deactivate_option").is(":checked")&&bF("#transfer_files_on").is(":checked")&&!this.invited){T=bF(".tokenized_autocompleter_container .token-display-text");fl=bF(".tokenized_autocompleter_container .token-suspended");if(T.length&&fl.length){this.set_modal_class("approve_transfer_to_suspended");this.$modal_window.find(".target_user_name").text(T.text());this.$confirm_button=this.get_confirm_button();this.reset_button_click(this.$confirm_button,(function(fn){return function(fo){return fn.execute_form()}})(this));this.$cancel_button=this.get_cancel_button();this.$cancel_button.on("click",fm);return}}return this.execute_form()};i.prototype._isTransferSelected=function(){return bF(this.transfer_choice_selector).prop("checked")};i.prototype._selectChange=function(T){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};i.prototype._tokenAdd=function(T){this.$collab_input.hide();if(T.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};i.prototype._tokenRemove=function(T){this.$collab_input.show();return this._clearInput()};i.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};i.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};i.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return i})(d7);fa=E.TwoFactorMessageModal=(function(j){fc(i,j);function i(){i.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}i.prototype.on_confirm_button_click=function(T){dU.send_team_security_message(T);return this.hide()};return i})(d7);bu=E.DfeUnsuspendUserModal=(function(i){fc(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);j.__super__.constructor.call(this,T)}j.prototype.before_show=function(){var T;j.__super__.before_show.call(this);T=eA("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(T);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};j.prototype.success_callback=function(fl){var T;if((T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){T.refresh_member_stats()}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb("unsuspended"):void 0};j.prototype.on_confirm_button_click=function(fm){var T,fl;fm.preventDefault();fl=this.$modal_window.find(".dfe-unsuspend-modal")[0];T=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fl,false,this.success_callback,false,T)};return j})(d7);ee=E.DfeRemoveOrDeactivateUserModal=(function(j){fc(i,j);function i(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);this.handle_change_action=b3(this.handle_change_action,this);this.switch_to_uninvite_mode=b3(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=b3(this.switch_to_deactivation_mode,this);this.show_removal_content=b3(this.show_removal_content,this);this.show_deactivation_content=b3(this.show_deactivation_content,this);i.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")};i.prototype.set_form_action_to_deactivate=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/suspend_user")};i.prototype.set_form_action_to_remove=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};i.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};i.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};i.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};i.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};i.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};i.prototype.handle_change_action=function(T){T.preventDefault();if(bF("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};i.prototype.on_show=function(T){var fl;i.__super__.on_show.call(this);bF("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){fl=eA("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{fl=eA("Suspend or delete %(user_name)s").format({user_name:this.user_name});if(this.limited){bF("#deactivate_option").prop("disabled",true);bF("#delete_option").attr("checked","checked");this.switch_to_removal_mode()}else{bF("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}}this.$modal_window.find(".db-modal-title-text").text(fl);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};i.prototype.success_callback=function(T){var fl;if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}fl="";if(this.invited){fl="uninvited"}else{if(bF("#deactivate_option").is(":checked")){fl="suspended"}else{fl="deleted"}}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fl):void 0};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return i})(bJ);eZ=E.DfeRemoveUserModal=(function(i){fc(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);j.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}j.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-user-modal")};j.prototype.on_show=function(fl){var T,fm;j.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fm=eA("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fm=eA("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fm);if(this.num_api_apps){T=bd("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(T)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".transfer_files_option").remove();this.$modal_window.find(".remote_wipe_setting").remove();this.get_form().addClass("invited")}if(this.hide_transfer_setting){this.$modal_window.find(".transfer_files_option").remove()}if(this.hide_remote_wipe_setting){return this.$modal_window.find(".remote_wipe_setting").remove()}};j.prototype.success_callback=function(fn){var fo,fm,fl,T;T=JSON.parse(fn.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fm=window.active_team_member_table)!=null){fm.remove_user(this.user_id)}if((fl=window.removed_team_member_table)!=null){fl.add_users(T)}}fo="";if(this.invited){fo="uninvited"}else{fo="deleted"}dU.decrement_used_licenses();this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fo):void 0};j.prototype.switch_to_removal_mode=function(){return this.set_modal_class()};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return j})(bJ);eJ=E.ManageFilesModal=(function(j){fc(i,j);function i(fl,T,fm){this.source_user_id=fl;this.source_user_name=T;this.options=fm;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_manage_files=b3(this.switch_to_manage_files,this);this.success_callback=b3(this.success_callback,this);i.__super__.constructor.call(this,this.options,"input[name=file_action]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".manage-files-modal")};i.prototype.on_show=function(){var T;i.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);T=eA("Manage %(team_member)s's files").format({team_member:this.source_user_name});return this.$modal_window.find(".db-modal-title-text").text(T)};i.prototype.success_callback=function(fl){var T;T=JSON.parse(fl.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}if(bF("#move-files").prop("checked")){ah.success(eA("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ah.success(eA("Permanently deleted files"))}return this.hide()};i.prototype.switch_to_manage_files=function(){return this.set_modal_class("manage-files-modal")};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_manage_files)};return i})(bJ);cs=E.show_manage_files_modal=function(i,j){var T;T=new eJ(i,j,{element_id:"manage-files-modal",focus:".new-collab-input"});return T.show()};q=function(){var i;i=function(fl,T){var j,fm;bF(T).css("display","none");j=bF(T).closest("#user_generate_liveops_pin");fm=j.find(".user_generate_liveops_pin_value");fm.text(fl.pin);bF(T).addClass("liveops_pin_elem_invisible");return j.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dU.get_pin_with_user_id(null,this,i);return false};bF("#user_generate_liveops_pin_button").click(q);bh=function(){bF("#help_callus_title").hide();bF("#help_callus_details").show();return false};bF("#help_callus_trigger").click(bh);var bE;bE=E.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var b9;b9=E.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var a6;a6=E.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(j,T){var i;if(T==null){T=null}i=Object.clone(j);if(i.is_dir){i.ago="";i.ts=0}else{i.target_ns=false}i.sort_key=d6.decode_sort_key(i.sort_key);i.request_id=T!=null?T:null;return new cS(i)},filepreview_from_selected:function(fo,fn,fm,fl){var i,T,fp,j;if(fn==null){fn=false}if(fm==null){fm=false}if(fl==null){fl=Constants.BROWSE_UNKNOWN}if(fo.bytes<0||fo.preview_type==="download"){window.open(fo.href,"_blank");return}if(az.getGandalfRule("file-viewer-react")){T=this.getIndexOfFileInArray(ct.files,fo);e0.open(ct.files,T,ct.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewContext:aX.FileViewContextType.PRIVATE})}else{j=eD.get_url();fp=eD.deconstruct_url(j);i=j.indexOf("/s/")===0;n.show(fo,ct.active_user,{files:ct.files,file_view_mode:aX.FileViewModeType.BROWSE,should_focus_comment_input:fm},fl);if(!(fn||i||fp.qargs.preview===fo.filename)){n.set_preview_url()}}},profile_files:function(T){var fl,j,i,fm,fn;fm={files:0,folders:0,shared_folders:0,team_shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(j=0,i=T.length;j<i;j++){fl=T[j];if(fl.dir){fm.folders+=1}else{fm.files+=1}if(fl.is_sandbox()){fm.sandboxes+=1}if(fl.is_shared_folder()){fm.shared_folders+=1}if(fl.is_team_shared_folder()){fm.team_shared_folders+=1}if(fl.bytes===-1){fm.deleted+=1}if(fl.target_ns){fm.target_namespaces+=1}if(fl.fq_path.toLowerCase()==="/public"&&ct.public_folder_enabled){fm.public_folder=1}if(fl.in_root_coll){fm.in_root_coll+=1}if(fl.compressible){fm.compressible_count+=1}if(!((fn=ct.permanent_delete_is_disabled_by_ns_id)!=null?fn[fl.ns_id]:void 0)){fm.can_permanently_delete+=1}}return fm},profile_summary:function(j){var T,i;T=bd("%d file","%d files",j.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.files);i=bd("%d folder","%d folders",j.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.folders);if(j.files&&j.folders){return eA("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:T,y_folders:i})}else{if(j.files){return T}else{if(j.folders){return i}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fp,fn,fl,T,j,i,fo,fm;fp=bF("#browse");fl=fp.find("#browse-root-actions");T=fp.find("#browse-sort");fn=fp.find("#browse-header-status");fm=this.SPECIAL_MODES;for(j=0,i=fm.length;j<i;j++){fo=fm[j];fp.removeClass(fo);fl.removeClass(fo);T.removeClass(fo);fn.removeClass(fo)}cb.reset_fulltext_search(true);fp.removeClass("fulltext_search");fl.removeClass("fulltext_search");T.removeClass("fulltext_search");fn.removeClass("fulltext_search");bF("#fulltext-search-loading").hide();return bF("#fulltext-search-all-link").hide()},set_special_mode:function(fp){var T,fm,fq,i,fl,fo,fn,j;T=bF("#browse");fq=T.find("#browse-root-actions");i=T.find("#browse-sort");fm=T.find("#browse-header-status");cL(this.SPECIAL_MODES.indexOf(fp)!==-1,"unknown mode");j=this.SPECIAL_MODES;for(fl=0,fo=j.length;fl<fo;fl++){fn=j[fl];if(fn!==fp){T.removeClass(fn);fq.removeClass(fn);i.removeClass(fn);fm.removeClass(fn)}}T.addClass(fp);fq.addClass(fp);i.addClass(fp);fm.addClass(fp);if(fp===this.SEARCH_MODE){T.addClass("fulltext_search");fq.addClass("fulltext_search");i.addClass("fulltext_search");return fm.addClass("fulltext_search")}},get_mode:function(){var T,j,fm,fl,i;i=this.BROWSE_MODE;fl=this.SPECIAL_MODES;for(T=0,j=fl.length;T<j;T++){fm=fl[T];if(bF("#browse").hasClass(fm)){i=fm}}return i},load_visible_thumbs:function(){var fv,fx,fn,fs,fy,fz,fw,fm,fr,fp,fo,ft,fq,T,fl,fu;fm=this.get_files_in_view();fx=fm[1]-fm[0];fw=[Math.max(fm[0]-fx,0),fm[0]];fz=[Math.min(fm[1],ct.files.length),Math.min(fm[1]+fx,ct.files.length)];fv=[];fl=[fm,fz,fw];for(fp=0,ft=fl.length;fp<ft;fp++){fy=fl[fp];fs=fy[0],fr=fy[1];fu=ct.files.slice(fs,+fr+1||9000000000);for(fo=0,fq=fu.length;fo<fq;fo++){fn=fu[fo];if(fn.get_div()){fv.push(fn.get_div().down("img"))}}}T=function(i){if(!i.src.endsWith(cx.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bs.batch_load_thumbs(fv,this.THUMBS_BATCH_SIZE,T)},get_files_in_view:function(){var fq,fn,fs,fo,fp,fm,T,ft,fr,fl,fu;T=[0,ct.files.length-1];fl=C.viewport_dimensions().height;fu=C.scroll_offsets().top;fm=this._get_elm_height();if(!fm){return T}fq=bF("#browse-files");fo=parseInt(fq.css("padding-top"),10);if(!fq.length||isNaN(fo)){return T}if(bF("body").hasClass("absolutize")){fn=fq.offset().top+fo;fs=fn-fu;if(fs>0){ft=0;fp=fl-fs;fr=fp/fm}else{ft=Math.abs(fs/fm);fr=Math.abs(fl-fs)/fm}}else{ft=fu/fm;fp=fl-fo;fr=(fp+fu)/fm}ft=Math.max(Math.floor(ft),0);fr=Math.min(Math.floor(fr),ct.files.length-1);return[ft,fr]},_get_elm_height:function(){var j,i;if(ct.files.length>=3&&ct.files[1].get_div()){j=bF(ct.files[1].get_div());i=j.outerHeight()+parseInt(j.css("margin-bottom"))+parseInt(j.css("margin-top"));return i}else{return null}},append_ellipsis:function(i){return eA("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:i})},getIndexOfFileInArray:function(fo,fn){var fm,fl,T,j,i;i=-1;for(fl=T=0,j=fo.length;T<j;fl=++T){fm=fo[fl];if(fm.sjid===fn.sjid){i=fl}}return i}};var bq;bq=E.Sort=(function(){var fo,i,fl,fn,fm,T,j;fl=function(fq){var fp;fp=fq?1:-1;return function(fr,fs){return fp*d6.sort_by_rank_or_key(fr,fs)}};fn=function(fq){var fp;fp=fq?1:-1;return function(fr,fs){if(fr.bytes>fs.bytes){return fp}else{if(fr.bytes<fs.bytes){return -fp}else{return fp*bq.FILES_BY_NAME(fr,fs)}}}};fo=function(fq){var fp;fp=fq?1:-1;return function(fr,fs){return fp*(fr.fq_path.toLowerCase()>fs.fq_path.toLowerCase()?1:-1)}};i=function(fq){var fp;fp=fq?1:-1;return function(fs,ft){var fr;fr=fs.ts===ft.ts?0:fs.ts>ft.ts?1:-1;return fp*fr}};T=function(fp){return function(fs){var fr,fq;fq=fp(fs);fr=fl(true);return function(ft,fu){if(ft.dir^fu.dir){return(ft.dir?1:0)-(fu.dir?1:0)}else{return fq(ft,fu)||fr(ft,fu)}}}};fm=function(fp){return function(fs){var fq,fr;if(!bq.FOLDERS_FIRST){return fp(fs)}fr=fp(fs);fq=fs?1:-1;return function(fu,fv){var ft;if(fu.dir^fv.dir){ft=(fu.dir?0:1)-(fv.dir?0:1);return fq*ft}else{return fr(fu,fv)}}}};j=function(fp){return function(fs){var fq,fr;fr=bq.FILES_BY_NAME(fs);fq=fs?1:-1;return function(fu,fv){var ft;if(fu.is_deleted^fv.is_deleted){return(fu.is_deleted?1:0)-(fv.is_deleted?1:0)}ft=0;if(fp){if(fu.get_category()!==fv.get_category()){ft=fu.get_category()<fv.get_category()?-1:1}else{if(fu.get_extension()!==fv.get_extension()){ft=fu.get_extension()<fv.get_extension()?-1:1}}}else{if(fu.get_extension()!==fv.get_extension()){ft=fu.get_extension()<fv.get_extension()?-1:1}else{if(fu.get_category()!==fv.get_category()){ft=fu.get_category()<fv.get_category()?-1:1}}}return(fq*ft)||fr(fu,fv)}}};return{FILES_BY_NAME:fm(fl),SHARED_WITH:fm(fl),FILES_BY_SIZE:T(fn),FILES_BY_LOCATION:T(fo),FILES_BY_KIND:T(j(true)),FILES_BY_EXTENSION:T(j(false)),FILES_BY_MODIFIED:T(i),FOLDERS_FIRST:!d6.is_mac(),ALL_BY_MODIFIED:i}})();var ds,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};ds=E.FlexColumn=(function(){var fq,fo,T,fp,fn,fl,fm,j;fq=[{label:"SHARED_WITH",func:bq.FILES_BY_NAME,display:eA("Shared With"),is_asc:true},{label:"FILES_BY_KIND",func:bq.FILES_BY_KIND,display:eA("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bq.FILES_BY_EXTENSION,display:eA("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bq.FILES_BY_SIZE,display:eA("Size"),is_asc:false}];fo={};T={};fn=[];fp=[];for(fm=0,j=fq.length;fm<j;fm++){fl=fq[fm];fn.push(fl.func);fo[fl.label]=fl.display;T[fl.label]=fl.is_asc;fp.push(fl.label)}return{SORT_FUNCTIONS:fn,DISPLAY:fo,IS_ASC:T,LABELS:fp,has_label:function(i){return cT.call(this.LABELS,i)>=0},has_sort:function(i){return cT.call(this.SORT_FUNCTIONS,i)>=0},next:function(fr){var i;i=ds.LABELS.indexOf(fr)+1;if(i===ds.LABELS.length){i=0}return fq[i]}}})();var cb;cb=E.FileSearch={MAX_RESULTS:100,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(i,j){this.firefly_enabled=i;return this.fulltext_search_enabled=j},get_state:function(){var i;i={};i.query_unnormalized=this.get_basic_query();i.query=i.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");i.last_fq_path=this.last_fq_path!=null?this.last_fq_path:"";return i},set_state:function(i){this.last_fq_path=i.last_fq_path!=null?i.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";ct.inside_dir=this.scoped_search;this.set_basic_query(i.query_unnormalized);return this.do_search(false,true)},state_changed:function(){var j,i;j=this.get_state();i=this.last_state;if(i===false){return !!j.query}return(j.query!==i.query)||(j.last_fq_path!==i.last_fq_path)},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(i){if(i===this.get_basic_query()){return}return this._get_browse_search_input().val(i)},set_title:function(){var i,j;i=this.get_state();j=eA("Search - Dropbox");if(i.query_unnormalized){j=i.query_unnormalized+" - "+j}return document.title=j},_set_scope_path_to_browse_location:function(){if(ct.inside_dir){return this.last_fq_path=ct.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(T,i){var fm,fn,fl,j;if(i==null){i=false}if(typeof ct.entered_search==="function"){ct.entered_search()}j=!i&&!ct.in_search_mode();if(j){this._set_scope_path_to_browse_location()}fl=this.get_state();fn=""===this.get_basic_query();if(fn){if(ct.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=fl;this._clear_on_reload=true;eW.deselect_all();ct.clear();a6.set_special_mode("search");this.scoped_search=this.last_fq_path!=="";if(!i){fm=null;eD.push_state("/search/"+ct.active_user.role,fl)}this.set_title();this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bF("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",T,0,this.MAX_RESULTS,false);return eI("search")},search:function(i){if(i==null){i=false}if(i!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&i;if(!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var i;if(!this.end_of_results){i=this.search_pos;if(this.end_of_active_results){i=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,i,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},update_empty:function(){var i;i=eA("No results found");if(this.scoped_search){i=eA("No results found in '%(path)s'").format({path:aA.filename(this.last_fq_path)})}bF("#noresults-header").text(i);bF("#fulltext-search-all-link").hide();bF("#noresults-directions").toggle(!this.scoped_search);return bF("#noresults-search-all-link").toggle(this.scoped_search)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(i){eW.deselect_all();ct.clear();ct.reset_state();ct.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=i;return bF("#fulltext-search-all-link").hide()},exit_search:function(){var i;if(ct.in_search_mode()){i=[ct.inside_deleted_dir,ct.inside_deleted_sandbox,ct.inside_deleted_shared_folder];if(!bx.any(i)){ct.deleted_shown=false}}$("browse").removeClassName("pending-search");this.hide_empty();return a4.set_path_url(null,this.last_fq_path,ct.deleted_shown)},force_reload:function(){return this.search()},ask_server:function(j,fo,T,fp,fm){var fn,fs,fq,fl,fr,i;i=this.get_state();fr=null;fl=new Date();if(fm){fr=eC.DELETED}else{if(fo){fr=eC.COMPLETION}else{fr=eC.FULLTEXT}}fn={firefly:this.firefly_enabled,infinite_scroll:T>0?true:false,path_scoped:false,search_type:fr,query_string:i.query};ba.SearchClientActivityLogger.log("query_started",ct.active_user.id,fn);if(!T){bF("#web-search-results").html(eA("Searching..."))}bF("#browse").addClass("pending-search");fs={query:i.query};if(T){fs.start=T}if(fp){fs.max_results=fp}if(fm){fs.deleted=fm}if(this.scoped_search){fs.fq_path=this.last_fq_path}if(!fo){this.last_fulltext_query=i.query}if(fo){fs.filename_only=true}fq=false;return new Ajax.DBRequest(j,{no_watch:true,evalJSON:false,parameters:fs,log_timing:true,onSuccess:(function(ft){return function(fw){var fx,fu,fv,fz,fy;if(!ct.in_search_mode()){return}fz=fw.request.parameters.parent_request_id;fx=JSON.parse(fw.responseText);fy=fx.file_info.length;if(i.query===ft.last_fulltext_query&&fl>=ft.last_new_search_ts){ft.search_pos=ft.search_pos+fy;if(ft.end_of_active_results){ft.deleted_search_pos=ft.deleted_search_pos+fy}if(fy<ft.MAX_RESULTS){ft.end_of_results=true&&ft.end_of_active_results;ft.end_of_active_results=true;if(!ft.end_of_results){fq=true}else{bF("#fulltext-search-loading").hide()}}ft.update_results(fx,fq,fz)}if(fx.file_info.length>0){fu=fx.file_info[0]}else{fu=null}fn=ba.SearchClientActivityLogger.create_completion_log_dict(fn,fz,fw.request.start_time,i.query,i.query===((fv=ft.last_state)!=null?fv.query:void 0),fy,null,fu);return ba.SearchClientActivityLogger.log("query_completed",ct.active_user.id,fn)}})(this),onFailure:(function(ft){return function(fv){var fu;fn=ba.SearchClientActivityLogger.create_completion_log_dict(fn,fv.request.parameters.parent_request_id,fv.request.start_time,i.query,i.query===((fu=ft.last_state)!=null?fu.query:void 0),null,fv.status);return ba.SearchClientActivityLogger.log("query_failed",ct.active_user.id,fn)}})(this),cleanUp:(function(ft){return function(){if(fq){return ft.load_more_results()}else{return bF("#browse").removeClass("pending-search")}}})(this),subject_user:ct.active_user})},update_results:function(j,i,fl){var T;if(i==null){i=false}if(fl==null){fl=null}T=this.get_state();ct.update(j,fl);ct.set_selection_from_fq_paths_or_index(cb);if(!i){this._update_number_results(this.search_pos);if(ct.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(j){var i,T;if(j===0){i=""}else{if(this.end_of_results){i=this.fulltext_search_enabled?bd("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",j).format({num_results:j})}else{i=this.fulltext_search_enabled?bd("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",j).format({num_results:j})}}T=eA("Search")+" - "+i;ct.update_header_status(i);T=eA("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){T=eA("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:aA.filename(this.last_fq_path+"'")})}bF("#web-search-results").text(T);if(this.scoped_search){return bF("#fulltext-search-all-link").show()}},history_change_handler:function(i,fl){var fm,j,T;j=typeof this._get_browse_search_input().find("input").attr("value")==="string";T=j&&!this.is_loaded;if(fl){this.last_state=fl}if(!this.last_state){a4.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||T){this.set_state(this.last_state)}if(!n.shown()){key.setScope(ct.KEY_SCOPE)}if(eW.get_selected_files().length){fm=eW.get_selected_files()[0].get_div();ct.scrollToWithPadding(fm,fm.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bF("#browse-search-input")}};var en;en=E.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var T,i,j;j=this.advanced_dict;for(i in j){T=j[i];key(T.key,ct.KEY_SCOPE,T.onPress)}this.customize_chart();if(d6.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(fl){return function(fm){if(fm.charCode===63&&!C.focus_in_input()){return fl.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var fm,j,fl,T;fm=(d6.is_mac()?".key-windows":".key-macos");fl=0;j=void 0;T=[];while(true){j=$("keys-chart").down(fm,fl++);if(!j){break}T.push(j.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var i,j;i=$("keys-chart");i.style.position="fixed";j=$("browse-sort");if(ct.in_search_mode()){j=$("browse-header-wrapper")}else{if(j.getStyle("display")==="none"){j=$("browse-root-actions")}}bF(i).clonePosition(bF(j),{setHeight:false});i.style.top=j.cumulativeOffset()[1]+j.getHeight()+"px";i.setOpacity(0.9);return i.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:eA("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(j,T){var i;i=eW.get_selected_files();if(i.length){return i.first().edit()}}},"delete":{title:eA("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(fl,fm){var i,T,j;Event.stop(fl);if(ct.inside_read_only_shared_folder){ah.warning(eA("You don't have permission to delete files in this folder."))}j=eW.get_selected_files();if(j.length===1){i=j.first();if(i.is_deleted){return dD.show_purge(i.fq_path,i.dir)}else{return dD.show_delete(ct.active_user,i.fq_path,i.dir)}}else{if(j.length>1){T=a6.profile_files(j);if(T.deleted===j.length){return dD.show_bulk_purge(j)}else{if(T.deleted===0){return dD.show_bulk_delete(ct.active_user,j)}}}}}},help:{title:eA("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return en.toggle_chart()}},close_help:{title:eA("Hide keyboard shorcuts"),key:"escape",onPress:function(){return en.hide_chart()}},up_dir:{title:eA("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var i,j;ct.keyboard_nav=true;if(!ct.reloading){if(ct.inside_dir){if(!ct.containing_ns_path()&&ct.containing_ns_id()!==Constants.root_ns){j=Constants.root_ns;i=aA.normalize(aA.parent_dir(ct.containing_fq_path()))}else{j=ct.containing_ns_id();i=aA.normalize(aA.parent_dir(ct.containing_ns_path()))}if(ct.containing_ns_path()!==i||ct.containing_ns_id()!==j){ct.select_fq_paths=[ct.containing_fq_path()];return a4.set_path_url(j,i)}else{return eW.flicker_selected()}}else{return eW.flicker_selected()}}}},open_file:{title:eA("Open highlighted file"),key:"enter",onPress:function(){var i,j;j=eW.get_selected_files();if(j.length===1){i=j[0];ct.open_file(i,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:eA("Open highlighted folder"),key:"right",onPress:function(){var i,j;ct.keyboard_nav=true;j=eW.get_selected_files();if(j.length===1){i=j[0];if(i.dir){ct.select_index=0;ct.open_folder(i)}else{eW.flicker_selected()}}return false}},undo:{title:eA("Undo recent move/copy/rename/delete"),key:(key.main_modifier())+"+z",onPress:function(){X.perform_undo();return false}},search:{title:eA("Search"),key:"/",onPress:function(){bF(document).trigger("db:searchbar:focus");return false}}}};var af;af=E.BrowseSharedLink={store_shared_link_info:function(T,i,j){if(T.charAt(0)==="/"){T=T.substring(1)}this._shared_link_fq_dir=T;this._shared_link_file=j;return this._shared_link_url=i},shared_link_handler:function(i,j){if(af._shared_link_url==="/s/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fi")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));ct.open_preview(af._shared_link_file)}else{if(af._shared_link_url==="/sh/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fo")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));if(af._shared_link_file){ct.open_preview(af._shared_link_file)}}else{location.reload()}}return af.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return a4.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(ct.active_user.role===Constants.ROLE_WORK){bF("#work-nav-item").addClass("selected");return bF("#personal-nav-item").removeClass("selected")}else{bF("#personal-nav-item").addClass("selected");return bF("#work-nav-item").removeClass("selected")}}};var a4;a4=E.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(i){var j;j=eD.deconstruct_url().qargs;if(i in j){return !!j[i]}else{cL(i in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[i]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(i,T){var j;if(i!==ct.active_user.root_ns&&(!(i in ct.ns_id_to_mount_point))){i=ct.active_user.root_ns}if(i===ct.active_user.root_ns){return T}else{j=ct.ns_id_to_mount_point[i];return j+T}},_make_url:function(i,fn,fo){var fp,fm,j,fl,T;if(fo==null){fo={}}if(!i){i=ct.active_user.root_ns}cL(typeof i==="number","expected ns_id as a number");cL(typeof fn==="string","expected explicit ns_path string");fp=this.ns_to_fq_path(i,fn);fl=G({path:fi.get_browse_root(ct.active_user)+fp});j=eD.deconstruct_url().qargs;for(fm in fo){T=fo[fm];if(fm in this._DEFAULTS&&!!T!==this._DEFAULTS[fm]){j[fm]=T}}for(fm in j){if(!(fm in this._DEFAULTS)){delete j[fm]}}return eD.construct_url(String(fl),j)},set_path_url:function(i,fn,fl){var fm,T,j;if(!i){i=ct.active_user.root_ns}else{T=parseInt(i,10);i=!isNaN(T)?T:Constants.root_ns}fn=aA.normalize(fn);j=fl!=null?this._make_url(i,fn,{d:fl?1:0}):this._make_url(i,fn);fm=eD.deconstruct_url(j);return eD.push_state(fm.path,fm.qargs)},set_del_url:function(i){var T,fl,j;j=eD.deconstruct_url();T=j.path;fl=j.qargs;if(i){fl.d="1"}else{delete fl.d}return eD.push_state(T,fl)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(i,fl,j){var fm,fn,T;if(j==null){j=false}key.setScope(ct.KEY_SCOPE);fl=aA.normalize(fl);T=false;if(!this._first_load){T=(!ct.inside_dir)||(fl!==this._last_ns_dir)||(i!==this._last_ns_id)||ct.in_search_mode()}fm=j!==ct.deleted_shown;ct.deleted_shown=j;if(this._first_load||T||fm){ct.reload(i,fl,true)}this._first_load=false;this._last_ns_dir=fl;this._last_ns_id=i;if(eW.get_selected_files().length){fn=eW.get_selected_files()[0].get_div();if(fn){return ct.scrollToWithPadding(fn,fn.getHeight()*2)}}},history_change_handler:function(fn,fo){var fl,fm,T,i,j;i=fo.ns;j=fo.d==="1";this.load_browse_view(i,fn,j);if(fo.preview!=null){fm="/"+G.encode(fo.preview);if(!!fn){fm="/"+fn+fm}fl=ct.find_file(G.decode(fm));if(fl!=null){if(az.getGandalfRule("file-viewer-react")){T=a6.getIndexOfFileInArray(ct.files,fl);return e0.open(ct.files,T,ct.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewContext:aX.FileViewContextType.PRIVATE})}else{if(!(n.shown()&&n.file===fl)){return ct.open_preview(fl,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}}else{ba.UserActivityLogger.log("web","browse_preview_does_not_exist");return eD.replace_state(fi.get_browse_root(ct.active_user))}}else{if(!az.getGandalfRule("file-viewer-react")&&n.shown()){return n.hide()}else{if(az.getGandalfRule("file-viewer-react")&&e0.isShown()){return e0.close()}}}},parse_b2_hash:function(fm){var T,j,fl,i,fn;i=fm.split(":");if(i.length!==4){return false}fl=i[0];T=i[2]==="1";j=i[3];fn=!j||d6.isNumber(j);if(!fn){return false}j=parseInt(j,10)||Constants.root_ns;return{ns_id:j,ns_path:fl,deleted:T}}};var cS;cS=E.BrowseFile=Class.create({initialize:function(fl){var T,fm,j,i;T=aA.filename(fl.fq_path);this.allows_nesting=fl.allows_nesting;this.icon=fl.icon;this.filename=T;this.filename_highlights=(fm=fl.filename_highlights)!=null?fm:[];this.unresolved_comment_count=fl.unresolved_comment_count;this.unseen_comment_count=fl.unseen_comment_count;this.update_caption();this.ns_id=fl.ns_id;this.ns_path=fl.ns_path;this.fq_path=fl.fq_path;this.mount_point=fl.mount_point;this.hash=fl.hash;this.href=fl.href;this.size=fl.size!=="None"?fl.size:"";this.bytes=fl.bytes;this.is_deleted=this.bytes===-1;this.ago=fl.ago;this.ts=fl.ts;this.dir=fl.is_dir?1:0;this.target_ns=fl.target_ns;this.sort_rank=fl.sort_rank;this.sort_key=fl.sort_key||[""];this.sjid=fl.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=fl.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=fl.large_thumbnail_url_tmpl;this.type=fl.type;this.preview_type=fl.preview_type;if(fl.last_modified_fname){this.last_modified_fname=bU.em_snippet(fl.last_modified_fname,cV)}this.htmlified_link=fl.htmlified_link;this.linkfile_link=fl.linkfile_link;this.direct_blockserver_link=fl.direct_blockserver_link;this.doc_preview_status=fl.doc_preview_status;this.in_root_coll=fl.in_root_coll;this.compressible=fl.compressible;this.user_id=fl.user_id;this.sf_perm_role=fl.sf_perm_role;this.fulltext_search=fl.fulltext_search;this.read_only=fl.read_only?true:false;this.is_read_only_mount=fl.is_read_only_mount?true:false;this.request_id=(j=fl.request_id)!=null?j:null;return this.match_type=(i=fl.match_type)!=null?i:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cS._file_index)){ct.add_file(this);return cS._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b9.SHARED_FOLDER||this.type===b9.TEAM_SHARED_FOLDER},is_team_shared_folder:function(){return this.type===b9.TEAM_SHARED_FOLDER},could_be_shared_folder:function(){var T,fl,i,j;fl=ct.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");j=ct.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";i=this.target_ns;T=this.ns_id!==Constants.root_ns;return this.type===b9.FOLDER&&!i&&!fl&&!j&&!this.is_sandbox()&&(!T||(ct.golden_gate_aware&&this.allows_nesting&&!ct.inside_read_only_shared_folder))},is_sandbox:function(){return this.type===b9.SANDBOX},video_transcode_url:function(){return bt.video_transcode_url(this.fq_path,this.hash,ct.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fm,fo,T,fl,fn,fp){var fq,i,j;i=this.fq_path;ct.pre_action_selection=[i];fq=ct.find_file(fm);if(fq){ct.remove_file(fq)}this.filename=aA.filename(fm);this.update_caption();this.fq_path=fm;this.ns_path=fo;this.htmlified_link=fp;this.hash=T;this.sort_key=fl;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){j=this.href.split("/");j[j.length-1]=d6.urlquote(this.filename)+("?w="+T);this.href=j.join("/");this.icon=fn}else{this.href="/home"+d6.urlquote(fm);if(this.target_ns){ct.ns_id_to_mount_point[this.target_ns]=fm}}if(ct.in_search_mode()){this.filename_highlights=[]}cS._file_index[this.to_key()]=this;ct.update_file_pos(this);return bF(document).trigger(aH.RENAME,{old_fq_path:i,file:this})},edit:function(){var T,i,fl,j,fm;this.editing=true;ct.selectable();fm=(function(fn){return function(fv){var fp,fo,fs,fx,fu,fr,fy,fw,ft,fq;fq=fv.responseText.evalJSON(true);cL(fq.new_browse_files.length===1,"No new file data returned.");fs=fq.new_browse_files.first();fx=fs.fq_path;fu=fs.hash;ft=d6.decode_sort_key(fs.sort_key);fy=fs.icon;fw=fs.ns_path;fr=fs.htmlified_link;fp=fq.changesets;fo=eA("Rename complete.");X.notifyWithUndo(fo,fp,dD.do_rollback);fn.rename(fx,fw,fu,ft,fy,fr);eW.set_selected_files([fn]);fn.get_div().smoothScrollIntoView();a6.load_visible_thumbs();return ct.fire_visible_change_callbacks()}})(this);i=G({path:"/cmd/rename"+this.fq_path}).updateQuery(a9.UID_PARAM_NAME,ct.active_user).toString();fl=ct.in_search_mode()?".filename-col":".filename-col a";T=new Ajax.InPlaceEditor(this.get_div().down(fl),i,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(fn){return function(){return fn.editing=false}})(this),onFailure:function(){},savingText:eA("Saving..."),ajaxOptions:{job:true,subject_user:ct.active_user,html_in_error_msg:true,progress_text:eA("Renaming..."),method:"POST",onCreate:ah.clear,onSuccess:fm,onUninitialized:ct.unselectable},callback:(function(fn){return function(fo,fp){return{to_path:fp||"",folder:(fn.dir?"yes":"")}}})(this)});T.enterEditMode();j=this.get_div().down(".editor_field");if("selectionEnd" in j&&this.filename.lastIndexOf(".")>-1){return j.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return this.ns_id+"_"+this.sjid},get_category:function(){var j,i;if(this.dir){if(ct.inside_dir&&ct.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&ct.public_folder_enabled){j="PUBLIC_FOLDER"}}if(j==null){if(this.type===b9.FOLDER){j="FOLDER"}else{if(this.type===b9.PACKAGE){j="FOLDER"}else{if(this.type===b9.TEAM_SHARED_FOLDER){j="TEAM_SHARED_FOLDER"}else{if(this.type===b9.SHARED_FOLDER){j="SHARED_FOLDER"}else{if(this.type===b9.SANDBOX){j="SANDBOX"}else{if(this.target_ns){j="SHARED_FOLDER"}else{j="FOLDER"}}}}}}}}if(j==null){j=cS.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}i=this.is_deleted?cS.CATEGORY_TO_DELETED_TRANSLATION[j]:cS.CATEGORY_TO_TRANSLATION[j];cL(i,"CATEGORY MISSING FOR "+j);return i},get_icon_alt:function(){if(this.dir){if(this.is_shared_folder()){if(this.is_team_shared_folder()){if(this.is_read_only_mount){return eA("Read-only team folder")}else{return eA("Team folder")}}else{if(this.is_read_only_mount){return eA("Read-only shared folder")}else{return eA("Shared folder")}}}else{if(this.is_read_only_mount){return eA("Read-only folder")}else{return eA("Folder")}}}else{return""}},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return aA.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&ct.is_shmodelable_path(this.fq_path)},update_caption:function(){var i;i=ct.inside_dir?dp:cm;if(this.unresolved_comment_count>0){i-=aL}return this.caption=bU.em_snippet(this.filename,i)}});cS._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cS.EXTENSION_TO_CATEGORY={};cS.CATEGORY_TO_TRANSLATION={FILE:eA("file"),FOLDER:eA("folder"),SHARED_FOLDER:eA("shared folder"),TEAM_SHARED_FOLDER:eA("team folder"),PUBLIC_FOLDER:eA("folder"),IMAGE:eA("image"),VIDEO:eA("video"),AUDIO:eA("audio"),DOCUMENT:eA("document"),COMPRESSED_FILE:eA("archive"),CODE:eA("code"),DISK_IMAGE:eA("disk image"),EXECUTABLE:eA("executable"),SHORTCUT:eA("shortcut"),LINK:eA("link"),FONT:eA("font"),SANDBOX:eA("app folder")};cS.CATEGORY_TO_DELETED_TRANSLATION={FILE:eA("deleted file"),FOLDER:eA("deleted folder"),SHARED_FOLDER:eA("deleted shared folder"),TEAM_SHARED_FOLDER:eA("deleted team folder"),PUBLIC_FOLDER:eA("deleted folder"),IMAGE:eA("deleted image"),VIDEO:eA("deleted video"),AUDIO:eA("deleted audio"),DOCUMENT:eA("deleted document"),COMPRESSED_FILE:eA("deleted archive"),CODE:eA("deleted code"),DISK_IMAGE:eA("deleted disk image"),EXECUTABLE:eA("deleted executable"),SHORTCUT:eA("deleted shortcut"),LINK:eA("deleted link"),FONT:eA("deleted font"),SANDBOX:eA("deleted app folder")};(function(){var fl,fm,j,T,i;T=cS._CATEGORIES;i=[];for(fl in T){j=T[fl];i.push((function(){var fq,fp,fn,fo;fn=j.trim().split(" ");fo=[];for(fq=0,fp=fn.length;fq<fp;fq++){fm=fn[fq];fo.push(cS.EXTENSION_TO_CATEGORY[fm]=fl)}return fo})())}return i})();cS._file_index={};cS.from_key=function(i){return cS._file_index[i]};cS.from_elem=function(j){var i;if(!j){return}i=j.readAttribute("data-identity");if(i){return cS.from_key(i)}else{return cS.from_elem(j.up("[data-identity]"))}};var a,eH,aj,e8,bN,dG,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};a=INLINE_JS.BrowseActions=E.BrowseActions=Class.create({initialize:function(i){return this._set_files(i)},firefly_logging_helper:function(i){if(ct.in_search_mode()&&i){this._firefly_log_values.action_type=i;return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var i;i=this.get_files();if(i.length<2){return this._get_actions_single(i.first())}else{return this._get_actions_multi(i)}},get_files:function(){return this._files},get_action_by_name:function(i){return this.evaluate_action(a.option_dict[i],i)},evaluate_action:function(T,j){var fl,fm,i;fl=(function(fn){return function(fp,fo){if((fo!=null)&&(fp==null)){return fo}if(bF.isFunction(fp)){return fp.call(fn)}else{if(fp!=null){return fp}else{return fo}}}})(this);i={icon_href:T.icon_href,target:T.target,click_handler:T.click_handler,type:T.type,name:j||T.name,is_dropdown:!!T.is_dropdown,icon:fl(T.icon),text:fl(T.text),detail_text:fl(T.detail_text),href:fl(T.href,""),kind:fl(T.kind,"icon"),button_label:fl(T.button_label,T.text)};if(bF.isFunction(T.subactions)){i.subactions=T.subactions.call(this)}else{if(bF.isArray(T.subactions)){i.subactions=(function(){var fo,fn,fq,fp;fq=T.subactions;fp=[];for(fo=0,fn=fq.length;fo<fn;fo++){fm=fq[fo];fp.push(this.get_action_by_name(fm))}return fp}).call(this)}else{if(T.subactions){cL(0,"subactions must be a function or an array of actions")}}}return i},_set_files:function(j){var i;this._files=$A(j);this._log_extras={};if(this.get_files().length>0){i=j.first();this._log_extras={path:i.fq_path,ns_id:i.ns_id};return this._firefly_log_values={file_nsid:i.ns_id,file_sjid:i.sjid,firefly:cb.firefly_enabled,match_type:i.match_type,position:i.sort_rank,request_id:i.request_id,viewport:"full-view"}}},_get_actions_single:function(fC){var fo,fr,fs,fx,T,fq,fl,fD,fp,fw,fm,fn,fy,fz,fA,i,fv,ft,fB,fu;fr=[];if(!fC){return[]}fx=ct.public_folder_enabled&&fC.fq_path.toLowerCase().startsWith("/public/");fw=ct.public_folder_enabled&&fC.fq_path.toLowerCase()==="/public";fD=fC.target_ns;fs=fC.ns_id!==Constants.root_ns;fn=fC.type===b9.SHARED_FOLDER;fm=fC.type===b9.SANDBOX;fp=fC.type===b9.PACKAGE;fl=fC.in_root_coll;fq=fC.compressible;if(fC.is_deleted){fr=fr.concat(["restore"]);if(!((i=ct.permanent_delete_is_disabled_by_ns_id)!=null?i[fC.ns_id]:void 0)){fr.push("purge")}}else{fu=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((fv=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fv.is_cached_and_locally_available(fC.ns_id,fC.ns_path):void 0);fA=fu?"open":"download";if(fC.dir){if(fm){fr.push("app_info")}else{if(ct.simple_sharing_enabled){fr.push("share_folder_and_token")}else{if(fn){fr.push("sharing_options")}else{if(!(fs||fD||fx||fw)){fr.push("share")}}}}if(fC.is_shmodelable()&&!ct.simple_sharing_enabled){fr.push("token_share")}fr.push(fA);if(!fw){fr=fr.concat(["delete","rename","move"]);if(!(fp||fD)){fr.push("copy")}}if(ct.can_use_photos_features){if(ct.can_use_photos_features){fr.push("album_from_folder")}}}else{if(fx||ct.public_app_token){fr.push("copy_url")}else{if(ct.simple_sharing_react_member_list_enabled){fr.push("share_folder_and_token")}else{if(fC.is_shmodelable()){fr.push("token_share")}}}fr.push(fA);if(ct.can_show_preview(fC)&&ct.browser_supports_comments){fr.push("comment")}fr=fr.concat(["delete","rename","move","copy","revisions"]);if(fl&&ct.can_use_photos_features){if(ct.photos_experience==="carousel"){fr.push("view_in_carousel")}else{fr.push("view_in_photos")}}if(fq){fr.push("compress")}}if(!ct.simple_sharing_enabled){fB=false;ft=["sharing_options","share","token_share"];for(fy=0,fz=ft.length;fy<fz;fy++){fo=ft[fy];T=fr.indexOf(fo);if(T>-1){fr.splice(T,1);fB=true}}if(fC.is_shared_folder()||fC.could_be_shared_folder()){fr.unshift("single_entry_share_dropdown_variant_menu")}else{fr.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return fr},_get_actions_multi:function(fl){var i,j,T;if(Constants.send_a_copy_enabled){i=["send_copy","download"]}else{i=["download"]}i=i.concat(["delete","move","copy","restore","purge"]);if(ct.photos_experience==="carousel"){i.push("view_in_carousel")}else{i.push("view_in_photos")}j=a6.profile_files(fl);if(j.deleted>0||j.public_folder>0){i.removeItem("move");i.removeItem("copy");i.removeItem("delete")}if(j.shared_folders>0){i.removeItem("copy")}if(j.deleted>0){i.removeItem("send_copy");i.removeItem("delete");i.removeItem("download")}if(!ct.inside_dir){i.removeItem("download")}if(!(j.deleted===fl.length&&(j.shared_folders===0||((j.shared_folders===(T=fl.length)&&T===1))))){i.removeItem("restore")}if(!(j.deleted===fl.length&&j.can_permanently_delete===fl.length)){i.removeItem("purge")}if(j.in_root_coll!==fl.length||!ct.can_use_photos_features){i.removeItem("view_in_photos");i.removeItem("view_in_carousel")}return i},_show_appropriate_sharing_modals:function(j,i){var T;if((ct.simple_sharing_enabled&&j.dir)||ct.simple_sharing_react_member_list_enabled){if(d4.get_for_user(ct.active_user).verified_or_show()){eF.createAndShowInbandModalFromBrowseFile(ct.active_user,j)}return}if(j.is_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,ct.active_user)}else{if(j.could_be_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,ct.active_user)}else{ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cL(T,"token_share: expected non-root fq_path");return dx.shmodel(T,i+"_token_share")}}},get_disabled_action_names:function(){var T,fm,fl,i,fn;T=false;fn=this.get_files();for(fl=0,i=fn.length;fl<i;fl++){fm=fn[fl];T=true;if(!fm.read_only){T=false;break}}if(ct.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(i){if(ct.inside_read_only_shared_folder){if(i==="move"){return ah.warning(eA("You don't have permission to move files in this folder."))}else{if(i==="rename"){return ah.warning(eA("You don't have permission to rename files in this folder."))}else{if(i==="delete"){return ah.warning(eA("You don't have permission to delete files in this folder."))}else{if(i==="restore"){return ah.warning(eA("You don't have permission to restore files in this folder."))}else{if(i==="purge"){return ah.warning(eA("You don't have permission to permanently delete files in this folder."))}else{if(i==="upload"){return ah.warning(eA("You don't have permission to upload files into this folder."))}else{if(i==="new_folder"){return ah.warning(eA("You don't have permission to create a new folder in this folder."))}else{if(i==="compress"){return ah.warning(eA("You don't have permision to create a compressed file in this folder."))}else{return ah.warning(eA("You only have permission to view this folder."))}}}}}}}}}else{return ah.warning(eA("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(j){var i,T;fb.show(a6.append_ellipsis(eA("Copy public link")),dv.fromElm("copy-public-url"),{wit_group:"copy_public_link"});fb.onHide=function(){$("flash_copy_container").remove();delete fb.onHide;return fb.hide()};i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eA("Link copied to clipboard!"));return fb.hide()});i.css({zIndex:1001});T=$("modal-content").down("#public_url");cL(T,"Text element not found for copy pulic link");T.setValue(j);return T.select()},shortenPublicLink:function(){var i;d6.shorten_url($F("public_url"),a.updatePublicLink);i=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(i)},updatePublicLink:function(j){var i;$("public_url").setValue(j);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eA("Link copied to clipboard!"));return fb.hide()});return i.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:eA("New folder"),click_handler:function(i){return ct.new_folder()}},global_restore:{icon:"restore",text:function(){cL(ct.inside_deleted_dir,"Global restore from not a deleted dir");if(ct.inside_deleted_shared_folder){return a6.append_ellipsis(eA("Rejoin shared folder"))}else{if(ct.inside_deleted_sandbox){return eA("Restore app folder")}else{return eA("Restore folder")}}},click_handler:function(){var fl,fm,j,i,T;fl=ct.containing_fq_path();j=fl.toLowerCase();if(ct.inside_deleted_sandbox){cL(ct.old_path_to_ns_id[j],"Deleted sandbox missing nsid");return bi.restore_sandbox(ct.active_user,fl,ct.old_path_to_ns_id[j])}else{if(ct.inside_deleted_shared_folder){cL(ct.old_path_to_ns_id[j],"Deleted shared folder missing nsid");return s.show_rejoin_modal(ct.active_user,fl,ct.old_path_to_ns_id[j])}else{fm=G.parse(location.href).setFragment("").toString();i={prev:fm};i[a9.UID_PARAM_NAME]=ct.active_user;T=G({path:"/restore"+fl}).updateQuery(i);return window.location.href=String(T)}}}},restore:{icon:"restore",text:function(){var j,i;j=this.get_files();i=a6.profile_files(j);if(i.shared_folders===j.length){return a6.append_ellipsis(bd("Rejoin shared folder","Rejoin shared folders",j.length,{comment:"BUTTON"}))}else{return a6.append_ellipsis(eA("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var T,fo,j,fp,fn,i,fm,fl;fo=this.get_files();if(fo.length===0){}else{if(fo.length===1){T=fo.first();if(!T.is_deleted){return}fp=T.fq_path;j=fp.toLowerCase();if(T.type===b9.SANDBOX){cL(ct.old_path_to_ns_id[j],"Restore missing ns");bi.restore_sandbox(ct.active_user,fp,ct.old_path_to_ns_id[j])}else{if((fm=T.type)===b9.SHARED_FOLDER||fm===b9.TEAM_SHARED_FOLDER){cL(ct.old_path_to_ns_id[j],"Rejoin missing ns");s.show_rejoin_modal(ct.active_user,fp,ct.old_path_to_ns_id[j])}else{if(T.dir){fn=G.parse(location.href).updateQuery({select:T.filename});i={prev:String(fn)};i[a9.UID_PARAM_NAME]=ct.active_user;fl=G({path:"/restore"+T.fq_path}).updateQuery(i);window.location=String(fl)}else{dD.show_undelete(T)}}}}else{return dD.show_bulk_restore(fo,ct.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(ct.inside_shared_folder){return a6.append_ellipsis(eA("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(ct.containing_fq_path()===""){return a6.append_ellipsis(eA("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a6.append_ellipsis(eA("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(T){var j,i;T.preventDefault();if(ct.containing_fq_path()===""){return s.start_wizard_for_user(ct.active_user)}else{if(ct.simple_sharing_enabled){if(d4.get_for_user(ct.active_user).verified_or_show()){j=ct.inside_shared_folder&&!ct.containing_ns_path();i=j?ct.containing_ns_id():void 0;return eF.createAndShowInbandModal(ct.active_user,ct.containing_fq_path(),true,i,j,!ct.inside_shared_folder,ct.containing_sf_perm_role())}}else{if(ct.inside_shared_folder){return s.show_shared_folder_options_modal(ct.containing_mount_point(),ct.active_user)}else{return s.show_share_existing_modal(ct.containing_fq_path(),ct.active_user)}}}}},sharing_options:{icon:"rainbow_16",text:a6.append_ellipsis(eA("Shared folder options",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,ct.active_user)}},share:{icon:"rainbow_16",text:a6.append_ellipsis(eA("Invite to folder",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,ct.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a6.append_ellipsis(eA("Share",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();return this._show_appropriate_sharing_modals(j,i)}},revisions:{icon:"previous_versions",click_handler:function(){return window.location.href=dD.build_revisions_uri(this.get_files().first().fq_path,ct.active_user)},text:eA("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a6.append_ellipsis(eA("Share link",{comment:"BUTTON"})),click_handler:function(fl,i){var j,T;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cL(T,"token_share: expected non-root fq_path");return dx.shmodel(T,i+"_token_share")}},global_token_share:{icon:"s_link",text:a6.append_ellipsis(eA("Share link",{comment:"BUTTON"})),click_handler:function(j,i){ba.ShmodelUILogger.log("via-global-toolbar");return dx.shmodel(ct.containing_fq_path(),i+"_global_token_share")}},copy_url:{icon:"world_link",text:a6.append_ellipsis(eA("Copy public link",{comment:"BUTTON"})),click_handler:function(T){var j,i;j=this.get_files().first();if(ct.public_app_token){i="/spa/"+ct.public_app_token+j.ns_path}else{i="/u/"+ct.active_user.id+j.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new G({scheme:"https",authority:Constants.PUBSERVER,path:i})))}},download:{icon:"download",text:function(){return eA("Download",{comment:"BUTTON"})},click_handler:function(){var fm,fl,i,fo,fq,fp,fn,T,j;i=this.get_files();if(i.length===1&&!i[0].dir){fl=i.first();T=[Constants.protocol,Constants.BLOCK_CLUSTER,fl.fq_path,fl.hash],fp=T[0],fm=T[1],fq=T[2],fo=T[3];fn={w:fo,dl:1};j=G({scheme:fp,authority:fm,path:"/get"+fq,query:fn});return window.location=String(j.updateQuery(a9.UID_PARAM_NAME,ct.active_user))}else{return dD.do_bulk_download(i)}}},view:{href:function(){var fn,i,fl,T,fm,j;i=this.get_files().first();j=[Constants.protocol,Constants.BLOCK_CLUSTER,d6.urlquote(i.fq_path),i.hash],fm=j[0],fn=j[1],T=j[2],fl=j[3];return fm+"://"+fn+"/get"+T+"?w="+fl},icon:"page_white_magnify",text:eA("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return s.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:eA("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(i){return ct.toggle_deleted()},icon:"trash-can",text:eA("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(i){return ct.toggle_deleted()},icon:"trash-can-open",text:eA("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a6.append_ellipsis(eA("Copy",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_copy(i.fq_path,i.dir)}else{if(j.length>1){return dD.show_copy_bulk(j)}}}},move:{icon:"move_16",text:a6.append_ellipsis(eA("Move",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_move(i.fq_path,i.dir)}else{if(j.length>1){return dD.show_move_bulk(j)}}}},rename:{icon:"rename",text:eA("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a6.append_ellipsis(eA("Delete",{comment:"BUTTON"})),click_handler:function(fr){var fo,fn,T,fq,fp,fm,fs,fl;T=this.get_files();fs=T.length;if(fs>=1){fm=T[0].mount_point;if(fm){for(fq=fp=1,fl=fs;1<=fl?fp<fl:fp>fl;fq=1<=fl?++fp:--fp){if(T[fq].mount_point!==fm){fm="";break}}}if(fm){fo=aA.filename(fm)}else{fo=null}if(fs>1){return dD.show_bulk_delete(ct.active_user,T,fo)}else{if(fs===1){fn=T[0];return dD.show_delete(ct.active_user,fn.fq_path,fn.dir,void 0,fo,fn.is_shared_folder())}}}}},global_purge:{icon:"cancel",text:a6.append_ellipsis(eA("Permanently delete folder")),click_handler:function(){return dD.show_purge(ct.containing_fq_path(),true)}},purge:{icon:"cancel",text:a6.append_ellipsis(eA("Permanently delete",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_purge(i.fq_path,i.dir)}else{return dD.show_bulk_purge(j)}}},upload:{icon:"upload_16",text:a6.append_ellipsis(eA("Upload")),click_handler:function(i){return dD.show_upload()}},app_info:{icon:"application_double",text:a6.append_ellipsis(eA("Application info")),click_handler:function(i){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:eA("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:eA("More actions"),click_handler:function(){bN.show_secondary();return document.body.observe("click",bN.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return eA("View in Photos")},click_handler:function(){var i;i=this.get_files();return dD.do_bulk_photo_view(i,ct.photos_experience)}},compress:{icon:"s_photo",text:function(){return eA("Compress (experimental)")},click_handler:function(){var i;i=this.get_files();return dD.show_compress_bulk(ct.active_user,i)}},view_in_carousel:{icon:"s_carousel",text:function(){return eA("View in Timeline")},click_handler:function(){var i;i=this.get_files();return dD.do_bulk_photo_view(i,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return eA("Create album")},click_handler:function(){var j,i;j=this.get_files();i=j.first();return dD.create_album_from_folder(i.fq_path,i.filename)}},open:{icon:"open",text:function(){return eA("Open")},click_handler:function(){var i;i=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(i.ns_id,i.ns_path,i.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(j){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return eA("Comment",{comment:"BUTTON"})},click_handler:function(i){var j;j=this.get_files().first();return ct.open_preview(j,i,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a6.append_ellipsis(eA("Share")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("single_entry_share_click",i,j);return dx.shmodel(j.fq_path,i)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a6.append_ellipsis(eA("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(T,i){var j;j=this.get_files().first();return ba.ShmodelUILogger.log_with_target_file("single_entry_share_hover",i,j)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a6.append_ellipsis(eA("Invite people to collaborate")),click_handler:function(fn,i){var T,fl,fm,j;T=this.get_files().first();if(T.is_shared_folder()){if(d4.get_for_user(ct.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,T);fl=new dg(ct.active_user,T.fq_path);return fl.show()}}else{j=ct.verify_email_after_share_experiment_variant;fm=j&&j==="VERIFY_LAST";if(fm){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(j){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fm||d4.get_for_user(ct.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,T);fl=new cp(ct.active_user,{folder_name:T.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+ct.active_user.id,must_check_verified:fm});return fl.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a6.append_ellipsis(eA("Send link")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);return dx.shmodel(j.fq_path,i)}}}});aj=E.BrowseActionsContext=Class.create(a,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bF("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bF("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bF("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bF("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(fl,j){var T,i;T=j.readAttribute("data-value");if(cT.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}ba.TimeToFirstActionLogger.log(ct.active_user.id,T);this.firefly_logging_helper(T);i=a.option_dict[T];ba.BrowseActionsContextMenuLogger.log(this.get_files(),T);if(!i.is_dropdown||j.hasAttribute("submenu-index")){bn.hide()}fl.preventDefault();i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,fl,"browse_actions_context");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_options",ct.active_user,this._log_extra,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_share_existing",ct.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bF("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(i){return bF(i).removeClass("hover")},_enter:function(fl){var T,i,j;T=bF(fl.currentTarget).data("value");cL(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);return(j=i.hover_handler)!=null?j.call(this,fl,"browse_actions_context"):void 0},_over:function(i){if(bF(i.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bF(i.currentTarget).addClass("hover")}},_out:function(i){if(bF(i.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(j){return function(){return j._reset_submenu(i.currentTarget)}})(this),300)}}});eH=E.BrowseActionsBasic=Class.create(a,{initialize:function($super){var i;i=eW.get_selected_files();$super(i);this._render();return this._listen()},_listen:function(){var i;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eW.UPDATED_EVT,this.bound_update);document.observe(bn.SHOW_EVT,this.bound_disable);document.observe(bn.HIDE_EVT,this.bound_enable);i=$("browse-root-actions");i.stopObserving("click");return i.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eW.UPDATED_EVT,this.bound_update);document.stopObserving(bn.SHOW_EVT,this.bound_disable);document.stopObserving(bn.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eW.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(T){var j,i;i="#browse-root-actions #"+T+"_action_button";j=bF(i);j.addClass("disabled");return j.click((function(fl){return function(fm){fl.show_disabled_action_warning(T);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fL,fD,fG,ft,fK,fM,fN,fC,fF,fw,i,fn,fo,fr,fp,fH,fE,fA,fI,fs,fq,fJ,fm,fO,fz,T,fx,fv,fu,fy,fB,fl;fn=this.get_files();fG=this.get_action_names();if(!ct.simple_sharing_enabled){fu=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fH=0,fI=fu.length;fH<fI;fH++){fD=fu[fH];fp=fG.indexOf(fD);if(fp>-1){fG.splice(fp,1);break}}}fL=13.5;fF="";fo="";if(fn.length===1){fF=bU.em_snippet(fn[0].filename,fL);if(!fn[0].dir&&fn[0].bytes>=0){fo=fn[0].size}}else{if(1<fn.length){T=a6.profile_files(fn);fJ=[];if(T.files){fm=bd("%d file","%d files",T.files).format(T.files);fJ.push(fm)}if(T.folders){fm=bd("%d folder","%d folders",T.folders).format(T.folders);fJ.push(fm)}fF=d6.nice_list(fJ)}}fM=$("browse-root-actions");fK=fM.getLayout().get("width");fr=fM.getStyle("font-size");cL(fr.endsWith("px"),"Invalid font size "+fr);fr=parseInt(fr,10);fw=new bU(fF).length*fr;fy=new bU(fo).length*fr;fK-=fw+fy;fB=[];fv=[];fK-=30;for(fE=0,fs=fG.length;fE<fs;fE++){fO=fG[fE];fD=this.get_action_by_name(fO);fl=new bU(fD.text).length*fr;fN=fl+16+8+10+9;if(fK>fN){fB.push(fO)}else{if(fv.length===0){fz=fB.pop();fv.push(fz)}fv.push(fO)}fK-=fN}if(fv.length){fB.push("more_actions")}ft=(function(){var j,fP,fQ;fQ=[];for(j=0,fP=fB.length;j<fP;j++){fO=fB[j];fQ.push(this.get_action_by_name(fO))}return fQ}).call(this);if(fv.length){ft[ft.length-1].subactions=(function(){var j,fP,fQ;fQ=[];for(j=0,fP=fv.length;j<fP;j++){fO=fv[j];fQ.push(this.get_action_by_name(fO))}return fQ}).call(this)}fC=fg.tmpl("actions_bar_tmpl",{context:this,description:fF,filesize:fo,has_actions:!!fG.length,actions:ft,_:eA,Sprite:cx});$("browse-root-actions").__date(fC);i=this.get_disabled_action_names();fx=[];for(fA=0,fq=i.length;fA<fq;fA++){fD=i[fA];fx.push(this._disable_action(fD))}return fx},_click:function(fl,j){var T,i;T=j.readAttribute("data-value");cL(T);this.firefly_logging_helper(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);fl.preventDefault();ba.TimeToFirstActionLogger.log(ct.active_user.id,T);i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,fl,"browse_actions_basic");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",ct.active_user,this._log_extras,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",ct.active_user,this._log_extras,true)}}});Object.extend(eH,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});e8=E.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var i;if(!ct.inside_dir){return[]}i=[];if(!ct.inside_deleted_dir){i=i.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){i.push("global_share")}if(this._should_show_share_link()){i.push("global_token_share")}if(!Constants.can_see_trash){i.push((ct.deleted_shown?"hide_del":"show_del"))}}else{i=i.concat(["global_restore"])}return i},_should_show_shared_folder_options:function(){return !ct.is_in_subfolder_of_shared_folder()&&!ct.inside_sandbox},_should_show_share_link:function(){return ct.is_shmodelable_path(ct.containing_fq_path())}});bN=E.GlobalActionsBasic=Class.create(e8,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bn.SHOW_EVT,this._disable.bind(this));return document.observe(bn.HIDE_EVT,this._enable.bind(this))},_render:function(){var fl,fm,fq,fu,fv,fn,fr,i,T,fp,fo,ft,fs;fm=this.get_action_names();fs=fm.intersect(bN.STANDARD_ACTIONS);fo=fm.without.apply(fm,bN.STANDARD_ACTIONS);if(fo.length===1){fs=fm;fo=[]}if(fo.length){fs.push("more_global_actions")}ft=(function(){var fx,fw,fy;fy=[];for(fx=0,fw=fs.length;fx<fw;fx++){i=fs[fx];fy.push(this.get_action_by_name(i))}return fy}).call(this);fq=(function(){var fx,fw,fy;fy=[];for(fx=0,fw=ft.length;fx<fw;fx++){fl=ft[fx];if(fl.kind==="button"){fy.push(fl)}}return fy})();T=(function(){var fx,fw,fy;fy=[];for(fx=0,fw=ft.length;fx<fw;fx++){fl=ft[fx];if(fl.kind!=="button"){fy.push(fl)}}return fy})();fu=fg.tmpl("global_actions_tmpl",{context:this,standard_actions:fq.concat(T),secondary_actions:(function(){var fx,fw,fy;fy=[];for(fx=0,fw=fo.length;fx<fw;fx++){i=fo[fx];fy.push(this.get_action_by_name(i))}return fy}).call(this),Sprite:cx});$("global-actions").__date(fu);bF(document).trigger(dN.GA_RENDERED);fv=this.get_disabled_action_names();fp=[];for(fn=0,fr=fv.length;fn<fr;fn++){fl=fv[fn];fp.push(this._disable_action(fl))}return fp},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(T){var j,i;i="#global-actions #"+T+"_button";j=bF(i);j.addClass("disabled");return j.click((function(fl){return function(fm){fl.show_disabled_action_warning(T);return false}})(this))},_enable:function(){var fm,fn,T,i,fl;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");fn=this.get_disabled_action_names();fl=[];for(T=0,i=fn.length;T<i;T++){fm=fn[T];fl.push(this._disable_action(fm))}return fl},_click:function(fl,j){var T,i;T=j.readAttribute("data-value");cL(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);bN.hide_secondary();eW.deselect_all();fl.preventDefault();i.click_handler.call(this,fl,"global_actions_basic");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_share_button",ct.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_share_button",ct.active_user,this._log_extras,true)}}}});Object.extend(bN,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var i,j;j=$("secondary-actions");i=$("more_global_actions_button");j.show();return i.addClassName("down")},hide_secondary:function(){var i,j;j=$("secondary-actions");if(!j){return}i=$("more_global_actions_button");j.hide();return i.removeClassName("down")}});dG=E.GlobalActionsContext=Class.create(e8,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fl,j){var T,i;T=j.readAttribute("data-value");if(cT.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}this.firefly_logging_helper(T);i=a.option_dict[T];eW.deselect_all();if(!i.is_dropdown){bn.hide()}fl.preventDefault();i.click_handler.call(this,fl,"global_actions_context");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_right_click_share",ct.active_user,this._log_extras,true)}else{if(ct.inside_shared_folder){return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_options",ct.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_share",ct.active_user,this._log_extras,true)}}}}});var y;y=E.BrowseClipboard=(function(){var fq,fn,T,fo,fm,fs,fu,fp,j,i,fr,fl,ft;fq=0;fn=1;fm=[];T=null;ft=function(){var fy,fz,fx,fw,fv,fA;if(C.focus_in_input()){return}fx=eW.get_selected_files();if(fx&&fx.length){for(fw=0,fv=fx.length;fw<fv;fw++){fz=fx[fw];if(fz.bytes<0){ah.error(eA("Deleted files cannot be added to the clipboard"));return false}else{if(fz.target_ns){fA=eA("'%(filename)s' cannot be added to the clipboard");fA=fA.format({filename:fz.filename});ah.error(fA);return false}}}fm=fx;fy=fx.length;fA=bd("Added %d item to clipboard","Added %d items to clipboard",fy).format(fy);ah.success(fA);return true}};fs=function(){if(ft()){T=fq;return false}};fu=function(){if(ft()){T=fn;return false}};fp=function(fv){var fw;cL(typeof fv!=="undefined","BrowseClipboard _paste got an undefined path");if(fm.length){fw=T===fq?dD.do_bulk_copy:dD.do_bulk_move;fw(fm,fv);return true}};fl=function(fv){var fw;if(C.focus_in_input()||ct.in_search_mode()||ct.inside_deleted_dir){return}fw=fp(ct.containing_fq_path());if(fw){return false}};fo=function(){return fm=[]};i=function(fC){var fB,fz,fA,fy,fx,fv,fw;fA=fC.memo.files;for(fy=0,fv=fA.length;fy<fv;fy++){fz=fA[fy];for(fx=0,fw=fm.length;fx<fw;fx++){fB=fm[fx];if(fB.fq_path===fz.fq_path||fB.fq_path.startsWith(fz.fq_path+"/")){fo();return}}}};j=function(fv){cL((fv.memo.file!=null)&&(fv.memo.files==null));fv.memo.files=[fv.memo.file];return i(fv)};fr=function(){var fz,fx,fw,fv,fy;bF(document).on(aH.RENAME,(function(fA){return function(fB,fC){fB.memo=fC;return j(fB)}})(this));fy=[aH.DELETE,aH.MOVE];for(fx=0,fw=fy.length;fx<fw;fx++){fz=fy[fx];document.observe(fz,i)}fv=key.main_modifier();key(fv+"+c",ct.KEY_SCOPE,fs);key(fv+"+x",ct.KEY_SCOPE,fu);return key(fv+"+v",ct.KEY_SCOPE,fl)};return{init:function(){return fr()}}})();var eW,aE;eW=E.BrowseSelection=(function(){var fI,fO,fL,fH,fo,fn,fE,fJ,fw,fm,fN,fG,fA,fz,fq,fC,j,i,fv,fB,fP,fu,fs,fx,fr,fl,fp,fF,fD,T,fM,fK,ft,fy;fp=[];fH=null;fm=null;fJ=null;fn=[];fK=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eW.get_selected_files().invoke("get_div").findAll(function(fQ){return fQ}).invoke("addClassName","file-select");if(eW.get_selected_files().length===1){return eW.get_selected_files().invoke("get_div").findAll(function(fQ){return fQ}).invoke("addClassName","file-select-one")}};ft=function(){if(fJ){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(ct.in_search_mode()){return}return eW.get_selected_files().filter(function(fQ){return !fQ.editing}).invoke("get_div").findAll(function(fQ){return fQ}).invoke("writeAttribute","draggable","true")};fy=function(fQ){fQ.apply(null,$A(arguments).slice(1));return document.fire(eW.UPDATED_EVT)};fF=function(fS,fR){var fT,fQ;fQ=fp.length;fp=(fS instanceof cS?[fS]:$A(fS));if(fp.length!==fQ){eI("Selected",fp.length,"files")}fT=fR||fp.last();cL(!fT||fT instanceof cS,"Invalid anchor type"+fT);return fH=fT};fF=fF.wrap(fy);fI=function(fR,fQ){if(fR){fp.push(fR)}return fH=fQ||fR};fI=fI.wrap(fy);fs=function(fQ){var fR;fR=fp.indexOf(fQ);if(fR===-1){return}return fp.splice(fR,1)};fs=fs.wrap(fy);fx=function(){return fp=[]};fx=fx.wrap(fy);fD=function(fQ){fn=fQ;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fQ.invoke("get_div").findAll(function(fR){return fR}).invoke("addClassName","context-select")};j=function(fZ){var fW,fU,fT,fV,f2,fS,f1,f3,fQ,fY,f0,fX,fR;fX=$(fZ.target);f3=fX.match("li.browse-file")?fX:fX.up("li.browse-file");fW=fX.match("a")?fX:fX.up("a");fT=cS.from_elem(f3);if(fZ.isRightClick()||!f3||fW||f3.hasClassName("unselectable")){return}ct.keyboard_nav=false;if(fn.length){return}fS=d6.is_mac();if((fS&&fZ.metaKey)||(!fS&&fZ.ctrlKey)){if(fp.indexOf(fT)===-1){return fI(fT)}else{return fs(fT)}}else{if(fZ.shiftKey){fU=ct.files.indexOf(fH);fR=ct.files.indexOf(fT);f1=ct.files.indexOf(fp.last());fY=fp.slice(0);f2=f1<fU?-1:1;fV=fU;while(fV!==f1){fV+=f2;f0=fY.indexOf(ct.files[fV]);if(f0!==-1){fY.splice(f0,1)}}f2=fR<fU?-1:1;fV=fU;while(fV!==fR){fV+=f2;fQ=fY.indexOf(ct.files[fV]);if(fQ!==-1){fY.splice(fQ,1)}fY.push(ct.files[fV])}return fF(fY,fH)}else{return fF(fT)}}};i=function(fW){var fZ,fS,fT,fV,fY,fX,fR,fQ,fU;if(fW.isRightClick()||fn.length||d6.in_scrollbar(fW.pointerX())){return}fX=$(fW.target);if(Element.match(fX,"object")){fX=fX.parentNode}fU=["browse-box","context-menu-container","modal","modal-overlay"];fR=false;for(fT=0,fV=fU.length;fT<fV;fT++){fQ=fU[fT];if(fX.descendantOf(fQ)||fX.match("#"+fQ)){fR=true;break}}if(!fR){fF();return}fY=fX.match("li.browse-file")?fX:fX.up("li.browse-file");fS=cS.from_elem(fY);fZ=fX.match("[draggable]")||fX.up("[draggable]");if(fS&&!fZ){fm=fH;if(!fW.shiftKey){if(fS){fm=fS}else{if(fX.match("#browse-files")){fm=ct.files.last()}}}fJ=[];if(fW.metaKey||fW.ctrlKey){return fJ=eW.get_selected_files()}}};T=function(fS){var fR,fQ;fR=cS.from_elem(fC(fS));fS.preventDefault();if(!fR){return}fQ="browse_file_row";ba.ShmodelUILogger.log_with_target_file("token_share",fQ,fR);return dx.shmodel(fR.fq_path,fQ)};fC=function(fR){var fQ;fQ=$(fR.target);if(fQ.match("li.browse-file")){return fQ}else{return fQ.up("li.browse-file")}};fq=(function(fQ){return function(fX){var f0,fS,fT,fZ,fY,fR,fW,f1,fU,fV;fZ=fC(fX);fS=cS.from_elem(fZ);fX.preventDefault();if(!fS){return}fY="browse_file_row";fV=ba.ShmodelUILogger.get_target_item(fS);ba.ShmodelUILogger.log("single_entry_share",fY,fV);fT=ct.simple_sharing_enabled;fW=bF(fZ).find(".inline-share-button")[0];if(!ct.in_search_mode()){fW=bF(fZ).find(".sharing .inline-share-button")[0]}fU=fS.dir&&(fS.is_shared_folder()||fS.could_be_shared_folder());f0=d4.get_for_user(ct.active_user).verified_or_show();if(ct.simple_sharing_react_member_list_enabled&&f0){return eF.createAndShowInbandModalFromBrowseFile(ct.active_user,fS)}else{if(ct.simple_sharing_individual_files_enabled&&!fS.dir&&f0){return eF.createAndShowInbandModalFromBrowseFile(ct.active_user,fS)}else{if(fU){if(fT){if(f0){return eF.createAndShowInbandModalFromBrowseFile(ct.active_user,fS)}}else{return aE.open(fS.fq_path,fS.is_shared_folder(),fW,ct.active_user,fV)}}else{if(ct.simple_sharing_to_file_enabled&&((fR=__CONDITIONAL_JS__.OpenWith)!=null?fR.file_supported(fS):void 0)){if(f0){return eF.createAndShowInbandModalFromBrowseFile(ct.active_user,fS)}}else{f1=function(){return dx.shmodel(fS.fq_path,fY)};eW.firefly_logging_helper(fS,"single_entry_share_button_file_link");return cy.show_modal(fX,ct.active_user.id,f1)}}}}}})(this);fo=function(fT){var fR,fQ,fS;fS=$(fT.target);fQ=fS.match("li.browse-file")?fS:fS.up("li.browse-file");fR=cS.from_elem(fQ);if(fR){return j(fT)}};fz=null;fN=function(){var fQ;clearInterval(fz);fQ=function(){ct.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fz=setTimeout(fQ,100)};fE=function(){if(!ct.keyboard_nav){ct.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fv=function(fX){var fT,fS,fR,fV,fY,fU,fW,fQ;fN();if(!eW.is_selecting()){return}fT=ct.files.indexOf(fm);fQ=ct.files.indexOf(cS.from_elem(fX.target));cL(fT<ct.files.length&&fT>=0,"anchor_index: "+fT+" "+fm);cL(fQ<ct.files.length&&fQ>=0,"target_index: "+fQ);fS=ct.files.slice(Math.min(fT,fQ),Math.max(fT,fQ)+1);fR=fJ.slice(0);for(fU=0,fW=fS.length;fU<fW;fU++){fY=fS[fU];fV=fR.indexOf(fY);if(fV===-1){fR.push(fY)}else{fR.splice(fV,1)}}return fF(fR)};fw=function(fQ){fm=null;return fJ=null};fu=function(fS){var fQ,fR;if(typeof P!=="undefined"&&P!==null){P.reset()}fE();if(fS){Event.extend(fS).preventDefault()}fR=fp.length?fp.last()===ct.files.first()?ct.files.first():(fQ=ct.files.indexOf(fp.last())-1,ct.files[fQ]):ct.files.last();fF(fR);if(fR){return ct.scrollTo(fR.get_div())}};fB=function(fS){var fQ,fR;if(typeof P!=="undefined"&&P!==null){P.reset()}fE();if(fS){Event.extend(fS).preventDefault()}fR=fp.length?fp.last()===ct.files.last()?ct.files.last():(fQ=ct.files.indexOf(fp.last())+1,ct.files[fQ]):ct.files.first();fF(fR);if(fR){return ct.scrollTo(fR.get_div())}};fL=function(fY){var fR,fS,fW,fU,fX,fT,fQ,fV;if(typeof P!=="undefined"&&P!==null){P.reset()}fE();if(fY){Event.extend(fY).preventDefault()}if(fp.length>0){fX=ct.files.indexOf(fp.last());fR=ct.files.indexOf(fH);if(fH===fp.last()||fR>fX){if(fX>0){fV=[];for(fW=fU=fQ=fX-1;fQ<=0?fU<=0:fU>=0;fW=fQ<=0?++fU:--fU){fS=ct.files[fW];fT=fp.indexOf(fS);fI(fS,fH);if(fT!==-1){fV.push(fp.splice(fT,1))}else{ct.scrollTo(fS.get_div());break}}return fV}}else{fs(fp.last());return ct.scrollTo(fp.last().get_div())}}else{return fu()}};fO=function(fZ){var fR,fS,fW,fU,fX,fT,fQ,fY,fV;if(typeof P!=="undefined"&&P!==null){P.reset()}fE();if(fZ){Event.extend(fZ).preventDefault()}if(fp.length>0){fX=ct.files.indexOf(fp.last());fR=ct.files.indexOf(fH);if(fH===fp.last()||fR<fX){fV=[];for(fW=fU=fQ=fX+1,fY=ct.files.length;fQ<=fY?fU<fY:fU>fY;fW=fQ<=fY?++fU:--fU){fS=ct.files[fW];fT=fp.indexOf(fS);fI(fS,fH);if(fT!==-1){fV.push(fp.splice(fT,1))}else{ct.scrollTo(fS.get_div());break}}return fV}else{fs(fp.last());return ct.scrollTo(fp.last().get_div())}}else{return fB()}};fr=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}fF(ct.files);return false};fl=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}return fF(null,null,null)};fA=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(fK,100)};fP=function(fQ){return fQ.memo.files.each(function(fR){var fS;fS=fp.indexOf(fR[0]);if(fS!==-1){fp.splice(fS,1);return fI(fR[1])}})};fG=function(fQ,fR){var fS;if(ct.in_search_mode()&&fQ&&fR){fS={file_nsid:fQ.ns_id,file_sjid:fQ.file_sjid,firefly:cb.firefly_enabled,match_type:fQ.match_type,position:fQ.sort_rank,request_id:fQ.request_id,viewport:"full-view",action_type:fR};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fS)}};fM=function(fR,fQ,fS,fU,fY){var fX,fW,fV,fT;fW="file_row_sharing_menu";if(fQ){if(d4.get_for_user(fR).verified_or_show()){ba.ShmodelUILogger.log("sf_options",fW,fS);fG("single_entry_share_button_folder_options");fX=new dg(fR,fU);if(typeof fY==="function"){fY()}return fX.show()}}else{fT=ct.verify_email_after_share_experiment_variant;fV=fT&&fT==="VERIFY_LAST";if(fV){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fT){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fV||d4.get_for_user(fR).verified_or_show()){ba.ShmodelUILogger.log("sf_invite",fW,fS);fG("single_entry_share_button_folder_invite");fX=new cp(fR,{folder_name:fU,element_id:"invite-to-new-sf-wizard-modal-"+fR.id,must_check_verified:fV});if(typeof fY==="function"){fY()}return fX.show()}}};document.observe(bE.REMOVE,function(fQ){return fQ.memo.files.each(fs)});document.observe(bE.MOVE,fP);return{UPDATED_EVT:"db:select:updated",init:function(){var fQ;document.observe("click",fo);document.observe("mousedown",i);document.observe("mouseup",fw);document.observe("dragend",fw);document.observe("mouseup",ft);$("browse-files").on("mouseover","li.browse-file",fv);$("browse-files").on("click",".shmodel-file",T);$("browse-files").on("click",".inline-share-button",fq);document.observe(eW.UPDATED_EVT,fK);document.observe(eW.UPDATED_EVT,ft);document.observe(dN.RENDER,fK);document.observe(dN.RENDER,ft);document.observe(dN.UPDATE,fF.bind(null,null,null));fQ=key.main_modifier();key("up",ct.KEY_SCOPE,fu);key("down",ct.KEY_SCOPE,fB);key(fQ+"+a",ct.KEY_SCOPE,fr);key("escape",ct.KEY_SCOPE,fl);key("shift+up",ct.KEY_SCOPE,fL);return key("shift+down",ct.KEY_SCOPE,fO)},set_selected_files:function(fQ){return fF(fQ)},get_selected_files:function(){return fp.slice(0)},get_selected_fq_paths:function(){return fp.map(function(fQ){return fQ.fq_path})},has_selected_files:function(){return fp.length},is_selected:function(fQ){return fp.indexOf(fQ)!==-1},is_selecting:function(){return !!fm},deselect_all:fx,set_context_selected:function(fQ){return fD(fQ)},flicker_selected:fA,firefly_logging_helper:function(fQ,fR){return fG(fQ,fR)},show_share_modal_if_email_verified:fM}})();aE=E.SharingGrowthExperimentsDropdown={open:function(fm,j,T,fn,fl){var i;this.fq_path=fm;this.existing_sf=j;this.button=T;this.user=fn;this.target_item=fl;this.$menu=bF("#sharing-growth-experiments-dropdown-menu");i=this.$button&&this.$button.length;if(i){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var i;this.$menu.show();this.$button=bF(this.button);this.$button.addClass("pressed");i={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};C.clone_position(this.$menu,this.$button,i);bF("#browse-box").addClass("dropdown-menu-open");return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(i){return i.stopPropagation()});bF(document).on("mousedown",bF.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bF.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bF(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bF.proxy(this._share_link_click,this))},_sf_click:function(j){var i;i=(function(T){return function(){return eW.show_share_modal_if_email_verified(T.user,T.existing_sf,T.target_item,T.fq_path)}})(this);this._hide();return cy.show_modal(j,this.user.id,i)},_share_link_click:function(j){var i;i=(function(T){return function(){var fl;fl="file_row_sharing_menu";ba.ShmodelUILogger.log("token_share",fl,T.target_item);T._firefly_logging_helper("single_entry_share_button_folder_link");return dx.shmodel(T.fq_path,fl)}})(this);this._hide();return cy.show_modal(j,ct.active_user.id,i)},_firefly_logging_helper:function(i){return eW.firefly_logging_helper(ct.find_file(this.fq_path),i)},_clicked:function(i,j){return i.is(j.target)||i.has(j.target).length},_click_outside_menu_callback:function(i){if(!(this._clicked(this.$menu,i)||this._clicked(this.$button,i))){return this._hide()}},_hide:function(i){this._unlisten();bF("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");return this.$button=null}};var A;A=E.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(i,j){this._exclude_move_event=i;if(j!=null){return this._scroll_window=j}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(j){var i;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(j):void 0){return this._mouse_y=0}else{i=j.pointerY();return this._mouse_y=i-C.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var i;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}i=0;if(this._mouse_y<this._scroll_window){i=-1*this._scroll_amount}else{if(this._mouse_y>C.viewport_dimensions().height-this._scroll_window){i=this._scroll_amount}}if(i){return C.scroll_to(C.scroll_offsets().left,C.scroll_offsets().top+i)}}};var bR;bR=E.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var i;if(!Modernizr.draganddrop){return}this.listen();i=function(T){var j;j=bF(T.target);return j.closest("#browse-location").length||j.attr("id")==="browse-location"};return A.init(i,bF("#browse-header").height())},listen:function(){var i;i=$(document.body);document.observe(dN.UPDATE,this._update_body_data.bind(this));i.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));i.on("dragend",this._body_dragend.bind(this));i.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){i.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));i.on("mousedown",this._ie_start_drags.bind(this));i.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}i.observe("dragover",this._body_dragover.bind(this));i.observe("dragleave",this._body_dragleave.bind(this));i.observe("dragstart",this._body_dragstart.bind(this));i.observe("mousemove",this._body_mousemove.bind(this));i.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eW.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(dN.RENDER,this._build_selected_drag_icon.bind(this));i.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return i.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(j){var i;if(!window.event||window.event.button!==1){return}i=j.findElement("[draggable]");if(i&&i!==document&&i.dragDrop){i.dragDrop();return bR._ie_end_drags()}},_ie_start_drags:function(i,j){if(j.tagName!=="OBJECT"&&$(j).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var j,i;j=ct.inside_dir?"copy move":false;i=ct.inside_dir?ct.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",j);return $(document.documentElement).writeAttribute("data-fq_path",i)},_body_dragover:function(j){var i;i=this._get_event_browse_files();if(i.length){return this._update_status_position(j,i)}else{if(!this._drag_from_window&&this._can_drop_transfer(j.dataTransfer)){return bp.show_drop_indicators(j)}}},_body_dragleave:function(T){var j,i,fl;i=T.x||T.clientX;fl=T.y||T.clientY;j=C.viewport_dimensions();if(!((0<i&&i<j.width)&&(0<fl&&fl<j.height))){return bp.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bp.hide_drop_indicators();A.end();return this._drag_from_window=false},_body_mousemove:function(){return bp.hide_drop_indicators()},_ie_mouseover:function(j,i){if(!C.focus_in_input()){return i.focus()}},_dropzone_dragover:function(fn,i){var j,T,fl,fm;if(!cN.isFileDragEnabled()){return true}fn.preventDefault();fl=this._get_event_browse_files();fm=this._target_fq_path(i);if(!fl.pluck("fq_path").indexOf(fm===-1)){return}if(!this._can_drop(fn,i)){i.addClassName("drag_nodrop");return}try{T=fn.dataTransfer.effectAllowed}catch(fo){}if(T==="move"||T==="copyMove"||T==="linkMove"||T==="all"){fn.dataTransfer.dropEffect="move"}else{fn.dataTransfer.dropEffect="copy"}fn.preventDefault();j=$$(".dragover");j.removeItem(i);j.invoke("removeClassName","dragover");if(!dT.disabled){i.addClassName("dragover")}return bp.folder_dragover(fm)},_dropzone_dragleave:function(j,i){return this._clear_hover_state(i)},_file_dragstart:function(fp,fs){var ft,i,fu,fr,j,fo,fm,fl,fq,T;d6.clear_selected();if(eW.is_selecting()){return fp.preventDefault()}fp.dataTransfer.effectAllowed="copyMove";fp.dataTransfer.setData("URL","about:blank");fo=cS.from_elem(fs);this._set_event_browse_files(fo);fm=this._get_event_browse_files();if(fm.length<=1&&!fo.dir){T=fo.href;fl=(fo.filename||eA("file")).replace(/:/g,"-");fq="application/octet-stream";try{fp.dataTransfer.setData("DownloadURL",[fq,fl,T].join(":"))}catch(fn){}}fu=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});ft=true;try{fp.dataTransfer.setDragImage(fu,150,150)}catch(fr){j=fr;ft=d6.ie8}this._add_drop_indicators(fp);A.start();if(ft){this._update_status_position(fp,fm);i=$("drag-status");i.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fm.length>1){i.addClassName("rotatein")}if(this._is_dragging_selection()){i.addClassName("selection")}return i.addClassName("fadein")}},_add_drop_indicators:function(fn){var fo,T,i,fm,fl;$(document.body).addClassName(this._STATUS_CLASS);if(!dT.disabled){fm=$$('[dropzone="copy move"]');fl=[];for(T=0,i=fm.length;T<i;T++){fo=fm[T];if(this._can_drop(fn,fo)){fl.push(fo.addClassName("can_drop"))}else{fl.push(void 0)}}return fl}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,fo,ft,fn,fq,fu,fp,fs,fr,fm,fl;fl=eW.get_selected_files();ft=new Element("div",{id:"drag-selection-status"});fm=fl.slice(0,4);for(fq=fp=0,fs=fm.length;fp<fs;fq=++fp){fo=fm[fq];T=fo.get_div();if(!T){continue}fr=T.down(".icon");fr.stopObserving("load");fr.observe.bind(fr).defer("load",bR._build_selected_drag_icon);fu=fr.cloneNode(false);Element.addClassName(fu,"icon icon"+fq);ft.__sert(fu)}fn=new Element("span",{className:"badge"});fn.__date(fl.length);ft.appendChild(fn);return $("drag-selection-status").replace(ft)},_build_file_drag_icon:function(fm,i){var j,fn,fl,T;j=cS.from_elem(i);T=j.get_div().down(".icon").cloneNode(false);Element.addClassName(T,"icon icon0");fl=new Element("span",{className:"badge"});fl.__date("1");fn=new Element("div",{id:"drag-file-status"});fn.__date(T).__sert(fl);return $("drag-file-status").replace(fn)},_drop:function(fs,fv){var ft,fn,fy,fw,fz,fq,fx,fp,fm,fo,fr,T,fu,i,fl;fn=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fq=cN.getDraggedLink(fs.dataTransfer)}if(fq!=null){i=cN.buildUrlLinkfileContents(fq);fu=new Blob([i],{type:"text/plain"});T=G.parse(fq).getAuthority();fu.name=ct.unused_filename(T+".url");fu.overwrite=false;fx=[fu];ba.LinkfileActivityLogger.log("droplink","url",T,true,"browse",{})}else{fx=fs.dataTransfer.files;fp=fs.dataTransfer.items}fs.preventDefault();if(fv.readAttribute("quicksend")){if(fx&&fx.length){fy=function(){return bp.upload(Z.DEST_FOLDER,fx,fp)};Z.get_folder_name(fy)}else{if(fn.length){for(fo=0,fr=fn.length;fo<fr;fo++){fm=fn[fo];fm.id=p.guid();Z.add_dropbox_file(fm)}}}return}if(this._is_read_only(fv)){fl=eA("You don't have permission to add to this folder.");ah.error(fl);return}fw=null;fz=cS.from_elem(fv);ft=fv.readAttribute("data-fq_path");if(fz){fw=fz.fq_path}else{if(ft||ft===""){fw=ft}}if(fx&&fx.length){if(!bp.supported()){ah.error(eA("Drag and drop not supported. Please try the simple uploader."))}else{if(!bp.browse_indicators_enabled()&&!bp.modal_indicators_enabled()){if(cC.choose_button_id.startsWith("wizard-")){ah.error(eA("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ah.error(eA("You can't drag and drop upload right now."))}}else{bp.upload(fw,fx,fp)}}}else{if(fn.length){if((fs.dataTransfer.dropEffect==="copy")||(fs.dataTransfer.effectAllowed==="copy")){dD.do_bulk_copy(fn,fw)}else{if(!ct.inside_dir||ct.containing_fq_path()!==fw){dD.do_bulk_move(fn,fw)}}}}this._remove_drop_indicators();return bp.hide_drop_indicators()},_set_event_browse_files:function(i){var j;j=eW.is_selected(i);return this._current_item_key=j?this._SELECTION_CONST:i.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var i,fl,T,j;try{j=this._current_item_key;if(this._is_dragging_selection()){return eW.get_selected_files()}else{if(j){T=cS.from_key(j);return(T?[T]:[])}}}catch(i){fl=i;console.log(fl)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(i){if(i.readAttribute("read_only")){return true}if(i.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return az.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(j){var i;i=["Files"];if(this._linkfile_drop_enabled()){i.push.apply(i,["text/x-moz-url","text/uri-list","Url"])}return bx.intersection(j!=null?j.types:void 0,i).length>0},_can_drop:function(fl,j){var i,T;if(j.readAttribute("quicksend")){return true}if(this._is_read_only(j)){return false}i=this._target_fq_path(j);T=this._get_event_browse_files();if(T.length){return !dD.bulk_move_error(T,i)}else{if(this._can_drop_transfer(fl.dataTransfer)){bp.supported();return true}else{return false}}},_target_fq_path:function(i){var j;j=cS.from_elem(i);if(j){return j.fq_path}else{return i.readAttribute("data-fq_path")}},_clear_hover_state:function(fm){var fn,T,i,fl;fl=$$("#browse .dragover");for(T=0,i=fl.length;T<i;T++){fn=fl[T];if(fn!==fm){fn.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(i){i=Event.extend(i);return d6.scry("drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var P;P=E.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(i){return i.charCodeAt(0)}),update:function(){var fm,fo,fl,T,i,fn;if(!P._listening){P.listen();P._listening=true}fm=[];fn=ct.files;for(T=0,i=fn.length;T<i;T++){fl=fn[T];fo=P.to_codepoint_list(fl.filename);fm.push([fo,fl])}fm.sort(function(fp,j){return P.cmp_codepoints(fp[0],j[0])});return P._CODEPOINTS=fm},reset:function(){return P._active=""},is_active:function(){return P._active},jump:function(i){if(i){eW.set_selected_files([i]);return ct.scrollTo(i.get_div())}},listen:function(){var fn,T,i,fm,fl;document.observe("keypress",function(fo){var j;if(key.getScope()!==ct.KEY_SCOPE){return}if(C.focus_in_input()||fo.metaKey||fo.altKey||fo.altGraphKey||fo.ctrlKey){return}j=fo.charCode||fo.keyCode;if(j<32){return}if((33<=j&&j<=40)){return}if(j===32){if(P._active){fo.preventDefault()}else{return}}if(P._BLACKLIST.indexOf(j)!==-1){return}clearTimeout(P._RESET_TIMER_ID);P._active+=String.fromCharCode(j).toLowerCase();P.jump(P.nearest_file(P._active));return P._RESET_TIMER_ID=setTimeout(P.reset,P._RESET_WAIT)});fm=[aH.DELETE,aH.COPY,aH.MOVE,aH.RENAME,aH.PURGE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_LEAVE,aH.SF_UNSHARE,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,bE.ADD,bE.REMOVE,bE.MOVE];fl=[];for(T=0,i=fm.length;T<i;T++){fn=fm[T];document.observe(fn,function(j){return P.update()});fl.push(bF(document).on(fn,function(j){return P.update()}))}return fl},nearest_file:function(fr){var fn,fl,i,fm,fp,T,fq,fo;if((T=P._CODEPOINTS)!=null?T.length:void 0){fn=P.to_codepoint_list(fr);fq=P._CODEPOINTS;for(fm=0,fp=fq.length;fm<fp;fm++){fo=fq[fm],i=fo[0],fl=fo[1];if(P.cmp_codepoints(fn,i)<1){return fl}}P._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fo,fn){var fl,T,fm;cL(fo.length>0&&fn.length>0,"bad input to cmp_codepoints");for(fl=T=0,fm=fo.length;0<=fm?T<fm:T>fm;fl=0<=fm?++T:--T){if(fn[fl]==null){return 1}if(fo[fl]!==fn[fl]){return(fo[fl]<fn[fl]?-1:1)}}if(fn.length>fo.length){return -1}else{return 0}},to_codepoint_list:function(fl){var fn,fm,fo,T;fl=fl.toLowerCase();T=[];for(fn=fm=0,fo=fl.length;0<=fo?fm<fo:fm>fo;fn=0<=fo?++fm:--fm){T.push(fl.charCodeAt(fn))}return T}};var bn;bn=E.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bF(document).click(this.hide_on_click);bF(document).on(dN.UPDATE,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(i){return function(j){return bn.hide()}})(this))},unlisten:function(){bF(document).off("click",this.hide_on_click);return bF(document).off(dN.UPDATE,this.hide_on_click)},hide_on_click:function(i){if(!(i.which===3||bF(i.target).parents("#context-menu").length)){return bn.hide()}},show_for_file:function(i,fl,T){var fm,j;ct.keyboard_nav=false;this.hide();fm=cS.from_elem(T);j=eW.is_selected(fm)?eW.get_selected_files():(eW.deselect_all(),[fm]);eW.set_context_selected(j);return this._show(fl,new i(j))},show_global:function(i,j){this.hide();return this._show(j,new i())},show_shmodel:function(fo){var fn,j,i,T,fl,fm;fn=["get_original"];fl=fo.findElement("img");if((fl.readAttribute("enable-download"))==="true"){T=fl.readAttribute("data-original-href");j=[]}else{T="";j=["get_original"]}this.hide();fm={get_original:{icon:"download",text:eA("Download original"),href:T}};i=Class.create({get_action_names:function(){return fn},get_disabled_action_names:function(){return j},get_action_by_name:function(fp){var fq;fq=fm[fp];fq.name=fp;return fq}});return this._show(fo,new i())},show_for_lightbox:function(fp){var fo,j,i,fm,T,fn,fl;fo=["download","view_original"];this.hide();T=fp.findElement("img");if((T.readAttribute("enable-download"))==="false"){j=["download","view_original"];fm="";fl=""}else{j=[];fm=G.parse(T.readAttribute("data-original-href")).updateQuery({dl:1}).toString();fl=T.readAttribute("data-original-href")}fn={download:{icon:"download",text:eA("Download"),href:fm},view_original:{icon:"view_original",text:a6.append_ellipsis(eA("View original")),href:fl,target:"_blank"}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){var fq;fq=$("context-menu-container");fq.stopObserving("click");fq.stopObserving("contextmenu");fq.on("click",".action button",this._click.bind(this));return fq.on("contextmenu",".action button",this._click.bind(this))},_click:function(fu,fr){var ft,fq,fs;ft=fr.readAttribute("data-value");fq=fn[ft];bn.hide();fu.preventDefault();return(fs=fq.click_handler)!=null?fs.call(this,fu):void 0},get_action_names:function(){return fo},get_disabled_action_names:function(){return j},get_action_by_name:function(fq){var fr;fr=fn[fq];fr.name=fq;return fr}});return this._show(fp,new i())},show_photos:function(fq,fu){var ft,j,fn,fm,fs,fr,i,T,fl,fp,fo;this.hide();fm={divider:{type:"divider"},choose_album:{icon:"album_16",text:a6.append_ellipsis(eA("Add %(num_photos)s to album").format({num_photos:fu.length})),click_handler:function(fv){cJ.show_add_to_album_modal(fv,fu);return g.log_interaction(el.ADD_TO_OTHER_ALBUM,dc.PCM,{num_photos:fu.length})}},remove:{icon:"album_delete_16",text:eA("Remove %(num_photos)s from album").format({num_photos:fu.length}),click_handler:function(){cJ.show_remove_photos_modal(bQ.get_current_collection(),fu);return g.log_interaction(el.REMOVE,dc.PCM,{num_photos:fu.length})}},set_cover:{icon:"album_16",text:eA("Set as cover"),click_handler:function(){bQ.get_current_collection().set_cover(fu[0]);return g.log_interaction(el.SET_AS_COVER,dc.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bQ.show_timestamps_modal(fu)}}};if(bQ.in_single_collection_view()){ft=["share","choose_album","remove"];if(fu.length===1){ft.unshift("divider");ft.unshift("set_cover")}}else{ft=["share","choose_album"];ft.push("divider");ft.push("delete");if(bQ.timestamp_edit_enabled){fs=(function(){var fx,fv,fw;fw=[];for(fx=0,fv=fu.length;fx<fv;fx++){T=fu[fx];if(T.time_taken==null){fw.push(T)}}return fw})();if(fs.length===0){ft.push("edit_timestamp")}else{if(fs.length===fu.length){fm.edit_timestamp.text="Set timestamp";ft.push("edit_timestamp")}}}}if(fu.length===1){fl=c9.categorize_files(fu),fr=fl[0],i=fl[1];if(fr){fo=a6.append_ellipsis(eA("Share photo"))}else{fo=a6.append_ellipsis(eA("Share video"))}Object.extend(fm,{share:{icon:"s_link",text:fo,click_handler:function(fv){ez.show(fu,false);return g.log_interaction(el.SHARE,dc.PCM,{num_photos:1})}},"delete":{text:a6.append_ellipsis(eA("Delete")),click_handler:function(){bQ.show_delete_photos_modal(fu);return g.log_interaction(el.DELETE,dc.PCM,{num_photos:1})}},show_in_folder:{text:a6.append_ellipsis(eA("Show in folder")),click_handler:function(){bQ.show_in_folder(fu[0]);return g.log_interaction(el.SHOW_IN_FOLDER,dc.PCM,{num_photos:1})}}});if(bQ.in_single_collection_view()){ft.push("divider")}ft.push("show_in_folder")}else{fp=c9.categorize_files(fu),fr=fp[0],i=fp[1];if(fr&&i){fo=bd("Share %(file_count)s item","Share %(file_count)s items",fu.length);fn=bd("Delete %(file_count)s item","Delete %(file_count)s items",fu.length)}else{if(fr){fo=bd("Share %(file_count)s photo","Share %(file_count)s photos",fu.length);fn=bd("Delete %(file_count)s photo","Delete %(file_count)s photos",fu.length)}else{fo=bd("Share %(file_count)s video","Share %(file_count)s videos",fu.length);fn=bd("Delete %(file_count)s video","Delete %(file_count)s videos",fu.length)}}fo=fo.format({file_count:fu.length});fn=fn.format({file_count:fu.length});Object.extend(fm,{share:{icon:"s_link",text:fo,click_handler:function(fv){bQ._share_selected();return g.log_interaction(el.SHARE,dc.PCM,{num_photos:fu.length})}},"delete":{text:fn,click_handler:function(fv){bQ.show_delete_photos_modal(fu);return g.log_interaction(el.DELETE,dc.PCM,{num_photos:fu.length})}}})}j=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fz,fx){var fy,fw,fv;fy=fx.readAttribute("data-value");fw=fm[fy];if(fz.clientX===0&&fz.clientY===0){return}bn.hide();return(fv=fw.click_handler)!=null?fv.call(this,fz):void 0},get_action_names:function(){return ft},get_disabled_action_names:function(){return[]},get_action_by_name:function(fv){var fw;fw=fm[fv];fw.name=fv;return fw}});return this._show(fq,new j())},show_photo_collection:function(fl,fm,fn){var T,i,j;this.hide();if(fm.is_anonymous){T=["go_to_link","unshare"]}else{if(fm.is_creator){T=["share","rename"];if(fm.share_tkey!=null){T.push("unshare")}T.push("delete")}else{T=["share"]}}j={share:{icon:"s_link",text:a6.append_ellipsis(eA("Share album")),click_handler:function(fo){if(fm.num_items===0){ah.error(eA("This album is empty. Add some photos before you share it!"));return}ez.show(fm,true);return g.log_interaction(el.SHARE_ALBUM,dc.CCM,{num_photos:fm.num_photos})}},unshare:{icon:"lock",text:a6.append_ellipsis(fm.is_anonymous?eA("Unshare"):eA("Unshare album")),click_handler:function(fo){cJ.show_unshare_modal(fm);return g.log_interaction(el.UNSHARE_ALBUM,dc.CCM,{num_photos:fm.num_photos})}},rename:{icon:"pencil",text:eA("Rename album"),click_handler:function(fo){fm.rename(fn.down(".collection-name"));return g.log_interaction(el.RENAME_ALBUM,dc.CCM,{num_photos:fm.num_photos})}},"delete":{icon:"album_delete_16",text:a6.append_ellipsis(eA("Delete album")),click_handler:function(fo){cJ.show_delete_modal(fm);return g.log_interaction(el.DELETE_ALBUM,dc.CCM,{num_photos:fm.num_photos})}},go_to_link:{icon:"s_link",text:eA("Go to link"),click_handler:function(fo){cJ.go_to_link(fm);return g.log_interaction(el.GO_TO_ALBUM_LINK,dc.CCM,{num_photos:fm.num_photos})}}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fs,fp){var fr,fo,fq;fr=fp.readAttribute("data-value");fo=j[fr];bn.hide();return(fq=fo.click_handler)!=null?fq.call(this):void 0},get_action_names:function(){return T},get_disabled_action_names:function(){return[]},get_action_by_name:function(fo){var fp;fp=j[fo];fp.name=fo;return fp}});return this._show(fl,new i())},_show:function(fz,fo,fx){var fu,fw,fl,fA,T,ft,fv,fy,fn,fs,fm,fq,fp,fB,fr;if(fx==null){fx=false}fr=((fz!=null?(fm=fz.target)!=null?fm.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fz!=null?(fq=fz.target)!=null?fq.type.toUpperCase():void 0:void 0)==="TEXT")||((fz!=null?(fp=fz.target)!=null?fp.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");ft=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#react-file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fB=$(fz.target);if(bF(fB).parents("#context-menu").length){return}fu=bF("#file-preview-modal");if(!(fu.find(fB).length&&bF(fB).is("img"))){for(fw=0,fy=ft.length;fw<fy;fw++){T=ft[fw];fA=$$(T);if(fA){for(fv=0,fn=fA.length;fv<fn;fv++){fl=fA[fv];if(fB.descendantOf(fl)||fB.match(T)){return}}}}}if((fz!=null?fz.shiftKey:void 0)||fr){return}else{Event.stop(fz)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=fg.tmpl("context_menu_tmpl")}if(!fo.get_action_names().length){return}eT.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fo,actions:(function(){var fC,j,i,fD;i=fo.get_action_names();fD=[];for(fC=0,j=i.length;fC<j;fC++){fs=i[fC];fD.push(fo.get_action_by_name(fs))}return fD})(),disabled_actions:fo.get_disabled_action_names(),big:fx,Sprite:cx}));this.position_at(fz.clientX,fz.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(T,fn){var j,i,fl,fm;fm=C.viewport_dimensions();i=parseInt($("context-menu").getStyle("width"),10);j=parseInt($("context-menu").getStyle("height"),10);fl=15;if(T+i>fm.width-fl){$("context-menu").setStyle({left:(fm.width-i-fl)+"px"})}else{$("context-menu").setStyle({left:T+"px"})}if(fn+j>fm.height-fl){return $("context-menu").setStyle({top:(fm.height-j-fl)+"px"})}else{return $("context-menu").setStyle({top:fn+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eW.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dp,ct,k,aL,ay,cV,cm,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};dp=E.BROWSE_SNIPPET_LEN=25;cm=E.SEARCH_SNIPPET_LEN=20;aL=E.COMMENT_COUNT_SNIPPET_LEN=3;cV=E.LAST_MODIFIED_FNAME_SNIPPET=4;ay=[bq.FILES_BY_NAME,true,"FILES_BY_NAME"];ct=INLINE_JS.Browse=E.Browse={KEY_SCOPE:"browse",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:ay,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(j,fo,fl,fn,i,fm,T){this.browse_actions_ctor=fo;this.global_actions_ctor=fl;this.browse_actions_context_ctor=fn;this.global_actions_context_ctor=i;this.ns_id_to_mount_point=fm;cL(typeof T==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cM.get_viewer().get_user_by_id(T);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cL(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();C.viewport_dimensions();if(b1.chrome){this.browser_supports_previews=j&&d6.pdf_plugins().length}else{this.browser_supports_previews=j}this.compiled_search_tmpl=fg.tmpl("search_list_item_tmpl");cE.AuthenticatedRequest({url:G({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(fl,fp){var fo,fn,T,i,fm;if(fp==null){fp=null}this.ns_id_to_mount_point=fl.ns_id_to_mount_point;this.old_path_to_ns_id=fl.old_path_to_ns_id;this.compiled_tmpl=fg.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=fl.containing_fq_path==="";this.inside_dir=fl.inside_dir;this.inside_deleted_dir=fl.inside_deleted_dir;this.inside_shared_folder=fl.inside_shared_folder;this.is_nested_shared_folder=fl.is_nested_shared_folder;this.is_nested_in_team_folder=fl.is_nested_in_team_folder;this.inside_read_only_shared_folder=fl.inside_read_only_shared_folder;this.inside_sandbox=fl.inside_sandbox;this.public_app_token=fl.public_app_token;this.public_folder_enabled=fl.public_folder_enabled;this.inside_deleted_sandbox=fl.inside_deleted_sandbox;this.inside_deleted_shared_folder=fl.inside_deleted_shared_folder;this.inside_team_folder=fl.inside_team_folder;this.golden_gate_aware=fl.golden_gate_aware;this.is_read_only=fl.is_read_only;this.ns_map=fl.ns_map;this.permanent_delete_is_disabled_by_ns_id=fl.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=fl.contents_cache_key;fn="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(fn)}else{$("browse").removeClassName(fn)}this.block_hash=fl.block_hash;this.block_hash_param=fl.block_hash_param;if(this.inside_dir){this._containing_ns_id=fl.containing_ns_id;this._containing_ns_path=fl.containing_ns_path;this._containing_fq_path=fl.containing_fq_path;this._containing_mount_point=fl.containing_mount_point;this._containing_sf_perm_role=fl.containing_sf_perm_role;this.breadcrumb();fm=[this.browse_actions,this.global_actions];for(T=0,i=fm.length;T<i;T++){fo=fm[T];if(fo!=null){fo.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(fl.file_info||fl.paginated)){this.show_message(eA('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(fl.paginated){return this._start_pagination(fl.first_page)}else{return this._push_files(fl.file_info,fp)}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(j){var i;if(j.unsupported_sort!=null){this.reset_sort()}this.paginating=true;i=ct.active_user.id;this.pagination_manager=new fk();this.pagination_manager.initialize(j,"sjid","/browse_get_next",i,(function(T){return function(fl,fm){return T._new_data_available(fl,fm)}})(this));this.pagination_manager.startAutoFetching();bF("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bF("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(fl,j){var T,i;if(!this.paginating){return}i=this._push_files(j);if(az.getGandalfRule("file-viewer-react")){e0.updateFiles(this.files)}if(!this.in_search_mode()){this.smartfill();a6.load_visible_thumbs();this.fire_visible_change_callbacks()}T=fl.loadedPageCount()===1;if(!T){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||fl.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(ct)}}document.fire(dN.NEW_PAGE,{page_files:i});bF(document).trigger(dN.NEW_PAGE,{page_files:i})}if(fl.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(i){var fr,fs,fp,fn,fm,fq,fo,fl,T;if(i==null){i=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){T=this.select_fq_paths;for(fn=0,fq=T.length;fn<fq;fn++){fr=T[fn];fp=false;fl=fr.toLowerCase();for(fm=0,fo=i.length;fm<fo;fm++){fs=i[fm];if(fs.fq_path.toLowerCase()===fl){fp=true;break}}if(!fp){return false}}return true}else{if(this.select_index>-1){return this.select_index<i.length}}return cL(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){bF("#waiting-for-items").show();bF("#global-actions").addClass("disabled");return bF("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){bF("body").removeClass("waiting_for_items");bF("#global-actions").removeClass("disabled");return bF("#waiting-for-items").hide()},_push_files:function(fm,fp){var fo,T,fn,fl,i;if(fp==null){fp=null}T=[];for(fl=0,i=fm.length;fl<i;fl++){fn=fm[fl];fo=a6.make_browsefile(fn,fp);fo.track_in_browse();T.push(fo)}P.update();return T},_get_helper:function(i){cL(this.inside_dir,"accessed "+i+", but not inside a directory");return ct[i]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fy,fw,T,fn,fr,fq,fu,fs,fp,fm,fl,fv,ft,fo,fx,i;bF("#fulltext-search-all-link").click(this.unscoped_search);bF("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bn.show_for_file.bind(bn,this.browse_actions_context_ctor));this.enable_sorting();fo="#browse-sort a.sortable-column-header";d6.add_sort_arrow_mouseover($("name-sorter"),true,fo,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bn.show_global.bind(bn,this.global_actions_context_ctor));document.observe(eW.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aH.COPY,(function(j){return function(fz){if(j.inside_dir&&fz.memo.to_fq_path===j.containing_fq_path()){return j.force_reload()}}})(this));fl=[aH.MOVE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,aH.LINKS_ADD];for(fr=0,fu=fl.length;fr<fu;fr++){T=fl[fr];fn=(function(j){return function(fz){if(j.inside_dir&&!ct.in_search_mode()){return j.force_reload()}}})(this);document.observe(T,fn);bF(document).on(T,fn)}fv=[aH.SF_LEAVE,aH.SF_UNSHARE];for(fq=0,fs=fv.length;fq<fs;fq++){T=fv[fq];document.observe(T,(function(j){return function(fz){if(j.inside_dir){if(fz.memo.target_ns_id===j.containing_ns_id()){if(fz.memo.folder_deleted){return j.reload_fqpath("")}else{return j.reload_fqpath(j.containing_fq_path())}}else{return j.force_reload()}}}})(this))}ft=[aH.DELETE,aH.PURGE];for(fm=0,fp=ft.length;fm<fp;fm++){T=ft[fm];document.observe(T,(function(j){return function(fH){var fC,fE,fD,fB,fz,fA,fG,fF;if(j.inside_dir){if(fH.eventName===aH.PURGE||(fH.eventName===aH.DELETE&&!a4.get_del())){for(fE=fB=fG=j.files.length-1;fG<=0?fB<=0:fB>=0;fE=fG<=0?++fB:--fB){if(fH.memo.files.indexOf(j.files[fE])===-1){fz=j.files[fE]}else{break}}eW.deselect_all();fF=fH.memo.files;for(fA=0,fD=fF.length;fA<fD;fA++){fC=fF[fA];fC.get_div().remove();j.files.removeItem(fC)}if(j.files.length){if(fz!=null){return eW.set_selected_files(fz)}else{return eW.set_selected_files(j.files.last())}}else{return j.show_empty()}}else{if(j.keyboard_nav){j.select_fq_paths=[j.containing_fq_path()+"/"+fH.memo.files.last().filename]}return j.force_reload()}}}})(this))}document.observe(bn.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bn.HIDE_EVT,this.enable_sorting.bind(this));fy=function(){var fz,j;fz=$("browse-header");j=fz.cumulativeOffset().top+fz.getHeight();return C.viewport_dimensions().height-j};key("pagedown",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,fy())});key("pageup",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,-1*fy())});fx=function(){var j;j=ct.in_search_mode()?cb:ct;if(ct.files.length===0){return j.show_empty()}else{return j.hide_empty()}};document.observe(bE.ADD,(function(j){return function(fC){var fB,fA,fD,fz;fz=fC.memo.files;for(fD=0,fA=fz.length;fD<fA;fD++){fB=fz[fD];j.insert_file(fB,true)}return fx()}})(this));document.observe(bE.REMOVE,(function(j){return function(fC){var fB,fA,fD,fz;fz=fC.memo.files;for(fD=0,fA=fz.length;fD<fA;fD++){fB=fz[fD];j.remove_file(fB)}return fx()}})(this));document.observe(bE.MOVE,(function(j){return function(fF){var fI,fz,fC,fA,fG,fE,fD,fB,fH;fz=j.in_search_mode();fE=fF.memo.files;fB=[];for(fA=0,fC=fE.length;fA<fC;fA++){fD=fE[fA],fI=fD[0],fH=fD[1];if(fz){if(fI!=null){fG=j.get_file_pos(fI)}else{continue}}j.remove_file(fI);j.insert_file(fH);if(fz&&fG>=0){fB.push(j.update_file_pos(fH,fG))}else{fB.push(void 0)}}return fB}})(this));bF(document).on(aH.COMPRESS,(function(j){return function(fB,fA){var fz;j.force_reload();if(fA.compressed_files.length===1&&fA.original_files.length===1){fz=a6.make_browsefile(fA.compressed_files.first());return j.preview_compressed(fz,fA.original_files.first())}}})(this));fw=this.fire_visible_change_callbacks.bind(this);bF(window).on("resize",fw);this._last_visible_change_timeout_id=null;i=(function(j){return function(fz){clearTimeout(j._last_visible_change_timeout_id);return j._last_visible_change_timeout_id=setTimeout(fw,250)}})(this);return bF(window).on("scroll",i)},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(T,fm){var i,j,fl;i=bF(T.target);if(i.is("img.icon")||i.closest("a.filename-link").length>0||i.closest(".filename-col__comment-count-bubble").length>0){this._click(T,fm)}if(i.is("a.parent-dir")){j=cS.from_elem(fm);if(j){fl={file_nsid:j.ns_id,file_sjid:j.sjid,firefly:cb.firefly_enabled,match_type:j.match_type,position:j.sort_rank,request_id:j.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fl)}}},dblclick:function(i,j){if($(i.target).match("a")){return}return this._click(i,j)},open_file:function(fl,i,T,j){var fm,fn;if(T==null){T=false}if(j==null){j=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fm={user_id:ct.active_user.id,context:aX.FileViewContextType.PRIVATE,platform:aX.FileViewPlatformType.WEB,ns_id:fl.ns_id,sjid:fl.sjid,ns_path:fl.ns_path,shared_link_url:null,extra:{mode:aX.FileViewModeType.BROWSE,file_ext:aA.file_extension_for_logging(fl.filename),file_bytes:fl.bytes,file_mtime:fl.ts}};fn={file_nsid:fl.ns_id,file_sjid:fl.sjid,firefly:cb.firefly_enabled,match_type:fl.match_type,position:fl.sort_rank,request_id:fl.request_id,viewport:T?"dropdown-view":"full-view"};if(fl.dir){if(this.in_search_mode()||T){fn.action_type="folder_open";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fn)}if(i){this.open_folder_in_new_window(fl)}else{this.open_folder(fl)}return ba.TimeToFirstActionLogger.log(ct.active_user.id,"folder_open")}else{if(!i&&this.can_show_preview(fl)){if(this.in_search_mode()||T){fn.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fn)}ba.TimeToFirstActionLogger.log(ct.active_user.id,"file_view");return this.open_preview(fl,j,T)}else{if(this.in_search_mode()||T){fn.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fn)}ba.FileViewLogger.log(fm);ba.TimeToFirstActionLogger.log(ct.active_user.id,"file_view");return window.open(fl.href,"_blank")}}},close_preview_callback:function(){bF(document).off("db:filepreview:close",this.close_preview_callback);af.close_shared_link_view();return ct.set_title()},preview_compressed:function(j,i){return n.show(j,ct.active_user,{files:[j,i],file_view_mode:aX.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(T,i,fl,j){if(i==null){i=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(fl==null){fl=false}if(j==null){j=false}if(this.can_show_preview(T)){a6.filepreview_from_selected(T,fl,j,i);return bF(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(T,fl){var j,i;this.keyboard_nav=false;j=cS.from_elem(fl);if(j.editing){return}i=(T.which===2)||(d6.is_mac()&&T.metaKey);ct.open_file(j,i,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);T.preventDefault()},crumb_click:function(fl,i){var T,j;this.keyboard_nav=false;fl.preventDefault();j=i.readAttribute("data-fq_path");T=this.details_from_fq_path(j);return a4.set_path_url(T.ns_id,T.ns_path)},parent_click:function(fm,fl){var T,fn,i,j;this.keyboard_nav=false;fm.preventDefault();j=fl.readAttribute("data-parent_ns_path");i=parseInt(fl.readAttribute("data-parent_ns_id"),10);a4.set_path_url(i,j);T=cS.from_elem(fl);if(T){fn={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:cb.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fn)}},selection_handler:function(){if(eW.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var i,T,j,fl;if(this.in_search_mode()&&!cb.end_of_results){j=a6.get_files_in_view(),fl=j[0],T=j[1];i=this.files.length-(fl+T);if(i<=50&&!$("browse").hasClassName("pending-search")){cb.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a6.load_visible_thumbs.bind(a6),this.POST_SCROLL_WAIT)},unscoped_search:function(){return cb.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var j,i;this.last_sort=ay;i="#browse-sort a.sortable-column-header";j=$$(i)[0];d6.add_sort_arrow_mouseover(j,true,i,false);$("kind-sorter-label").__date(ds.DISPLAY.FILES_BY_KIND);return cx.src(j.down("img"),"web","arrow-up-gray")},sort_handler:function(fo,T,fn){var fm,fl,i,j;T=$(T);T.blur();j=T.readAttribute("data-sort");if(fn!=null){}else{if(this.last_sort[0]===bq[j]){fn=T.readAttribute("data-ascending")==="false"}else{fn=j!=="FILES_BY_MODIFIED"}}if(ds.has_label(j)){fl=ds.next(j);$("sharing-sorter-label").__date(fl.display);j=fl.label;T.writeAttribute("data-sort",j);fn=ds.IS_ASC[j]}else{T.writeAttribute("data-ascending",(fn?"true":"false"))}i="#browse-sort a.sortable-column-header";d6.add_sort_arrow_mouseover(T,fn,i,true);fm=bq[j];this.sort(fm,fn,j);if(fo){return fo.stop()}},toggle_deleted:function(){var i;i=!a4.get_del();return a4.set_del_url(i)},unused_filename:function(fu,fz){var T,fA,fl,fs,ft,fn,fw,fm,fv,fx,fq,fo,fp,fr,fB,fy;if(fz==null){fz=false}fy=aA.filename_without_extension(fu);fB=aA.file_extension(fu,T=true);fs=[];fp=ct.files;for(fv=0,fx=fp.length;fv<fx;fv++){fA=fp[fv];fo=aA.filename_without_extension(fA.filename);fq=aA.file_extension(fA.filename,T=true);fn=fo.toLowerCase().indexOf(fy.toLowerCase())===0;ft=fB.toLowerCase()===fq.toLowerCase();fm=!fz||fA.dir;if(fn&&ft&&fm){fs.push(fA.filename.toLowerCase())}}if(fB){fB="."+fB}else{fB=""}fl=fy+fB;fw=1;while(true){if(fr=fl.toLowerCase(),cT.call(fs,fr)<0){break}fl=fy+" ("+fw+")"+fB;fw++}return fl},new_folder:function(){var ft,fl,T,fm,fq,i,j,fo,fr,fs,fn,fp;if(this.reloading||this.creating_folder){return}if(ct.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fq=new a2(ct.active_user,{element_id:"create-and-share-new-folder-modal-"+ct.active_user.id,destination_dir:this.containing_fq_path()});fq.show();return}this.hide_empty();this.selectable();T=this.unused_filename(eA("New folder"),fr=true);fp=fg.tmpl("new_folder_tmpl",{name:T,Sprite:cx,_:eA});fm=-1;if(this.files.length){fn=C.scroll_offsets();if(fn.top>0){fs=this.files[0].get_div().getLayout().get("margin-box-height");fm=Math.floor(fn.top/fs)}}if(fm>0){this.files[fm].get_div().__sert({after:fp})}else{$("browse-files").__sert({top:fp})}i=$$("#browse-files .browse-new-folder .name").first();cL(i!=null,"expected new_folder_name to be defined");ft=this.containing_fq_path();fo=(function(fu){return function(fx){var fw,fv,fy;fy=fx.responseText.evalJSON(true);cL(fy.new_browse_files.length===1,"No new file data returned.");fw=aA.filename(fy.new_browse_files.first().fq_path);fv=eA("Created folder '%(folder_name)s'");fv=fv.format({folder_name:bU.em_snippet(fw,25)});ah.success(fv);fu.select_fq_paths=[fy.new_browse_files.first().fq_path];return fu.force_reload()}})(this);j=(function(fu){return function(fw){var fv;fv=$$("#browse-files li.browse-new-folder").first();if(fv){fv.remove()}return fu.creating_folder=false}})(this);fl=new Ajax.InPlaceEditor(i,"/cmd/new"+(d6.urlquote(ft)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:j,savingText:eA("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fo,subject_user:ct.active_user},callback:(function(fu){return function(fv,fw){fu.creating_folder=true;return{to_path:fw||"",folder:"yes"}}})(this)});return fl.enterEditMode()},open_folder:function(j){var fl,i,T;cL(j.dir,"Only open directories, not files");if(ct.inside_dir&&ct.containing_ns_path()===j.ns_path&&!this.in_search_mode()){return}if(!(eW.get_selected_files().length===1&&eW.get_selected_files().indexOf(j)===0)){eW.deselect_all();fl=typeof j.get_div==="function"?j.get_div():void 0;if(fl){fl.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fm){return function(){var fn;if(!fm.reloading){return}fn=eA("Loading %(filename)s...");fn=fn.format({filename:bU.em_snippet(j.filename,50)});return fm.folder_loading_notification=ah.success(fn,60,true)}})(this),1000);if(j.target_ns){i=j.target_ns;T=""}else{i=j.ns_id;T=j.ns_path}if(j.is_deleted){return a4.set_path_url(i,T,true)}else{return a4.set_path_url(i,T)}},open_folder_in_new_window:function(i){return window.open(a4._make_url(i.ns_id,i.ns_path),"_blank")},show_message:function(T){var j,i;if((typeof T)!==(typeof"string")){i=$("browse-files").down(".browse-message");if(i){i.show()}return}this.msg=T;j=new Element("div",{"class":"browse-message"});j.__date(T);return $("browse-files").__sert(j)},sort:function(j,fm,i,fl){var T;if(!fl&&j===this.last_sort[0]&&fm===this.last_sort[1]){return}this.last_sort=[j,fm,i];T=j(fm);this.files.sort(T);this.smartfill();a6.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var fl,i,T,j;i=this.last_sort;T=i[0];fl=i[1];j=i[2];return this.sort(T,fl,j,true)},in_search_mode:function(){return bF("#browse").hasClass("search")},flex_column:function(){return $("sharing-sorter").readAttribute("data-sort")},smartfill:function(){var T,fo,fm,fp,fl,i,fq,fn;T=$("browse-files");fn=[];fp=this.in_search_mode();fq=this.files;for(fl=0,i=fq.length;fl<i;fl++){fo=fq[fl];fm=this.flex_column();fn.push(this.compiled_tmpl({file:fo,in_search_mode:fp,flex_column:fm,Browse:ct,Sprite:cx,Constants:Constants,FilePath:aA,Emstring:bU,GandalfUtil:az,_:eA}))}T.__date(fn);document.fire(dN.RENDER);return bF(document).trigger(dN.RENDER)},search_smartfill:function(fr,fl){var i,fq,fo,T,fm,fp,fn;if(fl==null){fl=null}fn=[];for(fm=0,fp=fr.length;fm<fp;fm++){fq=fr[fm];T=a6.make_browsefile(fq,fl);T.track_in_browse();fo=this.compiled_search_tmpl({file:T,BrowseInterface:fi,Browse:ct,Sprite:cx,Constants:Constants,_:eA,searchHelpers:ap,HTML:fg,FilePath:aA,Emstring:bU,Util:d6});i=bF(fo.toHTML());fn.push(i)}bF("#browse-files").append(fn);document.fire(dN.RENDER);bF(document).trigger(dN.RENDER);a6.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(i){this.files.push(i);if(i.target_ns){ct.ns_id_to_mount_point[i.target_ns]=i.fq_path}if(i.bytes<0){return this.deleted_shown=true}},insert_file:function(T,j){var i;if(!T){return}j=j||0;i=this.find_file(T.fq_path);if(i&&i!==T){this.remove_file(i)}cS._file_index[T.to_key()]=T;this.update_file_pos(T);if(j){T.get_div().setStyle({display:"none"})}document.fire(dN.RENDER);return bF(document).trigger(dN.RENDER)},add_files:function(i){return ct._push_files(i.file_info)},get_file_pos:function(i){var j;j=this.files.indexOf(i);cL(j!==-1,"file not present in @files");cL(i.to_key() in cS._file_index,"file not present in BrowseFile._file_index");return j},remove_file:function(i){var T,j;if(!i){return}T=this.files.indexOf(i);if(T!==-1){this.files.splice(T,1);delete cS._file_index[i.to_key()];return(j=i.get_div())!=null?j.remove():void 0}},update_file_pos:function(fn,fp){var i,fr,fl,fm,fo,T,j,fq;if(fp==null){fp=-1}fq=this.files.indexOf(fn);if(fq!==-1){this.files.splice(fq,1)}delete fn.sort_rank;T=this.last_sort[0];fo=this.last_sort[1];if(fp>=0){fq=fp}fm=this.in_search_mode()?fq:d6.bsearch(this.files,fn,T(fo),true);this.files.splice(fm,0,fn);fl=fn.get_div();i=$("browse-files");if(fl){fl.remove()}if(this.in_search_mode()){j=this.compiled_search_tmpl({file:fn,Browse:ct,BrowseInterface:fi,Constants:Constants,Emstring:bU,FilePath:aA,HTML:fg,searchHelpers:ap,Sprite:cx,Util:d6,_:eA})}else{j=this.compiled_tmpl({file:fn,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),Browse:ct,Constants:Constants,Emstring:bU,FilePath:aA,Sprite:cx,GandalfUtil:az,_:eA})}fr=i.childElements();if(fm<fr.length){return i.childElements()[fm].__sert({before:j})}else{return i.__sert(j)}},find_file:function(i){return this.files.find(function(j){return j.fq_path.toLowerCase()===i.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cS._file_index={};return bR._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return cb.hide_empty()},show_empty:function(){var i;this.hide_empty();if(bF("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){i="#browse-empty-team-folder"}else{i="#browse-empty"}bF(i+" .drag-prompt").toggle(!this.is_read_only);if(!ct.in_search_mode()){return bF(i).show()}},hide_empty:function(){return bF("#browse-empty, #browse-empty-team-folder").hide()},update:function(i,j){if(j==null){j=null}$("browse-box").show();if(this.in_search_mode()){return this.search_smartfill(i.file_info,j)}else{this.clear();if(typeof i==="string"){i=JSON.parse(i)}this.setup(i,j);this.resort();document.fire(dN.UPDATE);return bF(document).trigger(dN.UPDATE)}},reload_fqpath:function(j,i){return this.reload(null,d6.urlquote(j),i)},force_reload:function(){return this.reload(this.containing_ns_id(),d6.urlquote(this.containing_ns_path()),true)},set_title:function(){var i;if(ct.in_search_mode()){cb.set_title();return}if(!ct.inside_dir){return}i=this.containing_fq_path();return document.title=i?aA.filename(i)+" - Dropbox":cM.get_viewer().is_paired&&ct.active_user.role===Constants.ROLE_WORK?cM.get_viewer().team_name+" - Dropbox":cM.get_viewer().is_paired&&ct.active_user.role===Constants.ROLE_PERSONAL?eA("Personal")+" - Dropbox":eA("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(fr){var fl,T,fq,fo,fp,fn,i,fm;i=fr.select_fq_paths;fm=fr.select_index;if(i||fm>-1){T=[];if(i){for(fo=0,fp=i.length;fo<fp;fo++){fq=i[fo];fn=this.find_file(fq);if(fn){T.push(fn)}}}if(!T.length&&fm>-1){fl=this.files[fm];if(fl){T.push(fl)}}if(T.length){eW.set_selected_files(T);this.scrollToWithPadding(T.first().get_div(),100)}fr.select_fq_paths=false;return fr.select_index=-1}},set_selection_from_item_counters:function(){var fl,fq,fn,fo,fm,fr,fp,T,fs,ft;if(this.select_item_counters!=null){fn={};T=this.select_item_counters;for(fo=0,fr=T.length;fo<fr;fo++){fq=T[fo];fn[fq]=true}ft=[];fs=this.files;for(fm=0,fp=fs.length;fm<fp;fm++){fl=fs[fm];if(fl.root_coll_item_counter in fn){ft.push(fl)}}eW.set_selected_files(ft);return this.select_item_counters=null}},reload:function(fl,fq,j){var fs,fm,fr,T,fo,fn,fp,i;T="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fq+")";cL(fq.search(eD.URL_ESCAPE_REGEX)===-1,T);if(fl==null){fl=ct.active_user.root_ns}fq=aA.normalize(fq);if(a6.get_mode()!==a6.BROWSE_MODE){this.clear();a6.set_browse_mode()}if(cb._clear_on_reload){cb.clear_searchbox()}if(!aq.uploading){c1.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fq===this.containing_ns_path()&&fl===this.containing_ns_id()&&!j){return}fp=this.first_load?Constants.referrer:"";fr=this.deleted_shown?"?show_deleted=yes":"";fn={ns_id:fl,referrer:fp,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bq.FOLDERS_FIRST};fn=Object.extend(fn,this.extra_reload_args);eI("Browse.reload:",fq);this.reloading=true;i="/browse"+fq+fr;fs=2;fm=["browse",fl,fq,fr,ct.active_user.id,fs];fo=(function(ft){return function(fu){ft.reset_state();ft.update(fu);(ft.files.length?ft.hide_empty.bind(ft):ft.show_empty.bind(ft))();clearTimeout(ft.folder_loading_timeout);if(ah.isShown()&&ah.current()===ft.folder_loading_notification){ah.clear()}C.scroll_clear_cache();if(ft._is_item_selection_needed()){if(ft.paginating&&!ft._are_all_selected_items_fetched()){ft._wait_for_items()}else{ft.set_selection_from_fq_paths_or_index(ct)}}if(!n.shown()){return ft.set_title()}}})(this);bF(document).trigger(dN.BEFORE_UPDATE,{ns_id:fl,ns_path:G.decode(fq)});new Ajax.DBRequest(i,{allow_retries:true,subject_user:ct.active_user,parameters:fn,log_timing:true,on304:function(ft){},onSuccess:(function(ft){return function(fA){var fx,fu,fw,fC,fy,fv,fz,fB;if(ft.in_search_mode()){return}fC=JSON.parse(fA.responseText);fB=null;fz=null;fo(fC);if(fB){fv=[];for(fw=0,fy=fB.length;fw<fy;fw++){fx=fB[fw];fv.push(ct.find_file(fx.fq_path))}eW.set_selected_files(fv);window.scrollTo(fz[0],fz[1])}else{ct.set_selection_from_item_counters()}if(ct.sharing_autoselect_first_file_enabled&&!eW.has_selected_files()){fu=ft.files[0];eW.set_selected_files([fu])}if(ft.first_load){return eg.mark_time_to_interactive()}}})(this),onFailure:(function(ft){return function(){if(ft.first_load){ft.reload.bind(ft).defer(Constants.root_ns,"")}return clearTimeout(ft.folder_loading_timeout)}})(this),cleanUp:(function(ft){return function(){ft.first_load=false;return ft.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return ct.inside_shared_folder&&ct.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return ct.inside_team_folder&&ct.containing_ns_path()},is_shmodelable_path:function(i){var j;if(ct.public_app_token){return false}if(i===""){return false}if(ct.public_folder_enabled){j=i.toLowerCase();if(j.startsWith("/public/")){return false}}return true},can_show_preview:function(i){var j;return this.browser_supports_previews||((j=i.preview_type)==="photo"||j==="video")},can_get_details_from_fq_path:function(T){var j,i;j=this.containing_fq_path();i=this.containing_mount_point();return(i&&T.startsWith(i))||j.startsWith(T)},details_from_fq_path:function(fl){var fm,j,i,T;cL(this.can_get_details_from_fq_path(fl));j=this.containing_mount_point();if(j&&fl.startsWith(j)){i=this.containing_ns_id();T=fl.slice(j.length);fm=aA.filename(fl,this._get_root_name())}else{i=Constants.root_ns;T=fl;fm=aA.filename(fl,this._get_root_name())}return{ns_id:i,ns_path:T,fq_path:fl,folder_name:fm||this._get_root_name(),url:String(fi.browse_uri_for_fq_path(ct.active_user,fl)),icon:(fl.length?"folder_32":this._get_root_icon())}},update_header_status:function(i){return bF("#browse-header-status").text(i)},update_header_height:function(){var j,fl,T,i;fl=bF("#browse-header");j=bF("#browse-files");i=0;if(fl.css("position")==="fixed"){i=bF(window).scrollTop()}if(!C.is_page_scrollable()){i=Math.abs(parseFloat(bF("html").css("top"))||0)}T=fl.offset().top+fl.height()-j.offset().top-i;return j.css("padding-top",T)},_make_breadcrumbs_data:function(){var fp,fq,fm,fl,fo,T,fn;fq=this.containing_fq_path();fp=[];T=fq.split("/");for(fm=fl=0,fn=T.length;0<=fn?fl<fn:fl>fn;fm=0<=fn?++fl:--fl){fo=aA.normalize(T.slice(0,fm+1).join("/"));fp.push(this.details_from_fq_path(fo))}return fp},_get_root_icon:function(){if(!cM.get_viewer().is_paired){return"glyph"}if(ct.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(ct.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cM.get_root_name(ct.active_user)},_get_max_breadcrumb_width:function(fl){var j,T,i;T=fl?this._DROPDOWN_WIDTH:new bU(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){j=bF("#browse-rightmenu").width();i=bF("#browse-global-actions-bar").width();return((i-j)*this._FUDGE_FACTOR/this._PX_TO_EM)-T}else{return this._MAX_BREADCRUMB_WIDTH-T}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var ft,fl,fo,fv,fq,fp,fs,T,fu,fm,fr,fn;fl=this._make_breadcrumbs_data();fn=fl.collect(function(i){return new bU(i.fq_path?i.folder_name:"").length});fr=0;fo=0;cL(fl.length>0,"expected at least one breadcrumb");fu=this._get_max_breadcrumb_width();for(fq=fp=fm=fl.length-1;fm<=0?fp<=0:fp>=0;fq=fm<=0?++fp:--fp){fr+=fn[fq];if(fr>fu){break}fo+=1;fr+=this._CONNECT_WIDTH}fv=fl.slice(0,fl.length-Math.max(1,fo));fl=fl.slice(fv.length,fl.length);if(!fv.length&&fl.length>1){fl.shift()}fs=fl.pop();ft=fg.tmpl("breadcrumb_tmpl",{breadcrumbs:fl,dropdown:fv,containing_fq_path:this.containing_fq_path(),url_root:fi.get_browse_root(ct.active_user),root_name:this._get_root_name(),Sprite:cx});T=fs.folder_name;if(fs.fq_path!==""){T=bU.em_snippet(T,this._get_max_breadcrumb_width(fv.length>1))}$("browse-location").__date(ft);$("browse-location").__sert(" "+T);if(fv.length>1){return this._render_breadcrumbs_dropdown(fv)}},_render_breadcrumbs_dropdown:function(fm){var fl,i,T,j;i=$("breadcrumbs-box");fm.reverse();j=fg.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fm,Sprite:cx,Emstring:bU});$("browse-location").__sert(j);T=$("breadcrumb-dropdown");fl=function(fo){var fn;fo.stopPropagation();T.show();fn=bF(i);return bF(T).clonePosition(fn,{setWidth:0,setHeight:0,offsetTop:fn[0].offsetHeight,offsetLeft:parseInt(fn.css("padding-left"),10)})};i.observe("click",fl);i.observe("dragover",fl);return document.observe("click",function(){i.removeClassName("down");return T.hide()})},viewportOffset:function(){var i,T,j;if(!this.files.length){return}if(!this.div_parent){T=this.files[0].get_div().offsetParent;if(!T){return}this._viewportOffset={};this.div_parent=$(T);this._cumulativeOffset=this.div_parent.cumulativeOffset()}i=d6.scrollLeft(this.div_parent);j=d6.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==j||this.scrollLeft!==i){this._viewportOffset.top=this._cumulativeOffset.top-j;this._viewportOffset.left=this._cumulativeOffset.left-i;this.scrollLeft=i;this.scrollTop=j}return this._viewportOffset},selectable:function(){return d6.enableSelection($("browse-files"))},unselectable:function(){return d6.disableSelection($("browse-files"))},_header_offset:(function(){var i;i=$("browse-header");return i.getHeight()+i.cumulativeOffset().top}).cached(1000),scrollTo:function(i){return this.scrollToWithPadding(i,3)},scrollToWithPadding:function(fl,fn){var T,fo,j,fm,i;if(!fl){return}fm=C.viewport_dimensions();i=C.scroll_offsets();fo=fl.cumulativeOffset().top-i.top;T=fl.getHeight();j=this._header_offset();if(fo<j){C.scroll_to(0,i.top+fo-j-fn)}else{if(fo+T>fm.height){C.scroll_to(0,i.top+fo+T-fm.height+fn)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return fb.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(i){this._visible_change_callbacks[this._next_visible_change_callback_id]=i;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(i){return delete this._visible_change_callbacks[i]},fire_visible_change_callbacks:function(){var T,fo,fl,fm,i,j,fn;if(!bF.isEmptyObject(this._visible_change_callbacks)){fm=a6.get_files_in_view(),fn=fm[0],T=fm[1];i=this._visible_change_callbacks;j=[];for(fl in i){fo=i[fl];j.push(fo(this.files,this.active_user.id,fn,T))}return j}}};k=E.BrowseUpdate=(function(){var i,fp,fo,fl,fn,fm,T,j;T=function(fr){var fs,ft,fq;if(!ct.inside_dir){return}ft=fr.parent_changes;if(ft.change_to_fq_path!=null){if(ft.change_type==="moved"){if(ft.is_changing_view){fs=eA("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fs=fs.format(ft.old_fq_path.escapeHTML(),d6.urlquote(ft.new_fq_path))}else{fs=eA("This folder has been moved")}}else{if(ft.change_type==="renamed"){if(ft.is_changing_view){fs=eA("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fs=fs.format(ft.old_fq_path.escapeHTML(),d6.urlquote(ft.new_fq_path))}else{fs=eA("This folder has been renamed to '%s'.");fq=ft.change_to_fq_path.split("/");fs=fs.format(fq[fq.length-1].escapeHTML())}}else{fs=eA("The folder '%s' has been deleted.");fs=fs.format(ft.old_fq_path.escapeHTML())}}if(ft.is_changing_view){ah.error(new fg(fs))}else{if(ft.old_fq_path===ct.containing_fq_path()){ah.success(new fg(fs))}}ct.reload_fqpath(ft.change_to_fq_path);return}return fm(fr)};j=function(fu){var fs,ft,fw,fz,fy,fr,fA,fq,fx,fv;fz=[];fv=[];if(!ct.in_search_mode()){return}cb.clear_cache();for(fr in ct.ns_id_to_mount_point){if(!(fr in fu.mount_points)){fu.mount_points[fr]=null}}fq=fu.mount_points;for(fr in fq){fy=fq[fr];fr=parseInt(fr,10);fA=ct.ns_id_to_mount_point[fr];if(fy===fA){continue}if(fy){ct.ns_id_to_mount_point[fr]=fy}else{delete ct.ns_id_to_mount_point[fr]}fx=ct.files;for(ft=0,fw=fx.length;ft<fw;ft++){fs=fx[ft];if(fs.fq_path.indexOf(fA)===0&&fs.target_ns!==fr){if(fy){fs.fq_path=fy+fs.fq_path.slice(fA.length);fs.href=fi.get_browse_root(ct.active_user)+fy+fs.href.slice(5+fA.length);fz.push([fs,fs])}else{fv.push(fs)}}}}return fm(fu,[],fv,fz)};fm=function(fN,fu,fK,ft){var fB,fq,fL,fC,fG,fr,fI,fH,fJ,fw,fv,fF,fs,fA,fz,fy,fE,fD,fM,fx;if(fu==null){fu=[]}if(fK==null){fK=[]}if(ft==null){ft=[]}fs=fN.added;for(fI=0,fJ=fs.length;fI<fJ;fI++){fL=fs[fI];fq=aA.normalize(aA.parent_dir(fL.ns_path));if(ct.in_search_mode()||(fL.ns_id===ct.containing_ns_id()&&fq===ct.containing_ns_path())){fB=a6.make_browsefile(fL);fB.track_in_browse();fu.push(fB)}}fA=fN.removed;for(fH=0,fw=fA.length;fH<fw;fH++){fC=fA[fH];fK.push(ct.find_file(fC))}fz=fN.moved;for(fF=0,fv=fz.length;fF<fv;fF++){fy=fz[fF],fG=fy[0],fx=fy[1];fM=aA.normalize(aA.parent_dir(fx.ns_path));fD=null;fE=ct.in_search_mode()||(fx.ns_id===ct.containing_ns_id()&&fM===ct.containing_ns_path());fr=ct.in_search_mode();if(fE&&!(fr&&ct.find_file(fx.ns_path))){fD=a6.make_browsefile(fx);fD.track_in_browse()}ft.push([ct.find_file(fG),fD])}document.fire(bE.ADD,{files:fu});bF(document).trigger(bE.ADD,{files:fu});document.fire(bE.MOVE,{files:ft});a6.load_visible_thumbs();ct.fire_visible_change_callbacks();return fn(fu,fK,ft)};i=function(ft,fr,fs,fq){ft.css("background","");bF(document).trigger(dN.UPDATE_RENDERED);return document.fire(bE.REMOVE,{files:fs})};fn=function(fB,fz,fC){var ft,fE,fy,fv,fA,fx,fu,fs,fq,fr,fw,fD;fw=(fB.length+fz.length)<=10;for(fy=0,fA=fB.length;fy<fA;fy++){ft=fB[fy];if(!(ft&&ft.get_div())){continue}fp(ft,fw,fB,fz,fC)}for(fv=0,fx=fz.length;fv<fx;fv++){ft=fz[fv];if(!(ft&&ft.get_div())){continue}fl(ft,fw,fB,fz,fC)}fr=[];for(fs=0,fu=fC.length;fs<fu;fs++){fq=fC[fs],fE=fq[0],fD=fq[1];if(fE){fl(fE,fw,fB,fz,fC)}if(fD){fr.push(fp(fD,fw,fB,fz,fC))}else{fr.push(void 0)}}return fr};fo=function(fq){var fr;fr=eW.is_selected(fq)?"#83B8DC":"#CCEAFF";return bF(fq.get_div()).css("background-color",fr)};fl=function(fq,ft,fs,fu,fr){var fv;fo(fq);fv=bF(fq.get_div());if(ft){return fv.show().slideUp("normal",function(){return i(fv,fs,fu,fr)})}else{fv.hide();return i(fv,fs,fu,fr)}};fp=function(fq,ft,fs,fu,fr){var fv;fo(fq);fv=bF(fq.get_div());if(ft){return fv.hide().slideDown("normal",function(){return i(fv,fs,fu,fr)})}else{fv.show();return i(fv,fs,fu,fr)}};return{init:function(){var fr,fq;fq=d8[ct.active_user.id];return fr=fq.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fy,fv,fx,fu,fs,fw,ft;fu=ct.in_search_mode();fy=fu?j:T;ft=fu?"/update/list_search":"/update/list_dir";if(!(ct.inside_dir||fu)){fq.handler_failure(fr);return}if(fu){fw=cb.get_state();fx={all_terms:fw.query}}else{fx={fq_dir:ct.containing_fq_path(),show_deleted:ct.deleted_shown}}fx.ns_map=((function(){var fA,fz;fA=fq.get_ns_map();fz=[];for(fv in fA){fs=fA[fv];fz.push(fv+"_"+fs)}return fz})()).join(",");cL(ct.active_user,"No active_user was set before calling "+ft+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);return new bF.ajax(ft,{data:fx,dataType:"json",type:"POST",subject_user:ct.active_user,success:function(fz){fy(fz);return fq.handler_success(fr,{ns_map:fz.ns_map})},error:function(){return fq.handler_failure(fr)}})}})}}})();var ec;ec=E.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(j,fm){var fl,T,i;if(j.async_task_id){if(!j.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}T=j.async_task_id}else{T=j.job_id}ec.job_info[T]={};fl=ec.job_info[T];fl.subject_user=j.subject_user||((i=j.parameters)!=null?i[a9.UID_PARAM_NAME]:void 0);fl.req=j;fl.is_async_task=!!j.async_task_id;fl.poll_int=ec.INIT_POLL_INT;fl.poll_count=0;fl.int_id=setInterval(ec.update_for(T),fl.poll_int);fl.failures=0;fl.start_time=b6.time();return fl.dont_hide=fm},update_for:function(i){return function(){return ec.update(i)}},backoff:function(j){var i;i=ec.job_info[j];clearInterval(i.int_id);i.poll_int=Math.min(Math.floor(i.poll_int*1.5),30000);return i.int_id=setInterval(ec.update_for(j),i.poll_int)},update:function(T){var i,j;j=ec.job_info[T];if(dl.peek(T)){return ec.done(T)}j.poll_count++;if(j.poll_count%10===0){ec.backoff(T)}if(!j.modaled&&b6.time()-j.start_time>ec.MODAL_WAIT_MS){i=j.req.options;eB.show(i.progress_text);i.onProgress=eB.update;if(i.on_modal_shown!=null){i.on_modal_shown()}j.modaled=true}if(j.is_async_task){return ec.get_async_task_status(T)}else{return ec.get_job_status(T)}},get_job_status:function(i){return new Ajax.DBRequest("/job_status/"+i,{method:"post",subject_user:ec.job_info[i].subject_user,onSuccess:function(T){var fl,j;fl=ec.job_info[i];j=T.responseText;if(j.indexOf("err")===0){ec.done(i);if(fl.req.options.onFailure&&!dl.handled(i)){fl.req.options.onFailure(T)}return}if(j.indexOf("done")===0){fl.req.options.job=false;if(!dl.peek(i)){new Ajax.Request("/job_results/"+i,{method:"post",parameters:{t:bw.read(aK.JS_CSRF_COOKIE)},onSuccess:function(fn){if(dl.handled(i)){return}ar.clearWorkingMessage();if(fl.req.options.onSuccess){return fl.req.options.onSuccess(fn)}},onFailure:function(fn){if(dl.handled(i)){return}ar.clearWorkingMessage();if(fl.req.options.onFailure){return fl.req.options.onFailure(fn)}}})}return ec.done(i)}else{try{if(fl.req.options.onProgress){return fl.req.options.onProgress(T.responseText)}}catch(fm){}}},onFailure:function(j){var T;T=ec.job_info[i];T.failures++;if(T.failures>=ec.FAILS_MEAN_FAIL){if(T.req.options.onFailure){T.req.options.onFailure(j,true)}ar.remove(T.req);return ec.done(i)}}})},get_async_task_status:function(i){return new Ajax.DBRequest("/async_task_status/"+i,{method:"post",subject_user:ec.job_info[i].subject_user,onSuccess:function(T){var fl,j;fl=ec.job_info[i];j=T.responseText;if(j.indexOf("done:")===0||j.indexOf("err:")===0){dl.handled(i);ar.clearWorkingMessage();if(j.indexOf("done:")===0){T.responseText=j.substr(5)}if(fl.req.options.onSuccess){fl.req.options.onSuccess(T)}if(fl.req.options.onComplete){fl.req.options.onComplete(T)}return ec.done(i)}else{if(j.indexOf("async_task_err:")===0){ah.error(new fg(j.substr(15)));dl.handled(i);ar.clearWorkingMessage();ec.done(i);return ct.force_reload()}else{try{if(fl.req.options.onProgress){return fl.req.options.onProgress(T.responseText)}}catch(fm){}}}},onFailure:function(j){var T;T=ec.job_info[i];T.failures++;if(T.failures>=ec.FAILS_MEAN_FAIL){try{if(T.req.options.onFailure){T.req.options.onFailure(j,true)}}catch(fl){}ar.remove(T.req);return ec.done(i)}}})},done:function(j){var i;i=ec.job_info[j];clearInterval(i.int_id);if(!i.dont_hide){delete ec.job_info[j];if(!(i.req.async_task_id&&i.req.async_task_id!==j)){return eB.hide(j)}}else{return eB.update("1/1")}}};var du,bY,bC,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};bC=E.NamespaceEvents=(function(){function i(j){this.ns_id=j;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return i})();du=E.EventDatePicker=(function(){function i(T){var j,fl,fm;this.on_change=T;bF(document.body).on("click",(function(fn){return function(fo){return fn.hide_calendar(fo)}})(this));fm=new Element("div",{id:"cal_container"});bF(fm).bind("click",function(fn){return fn.preventDefault()});bF(document.body).append(fm);this.calendar=new I("cal_container",{onDateChange:(function(fn){return function(fo){return fn.on_change(fo)}})(this),disable_future:true});bF(fm).css("position","fixed");fl=bF("#cal_date");j=bF("#cal_container");j.clonePosition(fl,{setWidth:false,setHeight:false,offsetTop:fl.height(),offsetLeft:fl.width()-j.children().first()[0].offsetWidth});this.hide_calendar()}i.prototype.show_calendar=function(j){if(this.shown){bF("#cal_container").hide();this.shown=false;return}bF("#cal_container").show();return this.shown=true};i.prototype.hide_calendar=function(j){if(j&&bF(j.target).closest("#cal_date").length>0){return}bF("#cal_container").hide();this.shown=false;return true};return i})();bY=INLINE_JS.Events=E.Events={ns:null,role:"all",now:Number(new Date()),timestamp:d6.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(i,fn,fp,T,fo){var fl,fm,j;if(fo==null){fo=false}this.awaitingFirstRender=true;j=eD.deconstruct_url();this.first_event_map=i;this.roles=fn;this.rss_data=fp;this.role_has_events=T;this.deletions_only=fo;this.role_picker=C.controller(bF("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(j.qargs.role){this.role=j.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new du((function(fq){return function(fr){fq.change_date(fr);fq.set_url();return ba.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fq){return function(){fq.role=fq.role_picker.get_state();if(fq.ns&&!bx(fq.valid_roles()).any(function(fr){return fr.ns_ids.contains(fq.ns.ns_id)})){fq.ns=null;aS.set_selected_by_value(bF("#namespace-list")[0],"false")}fq.set_url();return fq.get_more(true)}})(this);bO.set_during_login_callback((function(fq){return function(fs,fr){return window.location.reload()}})(this));bF(window).bind("beforeunload",(function(fq){return function(){fq.user_navigated_away=true;return void 0}})(this));if(bF("#namespace-list-container")[0]){bF("#namespace-list-container")[0].observe("db:change",(function(fq){return function(fr){fq.ns=fq.namespaces[JSON.parse(fr.memo)];fq.set_url();fq.get_more(true);return ba.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bF(window).on("scroll",(function(fq){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-C.viewport_dimensions().height-10);return fq.get_more()}})(this));if(j.qargs.ns){aS.set_selected_by_value(bF("#namespace-list")[0],j.qargs.ns);this.ns=this.namespaces[j.qargs.ns]}if(j.qargs.date){fm=j.qargs.date.split("-").map(Number);fl=new Date(fm[2],fm[1]-1,fm[0]);this.date_picker.calendar.selected_date=fl;this.change_date(fl)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var fq,fp,fl,fo,T,fr,fn,fm;this.namespaces={};fr=bx(this.roles).values();for(fq=0,fl=fr.length;fq<fl;fq++){fm=fr[fq];fn=fm.ns_ids;for(fp=0,fo=fn.length;fp<fo;fp++){T=fn[fp];this.namespaces[T]=new bC(T)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(i){this.timestamp=Number(i)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bF("#cur_date_text").text(N.localize(i));return this.get_more(true)},is_scrolled_down:function(){var i,T,j;j=C.scroll_offsets().top;T=C.viewport_dimensions().height;i=bF("#events").height();return j+T+50>=i},get_more:function(fl){var i,j,T;if(this.request_in_flight){return}if(bx(this.valid_nss()).all(function(fm){return fm.done})){this.render();return}if(!(fl||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();j=(function(fm){return function(){return bx(fm.valid_nss()).map(function(fn){return fn.ns_id}).join(",")}})(this);i=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));T={page_size:25,ns_ids:j(),timestamp:i};if(this.deletions_only){T.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:T,onSuccess:(function(fm){return function(fB){var fu,fn,fv,fs,fr,fx,ft,fq,fA,fp,fz,fo,fy,fw;fu=JSON.parse(fB.responseText);fm.request_in_flight=false;fo=fu.events;for(fv=0,fx=fo.length;fv<fx;fv++){fn=fo[fv];fn.html=bF(fn.html)[0];fz=fn.pkey+" "+(fn.html.textContent||fn.html.innerText);fA=fm.namespaces[fn.ns_id];if(!fA.seen[fz]){fA.events.push(fn);fA.seen[fz]=true;fA.earliest=fn.timestamp}}if(fu.events.length>0){fy=fu.ns_ids;for(fs=0,ft=fy.length;fs<ft;fs++){fp=fy[fs];fm.namespaces[fp].earliest=bx(fu.events).map(function(fC){return fC.timestamp}).min()}}fm.render();if(fu.events.last()){fm.get_more()}else{if(bx(fu.ns_ids).join(",")!==j()){fm.get_more()}else{fw=fu.ns_ids;for(fr=0,fq=fw.length;fr<fq;fr++){fp=fw[fr];fm.namespaces[fp].done=true}}}return at.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fm){return function(){fm.request_in_flight=false;if(!fm.user_navigated_away){return ah.error(eA("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return bx(this.roles).filter((function(i){return function(j){return j.role===i.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().map((function(i){return function(j){return i.namespaces[j]}})(this)).uniq()}},earliest:function(){return bx(this.valid_nss()).map((function(i){return function(j){return j.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=d6.start_of_day(new Date(bx(this.valid_nss()).map((function(i){return function(j){return i.first_event_map[j.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=d6.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var T,fl,j,i;j=new Date(this.timestamp-this.one_day);fl=this.now-this.timestamp>0;T={};if(this.ns){T.ns=this.ns.ns_id}if(this.role!=="all"){T.role=this.role}if(fl){T.date=(j.getDate())+"-"+(j.getMonth()+1)+"-"+(j.getFullYear())}i=this.deletions_only?"/deleted_files":"/events";return eD.push_state(i,T)},on_preview_open:function(j){var i;i=cM.get_viewer().get_user_by_id(j.user_id);bF(document).on("db:filepreview:close",this.on_preview_close);n.show(j,i);return false},on_preview_close:function(){bF(document).off("db:filepreview:close",this.on_preview_close);return document.title=eA("Recent events - Dropbox")},render:function(){var fl,fA,fE,fD,fs,fB,fF,fz,fC,ft,fr,fp,fv,fG,fx,fm,fq,fu,fo,fw,fy,T,fn;if(this.role_has_events[this.role]){this.update_calendar_first_day()}fl=bx(this.valid_nss()).map((function(i){return function(j){return j.events}})(this)).flatten();fA=this.earliest();T=bx(fl).sortBy(function(i){return -i.timestamp});fs=bx(T).filter((function(i){return function(j){return j.timestamp>=fA&&j.timestamp<i.timestamp/1000&&(i.ns!==null||!j.is_dup)}})(this));if(this.role_has_events[this.role]){bF("#event-table").empty();for(fB=0,fC=fs.length;fB<fC;fB++){fq=fs[fB];fE=bF(fq.html);fu=bx(this.valid_roles()).filter((function(i){return function(j){return j.ns_ids.contains(fq.ns_id)}})(this)).map((function(i){return function(j){return j.name}})(this)).join(" & ");if(this.deletions_only){fE.find("span.role-path").text(fu)}else{fE.find("span.role-label > span").text(fu)}bF("#event-table").append(fE);if(fq.preview_jsinfo!=null){fD=fq.preview_jsinfo;fr=fE.find("#prev_link");fr.on("click",this.on_preview_open.bind(this,fD));fy=fE.find(".inline-button");fy.on("click",this._inline_share_button.bind(this,fD))}}bF("#events-container").show();bF("#events-sub-header").show();bF("#events-sub-header").css("visibility","visible");bF("#events-empty-state").hide();bF(".empty-explanation").hide()}else{if(!this.request_in_flight){bF("#events-container").hide();bF("#events-sub-header").hide();bF("#events-empty-state").show();bF(".empty-explanation").show()}}if(!this.request_in_flight){if(this.awaitingFirstRender){this.awaitingFirstRender=false;ba.WebMiscActivityLogger.log("events-first-load",{time:Number(new Date())-this.now})}bF("#more-loading").hide()}else{bF("#more-loading").show()}bF("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fp=bF("#namespace-list > li");for(fz=0,ft=fp.length;fz<ft;fz++){fF=fp[fz];fm=bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().any((function(i){return function(j){return j===bF(fF).data("value")}})(this));fx=bF(fF).data("value")===false;fn=fx||fm;bF(fF).css("display",fn?"":"none")}fw=cT.call((function(){var fH,j,i,fI;i=this.valid_roles();fI=[];for(fH=0,j=i.length;fH<j;fH++){fG=i[fH];fI.push(fG.ns_ids.length>1)}return fI}).call(this),true)>=0;if(!this.request_in_flight){if(fw){bF("#namespace-list-container").css("visibility","visible");bF("#namespace-list-container").show()}else{bF("#namespace-list-container").hide()}fo=this.rss_data[(fv=this.ns)!=null?fv.ns_id:void 0]||this.rss_data[this.role];if(fo&&this.role_has_events[this.role]){bF("#rss-feed a").attr("data-title",fo.title);bF("#rss_url").val(fo.url);bF("#reset-rss-link").on("click",(function(i){return function(j){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fo.ns_id},onSuccess:function(){ah.success(eA("RSS feed url successfully reset."));return b1.redirect("/events")}});return false}})(this));bF("#rss_url").focus();bF("#rss-feed").show();return bF("#rss-feed").css("visibility","visible")}else{return bF("#rss-feed").hide()}}},show_rss_modal:function(){var i,j;fb.show(eA("Subscribe to this RSS feed"),bF("#rss-modal")[0]);j=bF("#rss_url").val();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eA("Link copied to clipboard!"));return fb.hide()},bF(".modal-buttons"));return i.css({zIndex:1001})},_inline_share_button:function(j,fl){var i,T;fl.preventDefault();i="events_table_row";T=ba.ShmodelUILogger.get_target_item(j);ba.ShmodelUILogger.log("single_entry_share",i,T);return new dh(j.user_id,j.fq_path,i).show()}};var N;N=E.DateUtil={fromSecondsSinceEpochUTC:function(i){var j;j=new Date(1970,0,1);j.setSeconds(i);return j},applyTimezoneOffset:function(j,fl){var i,T;i=parseInt(fl,10);T=60*(fl-i);j.setHours(j.getHours()+i);return j.setMinutes(j.getMinutes()+T)},contextualFormat:function(j){var fl,fn,i,T,fm;i=new Date(Date.now());T=(i.getTime()-j.getTime())/1000;fl=0;if(T<8*3600){return b6.ago(j)}this.applyTimezoneOffset(i,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(j,Constants.TIMEZONE_OFFSET);fm=new Date(Date.now());this.applyTimezoneOffset(fm,Constants.TIMEZONE_OFFSET);fm.setDate(fm.getDate()-1);if(j.getYear()===i.getYear()&&j.getMonth()===i.getMonth()&&j.getDate()===i.getDate()){fn=eA("Today %(time)s");return fn.format({time:N.format(j,Constants.time_format)})}else{if(j.getYear()===fm.getYear()&&j.getMonth()===fm.getMonth()&&j.getDate()===fm.getDate()){fn=eA("Yesterday %(time)s");return fn.format({time:N.format(j,Constants.time_format)})}else{return N.format(j,Constants.datetime_format)}}},toUTCDate:function(i){return new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())},differenceStr:function(fl,fo){var fq,fp,j,T,fm,i,fn;fm=(fl.getTime()-fo.getTime())/1000;if(fm<60){return bd("%d sec","%d secs",fm).format(fm)}else{if(fm<3600){j=parseInt(fm/60,10);return bd("%d min","%d mins",j).format(j)}else{if(fm<86400){fp=parseInt(fm/3600,10);return bd("%d hour","%d hours",fp).format(fp)}else{if(fm<2592000){fq=parseInt(fm/(60*60*24),10);return bd("%d day","%d days",fq).format(fq)}else{if(fm<4838400){i=parseInt(fm/(60*60*24*7),10);return bd("%d week","%d weeks",i).format(i)}else{if(fm<31536000){T=parseInt(fm/(60*60*24*30),10);return bd("%d month","%d months",T).format(T)}else{fn=parseInt(fm/(60*60*24*365),10);return bd("%d year","%d years",fn).format(fn)}}}}}}},localize:function(i){cL(Constants.date_format!=null,"Date format missing.");return N.format(i,Constants.date_format)},format:function(i,j){var T;cL(typeof j==="string","Date format requires a format string");T={yy:(function(fl){return function(){return i.getFullYear().toString().substring(2)}})(this),yyyy:(function(fl){return function(){return i.getFullYear().toString()}})(this),M:(function(fl){return function(){return(i.getMonth()+1).toString()}})(this),MM:(function(fl){return function(){return(i.getMonth()+1).toString().lpad(2)}})(this),d:(function(fl){return function(){return i.getDate().toString()}})(this),dd:(function(fl){return function(){return i.getDate().toString().lpad(2)}})(this),h:(function(fl){return function(){return(i.getHours()%12||12).toString()}})(this),H:(function(fl){return function(){return i.getHours().toString()}})(this),HH:(function(fl){return function(){return i.getHours().toString().lpad(2)}})(this),m:(function(fl){return function(){return i.getMinutes().toString()}})(this),mm:(function(fl){return function(){return i.getMinutes().toString().lpad(2)}})(this),a:(function(fl){return function(){if(i.getHours()>11){return eA("PM",{comment:"PM as in evening"})}else{return eA("AM",{comment:"AM as in morning"})}}})(this)};return j.replace(/([a-zA-Z]+)/g,function(fl){if(T[fl]!=null){return T[fl]()}else{return fl}})}};var eQ;eQ=INLINE_JS.Timezone=E.Timezone={check_timezone:function(){var i;if(!cM.get_viewer().is_signed_in){return}i=eQ.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==i){return eQ.update(i)}},get_current_timezone:function(){var fl,T,i,j;T=new Date();T.setSeconds(0);T.setMilliseconds(0);j=T.toGMTString();fl=new Date(j.substring(0,j.lastIndexOf(" ")));i=(T-fl)/(1000*60*60);return i},update:function(i){cL(typeof i==="number","Timezone offset was not a number: "+i);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:i},noAutonotify:true})},update_timezones_dropdown:function(j,fl){var T,i;if(fl==null){fl=null}i=eQ.timezones_by_country[j];bF("#timezone_id").empty();return bF("#timezone_id").append((function(){var fo,fm,fn;fn=[];for(fo=0,fm=i.length;fo<fm;fo++){T=i[fo];fn.push(bF('<option value="'+T.id+'">'+T.name+"</option>").prop("selected",T.id===fl))}return fn})())},auto:function(){var i;i=$F("timezone_auto");if(i){return bF("#tz").hide()}else{if(eQ.default_country){bF("#timezone_country").val(eQ.default_country);eQ.update_timezones_dropdown(eQ.default_country)}return bF("#tz").show()}},load_data:function(j,i){eQ.timezones_by_country=j;return eQ.default_country=i}};var bi,bK;bK=E.CreateApp={init:function(fl,j){var T,fm,i;this.accepted_tos_by_uid=fl;this.form=T=bF("#create-app-form");this.email_verification=null;if(!cM.get_viewer().is_paired){i=cM.get_viewer().get_users()[0];this.select_user(i.id)}fm=(function(fn){return function(fo){var fp;fp=fo.target.name;return T.find("input[name="+fp+"]").each(function(){bF(this).parents("label").removeClass("active");return T.removeClass(bF(this).data("next"))})}})(this);T.find("input[type=radio]").change(function(fn){fm(fn);bF(fn.target).parents("label").addClass("active");return T.addClass(bF(this).data("next"))});T.find("input[type=checkbox]").change(function(fn){var fo;if(bF(this).filter("#accept-tos").length){return}bF(fn.target).parents("label").toggleClass("active");fo=T.find("input[name="+(bF(this).attr("name"))+"]:checked");T.toggleClass(bF(this).data("next"),fo.length!==0)});T.find(".role-choice input").change((function(fn){return function(fp){var fo,fq;fo=T.find(".role-choice input:checked");fq=fo.val();if(!cM.get_viewer().is_uid_signed_in(fq)){fo.prop("checked",false);fm(fp);bO.show_modal({user_id:fq,on_success:function(){return fo.prop("checked",true).trigger("change")}});return false}else{return fn.select_user(fq)}}})(this));T.find("input:checked").trigger("change");T.find("input[name=tos_accept]").change((function(fn){return function(fo){return fn.update_submit_enabled()}})(this));T.find("#send-verify-email, #resend-verify-email").click((function(fn){return function(fo){fn.email_verification.send_email(j,function(){T.addClass("verify-email-sent");fn.email_verification.flash_email_sent_notification();return fn.email_verification.ensure_polling(function(){if(!fn.email_verification.user.is_email_verified){return}T.addClass("email-verified");T.removeClass("verifiy-email-sent");T.removeClass("email-unverified");return fn.update_submit_enabled()})});return false}})(this));return T.submit(function(fn){T=bF(fn.target);bT.ajax_submit(T[0],false,(function(fo){return window.location.href=fo.responseText}));return false})},select_user:function(i){this.email_verification=d4.get_for_user(cM.get_viewer().get_user_by_id(i));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[i]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var j,i;i=this.email_verification.user;j=this.accepted_tos_by_uid[i.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!j)}};bi=INLINE_JS.Apps=E.Apps={init_apps:function(){return bF("#show-disabled-apps").click(function(){bF(this).parent().hide();bF("#disabled-apps").show();return false})},init_app_info:function(j,T,i){this.user_email=i;bF("#app-info .icon-container").each(function(fm,fn){var fl;fl=bF(fn);return fl.append(Dropbox.createChooseButton({success:function(fo){fl.find(".icon").attr("src",fo[0].thumbnailLink);return fl.find("input[type=hidden]").val(fo[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=fg.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=fg.tmpl("webhook_info_row_tmpl");bF("#domain-list").on("click",".img-container",function(fl){bi.remove_domain(fl.currentTarget.parentNode,j)});bF("#oauth-uri-list").on("click",".img-container",function(fl){bi.remove_oauth_uri(fl.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".img-container",function(fl){bi.remove_webhook(fl.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(fl){bi.update_webhook_url(fl.currentTarget,j,false)});bF("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(fl){bi.update_webhook_url(fl.currentTarget,j,true)});bF("#generate-token-button").on("click",function(fl){bi.generate_access_token(j)});bF("#delete-app-button").on("click",function(fl){bi.confirm_disable(T,j,0)});bF("#webhook_url").on("click change paste focus",function(fl){bF("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bF("#oauth2-allow-implicit-grant").on("change",function(fl){return bi.set_oauth2_allow_implicit_grant(fl.currentTarget,j)})},init_app_info_add_redirect_uri:function(){var i,j,T,fl;j=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!j){return}fl=window.decodeURIComponent(j[1]);i=bF("#oauth-add-uri-form");bF("input[name=oauth_uri]",i).val(fl);T=bF("#add-redirect-uri-modal")[0];bF("#add-redirect-uri-modal-uri").text(fl);fb.show(eA("Add OAuth redirect URI"),T,{doit:function(){var fm;if(window.history&&window.history.replaceState){fm=window.location.href;fm=fm.substring(0,fm.indexOf("#"));window.history.replaceState({},document.title,fm)}else{window.location.hash=""}fb.hide();return bi.submit_new_oauth_uri(bF("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(i){this.ds_info=i;if(cM.get_viewer().is_paired){this.role_picker=C.controller(bF("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bO.set_during_login_callback((function(j){return function(fl,T){return j.app_datastores_browse_reload_info(function(){return T()},function(){T("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(j,i){bF.ajax({url:"/developers/apps/datastores/info",success:(function(T){return function(fl){T.ds_info=fl;T.app_datastores_browse_render();return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(fl){return typeof i==="function"?i(fl):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var fl,T,j,i;T=bF("#no_apps_container").empty();if(bF("#apps_developed_container").children().length!==0||bF("#apps_used_container").children().length!==0){return}fl=bF("<div class='empty-state'></div>").appendTo(T);switch((j=this.role_picker)!=null?j.get_state():void 0){case d2.PERSONAL:case d2.WORK:i=cM.get_viewer().get_user_by_role(this.role_picker.get_state());return fl.append("You don't have any datastores in your "+cM.get_role_title(i)+" Dropbox.");default:return fl.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fq){var fl,fp,fm,fo,T,i,fn;fo=this.app_datastores_browse_get_id_info(fq);fp=bF(fq);fp.empty();fl="";for(T=0,i=fo.length;T<i;T++){fm=fo[T];if(this.app_datastores_should_render(fm.uid)){fl+=fm.html}}if(fl){fp.append(this.app_datastores_browse_get_id_header(fq));fn=bF("<div class='app-list clearfix'/>").appendTo(fp);return fn.html(fl)}},app_datastores_should_render:function(j){var i;if(this.role_picker!=null){i=cM.get_viewer().get_user_by_id(j);return this.role_picker.is_role_visible(i.role)}else{return true}},app_datastores_browse_get_id_info:function(i){switch(i){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cL(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(i){switch(i){case"#apps_developed_container":return bF("<h2>Apps you develop</h2>");case"#apps_used_container":return bF("<h2>Apps you use</h2>");default:return cL(false,"invalid ds group id")}},generate_access_token:function(j){var fl,T,i;i=this;fl=bF("#generate-token-button");T=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fl.replaceWith(T);return bF.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:j},dataType:"json",success:function(fn){var fm;if(fn.status==="ok"){fm=bF("<div>").append(bF("<input>").attr("id","generated-token").attr("type","text").attr("value",fn.token).prop("readonly",true).click(function(){return bF(this).select()}));fm.append(bF("<div>").addClass("detail-text").text(fn.warning))}else{if(fn.status==="error"){fm=bF("<div>").addClass("detail-text").addClass("error").text(fn.msg)}}return T.replaceWith(fm)},error:function(){return ah.error("Unable to complete your request.")}})},confirm_disable:function(fl,T,j){var fm,i;fm=(j?eA("Are you sure you want to disable '%(app_name)s'?"):eA("Are you sure you want to delete '%(app_name)s'?"));dv.fillVal(fm.format({app_name:fl.escapeHTML()}),"app-disable-text");fb.show((j?eA("Confirm disable"):eA("Confirm delete")),$("app-disable-modal"));i="/developers/disable_app/"+T;$("app-disable-modal").down("form").action=i;return $("disable-app-button").setValue((j?eA("Disable"):eA("Delete")))},enable_app:function(j){var i;i="/developers/enable_app/"+j;return window.location.href=i},show_uninstall:function(fn,fm,T,j,fl,i){var fo;if(fn){Event.stop(fn)}fb.vars={app_id:T,user_id:i};fo=bF("#delete-"+j+"-app-confirm");if(j==="sandbox"){if(!fl){bi.do_uninstall();return}bF(".app_folder",fo).text(fl)}bF(".app_name",fo).text(fm);fb.show(eA("Remove %(app_name)s?").format({app_name:bU.em_snippet(fm,22)}),fo[0],fb.vars);return null},do_uninstall:function(){var i;i=fb.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fb.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(j){var T;ah.success(j.responseText);T=bF(".apps-"+i);bF("#inst-app-"+fb.vars.app_id+"-row",T).hide().removeClass("active_app");if(bF(".active_app",T).length===0){T.hide()}if(bF(".active_app").length===0){bF("#empty-explanation").text(eA("You have no apps linked to your Dropbox."));return bF("#applications-explanation",T).remove()}},subject_user:i});return fb.hide()},enable_users_in_dev:function(i,j){new Ajax.DBRequest("/developers/enable_users_in_dev/"+i,{onSuccess:function(T){fb.show(eA("Limit raised to %d users").format(j),$("increased-dev-user-limit-modal"));bF("#users-in-dev-none, #users-in-dev-some").hide();return bF("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(i){fb.show(eA("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+i,{onSuccess:function(j){bF("#current-app-users-1, #current-app-users-2").text("0");return fb.hide()}})}});return false},unlink_all_teams_in_dev:function(i){fb.show(eA("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bF.ajax({url:"/developers/unlink_all_teams/"+i,type:"POST",success:function(j){bF("#current-app-teams").text("0");return fb.hide()}})}});return false},restore_sandbox:function(j,fl,i){var fn,T,fm;fn=bF("#restore-sandbox")[0];fb.show(eA("Restore app folder '%(filename)s'").format({filename:bU.em_snippet(aA.filename(fl),17)}),fn);fm=bF("#restore-sandbox-form")[0];T={ns_id:i};T[a9.UID_PARAM_NAME]=j.id;return bT.add_vars(fm,T)},submit_restore_sandbox:function(j){var i;i=$("restore-sandbox-form");bT.ajax_submit(i,false,(function(T){fb.hide();ah.success(eA("Restored app folder"));if(T.responseText.length){return ct.reload_fqpath(T.responseText)}else{return ct.reload("","",true)}}),false,j.target);return false},submit_app_info:function(i){var j;j=bF(i).find("input[name=name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App info updated.");if(j){return bF("#app-info h1").text(j)}}))},submit_folder_name:function(i){var j;j=bF(i).find("input[name=folder]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App folder name updated.");bF("#folder-name .text").text(j);return bi.hide_folder_input()}))},submit_new_webhook:function(j){var T,fu,fs,fn,fp,fo,ft,fr,fm,fq,fl,i;fu=bF(j);fp=bF("#webhook-list");fn=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fs=fu.find("input[name=webhook_url]");fl=function(fw,fv){if(fv){fv.remove()}if(fp.find(".hoverable-url").length===0){fp.addClass("hide-status")}bF("#webhook-form-error").text(fw);return bF("#webhook-form").addClass("error")};ft=fs.val();if(ft===""){fl("Empty URI");return}fr=G.parse(ft);if((fm=fr.scheme)!=="http"&&fm!=="https"){fl("URI scheme must be http or https");return}if(!fr.authority){fl("Improperly formatted URI (typo maybe?)");return}if(((fq=fr.authority)==="localhost"||fq==="127.0.0.1")||fr.authority.indexOf("[::1]")===0){fl("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fp.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){fl("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}T=bF(this._webhook_info_row_tmpl({url:ft,status:"Verifying"}).toHTML());T.find(".status").append(fn);T.find(".webhook-actions").removeClass("disabled").addClass("enabled");fp.append(T);fp.removeClass("hide-status");bF("#webhook-form").removeClass("error");fo=bT.collect_form_vars(j);fs.val("");i=new Date().getTime();return bF.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fo,success:function(fx){var fv,fw;if(fx.status==="invalid"){fl(fx.failure_text,T);return fs.val(ft)}else{fw=new Date().getTime()-i;fv=Math.max(0,1000-fw);return setTimeout((function(){if(fx.status==="ok"){return T.find(".status").text("Enabled")}else{if(fx.status==="error"){T.find("textarea").text(fx.failure_text);T.find(".status").text(fx.status_text).addClass("error");T.find(".timestamp").text("Just now");return T.find(".webhook-failure-info").css("display","")}}}),fv)}},error:function(){ah.error("Unable to complete your request.");T.remove();return fs.val(ft)}})},remove_webhook:function(T,j){var fl,i;bF("#webhook-form").removeClass("error");i=bF(T).find(".value").text();fl=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bF(T).find(".status").text("Removing").removeClass("error").append(fl);return bF.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:j,webhook_url:i},dataType:"json",success:function(fo){var fm,fn;fm=T.parentNode;fn=fm.parentNode;fn.removeChild(fm);if(fn.getElementsByClassName("hoverable-url").length===0){bF(fn).addClass("hide-status")}if(!bF("#webhook_url").val()){return bF("#webhook_url").val(i)}},error:function(){return ah.error("Unable to complete your request.")}})},update_webhook_url:function(fn,fl,T){var fo,i,fm,fp,j;j=bF(fn.parentNode.parentNode).find(".value").text();bF("#webhook-form").removeClass("error");fm=fn.parentNode.parentNode.parentNode;fo=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");i=bF(fm).find(".status").text();T=i==="Disabled";fp=T?"Enabling":"Disabling";bF(fm).find(".status").text(fp).removeClass("error").append(fo);return bF.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:fl,webhook_url:j,enable:T},dataType:"json",success:function(fr){var fq;i=bF(fm).find(".status").text();fq=i==="Disabling"?"Disabled":"Enabled";bF(fm).find(".status").text(fq).removeClass("error").removeClass("img");if(i==="Disabling"){return bF(fm).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bF(fm).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fq){return ah.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(j,i){return bF.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:i,allow:bF(j).val()},dataType:"json",success:function(T){return ah.success("OAuth 2 allow implicit grant updated.")},error:function(){return ah.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(j){var i;i=bF(j).find("input[name=oauth_uri]").val();bT.clear_errors(j);return bT.ajax_submit(j,false,(function(){ah.success("OAuth URI added.");bi.add_oauth_uri(i);return bF(j).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(j){var i;i=bF("#oauth-uri-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_oauth_uri:function(j,i){var T,fl;fl=bF(j).find(".value").text();T=function(fn){var fm;ah.success("OAuth URI removed.");fm=j.parentNode;fm.removeChild(j);if(fm.getElementsByTagName("div").length===0){return fm.hide()}};return bF.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:i,oauth_uri:fl},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},submit_new_domain:function(i){var j;j=bF(i).find("input[name=domain_name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("Domain added.");bi.add_domain(j);return bF(i).find("input[name=domain_name]").val("")}))},add_domain:function(j){var i;i=bF("#domain-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_domain:function(j,i){var T,fl;fl=bF(j).find(".value").text();T=function(fn){var fm;ah.success("Domain removed.");fm=j.parentNode;fm.removeChild(j);if(fm.getElementsByTagName("div").length===0){return fm.hide()}};return bF.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:i,domain_name:fl},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},show_need_users_modal:function(i){fb.show(eA("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(i){return fb.show(eA("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(i){fb.show(eA("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(i){fb.show(eA("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){bF("#folder-name").show();return bF("#folder-input").hide()},show_folder_input:function(){bF("#folder-name").hide();bF("#folder-input").show();return bF("#folder-input input[name=folder]").focus()}};var cG,dF;dF=INLINE_JS.twitter_auth_complete=function(i){cL(i!=null,"user_id must be provided");if(cG.onLoginSuccessCallback){cG.onLoginSuccessCallback(i)}else{window.location.reload()}return false};cG=E.Twitter={is_authed:function(i){i=parseInt(i);if(cG._authed_users==null){cG._authed_users={}}return cG._authed_users[i]},set_is_authed:function(i,j){i=parseInt(i);if(cG._authed_users==null){cG._authed_users={}}return cG._authed_users[i]=j},get_progress_container:function(){var i;cL(cG.progress_container,"Twitter is missing progress_container");i=$(cG.progress_container);cL(i,"Missing progress_container elm");return i},follow_dropbox:function(j,i){var T;cL(i!=null,"user_id must be provided");if(j.showWorking){j.showWorking()}T=function(){if(j.onFailure){return j.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(fl){if(!fl.responseText.startsWith("ok")){return T()}else{if(j.onSuccess){return j.onSuccess()}}},onFailure:function(){return T()},subject_user:i})},do_auth:function(fl,i){var T,j;cL(i!=null,"user_id must be provided");j=G({path:"/twitter/request_token"}).updateQuery(a9.UID_PARAM_NAME,i).toString();window.open(j,"twitter_auth","width=800,height=400");T=function(fm){cG.set_is_authed(fm,true);return typeof fl==="function"?fl(fm):void 0};return cG.onLoginSuccessCallback=T},show_auth:function(i){if(i){cG.onLoginSuccessCallback=i}return dv.updateFromElm(cG.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cG.should_hide_modal()){fb.hide()}return cG.get_progress_container().update(dv.fromElm("sharing-progress"))},show_complete:function(j){var i;i=cG.get_progress_container();i.update(dv.fromElm("sharing-posted"));return cG.show_complete_into(j,i)},show_complete_into:function(fo,i){var fl,fm,T,fn,j;fl="twitter";fn=eA("View tweet");j=void 0;if(fo.startsWith("ok")){j="http://www.twitter.com/"}else{j=fo}fm=i.down("#view-post");fm.href=j;fm.update(fn);T=cx.make("web",fl);return fm.__sert({top:T})},post:function(fl,fn,T,i){var fm,j;cL(i!=null,"user_id must be provided");cL(fl,"Twitter message is empty");fm={message:fl,from_referrals:cG.from_referrals,from_getspace:cG.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fm,onSuccess:function(fo){var fp,fq;if(fo.responseText==="login"){cG.onLoginSuccessCallback=function(){return cG.post(fl,null,null,i)};fp=cG.custom_show_auth||cG.show_auth;return fp()}else{if(cG.should_hide_modal()){fb.hide()}fq=cG.onPostSuccessCallback||cG.show_complete;return fq(fo.responseText)}},subject_user:i});j=cG.custom_show_posting||cG.show_posting;return j()},custom_post:function(j,T,i){cL(i!=null,"user_id must be provided");if(T){cG.onPostSuccessCallback=T}if(!j){return}cL(j,"Twitter message doesn't exist");if(!cM.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(j))}else{return cG.post(j,null,null,i)}},get_user_info:function(j,i){cL(i!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(T){return j(JSON.parse(T.responseText))},subject_user:i})},should_hide_modal:function(){if(typeof cG.hide_modal==="undefined"){return true}else{return cG.hide_modal}}};var dt,e2,dE,Y,eS,au,bH,ao,e1,bD,fc=function(fl,j){for(var i in j){if(dk.call(j,i)){fl[i]=j[i]}}function T(){this.constructor=fl}T.prototype=j.prototype;fl.prototype=new T();fl.__super__=j.prototype;return fl},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dE=E.LightboxPreviewBase=(function(){function i(j){this.link_hash=j.link_hash;this.filename=j.filename;this.fq_path=j.fq_path;this.thumbnail_url_tmpl=j.thumbnail_url_tmpl;this.dl_url=j.dl_url;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.display_time=j.display_time||null;this.more_actions_item_tmpl=fg.tmpl("lightbox_more_actions_item_tmpl")}i.prototype.shutdown=function(){};i.prototype.preload=function(){};i.prototype.render=function(){};i.prototype.image_size=function(){var j;j=document.viewport.getDimensions();return aG(j.width,j.height)};i.prototype.get_more_actions_above_divider=function(T){var fl,j;j=[];fl=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:eA("Download"),more_classes:"more-actions-item",Sprite:cx});j.push(fl);return j};i.prototype.get_more_actions_below_divider=function(j){return[]};i.prototype.is_a_timeline_preview=function(){return this instanceof eS||this instanceof dt||this instanceof au||this instanceof e2};i.prototype.is_an_album_preview=function(){return this instanceof eS||this instanceof au};i.prototype.is_a_photo_preview=function(){return this instanceof Y};i.prototype.is_a_video_preview=function(){return this instanceof bH};i.prototype.get_actions=function(fl){var fn,fp,fq,T,fm,j,fo;j=[];if(!this.is_a_timeline_preview()&&fl.enable_sublinks){if(fl.share_button_experiment_variant==="WHITE_BUTTON"){fq=bF("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fm=(function(fr){return function(fs){ba.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(G.parse(fr.shmodel_link).updateQuery("m","1"))}})(this)}else{fm=(function(fr){return function(fs){fs.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dx.shmodel(fr.fq_path,"browse_lightbox")}})(this)}}else{fq=bF("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fq.html(cx.make("web","link_white"));if(this.is_a_photo_preview()){fq.attr("title",eA("Share link to photo"))}else{if(this.is_a_video_preview()){fq.attr("title",eA("Share link to video"))}else{cL(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fq.attr("href",G.parse(this.shmodel_link).updateQuery("m","1"));fq.attr("target","_blank");fm=(function(fr){return function(fs){return ba.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fq.attr("href","#");fm=(function(fr){return function(fs){fs.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dx.shmodel(fr.fq_path,"browse_lightbox")}})(this)}}fq.on("click",fm);j.push(fq[0])}if(fl.include_delete){fo=bQ.in_single_collection_view()?eA("Remove"):eA("Delete");if(fl.share_button_experiment_variant==="WHITE_BUTTON"){fn=bF("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");fn.find(".sprite-text-inner").text(fo);fn.on("click",(function(fr){fr.preventDefault();return aM.delete_current()}))}else{fn=bF("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fo});fn.html(cx.make("web","lightbox_delete_16"));fn.on("click",(function(fr){fr.preventDefault();return aM.toggle_delete()}))}j.push(fn[0])}if(fl.share_button_experiment_variant==="WHITE_BUTTON"){T=(function(fr){return function(fs){fs.preventDefault();return aM.toggle_more_actions_menu()}})(this);fp=bF("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",T);j.push(fp[0])}else{cL(aM.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");j.push(aM.more_actions_button)}return j};i.prototype.delete_pressed=function(){var j;j=eA("Deleting...");if(this.is_a_timeline_preview()){if(bQ.in_single_collection_view()){j=eA("Removing...");bQ.get_current_collection().remove_photos([this.photo])}else{bQ._delete_photos([this.photo])}}else{document.fire(aM.PHOTO_DELETE_EVT,this)}return ah.success(j)};i.prototype.set_more_actions_event_handlers=function(j){};i.prototype.replace_dl_action_with_open_action_if_file_available=function(){var T,fm,fl,j;if(__CONDITIONAL_JS__.UnityFeatures==null){return}j=ct.active_user.id;fl=(function(fn){return function(fo,fr,fp){var fs,fq;fs=bF("#lightbox_download_link");if(!(fs.data("ns-id")===fo&&fs.data("ns-path")===fr)){return}fq=bF(fn.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fo,_ns_path:fr,sprite_name:"lightbox_open",item_text:eA("Open"),more_classes:"more-actions-item",Sprite:cx}).toHTML());fs.replaceWith(fq);return fq.on("click",function(ft){return __CONDITIONAL_JS__.UnityFeatures.open_file(fo,fr,fp,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fu){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fm=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fm.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return fl(this.ns_id,this.ns_path,j)}else{T=(function(fn){return function(fo){if(fo.is_locally_available){return fl(fn.ns_id,fn.ns_path,j)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,j,T)}};return i})();Y=INLINE_JS.PhotoPreview=E.PhotoPreview=(function(j){fc(i,j);function i(T){i.__super__.constructor.call(this,T);this.original_url=String(G.parse(T.original_url).updateQuery(a9.UID_PARAM_NAME,ct.active_user));this.shmodel_link=T.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=T.enable_download}i.prototype.show_fail=function(fl){var T;return T=bF(fl).find(".lightbox_fail_text").text(eA("Unable to preview this item."))};i.prototype.fallback=function(fl){var T,fm;T=$(fl.target);T.writeAttribute({src:this.fail_image_src,width:128,height:128});fm=T.up("div.content-item");if(fm){return this.show_fail(fm)}};i.prototype.is_gif=function(){return"gif"===aA.file_extension(this.filename).toLowerCase()};i.prototype.preload=function(fm){var fl,fn,T;T=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){T=this.thumbnail_url_tmpl}fn=(function(fo){return function(){if(typeof fm==="function"){fm()}return fo.loaded=true}})(this);d6.preload_image(T,this.fallback.bind(this),fn);fl=$(d6.preloaded_images[T]);fl.writeAttribute("data-original-href",this.original_url);fl.setAttribute("enable-download",this.enable_download);fl.writeAttribute("class","thumbnail");return fl};i.prototype.render=function(fp,fm){var fn,fl,fo,T,fq;if(this.loaded){fm()}fl=this.preload(fm);fq=bF("<div />",{"class":"content-item"}).append(fl);fn=bF("<div />",{"class":"lightbox_fail_text"});fq.append(fn);fo=fl.getAttribute("src").length;T=fl.getAttribute("src").substring(fo-this.fail_image_src.length,fo);if(T===this.fail_image_src){this.show_fail(fq)}fp.appendChild(fq[0]);return fq[0]};i.prototype.advance_on_click=true;i.prototype.get_more_actions_above_divider=function(fm){var fl,T;T=i.__super__.get_more_actions_above_divider.call(this,fm);fl=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:eA("View original"),more_classes:"more-actions-item",Sprite:cx});T.push(fl);return T};return i})(dE);bH=E.VideoPreview=(function(i){fc(j,i);function j(T){this._player_error=b3(this._player_error,this);this._player_ready=b3(this._player_ready,this);j.__super__.constructor.call(this,T);this.preview_url=T.preview_url;this.shmodel_link=T.shmodel_link;this.thumbnail_div=null;this.metadata_link=T.metadata_link!=null?T.metadata_link:void 0;this.metadata=null;this.player=null}j.prototype.render_error=function(fn){var fp,fl,T,fm,fo;fl=bF("<div/>");T=bF("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fm=bF("<div/>",{"class":"video-preview-fail"});if(fn==="needflash"){fm.html(eA('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fm.text(eA("Unable to preview this item.",fo="web",fp="preview means showing the item in the same browser window without downloading a copy."))}fl.append(T,fm);return fl[0]};j.prototype._player_ready=function(){var T;T=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return T.defer()};j.prototype._onPlay=function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()};j.prototype._onEnded=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()};j.prototype._player_error=function(T){this.shutdown();this.div=this.render_error(T);return bF("#file-preview-modal .content-item").html(this.div)};j.prototype.preload=function(){};j.prototype.render=function(fl,T){this.div=this.render_video(fl);return this.div};j.prototype.render_video=function(fq){var T,fo,fm,fl,fp,fn;fn=new Element("div",{"class":"video-player content-item"});fp=this.image_size().split("x")[0]*0.8;fl=parseInt(fp*0.55,10);fo=false;fm=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();T=(function(fr){return function(fs){return fr.metadata=fs}})(this);this.player=bt.embed(fn,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fp,height:fl,controls:true,preload:"auto",poster:fm,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:T});fq.appendChild(fn);bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return fn};j.prototype.shutdown=function(){var fl,fm,T;bF(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((T=this.player.tech.sourceBuffer)!=null){T.abort()}}this.player.dispose()}catch(fm){fl=fm}return this.player=null}};return j})(dE);ao=function(T){var i,j;i=(function(fm){fc(fl,fm);function fl(fn){fn.ns_id=fn.photo.ns_id;fn.ns_path=fn.photo.ns_path;fl.__super__.constructor.call(this,fn);this.photo=fn.photo;bo.set_vertical_space(3);if(bQ.in_single_collection_view()){bF("#lightbox-delete-photo").val(eA("Remove"))}else{bF("#lightbox-delete-photo").val(eA("Delete"))}}fl.prototype.get_more_actions_above_divider=function(fp){var fo,fn;fn=fl.__super__.get_more_actions_above_divider.call(this,fp);fo=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:eA("Add to album"),more_classes:"more-actions-item",Sprite:cx});fn.push(fo);return fn};fl.prototype.toggle_select_button_off=function(fn){if(this.is_a_photo_preview()){fn.attr("title",eA("Select photo"))}else{if(this.is_a_video_preview()){fn.attr("title",eA("Select video"))}}fn.html(cx.make("web","lightbox_unselected"));fn.removeClass("selected");fn.addClass("elbboggiw");return setTimeout((function(){return fn.removeClass("elbboggiw")}),540)};fl.prototype.toggle_select_button_on=function(fn){if(this.is_a_photo_preview()){fn.attr("title",eA("Un-select photo"))}else{if(this.is_a_video_preview()){fn.attr("title",eA("Un-select video"))}}fn.html(cx.make("web","lightbox_selected"));fn.addClass("selected");fn.addClass("wiggobble");return setTimeout((function(){return fn.removeClass("wiggobble")}),540)};fl.prototype.toggle_select=function(fo){var fn;fo.preventDefault();fn=bF("#lightbox-select-button");bo.hide_all();if(eU.contains(this.photo)){eU._remove(this.photo);return this.toggle_select_button_off(fn)}else{eU._add(this.photo);return this.toggle_select_button_on(fn)}};fl.prototype.get_actions=function(fp){var fo,fn,fq;fo=[];fq=bF("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aM.update_share_button_text(null,bF(fq));fq.on("click",((function(fr){return function(ft){var fs;ft.preventDefault();fs=eU.get();if(fs.length===0){return ez.show([fr.photo],false)}else{return ez.show(eU.get(),false)}}})(this)));fn=bF("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:eA("Select this photo")});if(eU.contains(this.photo)){fn.html(cx.make("web","lightbox_selected"))}else{fn.html(cx.make("web","lightbox_unselected"))}fn.on("click",this.toggle_select.bind(this));fo.push(fq[0]);fo.push(fn[0]);return fo.concat(fl.__super__.get_actions.call(this,fp))};fl.prototype.set_more_actions_event_handlers=function(fn){$("lightbox_add_to_album").observe("click",((function(fo){return function(fp){fp.preventDefault();return cJ.show_add_to_album_modal(fp,[fo.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fo){return function(fp){fp.preventDefault();return bQ.show_in_folder(fo.photo)}})(this)));return fl.__super__.set_more_actions_event_handlers.call(this,fn)};fl.prototype.get_more_actions_below_divider=function(fp){var fo,fn;fo=[];fn=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:eA("Show in folder"),more_classes:"more-actions-item",Sprite:cx});fo.push(fn);fo=fo.concat(fl.__super__.get_more_actions_below_divider.call(this,fp));return fo};return fl})(T);j=(function(fm){fc(fl,fm);function fl(){return fl.__super__.constructor.apply(this,arguments)}fl.prototype.get_more_actions_below_divider=function(fp){var fn,fo;fo=[];fn=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:eA("Remove from album"),more_classes:"more-actions-item",Sprite:cx});fo.push(fn);fo=fo.concat(fl.__super__.get_more_actions_below_divider.call(this,fp));return fo};fl.prototype.set_more_actions_event_handlers=function(fn){$("lightbox_remove_from_album").observe("click",((function(fo){return function(fp){fp.preventDefault();return cJ.show_remove_photos_modal(bQ.get_current_collection(),[fo.photo])}})(this)));return fl.__super__.set_more_actions_event_handlers.call(this,fn)};return fl})(i);return[i,j]};e1=ao(Y),dt=e1[0],eS=e1[1];bD=ao(bH),e2=bD[0],au=bD[1];var aM;aM=INLINE_JS.Lightbox=E.Lightbox=(function(){var i,fI,fR,gd,fl,f7,fq,fQ,f2,fy,f1,fN,fW,gc,fx,fO,fv,f0,f4,fp,f3,fo,fG,f6,fA,fP,fs,fJ,fX,fK,fT,fm,fC,j,fS,f5,gb,fZ,fz,fF,fn,fE,fV,T,ft,fY,fL,fM,fw,fH,fu,ga,fD,fB,f9,f8,fU,fr;f8=[];fD=0;fU=false;f9=true;fL=void 0;i=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;fr=false;f6=void 0;f2=void 0;fV=-1;T=null;fW=null;fO=false;j=false;fp=false;fv=null;fx=function(ge){return ge.complete!==false};fn=function(){var ge;if($$("#file-preview-modal .loading-image").length){return}ge=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(ge)};fN=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fK=function(){var gk,gj,gg,ge,gi,gh,gf;gj=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!gj||!fx(gj)){return}ge=$$("#file-preview-modal .preview").first().getDimensions();gk=void 0;if(!gj.naturalHeight){gk=gj.getDimensions();gj.naturalHeight=gk.height;gj.naturalWidth=gk.width}else{gk={width:gj.naturalWidth,height:gj.naturalHeight}}gg=gk.width/ge.width;gf=gk.height/ge.height;gh=Math.max(gg,gf);gj.style.visibility="";if(gh<1){gj.style.width="";gj.style.height=""}else{gj.style.width=Math.floor(gk.width/gh)+"px";gj.style.height=Math.floor(gk.height/gh)+"px"}gi=bF("#file-preview-modal .paging-block").position().left-16;return bF("#file-preview-modal .filename").css("max-width",gi)};fQ=void 0;f3=function(){var gl,gg,gk,gf,ge,gj,gi,gh;gg=$("file-preview-modal");gj=gg.down(".menu");gk=gg.down(".header");gi=$$(".lightbox-not-important");gh=[];for(gf=0,ge=gi.length;gf<ge;gf++){gl=gi[gf];gh.push(gl.addClassName("opacity-zero"))}return gh};fE=function(){var gi,gf,ge,gh,gg;if(fQ){clearTimeout(fQ)}gh=$$(".lightbox-not-important");gg=[];for(gf=0,ge=gh.length;gf<ge;gf++){gi=gh[gf];gg.push(gi.removeClassName("opacity-zero"))}return gg};fT=function(gf){var ge;fE();ge=gf&&$(gf.target).descendantOf("file-preview-menu");if(fQ!=null){clearTimeout(fQ)}if(f9){if(!fr&&!ge){return fQ=setTimeout(f3,3112)}}};fY=function(){if(fQ!=null){clearTimeout(fQ)}return f9=false};ft=function(){f9=true;return fT()};gc=function(gf){var ge;ge=f8.length;return(ge+(fD+gf)%ge)%ge};fP=function(gf){var gg,ge;if(f6.no_preload){return}ge=fz.bind(null,gf);return typeof(gg=f8[gf]).preload==="function"?gg.preload(ge):void 0};fs=function(){var gg,gf,ge,gi,gh;gi=[1,2,3,4,5,6,-1,-2];gh=[];for(gg=0,gf=gi.length;gg<gf;gg++){ge=gi[gg];if(Math.abs(ge)<f8.length){gh.push(fP(gc(ge)))}else{gh.push(void 0)}}return gh};fC=function(ge){if(!f6.filename_in_url){return}if(ge!=null){a3.replace_hash("lh",ge)}else{a3.replace_hash("")}return fv=ge};fX=function(){var ge,gf;ge=bF("#file-preview-modal");gf=(f6!=null?f6.num_previews:void 0)||f8.length;if(fO&&j&&fp){ge.find(".lightbox-index-text-container").text(eA("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fO){if(j){ge.find(".lightbox-index-text-container").text(eA("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{ge.find(".lightbox-index-text-container").text("")}}else{ge.find(".lightbox-index-text-container").text(eA("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fD+1,num_total_files:gf}))}}if(f8.length===1){ge.find(".prev").addClass("opacity-zero");return ge.find(".next").addClass("opacity-zero")}else{if(fD===0&&f6.no_wrap){ge.find(".prev").addClass("opacity-zero");return ge.find(".next").removeClass("opacity-zero")}else{if(fD===f8.length-1&&f6.no_wrap){ge.find(".prev").removeClass("opacity-zero");return ge.find(".next").addClass("opacity-zero")}else{ge.find(".prev").removeClass("opacity-zero");return ge.find(".next").removeClass("opacity-zero")}}}};fl=function(gi,gf,gh,ge,gg){var gj;gj={user_id:null,context:gf,platform:aX.FileViewPlatformType.WEB,ns_id:gi.ns_id,sjid:null,ns_path:gi.ns_path,shared_link_url:gh,extra:{mode:ge,file_ext:gg}};return gj};fS=function(gf,gD){var gq,gr,gt,gy,gm,gg,go,gh,gi,gu,ge,gz,gp,gj,gC,gB,gx,gn,gw,gl,gv,gA,gk,gs;fV=b6.time();cL(fD<f8.length,"Invalid index "+fD);gv=f8[fD];if(typeof gv!=="object"){if(T){clearTimeout(T)}T=setTimeout((function(){if((aM.shown!=null)&&aM.shown){return fS(gf,gD)}}),100);return}bF("#file-preview-modal").trigger(aM.LIGHTBOX_SHOW_EVT,{preview:gv});gg=aA.file_extension_for_logging(gv.filename);gh=aX.FileViewModeType.PHOTOS_LIGHTBOX;go=aX.FileViewContextType.PRIVATE;gi=null;gj="lightbox";if(gv.fq_path!=null){gh=aX.FileViewModeType.BROWSE_LIGHTBOX;go=aX.FileViewContextType.PRIVATE;gj="browse_lightbox"}else{if(gv.shmodel_link!=null){gh=aX.FileViewModeType.SHARED_LINK_LIGHTBOX;go=aX.FileViewContextType.SHARED_LINK;gi=gv.shmodel_link;gj="shmodel_lightbox"}}gu=fl(gv,go,gi,gh,gg);ba.FileViewLogger.log(gu);ba.WebLightboxLogger.log(ba.WebLightboxLogger.VIEW,{context:gj,file_ext:gg});gB=bF("#file-preview-modal");gA=gB.find(".preview-content");gl=gf?fZ:fz;gA.empty();gm=gv.render(gA[0],gl);gB=gB[0];if(!fW){fW=gB.on("contextmenu","img.thumbnail",bn.show_for_lightbox.bind(bn))}fC(gv.link_hash);fX();if(gv.display_time){if(gv.filename.match(i)){gB.down(".filename").__date(gv.display_time)}else{gB.down(".filename").__date(gv.display_time+" - "+gv.filename)}}else{gB.down(".filename").__date(gv.filename)}gB.down(".filename").writeAttribute("title",gv.filename);if(bQ.in_single_collection_view()&&((gk=bQ.get_current_collection().member_fnames)!=null?gk.length:void 0)>1&&(((gs=gv.photo)!=null?gs.item_owner_fname:void 0)!=null)){gy="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gy+=eA("Added by %(fname)s").format({fname:bU.em_snippet(gv.photo.item_owner_fname,7)});gB.down(".added-by").__date(new fg(gy));gB.down(".added-by").show()}else{gB.down(".added-by").hide()}gn=fg.tmpl("lightbox_more_actions_item_tmpl");gx=gv.get_more_actions_above_divider(f6);gt=gv.get_more_actions_below_divider(f6);if(gt.length){gx.push(gn({divider:true,Sprite:cx}));gx=gx.concat(gt)}$("lightbox-more-actions-list").__date(gx);gv.set_more_actions_event_handlers(f6);if(bF(gB).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gv.replace_dl_action_with_open_action_if_file_available()}gr=gv.get_actions(f6);ge=document.createDocumentFragment();for(gz=0,gp=gr.length;gz<gp;gz++){gq=gr[gz];ge.appendChild(gq)}gB.down(".actions").__date();gB.down(".actions").appendChild(ge);if(f6.share_button_experiment_variant==="WHITE_BUTTON"){gw=bF("#lightbox-more-actions-button .sprite-div").width();bF("#lightbox-more-actions-menu").css("right",gw/2)}document.fire(aM.ACTIONS_ADDED);if(bQ.in_single_collection_view()){gB.down(".album-name").show().__date(bU.em_snippet(bQ.get_current_collection().name,15,1));gB.down(".filename").addClassName("faded")}else{gB.down(".album-name").hide();gB.down(".filename").removeClassName("faded")}gm=gm.down("img.thumbnail");if(gm){if(!fx(gm)){gm.hide();fn();gm.observe("load",function(){fN();gm.style.visibility="hidden";gm.show();return fK()})}else{gm.show();fK()}}gC={preview_obj:gv,index:fD,direction:gD};return document.fire(aM.PHOTO_CHANGE_EVT,gC)};gb=function(gj){var gf,gg,ge,gh,gi;if(fV===-1){return}gi=b6.time()-fV;if(typeof g!=="undefined"&&g!==null){gf=g.get_current_view()}else{if(typeof am!=="undefined"&&am!==null?am.is_album:void 0){gf="album_shmodel"}else{gf="not_photos"}}gg={current_view:gf};ge=bF("#file-preview-modal .content-item img.thumbnail")[0];if((ge!=null)&&(ge.src!=null)){gh=G.parse(ge.src).getQuery();if("size" in gh){gg.size=gh.size}}eg.log_ajax_transition(gi,gj,gg);fV=-1;return fs()};fZ=function(){return gb("file-preview-lightbox-load-initial")};fz=function(ge){var gf;if(typeof ge==="number"){if((gf=f8[ge])!=null){gf.loaded=true}if(ge===fD){return gb("file-preview-lightbox-load")}}else{return gb("file-preview-lightbox-load")}};f5=function(ge){var gf;gf=bF("#lightbox-click-catcher");if(!gf.length){gf=bF("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});gf.appendTo("#file-preview-modal .modal-preview-content");if(b1.msie_version_at_most(10)){gf.css("background","black");gf.fadeTo(0,0)}}gf.off("click");gf.on("click",(function(gg){gg.preventDefault();return ge()}));return gf.show()};fy=function(){return bF("#lightbox-click-catcher").hide()};gd=function(){var ge;ge=bF("#lightbox-more-actions-button");if(ge.hasClass("toggled")){fy();ge.removeClass("toggled");$("lightbox-more-actions-menu").hide();bF(document).trigger("dropdownClosed",[1]);ft();return true}return false};fG=function(){var ge;ge=bF("#lightbox-more-actions-button");if(!ge.hasClass("toggled")){f1();ge.addClass("toggled");bo.hide_all();bF("#lightbox-more-actions-menu").show();bF(document).trigger("dropdownOpened",[1]);fY();return f5(aM.close_more_actions_menu)}};fw=function(){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gd()}else{return fG()}};fo=function(gf){var ge;if(fO){j=true;fX()}gd();if(gf){gf.preventDefault()}if(fD===f8.length-1&&f6.no_wrap){return}if((ge=f8[fD])!=null){ge.shutdown()}fD=gc(1);if(fD===0){fT()}return fS(null,aM.NEXT)};fJ=function(gf){var ge;if(fO){j=true;fX()}gd();if(gf){gf.preventDefault()}if(fD===0&&f6.no_wrap){return}if((ge=f8[fD])!=null){ge.shutdown()}fD=gc(-1);return fS(null,aM.PREV)};fR=function(ge){if(ge){ge.preventDefault()}if(f8[fD].advance_on_click){if(ge.clientX<bF(window).width()/10){return fJ()}else{return fo()}}};f7=function(gk){var gh,ge,gj,gl,gg,gf,gi;gh=f8.dict_by("fq_path");gl=void 0;if(gk.memo.files){gl=gk.memo.files.collect(function(gm){return gm.fq_path})}else{gl=gk.memo.fq_paths}gi=[];for(gg=0,gf=gl.length;gg<gf;gg++){gj=gl[gg];if(gh[gj]){ge=f8.indexOf(gh[gj]);f8.splice(ge,1);if(f6.num_previews){f6.num_previews--}if(!f6.num_previews&&!f8.length){gi.push(f2())}else{if(ge===f8.length){gi.push(fJ())}else{gi.push(fS())}}}else{gi.push(void 0)}}return gi};fm=function(ge){if(f8[fD].is_a_timeline_preview()){return f8[fD].toggle_select(ge)}};fH=function(){Event.stopObserving(document,"mousemove",fT);Event.stopObserving(document,"click",fT);document.stopObserving(aM.PHOTO_DELETE_EVT,fA);document.stopObserving(aH.DELETE,f7);document.stopObserving(eU.CHANGE_EVT,fu);return clearInterval(fL)};f2=function(gi){var gh,gg,gf,ge;if(gi){gi.preventDefault()}if(!aM.shown){return}if((gg=f8[fD])!=null){gg.shutdown()}gh=$("file-preview-modal");gh.hide();gh.down(".preview-content").__date();C.scroll_unlock_document();fH();fC();aM.shown=0;gh.stopObserving("click",aM.back);if((gf=$$(".preview-content"))!=null){if((ge=gf.first())!=null){ge.stopObserving("click")}}return bF("#file-preview-modal").trigger(aM.LIGHTBOX_HIDE_EVT)};fB="db:filepreview:exitselect";fI=function(gf){var ge;if(f6.keep_url){f2()}else{if((ge=f8[fD])!=null){ge.shutdown()}window.history.go(-1)}if(gf!=null){if(gf.originalEvent){gf=gf.originalEvent}Event.extend(gf).stop()}return document.fire(fB,f8[fD])};fA=function(ge){return dD.do_delete(ct.active_user,ge.memo.fq_path)};f4=function(){var ge;if(!fU){ge=bF("#file-preview-modal");ge.on("click",".close",fI);key("esc",aM.KEY_SCOPE,(function(gf){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gd()}else{if(fr){return f1()}else{return fI(gf)}}}));ge.on("click",".next",fo);ge.on("click",".prev",fJ);ge.on("click",".preview-container",fR);key("left, k",aM.KEY_SCOPE,function(gf){return fJ()});key("right, j",aM.KEY_SCOPE,function(gf){fo();return false});key("up, down",aM.KEY_SCOPE,function(gf){return false});key("x, s, space",aM.KEY_SCOPE,function(gf){fm(gf);return false});if(f6.include_delete&&f6.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aM.KEY_SCOPE,function(gf){Event.extend(gf).preventDefault();return aM.toggle_delete()});bF("#lightbox-delete-photo").on("click",(function(gf){fM();return f8[fD].delete_pressed()}));bF("#lightbox-delete-cancel").on("click",f1)}eD.add_exit_callback("/lightbox",function(){return f2()});d6.disableSelection(ge.find(".preview-container")[0]);d6.disableSelection(ge.find(".header")[0]);fU=true}Event.observe(document,"mousemove",fT);Event.observe(document,"click",fT);document.observe(aH.DELETE,f7);document.observe(aM.PHOTO_DELETE_EVT,fA);document.observe(eU.CHANGE_EVT,fu);key.setScope(aM.KEY_SCOPE);return fL=setInterval(fK,500)};f0=function(){var gh,gf,ge,gi,gg;if(!fv){return}gg=[];for(gh=gf=0,ge=f8.length;gf<ge;gh=++gf){gi=f8[gh];if(gi.link_hash&&gi.link_hash.toLowerCase()===fv.toLowerCase()){fD=gh;if(!aM.shown){gg.push(aM.show())}else{gg.push(fS())}}else{gg.push(void 0)}}return gg};ga=function(){return on_script_loaded(function(){a3.watch("lh",function(ge){fv=ge;return f0()});return a3.watch("f",function(ge){var gi,gg,gf,gj,gh;gh=[];for(gi=gg=0,gf=f8.length;gg<gf;gi=++gg){gj=f8[gi];if(gj.filename.toLowerCase()===ge.toLowerCase()){fD=gi;if(!aM.shown){gh.push(aM.show())}else{gh.push(fS())}}else{gh.push(void 0)}}return gh})})};fu=function(gi,gk){var gg,gj,gh,ge,gf;if(gk==null){gk=bF("#lightbox_share")}gf=eU.get();gh=c9.categorize_files(gf),gg=gh[0],gj=gh[1];if(gf.length===0){gk.text(eA("Share"));return(ge=f8[fD])!=null?ge.toggle_select_button_off(bF("#lightbox-select-button")):void 0}else{if(gf.length===1){if(gg){return gk.text(eA("Share 1 photo"))}else{return gk.text(eA("Share 1 video"))}}else{if(gg&&gj){return gk.text(eA("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:gf.length}))}else{if(gg){return gk.text(eA("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:gf.length}))}else{return gk.text(eA("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:gf.length}))}}}}};fF=function(){bo.hide_all();bF("#file-preview-modal .delete-file-prompt").show();bF(document).trigger("dropdownOpened",[1]);fE();fr=true;f5(aM.toggle_delete);return bF("#lightbox-delete-photo").focus()};f1=function(){var gf,ge;if(fr){gf=bF("#file-preview-modal .delete-file-prompt");gf.hide();bF(document).trigger("dropdownClosed",[1]);if((ge=gf.find(":focus")[0])!=null){ge.blur()}fT();fr=false;return fy()}};fM=function(){gd();if(fr){return f1()}else{return fF()}};fq=function(){return f8[fD].delete_pressed()};return{init_from_preview_objs:function(gi,gl,gf){var gk,gh,gg,gj,ge;if(gf==null){gf=true}ge=[];for(gh=0,gg=gi.length;gh<gg;gh++){gk=gi[gh];if(gk.is_video){gj=new bH({filename:gk.filename,fq_path:gk.path,thumbnail_url_tmpl:gk.thumbnail_url,preview_url:gk.preview_url,dl_url:gk.dl_url,shmodel_link:gk.shmodel_link,ns_id:gk.ns_id,ns_path:gk.path,link_hash:gk.item_id+"-"+gk.filename,metadata_link:gk.metadata_link})}else{gj=new Y({filename:gk.filename,fq_path:gk.path,thumbnail_url_tmpl:gk.thumbnail_url,dl_url:gk.dl_url,original_url:gk.orig_url,shmodel_link:gk.shmodel_link,ns_id:gk.ns_id,ns_path:gk.ns_path,link_hash:gk.item_id+"-"+gk.filename,enable_download:gk.enable_download})}ge.push(gj)}aM.init(ge,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:gf});return document.on(aM.EXIT_SELECT_EVT,function(gn){var gm;key.setScope("all");gm=bF(gl)[ge.indexOf(gn.memo)];d6.scroll_to_thumb(gm);bF(gm).addClass("wiggobble");return setTimeout((function(){return bF(gm).removeClass("wiggobble")}),1000)})},init:function(ge,gf){if(aM.shown){return}aM.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:eA("More actions")});aM.more_actions_button.observe("click",(function(gg){gg.preventDefault();return aM.toggle_more_actions_menu()}));aM.more_actions_button.__date(cx.make("web","lightbox_more"));gf=gf||{};f6={include_delete:gf.include_delete||false,keep_url:gf.keep_url||false,num_previews:gf.num_previews||null,filename_in_url:gf.filename_in_url||false,no_wrap:(gf.no_wrap||false)||true,no_preload:gf.no_preload||false,enable_sublinks:gf.enable_sublinks!=null?gf.enable_sublinks:true,share_button_experiment_variant:gf.share_button_experiment_variant||false};fO=gf.is_loading||false;cL(!f6.filename_in_url||f6.keep_url,"filename_in_url cannot be used with keep_url off");f8=ge;if(gf.start_index!=null){aM.show(gf.start_index)}if(f6.filename_in_url){ga()}return $(document.body).on("click",".more-actions-item",function(gg,gh){if(gh.down("a").getAttribute("href").length<2){gg.preventDefault()}return aM.close_more_actions_menu()})},update_previews:function(ge){return f8=ge},show:function(ge){var gf,gg;if(aM.shown){return}cL(f8&&f8.length,"Lightbox.show() requires file preview objects to show");f4();if(ge!=null){fD=ge}bF("#file-preview-modal").trigger("lightbox-init-show",{preview:f8[fD]});if((gg=f8[fD])!=null?gg.enable_download:void 0){aM.more_actions_button.show()}else{aM.more_actions_button.hide()}cL(!aM.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();C.scroll_lock_document();fS(true);aM.shown=1;if(!f6.keep_url){gf=eD.deconstruct_url(eD.get_url());if(gf.path.indexOf("/lightbox/")!==0){eD.push_state("/lightbox"+gf.path,gf.qargs)}}return fT()},jump_to:function(ge){cL(aM.shown,"Lightbox should be showing");fD=ge;fS();return fT()},set_no_wrap:function(ge){return f6.no_wrap=ge},update_with_error:function(){fp=true;return fX()},num_previews:function(){return f6.num_previews||f8.length},get_previews:function(){return f8},current_index:function(){return fD},close_more_actions_menu:gd,toggle_more_actions_menu:fw,update_share_button_text:fu,toggle_delete:fM,delete_current:fq,back:fI,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fB,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bG;bG=E.Tour=(function(){var fl,T,fn,fo,fs,fq,fr,fp,fm,ft,j,i;T=6;fl=0;j=function(fu){var fF,fD,fC,fB,fz,fw,fv,fx,fE,fy,fA;$$(".page-end").each(Element.remove);fv=fu;fA=T-fu-1;fF=document.createDocumentFragment();for(fD=fB=0,fx=fv;0<=fx?fB<fx:fB>fx;fD=0<=fx?++fB:--fB){fw=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fw.style.left=(28-fD*5)+"px";fw.style.zIndex=T-fD;fF.appendChild(fw)}for(fC=fz=0,fE=fA;0<=fE?fz<fE:fz>fE;fC=0<=fE?++fz:--fz){fy=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fy.style.right=(31-fC*5)+"px";fy.style.zIndex=T-fC;fF.appendChild(fy)}return $("book").appendChild(fF)};i=function(fu){(fu>0?Element.show:Element.hide)("tour-page-back");return(fu+1<T?Element.show:Element.hide)("tour-page-forward")};fm=function(fu){$$(".pages").invoke("hide");return $("page-"+fu).show()};fn=function(fu){i(fu);j(fu);fm(fu);return fl=fu};fp=function(fv){var fu;Event.extend(fv).preventDefault();fu=fl-1;if(fu<0){return}fn(fu);return eD.push_state("/tour/"+fu)};fq=function(fv){var fu;Event.extend(fv).preventDefault();fu=fl+1;if(fu>=T){return}fn(fu);return eD.push_state("/tour/"+fu)};ft=function(fv,fw){var fu;fv.preventDefault();fu=parseInt(fw.href.split("/").last(),10);fn(fu);return eD.push_state("/tour/"+fu)};fs=function(){$("tour-page-back").observe("click",fp);$("tour-page-forward").observe("click",fq);key("right",fq);key("left",fp);return $("toc").on("click","a",ft)};fo=function(fv,fw){var fu;fu=parseInt(fv,10)||0;if(fu<0||fu>=T){fu=0}return fn(fu)};fr=function(){var fy,fv,fu,fx,fw;fx=$$(".page-right img");fw=[];for(fv=0,fu=fx.length;fv<fu;fv++){fy=fx[fv];fw.push(d6.preload_image(fy.src))}return fw};return{setup:function(){return bF(function(){eD.add_callback("/tour",fo);fs();return fr()})}}})();var bQ,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};bQ=INLINE_JS.Photos=E.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fp,T,fm,ft,fq,fl,j,fr,fv,i){var fo,fs,fu,fn;this.event_metadata_cache=j;this._root_collection_gid=i;this.initialized=true;this.disable_selection();d6.disable_ie_image_dragging();this._tmpl=fg.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=fg.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fq!=null?fq.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=fr.include_shared_folders;this.show_hidden=fr.show_hidden;this.timestamp_edit_enabled=fv.timestamp_edit_enabled;this.undo_enabled=fv.undo_enabled;this.local_storage_enabled=fv.local_storage_enabled;fs=eD.deconstruct_url();fn="share" in fs.qargs;for(fu in ft){if(ft.hasOwnProperty(fu)){eU.inc_num_loading_events_before_select(fn)}}this._init_timeline(fp,T,fm,ft);this._init_lightbox();fo=[];if(fq!=null){fo.push(new ad(fq,false))}cJ.init(fo,fl);eU.drag_select_enabled=fv.drag_select_enabled;if(fr.show_photos_tour){aO.next()}delete fs.qargs.selr;delete fs.qargs.user_email;delete fs.qargs.uid;delete fs.qargs.share;delete fs.qargs.m;if("uuid" in fs.qargs){delete fs.qargs.uuid;delete fs.qargs.id}if(dL){eD.replace_state(fs.path,fs.qargs)}else{if(!G.parse(window.location.href).fragment){eD.push_state("/photos",fs.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aM.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aM.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aM.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aM.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bn.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eD.add_callback("/photos",this._history_change_handler.bind(this));document.observe(dd.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(dd.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(ck.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(ck.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bF("#photos-nav-item").on("click",this.show_all_photos.bind(this));bF("#back-to-photos").on("click",this._back_to_photos.bind(this));bF("#back-to-albums").on("click",this._back_to_albums.bind(this));bF("#share-selected").on("click",this._share_selected.bind(this));bF("#clear-selected").on("click",this._clear_selected.bind(this));bF("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bF("#do-include-shared-folders").prop("checked",true)}else{bF("#dont-include-shared-folders").prop("checked",true)}cJ.listen();eU.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bF(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fq){var fo,fp,fl,i,T,fn,fm;fp=$(fq.target).up(".cu-month-header").identify().slice(2);fo=this.get_timeline().events.valueFromKey(fp);fn=fo.photos;fm=[];for(fl=0,i=fn.length;fl<i;fl++){T=fn[fl];fm.push(eU._add(T))}return fm},_share_event:function(fp){var fn,fo,fl,i,T,fm;fo=$(fp.target).up(".cu-month-header").identify().slice(2);fn=this.get_timeline().events.valueFromKey(fo);fm=fn.photos;for(fl=0,i=fm.length;fl<i;fl++){T=fm[fl];eU._add(T)}return this._share_selected()},_add_event_to_album:function(fp){var fn,fo,fl,i,T,fm;fo=$(fp.target).up(".cu-month-header").identify().slice(2);fn=this.get_timeline().events.valueFromKey(fo);fm=fn.photos;for(fl=0,i=fm.length;fl<i;fl++){T=fm[fl];eU._add(T)}return cJ.show_add_to_album_modal(fp,eU.get())},_init_timeline:function(fo,T,fm,fr){var j,fs,fp,i,fl,fq,ft,fn;if(!fo.length){this.show_empty_state();return}j=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");fn=$("cu-view").cumulativeOffset().top+j.getLayout().get("margin-top")+j.getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){fn+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fp=$("cu-view").cumulativeOffset().left+j.getLayout().get("margin-left")+j.getLayout().get("padding-left");fs={top_offset:fn,left_offset:fp,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};i={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};ft=new ck(j,null,fo,T,fm,fr,this._tmpl,fs,i);if(this.in_single_collection_view()){if((fl=this._single_collection_timeline)!=null){fl.unlisten()}this._single_collection_timeline=ft}else{if((fq=this._all_photos_timeline)!=null){fq.unlisten()}this._all_photos_timeline=ft}return this.get_timeline().render()},_init_lightbox:function(){var j,i;if(this.get_timeline()==null){return}if(aM.shown){i=this.get_timeline().get_preview_objs();if(i.length){aM.update_previews(i);j=Math.min(aM.current_index(),i.length-1);return aM.jump_to(j)}else{return aM.back()}}else{return aM.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(j){var i;if((i=this.get_timeline())!=null){i.unlisten()}eU.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(j);return window.scrollTo(0,0)},_refresh_photo_events:function(i){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(j){return function(T){var fl;fl=JSON.parse(T.responseText);if(fl==="deleted_collection"){j._current_collection_gid=null;cJ.reload();j.show_all_collections();ah.error(eA("This album has been deleted!"));return}j._init_timeline(fl.header_ids,fl.header_id_to_name,fl.header_id_to_num_photos,{});j._init_lightbox();return typeof i==="function"?i():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(i){if(i.duplicates_info!=null){return this._show_duplicates_modal(i,false)}else{return window.open(this._get_browse_link(i),"_blank")}},_get_browse_link:function(j){var i;i=fi.get_browse_root(cM.get_viewer().photos_user);return String(G({path:""+i+(aA.normalize(aA.parent_dir(j.fq_path))),query:{select:j.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cJ.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return d6.enableSelection($(document.body))},disable_selection:function(){return d6.disableSelection($(document.body))},show_collection:function(T){var j,i;g.log_transition_to(cn.SINGLE_COLLECTION_VIEW);i=eD.deconstruct_url();j="/lightbox";if(i.path.indexOf(j)===0){i.path=i.path.slice(j.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(cT.call(i.path,"/album/")<0){if(i.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(T!=null){i.path=cJ.get(T).url}return eD.push_state(i.path,i.qargs)},show_all_collections:function(){g.log_transition_to(cn.ALBUMS_VIEW);return eD.push_state("/photos/all_albums")},show_all_photos:function(j){var i;j.preventDefault();g.log_transition_to(cn.PHOTOS_VIEW);i=eD.deconstruct_url();if(i.path==="/photos"){return this._refresh_view()}else{eU.clear();return eD.push_state("/photos")}},_back_to_photos:function(i){eU.clear();return this.show_all_photos(i)},_back_to_albums:function(i){eU.clear();return this.show_all_collections()},get_thumb_click_event_data:function(T,i){var j;j=T.event;return{timeline_photo_index:i,event_photo_index:j.photos.indexOf(T),num_photos_in_event:j.photos.length,event_index:this.get_timeline().events.list.indexOf(j.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(j){var i;i=this.get_timeline().get_photo_for_thumb_elm($(j.target));if(eU._drag_drop.ignore_next_click){return eU._drag_drop.ignore_next_click=false}else{return eU.photo_click(j,i)}},_thumb_double_click:function(fl){var T,j,i;j=this.get_timeline().get_photo_for_thumb_elm($(fl.target));i=this.get_timeline().index_of_photo(j);this._preview(i);T=this.get_thumb_click_event_data(j,i);return g.log_interaction(el.OPEN_LIGHTBOX,dc.DBL_CLICK,T)},_thumb_context_menu:function(fo){var fl,i,T,fp,fn,fm;T=this.get_timeline().get_photo_for_thumb_elm($(fo.target));if(fo.shiftKey){eU.photo_click(fo,T);return}if(eU.contains(T)){fp=eU.get()}else{fp=[T]}bn.show_photos(fo,fp);fm=[];for(fl=0,i=fp.length;fl<i;fl++){T=fp[fl];fm.push((fn=this.get_timeline().get_thumb_elm_for_photo(T))!=null?fn.addClassName("context-selected"):void 0)}return fm},_context_menu_hide:function(i){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(j){var i;i=eU.get();if(!i.length){return}ez.show(i,false);return g.log_interaction(el.SHARE,dc.SAH,{num_photos:i.length})},_clear_selected:function(j){var i;i=eU.get().length;eU.clear();return g.log_interaction(el.CLEAR_SELECTED,dc.SAH,{num_photos:i})},_share_collection:function(j){var i;cL(this.in_single_collection_view(),"_share_collection can only happen in single collection view");i=this.get_current_collection();if(i.num_items===0){ah.error(eA("This album is empty. Add some photos before you share it!"));return}ez.show(this.get_current_collection(),true);return g.log_interaction(el.SHARE_ALBUM,dc.SCA)},toggle_mem_lane_settings:function(i){var T,j;if(i){Event.extend(i).preventDefault()}if(!bF("#memory-lane-settings-menu").visible()){j=bF("#memory-lane-settings-menu");eT.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));T=function(fl){return fl.stopPropagation()};j.off("mousedown");j.off("click");j.on("mousedown",T);return j.on("click",T)}},show_delete_photos_modal:function(fr){var fs,fp,fn,fo,fm,fq,i,T,fl;if(fr.length===1){T=fr[0];if(T.duplicates_info!=null){this._show_duplicates_modal(T,true);return}}else{fs=[];for(fn=0,fo=fr.length;fn<fo;fn++){T=fr[fn];if(T.duplicates_info!=null){fp=T.duplicates_info.slice(0);fp.push(T);fp.sort(function(ft,j){return j.mtime-ft.mtime});fs=fs.concat(fp)}}if(fs.length){this._show_delete_multiple_duplicates_modal(fr,fs);return}}fl=c9.categorize_files(fr),fq=fl[0],i=fl[1];if(fq&&i){fm=bd("Delete %(file_count)s item?","Delete %(file_count)s items?",fr.length)}else{if(fq){fm=bd("Delete %(file_count)s photo?","Delete %(file_count)s photos?",fr.length)}else{fm=bd("Delete %(file_count)s video?","Delete %(file_count)s videos?",fr.length)}}return dM.show({title_text:fm.format({file_count:fr.length}),body_html:eA("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:c9.file_desc(fr)}),confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:(function(j){return function(){return j._delete_photos(fr)}})(this)})},_delete_photos:function(fy){var fq,fs,fu,fr,fl,fp,fn,ft,fo,fw,i,T,fx,fm,fv;fy=fy.slice(0);fx=[];for(fp=0,ft=fy.length;fp<ft;fp++){T=fy[fp];fx.push(T.fq_path);if(T.duplicates_info!=null){fm=T.duplicates_info;for(fn=0,fo=fm.length;fn<fo;fn++){fl=fm[fn];fx.push(fl.fq_path)}}}fv=c9.categorize_files(fy),fw=fv[0],i=fv[1];if(fw&&i){fr=bd("Deleting file","Deleting files",fx.length);fu=bd("Deleted file.","Deleted files.",fx.length)}else{if(fw){fr=bd("Deleting photo","Deleting photos",fx.length);fu=bd("Deleted photo.","Deleted photos.",fx.length)}else{fr=bd("Deleting video","Deleting videos",fx.length);fu=bd("Deleted video.","Deleted videos.",fx.length)}}fs=function(j){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(j)},html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:function(fz){var fA;fA=eA("Undo complete");ah.success(fA);return bQ._all_photos_timeline.restore_removed_photos()},subject_user:cM.get_viewer().photos_user})};fq=(function(j){return function(fz){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fx},job:fx.length>bQ.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cM.get_viewer().photos_user,progress_text:fr,onSuccess:function(fC){var fA,fD,fB;fD=fC.responseText.evalJSON();fB=bQ.undo_enabled&&(bQ._all_photos_timeline!=null);fA=fB?fD.changesets:null;X.notifyWithUndo(fr,fA,fs);bQ.get_timeline().remove_photos(fy);if(fz.length>0){return cJ.refresh_album_views(fz)}},subject_user:cM.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fx)},onSuccess:(function(j){return function(fB){var fA,fz,fC,fD;fz=JSON.parse(fB.responseText);fC=[];for(fD in fz){fA=fz[fD];fC=fC.concat(fA)}return fq(fC)}})(this)})},_preview:function(i){return aM.show(i)},_lightbox_delete:function(i){var j;j=i.memo.photo;g.log_interaction(el.DELETE,dc.LIGHTBOX);return this.show_delete_photos_modal([j])},_lightbox_remove:function(j){var i;i=j.memo.photo;this.get_current_collection().remove_photos([i]);return g.log_interaction(el.REMOVE,dc.LIGHTBOX)},_show_duplicates_modal:function(T,fz){var fs,fy,fp,fu,ft,fn,fw,fo,fr,fm,fq,fv,i,fl,fx;ft=T.duplicates_info.slice(0);ft.push(T);ft.sort(function(fA,j){return j.mtime-fA.mtime});fu=$("cu-duplicate-files");fn=[];for(fo=0,fr=ft.length;fo<fr;fo++){fp=ft[fo];fy="Dropbox"+aA.normalize(aA.parent_dir(fp.fq_path));fn.push(this._cu_duplicate_tmpl({thumbnail_url:fp.thumbnail_url,filename_snippet:bU.em_snippet(fp.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fy,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fp)}))}fu.__date(fn);if(ft.length>=5){fu.addClassName("scroll")}else{fu.removeClassName("scroll")}fl=c9.categorize_files([T]),fv=fl[0],i=fl[1];if(fv){fm=eA("There are multiple copies of this photo.");fq=eA("Delete all copies of this photo?")}else{fm=eA("There are multiple copies of this video.");fq=eA("Delete all copies of this video?")}if(fz){fw="delete_32";fx=fq;fs=fm+" "+eA("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fw="folder_32";fx=eA("Show in folder");fs=fm+" "+eA("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}dv.fillVal(fs,"cu-duplicates-desc");return fb.show(fx,$("cu-duplicates-modal"),{action:this._delete_photos.curry([T])})},_show_delete_multiple_duplicates_modal:function(fw,fs){var fv,fp,ft,fm,fn,fr,fl,fq,fo,fu,i,T;ft=$("cu-multiple-duplicate-files");fm=[];for(fn=0,fr=fs.length;fn<fr;fn++){fp=fs[fn];fv="Dropbox"+aA.normalize(aA.parent_dir(fp.fq_path));fm.push(this._cu_duplicate_tmpl({thumbnail_url:fp.thumbnail_url,filename_snippet:bU.em_snippet(fp.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fv,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fp)}))}ft.__date(fm);if(fs.length>=5){ft.addClassName("scroll")}else{ft.removeClassName("scroll")}T=c9.categorize_files(fw),fu=T[0],i=T[1];if(fu&&i){fl=eA("Delete %(num_files)s files and all copies?").format({num_files:fw.length});fq=eA("There are multiple copies of these files in your Dropbox.");fo=eA("Show files with multiple copies")}else{if(fu){fl=eA("Delete %(num_photos)s photos and all copies?").format({num_photos:fw.length});fq=eA("There are multiple copies of these photos in your Dropbox.");fo=eA("Show photos with multiple copies")}else{fl=eA("Delete %(num_videos)s videos and all copies?").format({num_videos:fw.length});fq=eA("There are multiple copies of these videos in your Dropbox.");fo=eA("Show videos with multiple copies")}}dv.fillVal(fq,"cu-multiple-duplicates-desc");dv.fillVal(fo,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return fb.show(fl,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fw)})},show_timestamps_modal:function(fn){var j,T,fl,i,fm;fn.sort_by_key((function(fo){return fo.time_taken}),true);i=(function(){var fp,fo,fq;fq=[];for(fp=0,fo=fn.length;fp<fo;fp++){fl=fn[fp];fq.push(fl.time_taken)}return fq})();j=(function(){var fp,fo,fq;fq=[];for(fp=0,fo=fn.length;fp<fo;fp++){fl=fn[fp];fq.push(fl.item_counter)}return fq})();T=(function(){var fp,fo,fq;fq=[];for(fp=0,fo=i.length;fp<fo;fp++){fm=i[fp];if(fm==null){fq.push(fm)}}return fq})();if(T.length===i.length){return this._show_add_timestamps_modal(fn,i,j)}else{if(T.length===0){return this._show_edit_timestamps_modal(fn,i,j)}else{return cL(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(i,j){return this._refresh_photo_events((function(T){return function(){var fl,fm;fm=("m_"+(j.getFullYear()))+(""+(j.getMonth()+1)).lpad(2);fl=T.get_timeline().events.valueFromKey(fm);cL(fl!=null,"Event is missing after a timestamp edit!");eB.update("2/3");fl.on_load_all_metadata=function(){T.get_timeline().scroll_to_photo_with_key(i.uniqueness_key);eB.hide();return ah.success("New timestamps have been saved!")};if(fl.has_loaded_metadata()){fl.on_load_all_metadata();return fl.on_load_all_metadata=null}else{return fl.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fm,j,i){var fl,T;T=bF("#add-timestamp-modal");fl=new I("date_picker",{disable_future:true});return fb.show("Set Timestamps",T[0],{action:(function(fn){return function(){var fr,fs,fv,fq,fo,ft,fu,fp;ft=d6.to_iso8601_date(fl.selected_date,false,true);fu=(function(){var fw,fy,fx;fx=[];for(fr=fw=0,fy=fm.length;0<=fy?fw<fy:fw>fy;fr=0<=fy?++fw:--fw){fx.push(ft)}return fx})();fp={};for(fs=fq=0,fo=i.length;fq<fo;fs=++fq){fv=i[fs];fp[fv]=fu[fs]}eB.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fp)},onSuccess:function(fw){eB.update("1/3");return fn._scroll_to_photo_after_timestamp_edit(fm[0],fl.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fq,fp,fl){var fn,j,i,fo,T,fm;fo=bF("#edit-timestamp-modal");i=(function(){var fs,fr,ft;ft=[];for(fs=0,fr=fp.length;fs<fr;fs++){fm=fp[fs];ft.push(N.toUTCDate(new Date(fm)))}return ft})();T={year:0,month:0,day:0,hour:0};fn=function(fr){return eA("%(date)s at %(time)s").format({date:N.localize(fr),time:N.format(fr,Constants.time_format)})};j=function(fr,fv,fw,fu){var ft,fs;if(fr==null){fr=0}if(fv==null){fv=0}if(fw==null){fw=0}if(fu==null){fu=0}T.year+=fr;T.month+=fv;T.day+=fw;T.hour+=fu;fs=b6.increment_date(new Date(i[0]),T.year,T.month,T.day,T.hour,0);ft=b6.increment_date(new Date(i[i.length-1]),T.year,T.month,T.day,T.hour,0);if(fq.length===1){return fo.find("#timestamp-new").text(fn(fs))}else{fo.find("#timestamp-new-start").text(fn(fs));return fo.find("#timestamp-new-end").text(fn(ft))}};if(fq.length===1){fo.find("#edit-timestamp-single").show();fo.find("#edit-timestamp-multi").hide();fo.find("#timestamp-current").text(fn(i[0]))}else{fo.find("#edit-timestamp-single").hide();fo.find("#edit-timestamp-multi").show();fo.find("#timestamp-current-start").text(fn(i[0]));fo.find("#timestamp-current-end").text(fn(i[i.length-1]))}j();bF("#timestamp-year-plus").on("click",j.curry(1,0,0,0));bF("#timestamp-year-minus").on("click",j.curry(-1,0,0,0));bF("#timestamp-month-plus").on("click",j.curry(0,1,0,0));bF("#timestamp-month-minus").on("click",j.curry(0,-1,0,0));bF("#timestamp-day-plus").on("click",j.curry(0,0,1,0));bF("#timestamp-day-minus").on("click",j.curry(0,0,-1,0));bF("#timestamp-hour-plus").on("click",j.curry(0,0,0,1));bF("#timestamp-hour-minus").on("click",j.curry(0,0,0,-1));fb.onHide=function(){var fs,ft,fr,fu;fu=["year","month","day","hour"];for(ft=0,fr=fu.length;ft<fr;ft++){fs=fu[ft];bF("#timestamp-"+fs+"-plus").off("click");bF("#timestamp-"+fs+"-minus").off("click")}fb.onHide=null;return fb.hide()};return fb.show("Edit Timestamps",fo[0],{action:(function(fr){return function(){var fC,fw,fs,fv,fA,ft,fx,fu,fB,fz,fD,fy;if((((T.year===(fz=T.month)&&fz===(fB=T.day))&&fB===(fu=T.hour))&&fu===0)){return}g.log_interaction(el.EDIT_TIMESTAMP,dc.PCM,{num_photos:fq.length});ft=(function(){var fF,fE,fG;fG=[];for(fF=0,fE=i.length;fF<fE;fF++){fC=i[fF];fG.push(b6.increment_date(fC,T.year,T.month,T.day,T.hour,0))}return fG})();fx=(function(){var fF,fE,fG;fG=[];for(fF=0,fE=ft.length;fF<fE;fF++){fD=ft[fF];fG.push(d6.to_iso8601_date(fD,false,true))}return fG})();fy={};for(fw=fv=0,fA=fl.length;fv<fA;fw=++fv){fs=fl[fw];fy[fs]=fx[fw]}eB.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fy)},job:fq.length>fr.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cM.get_viewer().photos_user,onSuccess:function(fE){eB.update("1/3");return fr._scroll_to_photo_after_timestamp_edit(fq[0],ft[0])}})}})(this)})},_preload_file_previews:function(fm){var fu,fr,fo,fn,fl,ft,fp,T,fy,fx,fv,fs,fq,fw;fw=this.get_timeline().get_photos();if(fm[0]<=fm[fm.length-1]){fs=null;for(fo=0,ft=fm.length;fo<ft;fo++){fr=fm[fo];T=fw[fr];if(T.status!==K.PLACEHOLDER){continue}fy=T.event;if(fs==null){fs=fy;fv=T}if(fy===fs){continue}if(fs.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fs.load_metadata();fs=fy;fv=T}if((fs!=null)&&!fs.has_loaded_metadata()){fu=fs.photos.indexOf(fv);fl=fs.photos.indexOf(T);if(fs.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fs.load_metadata_range(fu,fl)}}else{fq=[];for(fn=0,fp=fm.length;fn<fp;fn++){fr=fm[fn];T=fw[fr];if(T.status!==K.PLACEHOLDER){continue}fy=T.event;fx=fy.photos.indexOf(T);fq.push(fy.load_metadata(fx))}return fq}},_lightbox_photo_change:function(fr){var fo,fn,fl,ft,fm,fs,i,fq,fp,T;this._last_lightbox_photo=fr.memo.preview_obj.photo;fl=fr.memo.index;fm=aM.num_previews();if(fl===0||fl===fm-1){return}if(fr.memo.direction===aM.NEXT||(fr.memo.direction==null)){ft=Math.min(fl+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fm-1);return this._preload_file_previews((function(){fp=[];for(var fu=i=fl+1;i<=ft?fu<=ft:fu>=ft;i<=ft?fu++:fu--){fp.push(fu)}return fp}).apply(this))}else{if(fr.memo.direction===aM.PREV){fs=Math.max(fl-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){T=[];for(var j=fq=fl-1;fq<=fs?j<=fs:j>=fs;fq<=fs?j++:j--){T.push(j)}return T}).apply(this))}}},_lightbox_exit:function(i){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var j,fl,T,i;i=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){i+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}j=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((fl=this._all_photos_timeline)!=null){fl.update_offsets(i,j)}return(T=this._single_collection_timeline)!=null?T.update_offsets(i,j):void 0},_history_change_handler:function(fw,fv){var fp,fr,fu,fm,fs,fl,i,ft,fq,fo,fn,T;if(this._init_finished){if(fb.shown()){fb.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((i=this.get_timeline())!=null){i.unlisten()}if(fw==="all_albums"){cJ.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((ft=$("all-albums-sidebar"))!=null){ft.addClassName("selected")}eU.clear();document.title=eA("Albums")+" - Dropbox";cJ.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fw.startsWith("album/")){fp=cJ.get_from_url("/photos/"+fw);fq=$$(".sidebar-album");for(fm=0,fs=fq.length;fm<fs;fm++){fu=fq[fm];if(fu.readAttribute("data-gid")===fp.gid){fu.addClassName("selected");break}}$("single-collection-title").__date(bU.em_snippet(fp.name,cJ.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fp.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fp.shmodel_url);if(((fo=fp.member_fnames)!=null?fo.length:void 0)>1){fr=eA("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:c9.album_desc(fp),album_members:d6.nice_list(fp.member_fnames)});$("single-collection-share-status").__date(fr)}else{$("single-collection-share-status").__date(eA("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fp.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=fp.name+" - Dropbox";cA.log_event("show_collection",fp.gid,fp.num_photos,fp.is_anonymous)}else{fp=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=eA("Photos")+" - Dropbox"}fl=false;if(fp!=null){if(fp.gid!==this._current_collection_gid){fl=true}}else{if(this._all_photos_timeline==null){fl=true}}this._current_collection_gid=fp!=null?fp.gid:null;if(fl){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){T=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(T);if((fn=$(T))!=null){fn.addClassName("wiggobble")}setTimeout((function(){return $(T).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aO;aO=INLINE_JS.PhotosTour=E.PhotosTour={_frame:0,next:function(){var i;fb.show("",bF("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);i=this._frame;g.log_interaction(a8.SHOW_MODAL,"",{frame:i});bF("#modal-x").off("click");bF("#modal-x").on("click",((function(j){return function(){return g.log_interaction(a8.EXIT_MODAL,"",{frame:i})}})(this)));return this._frame=(this._frame+1)%4},hide:function(i){g.log_interaction(i,"");return fb.hide()}};var c9;c9=E.PhotosUtil={categorize_files:function(j){var T,i;T=j.filter(function(fl){return fl.preview_type==="photo"});i=j.filter(function(fl){return fl.preview_type==="video"});return[T.length,i.length]},file_desc:function(fn,fl,i){var j,fm,T;if(fl==null){fl=false}if(i==null){i=false}T=this.categorize_files(fn),j=T[0],fm=T[1];return this._photo_video_desc(j,fm,fl,i)},album_desc:function(T,j,i){if(j==null){j=false}if(i==null){i=false}return this._photo_video_desc(T.num_photos,T.num_videos,j,i)},_photo_video_desc:function(j,fo,T,i){var fl,fn,fm;fn=bd("%d photo","%d photos",j,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(j);fm=bd("%d video","%d videos",fo,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fo);if(j&&fo){if(T){fl=j+fo;return bd("%d item","%d items",fl).format(fl)}else{if(i){return new fg(fn+"<br/>"+fm)}else{return eA("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:fn,num_videos:fm})}}}else{if(j){return fn}else{if(fo){return fm}else{return""}}}}};var eU,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};eU=INLINE_JS.PhotosSelection=E.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&i._last_mouseover&&!C.focus_in_input()){return i._highlight_range(i._last_selected,i._last_mouseover)}}})(this));$(document.body).on("keyup",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&!i._marquee.active){return i.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bQ.KEY_SCOPE,(function(i){return function(j){j.preventDefault();if(bQ.in_single_collection_view()){if(i._selected.length){return cJ.show_remove_photos_modal(bQ.get_current_collection(),i._selected)}}else{if(i._selected.length){return bQ.show_delete_photos_modal(i._selected)}}}})(this));key("esc",bQ.KEY_SCOPE,(function(i){return function(T){var j;if(typeof T.preventDefault==="function"){T.preventDefault()}if(i._drag_drop.active){i._drag_drop.active=false;if((j=$("albums-sidebar-list"))!=null){j.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{i.clear();return g.log_interaction(el.CLEAR_SELECTED,dc.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return A.init(null,bF("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(j){var T,i,fl;fl=(function(){var fn,fm,fp,fo;fp=this._selected;fo=[];for(fn=0,fm=fp.length;fn<fm;fn++){i=fp[fn];fo.push(i.uniqueness_key)}return fo}).call(this);return T=j.uniqueness_key,cT.call(fl,T)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eT.hide_all();return document.fire(eU.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(j,i){if(j.isRightClick()&&!j.shiftKey){return}if(j.shiftKey){return this._select_highlighted()}else{if(this.contains(i)){return this._remove(i)}else{return this._add(i)}}},num_selected:function(){return this._selected.length},refresh:function(T){var fo,fm,fl,fp,fn,i,fq;fq=(function(){var fs,fr,fu,ft;fu=this._selected;ft=[];for(fs=0,fr=fu.length;fs<fr;fs++){i=fu[fs];ft.push(i.uniqueness_key)}return ft}).call(this);fn=[];for(fm=0,fl=T.length;fm<fl;fm++){fp=T[fm];fo=fq.indexOf(fp.uniqueness_key);if(fo>=0){fn.push(this._selected[fo]=fp)}else{fn.push(void 0)}}return fn},inc_num_loading_events_before_select:function(i){if(!this._show_share_after_loading_selected){eB.show(eA("Loading photos..."))}this._show_share_after_loading_selected=i;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;eB.update((this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){eB.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bQ._share_selected()}}}},_photo_mouseover:function(i){this._last_mouseover=bQ.get_timeline().get_photo_for_thumb_elm($(i.target));if(i.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(i){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(fl){var i,T,j;if(bQ.in_all_collections_view()||fl.isRightClick()||this._invalid_mouse_target($(fl.target))){return}bn.hide();eT.hide_all();i=(T=bQ.get_timeline())!=null?T.get_photo_for_thumb_elm($(fl.target)):void 0;if(i!=null){if(this.contains(i)||!eU.drag_select_enabled){j=C.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=fl.clientX+j.left;this._drag_drop.start_y=fl.clientY+j.top;this._drag_drop.anchor=$(fl.target);this._drag_drop.single_photo=this.contains(i)?null:i;this._build_drag_status(i);this._update_drag_status_position(fl)}else{this._drag_select.active=true;this._drag_select.anchor=i}}else{j=C.scroll_offsets();if((fl.clientX+j.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=fl.clientX+j.left;this._marquee.start_y=fl.clientY+j.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return A.start()},_body_mousemove:function(fl){var T,j,i,fm;j=C.scroll_offsets();i=fl.clientX+j.left;fm=fl.clientY+j.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(i-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fm-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=i;this._marquee.end_y=fm;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(i-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fm-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(fl);$$(".sidebar-album").invoke("removeClassName","album-flash");if((T=$("albums-sidebar-list"))!=null){T.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(T){var j,i;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();j=this._highlighted.length;this._select_highlighted();if(j){g.log_interaction(el.MARQUEE_SELECT,dc.DRAG,{num_selected:j})}}if(this._drag_drop.active){if($(T.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((i=$("albums-sidebar-list"))!=null){i.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return A.end()},_body_double_click:function(i){if(bQ.get_timeline().get_photo_for_thumb_elm($(i.target))||this._invalid_mouse_target($(i.target))){return}this.clear();return g.log_interaction(el.CLEAR_SELECTED,dc.DBL_CLICK)},_draw_marquee:function(){var i,fm,fl,T,j;j=Math.abs(this._marquee.start_x-this._marquee.end_x);i=Math.abs(this._marquee.start_y-this._marquee.end_y);fl=Math.min(this._marquee.start_y,this._marquee.end_y);fm=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:j+"px",height:i+"px",top:fl+"px",left:fm+"px"});$("marquee").show();T=false;if(bQ.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);T=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);T=true}if(T){return this._update_marquee_highlight(fl,fm,j,i)}}},_update_marquee_highlight:function(fw,fn,T,fx){var ft,fr,fo,fu,fq,fp,fl,fv,fs,fm;this.clear_highlighted();fm=[];fu=bQ.get_timeline().grid.photo_col_offsets.length;fl=bQ.get_timeline().grid.photo_col_offsets.slice(0,fu-1);for(ft=fr=0,fq=fl.length;fr<fq;ft=++fr){fp=fl[ft];if(fp<=fn+T&&bQ.get_timeline().grid.photo_col_offsets[ft+1]>=fn){fm.push(ft)}}fs=[];for(ft=fo=0,fv=bQ.get_timeline().events.length();0<=fv?fo<fv:fo>fv;ft=0<=fv?++fo:--fo){fs.push(bQ.get_timeline().events.valueAtIndex(ft).marquee_highlight(fw,fw+fx,fm))}return fs},_update_marquee_x_bounds:function(T){var fo,fm,fl,fq,fr,fp,fn;fq=$(document.body).getWidth();if(T<bQ.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bQ.get_timeline().grid.photo_col_offsets.first()}else{if(T>bQ.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fq}else{fp=bQ.get_timeline().grid.photo_col_offsets;fn=[];for(fo=fm=0,fl=fp.length;fm<fl;fo=++fm){fr=fp[fo];if(fr>T){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets[fo-1];this._marquee.x_max_boundary=fr;break}else{fn.push(void 0)}}return fn}}},_update_marquee_y_bounds:function(fr){var T,fp,fm,fl,fo,fq,fn;fo=$(document.body).getHeight();if(fr<bQ.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bQ.get_timeline().grid.photo_row_offsets.first()}else{if(fr>bQ.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=fo}else{fq=bQ.get_timeline().grid.photo_row_offsets;fn=[];for(fp=fm=0,fl=fq.length;fm<fl;fp=++fm){T=fq[fp];if(T>fr){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets[fp-1];this._marquee.y_max_boundary=T;break}else{fn.push(void 0)}}return fn}}},_build_drag_status:function(fl){var T,i,j;i=bQ.get_timeline().get_thumb_elm_for_photo(fl);j=i.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(j);T=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(c9.file_desc(T,false,true))},_update_drag_status_position:function(i){return $("photos-drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fy,fx,fm){var fw,T,fo,fr,fp,fu,fs,fn,fv,ft,fq,fl;if(fm==null){fm=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fy;this._last_highlight_to_photo=fx;fo=bQ.get_timeline().index_of_photo(fy);fl=bQ.get_timeline().index_of_photo(fx);fw=!fm&&this.contains(fx)&&!this.contains(fy);fq=[];for(fr=fp=fn=fo,fv=fl;fn<=fv?fp<=fv:fp>=fv;fr=fn<=fv?++fp:--fp){fs=bQ.get_timeline().photo_at_index(fr);if(fs.status===K.PLACEHOLDER){if(fs.event!==fu){T=fs.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(ft=T.unique_id,cT.call(this._events_highlighting,ft)<0){this._events_highlighting.push(T.unique_id)}fq.push(fu=T)}else{fq.push(void 0)}}else{fq.push(void 0)}}else{if(this.contains(fs)){if(fw){fq.push(this._dehighlight(fs))}else{fq.push(void 0)}}else{if(!fw){fq.push(this._highlight(fs))}else{fq.push(void 0)}}}}return fq},_highlight_range_incremental:function(T){var ft,fm,fu,fp,fo,fq,fn,fr,fl,fs;fu=this._last_highlight_from_photo;fs=this._last_highlight_to_photo;if(!((fu!=null)&&(fs!=null))){return}fm=bQ.get_timeline().index_of_photo(fu);fl=bQ.get_timeline().index_of_photo(fs);for(fp=fo=fn=fm,fr=fl;fn<=fr?fo<=fr:fo>=fr;fp=fn<=fr?++fo:--fo){fq=bQ.get_timeline().photo_at_index(fp);if(fq.status!==K.PLACEHOLDER&&!this.contains(fq)&&this._highlighted.indexOf(fq)===-1){this._highlight(fq)}}ft=this._events_highlighting.indexOf(T.unique_id);if(ft>=0){this._events_highlighting.splice(ft,1)}if(this._select_highlighted_waiting){eB.update((this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(fm){var fl,T,i,fn;this.clear_highlighted();fn=[];for(fl=0,T=fm.length;fl<T;fl++){i=fm[fl];if(!this.contains(i)){fn.push(this._highlight(i))}else{fn.push(void 0)}}return fn},_select_highlighted:function(){var fo,fl,fn,T,fm,fp,i;if(this._events_highlighting.length>0){eB.show(eA("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fp=this._highlighted;for(fo=0,fn=fp.length;fo<fn;fo++){fm=fp[fo];this._add(fm)}i=this._dehighlighted;for(fl=0,T=i.length;fl<T;fl++){fm=i[fl];this._remove(fm)}if(this._select_highlighted_waiting){eB.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(j){var i;this._highlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("highlighted"):void 0},_dehighlight:function(j){var i;this._dehighlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("dehighlighted"):void 0},_add:function(j){var i;cL(j.status!==K.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);i=bQ.get_timeline().get_thumb_elm_for_photo(j);if(i!=null){i.addClassName("selected")}this._selected.push(j);this._last_selected=j;dv.fillVal(c9.file_desc(this._selected,true),"selected-desc");dv.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eU.CHANGE_EVT)},_remove:function(T){var j,i;i=bQ.get_timeline().get_thumb_elm_for_photo(T);if(i!=null){i.removeClassName("selected")}j=this._selected.indexOf(T);if(j!==-1){this._selected.splice(j,1);this._last_selected=T;if(this._selected.length){dv.fillVal(c9.file_desc(this._selected,true),"selected-desc");dv.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eU.CHANGE_EVT)},_invalid_mouse_target:function(fl){var T,i,j;j=fl.classNames().toArray().concat(fl.up().classNames().toArray());return(cT.call(j,"freshbutton")>=0)||(cT.call(j,"freshbutton-blue")>=0)||(cT.call(j,"freshbutton-lightblue")>=0)||(cT.call(j,"freshbutton-blue-on-gray")>=0)||(cT.call(j,"timeline-elm")>=0)||(fl.up(".no-marquee")!=null)||(fl.up("#context-menu")!=null)||(fl.up(".freshdropdown-menu")!=null)||fl.nodeName==="A"||((T=fl.tagName.toUpperCase())==="INPUT"||T==="TEXTAREA"||T==="SELECT")||fb.shown()||((i=$("modal-progress-content"))!=null?i.visible():void 0)||aM.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cJ,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};cJ=INLINE_JS.PhotosCollections=E.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new fg('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(j,i){this._collections=j;this._gid_to_collection=j.dict_by("gid");this._url_to_collection=j.dict_by("url");this._collection_list_item_tmpl=fg.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=fg.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var i;i=eD.deconstruct_url();if(i.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(i){if(this._num_loading_collections!==null&&(this._num_loading_collections<i||i===null)){this._num_loading_collections=i;return cE.WebRequest({url:"/collections",data:{limit:i},subject_user:cM.get_viewer().photos_user,success:(function(j){return function(fq){var fp,fo,fm,T,fn,fl;fl=JSON.parse(fq);for(fm=0,T=fl.length;fm<T;fm++){fo=fl[fm];if(!(fo.gid in j._gid_to_collection)&&!(fn=fo.gid,cT.call(j._removed_pre_load,fn)>=0)){fp=new ad(fo,false);j._collections.push(fp);j._gid_to_collection[fp.gid]=fp;j._url_to_collection[fp.url]=fp}}if(i===null||fl.length<i){j._all_collections_loaded=true;j._sidebar_collections_loaded=true}if(i>=5){j._sidebar_collections_loaded=true}return j.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(i){return function(j){if(!bQ.get_current_collection().is_creator){return}i.header_rename();return g.log_interaction(el.RENAME_ALBUM,dc.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bn.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(ad.CREATE_EVT,this._collection_created.bind(this));document.observe(ad.ADD_EVT,this._collection_photos_added.bind(this));document.observe(ad.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(ad.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(ad.RENAME_EVT,this._collection_renamed.bind(this));document.observe(ad.DELETE_EVT,this._collection_deleted.bind(this));document.observe(ad.SHARE_EVT,this._collection_shared.bind(this));document.observe(ad.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(ad.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var fn,fl,T,i,fm;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}fl=[];fm=this._collections;for(T=0,i=fm.length;T<i;T++){fn=fm[T];fl.push(this._collection_list_item_tmpl({collection:fn,additional_class:"albums-list-item show-collection-target",Sprite:cx,Emstring:bU}))}$("albums-list").__date(fl);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fo,fl,fn,T,i,fm;fl=[];fn={name:eA("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};fl.push(this._collection_list_item_tmpl({collection:fn,additional_class:"create-album-target",hide_icons:true,Sprite:cx,Emstring:bU}));fm=this._collections;for(T=0,i=fm.length;T<i;T++){fo=fm[T];fl.push(this._collection_list_item_tmpl({collection:fo,additional_class:"add-to-album-target",Sprite:cx,Emstring:bU}))}$("add-to-album-modal-list").__date(fl);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fq,T,fo,fr,i,fp,fn,fm,fl;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();fr=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:eA,Sprite:cx,PhotosCollections:cJ});if((i=$("albums-sidebar"))!=null){i.__date(fr)}if((fp=$("all-albums-sidebar"))!=null){fp.observe("click",bQ.show_all_collections)}if((fn=$("all-albums-sidebar"))!=null){fn.observe("mouseup",(function(j){return function(fs){var ft;if(!eU._drag_drop.active){return}if(eU._drag_drop.single_photo!=null){ft=[eU._drag_drop.single_photo]}else{ft=eU.get()}j.show_add_to_album_modal(fs,ft);return g.log_interaction(el.ADD_TO_OTHER_ALBUM,dc.DROP_TARGET,{num_photos:eU.get().length})}})(this))}if(bQ.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bQ.in_single_collection_view()){fm=$$(".sidebar-album");fl=[];for(T=0,fo=fm.length;T<fo;T++){fq=fm[T];if(fq.readAttribute("data-gid")===bQ.get_current_collection().gid){fq.addClassName("selected");break}else{fl.push(void 0)}}return fl}}},refresh_album_views:function(j){var i;if(j==null){j=null}i=(function(T){return function(){T.render_all_albums_view();T.render_albums_sidebar();return T.render_add_to_album_modal()}})(this);if(j!=null?j.length:void 0){return cE.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(j.unique())},subject_user:cM.get_viewer().photos_user,success:(function(T){return function(fn){var fv,fs,fm,fr,fq,fo,ft,fp,fl,fu;fl=JSON.parse(fn);for(fq=0,ft=fl.length;fq<ft;fq++){fm=fl[fq];fs=new ad(fm,false);T._gid_to_collection[fs.gid]=fs;T._url_to_collection[fs.url]=fs;fu=T._collections;for(fr=fo=0,fp=fu.length;fo<fp;fr=++fo){fv=fu[fr];if(fv.gid===fs.gid){T._collections[fr]=fs;break}}}return i()}})(this)})}else{return i()}},show_add_to_album_modal:function(i,j){if(j!==eU.get()&&(eU._drag_drop.single_photo==null)){eU._context_selected=j}fb.onHide=function(){eU._context_selected=null;delete fb.onHide;return fb.hide()};fb.show(eA("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(T,fm,j){var i,fl;if(j==null){j=true}fl=bQ.get_current_collection_gid();i=fm.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ah.success(eA("Adding to album..."));return T.add_photos(fm,fl,i,j)},show_remove_photos_modal:function(fl,fn){var T,i,fm,j;j=c9.categorize_files(fn),i=j[0],fm=j[1];if(i&&fm){T=bd("Remove %(file_count)s item?","Remove %(file_count)s items?",fn.length)}else{if(i){T=bd("Remove %(file_count)s photo?","Remove %(file_count)s photos?",fn.length)}else{T=bd("Remove %(file_count)s video?","Remove %(file_count)s videos?",fn.length)}}T=T.format({file_count:fn.length});dv.fillVal(c9.file_desc(fn),"collection-remove-files");dv.fillVal(fl.name.escapeHTML(),"collection-remove-name");return fb.show(T,dv.fromElm("collection-remove-modal"),{action:(function(fo){return function(){var fp;fn=fn.slice(0);fp=fn.length>fo.NUM_PHOTOS_LONG_RUNNING_REMOVES;return fl.remove_photos(fn,fp)}})(this)})},header_rename:function(){if(bF("#single-collection-title-container").hasClass("editing")){return}bF("#single-collection-title-container").addClass("editing");return bQ.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(j){var i;dv.fillVal(j.name.escapeHTML(),"collection-delete-name");i=eA("Delete album?");return fb.show(i,dv.fromElm("collection-delete-modal"),{action:function(){if(j.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ah.success(eA("Deleting '%(collection_name)s'...").format({collection_name:j.name}),100)}return j["delete"]()}})},show_unshare_modal:function(j){var i;dv.fillVal(j.name.escapeHTML(),"collection-unshare-name");i=eA("Unshare album?");return fb.show(i,dv.fromElm("collection-unshare-modal"),{action:function(){return j.unshare()}})},create:function(fq,fp,fu,j){var fl,fm,T,fn,fs,ft,fr,i,fo;if(j==null){j=false}if(fq){Event.extend(fq).preventDefault();fo=$(fq.target);if(fo.hasClassName("inplaceeditor-form")||(fo.up(".inplaceeditor-form")!=null)){return}if(fo.up("#context-menu")){fl=true}else{if(fo.up(".freshdropdown-menu")){T=true}}}bQ.enable_selection();if(!fu){fu=eU.get()}fn=(function(){var fw,fv,fx;fx=[];for(fw=0,fv=fu.length;fw<fv;fw++){i=fu[fw];fx.push(i.item_counter)}return fx})();fu.sort_by_key(function(fv){return fv.time_taken});fs=fu.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;fr=(function(fv){return function(fx){var fA,fy,fw,fz;fy=JSON.parse(fx.responseText);fA=new ad(fy);eU.clear();eT.hide_all();bn.hide();fb.hide();bQ.disable_selection();fz=eA("Created '%(collection_name)s'");fw=fA.name.escapeHTML();fz=fz.format({collection_name:"<a data-gid='"+fA.gid+"' class='show-collection-target'>"+fw+"</a>"});ah.success(new fg(fz));return fv.flash_sidebar_album(fA.gid)}})(this);ft=function(){if(!T){eT.hide_all()}if(!fl){bn.hide()}cJ.render_albums_sidebar();return bQ.disable_selection()};fm=new Ajax.InPlaceEditor(fp,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:j,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:ft,onFailure:function(){},savingText:eA("Creating..."),onLeaveEditMode:bQ.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:fr,job:fs,job_user:cM.get_viewer().photos_user,progress_text:eA("Creating album...")},callback:function(fv,fx){var fw;ah.success(eA("Creating album..."));fw={collection_name:fx,item_counters:JSON.stringify(fn),source_collection_gid:bQ.get_current_collection_gid()};return fw}});fm.enterEditMode();if(!j){return fm._controls.editor.observe("blur",ft)}},toggle_more_selected_actions:function(i){if(i){Event.extend(i).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eT.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(i){var j;if(i){Event.extend(i).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bQ.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(b1.msie_version_at_most(10)){j=bF("#more-collection-actions-menu");if(!j.parent().is("body")){bF(document.body).append(j.remove())}}return eT.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(i){var j;j=i.memo.collection;if(!j.is_anonymous){this._collections.unshift(j)}this._gid_to_collection[j.gid]=j;this._url_to_collection[j.url]=j;return this.refresh_album_views()},_collection_changed:function(i){this._collections.removeItem(i);this._collections.unshift(i);return this.refresh_album_views()},_collection_photos_added:function(fp){var fo,fn,fm,fq,fr,T,i,j,fs,fl;fo=fp.memo.collection;fs=fp.memo.photos;fq=fp.memo.num_items_added;T=fp.memo.num_photos_added;j=fp.memo.num_videos_added;if(fp.memo.promote_collection&&fq>0){this._collection_changed(fo)}else{this.refresh_album_views()}if(fs===eU.get()){eU.clear()}if(fq<1){fl=c9.categorize_files(fs),fr=fl[0],i=fl[1];if(fr&&i){fm=bd("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fs.length)}else{if(fr){fm=bd("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fs.length)}else{fm=bd("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fs.length)}}}else{if(T&&j){fm=bd("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fs.length)}else{if(T){fm=bd("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fs.length)}else{fm=bd("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fs.length)}}}fn=fo.name.escapeHTML();fm=fm.format({collection_name:"<a data-gid='"+fo.gid+"' class='show-collection-target'>"+fn+"</a>"});return ah.success(new fg(fm))},_collection_photos_removed:function(j){var T,fl,i;T=j.memo.collection;fl=j.memo.photos;i=bQ.undo_enabled?j.memo.undo_changeset:null;bQ.get_timeline().remove_photos(fl);this._collection_changed(T);return ah.success(eA("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:c9.file_desc(fl),collection_name:T.name}),null,null,i,(function(){return T.undo_remove(i)}))},_collection_undid_remove:function(i){var j;j=i.memo.collection;bQ.get_timeline().restore_removed_photos();cJ.refresh_album_views([j.gid]);return ah.success(eA("Undo complete"))},_collection_renamed:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-title").text(bU.em_snippet(T.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=T.name+" - Dropbox"}this._collection_changed(T);return ah.success(eA("Renamed '%(collection_name)s'").format({collection_name:T.name}))},_collection_deleted:function(j){var T,i;T=j.memo.collection;this._collections.removeItem(T);if(!this._all_collections_loaded){this._removed_pre_load.push(T.gid)}this.refresh_album_views();if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bQ.show_all_collections()}delete this._gid_to_collection[T.gid];delete this._url_to_collection[T.url];return ah.success(eA("Deleted '%(collection_name)s'").format({collection_name:T.name}))},_collection_shared:function(j){var T,i;T=j.memo.collection;this._collection_changed(T);if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text(eA("Shared"));return bF("#single-collection-share-status").attr("href",T.shmodel_url)}},_collection_unshared:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text("")}return ah.success(eA("Unshared '%(collection_name)s'").format({collection_name:T.name}))},_collection_cover_changed:function(i){var T,j;T=i.memo.collection;this._collection_changed(T);j=eA("Changed cover photo for '%(collection_name)s'");j=j.format({collection_name:T.name.escapeHTML()});return ah.success(j)},_albums_list_item_contextmenu:function(j,i){bn.show_photo_collection(j,this.get(i.readAttribute("data-gid")),i);i.removeClassName("album-flash");return i.addClassName("context-selected")},_show_collection_click:function(T,i){var j;j=$(T.target);if(j.hasClassName("inplaceeditor-form")||(j.up(".inplaceeditor-form")!=null)){return}return bQ.show_collection(i.readAttribute("data-gid"))},_collection_shmodel_click:function(j,i){return this.go_to_link(this.get(i.readAttribute("data-gid")))},_add_to_album_click:function(j,i){if(eU._context_selected){this.add_photos(this.get(i.readAttribute("data-gid")),eU._context_selected);eU._context_selected=null}else{this.add_photos(this.get(i.readAttribute("data-gid")),eU.get())}delete fb.onHide;fb.hide();return g.log_interaction(el.ADD_TO_RECENT_ALBUM,dc.SAH,{num_photos:eU.get().length})},_drop_target_mouseover:function(j,i){if(eU._drag_drop.active){i.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(j,i){if(eU._drag_drop.active){i.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(j,i){var T;if(i.hasClassName("hovered")){i.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eU._drag_drop.single_photo!=null){T=[eU._drag_drop.single_photo]}else{T=eU.get()}if(i.readAttribute("data-gid")!=null){this.add_photos(this.get(i.readAttribute("data-gid")),T,false)}if(i.identify()==="add-to-album-sidebar-new"){return g.log_interaction(el.ADD_TO_NEW_ALBUM,dc.DROP_TARGET,{num_photos:eU.get().length})}else{if(i.identify()==="all-albums-sidebar"){return g.log_interaction(el.ADD_TO_OTHER_ALBUM,dc.DROP_TARGET,{num_photos:eU.get().length})}else{return g.log_interaction(el.ADD_TO_RECENT_ALBUM,dc.DROP_TARGET,{num_photos:eU.get().length})}}}},_create_album_click:function(i,j){if(eU._context_selected){this.create(i,j.down(".collection-name"),eU._context_selected,true);return eU._context_selected=null}else{return this.create(i,j.down(".collection-name"),eU.get(),true)}},_window_scroll:function(){if(bQ.in_all_collections_view()){return this._all_albums_scroll_position=C.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(i){return this._url_to_collection[i]},get:function(i){return this._gid_to_collection[i]},go_to_link:function(i){return window.open(i.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(T,j){var i,fm,fl;i=bU.em_snippet(T,j,1);fm=i.lastIndexOf(" ");if(fm===-1){return i}else{i=i.slice(0,+fm+1||9000000000);fl=bU.em_snippet(T.slice(fm+1),j,1);return i+fl}},get_default_album_name:function(){var i;i=eA("Untitled album");return this.increment_collection_name_until_valid(i)},collection_name_in_use:function(fl){var fn,T,i,fm;fm=this.get_all();for(T=0,i=fm.length;T<i;T++){fn=fm[T];if(fn.name===fl.trim()){return true}}return false},increment_collection_name_until_valid:function(j){var T,i;T=this.collection_name_in_use(j);i=0;while(T){i++;T=this.collection_name_in_use(j+(" ("+i+")"))}return(i===0?j:j+(" ("+i+")"))},flash_sidebar_album:function(fn){var fo,T,i,fm,fl;fm=$$(".sidebar-album");fl=[];for(T=0,i=fm.length;T<i;T++){fo=fm[T];if(fo.readAttribute("data-gid")===fn){fo.removeClassName("album-flash");fo.addClassName("album-flash");break}else{fl.push(void 0)}}return fl}};var ck;ck=E.PhotoTimeline=(function(){i.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";i.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";i.prototype.THUMB_SIZE=null;i.prototype.HEADER_HEIGHT=null;i.prototype.THUMBS_PER_ROW=4;i.prototype.RENDER_SCROLL_WAIT=100;i.prototype.RENDER_SCROLL_MAX_WAIT=750;i.prototype.HIDE_TIMELINE_NAV_DELAY=1500;i.prototype.THUMBS_BATCH_SIZE=12;i.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;i.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;i.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;i.prototype.TIMELINE_NAV_ELM_HEIGHT=20;i.prototype.TIMELINE_DOT_HTML=cx.html("web","timeline_dot");i.container;i.scroll_container;i.events;i.current_event;i.key_to_photo;i.preview_objs;i.tmpl;i.last_render_scroll_timeout;i.start_render_scroll_time;i.last_scroll_position;i.hide_timeline_nav_timeout;i.grid;i._skip_scroll_update;i.header_id_to_sel_items;i.event_remove_info;i.opts;function i(T,fl,fo,fm,fn,fp,fq,fr,j){this.container=T;this.scroll_container=fl;this.tmpl=fq;this.opts=j;this.THUMB_SIZE=fr.thumb_size;this.HEADER_HEIGHT=fr.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fp;this.event_remove_info=[];this._init_events(fo,fm,fn);this.update_offsets(fr.top_offset,fr.left_offset);this.listen();dA.start_capture(this.scroll_container)}i.prototype._init_events=function(fs,fm,fo){var fl,fq,fv,fn,fp,fr,ft,fu,T;if(fs.length<1){this.events=new a0([],{});return}fq=[];fp={};fv=false;for(fr=0,ft=fs.length;fr<ft;fr++){fn=fs[fr];fn=String(fn);T=fn in this.header_id_to_sel_items?this.header_id_to_sel_items[fn]:[];fu=false;if(T.length&&!fv){fv=true;fu=true}fl=new dd(this,fn,fm[fn],fo[fn],T,fu);fq.push(fn);fp[fn]=fl}return this.events=new a0(fq,fp)};i.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(dd.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};i.prototype.unlisten=function(){var fl,T,j;if((fl=this._body_mousemove_handler)!=null){fl.stop()}if((T=this._timeline_elm_click_handler)!=null){T.stop()}if((j=this._show_missing_timestamp_bucket_handler)!=null){j.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(dd.EVENT_MISCOUNT_EVT)};i.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};i.prototype.update_offsets=function(fl,T){var fo,fm,fp,fn;cL(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=fl;this.refresh_row_offsets();this.left_offset=T;this.grid.photo_col_offsets=[];fn=[];for(fo=fm=0,fp=this.THUMBS_PER_ROW;0<=fp?fm<=fp:fm>=fp;fo=0<=fp?++fm:--fm){fn.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fo))}return fn};i.prototype.refresh_row_offsets=function(){var fr,fq,fo,fn,fm,T,fp,fl;this.grid.photo_row_offsets=[];fr=this.top_offset;fp=this.events.getValues();for(fn=0,T=fp.length;fn<T;fn++){fq=fp[fn];fq.top_offset=fr;fr+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(fr);for(fo=fm=0,fl=fq.get_num_rows();0<=fl?fm<fl:fm>fl;fo=0<=fl?++fm:--fm){fr+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(fr)}}};i.prototype._render_empty_grid=function(){var fn,fl,T,fo,fm;this.container.__date();fm=this.events.getValues();for(fl=0,T=fm.length;fl<T;fl++){fn=fm[fl];if(!(fn.is_missing_timestamp_bucket()&&this.events.length()>1)){fn.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fo=bF('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(eA("Show photos with missing dates"));return bF(this.container).append(fo)}};i.prototype._render_viewport=function(fl){var T,fx,fn,fs,fq,fo,ft,fv,fr,fp,fm,fw,fu,fy;if(fl==null){fl=false}this.start_render_scroll_time=-1;fy=this.get_viewport_info();fx=[];fm=this.events.getValues();for(fs=0,fv=fm.length;fs<fv;fs++){T=fm[fs];if(!(T.has_loaded_metadata()||T.loading_metadata||(T.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(T.in_current_viewport(fy,false)){fx.unshift(T)}else{if(T.in_current_viewport(fy,true)){fx.push(T)}}}}for(fq=0,fr=fx.length;fq<fr;fq++){T=fx[fq];fw=T.get_photo_range_to_render(fy,true),fn=fw[0],ft=fw[1];T.load_metadata_range(fn,ft)}if(fl){fy=this.get_viewport_info();fu=this.events.getValues();for(fo=0,fp=fu.length;fo<fp;fo++){T=fu[fo];if(T.in_current_viewport(fy,false)){T.timing_stopped_scrolling_on_event=b6.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};i.prototype._load_metadata_for_sel_events=function(){var fm,fn,fl,T,j;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fl=this.header_id_to_sel_items;T=[];for(fn in fl){j=fl[fn];fm=this.events.valueFromKey(fn);if(fm!=null){fm.load_metadata()}T.push(cL(fm!=null,"Missing "+fn+" in list of events with selected photos"))}return T};i.prototype._load_visible_photos=function(){var fo,fl,T,fn,fm;fn=this.events.getValues();fm=[];for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];if(!(fo.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){fm.push(fo.update_photo_divs())}else{fm.push(void 0)}}return fm};i.prototype._body_mousemove=function(j){if(!this.opts.uses_timeline_nav){return}if((j.clientX+C.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};i.prototype._timeline_elm_click=function(fm,fl){var j,T;T=fl.readAttribute("data-event-id");if(T){j=this.events.valueFromKey(T)}this._update_timeline_position(j);if(j.is_missing_timestamp_bucket()){g.log_interaction(cn.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(j)};i.prototype._scroll_to_event=function(fl,j){var T;if(j==null){j=false}T=fl.top_offset-this.top_offset;if(fl&&(C.scroll_offsets().top!==T)){if(j){return bF("html, body").animate({scrollTop:T},200)}else{this._skip_scroll_update=true;return window.scrollTo(C.scroll_offsets().left,T)}}};i.prototype._window_scroll=function(){var fp,fm,T,fl,fo,fn,fq;fl=b6.time();bs.clear_all_pending_batches();if(this.start_render_scroll_time===-1||fl-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=fl}fq=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fq);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(j){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=C.scroll_offsets().top;bQ.scroll_count++;fo=this.events.getValues();fn=[];for(fm=0,T=fo.length;fm<T;fm++){fp=fo[fm];fn.push(fp.logged_thumbs_arrived=false)}return fn};i.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};i.prototype.init_timeline_nav=function(){var fn,fl,T,fm;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();fm=this.events.getValues().reverse();for(fl=0,T=fm.length;fl<T;fl++){fn=fm[fl];fn.add_to_timeline_nav(fn===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};i.prototype._resize_timeline_nav=function(){var j;if(!this.opts.uses_timeline_nav){return}j=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:j+"px"})};i.prototype._update_timeline_position=function(fp){var fu,fs,T,fn,fm,fq,fo,fl,fr,ft;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fp==null){ft=this.get_viewport_info();if(this.scroll_container==null){ft.top=document.viewport.getScrollOffsets().top}fu=ft.top+ft.height/2;fl=this.events.getValues();for(fn=0,fq=fl.length;fn<fq;fn++){T=fl[fn];if(T.top_offset>fu){break}fp=T}}if((fp==null)||fp===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");fr=$$(".timeline-elm");for(fm=0,fo=fr.length;fm<fo;fm++){fs=fr[fm];if(fs.readAttribute("data-event-id")===fp.unique_id){fs.addClassName("current");break}}return this.current_event=fp};i.prototype._show_hide_timeline_elms=function(){var fr,fq,fm,fl,T,fp,fo,fn;if(!this.opts.uses_timeline_nav){return}fm=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fq=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fo=$$(".timeline-elm");fn=[];for(fl=0,T=fo.length;fl<T;fl++){fr=fo[fl];fr.show();fp=fr.cumulativeOffset();if(fp.top<fq&&fp.left<fm){fn.push(fr.hide())}else{fn.push(void 0)}}return fn};i.prototype._event_miscount=function(j){this.refresh_row_offsets();return this._load_visible_photos()};i.prototype.remove_photos=function(fr){var fo,fp,fq,fn,T,fm,fl;fr=fr.slice(0);this.event_remove_info=[];fq={};for(fn=0,T=fr.length;fn<T;fn++){fm=fr[fn];fp=fm.event.unique_id;if(fp in fq){fq[fp].push(fm)}else{fq[fp]=[fm]}}for(fp in fq){fr=fq[fp];fo=this.events.valueFromKey(fp);fl=fo.remove_photos(fr);this.event_remove_info.push({event:fo,remove_info:fl})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_REMOVED_EVT,this)};i.prototype.restore_removed_photos=function(){var T,fz,fw,fq,fp,fn,ft,fr,fo,fy,fm,fu,fs,fx,fl,fv;eU.clear();fm=this.event_remove_info.reverse();for(fq=0,ft=fm.length;fq<ft;fq++){fz=fm[fq];T=fz.event;fx=fz.remove_info;if(fx.removed_event_index!=null){this.events.insertAtIndex(fx.removed_event_index,T.unique_id,T);T.restore()}T.add_photos(fx.removed_photos_and_indexes.reverse());fu=fx.removed_photos_and_indexes;for(fp=0,fr=fu.length;fp<fr;fp++){fy=fu[fp];eU._add(fy.photo)}}fl=null;fv=null;fs=this.event_remove_info;for(fn=0,fo=fs.length;fn<fo;fn++){fz=fs[fn];T=fz.event;fx=fz.remove_info;fw=this.events.indexOfKey(T.unique_id);if((fl==null)||fl>fw){fl=fw;fv=fx.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fv!=null){this.scroll_to_photo_with_key(fv.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_ADDED_EVT,this)};i.prototype.get_photos=function(){var fn,fl,T,fo,fm;fo=[];fm=this.events.getValues();for(fl=0,T=fm.length;fl<T;fl++){fn=fm[fl];fo=fo.concat(fn.photos)}return fo};i.prototype.num_photos=function(){var fo,fl,T,fm,fn;fm=0;fn=this.events.getValues();for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];fm+=fo.photos.length}return fm};i.prototype.get_preview_objs=function(){var T,fo,fn,fq,fp,fl,fr,fm,fs;fr=[];fm=this.events.getValues();for(fo=0,fq=fm.length;fo<fq;fo++){T=fm[fo];fs=T.photos;for(fn=0,fp=fs.length;fn<fp;fn++){fl=fs[fn];fr.push(fl.preview_obj)}}return fr};i.prototype.index_of_photo=function(fn){var fp,fm,fl,T,fo;fm=0;fo=this.events.getValues();for(fl=0,T=fo.length;fl<T;fl++){fp=fo[fl];if(fp===fn.event){fm+=fp.photos.indexOf(fn);break}else{fm+=fp.photos.length}}return fm};i.prototype.photo_at_index=function(fn){var fl,fp,fm,T,fo;fl=0;fo=this.events.getValues();for(fm=0,T=fo.length;fm<T;fm++){fp=fo[fm];if(fl+fp.photos.length>fn){return fp.photos[fn-fl]}else{fl+=fp.photos.length}}return null};i.prototype.get_thumb_elm_for_photo=function(j){return $(j.uniqueness_key)};i.prototype.get_photo_for_thumb_elm=function(j){if(!j.hasClassName("cu-thumb")){j=j.up(".cu-thumb")}if(j){return this.key_to_photo[j.identify()]}else{return null}};i.prototype.get_viewport_info=function(){var j,T;if(this.scroll_container!=null){T=this.scroll_container.scrollTop;j=this.scroll_container.getHeight()}else{T=C.scroll_offsets().top;j=C.viewport_dimensions().height}return{top:T,height:j,bottom:T+j}};i.prototype.scroll_to_photo_with_key=function(T){var fo,fl,j,fn,fm;C.scroll_unlock_document();fo=$(T);if(fo!=null?fo.visible():void 0){d6.scroll_to_thumb(fo)}else{j=this.key_to_photo[T];fl=j.event;if(j.event!=null){fn=Math.floor(fl.photos.indexOf(j)/this.THUMBS_PER_ROW);fm=this.get_viewport_info().height;C.scroll_to(0,fl.top_offset+this.HEADER_HEIGHT+fn*this.THUMB_SIZE-fm/2)}}return this._load_visible_photos()};i.prototype.restore_scroll_position=function(){C.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};i.prototype.visible_thumbs_loaded=function(){var fn,fl,T,fm;fm=this.events.getValues();for(fl=0,T=fm.length;fl<T;fl++){fn=fm[fl];if(!fn.visible_thumbs_loaded()){return false}}return true};i.prototype.has_missing_timestamp_bucket=function(){var j;j=this.events.getValues();return j[j.length-1].is_missing_timestamp_bucket()};i.prototype.is_missing_timestamp_bucket_shown=function(){var j,T;if(!this.has_missing_timestamp_bucket()){return false}j=this.events.getValues();T=j[j.length-1].unique_id;return bF("#p-"+T).length>0};i.prototype._show_missing_timestamp_bucket=function(j,fm){var fl,T;if(j==null){j=true}if(fm==null){fm=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}T=this.events.getValues();fl=T[T.length-1];bF("#show-missing-timestamps-button").hide();fl.add_html_elements_to(this.container);if(!fm){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(fl,j);this._render_viewport()}return this.init_timeline_nav()};return i})();var dd;dd=E.PhotoEvent=(function(){i.EVENT_MISCOUNT_EVT="db:photoevent:miscount";i.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";i.prototype.MONTH_PREFIX="m_";i.prototype.COLLECTION_PREFIX="c_";i.prototype.EVENT_PREFIX="e_";i.prototype.MISSING_TIMESTAMP_PREFIX="a_";i.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;i.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;i.timeline;i.unique_id;i.name;i.init_num_photos;i.photos;i.header_html;i.placeholder_html;i.top_offset;i.loading_metadata;i.cursor;i.num_photos_loaded;i.prototype.LOADING_ORDER_NOT_DECIDED=-1;i.prototype.LOADING_ORDER_TOP_DOWN=0;i.prototype.LOADING_ORDER_BOTTOM_UP=1;i.loading_order;i.num_photos_to_load;i.on_load_all_metadata;i.init_sel_items;i.scroll_to_first_sel;i.num_to_select;i.logged_thumbs_arrived;i.timing_metadata_received;i.timing_stopped_scrolling_on_event;i.scroll_count;function i(fs,fq,fl,fr,T,fp){var fn,ft,fm,fo;this.timeline=fs;this.unique_id=fq;this.name=fl;this.init_num_photos=fr;this.photos=(function(){var fu,fw,fv;fv=[];for(fn=fu=0,fw=fr;0<=fw?fu<fw:fu>fw;fn=0<=fw?++fu:--fu){fv.push(new K(this))}return fv}).call(this);this.init_sel_items={};for(fm=0,fo=T.length;fm<fo;fm++){ft=T[fm];this.init_sel_items[ft]=true}this.num_to_select=T.length;this.scroll_to_first_sel=fp;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(fr===0){$("single-album-empty").show()}}i.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};i.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};i.prototype.get_month=function(){var j;cL(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(6,8),10);cL(!isNaN(j),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.get_year=function(){var j;cL(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(2,6),10);cL(!isNaN(j),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};i.prototype.get_collection_gid=function(){cL(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};i.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};i.prototype._generate_container_html=function(){var fm,T,fn,fp,fl,j,fo;fp=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fp);fm=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fm.__date(cx.html("web","event_add_to_album"));this.header_html.__sert(fm);fo=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fo.__date(cx.html("web","event_share"));this.header_html.__sert(fo);j=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});j.__date(cx.html("web","event_select"));this.header_html.__sert(j)}else{this.header_html=new fg("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fp+"</span></h1>")}T=this.get_content_height();fl=this.photos.length%this.timeline.THUMBS_PER_ROW;fn=fl===0?0:(this.timeline.THUMBS_PER_ROW-fl)*this.timeline.THUMB_SIZE;return this.placeholder_html=new fg('<div style="height: '+T+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+T+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+fn+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};i.prototype.add_html_elements_to=function(T){var j;if(this.is_event()){j=new Element("div",{"class":"photo-event"});j.__sert(this.header_html);j.__sert(this.placeholder_html);return T.__sert(j)}else{T.__sert(this.header_html);return T.__sert(this.placeholder_html)}};i.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};i.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};i.prototype.add_to_timeline_nav=function(fq){var j,fo,fr,T,fs,fn,fm,fp,fl;if(fq==null){fq=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}fl=this.timeline.get_viewport_info().height;fs=this.timeline.TIMELINE_NAV_ELM_HEIGHT;fn=$(document.body).getHeight();fm=this.top_offset/fn*100;if(this.is_event()){T=this.name}else{if(this.is_missing_timestamp_bucket()){T=eA("Missing dates")}else{T=b6.month_abbr_with_year(this.get_month()-1,this.get_year())}}fr=false;for(fp in this.timeline.grid.side_nav){j=Math.abs(this.timeline.events.valueFromKey(fp).top_offset-this.top_offset);if(j/fn*fl<fs){fr=true;if(fq){bF("#timeline-nav-"+fp).remove()}}}fo=bF("#timeline-nav-"+this.unique_id);if(!fr||fq){if(fo.length){fo.css("top",fm+"%")}else{fo=bF("<div/>");fo.addClass("timeline-elm");fo.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fo.css("top",fm+"%");fo.text(T);bF("#timeline-nav").append(fo)}return this.timeline.grid.side_nav[this.unique_id]=fm}else{if(fo.length){return fo.remove()}}};i.prototype.marquee_highlight=function(fl,fs,fp){var fm,ft,fr,fq,fu,T,fo,fw,fv,fx,fn;if(this.top_offset>fs||this.top_offset+this.get_height()<fl){return}if(fl<this.top_offset){fs-=this.top_offset;if(fs<this.timeline.HEADER_HEIGHT){return}fn=0;fx=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fs>this.top_offset+this.get_height()){fl-=this.top_offset;fx=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(fl<this.timeline.HEADER_HEIGHT){fn=0}else{fn=Math.floor((fl-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{fl-=this.top_offset;fs-=this.top_offset;if(fl<this.timeline.HEADER_HEIGHT&&fs<this.timeline.HEADER_HEIGHT){return}else{if(fl<this.timeline.HEADER_HEIGHT){fn=0;fx=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{fn=Math.floor((fl-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fx=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fv=fr=fo=fn,fw=fx;fo<=fw?fr<=fw:fr>=fw;fv=fo<=fw?++fr:--fr){for(fq=0,fu=fp.length;fq<fu;fq++){fm=fp[fq];ft=this.timeline.THUMBS_PER_ROW*fv+fm;if(ft<this.photos.length){T=this.photos[ft];if(T.status!==K.PLACEHOLDER&&!eU.contains(T)){eU._highlight(T)}}}}};i.prototype.add_photos=function(fo){var fn,fm,T,fl,fp;for(fm=0,T=fo.length;fm<T;fm++){fp=fo[fm];fl=fp.photo;fn=fp.index;cL(fn<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(fn,0,fl);if(fl.status>=K.LOADED){fl.status=K.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};i.prototype.remove_photos=function(fs){var fq,fn,fp,fl,fo,fm,fr,T;fq=this.timeline.events.indexOfKey(this.unique_id);T=[];for(fn=0,fp=fs.length;fn<fp;fn++){fl=fs[fn];fo=this.photos.indexOf(fl);cL(fo>-1,"Photo not found in the photos array!");this.photos.splice(fo,1);if(fl.status>=K.LOADED){this.num_photos_loaded--;if((fm=$(fl.uniqueness_key))!=null){fm.remove()}fl.status=K.LOADED}eU._remove(fl);T.push({photo:fl,index:fo})}this._num_photos_changed();fr={removed_photos_and_indexes:T};if(this.photos.length===0){fr.removed_event_index=fq}return fr};i.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};i.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};i.prototype._update_placeholder_container=function(){var T,j;$("p-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});j=this.photos.length%this.timeline.THUMBS_PER_ROW;T=j!==0?(this.timeline.THUMBS_PER_ROW-j)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:T+"px"})};i.prototype.load_metadata=function(fq){var fl,T,fp,j,fn,fo,fm;j=0;if((!this._is_valid_photo_index(fq))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}j=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fq*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}j=this._is_loading_from_bottom()?this.photos.length-fq:fq+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,j);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;fn={show_hidden:bQ.show_hidden};if(this.cursor!=null){fn.cursor=this.cursor}if(this._is_loading_from_bottom()){fn.chron_order=true}fn.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(fn.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){fn.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fo=this.unique_id.split("_");fl=fo[2];T=fo[1];fn.filters=JSON.stringify({date_begin:fl,date_end:T},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){fn.filters=JSON.stringify({other:true})}else{if(this.is_month()){fm=this.get_year();fp=this.get_month();fl=d6.to_iso8601_date(new Date(fm,fp-1,1,0,0,0,0),false,true);T=d6.to_iso8601_date(new Date(fm,fp,1,0,0,0),false,true);fn.filters=JSON.stringify({date_begin:fl,date_end:T},{year:fm,month:fp})}else{if(this.is_collection()){fn.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cL(false,"invalid photo event id: "+this.unique_id)}}}}return new cE.WebRequest({url:"/photos_event_metadata",data:fn,dataType:"json",success:(function(fr){return function(fs){fr.timing_metadata_received=b6.time();fr.cursor=fs.cursor;return fr._load_metadata_callback(fs.photos,fs.key_to_duplicates,(fs.more!=null)&&fs.more)}})(this)})};i.prototype.load_metadata_range=function(T,j){if(!(this._is_valid_photo_index(T)&&this._is_valid_photo_index(j))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=T*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(T)}else{return this.load_metadata(j)}};i.prototype.load_cached_metadata=function(){var j,T;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((T=bQ.event_metadata_cache)!=null?T[this.unique_id]:void 0)==null)){return false}j=bQ.event_metadata_cache[this.unique_id];this.cursor=j.cursor;this._load_metadata_callback(j.photos,j.key_to_duplicates,j.more);return true};i.prototype._load_metadata_callback=function(fx,fn,fo){var fw,fp,fv,fu,fB,fy,fr,fq,fC,T,fs,fA,fm,fz,fl,ft;fq=[];fm=[];ft=false;for(fw=fv=0,fy=fx.length;fv<fy;fw=++fv){fs=fx[fw];if(this.has_loaded_metadata()){T=new K(this);if(this._is_loading_from_bottom()){this.photos.unshift(T)}else{this.photos.push(T)}ft=true}else{if(this.num_photos_loaded<this.photos.length){fp=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;T=this.photos[fp]}else{cL(false,"num_photos_loaded should never be greater than photos.length")}}T.init_metadata(fs);if(T.uniqueness_key in fn){T.set_duplicates(fn[T.uniqueness_key])}if(fw<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fm.push(T.preview_obj)}fq.push(T)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var j,fD,fF,fE;fE=[];for(j=0,fD=fm.length;j<fD;j++){fF=fm[j];fE.push(fF.preload())}return fE}),500)}eU.refresh(fq);for(fu=0,fr=fq.length;fu<fr;fu++){T=fq[fu];if(T.item_counter in this.init_sel_items){eU._add(T);this.num_to_select--;if(this.num_to_select===0){eU.dec_num_loading_events_before_select()}delete this.init_sel_items[T.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fl=this.timeline;fB=T.uniqueness_key;bF(document).ready(function(){return fl.scroll_to_photo_with_key(fB)})}}}if(!fo){if(this.num_photos_loaded<this.photos.length){fC=this.photos.length-this.num_photos_loaded;fz=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fz,fC);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(ft||fC){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(i.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fA=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fA)}};i.prototype._fix_photo_miscount=function(){var fl,T,j;fl=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);T=this.get_num_rows()-fl;if(typeof g!=="undefined"&&g!==null){g.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}j=C.scroll_offsets().top;if(this.top_offset+this.get_height()<j){C.scroll_to(0,j+T*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(i.EVENT_MISCOUNT_EVT,this)};i.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};i.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};i.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};i.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};i.prototype.visible_thumbs_loaded=function(fs){var fm,fn,fp,T,fo,fl,fr,fq;if(fs==null){fs=this.timeline.get_viewport_info()}fl=this.get_photo_range_to_render(fs,false),fm=fl[0],fp=fl[1];if(fm===null&&fp===null){return true}for(fo=fn=fr=fm,fq=fp;fr<=fq?fn<=fq:fn>=fq;fo=fr<=fq?++fn:--fn){T=this.photos[fo];if((T==null)||!(T.status>=K.RENDERED)){return false}}return true};i.prototype._is_loaded=function(j){var T,fl;if(this._is_loading_from_bottom()){fl=this.photos.length-this.num_photos_loaded;T=this.photos.length-1}else{fl=0;T=this.num_photos_loaded-1}return(fl<=j&&j<=T)};i.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};i.prototype._is_valid_photo_index=function(j){return(j!=null)&&(j>=0)&&(j<=this.photos.length-1)};i.prototype.update_photo_divs=function(){var fl,T,fs,fJ,fI,fH,fr,fK,fw,fF,fE,fv,fG,ft,fp,fn,fu,fC,fB,fA,fz,fy,fD,fo,fm,fL,fq,fx;if(!this.num_photos_loaded){return}fx=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fx)){return}fu=this.get_photo_range_to_render(fx),fs=fu[0],fr=fu[1];cL((fs!=null)&&(fr!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fs))||(!this._is_loaded(fr)))){this.load_metadata_range(fs,fr);if(this._is_loading_from_bottom()){fs=Math.max(fs,this.photos.length-this.num_photos_loaded)}else{fr=Math.min(fr,this.num_photos_loaded-1)}if(fs>fr){return}}fG=Math.floor(fs/this.timeline.THUMBS_PER_ROW);fq=fG*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fq+"px"});fv=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fr/this.timeline.THUMBS_PER_ROW);T=fv*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:T+"px"});this._hide_photos((function(){fD=[];for(var fM=0;0<=fs?fM<fs:fM>fs;0<=fs?fM++:fM--){fD.push(fM)}return fD}).apply(this));this._hide_photos((function(){fo=[];for(var fM=fC=fr+1,j=this.photos.length;fC<=j?fM<j:fM>j;fC<=j?fM++:fM--){fo.push(fM)}return fo}).apply(this));this._show_photos((function(){fm=[];for(var j=fs;fs<=fr?j<=fr:j>=fr;fs<=fr?j++:j--){fm.push(j)}return fm}).apply(this));fA=eU.get();for(fF=0,fK=fA.length;fF<fK;fF++){fp=fA[fF];if((fz=$(fp.uniqueness_key))!=null){fz.addClassName("selected")}}this.scroll_count=bQ.scroll_count;fl=[];fy=this.get_thumb_indexes_to_load(fx);for(fE=0,fw=fy.length;fE<fw;fE++){fn=fy[fE];fp=this.photos[fn];if((fp!=null)&&fp.status>=K.RENDERED){fL=$(fp.uniqueness_key);if((fL!=null?fL.down("img"):void 0)!=null){fl.push(fL.down("img"))}}}ft=function(j){return j.up(".cu-thumb").addClassName("thumb-loaded")};return bs.batch_load_thumbs(fl,this.timeline.THUMBS_BATCH_SIZE,ft,this.log_thumb_load.bind(this))};i.prototype._hide_photos=function(fo){var fn,fl,T,fm;fm=[];for(fl=0,T=fo.length;fl<T;fl++){fn=fo[fl];fm.push(this._hide_photo(fn))}return fm};i.prototype._hide_photo=function(j){var T;T=this.photos[j];if((T==null)||!(T.status===K.DISPLAYED)){return}$(T.uniqueness_key).hide();return T.status=K.RENDERED};i.prototype._show_photos=function(fA){var fw,fv,fz,fl,fy,ft,fr,fo,fx,fs,fq,fn,fm,fu,fp,T;fl=[];for(ft=0,fx=fA.length;ft<fx;ft++){fv=fA[ft];fy=this._get_photo_insert_info(fv);if(!fy){continue}fz=fy[0],T=fy[1];fp=false;for(fr=0,fs=fl.length;fr<fs;fr++){fw=fl[fr];if(fw.after===fz){fw.photos.push(T);fp=true;break}}if(!fp){fl.push({after:fz,photos:[T]})}}for(fo=0,fq=fl.length;fo<fq;fo++){fw=fl[fo];fw.after.__sert({after:fw.photos})}fu=[];for(fm=0,fn=fA.length;fm<fn;fm++){fv=fA[fm];fu.push(this.photos[fv].status=K.DISPLAYED)}return fu};i.prototype._get_photo_insert_info=function(T){var fo,fl,fn,fm,fr,fq,fp;fm=this.photos[T];if((fm==null)||fm.status===K.DISPLAYED){return}if(fm.status===K.RENDERED){$(fm.uniqueness_key).show()}else{fl=$("p-top-"+this.unique_id);if(T!==0){for(fo=fn=fp=T-1;fp<=0?fn<=0:fn>=0;fo=fp<=0?++fn:--fn){fr=this.photos[fo];if((fr!=null)&&fr.status>=K.RENDERED){fq=$(fr.uniqueness_key);cL(fq!=null,"photo "+fo+" was marked as rendered, but its thumb elm doesn't exist");fl=fq;break}}}return[fl,fm.thumb_html]}};i.prototype.in_y_range=function(T,j){return !(this.top_offset+this.timeline.HEADER_HEIGHT>j||this.top_offset+this.get_height()<T)};i.prototype.in_current_viewport=function(fm,fn){var fl,j,T;if(fm==null){fm=this.timeline.get_viewport_info()}if(fn==null){fn=true}T=fm.top;j=fm.top+fm.height;if(fn){fl=this._blur_range(T,j,fm),T=fl[0],j=fl[1]}return this.in_y_range(T,j)};i.prototype.hide_photos_if_not_in_current_viewport=function(fq){var fo,fn,fm,fp,fl,T;if(!this.in_current_viewport(fq)){if(this._is_loading_from_bottom()){for(fo=fn=fp=this.photos.length-this.num_photos_loaded,fl=this.photos.length;fp<=fl?fn<fl:fn>fl;fo=fp<=fl?++fn:--fn){this._hide_photo(fo)}}else{for(fo=fm=0,T=this.num_photos_loaded;0<=T?fm<T:fm>T;fo=0<=T?++fm:--fm){this._hide_photo(fo)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};i.prototype._blur_range=function(fm,j,fo){var fl,T,fn;if(fo==null){fo=this.timeline.get_viewport_info()}fn=dA.get();if(fn>=0){T=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;fl=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(fn<0){T=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;fl=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fm-=T*fo.height;j+=fl*fo.height;return[fm,j]};i.prototype.get_photo_range_to_render=function(fr,fm){var fp,fl,fo,T,fq,fn,j;if(fm==null){fm=true}j=fr.top;fn=fr.bottom;if(fm){T=this._blur_range(j,fn,fr),j=T[0],fn=T[1]}if(!this.in_y_range(j,fn)){return[null,null]}fq=Math.floor((j-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fp=Math.floor((fn-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fl=Math.min(this.photos.length-1,fq*this.timeline.THUMBS_PER_ROW);fo=Math.min(this.photos.length-1,(fp+1)*this.timeline.THUMBS_PER_ROW-1);cL(!isNaN(fo),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+fr.bottom+" ")+("viewport_data.height="+fr.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fp+" "),true,["photo_event_nan_limit"]);return[Math.max(0,fl),fo]};i.prototype.get_photo_range_to_render_with_blur=function(fn){var j,fp,fl,fo,fm,T;fm=this.get_photo_range_to_render(fn,true),fp=fm[0],fo=fm[1];T=this.get_photo_range_to_render(fn,false),j=T[0],fl=T[1];return[fp,j,fl,fo]};i.prototype.get_thumb_indexes_to_load=function(fs){var fE,fp,fC,fB,fA,fo,fn,fz,fw,fD,ft,fx,fq,fv,fu,fy,fm,fl,T,fr;fq=this.get_photo_range_to_render_with_blur(fs),fp=fq[0],fE=fq[1],fo=fq[2],fn=fq[3];if(fE==null){fw=(function(){fy=[];for(var fF=fp;fp<=fn?fF<=fn:fF>=fn;fp<=fn?fF++:fF--){fy.push(fF)}return fy}).apply(this);if(this.top_offset>fs.bottom){return fw}else{return fw.reverse()}}fx=(function(){fm=[];for(var j=fE;fE<=fo?j<=fo:j>=fo;fE<=fo?j++:j--){fm.push(j)}return fm}).apply(this);fD=[];ft=[];if(fp<fE){fD=(function(){fl=[];for(var j=fv=fE-1;fv<=fp?j<=fp:j>=fp;fv<=fp?j++:j--){fl.push(j)}return fl}).apply(this)}if(fn>fo){ft=(function(){T=[];for(var j=fu=fo+1;fu<=fn?j<=fn:j>=fn;fu<=fn?j++:j--){T.push(j)}return T}).apply(this)}fr=dA.get();if(fr>=0){return fx.concat(ft).concat(fD)}else{return fx.concat(fD).concat(ft)}};i.prototype.log_thumb_load=function(T,fm){var fn,fl,j;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bQ.scroll_count&&!this.logged_thumbs_arrived){if((T+1)%this.timeline.THUMBS_PER_ROW===0||T+1===fm){if(this.visible_thumbs_loaded()){j=this.timeline.get_viewport_info();fn=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<j.bottom&&j.bottom<this.top_offset+this.get_height())||fn){if(bQ.scroll_count<2&&((fl=g.get_current_view())===cn.PHOTOS_VIEW||fl===cn.CAMERA_VIEW)){this.log_timing_event(J.viewport_initial_load);bQ.scroll_count+=2}else{this.log_timing_event(J.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};i.prototype.log_timing_event=function(fm){var j,T,fl,fn;T=b6.time();j={};if(fm===J.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(fl=performance.timing)!=null?fl.navigationStart:void 0:void 0)!=null){fn=b6.time()-performance.timing.navigationStart;j={current_view:g.get_current_view()};eg.log_ajax_transition(fn,fm,j,fm)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fm===J.viewport_loaded){fn=T-this.timing_stopped_scrolling_on_event}return eg.log_ajax_transition(fn,fm,j,fm)};return i})();var K;K=E.Photo=(function(){i.PLACEHOLDER=0;i.LOADED=1;i.RENDERED=2;i.DISPLAYED=3;i.uniqueness_key;i.item_counter;i.filename;i.ns_id;i.ns_path;i.fq_path;i.href;i.thumbnail_url;i.large_thumbnail_url;i.time_taken;i.display_time_taken;i.preview_type;i.mtime;i.video_streaming_url;i.is_visible;i.user_id;i.event;i.status;i.thumb_html;i.preview_obj;i.duplicates_info;function i(j){this.event=j;this.status=i.PLACEHOLDER;this.preview_obj=j.unique_id}i.prototype.init_metadata=function(j){this.uniqueness_key=j.uniqueness_key;this.item_counter=j.item_counter;this.filename=j.filename;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.fq_path=j.path;this.href=j.href;this.thumbnail_url=j.thumbnail_url;this.large_thumbnail_url=j.large_thumbnail_url;this.time_taken=j.time_taken;this.display_time_taken=j.display_time_taken;this.preview_type=j.preview_type;this.mtime=j.mtime;this.video_streaming_url=j.video_streaming_url;this.is_visible=j.is_visible;this.user_id=j.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cx});this.preview_obj=this._get_preview_obj();this.status=i.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};i.prototype.set_duplicates=function(fm){var fl,T,j;for(T=0,j=fm.length;T<j;T++){fl=fm[T];fl.fq_path=fl.path}return this.duplicates_info=fm};i.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bQ.in_single_collection_view()){return new eS({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dt({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bQ.in_single_collection_view()){return new au({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new e2({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};i.prototype._get_display_date=function(){var j;if(this.time_taken!=null){j=new Date(this.time_taken);return b6.nice_date_with_month_name(j,j.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return i})();var ad;ad=E.PhotoCollection=(function(){i.CREATE_EVT="db:photocollection:create";i.ADD_EVT="db:photocollection:add";i.REMOVE_EVT="db:photocollection:remove";i.UNDO_REMOVE_EVT="db:photocollection:undo_remove";i.RENAME_EVT="db:photocollection:rename";i.DELETE_EVT="db:photocollection:delete";i.SHARE_EVT="db:photocollection:share";i.UNSHARE_EVT="db:photocollection:unshare";i.COVER_CHANGE_EVT="db:photocollection:cover_change";i.gid;i.name;i.num_items;i.num_photos;i.num_videos;i.thumbnail_url_32;i.thumbnail_url_256;i.is_anonymous;i.share_tkey;i.shmodel_url;i.short_url;i.is_creator;i.member_fnames;function i(T,j){if(j==null){j=true}cL((T.gid!=null)&&(T.url!=null)&&(T.name!=null)&&(T.num_items!=null)&&(T.num_photos!=null)&&(T.num_videos!=null),"missing required PhotoCollection params");this.gid=T.gid;this.url=T.url;this.name=T.name;this.num_items=T.num_items;this.num_photos=T.num_photos;this.num_videos=T.num_videos;this.thumbnail_url_32=T.thumbnail_url_32||null;this.thumbnail_url_256=T.thumbnail_url_256||null;this.is_anonymous=T.is_anonymous!=null?T.is_anonymous:false;this.share_tkey=T.share_tkey||null;this.shmodel_url=T.shmodel_url||null;this.short_url=T.short_url||null;this.is_creator=T.is_creator!=null?T.is_creator:true;this.member_fnames=T.member_fnames||[eA("You")];if(j){document.fire(i.CREATE_EVT,{collection:this})}}i.prototype.add_photos=function(fp,fo,fl,fn){var j,fm,T;if(fl==null){fl=false}if(fn==null){fn=true}j=(function(){var fs,fq,fr;fr=[];for(fs=0,fq=fp.length;fs<fq;fs++){T=fp[fs];fr.push(T.item_counter)}return fr})();cL(j.length,"Have to add at least one photo");fm={collection_gid:this.gid,item_counters:JSON.stringify(j),source_collection_gid:fo};return new Ajax.DBRequest("/collection_add",{parameters:fm,job:fl,job_user:cM.get_viewer().photos_user,progress_text:eA("Adding to album..."),onSuccess:(function(fq){return function(ft){var fr,fu,fs,fv;fv=JSON.parse(ft.responseText);fq.thumbnail_url_32=fv.thumbnail_url_32;fq.thumbnail_url_256=fv.thumbnail_url_256;fu=fv.new_num_photos-fq.num_photos;fs=fv.new_num_videos-fq.num_videos;fr=fv.new_num_items-fq.num_items;fq.num_photos=fv.new_num_photos;fq.num_videos=fv.new_num_videos;fq.num_items=fv.new_num_items;return document.fire(i.ADD_EVT,{collection:fq,photos:fp,num_items_added:fr,num_photos_added:fu,num_videos_added:fs,promote_collection:fn})}})(this)})};i.prototype.remove_photos=function(fm,fl){var j,T;if(fl==null){fl=false}j=(function(){var fp,fn,fo;fo=[];for(fp=0,fn=fm.length;fp<fn;fp++){T=fm[fp];fo.push(T.item_counter)}return fo})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(j),is_shared:this.share_tkey!=null,num_items:this.num_items},job:fl,job_user:cM.get_viewer().photos_user,progress_text:eA("Removing from album..."),onSuccess:(function(fn){return function(fo){var fp;fp=JSON.parse(fo.responseText);fn.thumbnail_url_32=fp.thumbnail_url_32;fn.thumbnail_url_256=fp.thumbnail_url_256;fn.num_photos=fp.new_num_photos;fn.num_videos=fp.new_num_videos;fn.num_items=fp.new_num_items;return document.fire(i.REMOVE_EVT,{collection:fn,photos:fm,undo_changeset:fp.undo_changeset})}})(this)})};i.prototype.undo_remove=function(j){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:j},html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:(function(T){return function(){return document.fire(i.UNDO_REMOVE_EVT,{collection:T})}})(this)})};i.prototype.rename=function(T){var j;bQ.enable_selection();j=new Ajax.InPlaceEditor(T,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bF("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:eA("Saving..."),onLeaveEditMode:bQ.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(fl){return function(fm){fl.name=fm.responseText;return document.fire(i.RENAME_EVT,{collection:fl})}})(this)},callback:(function(fl){return function(fm,fn){return{collection_gid:fl.gid,new_collection_name:fn,is_shared:fl.share_tkey!=null}}})(this)});return j.enterEditMode()};i.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cM.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cM.get_viewer().photos_user,onSuccess:(function(j){return function(){return document.fire(i.DELETE_EVT,{collection:j})}})(this)})};i.prototype.attach_to_token=function(fl,fn,T,fm,j){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:fl,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fo){return function(){fo.share_tkey=fl;fo.shmodel_url=fn;fo.short_url=T;if(typeof fm==="function"){fm()}return document.fire(i.SHARE_EVT,{collection:fo})}})(this),onFailure:function(){return typeof j==="function"?j():void 0}})};i.prototype.send_link=function(T,fm,fq,fl,fp,j){var fo,fn;fo=(function(fr){return function(){fr.share_tkey=fm;fr.shmodel_url=fq;fr.short_url=fl;if(typeof fp==="function"){fp()}return document.fire(i.SHARE_EVT,{collection:fr})}})(this);fn={collection_gid:this.gid,share_tkey:fm,num_items:this.num_items};return bT.ajax_submit(T,"/collection_share",fo,j,T.down(".tokenizer-submit-button"),fn)};i.prototype.unshare=function(){cL(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(j){return function(){j.share_tkey=null;j.shmodel_url=null;j.short_url=null;return document.fire(i.UNSHARE_EVT,{collection:j})}})(this),subject_user:cM.get_viewer().photos_user})};i.prototype.set_cover=function(j){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:j.item_counter},onSuccess:(function(T){return function(fl){var fm;fm=JSON.parse(fl.responseText);T.thumbnail_url_32=fm.thumbnail_url_32;T.thumbnail_url_256=fm.thumbnail_url_256;return document.fire(i.COVER_CHANGE_EVT,{collection:T})}})(this)})};return i})();var b7,l;b7=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=E.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,pdfLink:null,_pdfLoader:new ax(),init_pdf:function(fn,fm,T,i,fo){var j,fl;this.pdfLink=i;this.iframe_src=fm;this._log_pdf_render_time(fn);if(fn==="pdf-native"||fn==="pdf-embedded"||fn==="pdf-js"){window.addEventListener("message",l,false);bF((function(fp){return function(){var ft,fs,fr,fq;fq=G.parse(fm);ft=bF("#pdf-embed-container");if(ft.attr("data-docpreview-annotation-marker-enabled")==="True"){fq=fq.updateQuery("annotation_marker","1")}if(ft.attr("data-docpreview-annotation-highlight-enabled")==="True"){fq=fq.updateQuery("annotation_highlight","1")}if(ft.attr("data-docpreview-annotation-region-enabled")==="True"){fq=fq.updateQuery("annotation_region","1")}if(fn==="pdf-js"){fr=fq.getQuery();fp._pdfLoader.startListening();fp._pdfLoader.openFile(fr.file,{presentationMode:fo});delete fr.file;fq.setQuery(fr)}fs=bF("#pdf-embed-iframe");fs.attr("src",String(fq));fs.attr("type","application/pdf");fs.attr("allowfullscreen","");fs.addClass("pdfjs");bF("html, body").addClass("full_height");return fp._fire_pdf_render_event()}})(this));this.preview_status=T;if(b1.chrome){fl=function(){var fp;fp=bF('link[rel="shortcut icon"]').remove();return bF("head").append(fp)};setTimeout(fl,1000)}j=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fp){return function(){return j.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(i){window.addEventListener("message",l,false);return bF("#pdf-embed-iframe").attr("src",i)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bF((function(i){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(i){return function(){if(!window.htmlified_height){return i.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var i;if((i=$("htmlified-loading"))!=null){i.remove()}if(bF("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(fm,fo,j,fl,i,T,fn){return bF((function(fp){return function(){var fs,fq,fr;fr=fn.width()*0.9;fq=fr*0.55;fs=fp._video_preview_failed;if(fl==="hls"){fp.player=bt.embed("#video",{src:j,type:"application/vnd.apple.mpegurl",width:fr,height:fq,controls:true,poster:i,onError:fs,onReady:fp._player_ready,metadata_link:T})}else{bF("#video").empty();if(fm){if(fo){fp.player=bt.embed("#video",{src:j,type:"video/mp4",width:fr,height:fq,controls:true,poster:i,onError:fs,onReady:fp._player_ready,metadata_link:T})}else{fs()}}else{fp.player=bt.embed("#video",{src:j,type:"video/flv",width:fr,height:fq,controls:true,poster:i,onError:fs,onReady:fp._player_ready,metadata_link:T})}}bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();fp.player.on("play",fp._onPlay);return fp.player.on("ended",fp._onEnded)}})(this))},photo_loaded:function(T){var j,i;if((j=window.performance)!=null?(i=j.timing)!=null?i.navigationStart:void 0:void 0){T=T-window.performance.timing.navigationStart;return eg.log_ajax_transition(T,"file-preview-photo")}},switch_preview:function(ft,fm,fr,fq,T){var fs,fl,i,fp,fo,fn,j;if(this.iframe_src){i=INLINE_JS.URI.parse(this.iframe_src);j=INLINE_JS.URI.parse(i.getQuery().file);fn=j.updateQuery({revision_id:ft}).toString();fl=G.parse(this.iframe_src).updateQuery({file:fn});if(fm){fl.updateQuery({annotation_marker:"1"});fl.updateQuery({annotation_highlight:"1"});fl.updateQuery({annotation_region:"1"})}else{fl.removeQuery("annotation_marker");fl.removeQuery("annotation_highlight");fl.removeQuery("annotation_region")}fs=bF("#pdf-embed-iframe");fs.attr("src",fl.toString());fs.on("load",fr);return this._fire_pdf_render_event()}else{fo={thumbnailUrl:fq,commentActivity:T};fp={action:"switch-preview",parameters:fo};return window.postMessage(JSON.stringify(fp),"*")}},_player_ready:function(){var i;i=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return i.defer()},_onPlay:function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()},_onEnded:function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()},_video_preview_failed:function(i){if(i==="needflash"){bF("#video-preview-flash-message").show()}return b7.preview_failed()},preview_failed:function(){var i;i=bF(document.body);if(i.hasClass("shmodel-body")){i.removeClass("file-preview-body")}ah.error(eA("Preview failed."));return bF(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var i;if(document.createEvent&&window.dispatchEvent){i=document.createEvent("UIEvents");i.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(i)}},_log_pdf_render_time:function(j){var i;i=function(fn){var fm,T,fl;if((fm=window.performance)!=null?(T=fm.timing)!=null?T.navigationStart:void 0:void 0){fl=b6.time()-window.performance.timing.navigationStart;return eg.log_ajax_transition(fl,fn)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return i(j)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return i(j+"-parse")})}};l=function(fm){var fl,j,T,i,fn;j={"https://dl.dropbox.com":true};j["https://"+fj.DL_DOC_DOMAIN]=true;j["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;j["https://"+Constants.PUBSERVER]=true;j["https://"+Constants.WEB_STATIC_DROPBOX_HOST]=true;if(j[fm.origin]){T={};try{T=JSON.parse(fm.data);fl=T.action}catch(fn){i=fn;fl=fm.data}switch(fl){case"failed":return b7.preview_failed()}}};var aD;aD=E.ClientDownload=(function(){function i(){}i.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(j){var T;T=bF("<div",{"class":"brodal-header",text:eA("Install Dropbox")});return fb.show(T[0],$("client-download"),{},false,450)},subject_user:ct.active_user})};return i})();var cA,el,g,J,a8,dc,cn;cA=E.AlbumsLogger={log_share:function(j,fm,fl,T,i){return cA.log(j,fm,true,fl,T,i)},log_event:function(i,fl,T,j){return cA.log(i,fl,false,T,j)},log:function(j,fo,fl,fn,fm,i){var T;T={evt:j,collection_gid:fo,is_anonymous:fm};if(fl!=null){T.share_event=fl}if(fn!=null){T.num_items=fn}if(i!=null){T.on_create=i}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:T})}};el=INLINE_JS.PhotosEvents=E.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a8=INLINE_JS.PhotosTourEvents=E.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};dc=INLINE_JS.PhotosTriggers=E.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cn=E.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};g=INLINE_JS.PhotosLogger=E.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var i,j,T;i=((j=$("modal"))!=null?j.visible():void 0)&&$("shmodal").visible();T=i?"-foshmodal":"";if(bQ.in_single_collection_view()){return cn.SINGLE_COLLECTION_VIEW+T}else{if(bQ.in_all_collections_view()){return cn.ALBUMS_VIEW+T}else{if(bQ.initialized){return cn.PHOTOS_VIEW+T}else{return cn.NOT_PHOTOS}}}},log_interaction:function(i,j,T){return g.log(i,j,null,g.get_current_view(),T)},log_transition_to:function(i){return g.log(i,null,null,g.get_current_view(),null,true)},log:function(j,T,i,fo,fm,fn){var fl;fl={evt:j,trigger:T,view:i};if(fm!=null){fl.data=JSON.stringify(fm)}if(fo!=null){fl.start_view=fo}if(fn!=null){fl.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:fl})}};J=E.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dK,aQ;aQ=E.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(i){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:i,url:window.location.href}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){aQ.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};dK=E.RegistrationLogger={log:function(i){var j;j=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:i,url:j}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){dK.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};var f;f=E.ModalFlow=(function(){function i(fn,fr,ft,fm,T,fq,fs){var fo,fp,fl,j;this.title=fn;this.icon=fr;this.states=ft;this.next_state_table=fm;this.previous_state_table=T;this.initial=fq;this.onStart=fs;this._state_map={};fl=this.states;for(fo=0,fp=fl.length;fo<fp;fo++){j=fl[fo];this._state_map[j.name]=j}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}i.prototype.start=function(){var T,j,fl,fm;this.vars={};fl=this.states;for(T=0,j=fl.length;T<j;T++){fm=fl[T];fm.next=this._next.bind(this,fm);fm.back=this._back.bind(this,fm);if(fm.onSubmit){fm.onSubmitFn=(function(fn,fo){fn.onSubmit(this,fn,fo);return false}).bind(this,fm)}else{fm.onSubmitFn=((function(fn){return function(fo,fp){fo.next();return false}})(this)).bind(this,fm)}fm.contents.on("submit",fm.onSubmitFn);fm.contents.find(".backbutton").on("click",fm.back)}fb.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};i.prototype.to_state=function(T){var j;this.state=this._state_map[T];j=this.title;if(this.state.title!=null){j=this.state.title}fb.show(j,this.state.contents[0]);return this.state.enter(this)};i.prototype._next=function(j){var T;if(j===this.state){T=this.next_state_table[this.state.name](this);if(T==="__exit__"){return this.exit()}else{return this.to_state(T)}}};i.prototype._back=function(j){var T;if(j===this.state){T=this.previous_state_table[this.state.name](this);if(T==="__cancel__"){return this.exit()}else{if(T){return this.to_state(T)}}}};i.prototype.exit=function(){return this._onExit()};i.prototype._onExit=function(fs){var fp,fn,fq,fo,fl,fm,fr,T;fm=this.states;for(fp=0,fq=fm.length;fp<fq;fp++){T=fm[fp];T.contents.off("submit",T.onSubmitFn)}this._cleanUpExitListeners();fr=this._exit_listeners;for(fn=0,fo=fr.length;fn<fo;fn++){fl=fr[fn];fl(fs)}fb.onHide=null;return fb.hide()};i.prototype.addExitListener=function(j){return this._exit_listeners.push(j)};i.prototype.removeExitListener=function(j){return this._cleanup_queue.push(j)};i.prototype._cleanUpExitListeners=function(){var fo,fm,T,j,fp,fl;fp=this._cleanup_queue;fl=[];for(fm=0,j=fp.length;fm<j;fm++){fo=fp[fm];T=this._exit_listeners.indexOf(fo);fl.push(this._exit_listeners.splice(T,1))}return fl};return i})();var cH;cH=E.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(i){this._user=cM.get_viewer().get_user_by_id(i);cL(this._user,i+" is invalid");return bF("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bF("#resend-link").on("click",this.resend_phone_code.bind(this));return bF("#code").focus()},init:function(j,i){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();d6.async_load_script(j);return d6.async_load_script(i)},account_listen:function(){var fx,T,fv,fs,ft,fr,fo,fw,i,j,fl,fn,fm,fu,fq,fp;fv={name:"delivery_choice",enter:(function(fy){return function(fz){var fA;fy.hide_error();fA=0;bF(".delivery-choice").each(function(){var fB;fB=bF(this).height();return fA=Math.max(fB,fA)});bF(".delivery-choice").height(fA);return bF(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bF("#twofactor-delivery-choice"),onSubmit:(function(fy){return function(fz,fA,fB){fz.vars.sms=!!(bF("#use-sms")[0].getValue()==="on");if(!fz.vars.sms){return fy.fetch_offline_key(fz,fA)}else{return fA.next()}}})(this)};fs={name:"enter_phone_number",enter:(function(fy){return function(fA){var fB,fz;fy.hide_error();fy._is_offline_setup=false;fy._phone_number=null;fB=$("twofactor-enter-phone");fz=fy.fill_phone_number_for_edit(fB,bF("#twofactor-row-"+fy._user.role+" #twofactor-sms-number").text());return fz.focus()}})(this),contents:bF("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};ft={name:"offline_setup",enter:(function(fy){return function(fz){fy.hide_error();fy._is_offline_setup=true;return fy._phone_number=null}})(this),contents:bF("#twofactor-offline-setup")};T={name:"confirm_phone",enter:(function(fy){return function(fz){var fA;fy._invalid_code_count=0;if(fy._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fA=fz.vars.phone_number;cL(fA,"expected a display_phone argument");$("phone-number-placeholder").__date(fA);$("twofactor-enable-confirm").removeClassName("offline")}fy.hide_error();$("phone-code").clear().focus();return fy.fill_delivery_choice(fA)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bF("#twofactor-enable-confirm")};fx={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bF("#twofactor-enter-backup-phone")};fn=new f(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bF("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fy){return function(fz,fA){fy.successfully_enabled=false;fz.vars.mode="ENABLE";fz.vars.passed_password=true;return fA.next()}})(this)),contents:bF("#twofactor-enter-password")},fv,fs,ft,T,fx,{name:"recovery_code",enter:(function(fy){return function(){fy.fill_backup_phone(fy._backup_phone);return fy.hide_error.bind(fy)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:bF("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:eA("Congrats! You've enabled two-step verification!"),contents:bF("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fy){if(fy.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fy){if(fy.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});fn.addExitListener((function(fy){return function(fz){if(fn.vars.passed_password&&fz&&!fy.successfully_enabled){return ah.error(eA("Two-step verification isn\u2019t enabled"))}}})(this));fl=new f(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fy){return function(fA,fB){var fz;fy.successfully_enabled=false;bF(".delivery-choice").removeClass("selected");fz=!bF("#twofactor-row").hasClass("with-sms");bF(fz?"#app-choice":"#sms-choice").addClass("selected");bF("#twofactor-recovery").addClass("edit-mode");fA.vars.passed_password=true;return fB.next()}})(this)),contents:bF("#twofactor-enter-password")},fv,fs,ft,T,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fy){if(fy.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fy){if(fy.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});fl.addExitListener((function(fy){return function(fz){if(fl.vars.passed_password&&fz&&!fy.successfully_enabled){return ah.error(eA("Two-step verification has not been changed"))}}})(this));i=new f(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fy){return function(fz,fA){fy.successfully_disabled=false;fz.vars.passed_password=true;return fA.next()}})(this)),contents:bF("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bF("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});i.addExitListener((function(fy){return function(fz){if(i.vars.passed_password&&fz&&!fy.successfully_disabled){return ah.error(eA("Two-step verification is still enabled"))}}})(this));fr=new f(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fy,fz){return fz.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");j=new f(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fy,fz){return fz.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fu=new f(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fy){return function(fz,fA){return new Ajax.DBRequest(fy.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fy._checkpoint_token,use_json:true},onSuccess:function(fC){var fB,fD;fD=JSON.parse(fC.responseText.strip());if(fD.result==="OK"){fB=fD.codes;fy.fill_recovery_codes(fB,"backup-code-list-edit");return fA.next()}else{switch(fD.result){case"EXPIRED":return fy.show_error_expired();case"ALREADY_DISABLED":bF("#twofactor-row").removeClass("twofactor-enabled");ah.success(eA("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fb.hide()}}},onFailure:fy.show_error500.bind(fy),cleanUp:fy.hide_loading.bind(fy),subject_user:fy._user})}})(this)),contents:bF("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bF("#twofactor-recovery-edit"),onSubmit:(function(fy){return function(fz,fA){fy._checkpoint_token=null;return fA.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fp=(function(fy){return function(fz){return new Ajax.DBRequest(fy.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fy._checkpoint_token,device_response:JSON.stringify(fz)},noAutonotify:true,onSuccess:function(fA){var fB;fB=fA.responseText.strip();fo.to_state("register_success");return bF(document).trigger("security-key-manager:UPDATE_KEYS",fy._user.id)},onFailure:function(fC){var fA,fB;fA=JSON.parse(fC.responseText.substr(4));fB=fA.security_key_register!=null?fA.security_key_register["message_text"]:ah.DEFAULT_ERROR;bF("#twofactor-security-key-register-error #error-msg").text(fB);return fo.to_state("register_error")},cleanUp:fy.hide_loading.bind(fy),subject_user:fy._user})}})(this);fm=(function(fy){return function(fz,fA){return new Ajax.DBRequest(fy.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fy._checkpoint_token},onSuccess:function(fB){var fC;fC=JSON.parse(fB.responseText);u2f.register(fC.registerRequests,fC.authenticateRequests,fp);return fA.next()},onFailure:fy.show_error500.bind(fy),cleanUp:fy.hide_loading.bind(fy),subject_user:fy._user})}})(this);fq=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fw=new f("Confirm password",this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fy){return function(fz,fA){bF(document).trigger("security-key-modal:PASSWORD_CONFIRMED",[fy._user.id,fy._checkpoint_token]);return fb.hide()}})(this)),contents:bF("#twofactor-enter-password")}],{password:function(){return"__exit__"}},{},"password");fo=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fy,fz){return fz.next()}),contents:bF("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-prepare-register"),onSubmit:fm},{name:"register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register-error"),onSubmit:fm},{name:"register_success",enter:(function(fy){return function(){fy.hide_error.bind(fy);return fy._checkpoint_token=null}})(this),onSubmit:function(fy,fz){ah.success(eA("Successfully added security key."));return fz.next()},contents:bF("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();bF(".enable-twofactor").on("click",(function(fy){return function(fz){return fy.start_flow(fz,fn)}})(this));bF(".disable-twofactor").on("click",(function(fy){return function(fz){return fy.start_flow(fz,i)}})(this));bF(".add-twofactor-backup-link").on("click",(function(fy){return function(fz){return fy.start_flow(fz,fr)}})(this));bF(".edit-twofactor-backup").on("click",(function(fy){return function(fz){return fy.start_flow(fz,j)}})(this));bF(".edit-twofactor-recovery").on("click",(function(fy){return function(fz){return fy.start_flow(fz,fu)}})(this));bF(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fy){return function(fz){return fy.start_flow(fz,fl)}})(this));bF(document).on("twofactor:ADD_SECURITY_KEY",(function(fy){return function(fA,fz){if(bF("#twofactor-security-key-unsupported-browser").length){return fy.start_flow(fA,fq,fz)}else{return fy.start_flow(fA,fo,fz)}}})(this));bF(document).on("twofactor:ASK_PASSWORD_CONFIRM",(function(fy){return function(fA,fz){return fy.start_flow(fA,fw,fz)}})(this));bF("#generate-new-recovery-code").on("click",(function(fy){return function(fz){fy.show_loading();return new Ajax.DBRequest(fy.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fy._checkpoint_token,use_json:true},onSuccess:function(fB){var fC,fA;fC=fB.responseText.strip();fA=JSON.parse(fC);if(fA.result==="OK"){return fy.fill_recovery_codes(fA.codes,"backup-code-list-edit")}else{switch(fC){case"EXPIRED":fu.to_state("password");return fy.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eA("Two-step verification is disabled. Did you maybe disable it in another window?"));return fb.hide()}}},onFailure:fy.show_error500.bind(fy),cleanUp:fy.hide_loading.bind(fy),subject_user:fy._user})}})(this));bF("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bF("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bF("#twofactor-delivery-choice input").change(function(){bF(".delivery-choice").removeClass("selected");return bF(this).parents(".delivery-choice").addClass("selected")});bF("#show-qr").on("click",function(fy){bF("#twofactor-offline-setup").addClass("showing-qr");return false});bF("#hide-qr").on("click",function(fy){bF("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&bF("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(fr)}},_bind_phone_input_to_save_button:function(){this.$save_button=bF("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=bF("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));this.$phone_input.on("input",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return bF("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(i){return function(){return i.submit_finish(true,i._current_flow,i._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(i,j){var T;T=bF.trim(i.val())==="";return j.prop("disabled",T)},start_flow:function(T,j,i){if(i==null){i=null}T.preventDefault();delete this._phone_number;if(i==null){i=bF(T.target).data("uid")}cH.set_user(cM.get_viewer().get_user_by_id(i));this._current_flow=j;j.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bF("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(j){var i;if(this.is_resending()){return}this.show_resending();i="/twofactor_resend";if(bF("#twofactor-confirm").hasClass("backup")){i=G.parse(i).updateQuery({backup:true}).toString()}new Ajax.DBRequest(i,{onSuccess:(function(T){return function(fl){switch(fl.responseText.strip()){case"OK":T.hide_error();return T.notify_resent();case"UNREACHABLE":return T.show_error_unreachable(true);case"BADCARRIER":return T.show_error_bad_carrier();case"INVALIDNUMBER":return T.show_error_invalid_number();case"NOTAMOBILE":return T.show_error_not_a_mobile();case"RATELIMIT":return ah.error(eA("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return ah.error(j.error_unreachable(true));case"BADCARRIER":return ah.error(j.error_bad_carrier());case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return ah.error(j.error_not_a_mobile());case"RATELIMIT":return ah.error(eA("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(j){return function(T){return ah.error(j.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return j.show_error_unreachable();case"BADCARRIER":return j.show_error_bad_carrier();case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return j.show_error_not_a_mobile();case"RATELIMIT":return ah.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":j._current_flow.to_state("password");return j.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:eA("Enable two-step verification"),DEFAULT_EDIT_TITLE:eA("Edit two-step verification"),DEFAULT_DISABLE_TITLE:eA("Disable two-step verification"),ADD_BACKUP_TITLE:eA("Add a backup phone number"),EDIT_BACKUP_TITLE:eA("Edit backup phone number"),EDIT_RECOVERY_TITLE:eA("View recovery code"),ADD_SECURITY_KEY_TITLE:eA("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var i;this.hide_error();bF("#twofactor-recovery").removeClass("edit-mode");i=$("twofactor-enter-password");bF("#password",i).val("").focus();return false},submit_password:function(T,fn,i,fl,fm){var j;j=$("password").getValue();if(!j){this.show_error(eA("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(T,{parameters:{password:j},onSuccess:(function(fo){return function(fp){var fq;fq=fp.responseText.strip();if(fq.startsWith("OK:")){fo._checkpoint_token=fq.substr(3);return fn(i,fl)}else{switch(fq){case"EXPIRED_PASSWORD":return fo.show_error_expired_password();case"INVALID":return fo.show_error(eA("Invalid password"));case"RATELIMIT":return fo.show_error(eA("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ah.success(eA("Two-step verification is already enabled. Did you maybe enable it in another window?"));return fb.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eA("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fb.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(T){return function(fl){var fm;fm=fl.responseText.strip();if(fm.startsWith("OK:")){T.fill_key(fm.substr(3));return j.next()}else{switch(fm){case"EXPIRED":i.to_state("password");return T.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(j){var i,fl,T;j=j.replace(new RegExp("=+$"),"");i=j.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(i);$("qr-div").__date();T=Constants.IS_PROD?"Dropbox":"DropboxDev";fl={text:"otpauth://totp/"+T+":"+this._user.email+"?secret="+j+"&issuer="+T,width:200,height:200};if(!Modernizr.canvas){fl.render="table"}bF("#qr-div").qrcode(fl);if(!Modernizr.canvas){return bF("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(j,fl,fm){var i,T;i=bF("#twofactor-enter-phone .twofactor-phone-number");if(!C.controller(i).validate_on_submit()){return}T=i.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:T},onSuccess:(function(fn){return function(fo){switch(fo.responseText.strip()){case"OK":fn._phone_number=T;j.vars.phone_number=T;return fl.next();case"EXPIRED":j.to_state("password");return fn.show_error_expired();case"UNREACHABLE":return fn.show_error_unreachable(i);case"BADCARRIER":return fn.show_error_bad_carrier(i);case"INVALIDNUMBER":return fn.show_error_invalid_number(i);case"NOTAMOBILE":return fn.show_error_not_a_mobile(i);case"RATELIMIT":return fn.show_error(eA("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(i,j,fl){var T;T=$("phone-code").getValue().strip();if(!T){this.show_error(eA("Please enter the security code"));return}if(T.search(/^\d{6}$/)===-1){this.show_error(eA("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:T,use_json:true},onSuccess:(function(fm){return function(fn){var fp,fo;fo=JSON.parse(fn.responseText.strip());if(fo.result==="OK"){fm.fill_recovery_codes(fo.codes,"backup-code-list");return j.next()}else{switch(fo.result){case"INVALID":fm._invalid_code_count+=1;fp=fm._invalid_code_count<=2?eA("Invalid code"):fm._is_offline_setup?eA("Invalid code. Check the clock on your phone: it must be accurate to the minute."):eA("Invalid code");return fm.show_error(fp);case"EXPIRED":i.to_state("password");return fm.show_error_expired();case"RATELIMIT":return fm.show_error(eA("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(fl,j){var T,i;this.hide_error();T=$("twofactor-enter-backup-phone");i=this.fill_phone_number_for_edit(T,bF("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());i.focus();if(fl==="back_next"){bF("#twofactor-backup-back-next").show();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").hide()}else{if(fl==="cancel_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").show();return bF("#twofactor-backup-back-save").hide()}else{if(fl==="back_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fm,fl,j,fn,fo){var i,T;i=bF("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!C.controller(i).validate_on_blur()){return}T=i.val();if(T){if(this.is_primary_number(T)){C.controller(i).show_error(eA("You can't use your primary phone as your backup",i));return}}else{if(fm){C.controller(i).show_error(eA("Please enter phone number",i));return}}this._backup_phone=T;if(fl==="save_backup_phone"){this.save_added_backup_phone(j,fm,T)}else{if(fl==="save_everything"){this.submit_finish(false,j,fn,fo)}else{if(fl==="save_none"){return fn.next()}}}},is_same_phone_number:function(j,i){if(!j||!i){return false}return j.replace(/\D+/g,"")===i.replace(/\D+/g,"")},is_primary_number:function(i){var j;j=bF("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this._phone_number){return this.is_same_phone_number(i,this._phone_number)}else{if(this.is_same_phone_number(i,j.data("primary_phone"))){return true}if(this.is_same_phone_number(i,bF("#twofactor-sms-number",j).text())){return true}}return false},save_added_backup_phone:function(i,T,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:j},onSuccess:(function(fl){return function(fm){var fn;switch(fm.responseText.strip()){case"OK":fl.hide_error();fn="#twofactor-row-"+fl._user.role;bF(fn+" #twofactor-backup-number").text(j);bF(fn).toggleClass("with-backup",!!j);if(!j){ah.success(eA("Backup phone number removed"))}else{if(!T){ah.success(eA("Backup phone number updated"))}else{ah.success(eA("Backup phone number added"))}}return fb.hide();case"EXPIRED":i.to_state("password");return fl.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(T,fl){var i,j;j=bF("input.text-input-input",T);if(!fl){return j.val("")}i=C.controller(bF(".phone-number-input",T));i.set(fl);j.val(i.get_local_number());if(j.length){j[0].select()}bF("#twofactor-backup-back-save").find("#skipstep").hide();bF(".text-input-wrapper").find("label").hide();return j},fill_delivery_choice:function(i){bF("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!i);bF("#twofactor-delivery-offline-label").toggle(!i);bF("#confirm-phone-primary-number").text(i);return bF("#twofactor-row-"+this._user.role).data("primary_phone",i)},fill_backup_phone:function(i){bF("#confirm-phone-backup").toggle(!!i);return bF("#confirm-phone-backup-number").text(i)},insert_spaces_into_code:function(i){return i.toLowerCase().replace(/(.{4})/g,"$1 ")},fill_recovery_codes:function(j,fn){var fq,fl,T,fo,fr,fp,fm;fq=bF("#"+fn);fq.empty();T=j[0].length;if(T===16){fq.css("column-count","1")}fp=[];for(fo=0,fr=j.length;fo<fr;fo++){fl=j[fo];fm=bF("<li/>",{"class":"twofactor-backup-list__item"});fp.push(fq.append(fm.append(bF("<span/>",{"class":"twofactor-backup-list__code",text:this.insert_spaces_into_code(fl)}))))}return fp},submit_finish:function(j,i,T,fl){var fm;this.show_loading();fm={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!j){fm.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fm,onSuccess:(function(fn){return function(fo){switch(fo.responseText.strip()){case"OK":fn.successfully_enabled=true;if(i.vars.mode!=="ENABLE"){return fn.after_enabled(i,T)}else{return T.next()}break;case"EXPIRED":i.to_state("password");return fn.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(j,fl){var i,T;this._checkpoint_token=null;this.hide_error();i=bF("#twofactor-row-"+this._user.role);i.toggleClass("with-sms",!!this._phone_number);bF("#twofactor-sms-number",i).text(this._phone_number||"");i.toggleClass("with-backup",!!this._backup_phone);bF("#twofactor-backup-number",i).text(this._backup_phone||"");i.addClass("twofactor-enabled");bF("tr[id^='session_row_']").slice(1).hide();if(j.vars.mode!=="ENABLE"){T="/account/#security";ah.success(new fg(eA('Two-step verification updated. Any <a href="%(path)s">existing sessions, devices and apps</a> can still access your Dropbox.').format({path:T})));return fl!=null?fl.next():void 0}},disable_submit:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(T){return function(fm){var fl;switch(fm.responseText.strip()){case"OK":T.successfully_disabled=true;T._checkpoint_token=null;fl=bF("#twofactor-row-"+T._user.role);fl.removeClass("twofactor-enabled with-sms with-backup");bF(document).trigger("security-key-manager:UPDATE_KEYS",T._user.id);bF("#twofactor-sms-number, #twofactor-backup-number",fl).text("");bF("tr[id^='session_row_']").slice(1).hide();ah.success(eA("Two-step verification is now disabled."));return j.next();case"EXPIRED":i.to_state("password");return T.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(T,i){var j;if(i){C.controller(i).show_error(T);return}j=$$(this._error_selector);if(T===this.error_expired_password()||T===this.error_unreachable(true)){j.invoke("update",T)}else{j.invoke("__date",T)}return j.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(i){return this.show_error(this.error_bad_carrier(),i)},show_error_invalid_number:function(i){return this.show_error(this.error_invalid_number(),i)},show_error_not_a_mobile:function(i){return this.show_error(this.error_not_a_mobile(),i)},show_error_unreachable:function(i,j){if(j==null){j=false}return this.show_error(this.error_unreachable(j),i)},show_error_expired:function(i){return this.show_error(this.error_expired(),i)},show_error_expired_password:function(i){return this.show_error(this.error_expired_password(),i)},error_500:function(){return eA("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return eA("Unfortunately, your carrier isn\u2019t supported at this time.")},error_invalid_number:function(){return eA("That isn\u2019t a valid phone number.")},error_not_a_mobile:function(){return eA("That phone number doesn\u2019t appear to be a valid mobile number.")},error_unreachable:function(i){if(i==null){i=false}if(i){return eA('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return eA("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return eA("Since it's been a while, please enter your password again.")},error_expired_password:function(){return eA('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ah.success(eA("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(j){var i,T;i=j.element();T=bF(".sick-input",i.form);bF("input",T).val("").focus();return this.fill_example_phone_number(i,T)},fill_example_phone_number:function(i,fl){var T,j;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){T=bF(i).val().substr(1);j=phone_helpers.get_example_mobile_number(T);return bF("label",fl).text(eA("Example: ")+j)}},reset_phone_field_and_backup_country:function(j){var i;this.reset_phone_field(j);if(bF("#backup-phone-number").val()===""){i=bF("#twofactor-enter-backup-phone #country-code");i.val(j.element().getValue());return this.fill_example_phone_number(i,bF(".sick-input",i[0].form))}}};var n,cT=[].indexOf||function(fl){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fl){return T}}return -1};n=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=E.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aX.FileViewModeType.UNKNOWN,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new ax(),_is_browse_drag_enabled:null,_file_view_attempts:0,globalPreviewStateModel:new ek.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new ek.Model({state:"hidden",file_extension:null}),_get_extension:function(j){var i;i=j.lastIndexOf(".");return(i===-1?"":j.substr(i+1))},_get_preview_type_from_extension:function(T){var j,i;j=T.substring(0,3);if(j==="rtf"||j==="odt"){i="doc"}else{if(j==="pps"){i="ppt"}else{i=j}}return i},_file_view_mode_is_browse:function(){var i;return i=this.file_view_mode,cT.call(aX.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,i)>=0},_file_view_mode_is_shared_or_member_link:function(){var j,T,i;j=aX.FileViewModeCategories;return(T=this.file_view_mode,cT.call(j.SHARED_LINK_FILE_VIEW_MODE_TYPES,T)>=0)||(i=this.file_view_mode,cT.call(j.MEMBER_LINK_FILE_VIEW_MODE_TYPES,i)>=0)},show:function(fl,i,T,j){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fn,T,fm,fl){var fo,j,i;if(fm==null){fm={}}fm=bx.defaults(fm,{files:[],force_file_unlocked:true,file_view_mode:aX.FileViewModeType.UNKNOWN,should_focus_comment_input:false,hide_comments:false,hide_restore:false});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=bF.proxy((function(){return !this.shown()}),this)}i=bF("#file-viewer");if(this.hiding){i.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{i.hide()}}fo=i.find(".file-viewer-comment-container");if(fm.hide_comments){fo.hide()}else{fo.show()}j=i.find(".restore-button");if(j.length){if(fm.hide_restore){j.hide()}else{j.show()}}this.file=fn;this.active_user=T;this.flippable_files=this._filterFlippableFiles(fm.files);this.file_view_mode=fm.file_view_mode;this.should_focus_comment_input=fm.should_focus_comment_input;this.total_files=fm.files.length;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{C.scroll_lock_document();i.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,fm.force_file_unlocked,fl)}},_getFilesToPreloadActivities:function(){var fl,fp,fn,fq,fm,T,fo;fp=[];fl=this.currentFlippableFileIndex();fo=[1,2,3,4,5,6,-1,-2];for(fm=0,T=fo.length;fm<T;fm++){fn=fo[fm];fq=fl+fn;if((0<=fq&&fq<this.flippable_files.length)){fp.push(this.flippable_files[fq])}}return fp},load:function(T,fn,j){var i,fm,fl;if(fn==null){fn=false}this.file=T;document.title=this.file.filename;i=bF("#file-viewer");if(i.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(fn){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}bF(document.activeElement).blur();this._render_viewer();fl=this.modal_type===this._MODAL_FILEINFO;fm=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,fl,j,fm])},_filterFlippableFiles:function(j){var i;return(function(){var fl,T,fm;fm=[];for(fl=0,T=j.length;fl<T;fl++){i=j[fl];if(d5.isFlippable(i.preview_type)){fm.push(i)}}return fm})()},currentFlippableFileIndex:function(){var fn,fm,fl,T,fo;fo=this.flippable_files;for(fm=fl=0,T=fo.length;fl<T;fm=++fl){fn=fo[fm];if(this.file.sjid===fn.sjid){return fm}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var fp,fm,fl,fo,T,j,fn,i;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;T=0;i=this.active_user.id;fn=this.file.fq_path;j=1000;fo=(function(fq){return function(){T++;if(T<fq.MAX_CHECK_LOCK_TRIES){if(T===2){INLINE_JS.Notify.warning(eA("Office Online is saving your file."))}else{if(T===5){INLINE_JS.Notify.warning(eA("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fq.check_lock_timeout=setTimeout(fp,j);return j=j*2}else{clearTimeout(fq.check_lock_timeout);fq.check_lock_request=null;fq.file_locked=false;return fq._render_preview(true,true)}}})(this);fl=(function(fq){return function(fr){fr=JSON.parse(fr);if(fr!=null?fr.has_lock:void 0){return fo()}else{fq.check_lock_request=null;fq.file_locked=false;return fq._render_preview(true,true)}}})(this);fm=function(fs,fq,fr){return fo()};fp=(function(fq){return function(){return fq.check_lock_request=cE.WebRequest({url:"/ow/msft/check_lock",data:{user_id:i,fq_path:fn},success:fl,error:fm})}})(this);return fp()},shown:function(){return bF("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(i){return function(){return i.set_preview_url()}})(this),250)},set_preview_url:function(){var T,j,i;T=G.parse(eD.get_url());j=T.getPath();i=T.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eD.push_state(G.encode_parts(j),i,{immediatelyRestoreState:false})},unset_preview_url:function(){var T,j,i;this.clear_preview_url_timer();T=G.parse(eD.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(T.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in T.getQuery())){return}j=T.getPath();i=T.removeQuery("select").removeQuery("preview").getQuery();return eD.push_state(G.encode_parts(j),i)},render_file_failed:function(){var i,j;j=this.file;i=this.active_user;this._teardown_and_hide();j.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(j,i,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,should_focus_comment_input:this.should_focus_comment_input});bF("#file-viewer").show();return bF("#file-viewer").trigger("preview_failed")},_log_view:function(i,j,fl){var T;if(fl==null){fl=aX.FileViewModeType.FILE_PREVIEW}this._file_view_attempts++;T={user_id:this.active_user.id,context:aX.FileViewContextType.PRIVATE,platform:aX.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,shared_link_url:null,extra:{mode:fl,file_ext:aA.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:i,in_progress:j,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return ba.FileViewLogger.log(T)},preload_office_static:function(j){var fl,T,i;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}T=this._get_extension(j);if(T in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){fl=bF("#file-viewer .open-with-static-content-container");i=bF("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[T]});return fl.html(i)}},unload_office_static:function(){var i;i=bF("#file-viewer .open-with-static-content-container");return i.empty()},_render_viewer:function(){var fp,j,fs,ft,fl,fv,i,fu,fr,fw,fm,T,fn,fq,fo;j=bF("#file-viewer");fp=j.find(".download-button");ft=G.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);fq=(function(fx){return function(fE){var fA,fC,fz,fy,fB,fD;if(fE==null){fE=true}fy=bU.em_snippet(fx.file.filename,35);fA=j.find(".title-bar .filename");fD={"class":"icon",alt:fx.file.caption};fB=cx.html("web",fx.file.icon,fD).toHTML();fC=bF("<span />",{"class":"filename-text"}).text(fy);fA.html(fB).append(fC);j.addClass("has-preview");if(cM.get_viewer().is_team_assume_user_session){j.addClass("room-for-team-assume-user-top-bar")}if(fx.file.htmlified_link){j.addClass("htmlified-preview")}else{if(fx.file.preview_type==="excel"){j.addClass("html-preview");j.find(".loading").css("z-index","-1")}else{j.addClass(fx.file.preview_type+"-preview")}}if(fE){j.find(".loading").show()}fp.on("click",function(fF){fF.preventDefault();return window.location.href=ft});if(fx.file.tkey===void 0&&n.active_user.is_email_verified){fz=function(fF){this.file.tkey=fF.tkey;return this._update_title_bar_buttons()};cE.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fx.file.fq_path},dataType:"json",subject_user:fx.active_user.id,success:fz.bind(fx)})}else{fx._update_title_bar_buttons()}fx.modal_type=fx._MODAL_PREVIEW;fx._first_render_completed=false;return fx._listen()}})(this);fv=(function(fx){return function(){j.removeClass();j.find(".loading").hide();return fx._unlisten()}})(this);fn=(function(fx){return function(fy,fD,fB,fA,fz){var fC;if(fy==null){fy=false}if(fD==null){fD=true}if(fB==null){fB=false}if(fA==null){fA=false}if(fz==null){fz=true}fx._log_view(Date.now()-fx._start_time,fA,aX.FileViewModeType.FILE_PREVIEW);fC=fx._get_extension(fx.file.filename);if(fC==="doc"||fC==="docx"||fC==="odt"||fC==="ppt"||fC==="pptx"||fC==="xls"||fC==="xlsx"||fC==="pdf"||fC==="eps"||fC==="ai"||fC==="psd"||fC==="svg"||fC==="txt"||fC==="rtf"||fC==="pspimage"||fC==="tif"||fC==="tiff"||fC==="yuv"||fC==="url"||fC==="webloc"||fC==="website"||fC==="wopitest"){fx.globalPreviewStateModel.set({state:"open",file_obj:fx.file})}if(!fy){fq(fD);fx._update_title_bar_buttons()}fx._render_preview(fB,fz);return fx._initial_resize()}})(this);T=(function(fx){return function(fz){var fy,fB,fC,fA;if(fz==null){fz=false}fy=fx.file.filename.indexOf(".");fB=fx.file.filename.substring(fy+1);if(fB==="key"&&fx.file.preview_type===null){fA="/static/images/icons128/"+(aA.file_icon("_other"))+".png"}else{fA="/static/images/icons128/"+(aA.file_icon(fx.file.filename))+".png"}fx.globalPreviewStateModel.set({state:"closed",file_obj:null});fC=bU.em_snippet(fx.file.filename,20);j.find(".title-bar .filename").text(fC);j.addClass("no-preview");j.find(".file-thumbnail img").attr({src:fA});j.find(".file-type").text(fC);j.find(".file-size").text(fx.file.size);j.find(".file-modified").text(fx.file.ago||"");fp.on("click",function(){return b1.unsafeRedirect(ft)});fx.modal_type=fx._MODAL_FILEINFO;fx._listen();fx._log_view(Date.now()-fx._start_time,fz,aX.FileViewModeType.FILE_INFO);fx._update_title_bar_buttons();return fx._initial_resize()}})(this);fl=this._get_extension(this.file.filename);fw=((fm=this.file.preview_type)==="doc"||fm==="excel"||fm==="keynote"||fm==="adobecs"||fm==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||aA.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!b1.msie_version_at_most(9);this.has_preview=d5.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fw&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked));i=fw&&this._preview_progressive_try(fl)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||i){return fn(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fu=this.file_locked||(fw&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fu){return T()}fq();fr=G({path:"/doc_preview_status"+this.file.fq_path}).toString();fo=Date.now();return(fs=(function(fx){return function(){var fy;fy=Date.now();if(fy-fo>=5000){setTimeout(bF.proxy(fx.render_file_failed,fx),0);return}return fx.preview_status_request=bF.ajax(fr,{success:function(fz){if(fx.file){return fx.file.doc_preview_status=parseInt(fz,10)}},complete:function(fz,fA){if(fA==="abort"){return}if(fx.file_locked){return}if(fx.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fx.has_preview=true;return fn(true,false,true,true)}else{if(fx.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fx.preview_status_timeout_obj=setTimeout(fs,1000)}else{fx.render_file_failed()}}},timeout:5000-(fy-fo),subject_user:fx.active_user})}})(this))()},switch_preview:function(T,j,fn,fo){var fm,fl,i;if((T!=null)||(j!=null)){if(this.file!=null){this.annotation_enabled_for_this_revision=fn;if(T!=null){this.file.href=T}if(j!=null){this.file.direct_blockserver_link=j}fm=bF("#file-viewer .preview-content-container");if(this.file.preview_type==="photo"){if((fl=this._preview_flippable_component)!=null?fl.isMounted():void 0){return this._preview_flippable_component.setProps({"thumbnail-url-tmpl":T,onLoad:fo})}}else{i="";fm.html(i);return this._render_preview(false,true,fo)}}}},_remove_loading:function(i){var j;if(i==null){i=true}j=bF("#file-viewer .loading");j.hide();j.css("z-index","");return this.is_loaded=i},_render_blank:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dC.createElement(H,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dC.render(i,j.get(0))},_render_linkfile:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dC.createElement(S,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dC.render(i,j.get(0))},_update_title_bar_buttons:function(){var T,j,fr,fB,fw,fq,fu,fx,fF,fs,ft,fn,fl,i,fz,fo,fm,fD,fE,fp,fy,fv,fA,fC,fG;fq=bF("#file-viewer");fw=fq.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fw.remove()}T=fq.find(".download-button");j=fq.find(".split-button.openwith");fB=j!=null?j.find(".main-button"):void 0;fr=j!=null?j.find(".more-button"):void 0;fF=eA("Open",{comment:"Open a file natively on the user's computer"});fx=function(){return fq.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};fu=(function(fH){return function(fJ){var fK,fI;return fq.data("is-openwith-allowed")==="True"&&((fK=__CONDITIONAL_JS__.OpenWith)!=null?fK.get_open_handler_for(fJ,fH.active_user):void 0)&&fJ.bytes<((fI=__CONDITIONAL_JS__.OpenWith)!=null?fI.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fJ.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fD=(function(fH){return function(fI){return __CONDITIONAL_JS__.UnityFeatures.open_file(fH.file.ns_id,fH.file.ns_path,fH.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fJ){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fI)}})(this);fo=function(){return fD(false)};fm=function(){return fD(true)};fE=(function(fH){return function(){var fJ,fI,fK;fJ=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fH.file,fH.active_user);if(fJ){if((fK=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fK.log_open_button_pressed(fH.active_user.id,aA.file_extension(fH.file.filename).toLowerCase(),fH.file.ns_id,fH.file.ns_path)}fI=fJ.uri+"?hpt_click_ts="+Date.now();return b1.redirect(fI)}}})(this);fG=(function(fH){return function(fP,fQ,fI){var fM,fL,fR,fK,fJ,fT,fN,fO,fS;fS=[];fN=fQ!=null;if(fN&&(fQ.can_open_directly||(fQ.can_open_directly==null))){fM=fQ.open_application_name||eA("Open");fO=eA("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fO=eA("Open in %(app_name)s").format({app_name:fM})}fS.push({id:"ow_desktop",label:fO,icon:"ow_desktop",callback:fo})}if(fP){fT=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fH.file,fH.active_user);fS.push({id:"ow_web",label:fT.name,icon:fT.icon,callback:fE})}if(fN&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fJ=fQ.file_browser_display_name||eA("File Browser");fO=eA("Show in %(file_browser)s").format({file_browser:fJ});if(fN&&!fQ.can_open_directly&&!fP){fF=fO}fS.push({id:"ow_folder",label:fO,icon:"ow_folder",callback:fm})}fv(fF,fS);if(!fP&&!fN){fR=false}else{if(fN){fR=false}else{fR=true}}if(!fR&&!fI){fH._hide_more_button()}else{fH._show_more_button(fI,fR)}fL=function(fU,fW,fX,fV){if(fH._open_button_update_state_timeout){clearTimeout(fH._open_button_update_state_timeout)}return fH._open_button_update_state_timeout=setTimeout((function(){fH.globalOpenWithWebButtonStateModel.set({user_id:fU,state:fW,file_extension:fX,target_button:fV});return fH._open_button_update_state_timeout=null}),200)};if(fP){fK=aA.file_extension(fH.file.filename).toLowerCase();if(fN){return fL(fH.active_user.id,"visible",fK,fr)}else{return fL(fH.active_user.id,"visible",fK,fB)}}else{return fL(null,"hidden",null,null)}}})(this);fA=function(fH){if(j!=null){j.toggleClass("shown",fH)}return T.toggle(!fH)};fv=function(fI,fH){if(!(fH instanceof Array)){fH=[fH]}if(fH.length===0){return fA(false)}else{if(fH.length===1){return fn(fI,fH[0].callback)}else{return fl(fI,fH)}}};fn=function(fH,fI){if((j==null)&&(fB==null)){return}fA(true);j.removeClass("split");fB.text(fH);return fB.off("click").on("click",fI)};fl=function(fN,fI){var fM,fL,fJ,fH,fK;if((j==null)&&(fB==null)&&(fr==null)){return}fA(true);j.addClass("split");fB.text(fN);fM=fq.find(".openwith-dropdown");fB.off("click").on("click",function(fO){return fI[0].callback(fO)});fr.off("click").on("click",function(fP){var fO;fO=bF(this).parent().siblings(".openwith-dropdown");if(fO.is(":visible")){return}fO.removeAttr("style");eT.show(fO,this,null,true);return fP.stopPropagation()});fM.find("li").hide();fL=function(fO){var fP;fP=fM.find("."+fO.id);fP.find("a .sprite-text-inner").text(fO.label);cx.src(fP.find("a .sprite")[0],"web",fO.icon);fP.find("a").off("click").on("click",function(fQ){fQ.preventDefault();return fO.callback(fQ)});return fP.show()};for(fJ=0,fH=fI.length;fJ<fH;fJ++){fK=fI[fJ];fL(fK)}return bF("#file-viewer-container").off("click",eT.hide_all).on("click",eT.hide_all)};fC=!!fx();fs=!!fu(this.file);ft=!!this.file.tkey;fG(fs,null,ft);if(fC){i=function(fH){var fI,fJ;fJ=function(fK){fH.file_browser_display_name=fK;return fG(fs,fH,ft)};fI=function(){return fG(fs,null,ft)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fJ,fI)};if((fp=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fp.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return i((fy=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fy.get(this.file.ns_id,this.file.ns_path):void 0)}else{fz=function(fH){if(fH.is_locally_available){return i(fH)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fz)}}},_show_more_button:function(fo,j){var fm,fn,T,fl,i;i=bF("#file-viewer");fm=i.find(".more-options-button");fm.show();T=i.find(".more-options-dropdown");fm.on("click",function(fp){if(T.is(":visible")){return}eT.show(T,fm,null,true);return fp.stopPropagation()});bF("#file-viewer-container").on("click",eT.hide_all);fl=T.find(".remove-link");fl.off("click");if(fo){fl.show();fl.on("click",(function(fp){return function(fq){eT.hide_all();return am.confirm_remove(fp.file.filename,fp.file.tkey,0,0,0,fp.file.user_id)}})(this))}else{fl.hide()}fn=T.find(".download-button");return fn.toggle(j)},_hide_more_button:function(){var j,i;i=bF("#file-viewer");j=i.find(".more-options-button");j.off("click").hide();bF("#file-viewer-container").off("click",eT.hide_all);return i.find(".remove-link").off("click")},_initial_resize:function(){var i;if(this.is_loaded){return}i=function(){return bF("window").trigger("resize")};return setTimeout(i,0)},_is_pptx_slim_enabled:function(){return az.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fm,fl){var fn,i,T,j;j=this.active_user;fm=this._get_preview_type_from_extension(fm);T=G.parse(fl);i=false;if(fm==="doc"||fm==="key"||fm==="keynote"||fm==="adobecs"){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){T=T.updateQuery({post_message_on_failure:1})}}else{if(fm==="ppt"&&!this._is_pptx_slim_enabled()){fn="private_progressive_viewer";i=true}else{if(fm==="xls"){if(j.xls_edit){fn="xls/edit"}else{fn="xls/preview"}}}}if(fn){if(i){T.setAuthority(Constants.WEBSERVER)}else{T.setAuthority(T.getAuthority().replace("dl-web","dl-doc"))}T.setPath(T.getPath().replace("/pri/get/","/get/"));T.setPath(T.getPath().replace("/get/","/"+fn+"/"))}T=T.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return T},_get_pdf_js_url:function(i){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){i=G.parse(Constants.static_url_pdfjs_viewer)}return i},_preview_is_progressive:function(i){i=this._get_preview_type_from_extension(i);return i==="doc"||i==="ppt"||i==="xls"||i==="key"||i==="keynote"||i==="eps"||i==="ai"},_preview_progressive_try:function(j){var T,i;if(!this._preview_is_progressive(j)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}j=this._get_preview_type_from_extension(j);T=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED;i=j==="key"||j==="keynote";return T||i},_set_previews_sandbox_params:function(j,i){j=this._get_preview_type_from_extension(j);if(j!=="xls"){return""}else{return null}},_prepare_annotation_url:function(i){if(this._is_annotation_marker_enabled()){i=i.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){i=i.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){i=i.updateQuery("annotation_region","1")}return i},_render_preview:function(fE,fB,fo){var fl,fp,ft,fC,fy,fm,fJ,fF,fu,fA,fs,fH,fD,fG,fI,fr,fz,T,fw,fq,fx,fv,fn;if(fE==null){fE=false}if(fB==null){fB=true}if(fo==null){fo=null}fr=(function(i){return function(){i._remove_loading();return typeof fo==="function"?fo():void 0}})(this);if(fE){this._remove_loading(false)}fz=bF("#file-viewer .preview-content-container");if(fz.find("iframe").length>0){return}if(this.file.htmlified_link){fu=bF("<iframe/>",{src:this.file.htmlified_link,sandbox:"allow-scripts allow-forms"});fz.append(fu);return fu.on("load",fr)}else{if(this.file.preview_type==="doc"){ft=this._get_extension(this.file.filename);fp=this._get_preview_type_from_extension(ft);if(fp==="ppt"&&!this._is_pptx_slim_enabled()){fn=this._get_progressive_url(ft,this.file.href);fu=bF("<iframe/>",{src:fn.toString(),allowfullscreen:"",type:"application/pdf"});fz.append(fu)}else{if(az.getGandalfRule("security-primodel")){fn=this._get_progressive_url(ft,this.file.direct_blockserver_link)}else{fn=this._get_progressive_url(ft,this.file.href)}if(this.active_user.inline_commenting){bF("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});fn.setAuthority(fn.getAuthority().replace("dl-web","dl-doc"));fn.setPath(fn.getPath().replace("/get/","/dochax_private_commentless_preview/"));fy=fn.toString();fn=G.parse(Constants.static_url_pdfjs_hack_viewer);fn.setQuery({file:fy})}else{if(!fB){fn=fn.updateQuery({generate_preview:1});fn.setAuthority(fn.getAuthority().replace("dl-web","dl-doc"))}fH=fp==="ppt"&&this._is_pptx_slim_enabled();fn.updateQuery("sjid",this.file.sjid);this._pdfLoader.openFile(fn,{presentationMode:fH});fn=this._get_pdf_js_url()}fn=fn.updateQuery(a9.UID_PARAM_NAME,this.active_user);fn=this._prepare_annotation_url(fn);fu=bF("<iframe/>",{src:String(fn),type:"application/pdf"});fu.addClass("pdfjs");fz.append(fu)}return fu.on("load",fr)}else{if(this.file.preview_type==="html"){fu=bF("<iframe/>",{src:this.file.href,sandbox:""});fz.append(fu);return fu.on("load",fr)}else{if(this.file.preview_type==="excel"){if(az.getGandalfRule("security-primodel")){fn=this._get_progressive_url("xls",this.file.direct_blockserver_link)}else{fn=this._get_progressive_url("xls",this.file.href)}fu=bF("<iframe/>",{src:fn,sandbox:"allow-scripts allow-forms"});this._set_previews_sandbox_params("xls",fu);fz.append(fu);return fu.on("load",fr)}else{if(this.file.preview_type==="keynote"){fn=this._get_progressive_url("html",this.file.href);fn=fn.updateQuery({generate_preview:1});fn=fn.updateQuery({post_message_on_failure:1});fu=bF("<iframe/>",{src:fn,type:"text/html"});fz.append(fu);return fu.on("load",fr)}else{if(this.file.preview_type==="adobecs"){if(az.getGandalfRule("security-primodel")){fn=this._get_progressive_url("adobecs",this.file.direct_blockserver_link)}else{fn=this._get_progressive_url("adobecs",this.file.href)}fn=fn.updateQuery({generate_preview:1});this._pdfLoader.openFile(fn);fn=this._get_pdf_js_url();fn=fn.updateQuery(a9.UID_PARAM_NAME,this.active_user);fn=this._prepare_annotation_url(fn);fu=bF("<iframe/>",{src:String(fn),type:"application/pdf"});fu.addClass("pdfjs");fz.append(fu);return fu.on("load",fr)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{fl=this.currentFlippableFileIndex();fC=this._get_extension(this.file.filename);if(d5.isFlippable(this.file.preview_type)){bF("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fw=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?bt.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;fv=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"){if(fC==="gif"&&this.file.bytes<=Constants.MAX_GIF_FILE_SIZE_B){fJ=G.parse(this.file.href).updateQuery({raw:1}).toString()}fv=this.file.thumbnail_url_tmpl;fA=[];fq=[1,2,3,4,5,6,-1,-2];for(fD=0,fG=fq.length;fD<fG;fD++){fF=fq[fD];fs=fl+fF;if(0<=fs&&fs<this.flippable_files.length){fA.push(this.flippable_files[fs].thumbnail_url_tmpl)}}}}fm={"preview-type":this.file.preview_type,"preview-url":fw,"thumbnail-url-tmpl":fv,gifUrl:fJ,"file-extension":fC,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fA,index:fl,count:this.flippable_files.length,totalFiles:this.total_files,onPrevious:(function(i){return function(){return i.loadPreviousFlippable()}})(this),onNext:(function(i){return function(){return i.loadNextFlippable()}})(this),onLoad:fr,onError:(function(i){return function(){i._remove_loading()}})(this)};if((fx=this._preview_flippable_component)!=null?fx.isMounted():void 0){fI=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(fm)}else{T=dC.createElement(d5,fm);return this._preview_flippable_component=dC.render(T,fz.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(fr){var fq,fl,fo,fm,fp,fs,T,fn,i;fo=bF("#file-viewer .preview-content-container iframe");fn=[];for(fm=0,fp=fo.length;fm<fp;fm++){fl=fo[fm];i=fl.src;T="://";fs=i.indexOf(T);if(fs===-1){fq=i.indexOf("/")}else{fq=i.indexOf("/",fs+T.length)}if(fq!==-1){i=i.substring(0,fq)}fn.push(fl.contentWindow.postMessage(fr,i))}return fn},_watchFile:function(){if(!az.getGandalfRule("tap-to-refresh")){return}return this.subscription=aa.subscribe(this.file,this.active_user,this._onFileUpdate.bind(this))},_onFileUpdate:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}n.post_preview_message('{"action":"notify_sfj"}');return bc.when().then(function(){return ah.success(eA("Someone edited this file."))})},_unwatchFile:function(){if(!this.subscription){return}this.subscription.cancel();return delete this.subscription},loadPreviousFlippable:function(){var i;if(d5.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id,i])}},loadNextFlippable:function(){var i;if(d5.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id,i])}},_listen:function(){var j,i,T;j=bF("#file-viewer");this._pdfLoader.startListening();cN.addFileDragEnabledCheck(this._is_browse_drag_enabled);j.find(".js-close-button").on("click",bF.proxy(this._on_close,this));this._watchFile();if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(fl){return function(fm){if(eV.isFullscreen()||C.focus_in_input()||C.is_input(fm.target)){return}return fl._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(fl){return function(fm){return fl.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(fl){return function(fm){return fl.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){j.find(".share-button").on("click",bF.proxy(this._share,this));T=(function(fl){return function(fm){if(fl.file.fq_path.toLowerCase()===fm.memo.fq_path.toLowerCase()){fl.file.tkey=fm.memo.tkey;return fl._update_title_bar_buttons()}}})(this);i=(function(fl){return function(fm){if(fl.file.tkey===fm.memo.token){fl.file.tkey=null;return fl._update_title_bar_buttons()}}})(this);this.share_link_callback=T.bind(this);this.remove_link_callback=i.bind(this);document.observe(aH.LINKS_ADD,this.share_link_callback);document.observe(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){j.find(".share-button").on("click",bF.proxy(this._share,this))}}bF(window).on("resize",bF.proxy(this._resize,this));this.handleMessageFromChild=function(fl){switch(fl.action){case"failed":return n.render_file_failed();case"lock_preview":return n.preview_locked=true;case"unlock_preview":return n.preview_locked=false;case"toggle_preview_lock":return n.preview_locked=!n.preview_locked;case"hide_iframe":return n._teardown_and_hide();case"loaded":return n.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return n._handle_page_rendered(fl.parameters)}};this._frameMessenger=new et();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bF.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(fl){if(n.preview_locked){return""}else{return void 0}}},_unlisten:function(){var i;i=bF("#file-viewer");this._pdfLoader.stopListening();i.off("click",bF.proxy(this._teardown_and_hide,this));cN.removeFileDragEnabledCheck(this._is_browse_drag_enabled);i.find("#file-viewer-container").off("click",function(j){return j.stopPropagation()});i.find(".js-close-button").off("click",bF.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){i.find(".share-button").off("click",bF.proxy(this._share,this));i.find(".download-button").off("click");bF(document).off("click",eT.hide_all);document.stopObserving(aH.LINKS_ADD,this.share_link_callback);document.stopObserving(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){i.find(".share-button").off("click",bF.proxy(this._share,this))}}bF(window).off("resize",bF.proxy(this._resize,this));key.setScope(this.prev_scope);return this._unwatchFile()},_resize:function(T){var j,i;if(!this._is_rams_ui()){j=bF("#file-viewer");i=j.find("#file-viewer-container").height()-(j.find(".title-bar").height()+1);j.find(".preview").height(i);return j.trigger("height-resize",{height:i})}},_share:function(i){ba.ShmodelUILogger.log("via-browse-file-viewer");i.preventDefault();if(az.getGandalfRule("simple-sharing")){return eF.createAndShowInbandModalFromFile(this.active_user,this.file)}else{return new dh(this.active_user.id,this.file.fq_path,"file_viewer").show()}},_on_close:function(i){i.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var i;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){eW.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){n.unset_preview_url()}C.scroll_unlock_document();i=bF("#file-viewer");return i.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(j){return function(){var fm,fl,T;if(eV.isFullscreen()){eV.exitFullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){T=eA("Download");fm=i.find(".download-button");fm.text(T);fm.off("click")}j._hide_more_button();i.removeClass("has-preview").removeClass("no-preview");fl=i.find(".preview-content-container");dC.unmountComponentAtNode(fl.get(0));j._preview_flippable_component=null;fl.empty();i.find(".file-thumbnail img").attr({src:""});i.find(".title-bar .filename").text("");i.attr({"class":""});j._unlisten();j._remove_loading();document.title=j._cached_browser_window_title;j._cached_browser_window_title=null;j.last_file=j.file;j.file=null;j.preview_locked=false;window.removeEventListener("message",j.preview_lock_listener);j.is_loaded=false;j.hiding=false;j.cancel_check_lock();i.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(i){var fl,fm,fr,fp,fs,fq,T,fn,fo;if(!this._first_render_completed){fl=aA.file_extension_for_logging(this.file.filename);fo=i.stats;fq=((T=this.file)!=null?T.bytes:void 0)!=null?this.file.bytes:0;fp=bF.extend(i.attributes,{total_time:Date.now()-this._start_time,file_ext:fl,source:"file-viewer",originalSize:fq,docPreviewStatus:this.file.doc_preview_status});for(fm=0,fr=fo.length;fm<fr;fm++){fn=fo[fm];fs=(function(){switch(fn.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fp[fs]=fn.end-fn.start}ba.UserActivityLogger.log("web","file_view_first_page_rendered",fp);ba.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:fl,extra:JSON.stringify(fp)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},_is_annotation_marker_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return bF("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return bF("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"}};var dZ;dZ=E.Index2={init:function(fr,fl){var fp,fs,fq,j,T,fm,ft,fo,i;if(fl){bF("#sign-in").on("click",function(fy){var fn,fw,fv,fu,fx;fy.preventDefault();fv=bF("#sign-in-form");fb.show(eA("Sign in"),fv[0],false,false,416,false,"sign-in-modal");fw=fv.find("#login_email");fw.focus();return new b8(fn=fw,fx=function(){fv.find("#password-field").hide();fv.find("#remember-me").hide();fv.find("#login_submit").val(eA("Continue"));fv.find("#forgot_password_link").hide();return fv.find("#sso_description_footer").show()},fu=function(){fv.find("#password-field").show();fv.find("#remember-me").show();fv.find("#login_submit").val(eA("Sign in"));fv.find("#forgot_password_link").show();return fv.find("#sso_description_footer").hide()})})}fp=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF.when(bF("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bF("#signup-container").addClass("form_shown");return bF("#signup-container .text-input input:visible").first().focus()})}};if(!fr){bF(".register").find(".login-button").on("click",function(fn){if(!bF("#signup-container").hasClass("form_shown")){fn.preventDefault();return fp()}});dZ.animate()}else{bF(".photo").show()}fs=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF(".register").find(".login-button").trigger("click")}};bF(".buttons .freshbutton-blue").on("click",function(fn){fn.preventDefault();bF("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:fs});return false});bF("#learn-more").on("click",function(fn){fn.preventDefault();bF("html, body").animate({scrollTop:bF("#divider").offset().top},{queue:false,duration:500});return false});if(bw.are_enabled()){ba.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ah.error(eA("Please enable browser-cookies to use the Dropbox website."))}i=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];fq=function(fn){return bF(fn).on("click",function(){return ba.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fn})})};for(T=0,fm=i.length;T<fm;T++){j=i[T];fq(j)}fo=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];ft={};return bF(window).scroll(function(){var fz,fA,fy,fw,fu,fn,fv,fx;fx=[];for(fn=0,fv=fo.length;fn<fv;fn++){fy=fo[fn];if(bF(fy).length&&!ft[fy]){fA=bF(window).scrollTop();fz=fA+bF(window).outerHeight();fu=bF(fy).offset().top;fw=fu+bF(fy).outerHeight();if(fw<=fz){ba.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fy});fx.push(ft[fy]=true)}else{fx.push(void 0)}}else{fx.push(void 0)}}return fx})},_animate_points:function(fq,fr,fs,fl,fu,fp,T){var fn,fm,fo,ft;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fo=fp(T);ft=[(function(){var i,fv,j;j=[];for(fn=i=0,fv=fr.length;0<=fv?i<fv:i>fv;fn=0<=fv?++i:--i){j.push([(function(){var fw,fx;fx=[];for(fm=fw=0;fw<2;fm=++fw){fx.push(fr[fn][fm]+(fs[fn][fm]-fr[fn][fm])*fo)}return fx})()])}return j})()];fq.attr("points",dZ.points_array_to_str(ft));if(T>=1){return fu.resolve()}else{return setTimeout(function(){return dZ._animate_points(fq,fr,fs,fl,fu,fp,T+(10/fl))},10)}},animate_points:function(j,fo,fn,T,fm,fl){var i;if(fl==null){fl=jQuery.easing.linear}i=bF.Deferred();dZ._animate_points(j,fo,fn,T,i,fl);return i.done(function(){return typeof fm==="function"?fm():void 0}).promise()},animate_hide_rects:function(fl,fq,fr){var T,fo,fm,j,fp;T=bF.Deferred().resolve().promise();fo=function(fn){var fw,ft,fv,fs,fu;fs=bF(fl[fn]);fw=dZ.points_str_to_array(fs.attr("points"));fu=[fw[1],fw[1],fw[2],fw[2]];ft=dZ.inverse(jQuery.easing.linear);fv=fq*(ft((fn+1)/fl.length)-ft(fn/fl.length));return T=T.then(function(){return dZ.animate_points(fs,fw,fu,fv)})};for(fm=j=0,fp=fl.length;0<=fp?j<fp:j>fp;fm=0<=fp?++j:--j){fo(fm)}return T.done(function(){return typeof fr==="function"?fr():void 0}).promise()},animate_delay:function(j){var i;i=bF.Deferred();setTimeout(i.resolve,j);return i.promise()},animate:function(){return bF.Deferred().resolve().promise().then(function(){return dZ.animate_docs()}).then(function(){return dZ.animate_graphs()}).then(function(){return dZ.animate_photos()})},inverse:function(j,i){if(i==null){i=0.000001}return function(fn){var fl,fm,T;fm=0;fl=1;while(fl-fm>i){T=(fm+fl)/2;if(j(T)<fn){fm=T}else{fl=T}}return fm}},points_str_to_array:function(fp){var fm,T,j,fo,fn,fl;fn=fp.split(" ");fl=[];for(T=0,j=fn.length;T<j;T++){fo=fn[T];fl.push((function(){var i,fs,fq,fr;fq=fo.split(",");fr=[];for(i=0,fs=fq.length;i<fs;i++){fm=fq[i];fr.push(parseFloat(fm))}return fr})())}return fl},points_array_to_str:function(j){var i;return((function(){var fl,T,fm;fm=[];for(fl=0,T=j.length;fl<T;fl++){i=j[fl];fm.push(i.join(","))}return fm})()).join(" ")},animate_docs:function(){var fo,fl,i,fm,T,fn,j;j=[[5,6],[177,1],[184,157],[13,180]];i="";for(fn=fl=0.475;fl<=0.625;fn=fl+=0.05){fo=fn+0.05;fm=[[j[0][0]+(j[3][0]-j[0][0])*fn,j[0][1]+(j[3][1]-j[0][1])*fn],[j[1][0]+(j[2][0]-j[1][0])*fn,j[1][1]+(j[2][1]-j[1][1])*fn],[j[1][0]+(j[2][0]-j[1][0])*fo,j[1][1]+(j[2][1]-j[1][1])*fo],[j[0][0]+(j[3][0]-j[0][0])*fo,j[0][1]+(j[3][1]-j[0][1])*fo]];fm=dZ.points_array_to_str(fm);i+="<polygon points='"+fm+"' style='fill:#f5f9fc;stroke:none;' />"}T=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+i+"\n</svg>");return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".comp.doc").append(T);return bF(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dZ.animate_hide_rects(T.find("polygon"),2500,function(){return T.remove()})}).then(function(){return dZ.animate_delay(500)}).then(function(){return bF(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dZ.animate_delay(1500)}).then(function(){return bF(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var j,i;j=[[83,98],[158,37],[241,77],[171,145]];i=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');i.find("polygon").attr("points",dZ.points_array_to_str(j));return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".tablet.graph .graph-grid").hide();bF(".tablet.graph").append(i);return bF(".tablet.graph").show("fade",{},500).promise()}).then(function(){var T;T=[j[0],j[1],j[1],j[0]];return dZ.animate_points(i.find("polygon"),j,T,600,function(){return i.remove()})}).then(function(){if(!b1.msie_version_at_most(8)){return bF(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dZ.animate_delay(500)}).then(function(){return bF(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dZ.animate_delay(2000)}).then(function(){return bF(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bF(".phone.photo").show();return bF.when((function(){if(!b1.msie_version_at_most(8)){return bF(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bF.Deferred().resolve().promise().then(function(){return bF(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dZ.animate_delay(750)}).then(function(){return bF(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var bB,co,eO;eO=E.UnsupportedBrowser={init:function(){return bF("#unsupported-browser-dismiss").on("click",function(i){i.preventDefault();e7.hide();return bF.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};co=E.ExpiredCCNotificationBar={init:function(i){return bF(".expired-dismiss").on("click",function(j){j.preventDefault();e7.hide();return bF.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:i}})})}};bB=E.BetaLocaleNotificationBar={init:function(i){return bF(".beta-locale-dismiss").on("click",function(j){j.preventDefault();e7.hide();return bF.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:i}})})}};var e;e=INLINE_JS.viewer=cM.get_viewer();var L,ey,ex,b4,O,cd,e1,bD;if(!Constants.is_test){bF(eQ.check_timezone)}if(window._document_observe_listeners){e1=window._document_observe_listeners;for(ey=0,b4=e1.length;ey<b4;ey++){cd=e1[ey];if(document.loaded){cd.func()}else{document.observe(cd.event,cd.func)}}}if(window._jquery_ready_handlers){bD=window._jquery_ready_handlers;for(ex=0,O=bD.length;ex<O;ex++){L=bD[ex];bF(L)}}bF(function(){return Event.fire(document,"script:loaded")});return E});