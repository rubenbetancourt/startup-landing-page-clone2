define("dropbox",["modules/core/controller_registry","modules/clean/browse_interface","modules/clean/react/previews/preview_linkfile","modules/clean/base64","modules/clean/previews/file_view_rams_common","modules/core/uri","modules/clean/file_events","modules/clean/previews/preview_actions_helper","modules/clean/em_string","modules/core/exception","libs","modules/clean/uirequest","modules/clean/history","modules/clean/sharing/shared_link_modal","external/underscore","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","external/swfobject","modules/clean/display_format","modules/clean/search/search_helpers","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/notifications/file_watcher","modules/clean/previews/pdf_loader","modules/constants/viewer","modules/clean/sharing/sharing_constants","modules/clean/sharing/get_editable_link_prompt","modules/clean/people/experiments/link_profile_service_modal","modules/clean/account/email","modules/clean/dbmodal","modules/clean/events/rollback","external/backbone","modules/clean/react/previews/preview_image_zoom","modules/clean/sharing/api","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/components/role_picker","external/plupload_dev","modules/clean/react/previews/preview_video","external/keymaster","modules/clean/image_size","modules/clean/viewer","modules/constants/python","modules/clean/sprite","modules/clean/dbmodal_loading","modules/clean/undo","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/video_util","modules/clean/react/previews/preview_flippable","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/activity/comment_count_bubble","modules/clean/db_bubble","external/flash_detect","external/purify","modules/clean/sharing/share_inband","modules/core/visibility","modules/dirty/react/file_viewer/controller","modules/constants/env","modules/clean/sharing/shared_folder_settings_modal","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","external/modernizr","modules/clean/teams/team_folder_modal","modules/clean/components/ajax_form","modules/clean/react/invite/invite_form_react","modules/clean/browse_events","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/core/i18n","modules/constants/request","modules/clean/top_notif","modules/core/dom","modules/clean/web_timing_logger","modules/clean/payments/credit_card_util","modules/clean/react/previews/preview_image","modules/clean/form","modules/core/cookies","modules/clean/clipboard","modules/clean/payments/cash","modules/clean/browse/browse_drag_utils","modules/clean/account/email_verify_reasons","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/search/search_type","external/jquery_ui","modules/clean/contacts/cache","modules/clean/frame_messenger","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/filepath","modules/core/html","modules/clean/static_urls"],function(bX,fk,bI,ak,bV,G,aH,m,bU,ec,cl,by,eE,aI,bx,cE,b8,ah,c3,aF,ap,z,fm,aa,ax,a9,d0,B,b,cX,c8,at,el,di,e8,an,ee,er,dn,p,a7,e5,ai,cM,aX,cx,cD,X,cR,az,bO,b6,bt,M,W,dC,c2,a5,aC,eZ,c0,dP,bc,e2,fl,ae,bF,a0,bA,d,dW,ch,ab,dN,cq,o,da,bl,aK,cv,C,eh,e7,cz,bb,bw,t,dS,cN,es,aY,c4,eD,eH,ep,eu,ba,bs,b1,H,aA,fi,aN){var E={};var S=bI.PreviewLinkfile;var cP=m.LegacyFilePreviewActions;var eX=m.LegacyFileViewerActions;var ca=ec.alertd;var cL=ec.assert;var eN=ec.reportException;var eO=ec.stackTrace;var dl=z.Job;var eC=z.ModalProgress;var cy=b.LinkProfileServiceModal;var av=cX.ChangeEmail;var d4=cX.EmailVerification;var d8=c8.DBModal;var d1=c8.DBModalStack;var dm=c8.DBUserModal;var aW=di.PreviewImageZoom;var bm=e8.SharingApi;var cr=e8.UserlessSharingApi;var d2=dn.RolePickerState;var ek=a7.PreviewVideo;var aG=ai.image_best_fit_size;var bP=cR.NotServer;var d9=cR.NotClients;var d5=M.PreviewFlippable;var c7=a5.CommentCountBubbleFactory;var dM=cq.SimpleModal;var bk=da.LinkedProfileServices;var eb=da.ProfileServicesLinkingHandler;var bd=bl.ungettext;var eB=bl._;var dI=bl.N_;var F=bl.E_;var fb=bl.render_sentences;var e9=cv.TopNotificationBar;var eQ=cv.EUCookieNotificationBar;var r=cv.ExpiredIOSNotificationBar;var eg=cv.PackratUnlimitedOptInNotificationBar;var ci=cv.DfBAdminEarlyAccessSharingControlsBar;var ce=cv.DfBAdminEarlyAccessFtsBar;var aR=cv.LocaleSwitchBar;var e0=cv.SuperInactiveRecoverBar;var x=cz.PreviewImage;var bj=dS.Cash;var fg=dS.CashUtil;var dJ=aY.HierarchicalNavBar;var fh=c4.DfBTransitionInfoFetcher;var cK=ep.ContactsCache;var b0=ep.DefaultContactsCache;var ei,e6,de;INLINE_JS.$=$;INLINE_JS.$u=bx;Function.prototype.defer=Function.prototype.defer.wrap(function(j){var i;i=$A(arguments).slice(1);this.__tb__=eO();return j.apply(this,i)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(T){var j,fn,i;j=$A(arguments).slice(1);try{return T.apply(this,j)}catch(i){fn=i;return cL(0,fn.toString())}});ei=E.Jcached={cache:{},set:function(j,T,i){var fn;fn=ei.cache[j];if(fn==null){fn=ei.cache[j]={}}fn.value=T;return fn.expires=i?new Date().getTime()+i:0},get:function(i){var j;j=ei.cache[i];if((j==null)||new Date().getTime()>j.expires){delete ei.cache[i];return false}return j.value}};Function.prototype.cached=function(i){var T,j;j=Math.random();T=this;return function(){var fn;fn=ei.get(j);if(fn!==false){return fn}fn=T();ei.set(j,fn,i);return fn}};Array.prototype.sort_by_key=function(j,T){var i;if(T==null){T=false}i=T?-1:1;return this.sort(function(fn,fo){fn=j(fn);fo=j(fo);if(fn<fo){return i*-1}else{if(fn>fo){return i*1}else{return 0}}})};Array.prototype.contains=function(i){return this.indexOf(i)!==-1};Array.prototype.remove=function(j,i){i=i||j+1;return this.splice(j,i-j)};Array.prototype.removeItem=function(j){var i;i=this.indexOf(j);if(i>=0){return this.remove(i)}else{return false}};Array.prototype.dict_by=function(fn){var fq,fr,fp,T,fo;fo={};for(fq=fp=0,T=this.length;fp<T;fq=++fp){fr=this[fq];fo[this[fq][fn]]=this[fq]}return fo};Array.prototype.unique=function(){var fp,fo,T,i,fn;fp={};for(T=0,i=this.length;T<i;T++){fo=this[T];if(typeof fo!=="string"){return this}fp[fo]=0}fn=[];for(fo in fp){fn.push(fo)}return fn};String.prototype.widthSplit=function(fn){var i,T,j,fo;if(fn==null){fn=15}i=[];T=this;fo=0;j=T.substring(fo,fo+fn);while(j!==""){i.push(j);fo+=fn;j=T.substring(fo,fo+fn)}return i};Object.extend(Effect.Transitions,{EaseIn:function(i){return Math.pow(i,2)},EaseOut:function(i){return Math.pow(i,0.5)}});(function(T){var i,j;j=function(fs){var fn,fv,fp,fo,fr,fq,fu,ft,fw;if(fs){if(Object.isArray(fs)){fn=[];for(fp=0,fr=fs.length;fp<fr;fp++){fv=fs[fp];fn.push(fi.escape(fv).toHTML())}fs=new fi(fn.join(""))}else{if(fs.top||fs.bottom||fs.before||fs.after){ft=["top","bottom","before","after"];for(fo=0,fq=ft.length;fo<fq;fo++){fu=ft[fo];fw=fs[fu];if(fw){fs[fu]=arguments.callee(fw)}}}else{if(d6.isElm(fs)||fs.toElement||fs.toHTML){}else{fs=fi.escape(fs)}}}}return fs};return Element.addMethods({db_observe:function(fo,fn,fp){return fo.observe(fn,function(fq){return fp(fq,fo)})},smoothScrollIntoView:function(fq,fp){var fu,fo,fn,ft,fs,fr;if(fp==null){fp={}}fu={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};fp=Object.extend(fu,fp);fn=fq.viewportOffset(fq);fo=fq.getDimensions();fr=document.viewport.getDimensions();fs=fp.padding||0;if(fn.top>fs&&(fn.top+fo.height)<(fr.height-fs)){return}ft=fn.top<fs?-1*Math.floor(fr.height/4):-1*Math.floor(3*fr.height/4);fp.offset=fp.offset||ft;return new Effect.ScrollTo(fq,fp)},__sert:function(fn,fo){return Element.insert(fn,j(fo))},__date:function(fn,fo){return Element.update(fn,j(fo))},replace:i=function(fn,fo){return T(fn,j(fo))}})})(Element.replace);e6=function(i){if(i!=null?i.target:void 0){try{return document.activeElement=i.target===document?null:i.target}catch(j){}}};de=function(i){try{return document.activeElement=null}catch(j){}};if(document.addEventListener){document.addEventListener("focus",e6,true);document.addEventListener("blur",de,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(j,i){var T;if(i==null){i="0"}T=this;while(T.length<j){T=i+T}return T.toString()};String.prototype.reverse=function(){var T,j,i;i=this.split("");j=i.reverse();T=j.join("");return T};String.prototype.count=function(i){return(this.length-this.gsub(i,"").length)/i.length};String.prototype.repeat=function(i){return(new Array(i+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,fp,fn){var fw,fu,fz,fy,fB,fA,fr,T,i,fx,fs,fo,fq,fv,ft;if(fn==null){fn={}}this.orig_req={url:fp,options:fn};this.start_time=b6.time();fn.method=fn.method||"post";fn.evalJS=false;fn.suppress_nonstandard_headers=true;fn.parameters=fn.parameters||{};fn.parameters.t=bw.read(aK.JS_CSRF_COOKIE);fn.parameters.is_xhr=true;if(fn.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fn.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fn.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fn.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fn.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&fp.indexOf("/")===0){fn.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fn.parameters.restrict=Ajax.DBRequest.restrict}fu=fn.cleanUp||(function(){});this.subject_user=fn.subject_user||fn.job_user;if(fn.job){this.job_id=d6.nonce();fn.parameters.job_id=this.job_id;ed.watch(this,fn.dont_hide_progress_on_complete)}if(!fn.no_watch){ar.watch(this,!!fn.job)}fx=fn.onFailure;fs=fn.onSuccess;i=fn.onComplete;T=(function(j){return function(fD){var fC,fE;if(fn.parameters.xhr_retry||!fn.allow_retries){return false}if((fC=fD.status)===0||fC===500||fC===502||fC===503){j.orig_req.options.parameters.xhr_retry=true;j.orig_req.options.onFailure=fx;j.orig_req.options.onSuccess=fs;fE=new Ajax.DBRequest(j.orig_req.url,j.orig_req.options);return true}return false}})(this);fn.onFailure=function(fD){var fE,fC,j;if(dl.handled(fD.request.job_id)){return}if(T(fD)){return}if(!fn.noAutonotify){if(!Constants.IS_PROD&&fD.status===500&&fD.getHeader("X-Debug-Url")){fp=fD.getHeader("X-Debug-Url");fE=eB("There was a problem completing this request.")+(' <a href="'+fp+'" target="_blank">View debug</a>');ah.error(new fi(fE))}else{ah.error()}}fu(false);if(fx){fx(fD)}if(fD.status===403){j=d6.session_storage_get("reload-timestamp");if(!j||b6.time()-j>30*1000){d6.session_storage_set("reload-timestamp",b6.time());location.reload(true)}}return cL(fn.noAutonotify||((fC=fD.status)===403||fC===404||fC===502),"Ajax "+fD.status+" on "+fD.request.url)};fn.onComplete=(function(j){return function(fC){if(fC.responseText.length&&i){if(fC.responseText.indexOf("async_task_started:")!==0){return i(fC)}}}})(this);fn.onSuccess=(function(j){return function(fC){var fD,fM,fS,fU,fL,fQ,fR,fF,fO,fE,fG,fK,fN,fI,fP,fT,fJ,fH;fH=b6.time()-fC.request.start_time;if(dl.handled(fC.request.job_id)){return}if(!fC.responseText.length){if(!fn.job){if(T(fC)){return}if(!fn.noAutonotify){if(!fC||fC.status!==0){ah.error()}}if(fx){fx(fC)}}}else{if(fC.responseText.indexOf("err:")===0){if(!fn.noAutonotify){fF=fC.responseText.substr(4);if(fn.html_in_error_msg){fF=new fi(fF)}ah.error(fF)}if(fx){fx(fC)}}else{if(fC.responseText.indexOf("async_task_started:")===0){j.async_task_id=fC.responseText.split(":")[1];ed.watch(j)}else{if(fs){if(fC.responseText.indexOf("ok:")===0){ah.success(fC.responseText.substr(3))}fs(fC)}}fJ=fC.getHeader("X-Server-Response-Time")||"-1";if(fn.log_timing){eh.log_ajax_transition.defer(fH,void 0,void 0,void 0,fJ,fp=be.absolutize(j.url))}fM=bF("#cprofile");if(!fn.no_watch&&fM.length){fI=Constants.REQUEST_ID+"-"+(fC.getHeader("X-Dropbox-Request-Id"));fp=fC.request.url.replace(/[^\/]*\/\/[^\/]+/,"").replace(/\?.*$/,"");fE={request_id:fI};fN=fC.request.url;if(fN.indexOf(Constants.BLOCK_CLUSTER)!==-1){fE.block=1}else{fG=Constants.BATCH_THUMB_ENDPOINTS;for(fQ=0,fR=fG.length;fQ<fR;fQ++){fL=fG[fQ];if(fN.indexOf(fL)!==-1){fE.block=1;break}}}fD=function(f0,fY,fX,fZ){var fW,fV;if(fZ){fW=bF('<a target="_blank" />')}else{fW=bF("<a />")}fV=fW.attr("href",String(G({authority:Constants.WEBSERVER,path:fY,query:fX}))).text(f0+" ");return fV};fO=[["svg","/profile/cprofile/svg",true],["pstats","/profile/cprofile/pstats",false],["callgrind","/profile/cprofile/callgrind",false],["IO","/profile/ioprofile",true],["DB","/profile/dbprofile",true]];fT=(function(){var fV,fW,fX;fX=[];for(fV=0,fW=fO.length;fV<fW;fV++){fS=fO[fV];fX.push(fD(fS[0],fS[1],fE,fS[2]))}return fX})();fP=bF('<div class="ajax">').text("Ajax: "+fp+" ("+fJ+"ms)").prepend(fT);fU=fM.find(".ajax");if(fU.length>=10){fU.last().remove()}fM.prepend(fP)}if(bF("#gandalf_panel").length&&fC.request.url.substring(0,14)!=="/gandalf_panel"){if((fK=window.gandalf_panel)!=null){fK.add(fC.request.url,fC.getHeader("X-Dropbox-Request-Id"))}}}}return fu(true)}})(this);fn.onException=function(fC,fD){var fE,j;if(window.console){throw fD}fE=("Error with AJAX callback for: "+fp+" :::: ")+fD.toString();j=eO();j.pop();return eN(fE,b1.get_href(),"",j.join("\n"))};if(fn.job){fp+=(fp.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fn.subject_user&&!((fq=fn.parameters)!=null?fq[a9.UID_PARAM_NAME]:void 0)){fp=G.parse(fp).updateQuery(a9.UID_PARAM_NAME,fn.subject_user).toString()}fw=$H({url:fp});if(fn.parameters){fw.update(fn.parameters);fv=fw.keys();for(fz=0,fA=fv.length;fz<fA;fz++){fB=fv[fz];ft=["passwd","password","oauth","ccn","host_id"];for(fy=0,fr=ft.length;fy<fr;fy++){fo=ft[fy];if(fB.indexOf(fo)!==-1){fw.unset(fB)}}}fw.unset("t")}fn.onSuccess.__tb_ajax_info__=fn.onFailure.__tb_ajax_info__=Object.toJSON(fw);return $super(fp,fn)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(d6.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cF=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bF;if(!Function.prototype.bind){Function.prototype.bind=function(i){var fo,fn,j,T;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fo=Array.prototype.slice.call(arguments,1);T=this;j=function(){};fn=function(){return T.apply((this instanceof j&&i?this:i),fo.concat(Array.prototype.slice.call(arguments)))};j.prototype=this.prototype;fn.prototype=new j();return fn}}jQuery.fn.curry=function(){var i,T,j;T=arguments[0],j=arguments[1],i=3<=arguments.length?cF.call(arguments,2):[];if(j==null){j=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var fn;fn=1<=arguments.length?cF.call(arguments,0):[];return T.apply(j,cF.call(i).concat(cF.call(fn)))}};jQuery.fn.stripTags=function(i){if(typeof monkey_check==="function"){monkey_check()}return i.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return C.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(j,i){if(typeof monkey_check==="function"){monkey_check()}C.clone_position(this,j,i);return this};jQuery.format=function(j,i){if(typeof monkey_check==="function"){monkey_check()}return j.replace(/\{([^}]+)\}/g,function(fn,T){if(T in i){return i[T]}else{return fn}})};jQuery.cachedScript=function(j,i){if(typeof monkey_check==="function"){monkey_check()}i=bF.extend(i||{},{dataType:"script",cache:true,url:j});return jQuery.ajax(i)};jQuery.browser=b1;jQuery.addSubjectParam=function(T,i){var j;if(typeof monkey_check==="function"){monkey_check()}if(T.subject_user&&!((j=T.data)!=null?j[a9.UID_PARAM_NAME]:void 0)){return i[a9.UID_PARAM_NAME]=String(T.subject_user)}};jQuery.ajaxPrefilter(function(i,fn,T){var j;if(!fn.noDropboxDefaults){j={t:bw.read(aK.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(fn,j);if(jQuery.ajaxSettings.restrict!=null){j.restrict=jQuery.ajaxSettings.restrict}i.data=bF.param(bF.extend(fn.data,j),true);return false}});jQuery.ajax.retryOnce=function(fn,i,j){var T;if(typeof monkey_check==="function"){monkey_check()}if(i!=="abort"&&((T=fn.status)===0||T===500||T===502||T===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var eJ,dj,be,d6,dA;d6=INLINE_JS.Util=E.Util={scroll_to_thumb:function(i){var fo,fn,T,j;fn=i.cumulativeOffset().top;fo=i.getHeight();j=C.scroll_offsets().top;T=C.viewport_dimensions().height;if(fn<j||fn+fo>j+T){return C.scroll_to(0,fn-T/2)}},decode_sort_key:function(T){var fp,fn,i,fo;fo=[];for(fn=0,i=T.length;fn<i;fn++){fp=T[fn];if(typeof fp==="string"){fo.push(ak.decode(fp))}else{fo.push(fp)}}return fo},sort_by_rank_or_key:function(i,j){if((i.sort_rank!=null)&&(j.sort_rank!=null)){return i.sort_rank-j.sort_rank}cL((i.sort_key!=null)&&(j.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(i,j)},sort_by_key:function(i,j){return this._sort_by_key(i,j)},_sort_by_key:function(fn,fs){var fq,fp,fr,T,fo;T=fn.sort_key;fo=fs.sort_key;for(fq=fp=0,fr=T.length;0<=fr?fp<fr:fp>fr;fq=0<=fr?++fp:--fp){if(fo[fq]==null){return 1}if(typeof T[fq]!==typeof fo[fq]){if(typeof T[fq]==="string"){return 1}else{return -1}}else{if(T[fq]!==fo[fq]){if(T[fq]>fo[fq]){return 1}else{return -1}}}}if(fo.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(i,fp,fo,T){var fq,fs,ft,fn,fr;fn=$$(fo);fr=[];for(fq=0,fs=fn.length;fq<fs;fq++){ft=fn[fq];fr.push((function(j){var fu;if(i!==j){cx.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}fu=fp?"arrow-up-gray":"arrow-down-gray";return cx.src(j.down("img"),"web",fu)}})(ft))}return fr},add_sort_arrow_mouseover_j:function(i,fp,fo,T){var fq,fs,ft,fn,fr;fn=bF(fo);fr=[];for(fq=0,fs=fn.length;fq<fs;fq++){ft=fn[fq];fr.push((function(j){var fu;if(i.attr("data-sort")!==bF(j).attr("data-sort")){cx.src(bF(j).find("img")[0],"web","downtick-spacer");return bF(j).removeClass("bolded")}else{bF(j).addClass("bolded");if(bF(j).hasClass("noarrow")){return}fu=fp?"arrow-up-gray":"arrow-down-gray";return cx.src(bF(j).find("img")[0],"web",fu)}})(ft))}return fr},one_line_fit:function(i){var T,j;T=$$(i);if(T.length<2){return}j=(function(fn){return function(){var fw,fu,fs,fp,fq,fv,fr,ft,fo;fs=T[0];fv=T[T.length-1];fp=fs.cumulativeOffset().top;fr=fv.cumulativeOffset().top;if(fp!==fr){fw=parseInt(fs.getStyle("font-size"),10);fo=fw-1;if(fo<8){return}for(fq=0,ft=T.length;fq<ft;fq++){fu=T[fq];fu.style.fontSize=fo+"px"}return j()}}})(this);return j()},nice_list:function(j){var fp,fo,fn,i,T;if(!j){return""}else{if(j.length===1){return j[0]}else{if(j.length===2){return eB("%(x)s and %(y)s").format({x:j[0],y:j[1]})}}}T=eB("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cL(T.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fo=T[0];fn=T[1];i=T[2];fp=T[3];return[fo,j.slice(0,-1).join(fn),i,j[j.length-1],fp].join("")},list_em_snippet:function(fn,T){var ft,fq,fp,fo,fs,fr;fo="";T-=new bU("...").length;for(fq=fp=0,fs=fn.length;0<=fs?fp<fs:fp>fs;fq=0<=fs?++fp:--fp){fr=fn[fq];if(fq!==0){fr=", "+fr}ft=new bU(fr).length;if(ft>T){break}T-=ft;fo+=fr}return{str:fo,snipped:fn.length-fq}},start_of_day:function(i){var j;j=new Date();j.setTime(i.getTime());j.setHours(0);j.setMinutes(0);j.setSeconds(0);j.setMilliseconds(0);return j},to_iso8601_date:function(fn,j,T){var i;if(j==null){j=false}if(T==null){T=false}if(j){i=fn.getUTCFullYear().toString()+"-"+(fn.getUTCMonth()+1).toString().lpad(2)+"-"+fn.getUTCDate().toString().lpad(2);if(T){i+=" "+fn.getUTCHours().toString().lpad(2)+":"+fn.getUTCMinutes().toString().lpad(2)+":"+fn.getUTCSeconds().toString().lpad(2)}}else{i=fn.getFullYear().toString()+"-"+(fn.getMonth()+1).toString().lpad(2)+"-"+fn.getDate().toString().lpad(2);if(T){i+=" "+fn.getHours().toString().lpad(2)+":"+fn.getMinutes().toString().lpad(2)+":"+fn.getSeconds().toString().lpad(2)}}return i},to_mysql_date:function(fo,i,T){var j,fp,fn;j=fo.getFullYear().toString()+"-"+(fo.getMonth()+1).toString().lpad(2)+"-"+fo.getDate().toString().lpad(2);fn=fo.getHours().toString().lpad(2)+":"+fo.getMinutes().toString().lpad(2)+":"+fo.getSeconds().toString().lpad(2);fp="."+fo.getMilliseconds().toString().lpad(3);if(!i){return j}if(!T){return j+" "+fn}return j+" "+fn+fp},from_mysql_date:function(j){var fn,fp,T,fr,i,fq,fo;fr=j.split(" ");fn=fr[0];fq=fr.length>1?fr[1]:false;fp=fn.split("-");cL(fp.length===3,"weird date format on "+this+", expected yyyy-mm-dd");T=new Date(fp[0],parseInt(fp[1],10)-1,fp[2]);if(fq){fo=fq.split(":");cL(fo.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");T.setHours(fo[0]);T.setMinutes(fo[1]);i=fo[2].split(".");T.setSeconds(i[0]);if(i.length>1){T.setMilliseconds(i[1])}}return T},make_table:function(i,fr){var T,fq,fs,j,fo,fn,fp;fs=new Element("table",fr);j=new Element("tbody");fs.__sert(j);for(fq in i){fp=i[fq];fn=new Element("tr");fo=new Element("td").insert(fq);T=new Element("td").insert(fp);fn.__sert(fo);fn.__sert(T);j.__sert(fn)}return fs},validate_email:function(i){var j;j=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return j.test(i)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(T){var j,i;i=this.scried;j=i[T];if(!j){j=$(T);i[T]=j}return j},urlquote:function(i){return i.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var j,i;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(j=$("ieconsole"))!=null?j.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(i=console.log)!=null?i.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(T,j){var i;i=this.childElementWithIndex(T,j);return i[0]},childElementWithIndex:function(ft,fp){var fr,fs,fq,fo,T,fn;fr=0;fn=ft.childNodes;for(fq=fo=0,T=fn.length;fo<T;fq=++fo){fs=fn[fq];if(fs.nodeType===1&&fr++===fp){return[fs,fq]}}return[false,false]},disableSelection:function(i){i.onselectstart=function(){return false};i.unselectable="on";i.style.MozUserSelect="none";return i.style.cursor="default"},enableSelection:function(i){i.onselectstart=function(){return true};i.unselectable="off";i.style.MozUserSelect="";return i.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(i,fr,fp,fo){var T,fn,j,fq;if(!fp){fp=function(fs,ft){return fs-ft}}T=i.length;fn=0;while(T>fn){j=Math.floor(T/2+fn/2);fq=fp(i[j],fr);if(fq>0){T=j}else{if(fq<0){fn=j+1}else{return j}}}if(fo){return fn}else{return -1}},nonce:function(){var T,i,j;T=new Date();j=T.getTime().toString();i=Math.floor(Math.random()*1000000).toString().lpad(6);return j+i},focus:function(j){if(j){j=$(j);try{return j.focus()}catch(i){}}},sumStyles:function(fp,fq){var T,fn,fo,i;fn=0;if(fp){for(fo=0,i=fq.length;fo<i;fo++){T=fq[fo];fn+=parseInt(fp.getStyle(T),10)||0}}return fn},async_load_script:function(j){var i;i=function(){var fn,T;T=document.createElement("script");T.src=j;T.type="text/javascript";T.async=true;fn=document.getElementsByTagName("script")[0];return fn.parentNode.insertBefore(T,fn)};if(document.readyState==="complete"){return i()}else{if(window.attachEvent!=null){return window.attachEvent("onload",i)}else{return window.addEventListener("load",i,false)}}},smart_window_load:function(i){if(document.readyState==="complete"){return i.defer()}else{return Event.observe(window,"load",i)}},isNumber:function(i){return !isNaN(Number(i,10))},shorten_url:function(i,j){return new Ajax.DBRequest("/shorten_url",{parameters:{url:i},onSuccess:function(T){return j(T.responseText)}})},falsy_to_empty:function(i){return i||""},preloaded_images:{},preload_image:function(fn,T,j){var i;if(this.preloaded_images[fn]){return}i=new Image();if(T!=null){Element.extend(i).observe("error",T)}if(j!=null){Element.extend(i).observe("load",j)}i.src=fn;return this.preloaded_images[fn]=i},get_preloaded_image:function(i){if(this.preloaded_images[i]){return this.preloaded_images[i].clone()}else{return new Element("img",{src:i})}},clear_selected:function(){var i;if(window.getSelection){i=window.getSelection();if(i.removeAllRanges){return i.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(i){var T,j;T=20;j=C.viewport_dimensions();return i>j.width-T},freshbutton_overlay:function(j,i){var fn,T;T=j instanceof jQuery&&j||bF(j);fn=i instanceof jQuery&&i||bF(i);T.on("mouseover",(function(fo){return function(){return fn.addClass("hovered")}})(this));T.on("mouseout",(function(fo){return function(){fn.removeClass("hovered");return fn.removeClass("pressed")}})(this));T.on("mousedown",(function(fo){return function(){fn.removeClass("hovered");return fn.addClass("pressed")}})(this));return T.on("mouseup",(function(fo){return function(){return fn.removeClass("pressed")}})(this))},isElm:function(i){if(typeof HTMLElement==="object"){return i instanceof HTMLElement}else{return i&&typeof i==="object"&&i.nodeType===1&&typeof i.nodeName==="string"}},_track_twitter_chars_left:function(j,T){var i;clearInterval(this.chars_left_interval);i=(function(fn){return function(){var fo,fp;fo=$("twitter-chars");fp=T-$F(j).strip().length;if(fp<0){fo.addClassName("too-long")}else{fo.removeClassName("too-long")}return fo.__date(fp)}})(this);return this.chars_left_interval=setInterval(i,250)},session_storage_set:function(i,j){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(i,JSON.stringify(j))},session_storage_get:function(i){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(i))}},pdf_plugins:function(){var T,j,i;i=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return T=(function(){var fo,fn,fq,fp;fq=window.navigator.plugins;fp=[];for(fo=0,fn=fq.length;fo<fn;fo++){j=fq[fo];if(i.test(j.name)){fp.push(j)}}return fp})()},get_window_location:function(){return window.location}};d6.scrollLeft=d6.scrollLeft.cached(50);d6.scrollTop=d6.scrollTop.cached(50);if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var T,i,fp,fo,fn;if(d6.ie8){fo=$$("#page-header a, #page-footer a");fn=[];for(T=0,i=fo.length;T<i;T++){fp=fo[T];if(fp.target==="_blank"){fn.push(fp.target="")}else{fn.push(void 0)}}return fn}});dj=__CONDITIONAL_JS__.Trace=E.Trace=(function(){var i;i=[];return{log:function(){var j;j=b6.time()+": "+$A(arguments).join(" ");return i.push(j)},get:function(){return i.join("\n")}}})();eJ=E.T=function(){return dj.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var i;eJ("dom:loaded");i=function(){var fn,j,T,fo;T=$("page-content");if(T){fo=C.viewport_dimensions();j=$(document.body);fn="absolutize";if(fo.width<T.getWidth()){return j.addClassName(fn)}else{return j.removeClassName(fn)}}};Event.observe(window,"resize",bx.debounce(i,150));return i()});Event.observe(window,"load",function(){return eJ("window:load")});be=E.URLUtil={absolutize:function(i){if(i.startsWith("https://")||i.startsWith("http://")){return i}else{if(i.charAt(0)==="/"){return window.location.protocol+"//"+window.location.host+i}else{return cL(0,"absolutize is confused by "+i)}}}};dA=E.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var i,j;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}j=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;i=Math.abs(this.max_delta_y)<Math.abs(j-this.old_y);if(i){this.max_delta_y=j-this.old_y;return this.old_y=j}},start_capture:function(i){this.scroll_container=i;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(i){if(i==null){i=false}cL(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(i){return this.last_nonzero_velocity}return this.velocity}};var dv;dv=E.DomUtil={fromElm:function(i){return $(i).innerHTML},updateFromElm:function(j,i){j=$(j);i=$(i);return j.update(this.fromElm(i))},fillVal:function(fs,fq){var fp,T,fr,fn,fo,j;fr=$$("."+fq);fo=[];for(fp=0,T=fr.length;fp<T;fp++){j=fr[fp];j=$(j);if(j.tagName==="INPUT"){j.value=fs;fo.push(j.defaultValue=fs)}else{if(j.innerHTML===""&&((fn=j.tagName)==="A"||fn==="B"||fn==="INPUT"||fn==="I"||fn==="LABEL"||fn==="SELECT"||fn==="SPAN"||fn==="TEXTAREA")){d6.log("Filling an empty value; this may look broken in IE7",j)}fo.push(j.innerHTML=fs)}}return fo},copy_to_clipboard:function(fs,fp,ft){var fn,T,i,j,fq,fr,fo;fn=$("hold_clipboard");fn.value=fs;if(fn.createTextRange){fo=fn.createTextRange();if(fo&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return fo.execCommand("Copy")}catch(fr){fq=fr;ft=ft||eB("Please copy the text below:");fp=fp||eB("Copy text");this.fillVal(fs,"text-to-copy");this.fillVal(ft,"copy-modal-body");fd.show(fp,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){i=document.createElement("div");i.id="flashcb";document.body.appendChild(i)}$("flashcb").innerHTML="";T=encodeURIComponent(fn.value);j='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=j}}};var ar;ar=E.RequestWatcher={reqs:[],working_msg:eB("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(j,T){var i;i=this.reqs;if(!i.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(T){j.skip_message=true}return i.push([j,b6.time()])},check_up:function(){return this.scan(false)},remove:function(i){return this.scan(i)},scan:function(fq){var fu,fp,fr,T,fo,j,fn,ft,fs;T=b6.time();fo=[];fn=this.reqs;for(fp=0,fr=fn.length;fp<fr;fp++){j=fn[fp];ft=j[0];fs=j[1];fu=T-fs;if(ft.transport.readyState===4){this.clearWorkingMessage();continue}if(fu>4000&&!ft.skip_message){ft.skip_message=true;if(ah.isShown()&&ah.current()===!X.undo_notification){this.last_notification=ah.success(this.working_msg)}}if(fu>this.TIMEOUT*1000&&ft.job){ft.transport.abort()}if(ft!==fq){fo.push([ft,fs])}else{ft.transport.abort()}}this.reqs=fo;if(!fo.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ah.isShown()&&ah.current()===this.last_notification){return ah.clear()}}};bF(function(){var j,i,fn,T;fn=Prototype.Browser;T=[];for(j in fn){i=fn[j];if(i===true){T.push(bF(document.body).addClass(j.toLowerCase()))}}return T});var dL,a3,cF=[].slice;dL=E.HTML5_HISTORY=Modernizr.history;bF((function(i){return function(){return eE.init()}})(this));a3=E.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(i){return window.location.href=i},_replace_location:function(i){return window.location.replace(i)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(i,j){this.callback_map[i]=j;if(!this.watch_timer){return this.init()}},check_hash:function(){var j,T,fn,fp,fo,i;fp=this._get_location().split("#")[1];if(fp!=null){fp=fp.replace(/%27/g,"'")}if(this.last_hash===fp){return}this.last_hash=fp;if(this.last_prefix&&fp===""){fp=this.last_prefix+":"}else{if(!fp){return}}i=fp.split(":");fo=i.first();this.last_prefix=fo;fn=this.callback_map[fo];if(fn!=null){T=(function(){var fs,fq,ft,fr;ft=i.slice(1);fr=[];for(fs=0,fq=ft.length;fs<fq;fs++){j=ft[fs];fr.push(decodeURIComponent(j))}return fr})();fn.apply(null,T)}return $(document).fire("db:hash_change",{hash:fp})},_prepare_hash:function(T){var j,i;i=$A(T).map(d6.falsy_to_empty);j=i.map(encodeURIComponent);return j.join(":")},set_hash:function(){var i,j;i=1<=arguments.length?cF.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j)},replace_hash:function(){var i,j;i=1<=arguments.length?cF.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j,true)},_set_hash:function(j,i){if(j===""){j="/"}this.last_hash=j;if(!i){return this._set_location("#"+j)}else{return this._replace_location("#"+j)}}};var aZ;aZ=E.SharingUtil=(function(){function i(){}i.success_string_for_recipients=function(j){var T;if(j.length===1){if(j[0].indexOf("@")===-1){T=eB("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:j[0]})}else{T=eB("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:j[0]})}}else{if(j.length===2){if(j[0].indexOf("@")===-1){if(j[1].indexOf("@")===-1){T=eB("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eB("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:j[0],recipient_second:j[1]})}}else{if(j[1].indexOf("@")===-1){T=eB("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eB("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:j[0],recipient_second:j[1]})}}}else{if(j[0].indexOf("@")===-1){T=eB("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}else{T=eB("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}}}return T};return i})();var s;s=INLINE_JS.SharingModals=E.SharingModals=(function(){function i(){}i.show_shared_folder_options_modal=function(fo,j,T,fn){if(T==null){T=true}if(fn==null){fn=true}return d1.push(new dg(j,fo,T,fn))};i.show_share_inband_modal=function(fn,T,j,fo){return eG.createAndShowInbandModal(T,fn,true,j,true,false,fo)};i.show_shared_folder_wizard=function(j){return new eq(j,{element_id:"share-a-folder-wizard-modal"}).show()};i.get_select_role_modal=function(){return new cI({element_id:"select-role-modal"})};i.start_wizard_without_user=function(){if(cM.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=i.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cM.get_viewer().get_users()[0])}};i.start_wizard_for_user=function(j){if(d4.get_for_user(j).verified_or_show(es.SHARE_FOLDER)){return i.show_shared_folder_wizard(j)}};i.show_share_existing_modal=function(fn,j){var T;if(d4.get_for_user(j).verified_or_show()){T=new cp(j,{folder_name:fn,element_id:"invite-to-new-sf-wizard-modal-"+j.id});return T.show()}};i.show_shmodel_or_invite_modal=function(T,fo,j,fn){if(d4.get_for_user(j).verified_or_show()){return new dY(j,{path:T,existing_sf:fo,element_id:"create-link-or-invite-wizard-modal",target_item:fn}).show()}};i.show_unshare_team_sf_modal=function(T,j,fo){var fn;fn=new b5(T,{element_id:"unshare-confirm-modal",team_shared_folder:true,nested_shared_folder:false,ns_id:j,folder_path:fo});return fn.show()};i.show_ignore_modal=function(fn,T,j){var fp,fo,fq;cL(j,"Share ignore did not get an ns_id");fq=eB("Permanently remove '%(folder_name)s'").format({folder_name:bU.em_snippet(T,15)});fp={ns_id:j};fo=new dm(fn,{element_id:"ignore-confirm",title:fq});fo.on_confirm_button_click=function(ft){var fs,fr,fu;ft.preventDefault();fs=bF(ft.target);fr=fs.closest("form");fu=function(fv){ah.success(eB("Removed shared folder successfully."));document.fire(aH.SF_IGNORE,{target_ns_id:j,user_id:fn.id});return fo.hide()};return bT.ajax_submit(fr[0],false,fu,void 0,fs[0],fp)};return fo.show()};i.show_rejoin_modal=function(fn,T,j){var fp,fo,fq;cL(j,"Rejoin didn't get an ns_id");fq=eB("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bU.em_snippet(T,13)});fp={ns_id:j};fo=new dm(fn,{element_id:"rejoin-confirm",title:fq});fo.on_confirm_button_click=function(ft){var fs,fr,fu;ft.preventDefault();fs=bF(ft.target);fr=fs.closest("form");fu=function(fw){var fv;fv=fw.responseText;T=aA.filename(fv);ah.success(eB("Rejoined shared folder successfully."));document.fire(aH.SF_REJOIN,{target_ns_id:j,user_id:fn.id,filename:T,mount_point:fv});return fo.hide()};return bT.ajax_submit(fr[0],false,fu,void 0,fs[0],fp)};return fo.show()};i.show_invites=function(){return d1.push(new cD({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};i.show_shared_subfolder_modal=function(T,fo){var fr,fp,fq,j,fn;fq=bU.em_snippet(aA.filename(T),14);fp=eB("Can't share folder");j="'%(parent_shared_folder)s' ".format({parent_shared_folder:fq});dv.fillVal(j.escapeHTML(),"parent_shared_folder_name");fr=eB("Share '%(parent_shared_folder)s' folder");fn=fr.format({parent_shared_folder:fq});($("share_parent_folder_button")).value=fn;fd.show(eB("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bF("#share_parent_folder_button").on("click",(function(fs){return function(ft){fd.hide();return fs.show_shared_folder_options_modal(T,fo)}})(this));return fd.show(fp,$("share_subfolder"))};return i})();var df;df=E.InviteFormController=(function(){function i(fo,fn,T,j,fs,fr){var fq,fp;this.user=fo;this.$form=fn;this.members=T;this.invitees=j;this.new_style_groups=fs;this.team_only=this.$form.data("team-only");fp={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fq=Autocompleter.TeamTokenizer;fp.team_only=this.team_only}else{fq=Autocompleter.ContactsTokenizer;fp.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){fp.include_new_style_groups=true}this.sharing_options_auto_completer=new fq(this.user,fr+"-new-collab-input",fr+"-new-whobulk",fr+"-hidden-input",fp);cj._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new h(this.$form)}}i.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};i.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};i.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};i.prototype.reset_options=function(){return bF(this.sharing_options_auto_completer.get_entry_container()).hide()};i.prototype.set_team_only=function(j){this.team_only=j;return this.sharing_options_auto_completer.setTeamOnly(j)};i.prototype.get_token_count=function(){return this.sharing_options_auto_completer.getTokenCount()};i.prototype.extract_invitees=function(){var fq,fn,fo,T,fr,j,fp;fr={};fp=["emails","fb_ids","group_ids","new_style_group_ids"];for(fo=0,j=fp.length;fo<j;fo++){fn=fp[fo];T=this.$form.find("input[name="+fn+"]");fr[fn]=[(function(){var ft,fs,fu;fu=[];for(ft=0,fs=T.length;ft<fs;ft++){fq=T[ft];fu.push(bF(fq).val())}return fu})()]}return fr};i.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};i.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return i})();var aP,dg,R,ex,bv,ff,c6,dB,aV,eS,dw,cw,dR,bM,aJ,b5,fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dR=E.SharedFolderBaseModal=(function(i){fe(j,i);function j(fn,T){this.user=fn;this.options=T;j.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.nested_shared_folder=this.options.nested_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bm(this.user)}j.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return j})(d8);dg=E.ExistingSharedFolderOptionsModal=(function(j){fe(i,j);function i(fs,fo,fn,fp,T){var fr,fq;this.user=fs;if(fn==null){fn=true}if(fp==null){fp=true}this.restore_modal=T;this.__show_modal=b3(this.__show_modal,this);this.__x_click_handler=b3(this.__x_click_handler,this);cL(fo!=null,"Missing folder path");this.path=aA.normalize(fo);fq=eB("Shared folder options for '%(folder)s'");fq=fq.format({folder:bU.em_snippet(aA.filename(fo),13)});fr={};fr[a9.UID_PARAM_NAME]=this.user.id;fr.max_results=20;fr.show_invite_form=fn;fr.show_folder_settings=fp;d1.register(aP.MODAL_DONE_VIEWING_EVENT,(function(ft){return function(){return typeof ft.restore_modal==="function"?ft.restore_modal():void 0}})(this));i.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fq,endpoint_url:G({path:"/share_options"+this.path}).toString(),parameters:fr})}i.prototype.__x_click_handler=function(fn){var T;i.__super__.__x_click_handler.apply(this,arguments);T={path:this.path};ba.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,T);return typeof this.restore_modal==="function"?this.restore_modal():void 0};i.prototype.__show_modal=function(fn){var T;i.__super__.__show_modal.apply(this,arguments);T={path:this.path};return ba.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,T)};return i})(cD);aP=E.ExistingSharedFolderOptionsContent=(function(){i.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";i.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function i(fp,fn,fo,fq,j,T){this.$root=fp;this.options=fq;this.show_invite_form=j;this.allows_editor_manage_membership=T;this.show_email_verification=b3(this.show_email_verification,this);this.show_golden_gate_warning=b3(this.show_golden_gate_warning,this);this.show_folder_settings=b3(this.show_folder_settings,this);this.show_m2_folder_settings=b3(this.show_m2_folder_settings,this);this.toggle_from_invite_mode=b3(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=b3(this.toggle_to_invite_mode,this);this.toggle_get_link_button_visibility=b3(this.toggle_get_link_button_visibility,this);this.show_leave_folder_modal=b3(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=b3(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=b3(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=b3(this.show_unshare_folder_modal,this);this.show_uninvite_modal=b3(this.show_uninvite_modal,this);this.show_transfer_user_modal=b3(this.show_transfer_user_modal,this);this.show_kick_group_modal=b3(this.show_kick_group_modal,this);this.show_kick_user_modal=b3(this.show_kick_user_modal,this);this.update_tf_access=b3(this.update_tf_access,this);this.update_sf_perms=b3(this.update_sf_perms,this);this.reinvite_user=b3(this.reinvite_user,this);this.submit_invitations=b3(this.submit_invitations,this);this.maybe_load_more=b3(this.maybe_load_more,this);this.extract_user_data_and_call=b3(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=b3(this.extract_invitee_data_and_call,this);this.create_m2_inband_modal=b3(this.create_m2_inband_modal,this);this._disable_token_for_sf=b3(this._disable_token_for_sf,this);this.user=cM.get_viewer().get_user_by_id(fn);this.path=aA.normalize(fo);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fr){C.controller(bF(fr.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=20;this.$root.find(".member-container").on("scroll",(function(fr){return function(fu){var ft,fs;ft=bF(fu.currentTarget);fs=ft.find("#sf-members");if(ft.scrollTop()+ft.innerHeight()>=fs.innerHeight()){return fr.maybe_load_more()}}})(this));this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$root;bf.register_all();c5.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.nested_shared_folder=this.$root.data("nested-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");if(this.$root.find(".get-editable-link").length>0){B.showInstance(dC.createElement(B,{onDismiss:eG.dismissM2Prompt,shouldShow:ct.simple_sharing_show_m2_prompt,targetedButton:this.$root.find(".get-editable-link").get(0)}));ba.SimpleSharingLogger.log(this.user.id,29)}this.has_show_invite_form=false;this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();d1.trigger(i.CONTENT_LOADED_EVENT)}i.prototype.listen=function(){var fn,T,fo,j,fp;this.$root.find(".confirm-button").click((function(fq){return function(fr){fr.preventDefault();return fq.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fq){return function(fr){fr.preventDefault();return fq.toggle_from_invite_mode()}})(this));if(this.show_invite_form){this.get_link_button=this.$root.find(".get-editable-link-invite");this.$invite_input=this.$root.find("#sharing-options-new-collab-input");fp=["focus","keypress","contextmenu"];for(fo=0,j=fp.length;fo<j;fo++){T=fp[fo];this.$invite_input.off(T);this.$invite_input.on(T,this.toggle_to_invite_mode)}this.$invite_input.keyup(this.toggle_get_link_button_visibility);if(this.$invite_input[0]){this.$invite_input[0].on("token:remove",this.toggle_get_link_button_visibility);this.$invite_input[0].on("token:add",this.toggle_get_link_button_visibility)}fn=this.$root.find("#custom-message-wizard");fn.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".change-m2-settings-link").on("click",this.show_m2_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new df(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fq.user,fq.log_extras);return fq.show_leave_folder_modal()}})(this));this.$root.on("click",".get-editable-link",(function(fq){return function(fs){var fr;bF(document).trigger("collab:m2:prompt:dismiss");return fq.create_m2_inband_modal(fs,fr=false)}})(this));this.$root.on("click",".get-editable-link-invite",(function(fq){return function(fs){var fr;bF(document).trigger("collab:m2:prompt:dismiss");return fq.create_m2_inband_modal(fs,fr=true)}})(this));this.$root.on("click","a.owner-leave-folder",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fq.user,fq.log_extras);return fq.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fq){return function(fr){return fq.extract_user_data_and_call(fr,fq.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fq){return function(ft){var fr,fs,fu;ft.preventDefault();fr=bF(ft.currentTarget);fu=fr.data("group-name");fs=fr.data("group-gid");return fq.show_kick_group_modal(fu,fs)}})(this));this.$root.on("click","a.make-owner",(function(fq){return function(fr){return fq.extract_user_data_and_call(fr,fq.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fq){return function(fs){var fr,ft;fs.preventDefault();fr=bF(fs.currentTarget);ft=fr.data("email");return window.location=G({scheme:"mailto",path:ft}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fq){return function(fr){return fq.extract_invitee_data_and_call(fr,fq.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fq){return function(fr){return fq.extract_invitee_data_and_call(fr,fq.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fq.user,fq.log_extras);return fq.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fq.user,fq.log_extras);return fq.show_unshare_folder_modal()}})(this));this.$root.on("click","a.unshare_folder_link",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fq.user,fq.log_extras);return fq.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fq){return function(fr){fr.preventDefault();return fq._disable_token_for_sf(function(){return d1.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fq){return function(fr){var fs;fr.preventDefault();fs=function(){var ft;ft=d8.get_containing_modal(fq.$root);if(ft&&ft instanceof cD){return ft.fetch()}};return fq._disable_token_for_sf(fs)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fq){return function(fr){fr.preventDefault();return fq.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_done_button",fq.user,fq.log_extras);d1.trigger(i.MODAL_DONE_VIEWING_EVENT);return d1.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fq){return function(fs){var fr;fr=bF(fs.currentTarget);return fq.update_sf_perms(fr.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fq){return function(fs){var fr;fr=bF(fs.currentTarget);return fq.update_tf_access(!fr.prop("checked"))}})(this))};i.prototype._disable_token_for_sf=function(j){return cE.WebRequest({url:G({path:"/sm/disable_token_at_path"+aA.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(T){return function(){bF(document).trigger(dN.UPDATE);ah.success(eB("Link removed"));ba.SimpleSharingLogger.log(T.user.id,25);return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(){return ah.error(eB("An error occurred when removing link"))}})(this)})};i.prototype.create_m2_inband_modal=function(T,j){T.preventDefault();d1.pop();if(j){ba.SimpleSharingLogger.log(this.user.id,32)}else{ba.SimpleSharingLogger.log(this.user.id,30)}return eG.createAndShowM2InbandModal(this.user,this.path)};i.prototype.extract_invitee_data_and_call=function(fo,fn){var j,fp,T;fo.preventDefault();j=bF(fo.currentTarget);T=j.data("email-or-fbname");fp=j.data("invite-id");return fn(T,this.ns_id,fp)};i.prototype.extract_user_data_and_call=function(fq,fp){var T,fo,fn,j;fq.preventDefault();T=bF(fq.currentTarget);fn=T.data("display-name");fo=T.data("email");j=T.data("user-id");return fp(fn,fo,j)};i.prototype.maybe_load_more=function(){var T,j,fn;j=this.$root.closest("body").length;if(!j){return}if((this.num_total==null)||(this.start>=this.num_total)){bF("#more-members-spinner").hide();return}bF("#more-members-spinner").show();fn={};fn[a9.UID_PARAM_NAME]=this.user.id;fn.start=this.start;fn.max_results=this.max_results;T=G({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new by(this.$root,T,{data:fn,success:(function(fo){return function(fs,fp,ft){var fr,fq;if(((fq=fs.data)!=null?fq.options:void 0)!=null){fr=fs.data.options;if((fo.members!=null)&&(fr.folder_members!=null)){Array.prototype.push.apply(fo.members,fr.folder_members)}if((fo.invitees!=null)&&(fr.folder_invitees!=null)){Array.prototype.push.apply(fo.invitees,fr.folder_invitees)}if((fo.new_style_groups!=null)&&(fr.new_style_groups!=null)){return Array.prototype.push.apply(fo.new_style_groups,fr.new_style_groups)}}}})(this),error:(function(fo){return function(fr,fp,fq){return ah.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};i.prototype.submit_invitations=function(){var fo,fn,fq,T,fp,j;this.invite_form_controller.tokenize();fq=this.invite_form_controller.extract_invitees();fp=this.invite_form_controller.get_custom_message();fo=this.invite_form_controller.get_access_type();T=bx.clone(this.log_extras);T.access_type=fo;ba.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,T);j=(function(fr){return function(ft){var fs;fs=d8.get_containing_modal(fr.$root);if(fs&&fs instanceof cD){fs.fetch()}else{d1.pop()}ah.success(ft.responseText);return document.fire(aH.SF_INVITE,{target_ns_id:fr.ns_id,user_id:fr.user.id})}})(this);fn=(function(fr){return function(fs){return eL.show_validation_error(fs,fr.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fq,fp,fo,j,fn)};i.prototype.reinvite_user=function(fn,j,T){return this.sharing_api.reinvite_user(j,T,(function(fo){return function(fv){var fs,ft,fu,fr,fp,fq;fr=JSON.parse(fv.responseText);fp=fr.status;if(fp==="OK"){fq=eB("%(email_or_fbname)s was reinvited successfully");fq=fq.format({email_or_fbname:fn});return ah.success(fq)}else{fu=fr.reason;if(fu==="ACCEPTED"){fs=eB("That invitation has already been accepted.")}else{if(fu==="DECLINED"){fs=eB("That invitation has already been declined.")}else{fs=eB("You no longer have permission to perform this action.")}}ah.error(fs);if(fr.reload){ft=d8.get_containing_modal(fo.$root);if(ft&&ft instanceof cD){return ft.fetch()}}}}})(this))};i.prototype.update_sf_perms=function(T){var fn,fo,j;this.$root.find("#change-sf-perm-saving").show();fn=(T?1:0);j=(function(fp){return function(fq){if(T){ah.success(eB("Editors can now manage membership of this folder."))}else{ah.success(eB("Editors can no longer manage membership of this folder."))}return fp.$root.find("#change-sf-perm-saving").hide()}})(this);fo=(function(fp){return function(fq){if(fq.responseText.indexOf("err:")===0){ah.error(fq.responseText.substr(4))}else{ah.error(eB("Error updating your preference! Please try again."))}return fp.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,fn,j,fo)};i.prototype.update_tf_access=function(T){var fn,j;j=(function(fo){return function(fp){if(T){return ah.success(eB("Team members can now change folder contents."))}else{return ah.success(eB("Team members can no longer change folder contents."))}}})(this);fn=(function(fo){return function(fp){return ah.error(eB("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,T,j,fn)};i.prototype.show_kick_user_modal=function(fn,T,j){return d1.push(new eS(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:fn,folder_path:this.path,user_id:j}))};i.prototype.show_kick_group_modal=function(j,T){return d1.push(new aV(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:j,folder_path:this.path,group_id:T}))};i.prototype.show_transfer_user_modal=function(fn,T,j){return d1.push(new bM(this.user,{element_id:"transfer-confirm-modal",user_id:j,user_name:fn,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_uninvite_modal=function(fn,j,T){return d1.push(new aJ(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:fn,ns_id:j,invite_id:T,folder_path:this.path}))};i.prototype.show_unshare_folder_modal=function(){return d1.push(new b5(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,nested_shared_folder:this.nested_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_access_request_link_modal=function(){return d1.push(new dh(this.user.id,this.path,void 0,true))};i.prototype.show_owner_leave_folder_warning=function(){return ah.error(eB("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};i.prototype.show_leave_folder_modal=function(){return d1.push(new dw(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.toggle_get_link_button_visibility=function(){var fq,fp,fo,fn,T,j;fp=((fo=this.invite_form_controller)!=null?fo.get_token_count():void 0)===0;fq=((fn=this.$invite_input)!=null?fn.val():void 0)==="";if(fp&&fq){return(T=this.get_link_button)!=null?T.show():void 0}else{return(j=this.get_link_button)!=null?j.hide():void 0}};i.prototype.toggle_to_invite_mode=function(){var j;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if((j=this.sf_access_type)!=null){j.show()}this.toggle_get_link_button_visibility();if(!this.has_show_invite_form&&this.get_link_button.length>0){ba.SimpleSharingLogger.log(this.user.id,31)}this.has_show_invite_form=true;return bF(document).trigger("collab:m2:prompt:hide")};i.prototype.toggle_from_invite_mode=function(){var T,j;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((T=this.sf_access_type)!=null){T.hide()}if((j=this.invite_form_controller)!=null){j.reset_autocompleter()}return this.toggle_get_link_button_visibility()};i.prototype.show_m2_folder_settings=function(T){var fn,j;j=this.path;fn=function(){var fo;fo=new dg(ct.active_user,j);return fo.show()};d1.pop();return ae.showInstance(dC.createElement(ae,{user:this.user,fq_path:this.path,is_shared_folder:true,ns_id:this.ns_id,initial_allows_editor_manage_membership:this.allows_editor_manage_membership,done_callback:fn}))};i.prototype.show_folder_settings=function(j){ba.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);j.preventDefault();d1.register(ex.SAVED_PERMISSIONS,(function(T){return function(fo,fn){if(fn!=null){return T.set_team_only(fn)}}})(this));return d1.push(new ex(this.user,this.path,this.ns_id))};i.prototype.show_golden_gate_warning=function(j){j.preventDefault();return d1.push(new c6(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype.show_email_verification=function(j){d1.pop();return d4.get_for_user(this.user).show()};i.prototype.set_team_only=function(j){var T;this.invite_form_controller.set_team_only(j);T=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(j){return T.addClass("team-only")}else{return T.removeClass("team-only")}};return i})();dw=E.LeaveFolderModal=(function(i){fe(j,i);function j(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fn){var T;fn.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,T,(function(fo){return function(){var fp;fp=eB("You removed yourself from '%(msg)s'.").format({msg:bU.em_snippet(aA.filename(fo.path),25)});ah.success(fp);document.fire(aH.SF_LEAVE,{target_ns_id:fo.ns_id,folder_deleted:!T,user_id:fo.user.id});return d1.clear()}})(this))};j.prototype.on_show=function(){j.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};j.prototype.before_show=function(){var T;T=eB("Leave the shared folder '%(folder_name)s'");T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),14)});return this.format({".db-modal-title-text":T})};return j})(dR);b5=E.UnshareFolderModal=(function(j){fe(i,j);function i(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return i.__super__.constructor.apply(this,arguments)}i.prototype.on_confirm_button_click=function(fn){var T;fn.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,T,(function(fo){return function(){var fp;fp=eB("Unshared folder '%(folder_name)s'");fp=fp.format({folder_name:bU.em_snippet(aA.filename(fo.path),25)});ah.success(fp);document.fire(aH.SF_UNSHARE,{target_ns_id:fo.ns_id,user_id:fo.user.id});return d1.clear()}})(this))};i.prototype.on_show=function(){i.__super__.on_show.apply(this,arguments);this.$modal_window.find(".tsf_unshare_desc").hide();this.$modal_window.find(".nestedsf_unshare_desc").hide();this.$modal_window.find(".regular_unshare_desc").hide();if(this.team_shared_folder){return this.$modal_window.find(".tsf_unshare_desc").show()}else{if(this.nested_shared_folder){return this.$modal_window.find(".nestedsf_unshare_desc").show()}else{return this.$modal_window.find(".regular_unshare_desc").show()}}};i.prototype.before_show=function(){var T;if(this.nested_shared_folder){T=eB("Reset membership for '%(folder_name)s'")}else{T=eB("Unshare '%(folder_name)s'")}T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),21)});return this.format({".db-modal-title-text":T})};return i})(dR);aJ=E.UninviteModal=(function(j){fe(i,j);function i(T,fn){this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.email_or_fbname=fn.email_or_fbname;this.ns_id=fn.ns_id;this.invite_id=fn.invite_id;i.__super__.constructor.call(this,T,fn)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(fn){return function(ft){var fr,fs,fq,fo,fp;fq=JSON.parse(ft.responseText);fo=fq.status;if(fo==="OK"){fp=eB("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:fn.email_or_fbname});ah.success(fp)}else{fs=fq.reason;if(fs==="ACCEPTED"){fr=eB("That invitation has already been accepted.")}else{if(fs==="DECLINED"){fr=eB("That invitation has already been declined.")}}ah.error(fr)}return d1.pop()}})(this))};i.prototype.before_show=function(T){var fn;fn=eB("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bU.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":aA.filename(this.path),".db-modal-title-text":fn})};return i})(dR);eS=E.KickUserModal=(function(i){fe(j,i);function j(fn,T){this.user=fn;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(fo){var T,fn;fo.preventDefault();T=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,T,(function(fp){return function(){ah.success(eB("User removed successfully."));bZ.reload_folder_info_if_two_account();return d1.pop()}})(this));fn={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:T};return ba.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,fn)};j.prototype.before_show=function(T){var fn;fn=eB("Remove %(person_name)s from this folder?");fn=fn.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":fn})};return j})(dR);aV=E.KickGroupModal=(function(i){fe(j,i);function j(fn,T){this.user=fn;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.group_id=this.options.group_id;this.group_name=this.options.group_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(fn){return function(){ah.success(eB("Group removed successfully."));bZ.reload_folder_info_if_two_account();return d1.pop()}})(this))};j.prototype.before_show=function(){var T;T=eB("Remove %(group_name)s from this folder?");T=T.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":T})};return j})(dR);cw=E.MakeOwnerModal=(function(j){fe(i,j);function i(fn,T){this.user=fn;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.member_uid=this.options.member_uid;this.member_name=this.options.member_name;this.ns_id=this.options.ns_id;this.access_type=this.options.access_type;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(fn){return function(){ah.success(eB("%(name)s now is the owner.").format({name:fn.member_name}));return d1.pop()}})(this))};i.prototype.before_show=function(){var T;T=eB("Make %(name)s the owner of this folder?");T=T.format({name:bU.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":T})};return i})(dR);bM=E.TransferOwnershipModal=(function(j){fe(i,j);function i(fn,T){this.user=fn;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(fn){return function(fo){ah.success(eB("Ownership changed successfully"));return d1.pop()}})(this))};i.prototype.before_show=function(){var T;T=eB("Make %(person_name)s the owner of this folder?");T=T.format({person_name:bU.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":T})};return i})(dR);ex=E.ExistingSharedFolderPermissionsModal=(function(i){fe(j,i);j.SAVED_PERMISSIONS="existing_sf_permissions:saved";function j(fr,fp,T,fq){var fo,fn;this.user=fr;this.path=fp;this.ns_id=T;this.on_hide=fq;fo={ns_id:this.ns_id,folder_name:this.path};fo[a9.UID_PARAM_NAME]=this.user.id;fn=eB("'%(folder_name)s' settings");fn=fn.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fn,endpoint_url:"/share_ajax/folder_settings",parameters:fo})}return j})(cD);c6=c6=(function(i){fe(j,i);function j(fp,T){var fo,fn;this.user=fp;this.ns_id=T;fo={ns_id:this.ns_id};fo[a9.UID_PARAM_NAME]=this.user.id;fn=eB("Confirm converting to Golden Gate folder");j.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fn,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fo})}return j})(cD);dB=E.GoldenGateWarningModalContents=(function(){function i(j,T,fn){this.$form=j;this.ns_id=fn;this._submit=b3(this._submit,this);this.user=cM.get_viewer().get_user_by_id(T);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._submit=function(j){return d1.push(new bv(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype._cancel=function(j){return d1.pop()};return i})();bv=bv=(function(j){fe(i,j);function i(fp,T){var fo,fn;this.user=fp;this.ns_id=T;fo={ns_id:this.ns_id};fo[a9.UID_PARAM_NAME]=this.user.id;fn=eB("Confirm converting to Golden Gate folder");i.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fn,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fo})}return i})(cD);ff=E.GoldenGateConfirmModalContents=(function(j){fe(i,j);function i(T,fn,fo){this.$form=T;this.ns_id=fo;this.user=cM.get_viewer().get_user_by_id(fn);new ch(this.$form,null,{should_submit_once:true});this.$form.on(ch.SUCCESS_EVENT,(function(fp){return function(){return cE.WebRequest({url:"/share_ajax/enable_golden_gate_step_two",subject_user:fp.user,data:{ns_id:fp.ns_id},success:function(){ah.success("Golden Gate enabled for this folder");return location.reload()}})}})(this));this._listen()}i.prototype._listen=function(){return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(T){return d1.pop()};return i})(cD);R=E.ExistingSharedFolderPermissionsContent=(function(){function i(j,T,fn){this.$form=j;this.ns_id=fn;this._submit=b3(this._submit,this);this.user=cM.get_viewer().get_user_by_id(T);this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d1.pop()};i.prototype._submit=function(fq){var fr,j,fp,fn,fo,T;fq.preventDefault();j=this.$form.find("input[name=audience]:checked").val();fp=this.$form.find("input[name=inviter]:checked").val();T=this.$form.find("input[name=shared_link_policy]:checked").val();fr=(fo=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fo.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,j,fp,T,fr,(function(fs){return function(fu){var ft,fv;ft=JSON.parse(fu.responseText);fv=ft.team_only_invite;ah.success(ft.message);d1.trigger(ex.SAVED_PERMISSIONS,fv);return d1.pop()}})(this));false;fn={ns_id:this.ns_id,audience:j,inviter:fp};return ba.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,fn)};return i})();var a1,d7,eV,dY,a2,eL,cp,cB,al,eq,db,cf,bS,cZ,cY,cW,cU,fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};a1=E.BaseShareAFolderWizardModal=(function(i){fe(j,i);j.prototype.base_title=null;j.prototype.personal_title=null;j.prototype.work_title=null;function j(T,fn){this.user=T;this.options=fn;j.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}j.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=this.base_title;if(cM.get_viewer().is_paired){if(this.user.role==="personal"){T=this.personal_title}else{T=this.work_title.format({team_name:cM.get_viewer().team_name})}}return this.format({".db-modal-title-text":T})};return j})(d8);eq=E.ShareAFolderWizardModal=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;j.__super__.constructor.call(this,this.user,this.options);this.base_title=eB("Share a folder");this.personal_title=eB("Share a folder from your personal Dropbox");this.work_title=eB("Share a folder from your %(team_name)s Dropbox")}j.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fn){fn.preventDefault();s.start_wizard_without_user();return T.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(T){return function(fn){bF(fn.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(T.$modal_window.find("input#create-new-sf").is(":checked")){return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",T.user)}}})(this))};j.prototype.on_confirm_button_click=function(fs){var fp,fr,T,fo,fq,fn;fs.preventDefault();fr=this.$modal_window.find("input#create-new-sf").is(":checked");if(fr){fo=null;if(this.user.role==="work"){fq="shared-folder-type-wizard-modal";fn=d8.get_template(fq);if(fn.length){fo=new bS(this.user,{element_id:fq})}}if(fo===null){fo=new cf(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();T={selection:"new_folder"};ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T);return fo.show()}fp=this.$modal_window.find(".ajax-loading-indicator").show();return bF.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(ft){return function(fu){var fv;fu=JSON.parse(fu);if(fu===true){fo=new db(ft.user,{element_id:"share-existing-folder-wizard-modal"});T.has_existing_folder=true}else{fv=eB("You don't have any existing folders. Please create and share a new folder.");fo=new cf(ft.user,{element_id:"share-new-folder-wizard-modal",error_msg:fv});T.has_existing_folder=false}ft.hide();return fo.show()}})(this),error:(function(ft){return function(){return ah.error()}})(this),complete:(function(ft){return function(){return fp.hide()}})(this)},T={selection:"existing_folder"},ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T))};return j})(a1);bS=E.SharedFolderTypeWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;i.__super__.constructor.call(this,this.user,this.options);this.work_title=eB("Share a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fn){fn.preventDefault();s.start_wizard_for_user(T.user);return T.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(T){return function(fn){bF(fn.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(T.$modal_window.find("input#team-folder-option").is(":checked")){return ba.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",T.user)}}})(this))};i.prototype.on_confirm_button_click=function(fq){var T,fo,fp,fn;fq.preventDefault();T=(function(fr){return function(fu,fs){var ft;fu.preventDefault();fs.hide();ft=new fr.constructor(fr.user,fr.options);return ft.show()}})(this);fo=this.$modal_window.find("input#team-folder-option").is(":checked");if(fo){fp=new dW({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:T});fn="team_folder"}else{fp=new cf(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:T});fn="shared_folder"}ba.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:fn});this.hide();return fp.show()};return i})(a1);eL=E.InlineModalValidationError=(function(){function i(){}i.show_validation_error=function(fs,fo){var fp,fq,fn,T,fr,j;if(fs.responseText.indexOf("err:{")===0){j=fs.responseText.substr(4);fr=JSON.parse(j);for(fq in fr){fp=fr[fq];if("message_text" in fp){T=fo.find("span.error-message");if(T.length===0){T=bF("<span/>").addClass("error-message");fo.prepend(T)}T.text(fp.message_text);return}}fo.find("span.error-message").remove();return ah.error()}else{fo.find("span.error-message").remove();if(fs.responseText.indexOf("err:")===0){fn=fs.responseText.substr(4);return ah.error(fn)}else{return ah.error()}}};return i})();cZ=E.TeamSharedFolderWizardModalPage1=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=eB("Now, let's set up your team");this.options.vertical_offset=5}j.prototype.on_show=function(){var fo,fn,T,fp;fp=this.$modal_window.find(".suggestion-input");for(fn=0,T=fp.length;fn<T;fn++){fo=fp[fn];c5.register($(fo))}this.$modal_window.find("#validate-team-name").submit((function(fq){return function(fr){fr.preventDefault();return fq.on_confirm_button_click(fr)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return ba.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};j.prototype.on_confirm_button_click=function(fp){var fn,T,fo;fp.preventDefault();fo=this.$modal_window.find("#new-team-shared-folder-name-input").val();T=(function(fq){return function(){var fr;fr=new cY(fq.user,{team_name:fo,element_id:"team-shared-folder-wizard-modal-page2"});fq.hide();return fr.show()}})(this);fn=(function(fq){return function(fr){ba.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fq.user);return eL.show_validation_error(fr,fq.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fo,T,fn)};j.prototype.__fix_position=function(fn){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);cY=E.TeamSharedFolderWizardModalPage2=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;this.__fix_position=b3(this.__fix_position,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=eB("Invite teammates");this.folder_name=this.options.team_name}j.prototype.before_show=function(){var T;T=eB("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":T})};j.prototype.on_show=function(){ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(T){return function(fn){fn.preventDefault();return T.on_confirm_button_click(fn)}})(this))};j.prototype.on_confirm_button_click=function(fq){var fo,fn,fp,fs,T,fr;fq.preventDefault();fs={emails:[]};ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(T=fp=1;fp<=10;T=++fp){fo=this.$modal_window.find("#new-team-shared-folder-email"+T).val();if(fo){fs.emails.push(fo)}}fn=d4.getForRole(ct.active_user.role);if(!fn.verified_or_show()){ba.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return fn.send_email("share_folder",(function(ft){return function(){var fu;fu=new cW(ft.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:ft.folder_name,invitees:fs,from_email_verification:true});ft.hide();return fu.show()}})(this))}else{ba.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fr=new cW(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fs,from_email_verification:true});this.hide();return fr.show()}};j.prototype.__fix_position=function(fn){var T;T=this.$modal_window.find(".db-modal");T.css;return{margin:"0",position:"fixed"}};return j})(a1);cW=E.TeamSharedFolderWizardModalPage3=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=eB("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}j.prototype.on_show=function(){var fr,fp,fo,fn,ft,fs,fq,T;ba.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fu){return function(fv){fv.preventDefault();return fu.on_close_button_click(fv)}})(this));ft="";fs=true;fp=false;fn="all";fq=false;fr=null;T=(function(fu){return function(fx){var fv,fw;fv=JSON.parse(fx.responseText);ah.success(fv.success_msg);fw=new cU(fu.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fu.options.folder_name,invitees:fu.options.invitees,from_email_verification:true});fu.hide();return fw.show()}})(this);fo=(function(fu){return function(fv){return fu.hide()}})(this);return this.sharing_api.share_folder(fs,this.options.folder_name,this.options.invitees,ft,fp,fn,fq,fr,false,T,fo)};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.hide()};j.prototype.__fix_position=function(fn){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);cU=E.TeamSharedFolderWizardModalPage4=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;this.__fix_position=b3(this.__fix_position,this);i.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=eB("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}i.prototype.before_show=function(){var T;T=this.$modal_window.find("#back_to_home");T.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};i.prototype.on_show=function(){return ba.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};i.prototype.__fix_position=function(fn){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return i})(a1);cf=E.ShareNewFolderWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;this.options.focus="#new-shared-folder-wizard input[type=text]";i.__super__.constructor.call(this,this.user,this.options);this.base_title=eB("Create a new shared folder");this.personal_title=eB("Create a shared folder in your personal Dropbox");this.work_title=eB("Create a shared folder in your %(team_name)s Dropbox")}i.prototype.on_show=function(){var fo,fn,T,fp;fp=this.$modal_window.find(".suggestion-input");for(fn=0,T=fp.length;fn<T;fn++){fo=fp[fn];c5.register($(fo))}this.$modal_window.find("#validate-folder-name").submit((function(fq){return function(fr){fr.preventDefault();return fq.on_confirm_button_click(fr)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fq){return function(fr){if(fq.options.back_fn){return fq.options.back_fn(fr,fq)}else{fr.preventDefault();fq.hide();return s.start_wizard_for_user(fq.user)}}})(this))};i.prototype.on_confirm_button_click=function(fp){var fo,fq,fn,T;fp.preventDefault();fq=this.$modal_window.find("#new-shared-folder-name-input").val();fn={folder_name:fq};ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,fn);bF(document).trigger("db:share_new_folder:next");T=(function(fr){return function(){var fs;fs=new cp(fr.user,{folder_name:fq,element_id:"invite-to-new-sf-wizard-modal-"+fr.user.id});fr.hide();fs.new_folder=true;fs.show();return ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fr.user,fn)}})(this);fo=(function(fr){return function(fs){var ft;ft=ch.extract_errors(fs.responseText);ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fr.user,fn);if(ft===false){}else{if(typeof ft==="string"){return ah.error(ft)}else{bF("#new-shared-folder-name-input .error-message").remove();return ch.fill_errors(bF("#validate-folder-name"),ft)}}}})(this);return this.sharing_api.validate_new_sf_path(fq,T,fo)};return i})(a1);db=E.ShareExistingFolderWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;this._hide=b3(this._hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.user,this.options);this.base_title=eB("Choose folder to share");this.personal_title=eB("Choose a folder from your personal Dropbox");this.work_title=eB("Choose a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bF("#"+this.treeview_id).parent().attr("id");b2.schedule_reset();b2.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(T){return function(){var fn;bF(document).on("db:treeview_selected",function(fp,fo){return T.folder_name=fo});fn=bF(".first-treeview-link");if(!d6.ie){return fn.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(T){return function(fn){fn.preventDefault();T.hide();return s.start_wizard_for_user(T.user)}})(this))};i.prototype._hide=function(){b2.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return i.__super__._hide.apply(this,arguments)};i.prototype.on_hide=function(){return bF(document).off("db:treeview_selected")};i.prototype.on_confirm_button_click=function(fp){var fo,fn,T;fn={folder_name:this.folder_name};fp.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,fn);return s.show_shared_folder_options_modal(this.folder_name,this.user)}else{T=(function(fq){return function(){var fr;fr=new cp(fq.user,{folder_name:fq.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fq.user.id});fq.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fq.user,fn);fr.new_folder=false;return fr.show()}})(this);fo=(function(fq){return function(fr){return eL.show_validation_error(fr,fq.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,T,fo)}};return i})(a1);a2=E.CreateOrShareNewFolderWizardModal=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this._extract_invitees=b3(this._extract_invitees,this);this._toggle_send_button_state=b3(this._toggle_send_button_state,this);j.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bm(this.user);this.state="Create"}j.prototype.on_show=function(){var fn,fo,fq,fp,T;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fq="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fo=fq+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fo);fn={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fo,fq+"-new-whobulk",fq+"-hidden-input",fn);if((fp=this.file_name_input)!=null){fp.keyup(this._toggle_send_button_state)}if((T=this.collab_input)!=null){T.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};j.prototype._toggle_send_button_state=function(){var fp,fo,fn,T;T=((fo=this.autocompleter)!=null?fo.token_manager.tokens.length:void 0)===0;T=T&&this.collab_input.val()==="";fp=this.file_name_input.val();fn=fp==="";this.$send_button.prop("disabled",fn);if(T){this.$send_button.text(eB("Create folder"));return this.state="Create"}else{this.$send_button.text(eB("Share folder"));return this.state="Share"}};j.prototype._extract_invitees=function(){var fs,fo,fr,fp,fn,ft,T,fq;fr=this.$modal_window.find(".tokenized_autocompleter_container");ft={};fq=["emails","fb_ids","group_ids","new_style_group_ids"];for(fp=0,T=fq.length;fp<T;fp++){fo=fq[fp];fn=fr.find("input[name="+fo+"]");ft[fo]=(function(){var fv,fu,fw;fw=[];for(fv=0,fu=fn.length;fv<fu;fv++){fs=fn[fv];fw.push(bF(fs).val())}return fw})()}return ft};j.prototype.on_confirm_button_click=function(fx){var fo,fu,fr,fz,fs,fv,fp,fq,T,ft,fw,fy,fn;fx.preventDefault();T=this.file_name_input.val();fz=eB("We can\u2019t create folder '%(folder_name)s'");fz=fz.format({folder_name:T});fr=function(){return ah.error(fz)};if(this.state==="Create"){fn="/cmd/new"+d6.urlquote(this.destination_dir);ft={to_path:T};ft[a9.UID_PARAM_NAME]=this.user.id;fy=function(){var fA;fA=eB("Created new folder '%(folder_name)s'");fA=fA.format({folder_name:T});return ah.success(fA)};new cE.WebRequest({url:fn,data:ft,success:fy,error:fr})}else{this.autocompleter.tokenize_emails_input(true);fv=this._extract_invitees();fy=function(){var fA;fA=eB("Shared new folder '%(folder_name)s'");fA=fA.format({folder_name:T});return ah.success(fA)};fq="";fu=false;fp="all";fw=false;fo=null;fs=this.destination_dir+"/"+T;this.sharing_api.share_path(fs,fv,fq,fu,fp,fw,fo,false,fy,fr)}return this.hide()};return j})(d8);dY=E.CreateLinkOrInviteToFolderWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eB("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.options.path),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var T,fn,fo;T="edu_modal";fo=(fn=this.options.target_item)!=null?fn:null;ba.ShmodelUILogger.log("view",T,fo);this.$modal_window.find(".option-to-share-folder").on("click",(function(fp){return function(fr){var fq;if(fp.options.existing_sf){ba.ShmodelUILogger.log("sf_options",T,fo);fq=new dg(ct.active_user,fp.options.path)}else{ba.ShmodelUILogger.log("sf_invite",T,fo);fq=new cp(fp.user,{folder_name:fp.options.path,element_id:"invite-to-new-sf-wizard-modal-"+fp.user.id})}fp.hide();return fq.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(fp){return function(fq){ba.ShmodelUILogger.log("token_share",T,fo);dx.shmodel(fp.options.path,"create_link_or_invite_to_folder_modal");return fp.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(fp){return function(fq){fq.preventDefault();ba.ShmodelUILogger.log("clicked_learn_more",T,fo);return window.open("/help/274","_blank")}})(this))};return i})(d8);cp=E.InviteToNewSharedFolderWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;this.insert_folder_settings=b3(this.insert_folder_settings,this);this.share_folder=b3(this.share_folder,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.show_settings_modal=b3(this.show_settings_modal,this);this.show_m2_settings_modal=b3(this.show_m2_settings_modal,this);this._toggle_get_link_button_visibility=b3(this._toggle_get_link_button_visibility,this);this.options.focus=".new-collab-input";i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false;this.has_inviter_restriction=this.options.has_inviter_restriction}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eB("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var fn,fp,fo,T,fr,fq;fq=this.$modal_window.find(".suggestion-input");for(fo=0,T=fq.length;fo<T;fo++){fp=fq[fo];c5.register($(fp))}fn=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fr="invite-wizard-"+this.user.id;this.invite_form_controller=new df(this.user,fn,[],[],[],fr);this.insert_folder_settings(this.invite_form_controller.team_only?"team":"")}else{this.invite_form_controller.listen()}this.get_link_button=this.$modal_window.find(".get-editable-link-invite");if(this.get_link_button.length>0){B.showInstance(dC.createElement(B,{onDismiss:eG.dismissM2Prompt,shouldShow:ct.simple_sharing_show_m2_prompt,targetedButton:this.get_link_button.get(0)}));ba.SimpleSharingLogger.log(this.user.id,27)}this.collab_input=this.$modal_window.find(".new-collab-input");this.collab_input.focus();this.collab_input.keyup(this._toggle_get_link_button_visibility);if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_get_link_button_visibility);this.collab_input[0].on("token:add",this._toggle_get_link_button_visibility)}this.$modal_window.find(".change-new-folder-settings").on("click",(function(fs){return function(ft){ft.preventDefault();return fs.show_settings_modal()}})(this));this.$modal_window.find(".m2-settings-link").on("click",(function(fs){return function(ft){ft.preventDefault();return fs.show_m2_settings_modal()}})(this));this.$modal_window.find(".get-editable-link-invite").on("click",(function(fs){return function(fx){var fy,fw,fu,ft,fv;fx.preventDefault();bF(document).trigger("collab:m2:prompt:dismiss");ft=fs.$modal_window.find(".m2-settings-link");if(ft.length>0){fs.inviter_restriction=fs.has_inviter_restriction?"me":"all"}ba.SimpleSharingLogger.log(fs.user.id,28);fy=fs.$modal_window.find(".get-link-invite-loading");if(fy!=null){fy.show()}fv=function(fB){var fD,fC,fF,fA,fz,fE;if(fy!=null){fy.hide()}fA=bb.parse_response(fB),fE=fA[0],fF=fA[1];if(fE){return eG.createAndShowM2InbandModal(fs.user,fs.folder_name)}else{fz=bb.parse_error(fF),fC=fz[0],fD=fz[1];if(fC){return ah.error(fD)}else{return ah.error(eB("Failed to create link."))}}};fu=function(){if(fy!=null){fy.hide()}return ah.error(eB("Failed to create link."))};fw={path:fs.folder_name,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:true,folder_settings:1,shared_link_policy:fs.shared_link_policy_restriction,audience:fs.audience_restriction,inviter:fs.inviter_restriction};if(fs.audience_restriction||fs.inviter_restriction){fw.custom_folder_settings=1}return cE.FormWebRequest({subject_user:fs.user.id,url:"/share_ajax/existing_no_recipient",data:fw,success:fv.bind(fs),error:fu.bind(fs),skipErrorHandling:true})}})(this));this.log_extras={path:this.folder_name};ba.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return ba.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};i.prototype._toggle_get_link_button_visibility=function(){var fq,fp,fo,fn,T;if(this.shared_link_policy_restriction==="1"){if((fo=this.get_link_button)!=null){fo.hide()}return}fp=this.invite_form_controller.get_token_count()===0;fq=this.collab_input&&this.collab_input.val()==="";if(fp&&fq){return(fn=this.get_link_button)!=null?fn.show():void 0}else{return(T=this.get_link_button)!=null?T.hide():void 0}};i.prototype.show_m2_settings_modal=function(){var fn,T;fn=this.folder_name;T=function(fo){var fp;fp=new i(ct.active_user,{folder_name:fn,element_id:"invite-to-new-share-file-wizard-modal-"+ct.active_user.id,has_inviter_restriction:!fo});return fp.show()};d1.pop();return ae.showInstance(dC.createElement(ae,{user:this.user,fq_path:this.folder_name,is_shared_folder:false,initial_allows_editor_manage_membership:!this.has_inviter_restriction,done_callback:T}))};i.prototype.show_settings_modal=function(){var fn,T;T=eB("'%(folder_name)s' settings");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),13)});fn={folder_name:this.folder_name};if(this.audience_restriction){fn.audience=this.audience_restriction}if(this.inviter_restriction){fn.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){fn.shared_link_policy=this.shared_link_policy_restriction}fn[a9.UID_PARAM_NAME]=this.user.id;if(this.is_file){fn.is_file=this.is_file}d1.register(cB.SAVED_PERMISSIONS,(function(fo){return function(fq,fp){fo.insert_folder_settings(fp.audience,fp.inviter,fp.shared_link_policy);return fo.invite_form_controller.reset_options()}})(this));return d1.push(new cD({element_id:"folder-permissions-modal",title:T,endpoint_url:"/share_ajax/default_folder_settings",parameters:fn}))};i.prototype.on_confirm_button_click=function(fq){var fp,fo,fs,fn,T,fr;fq.preventDefault();this.invite_form_controller.tokenize();fs=this.invite_form_controller.extract_invitees();fr=this.invite_form_controller.get_custom_message();fp=this.invite_form_controller.get_access_type();fn=this.$modal_window.find("input#allow_other_members_to_share");if(fn.length>0){this.inviter_restriction=fn.is(":checked")?"all":"me"}T=this.$modal_window.find(".m2-settings-link");if(T.length>0){this.inviter_restriction=this.has_inviter_restriction?"me":"all"}if(this.is_file){fo=new eV(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:fs,msg:fr,access_type:fp,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();fo.show();return ba.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(fs,fr,fp,true,false)}};i.prototype.share_folder=function(fr,fo,T,fs,fq,fn){var fw,fp,ft,fv,fu;if(fs==null){fs=true}if(fq==null){fq=false}if(fn==null){fn=false}fp=(function(fx){return function(fy){return eL.show_validation_error(fy,fx.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fv=(function(fx){return function(fA){var fz,fy;fy=JSON.parse(fA.responseText);ah.success(fy.success_msg);if(fx.progress_ever_blocked_by_verify){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fx.user,ft)}document.fire(aH.SF_NEW,{sf_info:bZ.decode_sort_key(fy.sf_info)});if(fs){fx.hide()}if(fn){fz=new dg(fx.user,aA.normalize(fx.folder_name));return fz.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,ft);this.$modal_window.find(".confirm-button").prop("disabled",true);fu=eB("Verification email sent to %(email)s").format({email:this.user.email});fw=d4.get_for_user(this.user);fw.send_email("share_folder",function(){return ah.success(fu)});bF("#resend-email-verification-link").click(function(){return fw.send_email("share_folder",function(){return ah.success(fu)})});this.$modal_window.find(".email-verify-message").show();return fw.ensure_polling((function(fx){return function(){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fx.user,ft);ah.success(eB("Email verified. Try sharing your folder again."));fx.$modal_window.find(".confirm-button").prop("disabled",false);return fx.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,fr,fo,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,T,fq,fv,fp);ft={path:this.folder_name,access_type:T};ba.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,ft);return bF(document).trigger("db:invite_to_new_folder:share")}};i.prototype.insert_folder_settings=function(T,fn,fp){var fo;this.audience_restriction=T;this.inviter_restriction=fn;this.shared_link_policy_restriction=fp;fo=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(ct.inside_team_folder){fo.addClass("in-team-folder");fo.removeClass("team-only")}else{fo.removeClass("in-team-folder");if(this.audience_restriction==="team"){fo.addClass("team-only")}else{fo.removeClass("team-only")}if(this.user.role==="work"){this.invite_form_controller.set_team_only(this.audience_restriction==="team")}}return this._toggle_get_link_button_visibility()};return i})(d8);al=E.NewSharedFolderPermissionsModal=(function(i){fe(j,i);function j(fn,fr,T,fo){var fq,fp;this.user=fn;this.path=fr;this.saved_state=T;this.done_callback=fo;fq={folder_name:this.path,audience:this.saved_state.audience?this.saved_state.audience:void 0,inviter:this.saved_state.inviter?this.saved_state.inviter:void 0,shared_link_policy:this.saved_state.shared_link_policy?this.saved_state.shared_link_policy:void 0,is_file:false};fq[a9.UID_PARAM_NAME]=this.user.id;fp=eB("\u2018%(folder_name)s\u2019 settings");fp=fp.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});d1.register(cB.SAVED_PERMISSIONS,(function(fs){return function(fu,ft){return fs.done_callback.bind(null,ft.audience,ft.inviter,ft.shared_link_policy)()}})(this));j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fp,endpoint_url:"/share_ajax/default_folder_settings",parameters:fq})}return j})(cD);eV=E.ConfirmShareNewFileWizardModal=(function(i){fe(j,i);function j(T,fn){this.user=T;this.options=fn;j.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=aA.filename(this.file_path);this.folder_name=aA.filename_without_extension(this.file_name);this.folder_path=aA.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new bm(this.user);this.log_extras={path:this.file_path}}j.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return ba.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};j.prototype.on_confirm_button_click=function(fo){var fn,T;fn=(function(fp){return function(fs){var fq,fr,ft;ba.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",fp.user,fp.log_extras);ft=ch.extract_errors(fs.responseText);if(ft===false){return}else{if(typeof ft==="string"){ah.error(ft)}else{if(typeof ft==="object"){for(fr in ft){fq=ft[fr];if("message_text" in fq){ah.error(fq.message_text);break}}}}}return fp.hide()}})(this);T=(function(fp){return function(){var fq;ba.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",fp.user,fp.log_extras);fq=eB("%(folder_name)s was shared successfully.").format({folder_name:fp.folder_name});ah.success(fq);return fp.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,T,fn);return ba.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};j.prototype.format_invitees=function(){var fr,fq,fo,fn,T,fp;if(!this.invitees){return eB("others")}fr=this.invitees.emails[0];fq=this.invitees.fb_ids[0];fo=this.invitees.group_ids[0];fn=this.invitees.new_style_group_ids[0];if(!fr.length){return eB("others")}T=fr[0];fp=fr.length+fq.length+fo.length+fn.length;if(fp>1){T=T+eB(" and others")}return T};return j})(d8);d7=E.ConfirmShareExistingFileWizardModal=(function(j){fe(i,j);function i(T,fn){this.user=T;this.options=fn;i.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}i.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return ba.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};i.prototype.on_confirm_button_click=function(fn){var T;ba.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);T=new dg(this.user,this.folder_path);this.hide();return T.show()};return i})(d8);cB=E.NewSharedFolderPermissionsContent=(function(){i.SAVED_PERMISSIONS="new_sf_permissions:saved";function i(j){this.$form=j;this._submit=b3(this._submit,this);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d1.pop()};i.prototype._submit=function(fo){var T,fn,j;fo.preventDefault();T=this.$form.find("input[name=audience]:checked").val();fn=this.$form.find("input[name=inviter]:checked").val();j=this.$form.find("input[name=shared_link_policy]:checked").val();d1.trigger(i.SAVED_PERMISSIONS,{audience:T,inviter:fn,shared_link_policy:j});return d1.pop()};return i})();var dx;dx=E.SharingShmodel=(function(){function i(){}i.shmodel=function(T,j){return new dh(ct.active_user.id,T,j).show()};return i})();var bZ;bZ=INLINE_JS.Sharing=E.Sharing={init:function(j,i){this.show_inbox=j;this.simple_sharing_enabled=i;this._state={sf_info:{},cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:true,delay_reload_folder:false,pending_new_folders:[]};if(cM.get_viewer().is_paired){this.role_picker=C.controller(bF("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bO.set_during_login_callback((function(T){return function(fo,fn){return T._reload_folder_info(function(){return fn()},function(fp){fn(eB("Error displaying shared folders"));return window.location.reload()})}})(this))}this._listen();this._tmpl=fi.tmpl("sf_list_item_tmpl");this._display_spinner();cE.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(T){return function(fn){T._load_and_render_sf_list(fn);return eh.mark_time_to_interactive()}})(this),error:(function(T){return function(fn){return T._sf_list_error()}})(this)});this.refresh_inbox_counts(true);this._display_view();return bF(document).on(bm.REQUEST_SUCCEEDED_EVENT,(function(T){return function(fn,fo){if(fo.request_url==="/share_ajax/cancel_invite"||fo.request_url==="/share_ajax/invite_more"||fo.request_url==="/share_ajax/kick_user"){return T._reload_folder_info()}}})(this))},_load_and_render_sf_list:function(i){this._decode_sort_keys(i);this._state.sf_info=i;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ah.error(eB("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(i){return[i.current,i.past].each((function(j){return function(T){return T.each(function(fn){return j.decode_sort_key(fn)})}})(this))},decode_sort_key:function(i){cL((i.encoded_sort_key!=null)&&(i.sort_key==null),"expected encoded sort keys on each elm");i.sort_key=d6.decode_sort_key(i.encoded_sort_key);delete i.encoded_sort_key;return i},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(T,i){var j;if(!this.is_share_page()){return}j=(function(fn){return function(fo){var fp;fp=JSON.parse(fo.responseText);fn._decode_sort_keys(fp);fn._state.sf_info=fp;fn._render();return typeof T==="function"?T():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cr().get_folder_info(j,i)}},refresh_inbox_counts:function(i){return new cr().get_inbox_counts((function(j){return function(T){return j._update_inbox_counts(T,i)}})(this))},_update_inbox_counts:function(j,fo){var fr,T,i,fq,fp,fn;fn=0;for(fq in j){fr=j[fq];fn+=fr}bF("#inbox-count").text(fn);bF("#inbox-count").toggleClass("show",fn>0);if(!this.is_share_page()){return}T=function(ft,fs){var fu;for(fq in ft){fu=ft[fq];if(fs[fq]!==ft[fq]){return false}}return true};if((!fo)&&this._state&&T(this._state.inbox_counts,j)){return}this._state.inbox_counts=j;if(fn){i=new Element("a",{id:"new-invites-link",href:"#"});i.__sert(cx.make("web","email_32",{"class":"link-img"}));fp=bd("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",fn);fp+=" \n";fp=fp.format({total_count:fn});i.__sert(fp);i.observe("click",(function(fs){return function(ft){Event.stop(ft);return fs.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(i)}else{$("invites-box").hide()}if(fn>0&&this.show_inbox){this.show_inbox=false;return this.show_invites()}},register_accept:function(i){bF(i).closest(".sf-invite-action").addClass("loading");new by(bF(i),i.action,{data:bT.collect_form_vars(i),complete:(function(j){return function(fn,T){bF(i).closest(".sf-invite-action").removeClass("loading");j.refresh_inbox_counts();return j._reload_folder_info()}})(this),success:(function(j){return function(fq,T,fs){var fo,fp,fr,fn;fq=(fn=JSON.parse(fs.responseText))!=null?fn.data:void 0;fo=bF(i).closest(".sf-invite-action");fo.addClass("sf-accepted");if(fq!=null?fq.redirect:void 0){if(j._state&&j._state.current_total_count>1){fp=fo.find(".view-folder-button");return fp.click(function(){return window.location.href=fq!=null?fq.redirect:void 0})}else{return window.location.href=fq!=null?fq.redirect:void 0}}else{fr=bF(i).closest(".invitation-row").attr("data-invite-id");return j._remove_invite_row(fr)}}})(this)});return false},register_decline:function(j,fn,fo){var i,T;i=bF(j).closest("form");if((T=i.closest(".sf-invite-action"))!=null){T.addClass("loading")}if(i.length){new by(i,i[0].action,{data:bT.collect_form_vars(i[0]),complete:(function(fp){return function(fs,fq){var fr;if((fr=i.closest(".sf-invite-action"))!=null){fr.removeClass("loading")}fp._remove_invite_row(fn);fp.refresh_inbox_counts();fp._reload_folder_info();if(fo){return fo()}}})(this)})}return false},_remove_invite_row:function(fo){var i,fn,T,j;i=bF("#invites-container");fn=i.find('[data-invite-id="'+fo+'"]');if(fn){j=fn.parent("tbody");fn.remove();if(j.children().length===0){i.find(".invitation-table-container").hide();i.find(".message-bottom").removeClass("message-bottom");i.find(".message-top").removeClass("message-top");if(i.find(".invites-message").length===0){T=d8.get_containing_modal(i);return T!=null?T.hide():void 0}}}},_quietly_reload_content:function(){return cE.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(i){return function(j){return i._load_and_render_sf_list(j)}})(this),error:(function(i){return function(j){return i._sf_list_error()}})(this)})},_listen:function(){var T,j,i;this.listen_modals();T=(function(fn){return function(fq,fy,fs){var ft,fp,fx,fr,fu,fw,fo,fv,fz;fo=fn._get_current_sf_list_info(fs),fw=fo[0],fx=fo[1];cL(fy,"SF _transfer w/o target_ns_id");for(ft=fr=0,fu=fw.length;fr<fu;ft=++fr){fp=fw[ft];if(fp.target_ns_id===fy&&fp.user_id===fq){fv=fp;fz=ft;break}}cL(fz!=null,"SF _transfer w/o js obj");return[fv,fz]}})(this);i=(function(fn){return function(fs,fy,fv){var fx,fo,fu,fr,ft,fz,fw,fq,fp;fo=fn._get_current_sf_list_info(fy),fx=fo[0],fp=fo[1];fu=fn._get_current_sf_list_info(fv),fw=fu[0],fq=fu[1];fr=T(fs.memo.user_id,fs.memo.target_ns_id,fy),ft=fr[0],fz=fr[1];fx.splice(fz,1);fn._empty_check(fy);if(fs.memo.filename!=null){ft.filename=fs.memo.filename}if(fs.memo.mount_point!=null){ft.mount_point=fs.memo.mount_point}fw.push(ft);return fn._render()}})(this);j=(function(fn){return function(ft,fq){var fv,fr,fp,fs,fu,fo;fr=fn._get_current_sf_list_info(fq),fv=fr[0],fo=fr[1];fp=T(ft.memo.user_id,ft.memo.target_ns_id,fq),fs=fp[0],fu=fp[1];fv.splice(fu,1);return fn._render()}})(this);document.observe(aH.SF_UNSHARE,(function(fn){return function(fo){return j(fo,"#sf-current")}})(this));document.observe(aH.SF_LEAVE,(function(fn){return function(fo){return i(fo,"#sf-current","#sf-past")}})(this));document.observe(aH.SF_REJOIN,(function(fn){return function(fo){i(fo,"#sf-past","#sf-current");return fn._quietly_reload_content()}})(this));document.observe(aH.SF_IGNORE,(function(fn){return function(fo){return j(fo,"#sf-past")}})(this));document.observe(aH.SF_NEW,(function(fn){return function(fp){var fo;fo=fp.memo.sf_info;cL(fo,"SF_NEW without info");if(fn._state.sf_loading){return fn._state.pending_new_folders.push(fo)}else{fn._state.sf_info.current.push(fo);return fn._render()}}})(this));$("create-share").observe("click",(function(fn){return function(fo){ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fo);return s.start_wizard_without_user()}}})(this));bF("#learn-more-link").click((function(fn){return function(fo){return ba.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(fn){return function(fo){Event.stop(fo);return fn.show_invites()}})(this))}bF("#sf-current, #sf-past").each((function(fn){return function(fo,fp){var fq;fq=["#sf-current","#sf-past"][fo];bF(".sf-list",fp).on("click","a.options-link",function(ft){var fr,fx,fv,fz,fu,fA,fy,fw,fs;ft.preventDefault();fx=bF(ft.target).closest("a.options-link");fu=fx.attr("data-type");fr=fx.attr("data-filename");fz=fx.attr("data-mount");fw=parseInt(fx.attr("data-nsid"),10);fs=cM.get_viewer().get_user_by_id(fx.attr("data-user_id"));fy=bF(ft.target).closest("li.sf-folder").data("role");fA=fx.attr("data-sf-perm-role");if(fu==="normal"){if(fn.simple_sharing_enabled){if(d4.get_for_user(fs).verified_or_show()){eG.createAndShowInbandModal(fs,fz,true,fw,true,false,fA)}}else{s.show_shared_folder_options_modal(fz,fs)}}else{if(fu==="remove"){s.show_ignore_modal(fs,fr,fw)}else{if(fu==="rejoin"){s.show_rejoin_modal(fs,fr,fw)}}}fv={option_type:fu};if(fw){fv.ns_id=fw}if(fz){fv.path=fz}return ba.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fs.id,fv,true)});bF(".sf-sort",fp).on("click","a.sort-option",function(ft){var fs,fr,fu;ft.preventDefault();fs=bF(ft.target).closest("a.sort-option");fu={SF_BY_NAME:fn._name_cmp,SF_BY_MODIFIED:fn._modified_cmp};fr=fu[fs.attr("data-sort")];if(fn._state.cmp[fq]===fr){fn._state.is_ascending[fq]=!fn._state.is_ascending[fq]}else{fn._state.cmp[fq]=fr;fn._state.is_ascending[fq]=true}d6.add_sort_arrow_mouseover_j(fs,fn._state.is_ascending[fq],fq+" .sf-sort a.sort-option",true);return fn._render_list_id(fq)});return d6.add_sort_arrow_mouseover_j(bF(".modified-sorter",fp),fn._state.is_ascending[fq],fq+" .sf-sort a.sort-option",false)}})(this));return bF(".empty-share-button").click((function(fn){return function(fo){fo.preventDefault();ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return s.start_wizard_without_user()}})(this))},listen_modals:function(){return bF("#new-or-existing-sf li").click((function(i){return function(T){var j;bF("#new-or-existing-sf li").removeClass("active");j=bF(T.target).closest("li");j.find("input").prop("checked",true);return j.addClass("active")}})(this))},_showing_two_accounts:function(){var i;return cM.get_viewer().is_paired&&((i=this.role_picker)!=null?i.get_state():void 0)===d2.ALL},_render:function(){cL(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bF("#sf-current").hasClass("empty-list")&&bF("#sf-past").hasClass("empty-list")){bF("#page-content").addClass("no-shares");return bF("#empty-content").show()}else{bF("#page-content").removeClass("no-shares");return bF("#empty-content").hide()}},_render_list_id:function(fn){var fv,fs,fu,T,fp,fq,fr,i,fo,ft;i=this._get_current_sf_list_info(fn),fq=i[0],fu=i[1];ft=this._showing_two_accounts();fv=(function(j){return function(fw,fy){var fx;fx=j._state.is_ascending[fn]?1:-1;return fx*j._state.cmp[fn](fw,fy,ft)}})(this);fq.sort(fv);fr=bF(".sf-list",fn);fr.empty();for(T=0,fp=fq.length;T<fp;T++){fo=fq[T];if(this._should_render(fo)){fs=this._tmpl({options_str:eB("Options"),remove_str:eB("Remove"),rejoin_str:eB("Rejoin"),is_past:fu,sf:fo,Sprite:cx,Emstring:bU,Util:d6,_:eB});fr.append(fs.toHTML())}}return this._empty_check(fn)},_should_render:function(i){if(this.role_picker!=null){return this.role_picker.is_role_visible(i.role)}else{return true}},_empty_check:function(fn){var T,j,i;j=this._get_current_sf_list_info(fn),T=j[0],i=j[1];if(bF(".sf-list",fn).children().length){return bF(fn).removeClass("empty-list")}else{return bF(fn).addClass("empty-list")}},_get_current_sf_list_info:function(i){switch(i){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cL(false,"invalid sf list id")}},_name_cmp:function(j,T,i){if(i){return d6.sort_by_key(j,T)}else{return d6.sort_by_rank_or_key(j,T)}},_modified_cmp:function(j,T,i){return j.modified_ts-T.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var T,j,i;this._state.current_total_count=0;j=this._state.inbox_counts;for(i in j){T=j[i];this._state.current_total_count+=T}if(this._state.current_total_count>0){return s.show_invites()}},_display_view:(function(i){return function(){return bF("#sf-view").show()}})(this),_hide_view:(function(i){return function(){return bF("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return bF(".sf-spinner").show()},_hide_spinner:function(){return bF(".sf-spinner").hide()}};var br;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fn,fo,T,fs){var fr,j,fq,i,fp;this.user=fn;this.baseInitialize(fo,T,fs);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;j=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}fp=this.options.include_team===true;i=this.options.include_new_style_groups===true;fq=this.options.include_me===true;this.profile_services=bk.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new eb();this._autocompleter_profile_services_item_tmpl=fi.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;fr=(function(ft){return function(fu){if(ft.options.include_from_linked_accounts&&ft.options.viewer){fu=fu.includeForViewer(ft.options.viewer)}else{fu=fu.includeForUser(ft.user.id)}if(ft.options.contact_filter){fu=ft.options.contact_filter(fu)}else{if(!j){fu=fu.excludeFacebook()}if(!i){fu=fu.excludeNewStyleGroups()}if(!fp){fu=fu.excludeTeamMembers()}if(!fq){fu=fu.excludeMe()}}return ft.setContacts(fu)}})(this);(function(){var ft;return b0.load_contacts(ft=false,(function(fu){fr(fu);return b0.register_for_updates("autocompleter_contacts",fr)}))}).defer();return this.options.onShow=function(ft,fu){if(!fu.style.position||fu.style.position==="absolute"){fu.style.position="absolute";bF(fu).clonePosition(bF(ft),{setHeight:false,setTop:false,setLeft:false})}return bF(fu).fadeTo(150,1)}},link_callback:function(i){return eb.show_import_notifications(i)},getToken:function(){var i;i=this.getTokenBounds();return this.element.value.substring(i[0],i[1])},listen:function(){var i;this.install_profile_services_link_listener();i=(function(j){return function(T){if(j.profile_services.has_connected_services()){return}if(bF(j.element).val()){return}j.activate();setTimeout(function(){var fn;return(fn=j.get_entry_container())!=null?fn.show():void 0},300);return true}})(this);return bF(this.element).click(i)},install_profile_services_link_listener:function(){var i;Event.stopObserving(this.element,"blur");i=(function(j){return function(fn){var T;T=j.get_entry_container();if(bF(fn.target).hasClass("new-collab-input")&&bF(T).hasClass("people-default-show-import-shmodal-experiment")){return}if(!bF(fn.target).closest("li").hasClass("profile-services-link-handler")){if(bF(T).hasClass("people-default-show-import-shmodal-experiment")){bF(T).removeClass("people-default-show-import-shmodal-experiment");ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_LINK_DISMISS,j.user.id)}return T!=null?T.hide():void 0}}})(this);bF(this.element).closest(".db-modal-box").click(i);return bF(this.element).closest("#modal-box").click(i)},get_entry_container:function(){var i;return(i=this.element.up(".tokenized_autocompleter_container"))!=null?i.down(".autocomplete"):void 0},profile_services_show:function(){var fn,T,j,i;fn=this.get_entry_container();if(((T=fn.firstChild)!=null?(j=T.firstChild)!=null?j.value:void 0:void 0)>0){this.old_display=fn.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((i=$("flash_copy_container"))!=null){i.hide()}return this.element.focus()},profile_services_render_buttons:function(){var i;i=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(i.join(""))+"</ul>")},get_profile_services_button_list:function(){var T,fo,j,fq,fp,fn;fn=[];fp=c2.contact_services();for(fo=0,j=fp.length;fo<j;fo++){fq=fp[fo];cL(this.profile_services.is_updated,"profile_services has not been updated");T="";if(this.profile_services.service_is_connected(fq)){T=eB("Connected")}else{if(this.profile_services.service_was_connected(fq)){T=eB("Reconnect")}}fn.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fq,email_provider_img:c2.to_img(fq),email_provider_name:c2.to_name(fq),bottom_text:T}).toHTML())}return fn},update_import_contacts_link:(function(i){return function(j){i.profile_services=j;if(i.profile_services.has_unconnected_services(true)){return bF(i.element).closest("form").find(".import-contacts-link").show()}else{return bF(i.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bF(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bF("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(i){this.options.array=i.contacts;this.options.larray=i.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var T,j,i;j=this.getCurrentEntry();T=this.options.array[j.value];if(T.type===W.FB||T.type===W.NEW_STYLE_GROUP){j.innerHTML=T.name}else{j.innerHTML=T.email}if(this.options.tokens.length>1){i=this.options.tokens[0]+" "}else{i=""}j.innerHTML+=i;this.active=false;this.updateElement(j);return bF(this.element).trigger("db:autocompleted")}},br=function(i,j){var T;T=bF("<div>");T.addClass(i);if(typeof j==="string"||j instanceof String){T.text(j)}else{T.append(j)}return T},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(j){var i;if(j==null){j={}}i={choices:5,selector:(function(T){return function(){var fq,fF,fE,fy,fA,fR,fs,f5,f6,ft,fP,f1,fJ,f0,fC,fz,fQ,fO,fZ,fx,fY,fX,fr,fN,fB,fv,fu,f4,fK,fT,fL,fS,fn,fW,f2,fw,fD,fM,fo,fU,fG,fI,fV,fp,f3,fH;fG=[];fP=T.getToken().toLowerCase();fX=T.options.array.length;fA=T.options.array;fT=T.options.larray;fU=[];if(fP.indexOf(" ")===-1){fU.push("\\s+")}if(fP.indexOf("+")===-1){fU.push("\\+")}if(fP.indexOf("@")===-1){fU.push("@")}if(fP.indexOf(".")===-1){fU.push("\\.")}if(fP.indexOf("&lt;")===-1){fU.push("&lt;")}fo=RegExp("("+fU.join("|")+")");fQ=0;while(fP.length>0&&fQ<fX){fy=fA[fQ];fK=fT[fQ];f1=-1;ft=[];fS=[];fz="";switch(fy.type){case W.EMAIL:ft.push(fy.name,fy.email_snippet);fS.push(fK.name,fK.email);fz="/static/images/icons/mail28-vflHfHPJ0.png";break;case W.FB:ft.push(fy.name);fS.push(fK.name);if(bZ.use_fb_profile_pics){fz="https://graph.facebook.com/"+fK.fb_id+"/picture"}else{fz="/static/images/icons/fb24-vflGnjfAv.png"}break;case W.NEW_STYLE_GROUP:ft.push(fy.name,fy.members);fS.push(fK.name,"");fz="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fF=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fy.name);fE=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fy.name);fJ=bF("<span class='group-icon'>").css("border-color",fF).css("color",fF).text(fE)}break;default:cL(false,"should never get here due to type: "+(fy.type+", "+fy.name+", "+fy.email+", "+fy))}for(fx=f0=0,fB=fS.length;f0<fB;fx=++f0){fL=fS[fx];f2=fU.length?fL.split(fo):[fL];fs=0;for(fZ=0,fv=f2.length;fZ<fv;fZ++){fW=f2[fZ];if(!fW){continue}if(fW.indexOf(fP)===0){f1=fs;break}fs+=fW.length}if(f1!==-1){fM=((fP.length/fW.length)*9.4).toFixed(0);if(fy.sort_key!=null){fM+=fy.sort_key}fr=document.createTextNode(ft[fx].substr(0,f1));fn=bF("<strong>").text(ft[fx].substr(f1,fP.length));fV=document.createTextNode(ft[fx].substr(f1+fP.length));ft[fx]=[fr,fn,fV];break}}if(fy.type===W.FB){ft.push(eB("Facebook message"))}if(f1!==-1){if(fz){fC=bF('<img width="28px" height="28px">').attr("src",fz)}else{if(fJ){fC=fJ}}fw=br("autocomplete-line",ft[0]);fH=br("autocomplete-line autocomplete-secondary",ft[1]);fN=br("autocomplete-left",fC);fp=br(null,[fw,fH]);f4=bF("<li>").attr("value",fQ).append(fN,fp);fG.push([fM,f4])}fQ++}fG.sort(function(f8,f7){if(f8[0]<f7[0]){return 1}else{if(f8[0]>f7[0]){return -1}else{return 0}}});T._num_query_results=fG.length;fG=fG.slice(0,T.options.choices);fI=bF("<ul>");for(fY=0,fu=fG.length;fY<fu;fY++){f3=fG[fY];fI.append(f3[1])}T._num_contacts_shown=fG.length;if(!bF(T.element).hasClass("no-profile-services-link-handler")){if(T.profile_services.has_unconnected_services(true)){fR=bF(T.element).closest(".tokenized_autocompleter_container");fD=fR.attr("data-provider");fO=fD===c2.GOOGLE?eB("Select from your Gmail contacts"):fD===c2.YAHOO?eB("Select from your Yahoo contacts"):eB("Select from your contacts");f5=false;if((fD===c2.GOOGLE||fD===c2.YAHOO)&&!T.profile_services.service_is_connected(fD)){f5=true}else{if(T.profile_services.has_connected_services()){f5=false;fO=eB("Import Contacts")}}if(f5){f6=T._autocompleter_profile_services_item_tmpl({email_provider_num:fD,email_provider_img:c2.to_img(fD),email_provider_name:fO,bottom_text:""}).toHTML();fI.append(f6)}else{fC=cx.make("web","user_add");fw=br("autocomplete-line autocomplete-line-center",fO);fN=br("autocomplete-left",fC);fp=br(null,[fw]);f4=bF("<li>").addClass("profile-services-link-handler").append(fN,fp);fI.append(f4)}}}fq=fI.wrap("<span>").parent().html();T.old_contents=fq;return fq}})(this)};return this.options=Object.extend(i,j)}});var cO;cO=E.Token=Class.create({initialize:function(j,i,T,fn){this.element=$(j);this.token_manager=T;this.hidden_input=i;this.element.token=this;this.selected=false;this.info=fn;return bF(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var i;this.token_manager.token=this;if((i=this.hidden_input)!=null){i.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(i){if(i&&i.preventDefault){i.preventDefault()}if(this.detect(i)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(i){return this.token_manager.remove(this)},detect:function(fn){var j,T,i;T=fn.target?fn.target:fn.srcElement;i=T.token;j=T;while((i==null)&&j.parentNode){j=j.parentNode;i=j.token}return(i!=null)&&i.element===this.element}});var Q;Q=E.TokenManager=Class.create({initialize:function(T,fn,j,i){this.contact_search_logger=i;this.shift_boundary_right_func=fn;this.shift_boundary_left_func=j;this.element=T;this.tokens=[];return this.token=null},add:function(i){this.tokens.push(i);return this.element.fire("token:add",i.info)},populate:function(){var fr,fo,j,fn,T,fq,fp;fp=this.element.select(".token");fn=[];for(fo=0,j=fp.length;fo<j;fo++){fq=fp[fo];fr=fq.hasClassName("token-warn");T=new cO(fq,null,this,{external:fr});fn.push(this.add(T))}return fn},remove:function(j){var i;if(j==null){j=this.token}if(j!=null){this.contact_search_logger.flag_record_as_removed(j.info.value);i=this.tokens.indexOf(j);this.tokens.splice(i,1);j.element.remove();if(this.token===j&&i<this.tokens.length){this.tokens[i].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",j.info)}},removeAll:function(){var fo,j,fn,T,fp;fp=this.tokens.slice(0);this.tokens.clear();fn=[];for(fo=0,j=fp.length;fo<j;fo++){T=fp[fo];T.element.remove();fn.push(this.element.fire("token:remove",T.info))}return fn},shift_left:function(){var i;i=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(i>0){if(this.token){this.token.deselect()}return this.tokens[i-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var i;i=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(i+1<this.tokens.length){return this.tokens[i+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var ea;ea=E.HiddenInput=Class.create({initialize:function(i,T,j){this.element=$(i);this.auto_complete_element=T;this.token_manager=j;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(i){switch(i.keyCode){case Event.KEY_LEFT:i.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,i,fn,fp,T,j){var fo;this.user=i;$super(this.user,fn,fp,j);this.contact_search_logger=new ba.ContactSearchLogger;this.token_manager=new Q(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new ea(T,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bF(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fq,fr){bF(fr).clonePosition(bF(fq.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fr.show()};this.options.onHide=function(fq,fr){fr.hide();if(bF(fr).hasClass("people-default-show-import-shmodal-experiment")){return bF(fr).removeClass("people-default-show-import-shmodal-experiment")}};this.max_textbox_height=270;if(j.max_textbox_height!=null){this.max_textbox_height=j.max_textbox_height}this.members=[];if(j.members!=null){this.members=j.members}this.invitees=[];if(j.invitees!=null){this.invitees=j.invitees}this.new_style_groups=[];if(j.new_style_groups!=null){this.new_style_groups=j.new_style_groups}this.contacts_only=false;if(j.contacts_only!=null){this.contacts_only=j.contacts_only}if(eE.get_url().indexOf("/referrals")!==-1){fo=bF("#retrieve-contacts-button")}else{fo=bF(this.element).closest("form").find(".tokenizer-submit-button")[0]}bF(fo).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bF(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!j.hide_import_contacts){this.import_links=bF(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(j){var i,T;i=j.findElement("li");this.index=i.autocompleteIndex;T=this.selectEntry();if(!T){return this.hide()}},onBlur:function($super,i){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(i)},onFocus:function(i){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(i){return this.tokenize_emails_input(true)},clearTokens:function(i){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var j,i;j=bF(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fo,T,fn;fn=[];for(fo=0,T=j.length;fo<T;fo++){i=j[fo];fn.push(bF(i).val())}return fn})()).join(", ")},check_populated:function(){var j,i;j=$(this.element.parentNode);i=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(j.hasClassName("populated")&&i){return j.removeClassName("populated")}else{if(!j.hasClassName("populated")&&!i){return j.addClassName("populated")}}},clean_email_addr:function(fp,fo){var T,fn,j;for(fn=0,j=fp.length;fn<j;fn++){T=fp[fn];fo=fo.sub(T,"")}return fo.strip()},get_regexp_from_delimiters:function(fp){var T,fo,fn,j;fo="";for(fn=0,j=fp.length;fn<j;fn++){T=fp[fn];fo+=T+"|"}return new RegExp("["+fo+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(fn,T,i){var fo,j;j=true;fo=T;if(i===W.FB){fo=fn}if(i===W.EMAIL&&!d6.validate_email(T)){j=false}else{if(cT.call(this.members,T)>=0){j=false;fo=eB("Already member")}else{if(cT.call(this.invitees,T)>=0){j=false;fo=eB("Already invited")}else{if(i===W.NEW_STYLE_GROUP){if(cT.call(this.new_style_groups,T)>=0){j=false;fo=eB("Already member group")}else{j=true;fo=eB("Group")}}}}}if(T===this.user.email||T===this.user.id){fo=eB("You");j=!this.contacts_only}if(!fn&&T){fn=T.toString()}return{display:fn,value:T,type:i,valid:j,bubble_title:fo}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(j){var i,T;i=j.match(this.COMPOUND_EMAIL_REGEX);if(i){T=this.createTokenInfo(i[0],i[2],W.EMAIL);return T}return null},tokenize_emails_input:function(fu,fn){var fA,fs,fo,fy,T,fC,fB,fz,fD,fv,ft,fF,fE,fr,fx,fw,fp,fG,fq;fs=this.options.tokens;fw=this.get_regexp_from_delimiters(fs);if(this.options.single_token){fy=[this.element.value]}else{fy=this.element.value.split(fw)}fG="";if(!fu){fG=fy[fy.length-1];fx=this.clean_email_addr(fs,fG);fy=fy.slice(0,fy.length-1);if((fr=fG[fG.length-1])===" "||fr===">"){if(fx.match(this.COMPOUND_EMAIL_REGEX)||d6.validate_email(fx)){fy.push(fx);fG=""}}}fA=false;fq=[];if(fy.length>0){for(fC=0,fD=fy.length;fC<fD;fC++){fo=fy[fC];fp=this.parse_compound_email(fo);if(fp!=null?fp.valid:void 0){fA=true;this.set_input_size(1);if(this.addContact(fp)){fF={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fp.value,contact_name:fp.display,did_select_suggestion:false};this.contact_search_logger.add_record(fF)}}else{fq.push(fo)}}}fy=fq;if(!this.options.single_token){fE=[];for(fB=0,fv=fy.length;fB<fv;fB++){fo=fy[fB];fE.push.apply(fE,fo.split(" "))}fy=fE}if(fy.length>0){for(fz=0,ft=fy.length;fz<ft;fz++){fo=fy[fz];fo=this.clean_email_addr(fs,fo);if(fo){fp=this.createTokenInfo(fo,fo,W.EMAIL);if(fp.valid){fA=true}else{if(fn){continue}}this.set_input_size(1);if(this.addContact(fp)){fF={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fo,did_select_suggestion:false};this.contact_search_logger.add_record(fF)}}}}if(this.element.value!==fG){this.element.value=fG}T=this.element.up("form");if(fA){bT.clear_errors(T)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var j,i;j=this.element;i=function(){return j.focus()};return i},set_input_size:function(i){if((i==null)||i<0){i=20}return this.element.setStyle({width:i+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fx,fE,fr,fo,fA,fy,fF,fC,fq,fs,fB,fD,fn,fw,fv,T,ft,fp,fu,fz;fv=$(this.element.parentNode.parentNode);ft=parseInt(fv.getStyle("width"),10)-15;T=parseInt(fv.getStyle("height"),10);if(T!==this.textbox_height){this.textbox_height=T;if(T>=this.max_textbox_height){fv.setStyle({"overflow-y":"auto"})}else{fv.setStyle({"overflow-y":"hidden"})}}fF=ft;fx=bF(".tokenizer-link",fv.parentNode);if(fx.length>0){fF-=fx.width()}fu=this.token_manager.tokens;fs=false;fz=0;for(fA=0,fC=fu.length;fA<fC;fA++){fp=fu[fA];fo=fp.element;fr=parseInt(fo.getStyle("width"),10)+parseInt(fo.getStyle("margin-right"),10);fD=fz+fr;if(fD>ft){fz=fr;fs=true}else{if(fr>ft){fz=0;fs=true}else{fz=fD}}}fB=fF-fz;fE=this.element.value.length*7;if(fE>fB){fB=ft}this.set_input_size(fB);if(this.import_links.length&&this.import_links_visible){if(fs||ft-fz-fE<1.25*this.import_links_width){this.import_links_visible=false;fn=this.import_links;fw=[];for(fy=0,fq=fn.length;fy<fq;fy++){fo=fn[fy];fw.push(bF(fo).fadeOut(100))}return fw}}},onKeyPress:function(T){var j,i;this.dynamically_resize_input();if(this.active){switch(T.keyCode){case 44:case 188:case 59:case 186:if(!T.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(T);return}this.selectEntry();this.hide();this.active=false;Event.stop(T);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(T);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(T);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(T);return}}else{this.tokenize_emails_input(false);if(T.keyCode===Event.KEY_TAB||T.keyCode===Event.KEY_RETURN){if(this.element.value&&T.preventDefault){T.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((j=T.keyCode)===Event.KEY_LEFT||j===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((i=T.keyCode)===Event.KEY_LEFT||i===Event.KEY_RIGHT||i===Event.KEY_UP||i===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var T,fo,fn,j,fp,fq;if(this.active){fq=this.element.value;fp=this.options.tokens;for(fn=0,j=fp.length;fn<j;fn++){T=fp[fn];fo=fq.indexOf(T);if(fo!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fq.substr(0,fo);this.selectEntry();this.hide();this.active=false;this.element.value=fq.substr(fo+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(i){if(i==null){i=this.getCurrentEntry()}return bF(i).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(j){var i;if(j==null){j=this.getCurrentEntry()}return j.value===0&&((i=j.id)!=null?i.length:void 0)!==0},selectEntry:function(){var T,fq,i,fo,fn,fp,fs,fr,j;fq=this.getCurrentEntry();if(this.has_selected_profile_services(fq)){ba.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(fq)){fp="suggestion";if(bF(this.get_entry_container()).hasClass("people-default-show-import-shmodal-experiment")){fp=fp+" people-default-show-import-shmodal-experiment";ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_CLICK,this.user.id,{provider:i})}i=fq.id.split("_")[0];cL((cT.call(c2.contact_services(),i)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fr=c2.to_name(i);if(this.profile_services.service_is_connected(i)){ah.success(eB("You're already connected to %(service_name)s").format({service_name:fr}));return}if(cT.call(c2.contact_services(),i)>=0){return this.link_handler.auth_service_with_user(i,this.user.id,((function(ft){return function(fu){return ft.link_callback(fu)}})(this)),fp)}else{return cL(false,"Should never get here. entry_value: "+i)}}else{T=this.options.array[fq.value];fo=T.type===W.FB?T.fb_id:T.type===W.NEW_STYLE_GROUP?T.group_id:T.email;this.set_input_size(1);fs=this.element.value;j=this.createTokenInfo(T.name.strip(),fo,T.type);if(this.addContact(j)){fn={sort_variant:b0.sort_variant,context:"legacy_tokenizer",search_expr:fs,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:T.type,contact_id:fo,contact_name:T.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(fn)}bT.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(fp){var fv,fr,fB,fE,fn,fz,fA,fC,ft,fq,fw,fs,fx,fD,fF,T,fo,fu,fy;fy=this.token_manager.tokens;for(fB=0,fC=fy.length;fB<fC;fB++){fs=fy[fB];if(fp.value===fs.info.value){return false}}this.element.value="";switch(fp.type){case W.FB:fz="fb_ids";fE=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case W.EMAIL:fz="emails";fE=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case W.NEW_STYLE_GROUP:fz="new_style_group_ids";fE=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case W.INVALID:fz="invalids";fE=new Element("span",{"class":"hidden"});break;default:cL(false,"should never get here due to type: "+fp.type)}fx=this.getTokenClass(fp);fu=bF("<span class='x'>").addClass(fx);fu.on("click",function(i){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(i);return false});fF=new Element("input",{type:"hidden",name:fz,value:fp.value.toString()});fs=new Element("a",{"class":"title_bubble token "+fx,href:"#",tabindex:"-1",title:fp.bubble_title});fn=new Element("span");if(this.options.wrap_name){T=new Element("div",{"class":"token-display-text"});T.__sert(fp.display);fD=T;fv=1}else{fD=fp.display;fv=0}fq=[fF,fE,fD];for(fA=0,ft=fq.length;fA<ft;fA++){fr=fq[fA];fn.__sert(fr)}bF(fn).append(fu);fs.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fn))));if((fw=$(fs).down(5).next(fv))!=null){fw.innerHTML="&nbsp;"}fo=new cO(fs,this.hidden_input,this.token_manager,fp);this.token_manager.add(fo);this.element.up().__sert({before:fs});return true},getTokenClass:function(i){if(!i.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,i,fn,fo,T,j){$super(i,fn,fo,T,j);this.warn_only=!j.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};this.suspended_contacts={};this.pending_contacts={};return this.reloadContacts(true)},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(i){this.warn_only=!i;return this.reloadContacts()},reloadContacts:function(i){if(i==null){i=false}return b0.load_contacts(i=i,(function(j){return function(T){return j.setContacts(T)}})(this))},setContacts:function($super,fp){var T,fn,j,fo;this.team_contacts={};this.team_contacts[cM.get_viewer().work_email]=1;if(!bF(this.element).hasClass("team-admin")){fp=fp.excludeSuspended()}fp=fp.sortByTeamFirst();fo=fp.contacts;for(fn=0,j=fo.length;fn<j;fn++){T=fo[fn];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}if(T.team&&T.join_state==="pending"){this.pending_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(fp))}else{return $super(fp)}},createTokenInfo:function(fp,fn,j){var fr,fq,fo,i,T;T=true;fq=false;fr=fn;i=false;if(j===W.FB){fr=fp}if(j===W.EMAIL&&!d6.validate_email(fn)){T=false}else{if(cT.call(this.members,fn)>=0){T=false;fr=eB("Already member")}else{if(cT.call(this.invitees,fn)>=0){T=false;fr=eB("Already invited")}else{if((this.options.exclude_emails!=null)&&cT.call(this.options.exclude_emails,fn)>=0){T=false;fr=eB("You cannot choose this member")}else{if(j===W.EMAIL&&!this.team_contacts[fn]&&!this.pending_contacts[fn]){T=this.warn_only;fq=true}else{if(j===W.FB){T=this.warn_only;fq=true}else{if(j===W.NEW_STYLE_GROUP){if(cT.call(this.new_style_groups,fn)>=0){T=false;fr=eB("Already member group")}else{T=true;fr=eB("Group")}}}}}}}}if(fn===this.user.email||fn===this.user.id){fr=eB("You");T=!this.contacts_only}if(this.suspended_contacts[fn]){fr=eB("Suspended user");i=true}if(!fp&&fn){fp=fn.toString()}return fo={display:fp,value:fn,type:j,valid:T,external:fq,bubble_title:fr,suspended:i}},getTokenClass:function(i){if(!i.valid){return"token-error"}if(i.suspended){return"token-warn token-suspended"}if(i.external){return"token-warn"}return"token-valid"},notifyExternal:function(j){var i,T,fn;fn=j.memo;if(fn.external){T=this.token_manager.tokens.filter(function(fo){return fo.info.external});i=T?T.length:0;return this.element.fire("sf:token:external",{count:i})}}});var h;h=E.TeamSharedFolderInviteController=(function(){function i(j){var T;this.element=$(j[0]);T=this.element.down(".new-collab-input");T.observe("sf:token:external",this.handle_external.bind(this))}i.prototype.handle_external=function(T){var j,fn;j=T.memo.count;fn=this.element.down(".external-invite-message");if(j>1){dv.fillVal(j,"external-invite-num");if(fn!=null){fn.removeClassName("single")}return fn!=null?fn.show():void 0}else{if(j===1){if(fn!=null){fn.addClassName("single")}return fn!=null?fn.show():void 0}else{return fn!=null?fn.hide():void 0}}};return i})();var am;am=INLINE_JS.SharingModel=E.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(j,i,T){this.filename=j;this.c2d_vars=i;this.c2d_url=T!=null?T:"/sm/c2d";this.init_logger();bF(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(fn){return function(){var fq,fp,fo;fp=$("login-create-an-account");if(fp){fp.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bF("#download_button_link[data-dl-link]").on("click",fn.download_zip);fn.set_viewport_size();fq=function(fs,fr){return fn.do_c2d(fr.id)};bF("#c2d-modal .login-form").on("db:login:success",fq);bF("#c2d-modal .register-form").on("db:register:success",fq);fo=G.parse(window.location.href);if(fo.getQuery()["force_dl"]){fo.updateQuery({force_dl:0,dl:1});return window.location=fo.toString()}}})(this))},init_folder:function(j,fn,T,i){this.is_folder=true;this.gallery_enabled=j;this.gallery_showing=fn;this.file_viewer_files=T;this.file_view_mode=i;return on_script_loaded((function(fo){return function(){fo.load_thumbs();bF("#gallery-toggle").click(function(){return fo.switch_mode("gallery")});bF("#list-toggle").click(function(){return fo.switch_mode("list")});bF(".file-link").click(function(fp){return fo.open_file_viewer(bF(fp.currentTarget).data("mediaIndex"))});return bF(document).on(aH.FILE_ACTIVITY_UPDATE,function(fq,fp,fr){return bF("[data-file-activity-key='"+fr.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fs;return(fs=this.reactComponent)!=null?fs.setProps({unresolvedCommentCount:fr.unresolvedCommentCount(),unseenCommentCount:fr.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(i){if(!bx.isNumber(i)||i<0){return}n.show(this.file_viewer_files[i],cM.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});n.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(i){return function(){return bF("#add_to_my_dropbox_link").on("click",function(){return i.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(j){var T,i;i=j.icon.split("_");i.pop();T=i.join("_");return"/static/images/icons128/"+T+".png"},init_logger:function(){on_script_loaded((function(i){return function(){var j;j=$("login-hover-link");if(j){j.observe("click",function(){return aQ.log(aQ.CLICK_SIGN_IN)});j.observe("click",function(){return dK.log("click_sign_in")})}if($("download_button_link")){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,$("download_button_link"))}j=$("add_to_my_dropbox_link");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j);dK.attachLogListener("click_add_to_my_dropbox",j)}if($$(".remove-link").length){aQ.attachLogListener(aQ.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aQ.attachLogListener(aQ.CLICK_FILENAME,$$(".shmodel-filename")[0])}j=$("default_content_download_button");if(j){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,j)}j=$("default_content_a2md");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j)}j=bF("#login-create-an-account")[0];aQ.attachLogListener(aQ.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,j);j=bF("#login-hover-cont .login-form")[0];aQ.attachLogListener(aQ.LOGIN_THRU_DEFAULT_DROPDOWN,j);return bF("#share-button").click(function(T){return aQ.log(aQ.CLICK_SHARE)})}})(this));return document.observe(aM.ACTIONS_ADDED,(function(i){return function(){var fo,fn,j,T;T=$("view_original");if(T){aQ.attachLogListener("shmodel_lightbox_click_vieworiginal",T)}fn=$("lightbox_share_link");if(fn){aQ.attachLogListener("shmodel_lightbox_click_getlink",fn)}j=bF("lightbox-share-link");if(j[0]){aQ.attachLogListener("shmodel_lightbox_click_getlink",j[0])}fo=$("lightbox_download_link");if(fo){return aQ.attachLogListener("shmodel_lightbox_click_download",fo)}}})(this))},set_team_only_shmodel:function(j,i){this.team_only_shmodel=j;return this.owner_name=i},_resize_album_view:function(){var i;i=Math.floor((C.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:i+"px"})},load_thumbs:function(){var j,i;i=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");j=function(T){if(!T.src.endsWith(cx.SPACER)){return T.addClassName("thumbnail")}};return bs.batch_load_thumbs(i,this.THUMBS_BATCH_SIZE,j)},switch_mode:function(fr){var fo,fs,fn,T,fq,j,fp;fp=$A(["gallery","list"]);for(fn=0,T=fp.length;fn<T;fn++){j=fp[fn];fs=$(j+"-view-container");fo=$(j+"-toggle");if(fr===j){fs.show();fo.addClassName("selected")}else{fs.hide();fo.removeClassName("selected")}}if(history.replaceState){fq=window.location.pathname;if(fr==="list"){fq+="?lst"}history.replaceState({},"",fq)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var i;if($(document.body).hasClassName("mobile")){i=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(i)}},toggle_dropdown:function(fn,fo,T){var i,j;if(fn){Event.extend(fn).preventDefault()}if(!fo.visible()){if(this.is_album){return eU.show(fo,T,null,true)}else{j=$$(".nav-header").first().getHeight();i=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(i<0&&d6.ie8){i=4}return eU.show(fo,T,j-i,true)}}},prepare_confirm_remove_modal:function(j,fn,i,fp,fu,fq,ft,fr){var T,fo,fs;if(i){fs=fp?eB("Unshare?"):eB("Unshare album?");T=bF("#album-disable-token-modal")[0];dv.fillVal(j.escapeHTML(),"album_unshare_name")}else{if(fq){fs=eB("Remove link created by %(name)s").format({name:ft});if(fn){fo=eB('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fo=eB('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fo=fo.format({fname:bU.em_snippet(j,17),owner:ft,owner_email:fr})}else{fs=eB("Remove link to '%(name)s'").format({name:bU.em_snippet(j,17)});if(fn){fo=eB("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fo=eB("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}T=bF("#disable-token-modal")[0];dv.fillVal(fo,"disable-token-desc")}return{title:fs,contents:T}},confirm_remove:function(j,fp,T,i,fn,ft,fq,fs,fr){var fo;if(T==null){T=false}if(i==null){i=false}if(fn==null){fn=false}if(ft==null){ft=null}if(fq==null){fq=false}if(fs==null){fs=null}if(fr==null){fr=null}cL(fp,"confirm_remove missing tkey");cL(j,"confirm_remove missing name");cL(ft,"confirm_remove missing user_id");cL(!fq||!i,"admin removal of collections not supported");cL(!fq||fs,"missing link owner name for admin removal");cL(!fq||fr,"missing link owner email for admin removal");if(!cM.get_viewer().is_uid_signed_in(ft)){bO.show_modal({user_id:ft,on_success:(function(fu){return function(){return fu.confirm_remove(j,fp,T,i,fn,ft,fq,fs,fr)}})(this)});return}fo=am.prepare_confirm_remove_modal(j,T,i,fn,ft,fq,fs,fr);return fd.show(fo.title,fo.contents,{token:fp,name:j,is_album:i,user_id:ft})},confirm_remove_from_event_gid:function(i,fs,T,fr,fo,fq,fp,j){var fn;if(fo==null){fo=false}if(fq==null){fq=null}if(fp==null){fp=null}if(j==null){j=null}cL(fs,"confirm_remove missing event gid");cL(i,"confirm_remove missing name");cL(fr,"confirm_remove missing user_id");cL(cM.get_viewer().is_uid_signed_in(fr),"user not logged in");cL(!fo||fq,"missing link owner name for admin removal");cL(!fo||fp,"missing link owner email for admin removal");fn=am.prepare_confirm_remove_modal(i,T,false,false,fr,fo,fq,fp);return fd.show(fn.title,fn.contents,{name:i,user_id:fr,activity_log_event_gid_dbase64:fs,redirect_to_member_id:j})},do_remove:function(fn){var i,T,j;cL(fn.token||fn.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");i=bF("#modal-content input").first();i.attr("disabled",true);bF("#modal-content").addClass("ajax-loading");j=window.location.pathname;if((j==="/links"||j==="/links/your_links"||j==="/recents")||j.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+fn.token,{subject_user:fn.user_id,onSuccess:(function(fo){return function(){var fp;fd.hide();if(fn.is_album){fp=eB("Unshared '%(name)s'")}else{fp=eB("Removed link for '%(name)s'")}fp=fp.format({name:fn.name});ah.success(fp);return document.fire(aH.LINKS_REMOVE,{token:fn.token})}})(this),onComplete:(function(fo){return function(){i.attr("disabled",false);return bF("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(fn.token){T=G({path:"/sm/disable/"+fn.token})}else{T=G({path:"/sm/disable_by_event_gid/"+fn.activity_log_event_gid_dbase64});T.updateQuery("redirect_to_member_id",fn.redirect_to_member_id).toString()}return bT.postRequest(T.updateQuery(a9.UID_PARAM_NAME,fn.user_id).toString())}},show_shmodal_onload:function(T,fn,j,i){if(i==null){i=null}return bF((function(fo){return function(){eE.remove_query_param("m");if(!cM.get_viewer().is_uid_signed_in(i)){bO.show_modal({user_id:i,on_success:function(){return fo.show_shmodal_onload(T,fn,j,i)}});return}if((i!=null)&&d4.get_for_user(cM.get_viewer().get_user_by_id(i)).verified_or_show()){return fo.show_shmodal(T,fn,j,i)}else{if(i==null){cL(cM.get_viewer().is_paired,"Expected viewer to be paired.");return fo.show_share_shmodel_role_chooser(T,fn,j)}}}})(this))},show_shmodal:function(fs,fy,j,fx){var fw,fu,fv,ft,fp,fo,fr,fq,T,fn;this.url=fs;this.short_url=fy;if(!cM.get_viewer().is_uid_signed_in(fx)){bO.show_modal({user_id:fx,on_success:(function(i){return function(){return i.show_shmodal(url,short_url,j,fx)}})(this)});return}fn=cM.get_viewer().get_user_by_id(fx);if(d4.get_for_user(fn).verified_or_show()){fq="shmodal-user-"+fx;fd.show(this._get_shmodal_title(fn.is_team),dv.fromElm($(fq)));fp={};fp[a9.UID_PARAM_NAME]=fx;bT.add_vars("shmodal-send-form",fp);if(this._get_thumbnail_type()){T=$$(".shmodal-image");for(fo=0,fr=T.length;fo<fr;fo++){ft=T[fo];ft.addClassName("thumbnail")}}if(j==="contacts"){fv=Autocompleter.ContactsTokenizer}else{fv=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fv(fn,fq+"-new-collab-input",fq+"-new-whobulk",fq+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:j==="team_only",user_id:fx});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fw=t.clipboard_overlay(url,bF("#"+fq+"-copy-link"),am.copied_to_clipboard);fw.css({position:"fixed",zIndex:1001});fw.children().height(fw.height());clearInterval(this.follow_freshbutton);fu=(function(i){return function(){return fw.clonePosition(bF("#"+fq+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(fu,500)}else{$(fq+"-copy-link").hide()}}cj._create($("modal").down(".custom-message-container"));cj._create($("modal").down(".fb-post-sickinput"));cj._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(short_url,fx);$(fq+"-new-collab-input").focus();return aQ.log("shmodal_show")}},configure_dropdown:function(){var fp,fn,j,fo,T;fo=$$(".dropdown-menu-container");for(fn=0,j=fo.length;fn<j;fn++){fp=fo[fn];T=fp.down(".dropdown-menu-trigger");if(T!=null){T.observe("click",(function(i){return function(fr){var fq;fq=fr.target.up(".dropdown-menu-container");return fq.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(i){return function(fv){var fu,fs,fr,fq,ft;if(fv.target.hasClassName("dropdown-menu-trigger")||fv.target.up(".dropdown-menu-trigger")){return}fq=$$(".dropdown-shown");ft=[];for(fs=0,fr=fq.length;fs<fr;fs++){fu=fq[fs];ft.push(fu.removeClassName("dropdown-shown"))}return ft}})(this))},copied_to_clipboard:function(){ah.success(eB("Link copied to clipboard"));fd.hide();aQ.log("shmodal_copy_link");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(fn){var fo,fx,fv,ft,fy,fz,fs,fu,fr,fq,fw,T,fp;cL(fn,"Must pass the shmodal send form into get_shmodel_send_recipients");fo=fn.select('input[name="emails"]');fx=fn.select('input[name="fb_ids"]');fv=fn.select('input[name="group_ids"]');fq=fn.select('input[name="new_style_group_ids"]');T=[];fp=[fo,fx,fv,fq];for(ft=0,fu=fp.length;ft<fu;ft++){fz=fp[ft];for(fs=0,fr=fz.length;fs<fr;fs++){fy=fz[fs];fw=fy.up().innerHTML.stripTags().escapeHTML();T.push(fw.substring(0,fw.indexOf("&")))}}return T},close_embedded_fileviewer:function(j){var i;j.preventDefault();i=new eu();i.configureParentMessaging(function(){},["parent-ready"]);i.startListening();return i.postMessageToParent("close-fileviewer")},send_shmodel_link:function(fn){var T,j,fo,i;T=$("shmodal-send-form");cL(T,"Couldn't find the shmodal send form.");i=this.get_shmodel_send_recipients(T);fo=(function(fp){return function(fq){var fr;fr=aZ.success_string_for_recipients(i);ah.success(fr);fd.hide();return aQ.log("shmodal_send")}})(this);j=(function(fp){return function(fq){return bT.remove_loading()}})(this);return bT.ajax_submit(T,"/sm/share",fo,j,T.down(".tokenizer-submit-button"))},show_content:function(T){var fn,j,fo,fp;$("shmodal-title-text").__date(dr.to_title_str(T));fo=dr.list;for(fn=0,j=fo.length;fn<j;fn++){fp=fo[fn];if(fp!==T){$(dr.to_toggle_str(fp)).removeClassName("toggled");$(dr.to_content_str(fp)).hide()}}$(dr.to_content_str(T)).show();$(dr.to_toggle_str(T)).addClassName("toggled");return bF("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(dr.SEND)},show_fb_content:function(){return this.show_content(dr.FB)},show_twitter_content:function(){return this.show_content(dr.TWITTER)},start_fb_post:function(fo,j){var fp,T,i,fn;T=(function(fq){return function(){return er.do_auth(fq.do_fb_post.curry(fo,j),j)}})(this);fp=bF("#modal:visible, #modal-overlay:visible");i=function(){return fp.show()};if(er.authed_user_id===j){return this.do_fb_post(fo,j)}else{if(cM.get_viewer().is_uid_associated(er.authed_user_id)){fp.hide();fn=new ee(cM.get_viewer().get_user_by_id(j),i,T.bind(this));return fn.show()}else{return T()}}},start_twitter_post:function(i){if(cG.is_authed(i)){return this.do_twitter_post(i)}else{return cG.do_auth(this.do_twitter_post,i)}},do_fb_post:function(j,i){er.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};er.custom_show_complete=function(){fd.hide();ah.success(eB("Successfully posted to Facebook"));aQ.log("shmodal_fb_post");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})};return er.post($F("shmodal-fb-post-input"),j,null,null,null,function(){return fd.hide()},i)},do_twitter_post:function(i){var j;j=$F("shmodal-twitter-post-input");if(!j){ah.error(eB("Please enter a Twitter post"));return}else{if(j.length>140){ah.error(eB("Your post must be 140 characters or less"));return}}cG.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};return cG.custom_post(j,(function(T){return function(){fd.hide();ah.success(eB("Successfully posted to Twitter"));aQ.log("shmodal_tweet");return ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cS.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})}})(this),i)},_get_shmodal_title:function(i){if(i==null){i=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(j){return function(){return j.show_send_content()}})(this)),((function(j){return function(){return j.show_fb_content()}})(this)),((function(j){return function(){return j.show_twitter_content()}})(this)),i)},generate_title_content:function(j,fs,fp,fu,fn){var fo,fq,i,ft,T,fr;if(fn==null){fn=false}ft=bF("<div/>",{id:"shmodal-title"});T=bF("<div/>",{id:"shmodal-title-text",text:j});ft.append(T);if(!fn){i=bF("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});i.html(cx.make("web","email_20"));i.on("click",fs);fq=bF("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fq.html(cx.make("web","fb_20"));fq.on("click",fp);fr=bF("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fr.html(cx.make("web","twitter_20"));fr.on("click",fu);ft.append([i,fq,fr])}fo=bF("<div/>",{"class":"clear"});ft.append(fo);return ft[0]},_get_shmodal_title_text:function(){var j,i;if(this.is_folder){j=eB("Share link to \u2018%(folder_name)s\u2019");return j=j.format({folder_name:bU.em_snippet(this.filename,15)})}else{i=this._get_thumbnail_type();if(i===cS.CATEGORY_TO_TRANSLATION.IMAGE){return eB("Share this image")}else{if(i===cS.CATEGORY_TO_TRANSLATION.VIDEO){return eB("Share this video")}else{return eB("Share '%(filename)s'").format({filename:bU.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var j,i;if(this.filename.indexOf(".")===-1){return false}i=aA.file_extension(this.filename).toLowerCase();j=cS.EXTENSION_TO_CATEGORY[i];if(j&&(j==="IMAGE"||j==="VIDEO")){return cS.CATEGORY_TO_TRANSLATION[j]}return false},_populate_twitter_info:function(T,i){var fn,j;fn=this.is_folder?eB("Just shared some files using @Dropbox"):(j=this._get_thumbnail_type(),j&&j===cS.CATEGORY_TO_TRANSLATION.IMAGE?eB("Just shared an image using @Dropbox"):eB("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(fn+" "+T);d6._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cG.is_authed(i)){return cG.get_user_info(function(fo){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fo.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fo.name);$("shmodal-twitter-profile").down(".username").__date("@"+fo.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},i)}},download_zip:function(fn){var j,T,fo,i,fp;j=bF("#download_button_link").attr("data-dl-link");fp=bF("#download_button_link").attr("data-test-link");i=bF("#download_button_link").attr("data-owner")==="true";fo=(function(fq){return function(fr){var fs;if(fr==="OK"){window.location=j}else{if(fr.indexOf("err:")===0){if(i){fs=eB("The zip file is too large.")}else{fs=eB("The zip file is too large. Please add it to your Dropbox.")}ah.error(fs)}else{ah.error(eB("Failed to download zip file."))}}return false}})(this);T=(function(fq){return function(fr){ah.error(eB("Failed to download zip file."));return false}})(this);if(fp&&bF.support.cors===true){bF.ajax({url:fp,type:"POST",success:fo,error:T})}else{window.location=j}return false},show_share_shmodel_role_chooser:function(j,T,i){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dz({element_id:"share-shmodel-select-role-modal",link_url:j,short_url:T,tokenizer_type:i})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(j,T,i,fo){var fn;fn=(function(fp){return function(){var fq;fd.hide();bF("#role-selector option").removeClass("disabled");fq=cM.get_viewer().get_uid_by_role(fo);cM.get_viewer().sign_in_user_by_id(fq);ba.ShmodelUILogger.log("via-shmodel-viewer");return am.show_shmodal(j,T,i,fq)}})(this);if(!cM.get_viewer().is_role_signed_in(fo)){return bO.show_modal({role:fo,on_success:fn})}else{return fn()}},show_c2d_modal:function(fq,j){var fp,i,fo,T,fn;if(fq==null){fq=""}if(j==null){j=false}if(fq){if(fq===Constants.ROLE_PERSONAL){cL(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cM.get_viewer().is_role_signed_in(fq)){bO.show_modal({role:fq,on_success:(function(fr){return function(){return fr.show_c2d_modal(fq)}})(this)});return}}else{if(cM.get_viewer().is_paired){new aT({element_id:"select-role-modal"}).show();return}}ba.WebMiscActivityLogger.log("show-c2d-modal",{filename:this.filename,auth_google:bF.find(".auth-google")!=null});if(fq){T="#c2d-modal-"+fq}else{T="#c2d-modal"}fn=this._c2d_modal_msg(fq,cM.get_viewer().team_name);fp=this._c2d_modal_button_msg(fq,cM.get_viewer().team_name);i=this._c2d_modal_desc(fq,cM.get_viewer().team_name);if(j){i=this._c2d_modal_team_only_desc(cM.get_viewer().team_name)+"<br/><br/>"+i}fo=this._c2d_modal_login_desc(fq,cM.get_viewer().team_name);dv.fillVal(i,"c2d-desc");dv.fillVal(fo,"c2d-login-desc");bF(".c2d-submit-button").val(fp);bF(".c2d-login-register-desc").hide();if(this.is_album){bF(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bF(".c2d-login-register-folder-desc").show()}else{bF(".c2d-login-register-file-desc").show()}}return fd.show(fn,bF(T)[0],false,false,false,false)},_c2d_modal_msg:function(fn,j){var i,T;if(fn==null){fn=""}if(j==null){j=""}if(this.c2d_vars.title){return T=this.c2d_vars.title}else{if(fn===Constants.ROLE_PERSONAL){T=eB("Save '%(filename)s' to my personal Dropbox");return T.format({filename:bU.em_snippet(this.filename,10)})}else{if(fn===Constants.ROLE_WORK){T=eB("Save '%(filename)s' to my %(team_name)s Dropbox");i=Math.max(10,15-new bU(j).length);return T.format({filename:bU.em_snippet(this.filename,i),team_name:j})}else{T=eB("Save '%(filename)s' to my Dropbox");return T.format({filename:bU.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){return j=eB("Save to my personal Dropbox")}else{if(T===Constants.ROLE_WORK){j=eB("Save to my %(team_name)s Dropbox");return j.format({team_name:i})}else{return eB("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(i){var j;if(this.is_album){j=eB("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){j=eB("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{j=eB("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return j.format({owner_name:this.owner_name,team_name:i})},_c2d_modal_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){j=eB("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eB("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){j=eB("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eB("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){j=eB("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eB("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eB("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eB("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eB("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}else{if(this.is_album){return eB("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return eB("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return eB("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){return j=eB("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return j=eB("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return j=eB("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eB("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eB("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eB("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}}},do_c2d:function(i){var j;cL(i,"Must specify a user_id for saving to Dropbox.");j=eB("Saving to your Dropbox...");if(cM.get_viewer().is_paired){if(cM.get_viewer().get_user_by_id(i).is_team){j=eB("Saving to your %(team_name)s Dropbox...");j=j.format({team_name:cM.get_viewer().team_name})}else{j=eB("Saving to your personal Dropbox...")}}ah.success(j);fd.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:j,subject_user:i,onSuccess:(function(T){return function(fn){if(fn.responseText){return b1.redirect(fn.responseText)}}})(this)})},c2d_show_twofactor_error:function(j){var i;i=$("c2d-twofactor-error");i.__date(j);return i.show()},c2d_hide_twofactor_error:function(i){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(eB("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(eB("Unfortunately, your carrier isn\u2019t supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(eB("That isn\u2019t a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(eB("That phone number doesn\u2019t appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(eB("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(eB("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var dr;dr=E.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",eB("Share on Facebook"),eB("Share on Twitter")],to_content_str:function(i){return this._content_str[i]},to_toggle_str:function(i){return this._toggle_str[i]},to_title_str:function(i){if(i===0){return am._get_shmodal_title_text()}return this._title_str[i]},to_focus_str:function(i){return this._focus_str[i]}};var Z,dh,bL,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;dh=INLINE_JS.ShareLinkModal=E.ShareLinkModal=(function(i){fe(j,i);function j(T,fp,fn,fr,fq){var fo,fs;this.user_id=T;if(fr==null){fr=false}if(fq==null){fq=void 0}this.before_show=b3(this.before_show,this);this.show=b3(this.show,this);this.prompt_login_then_show=b3(this.prompt_login_then_show,this);fs={origin:fn};fs[a9.UID_PARAM_NAME]=this.user_id;if(fq){fo=G({path:"/sm/get_link_modal_content/"+fq}).toString()}else{fo=G({path:"/sm/share_link"+fp}).toString()}j.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fo,parameters:fs})}j.prototype.prompt_login_then_show=function(){var T;T=(function(fn){return function(){fd.hide();bF("#role-selector option").removeClass("disabled");cM.get_viewer().sign_in_user_by_id(fn.user_id);ba.ShmodelUILogger.log("via-shmodel-viewer");return fn.show()}})(this);if(!cM.get_viewer().is_uid_signed_in(this.user_id)){return bO.show_modal({user_id:this.user_id,on_success:T})}else{return T()}};j.prototype.show=function(){var T;T=cM.get_viewer().get_user_by_id(this.user_id);if(d4.get_for_user(T).verified_or_show(es.SHMODAL)){return j.__super__.show.call(this)}};j.prototype.before_show=function(){var fp,fo,T,fn;fn=this.$modal_window.find(".share-link-modal-content").length;if(fn){fp={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};T=bF("<img />",fp);fo=bF("<div />",{"class":"loading-spinner"}).append(T);return this.$modal_window.find(".dynamic-content").html(fo)}};return j})(cD);bL=E.ShareLinkModalContent=(function(){function i(fp,fr,fw,fs,j,T,fv,fo,ft){var fn,fq,fu,fx;this.owner_id=fp;this.tkey=fr;this.fq_path=fw;this.link=fs;this.filename=j;this.tokenizer_type=T;this.tokenizer_ctx_str=fv;this.fq_path_of_restricting_sf=ft;this._send_link=b3(this._send_link,this);this._show_shared_link_settings_modal=b3(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=b3(this._show_shared_folder_settings_modal,this);this._select_all_text=b3(this._select_all_text,this);this._toggle_send_link_button=b3(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=b3(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=b3(this._toggle_close_button_text,this);this._toggle_comment_option=b3(this._toggle_comment_option,this);this._listen=b3(this._listen,this);this._init_autocompleter=b3(this._init_autocompleter,this);this.$content=bF(".share-link-modal-content");this.modal=d8.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=o.create_contacts_list(fo)}fu={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aH.LINKS_ADD,fu);this.modal.set_title(eB("Share link to \u2018%(filename)s\u2019").format({filename:bU.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this.$custom_message_textarea=this.$content.find("#share-link-modal-custom-message");this.$comment_option_container=this.$content.find(".add-message-as-comment-container");this._init_autocompleter();this._listen();if((fn=this.$share_link_url_input[0])!=null){fn.select()}if(((fq=az.getGandalfRule("people-link-profile-on-share-experiment"))===null||fq==="CONTROL")&&az.isGandalfInVariant("people-default-show-import-shmodal-experiment","EXPERIMENT")&&this.tokenizer_type!=="shared_folder"){fx=(function(fy){return function(fz){var fA;fA=bF(fy.autocompleter.element).closest(".tokenized_autocompleter_container").attr("data-provider");fy.autocompleter.activate();bF(fy.autocompleter.get_entry_container()).addClass("people-default-show-import-shmodal-experiment");if(container.find("#autocompleter_item_tmpl")!=null){return ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_SHOW,fy.owner_id,{provider:fA})}}})(this);bk.get_linked_profile_services_for_user(this.owner_id,fx)}}i.prototype._init_autocompleter=function(){var j,T;j={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cM.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}}T=(function(fn){return function(fo){return function(){return fn.autocompleter.contact_search_logger.log_records(fn.owner_id,fo)}}})(this);this.modal.logger_keydown_close_handler=T(true);this.modal.$overlay.on("click",T(true));this.modal.$db_modal_x.on("click",T(true));this.$send_link_button.on("click",T(false));this.$cancel_button.on("click",T(true));cj.init();return this.$collab_input.focus()};i.prototype._listen=function(){var fo,fn,T,j,fq,fp;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fr){return function(fs){return d1.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if(this.$comment_option_container.length>0){this.$custom_message_textarea.on("input",this._toggle_comment_option)}if((fo=this.$collab_input)!=null){fo.keyup(this._toggle_send_link_button)}if((fn=this.$collab_input)!=null){fn.on("input",this._toggle_send_link_button)}if((T=this.$collab_input[0])!=null){T.observe("token:remove",this._toggle_send_link_button)}if((j=this.$collab_input[0])!=null){j.observe("token:add",this._toggle_close_button_text)}if((fq=this.$collab_input[0])!=null){fq.observe("token:remove",this._toggle_close_button_text)}return(fp=this.$collab_input[0])!=null?fp.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};i.prototype._toggle_comment_option=function(T){var j;j=this.$custom_message_textarea.val().length;if(j>0){return this.$comment_option_container.css("visibility","visible")}else{return this.$comment_option_container.css("visibility","hidden")}};i.prototype._toggle_close_button_text=function(fn){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;if(j){return this.$cancel_button.text(eB("Close"))}else{return this.$cancel_button.text(eB("Cancel"))}};i.prototype._toggle_recipients_outside_team_warning=function(fn){var j,T;j=bF(".external-recipient-warning-message");if(j.length){T=fn.memo.count;if(fn.memo.shared_folder_warning){if(T>0){return j.show()}else{return j.hide()}}else{if(T>1){j.find(".external-recpient-num").text(T);return j.removeClass("single").show()}else{if(T===1){return j.addClass("single").show()}else{return j.hide()}}}}};i.prototype._toggle_send_link_button=function(fn){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;j=j&&bF.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",j)};i.prototype._select_all_text=function(j){return bF(j.currentTarget)[0].select()};i.prototype._show_shared_folder_settings_modal=function(T){var j;T.preventDefault();j=cM.get_viewer().get_user_by_id(this.owner_id);return s.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,j)};i.prototype._show_shared_link_settings_modal=function(T){var j;T.preventDefault();j=new dX(this.owner_id,this.tkey);return d1.push(j)};i.prototype._send_link=function(fp){var fn,T,fo,j,fq;fo=this.$content.find(".share-link-modal-send-form")[0];j=this.get_shmodel_send_recipients(fo);fq=(function(fr){return function(fs){var ft;ft=aZ.success_string_for_recipients(j);ah.success(ft);d1.pop();return aQ.log("shmodal_send")}})(this);T=(function(fr){return function(fs){return bT.remove_loading()}})(this);fn=this.$content.find(".tokenizer-submit-button")[0];return bT.ajax_submit(fo,"/sm/share",fq,T,fn)};i.prototype.get_shmodel_send_recipients=function(fn){var fo,fx,fv,ft,fy,fz,fs,fu,fr,fq,fw,T,fp;cL(fn,"Must pass the shmodal send form into get_shmodel_send_recipients");fo=fn.select('input[name="emails"]');fx=fn.select('input[name="fb_ids"]');fv=fn.select('input[name="group_ids"]');fq=fn.select('input[name="new_style_group_ids"]');T=[];fp=[fo,fx,fv,fq];for(ft=0,fu=fp.length;ft<fu;ft++){fz=fp[ft];for(fs=0,fr=fz.length;fs<fr;fs++){fy=fz[fs];fw=fy.up().innerHTML.stripTags().escapeHTML();T.push(fw.substring(0,fw.indexOf("&")))}}return T};return i})();Z=INLINE_JS.QuickSend=E.QuickSend={_files:{},_uploading_fileids:{},init:function(i,T,fn){var j;this.owner_id=i;this.tokenizer_ctx_str=T;this.keep_visible=fn;this.$content=bF("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((j=this.$collab_input)!=null){j.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bF("#browse-files").addClass("quicksend-collapsed");Z._update_location();this.has_autocompleter_inited=false;ba.SharedFolderActivityLogger.log("web","quick_send_displayed",ct.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fo;return(fo=Z.$import_services)!=null?fo.hide():void 0},100)});bF("#quick-send-top-choose-button-send").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-choose-button").click(function(){return bF("#quick-send-file-box").click()});bF(".quick-send-choose-file-link").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-file-box").on("change",function(){var fp,fo;fo=bF("#quick-send-file-box")[0].files;fp=function(){if(!ct.active_user){ct.active_user=cM.get_viewer().get_user_by_id(Z.owner_id)}return bp.upload(Z.DEST_FOLDER+"/",fo)};return Z.get_folder_name(fp)});document.on(cC.COMPLETE_EVT,Z._file_upload_completed);document.on(cC.ERROR_EVT,Z._file_upload_errored);return document.on(dN.UPDATE,Z._update_location)},_cancel_button_clicked:function(i){ba.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",ct.active_user,{});return Z._reset()},_init_autocompleter:function(){var i;if(Z.has_autocompleter_inited){return}Z.has_autocompleter_inited=true;i={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:Z.owner_id,max_textbox_height:30,viewer:cM.get_viewer(),include_from_linked_accounts:true};return Z.autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_id(Z.owner_id),Z.collab_input_id,Z.tokenizer_ctx_str+"-new-whobulk",Z.tokenizer_ctx_str+"-hidden-input",i)},_send_link:function(fr){var fo,fn,fp,T,j,fs,ft,i,fq;ba.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",ct.active_user,{});Z.autocompleter.tokenize_emails_input(true);i=Z.autocompleter.getTokenCount();T=bF(".quick-send-left-form")[0];j=[];ft=0;for(fp in Z._files){ft+=1;fn=Z._files[fp];j.push(fn.fq_path)}fs={num_recipients:i,num_files:ft};ba.SharedFolderActivityLogger.log("web","quick_send_send_attempted",ct.active_user,fs);fq=(function(fu){return function(fv){Z._reset();Z._toggle_top_area_view();return ba.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",ct.active_user,{})}})(this);fo=(function(fu){return function(fv){return ba.SharedFolderActivityLogger.log("web","quick_send_send_failed",ct.active_user,{})}})(this);return bT.ajax_submit(T,"/sm/quick_send",fq,fo,null,{fq_paths:j.join(",")})},_update_file_area_view:function(){if(Object.keys(Z._files).length){bF("#quick-send-drop-area").hide();bF("#quick-send-files-area").show()}else{bF("#quick-send-drop-area").show();bF("#quick-send-files-area").hide()}return Z._toggle_send_button_state()},_toggle_top_area_view:function(){bF("#quick-send-top-part-send").hide();bF("#quick-send-top-part-confirm").show();return setTimeout(function(){bF("#quick-send-top-part-send").show();return bF("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var i;i=Z.keep_visible||!!ct.inside_root_folder;return Z._toggle_quick_send_module(i)},_toggle_quick_send_module:function(T){var i,j;if(Z._visible===T){return}j=Z.$content;if(T){Z._visible=true;j.show();return Z._update_collapsed_state()}else{Z._visible=false;j.hide();j.removeClass("collapsed expanded");i=bF("#browse-files");return i.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fo){var j,fn,i,T;fn=Z.$content;T=fo?"collapsed":"expanded";if(fn.hasClass(T)){return}i=fo?"expanded":"collapsed";fn.removeClass(i);fn.addClass(T);j=bF("#browse-files");T=fo?"quicksend-collapsed":"quicksend-expanded";i=fo?"quicksend-expanded":"quicksend-collpased";j.removeClass(i);j.addClass(T);if(!fo){return Z._init_autocompleter()}},_update_collapsed_state:function(){var i;i=Object.keys(Z._files).length;return Z._update_collapsed_view(i===0)},_remove_file:function(j,i){var T;T=false;if(j in Z._uploading_fileids){T=true;document.fire(cC.CANCEL_EVT,{file:i});bF(document).trigger(cC.CANCEL_EVT,{file:i});delete Z._uploading_fileids[j]}if(j in Z._files){$(j).remove();delete Z._files[j];Z._update_upload_list_scroll();Z._update_file_area_view();return Z._update_collapsed_state()}},_reset:function(){var j,fn,T,i;Z.autocompleter.clearTokens();T=bF(".quick-send-left-form")[0];T.reset();i=[];for(fn in Z._files){j=Z._files[fn];i.push(Z._remove_file(fn,j.file_obj))}return i},_has_added_fq_path:function(T){var i,j;for(j in Z._files){i=Z._files[j];if(i.fq_path===T){return true}}return false},_update_upload_list_scroll:function(){var j,i;j=Object.keys(Z._files).length;i=bF("#quick-send-upload-files-list");if(j<3){return i.removeClass("scroll")}else{i.addClass("scroll");return i.scrollTop=i.scrollHeight}},_add_file:function(fo,i){var fp,fu,fn,ft,fr,fs,T,j,fv,fq;fs={size:fo.bytes,source:i};ba.SharedFolderActivityLogger.log("web","quick_send_file_added",ct.active_user,fs);fu=fo.dest||Z.DEST_FOLDER;fv=aF.format_bytes(fo.bytes||0);fp=fi.tmpl("upload_list_item_tmpl");fn=fp({file:fo,icon:aA.file_icon(fo.name),filename_snippet:bU.em_snippet(fo.name,d3.FILENAME_SNIPPET_LENGTH),size:fv,dest:fu,dest_snippet:bU.em_snippet(eB("Dropbox")+fu,d3.DEST_SNIPPET_LENGTH,0),Sprite:cx});j=c0.sanitize(fn.toHTML());bF("#quick-send-upload-files-list").append(j);ft=bF("#"+fo.id);Z._update_upload_list_scroll();ft.find(".dest-col").hide();ft.find(".time-col").hide();fq=ft.find(".status-col").find("a.small-x-button");fr=fo.id;fq.on("click",function(fw){return Z._remove_file(fr,fo)});T=ft.find(".remove-link");T.on("click",function(fw){return Z._remove_file(fr,fo)});ft.on("mouseenter",(function(fw){return function(fx){ft.find(".status-col").hide();return T.show()}})(this));ft.on("mouseleave",(function(fw){return function(fx){ft.find(".status-col").show();return T.hide()}})(this));Z._files[fo.id]={file_div:fn,fq_path:fo.fq_path,bytes:fo.size,file_obj:fo};Z._update_file_area_view();return Z._update_collapsed_state()},_toggle_send_button_state:function(){var j,T,i;i=((j=Z.autocompleter)!=null?j.token_manager.tokens.length:void 0)===0;i=i&&Z.$collab_input.val()==="";T=Object.keys(Z._files).length===0||Object.keys(Z._uploading_fileids).length>0;return Z.$send_button.prop("disabled",i||T)},_file_upload_errored:function(T){var j,i;j=T.memo.file;if(j.id in Z._uploading_fileids){i={message:T.memo.message};ba.SharedFolderActivityLogger.log("web","quick_send_file_errored",ct.active_user,i);return delete Z._uploading_fileids[j.id]}},_file_upload_completed:function(j){var i;i=j.memo.file;if(i.id in Z._uploading_fileids){ba.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",ct.active_user,{});delete Z._uploading_fileids[i.id];return Z._toggle_send_button_state()}},get_folder_name:function(T){var j,i;if(Z.DEST_FOLDER){T();return}i=function(fo){var fn;fn=JSON.parse(fo);Z.DEST_FOLDER=fn.folder_name;return T()};j=function(){return ah.error(eB("We couldn\u2019t upload your file. Please try again."))};return cE.WebRequest({url:"/share/quick_send_folder_name",data:{},subject_user:Z.owner_id,success:i,error:j})},is_quicksend_dest:function(i){var j;j=aA.normalize(i);return j===Z.DEST_FOLDER},add_external_file:function(i){var T,j;j=i.dest+i.name;if(Z._has_added_fq_path(j)){ah.success(eB("You\u2019ve already added this file."));document.fire(cC.CANCEL_EVT,{file:i});bF(document).trigger(cC.CANCEL_EVT,{file:i});return}i.fq_path=j;i.bytes=i.size;Z._uploading_fileids[i.id]=true;Z._add_file(i,"external");T=bF("#"+i.id);return T.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(i){var j;if(i.dir){ah.error(eB("Please select files instead of folders."));return}if(Z._has_added_fq_path(i.fq_path)){ah.success(eB("You\u2019ve already added this file."));return}i.name=i.filename;Z._add_file(i,"dropbox");j=bF("#"+i.id);j.find(".upload-progress-bar").css({width:"100%"});j.addClass("complete");return setTimeout(function(){var T;T=j.find(".status-col");T.empty();return T.append(cx.make("web","s_check"))},0)}};var dX,cu,fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dX=E.SharedLinkSettingsModal=(function(j){fe(i,j);function i(T,fo,fn){var fp;this.owner_id=T;this.tkey=fo;this.dismiss_callback=fn;fp={tkey:this.tkey};fp[a9.UID_PARAM_NAME]=this.owner_id;i.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:fp});if(this.dismiss_callback){this.on_hide=this.dismiss_callback}}return i})(cD);cu=E.SharedLinkSettingsModalContent=(function(){function i(T,fn,j,fp){var fq,fo;this.owner_id=T;this.tkey=fn;this.filename=j;this.saved_password_placeholder_value=fp;this._save_settings=b3(this._save_settings,this);this._toggle_password_input=b3(this._toggle_password_input,this);this._enable_password_input_for_editing=b3(this._enable_password_input_for_editing,this);this._date_change_callback=b3(this._date_change_callback,this);this._show_calendar=b3(this._show_calendar,this);this._hide_calendar=b3(this._hide_calendar,this);this._future_date=b3(this._future_date,this);this._enable_save_button=b3(this._enable_save_button,this);this._custom_expiry_click_handler=b3(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=b3(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=b3(this._show_custom_expiry_label,this);this._toggle_expiration=b3(this._toggle_expiration,this);this._expiry_picker_callback=b3(this._expiry_picker_callback,this);this._listen=b3(this._listen,this);this._detect_and_handle_blur_when_password_empty=b3(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=b3(this._is_clicked,this);this._change_password_click=b3(this._change_password_click,this);this._init_expiration_section=b3(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bF(".sharing-settings-modal-content");this.modal=d8.get_containing_modal(this.$content);if(!this.modal){return}fo=eB("'%(filename)s' permissions").format({filename:bU.em_snippet(this.filename,18)});this.modal.set_title(fo);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fq=true)}this._init_expiration_section();this._listen()}i.prototype._init_expiration_section=function(){var j;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bF("#expiration-yes").prop("checked",true);j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(j);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};i.prototype._change_password_click=function(j){j.preventDefault();return this._enable_password_input_for_editing()};i.prototype._is_clicked=function(j,T){return j.is(T.target)||j.has(T.target).length};i.prototype._detect_and_handle_blur_when_password_empty=function(j){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,j)){return}return this._show_password_input(true)};i.prototype._listen=function(){if(this.loaded_with_saved_password){bF(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(j){return function(T){return d1.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bF(window).on(bA.CHANGED,this._expiry_picker_callback)};i.prototype._expiry_picker_callback=function(fo,fn){var j,T;if(fn.clicked_val===fn.old_val){return}j=fn.clicked_val;if(j!=="custom"){T=this._future_date(parseInt(j));return this._set_expiration(T)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};i.prototype._toggle_expiration=function(fn){var T,j;if(bF(fn.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();C.controller(bF(".expiration-picker")).set_value(30);j=30;T=this._future_date(j);this._set_expiration(T);return this._set_selected_date_text(T)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};i.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bF(window).on("click",this._custom_expiry_click_handler)};i.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bF(window).off("click",this._custom_expiry_click_handler)};i.prototype._custom_expiry_click_handler=function(j){if(this._is_clicked(this.$calendar,j)){return}if(this.$selected_date_box.is(j.target)||this.$selected_date_box.has(j.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};i.prototype._enable_save_button=function(j){return this.$save_button.removeAttr("disabled")};i.prototype._future_date=function(j){var T;T=d6.start_of_day(new Date());T.setDate(T.getDate()+j);return T};i.prototype._hide_calendar=function(){return this.$calendar.hide()};i.prototype._show_calendar=function(){var fn,T,j;bF(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{j=this._future_date(30)}T={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:j,onDateChange:bF.proxy(this._date_change_callback,this)};this.calendar=new I("expiration-calendar-container",T)}else{this.$calendar.show()}fn=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:fn})};i.prototype._posix_time_to_date=function(j){return new Date(j*1000)};i.prototype._set_selected_date_text=function(j){return this.$selected_date.text(N.localize(j))};i.prototype._set_expiration=function(T){var j,fn;cL(T.getMilliseconds()===0);cL(T.getSeconds()===0);cL(T.getMinutes()===0);cL(T.getHours()===0);fn=(T.getTime()+this.MS_PER_DAY)/1000;j=fn-1;return this.$expiry_posix.val(j)};i.prototype._date_change_callback=function(j){this._set_selected_date_text(j);this._set_expiration(j);this._enable_save_button();return this._hide_calendar()};i.prototype._show_password_input=function(fq){var fp,fn,T,fo,j;if(fq==null){fq=false}fp=this.$content.find("label[for=audience-password]").position().left;fo=this.$content.find("#audience-password").position().left;fn=fp-fo+10;this.$password.show().css({left:fn});this.$password_input.val("");if(fq){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");j="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(j).show();T=this.$password.position();return this.$change_password.css({left:T.left,top:T.top}).show()}else{return this._enable_password_input_for_editing()}};i.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(eB("Set password")).show();this.$password_input.focus();return this._enable_save_button()};i.prototype._toggle_password_input=function(j){var T;if(bF(j.currentTarget).attr("id")==="audience-password"){return this._show_password_input(T=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};i.prototype._save_settings=function(fo){var T,j,fn,fp;if(this.$password_input.data("is-saved-password")==="yes"){fn={type:"hidden",name:"password",value:this.saved_password_placeholder_value};T=bF("<input />",fn);this.$form.append(T);this.$password_input.attr("name","inoperative_password")}fp=(function(fq){return function(fr){d1.pop();return ah.success(eB("Settings saved."))}})(this);j=(function(fq){return function(fr){if(fq.$password.length&&fq.$password.is(":visible")){fq.$password_input.focus()}return bT.remove_loading()}})(this);return bT.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",fp,j,this.$save_button[0])};return i})();var eG;eG=E.SimpleSharing=(function(){function i(){}i.createAndShowInbandModalFromBrowseFile=function(j,T){return i.createAndShowInbandModal(j,T.fq_path,T.dir,T.target_ns,T.is_shared_folder(),T.could_be_shared_folder(),parseInt(T.sf_perm_role))};i.createAndShowInbandModalFromFile=function(j,T){return i.createAndShowInbandModal(j,T.fq_path,false,T.ns_id,false,false,d0.ACCESS_READER)};i.createAndShowM2InbandModal=function(T,fn){var fo,j;j=function(fp,fr,fq){return d1.push(new dX(fp,fr,fq))};fo=function(fq){var fp;fp=new dg(ct.active_user,fq);return fp.show()};return aI.showInstance(aI({needsFetchingTokenInfo:true,user:T,fqPath:fn,isDir:true,canReaderSync:false,isSharedFolder:true,couldBeSharedFolder:false,canEdit:true,editableLinksM2Enabled:true,showSharedLinkSettingsModal:j,onGoBackButtonClicked:fo}))};i.createAndShowInbandModal=function(j,fo,fn,fp,T,fr,ft){var fs,fq;fs=function(fv,fx,fu,fw){return window.INLINE_JS.DBModalStack.push(new ex(fv,fx,fu,fw))};fq=function(fw,fy,fx,fv,fu){return window.INLINE_JS.DBModalStack.push(new al(fw,fy,fx,fv,fu))};return dP.ShareInband.createAndShowModal(j,fo,{show_dfb_existing_folder_settings_modal:fs,show_dfb_new_folder_settings_modal:fq},Boolean(fn),fp,T,fr,parseInt(ft),ct.simple_sharing_react_member_list_enabled,ct.simple_sharing_individual_files_enabled)};i.dismissM2Prompt=function(){ct.simple_sharing_show_m2_prompt=false;return cE.WebRequest({url:"/simple_sharing_ajax/dismiss_m2_prompt"})};return i})();var eA,ev;ev=E.FoshmodalPanes=Object.clone(dr);ev.to_title_str=function(){var i,j,fp,T,fn,fo;if(eA.sharing_collection){fn=bU.em_snippet(eA.collection_to_share.name,18,1);return eB("Share '%(snippeted_name)s'").format({snippeted_name:fn})}else{i=eA._selection;T=c9.categorize_files(i),j=T[0],fp=T[1];if(j&&fp){fo=bd("Share %(file_count)s item","Share %(file_count)s items",i.length)}else{if(j){fo=bd("Share %(file_count)s photo","Share %(file_count)s photos",i.length)}else{fo=bd("Share %(file_count)s video","Share %(file_count)s videos",i.length)}}fo=fo.format({file_count:i.length});return fo}};eA=INLINE_JS.Foshmodal=E.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:ev.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=ev.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eW.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bF(".link-image").attr("src","static/images/empty_album_big.png");bT.remove_loading(bF("#modal").find(".tokenizer-submit-button")[0]);bT.remove_loading(bF("#modal").find(".foshmodal-copy-link")[0]);bT.remove_loading(bF("#shmodal-twitter-post-submit")[0]);return bT.remove_loading(bF("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(i){var j;cL(this._selection.length,"This should never be called with an empty selection");cL(this.current_tkey!=null,"Missing tkey");cL(this.current_shmodel_url!=null,"Missing shmodel url");cL(this.current_short_url!=null,"Missing short url");cL(i!=null,"Missing collection info");i.is_anonymous=this.creating_anonymous_collection();i.share_tkey=this.current_tkey;i.shmodel_url=this.current_shmodel_url;i.short_url=this.current_short_url;return j=new ad(i)},set_shmodel_url:function(j,i){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof j==="function"?j():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(T){return function(fo){var fn;fn=JSON.parse(fo.responseText);T.current_shmodel_url=fn.token_link;T.current_short_url=fn.short_link;T.current_tkey=fn.tkey;if(typeof j==="function"){j()}return typeof T.callback_for_when_we_have_shmodel_url==="function"?T.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof i==="function"?i():void 0}})}},attach_collection_to_token:function(j,i){cL(this.collection_to_share!=null,"Should get called only when there is an existing collection");cL(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof j==="function"){j(this.collection_to_share.gid)}return}cL(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,j,i)},create_collection_and_attach_to_token:function(fp,i){var T,fo,fn,j;cL(this.sharing_collection===false,"Should not get called when we already have a collection");cL(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fo=(function(fq){return function(fr){var fs;fs=JSON.parse(fr.responseText);fq.create_album_from_selected_photos(fs);return typeof fp==="function"?fp(fs.gid):void 0}})(this);T=function(fq){return typeof i==="function"?i(fq):void 0};fn={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fs,fq,ft,fr;ft=this._selection;fr=[];for(fs=0,fq=ft.length;fs<fq;fs++){j=ft[fs];fr.push(j.item_counter)}return fr}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fo,onFailure:T,parameters:fn})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ah.error(eB("Please enter a name for this album"));this.unlock();return true}if(cJ.collection_name_in_use(this.current_album_name)){ah.error(eB("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(T){var j,i;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}j=$("shmodal-send-form");cL(j,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}i=(function(fn){return function(fo){fn.unlock();if(!fo.responseText.startsWith("err:")){ah.error(eB("We couldn't send this album. Please try again."));fd.hide();return fn.refresh()}}})(this);if(this.sharing_collection){this.send_collection(j,i)}else{this.send_selection(j,i)}return g.log_interaction(em.SEND,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var fn,j,T,i,fo;fn=this.get_current_display_name();i=am.get_shmodel_send_recipients($("shmodal-send-form"));j=i[0].split(" ")[0];if(i.length===1){fo=eB("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:fn,first_name_of_recipient:j})}else{if(i.length===2){T=i[1].split(" ")[0];fo=eB("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:fn,first_name_of_recipient:j,first_name_of_second_recipient:T})}else{fo=eB("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:fn,first_name_of_recipient:j,num_other_recipients:i.length-1})}}return fo},send_selection:function(T,j){var fo,fn,i;fo=(function(fp){return function(fq){var fr;fr=JSON.parse(fq.responseText);fp.create_album_from_selected_photos(fr);ah.success(fp.get_send_success_text());fp.refresh();return fd.hide()}})(this);fn={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fr,fp,fs,fq;fs=this._selection;fq=[];for(fr=0,fp=fs.length;fr<fp;fr++){i=fs[fr];fq.push(i.item_counter)}return fq}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};if(this.creating_anonymous_collection()){fn.collection_name=""}else{if(this.current_album_name.trim().length===0){fn.collection_name=cJ.get_default_album_name()}}return bT.ajax_submit(T,"/collection_create_and_send_link",fo,j,T.down(".tokenizer-submit-button"),fn)},send_collection:function(j,i){var T;cL(this.current_tkey!=null,"tkey should be set");cL(this.current_shmodel_url!=null,"shmodel url should be set");T=(function(fn){return function(){ah.success(fn.get_send_success_text());fd.hide();return fn.refresh()}})(this);return this.collection_to_share.send_link(j,this.current_tkey,this.current_shmodel_url,this.current_short_url,T,i)},get_link_button_onclick:function(){var i,T,j;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}j=$("modal").down(".tokenizer-submit-button");T=(function(fn){return function(fp){var fo;fo=fn.get_current_display_name();if(FlashDetect.installed){ah.success(eB("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fo}))}fn.show_get_link_modal(fn.current_shmodel_url,fo,fp);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(fn.collection_to_share!=null){cA.log_share("share_link",fp,fn.num_photos_to_share,fn.creating_anonymous_collection(),!fn.sharing_collection)}return fn.refresh()}})(this);i=(function(fn){return function(fo){fn.unlock();bT.remove_loading(j);if(!fo.responseText.startsWith("err")){ah.error(eB("We couldn't create a link to this album. Please try again."));fd.hide();return fn.refresh()}}})(this);if(this.sharing_collection){bT.add_loading(j);this.attach_collection_to_token(T,i)}else{if(this.alert_if_album_name_invalid()){return}bT.add_loading(j);this.create_collection_and_attach_to_token(T,i)}return g.log_interaction(em.GET_LINK,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var i,j;if(FlashDetect.installed){i=t.clipboard_overlay(this.current_shmodel_url,bF("#foshmodal-copy-link"),eA.get_link_button_onclick.bind(this));i.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);j=(function(T){return function(){return i.clonePosition(bF("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(j,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(fp,j){var fo,T,i,fn;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(fp,j);return}fo=bF("#modal:visible, #modal-overlay:visible");i=function(){return fo.show()};T=(function(fq){return function(){fq.lock();setTimeout(fq.unlock.bind(fq),750);return er.do_auth((function(){return fq.do_fb_post(j)}),j)}})(this);if(er.authed_user_id===j){this.do_fb_post(j)}else{if(cM.get_viewer().is_uid_associated(er.authed_user_id)){this.unlock();fo.hide();fn=new ee(cM.get_viewer().get_user_by_id(j),i,T.bind(this));fn.show()}else{T()}}return g.log_interaction(em.FB_SHARE,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(j,i){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(j,i);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cG.is_authed(i)){this.do_twitter_post(i)}else{setTimeout(this.unlock.bind(this),750);cG.do_auth(((function(T){return function(){return T.do_twitter_post(i)}})(this)),i)}return g.log_interaction(em.TWITTER_SHARE,dc.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(i){var j,T;j=(function(fn){return function(){ah.error(eB("We couldn't share this album on Facebook. Please try again."));fd.hide();return fn.refresh()}})(this);T=(function(fn){return function(fp){var fo;er.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};er.progress_container=$("modal").down(".modal-buttons");fo=fn.get_current_display_name();er.custom_show_complete=function(){fd.hide();ah.success(eB("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fo}));return fn.refresh()};er.post($F("shmodal-fb-post-input"),fn.current_shmodel_url,null,null,null,j,i);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cA.log_share("share_facebook",fp,fn.num_photos_to_share,fn.creating_anonymous_collection(),!fn.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},do_twitter_post:function(i){var fn,j,T;fn=$F("shmodal-twitter-post-input");if(!fn){ah.error(eB("Please enter a tweet"));this.unlock();return}if(fn.length>140){ah.error(eB("Your tweet must be 140 characters or less"));this.unlock();return}T=(function(fo){return function(fp){cG.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};cG.custom_post(fn,function(){fd.hide();ah.success(eB("Your tweet has been posted!"));return fo.refresh()},i);ba.ViralLogger.log(cM.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cA.log_share("share_twitter",fp,fo.num_photos_to_share,fo.creating_anonymous_collection(),!fo.sharing_collection)}})(this);j=(function(fo){return function(){ah.error(eB("We couldn't share this album on Twitter. Please try again."));fd.hide();return fo.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},show_get_link_modal:function(j,i,T){var fn;fd.show(eB("Link to %(album_name)s").format({album_name:i.escapeHTML()}),$("get-link-modal"));fn=$("get-link-modal").down(".link-input");fn.setValue(j);fn.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(j,"_blank");return fd.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(T!=null){cJ.flash_sidebar_album(T)}return fd.hide()}},update_current_album_name_text:function(i){this.current_album_name=$(ev.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===ev.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fo){var j,fn,T,i;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(fo){if(this.num_photos_to_share===1){j=fo}else{j=eB("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fo,album_desc:c9.file_desc(i)})}}else{if(i.length===1){T=i[0];if(T.preview_type==="photo"){fn=eB("Photo from %(date_taken)s")}else{fn=eB("Video from %(date_taken)s")}j=fn.format({date_taken:b6.nice_date_with_month_name(new Date(T.time_taken),true,true,true)})}else{j=c9.file_desc(i)}}return $(ev.to_content_str(ev.FB)).down(".link-name").__date(j)},set_current_album_name_text:function(j,i){$(ev.to_content_str(j)).down(".album-name-input").value=i;if(j===ev.FB){return this.set_fb_post_title(i)}},show_content:function(fp){var fn,T,j,fo;if(this.working){return}$("shmodal-title-text").__date(ev.to_title_str());fo=ev.list;for(T=0,j=fo.length;T<j;T++){fn=fo[T];if(fn!==fp){$(ev.to_toggle_str(fn)).removeClassName("toggled");$(ev.to_content_str(fn)).hide()}}$(ev.to_content_str(fp)).show();$(ev.to_toggle_str(fp)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(fp,this.current_album_name)}switch(fp){case ev.FB:$("shmodal-fb-post-input").focus();break;case ev.TWITTER:$("shmodal-twitter-post-input").focus();break;case ev.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=fp},_get_foshmodal_title:function(){return am.generate_title_content(ev.to_title_str(),((function(i){return function(){return i.show_content(ev.SEND)}})(this)),((function(i){return function(){return i.show_content(ev.FB)}})(this)),((function(i){return function(){return i.show_content(ev.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return c9.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var i,fn,j,fo,T;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(i.length===1){T=c9.categorize_files(i),j=T[0],fo=T[1];if(j){fn=eB("Just shared a photo using @Dropbox")}else{if(fo){fn=eB("Just shared a video using @Dropbox")}else{cL(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{fn=eB("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(fn+" "+this.current_short_url)},update_shmodal_image_text:function(){var fr,fs,fo,ft,fp,fw,T,fu,fq,fn,fv;if(this.sharing_collection){fw=this.collection_to_share.num_items;fv=c9.album_desc(this.collection_to_share,false,true)}else{fw=this._selection.length;fv=c9.file_desc(this._selection,false,true)}if(fw>1){T=$$(".shmodal-image");fq=[];for(fs=0,ft=T.length;fs<ft;fs++){fr=T[fs];fr.down("span").__date(fv);fq.push(fr.down(".share-file-count").show())}return fq}else{fu=$$(".shmodal-image");fn=[];for(fo=0,fp=fu.length;fo<fp;fo++){fr=fu[fo];fn.push(fr.down(".share-file-count").hide())}return fn}},show:function(fs,fB){var fu,fr,fy,fz,fq,fo,fw,fp,fn,ft,T,fx,fv,fA;this.unlock();fd.onHide=(function(i){return function(){var fC,j;if((fC=$("flash_copy_container"))!=null){fC.remove()}if((j=i.send_link_autocompleter)!=null){j.hide()}bF("#modal").find(".new-collab-input").val("");clearInterval(i.follow_freshbutton);bQ.disable_selection();delete fd.onHide;return fd.hide()}})(this);this.sharing_collection=fB;fA=this.sharing_collection?fs.thumbnail_url_256:fs[0].thumbnail_url;T=$$(".link_image");for(fr=0,fw=T.length;fr<fw;fr++){fy=T[fr];if(fA!=null){fy.src=fA}else{fy.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=ev.SEND;this.have_real_tkey=this.sharing_collection&&(fs.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fs;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fs.sort(function(j,i){return j.time_taken-i.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fx=$$(".save-as-album-checkbox");for(fq=0,fp=fx.length;fq<fp;fq++){fu=fx[fq];fu.checked=false;ft=(function(i){return function(fJ){var fK,fE,fC,fF,fD,fI,fH,fG,j;if(fJ.target.checked){$("shmodal").addClassName("saving-as-album");i.current_album_name=i.previous_album_name||cJ.get_default_album_name();i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fK=$(ev.to_content_str(i.current_foshmodal_pane)).down(".album-name-input");fK.focus();fK.select();fI=$$(".save-as-album-checkbox");fG=[];for(fE=0,fF=fI.length;fE<fF;fE++){fu=fI[fE];fG.push(fu.checked=true)}return fG}else{$("shmodal").removeClassName("saving-as-album");i.previous_album_name=i.current_album_name;i.current_album_name="";i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fH=$$(".save-as-album-checkbox");j=[];for(fC=0,fD=fH.length;fC<fD;fC++){fu=fH[fC];j.push(fu.checked=false)}return j}}})(this);fu.observe("change",ft);if(b1.msie_version_at_most(8)){fu.observe("click",ft)}}fv=$$(".album-name-input");for(fo=0,fn=fv.length;fo<fn;fo++){fz=fv[fo];fz.observe("keyup",this.update_current_album_name_text.bind(this))}}bQ.enable_selection();fd.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(i){return function(){i.initialize_get_link_button();return i.set_twitter_message()}})(this)),(function(){ah.error(eB("This request could not be completed.  Please try again."));return fd.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();V.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return d6._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var eF,aq,c1,dT,cC,d3,bp,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};cC=INLINE_JS.Upload=E.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var T,j,fn,i;fn={"MSIE 8.0":"flash","MSIE 9.0":"flash"};j="html5";for(T in fn){i=fn[T];if(navigator.userAgent.indexOf(T)!==-1){j=i}}return j})(),choose_button_id:"choose-button",set_dest:function(i){dv.fillVal(i,"dest-folder");return this.current_dest=i},init:function(T,fn,fo,j){var i;this.set_dest(T);i=this.initPLU(fo,j);if(!fn){an.window_load(i)}else{i()}bF("#flash-upload-container > .moxie-shim").each(function(fp){if(fp.observe){d6.freshbutton_overlay(fp,$("choose-button"));return d6.freshbutton_overlay(fp,$("add-button"))}});return aq.clear()},init_basic:function(){d6.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(i){return document.fire(cC.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(T){var j,i,fn;j=$("modal").cumulativeOffset();fn=T.clientY-j.top-3;i=T.clientX-j.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:fn+"px",left:i+"px"})});return $("file-box").observe("change",function(){var fo,T,fp,fn,i,j;fd.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();T=$("file-box").getValue().split("\\").pop();fn=cx.make("web",aA.file_icon(T));$("basic-upload-status").down(".icon").__date(fn);fo=eB("Uploading %(filename)s").format({filename:bU.em_snippet(T,25)});$("basic-upload-status").down(".file-desc").__date(fo);$("basic-upload-status").show();$("basic-uploading-message").show();fp=$("file-box").files;j=0;if(fp){i=fp[0].lastModifiedDate;if(i){j=Math.round(Date.parse(i)/1000)||0}}if(!j){j=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=j;return $("basic-upload-form").submit()})},initPLU:function(j,i){return(function(T){return function(){var fo,fn;fo={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:T.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:T.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(j){j()}return T.uploaderLoaded()},Error:T.uploadError.bind(T)},init:{FilesAdded:T.fileQueued.bind(T),UploadProgress:T.uploadProgress.bind(T),FileUploaded:T.uploadSuccess.bind(T),BeforeUpload:T.prepareFileForUploading.bind(T),ChunkUploaded:T.chunkUploaded.bind(T),UploadComplete:aq.finished.bind(aq),Refresh:function(){if(T.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bF("#flash-upload-container").clonePosition(bF("#add-button"));bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aN.UrlConstants.MOXIE_SWF_URL};if(i!=null){bF.extend(fo,i)}fn=new p.Uploader(fo);T.PLU=fn;return T.PLU.init()}})(this)},reset:function(){if(aq.uploading&&aq.current_file){this.PLU.removeFile(aq.current_file)}return c1.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return c1.show()}},updatePostParams:function(T){var j,i;i=this.PLU.settings.multipart_params;for(j in T){if(T.hasOwnProperty(j)){i[j]=T[j]}}return this.PLU.settings.multipart_params=i},fileQueued:function(fo,fq){var fp,T,i,fn;for(T=0,i=fq.length;T<i;T++){fp=fq[T];if((typeof fp.getNative==="function"?(fn=fp.getNative())!=null?fn.dest:void 0:void 0)===void 0){fp.dest=cC.current_dest}else{fp.dest=fp.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fq});bF(document).trigger(this.QUEUE_EVT,{files:fq});if(Z.is_quicksend_dest(fp.dest)){return}return this.show_upload()},uploadNext:function(){var fo,T,i,j,fp,fn;j=aq.next();i=(bx.contains(cC.APPLE_PACKAGE_EXTENSIONS,aA.file_extension_for_logging(j.name))&&j.size%34===0)||(aA.file_extension_for_logging(j.name)===""&&j.size%34===0&&j.size<=3400);if(i){j.status=p.FAILED;T={file:j,code:cC.APPLE_PACKAGE_ERROR,message:eB("Can\u2019t Upload"),tooltip_text:eB('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,T);return false}fp={dest:aq.next().dest,t:bw.read(aK.JS_CSRF_COOKIE)};fp[a9.UID_PARAM_NAME]=ct.active_user;if((fn=aA.file_extension(j.name,fo=true))==="url"||fn==="webloc"||fn==="website"){fp.overwrite=0}cC.updatePostParams(fp);this.PLU.start();aq.last_update_time=0;aq.last_update_size=0;return true},pause:function(){return cC.PLU.stop()},uploadProgress:function(j,i){if(!aq.cancelled_files[i.id]){document.fire(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size});return bF(document).trigger(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size})}},generateUploadId:function(){var T,fo,fn,fp;T="";for(fo=fn=0;fn<=15;fo=++fn){T+=String.fromCharCode(Math.floor(Math.random()*256))}fp=ak.encode(T);fp=fp.replace(/\+/g,"-");fp=fp.replace(/\//g,"_");fp=fp.replace(/\=*$/,"");return fp},chunkUploaded:function(j,T,fn){var i;i=JSON.parse(fn.response||"");return this.updatePostParams({offset:i.offset})},prepareFileForUploading:function(){var i;i=aq.next();return this.updatePostParams({reported_total_size:i.size,dest:i.dest,t:bw.read(aK.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fo,fn,T){var j,fp,i;try{i=JSON.parse(T.response)}catch(fp){j=fp;i=null}if(T.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:fn,message:eB("Quota exceeded"),tooltip_text:eB("Your upload failed because you are over quota.")});return bF(document).trigger(this.ERROR_EVT,{file:fn,message:eB("Quota exceeded"),tooltip_text:eB("Your upload failed because you are over quota.")})}else{if(T.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:fn,message:eB("Empty File")});return bF(document).trigger(this.CANCEL_EVT,{file:fn,message:eB("Empty File")})}else{if(T.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:fn,message:eB("File Ignored")});return bF(document).trigger(this.CANCEL_EVT,{file:fn,message:eB("File Ignored")})}else{if((i!=null?i.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:fn});return bF(document).trigger(this.COMPLETE_EVT,{file:fn})}else{document.fire(this.ERROR_EVT,{file:fn});return bF(document).trigger(this.ERROR_EVT,{file:fn})}}}}},uploadComplete:function(j,i){document.fire(this.COMPLETE_EVT,{file:i});return bF(document).trigger(this.COMPLETE_EVT,{file:i})},uploadError:function(fo,i){var fn,T,j;if((j=i.file.id,cT.call(aq.file_ids(),j)<0)&&i.code!==cC.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[i.file]});bF(document).trigger(this.QUEUE_EVT,{files:[i.file]})}T=(function(){switch(i.code){case p.FILE_SIZE_ERROR:return eB("File too large");default:return eB("Upload Error")}})();this.show_upload();fn={file:i.file,error_code:i.code,message:T};if(i!=null?i.tooltip_text:void 0){fn.tooltip_text=i.tooltip_text}document.fire(this.ERROR_EVT,fn);return bF(document).trigger(this.ERROR_EVT,fn)},grabURL:function(){var i;i=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(i)){$("url").value=i}return true},treeview_handler:function(j,i){var T;dv.fillVal(j,"dest-folder");T=$("basic-uploader-url");if(T){T.href=T.href.replace(/(\/upload)(.*)(\?basic=1)/,function(fp,fo,fq,fn){return fo+d6.urlquote(j)+fn})}return aq.clear()},new_folder:function(){b2.hide();fd.show(eB("Create new folder..."),dv.fromElm("create-folder"),{action:this.do_new_folder.bind(this,ct.active_user),wit_group:"new-folder-confirm"});if(!d6.ie){return bF("#first-treeview-link").trigger("click")}},do_new_folder:function(i){var T,j;if(!fd.vars.selected_path){ah.error(eB("Please select a parent folder."));return}j=$F("entered-name");T=fd.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+d6.urlquote(T)+"?to_path="+d6.urlquote(j),{subject_user:i,onSuccess:(function(fn){return function(fo){fn.treeview_handler(aA.normalize(T)+"/"+j);return b2.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cC.PLU.runtime==="flash"){bF("#flash-upload-container").clonePosition(bF("#choose-button"));bF("#flash-upload-container > .moxie-shim")[0].style.top="0px";bF("#flash-upload-container > .moxie-shim")[0].style.left="0px";bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bF("#"+this.choose_button_id).click((function(i){return function(j){return bF("#"+i.PLU.id+"_html5").click()}})(this));return bF("#add-button").click((function(i){return function(j){return bF("#choose-button").click()}})(this))}}};aq=E.FileQueue={init:function(){return aq._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,aq._file_queued.bind(this));document.observe(cC.QUEUE_ERROR_EVT,aq._file_queue_errored.bind(this));document.observe(cC.UPDATE_EVT,aq._file_updated.bind(this));document.observe(cC.COMPLETE_EVT,aq._file_completed.bind(this));document.observe(cC.ERROR_EVT,aq._file_errored.bind(this));return document.observe(cC.CANCEL_EVT,aq._file_cancelled.bind(this))},_file_queued:function(fq){var fo,T,i,fp,fn;fp=fq.memo.files;fn=[];for(T=0,i=fp.length;T<i;T++){fo=fp[T];this.files[fo.id]=fo;if(!aq.uploading){this._start_uploading()}this.current_file=fo;fn.push(eJ("File queued:",fo.name))}return fn},_file_queue_errored:function(i){this._file_queued(i);return setTimeout(((function(j){return function(){return j._file_errored(i)}})(this)),250)},_file_updated:function(fs){var fn,i,j,T,fq,fp,fo,fr,ft;T=fs.memo.file;fp=fs.memo.percent_complete;fq=fp*T.size;ft=fq+this.completed_size();j=new Date().getTime();if(this.last_update_time){fo=(j-this.last_update_time)/1000;if(cC.PLU.total.bytesPerSec){this.average_bps=cC.PLU.total.bytesPerSec}else{i=fq-this.last_update_size;fn=i/fo;this.average_bps=((ft-i)*this.average_bps+i*fn)/ft}fr=(this.queue_size()-ft)/this.average_bps;this.formatted_time=b6.format_time(fr+this.num_left())}this.current_file=T;this.last_update_time=new Date().getTime();return this.last_update_size=fq},_file_completed:function(j){var i;i=j.memo.file;this.completed_files[i.id]=true;eJ("File completed:",i.name);return this._check_if_finished(i)},_file_errored:function(j){var i;i=j.memo.file;this.errored_files[i.id]=true;eF.update_errors();c1.update_errors();eJ("File errored:",i.name);return this._check_if_finished(i)},_file_cancelled:function(j){var i;i=j.memo.file;this.cancelled_files[i.id]=true;if(i.status===p.UPLOADING){cC.PLU.stop();cC.PLU.removeFile(i);cC.PLU.start()}else{cC.PLU.removeFile(i)}eJ("File cancelled:",i.name);return this._check_if_finished(i)},_start_uploading:function(){var i;this.uploading=cC.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=i=(function(j){return function(){return eB("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(i){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cC.uploadNext()}},_finished_uploading:function(){var j,T,fn,i;this.uploading=false;if(!this.num_files()){eF.cancelled()}else{if(this.errors()){eF.errored();c1.errored()}else{eF.completed();c1.completed()}}i=$("inline-upload-status").visible();ct.select_fq_paths=[];if(ct.inside_dir){for(fn in this.completed_files){T=this.files[fn];j=aA.normalize(T.dest);ct.select_fq_paths.push(j+"/"+T.name)}ct.force_reload()}else{if(ct.in_search_mode()){cb.force_reload()}}if(i){c1.show()}fd.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return bx(this.files).filter((function(i){return function(j){return !(i.cancelled_files[j.id]||i.errored_files[j.id]||i.completed_files[j.id])}})(this))[0]},cancels:function(){return bx(this.cancelled_files).keys().length},errors:function(){return bx(this.errored_files).keys().length},queue_size:function(){var fn,fq,T,i,fp,fo;fo=0;fp=this.file_ids();for(T=0,i=fp.length;T<i;T++){fq=fp[T];fn=this.files[fq];if(!this.errored_files[fq]&&!this.cancelled_files[fq]&&typeof fn.size!=="undefined"){fo+=fn.size}}return fo},completed_size:function(){var fp,T,i,fo,fn;fn=0;fo=bx(this.completed_files).keys();for(T=0,i=fo.length;T<i;T++){fp=fo[T];if(typeof this.files[fp].size!=="undefined"){fn+=this.files[fp].size}}return fn},file_ids:function(){return bx(this.files).map((function(i){return function(j,T){return T}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return bx(this.file_ids()).filter((function(i){return function(j){return !(i.cancelled_files[j]||i.errored_files[j]||i.completed_files[j])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof fd!=="undefined"&&fd!==null){return fd.onHide=null}}};aq.clear();d3=E.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){d3._tmpl=fi.tmpl("upload_list_item_tmpl");return d3._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,d3._file_queued);document.observe(cC.QUEUE_ERROR_EVT,d3._file_queue_errored);document.observe(cC.UPDATE_EVT,d3._file_updated);document.observe(cC.COMPLETE_EVT,d3._file_completed);document.observe(cC.ERROR_EVT,d3._file_errored);return document.observe(cC.CANCEL_EVT,d3._file_cancelled)},_file_queued:function(fq){var fo,T,i,fp,fn;fp=fq.memo.files;fn=[];for(T=0,i=fp.length;T<i;T++){fo=fp[T];fn.push((function(fr){var fx,j,fu,fw,fv,fy,fs,ft;fx=fr.dest;if(Z.is_quicksend_dest(fx)){Z.add_external_file(fr);return}fy=aF.format_bytes(fr.size||0);j=d3._tmpl({file:fr,icon:aA.file_icon(fr.name),filename_snippet:bU.em_snippet(fr.name,d3.FILENAME_SNIPPET_LENGTH),size:fy,dest:fx,dest_snippet:bU.em_snippet(eB("Dropbox")+fx,d3.DEST_SNIPPET_LENGTH,0),Sprite:cx});$("upload-files-list").__sert(j);fw=$(fr.id);fv=aq.num_files();if(dx.show_share_button_in_file_uploader){fu=bF("#"+fr.id);fu.find(".dest-col").hide()}fs=$("upload-files-list");if(fv<=6){fs.removeClassName("scroll")}else{fs.addClassName("scroll")}fs.scrollTop=fs.scrollHeight;fw.down(".dest").observe("click",function(){ct.reload_fqpath(fw.readAttribute("data-dest"),true);return fd.hide()});ft=fw.down(".status-col").down("a.small-x-button");ft.stopObserving("click");ft.observe("click",function(fz){document.fire(cC.CANCEL_EVT,{file:fr});return bF(document).trigger(cC.CANCEL_EVT,{file:fr})});return fw.down(".upload-progress-bar").setStyle({width:"0"})})(fo))}return fn},_file_queue_errored:function(i){d3._file_queued(i);return d3._file_errored(i)},_file_updated:function(fn){var T,fo,j,i;T=fn.memo.file;fo=$(T.id);if(aq.num_files()===1){i=eB("%(time_left)s left").format({time_left:aq.formatted_time});fo.down(".time-col").__date(i)}j=parseInt(T.percent,10)+"%";if(j==="100%"){fo.down(".time-col").__date();fo.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fo.down(".upload-progress-bar").setStyle({width:j})},_file_completed:function(j){var i,T,fn;i=j.memo.file;i.completed=true;fn=$(i.id);fn.addClassName("complete");if(dx.show_share_button_in_file_uploader&&!Z.is_quicksend_dest(i.dest)){T=bF("#"+i.id);T.find(".share-link").show();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",ct.active_user,{});T.on("click",function(fq){var fp,fo;fd.hide();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",ct.active_user,{});fp=i.dest+"/"+i.name;fo="file_uploader";return dx.shmodel(fp,fo)})}setTimeout(function(){return fn.down(".status-col").__date(cx.make("web","s_check"))},0);return fn.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(j){var i,T;i=j.memo.file;T=$(i.id);if(T){return d3._actual_file_errored(j)}else{return setTimeout((function(fn){return function(){return d3._actual_file_errored(j)}})(this),0)}},_actual_file_errored:function(fo){var i,T,j,fp,fn;j=fo.memo.file;fp=$(j.id);fp.addClassName("error");fp.down(".dest-col").hide();fp.down(".time-col").__date();fp.down(".status-col").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));fp.down(".upload-progress-bar").setStyle({width:"100%"});if(Z.is_quicksend_dest(j.dest)){return}T=fo.memo.message||eB("Upload Error");i=void 0;if(fo.memo.tooltip_text){i=fo.memo.tooltip_text}else{i=eB('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bF(document).on("click","a#basic_link",function(){dD.show_basic_upload();return false})}fp.down(".error-msg").__date(T);fn=fp.down(".error-details");fn.observe("mouseover",function(){return ej.show(fn,i)});return fp.down(".error-col").show()},_file_cancelled:function(j){var i,T;i=j.memo.file;T=$(i.id);T.addClassName("cancelled");T.down(".dest-col").__date(eB(j.memo.message||"Canceled"));T.down(".time-col").__date();T.down(".status-col").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return T.down(".upload-progress-bar").setStyle({width:"100%"})}};eF=E.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return eF._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,eF._file_queued.bind(this));return document.observe(cC.UPDATE_EVT,eF._file_updated.bind(this))},_file_queued:function(j){var i;i=new Element("a",{"class":"small-x-button"});i.observe("click",function(){var fp,fq,fn,T,fo;aq.all_cancelled=true;fp=aq.file_ids().slice(0);fo=[];for(fn=0,T=fp.length;fn<T;fn++){fq=fp[fn];if(!aq.completed_files[fq]&&!aq.errored_files[fq]){document.fire(cC.CANCEL_EVT,{file:aq.files[fq]});fo.push(bF(document).trigger(cC.CANCEL_EVT,{file:aq.files[fq]}))}else{fo.push(void 0)}}return fo});return this.elem.down(".status").__date(i)},_file_updated:function(fn){var T,j,i;if(aq.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");T=bd("%d file","%d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(T);j=eB("- %(size)s").format({size:aF.format_bytes(cC.PLU.total.size)});this.elem.down(".size").__date(j);if(aq.formatted_time){i=eB("%(time_left)s left").format({time_left:aq.formatted_time});this.elem.down(".time-left").__date(i)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(aq.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cC.PLU.runtime==="flash"){return bF("#flash-upload-container").clonePosition(bF("#add-button"))}}},update_errors:function(){var i;i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return $("bulk-upload-status").down(".num-errors").__date(i)},completed:function(){var j,i;$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("complete");j=bd("Uploaded %d file","Uploaded %d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(j);i=eB("- %(size)s").format({size:aF.format_bytes(aq.completed_size())});this.elem.down(".size").__date(i);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cx.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var i;$("hide-button").hide();$("done-button").show();this.completed();i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return this.elem.down(".num-errors").__date(i)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(eB("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return this.elem.down(".upload-progress-bar").style.width="100%"}}};c1=E.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cC.QUEUE_EVT,c1._file_queued.bind(this));return document.observe(cC.UPDATE_EVT,c1._file_updated.bind(this))},_file_queued:function(T){var j,i;j=$("inline-upload-status");j.removeClassName("error");j.removeClassName("complete");j.down(".icon").__date(cx.make("web","s_sync"));j.down(".file-desc").__date(eB("Starting upload..."));j.down(".num-errors").__date();i=bd("%d file","%d files",aq.num_left()).format(aq.num_left());j.down(".view-details").__date(i);j.down(".status").__date();return j.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fq){var fp,T,fn,fo,j,i;fp=$("inline-upload-status");T=fq.memo.file;fp.down(".icon").__date(cx.make("web","s_sync"));fn=eB("Uploading %(filename)s").format({filename:bU.em_snippet(T.name,this.FILENAME_SNIPPET_LENGTH)});fp.down(".file-desc").__date(fn);if(aq.num_left()>1){i=bd("%d file left","%d files left",aq.num_left()-1).format(aq.num_left()-1);fp.down(".view-details").__date(i)}else{fp.down(".view-details").__date(eB("View details"))}if(aq.formatted_time){j=eB("%(time_left)s left").format({time_left:aq.formatted_time});fp.down(".status").__date(j)}fo=T.percent+"%";return fp.down(".inline-upload-progress").style.width=fo},update_errors:function(){var i,j;i=$("inline-upload-status");j=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return i.down(".num-errors").__date(j)},add_x_button:function(){var i,j;j=new Element("a",{"class":"small-x-button"});j.observe("click",function(){c1.hide();return cC.reset()});i=$("inline-upload-status");return i.down(".status").__date(j)},completed:function(){var j,i;j=$("inline-upload-status");j.addClassName("complete");j.removeClassName("error");j.down(".icon").__date(cx.make("web","s_check"));if(aq.num_files()>1){i=eB("Uploaded %(num_files)d files").format({num_files:aq.num_non_cancelled_files()})}else{i=eB("Uploaded %(filename)s").format({filename:bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}j.down(".file-desc").__date(i);j.down(".num-errors").__date();j.down(".view-details").__date(eB("View details"));this.add_x_button();return j.down(".inline-upload-progress").style.width="100%"},errored:function(){var T,j,i,fn;T=$("inline-upload-status");T.addClassName("error");T.removeClassName("complete");T.down(".icon").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));j=void 0;if(aq.num_files()>1){j=eB("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:aq.num_non_cancelled_files()-aq.errors(),num_files:aq.num_non_cancelled_files()});T.down(".file-desc").__date(j);fn=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());T.down(".num-errors").__date(fn)}else{if(aq.current_file!=null){i=bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)}j=i?eB("Unable to upload %(filename)s").format({filename:i}):eB("Unable to upload file");T.down(".file-desc").__date(j);T.down(".num-errors").__date()}T.down(".view-details").__date(eB("View details"));this.add_x_button();return T.down(".inline-upload-progress").style.width="100%"},show:function(i){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bp=E.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bp.supported()&&ct.inside_dir&&!(ct.in_search_mode()&&cb.fulltext_search_enabled)},browse_indicators_enabled:function(){var fo,T,i,fn;if(!bp.enabled()){return false}fn=["modal-overlay"];if(cC.choose_button_id.startsWith("wizard-")){fn.push("wizard-overlay")}for(T=0,i=fn.length;T<i;T++){fo=fn[T];if($(fo).visible()){return false}}return true},modal_indicators_enabled:function(){var i;return bp.enabled()&&bF("#modal #upload-modal-dropzone").length&&bF("#modal").visible()&&((i=bF("#modal").offset())!=null?i.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(i){return bF(i).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(j){var i;if(!bp._drop_indicators){if(bp.modal_indicators_enabled()){i=$("upload-modal-dropzone");bF(i).clonePosition(bF("#modal"),{setLeft:false,setTop:false});bF(i).fadeIn(500);bp._show_border_drop_indicators()}else{if(bp.browse_indicators_enabled()){bR._add_drop_indicators(j)}else{return}}$("drag-status").removeClassName("active");return bp._drop_indicators=true}},hide_drop_indicators:function(){if(bp._drop_indicators){bp._hide_border_drop_indicators();bR._remove_drop_indicators();if(!bp._notifications_cleared){ah.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bp._drop_indicators=false;bp._drop_dest_folder=null;return bp._notifications_cleared=false}),500)}return bp._notifications_cleared=true},folder_dragover:function(i){var j;if(bp.browse_indicators_enabled()&&bp._drop_indicators){if(dT.disabled){if(bp._drop_dest_folder==null){j=eB("You can't upload files because you're out of space.");ah.error(j,60);bp._notifications_cleared=false;bp._show_border_drop_indicators()}}else{if(i!==bp._drop_dest_folder){if(i===ct.containing_fq_path()){if(ct.inside_read_only_shared_folder){j=eB("You don't have permission to add to this folder.");ah.error(j,60)}else{j=eB("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dD.upload_plain_snippet()});ah.success(new fi(j),60);bp._show_border_drop_indicators()}bp._notifications_cleared=false}else{ah.clear();bp._hide_border_drop_indicators()}}}return bp._drop_dest_folder=i}},supports_recursive_upload:function(i){var j;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(i!=null?(j=i[0])!=null?j.webkitGetAsEntry:void 0:void 0)},upload:function(fo,fq,T){var fp,fn,i,fr;if(T==null){T=null}if(ct.inside_read_only_shared_folder){return}if(dT.disabled){fr=eB("You can't upload files because you're out of space.");return ah.error(fr)}else{if(bp.supports_recursive_upload(T)){return bp._recursive_upload(fo,T)}else{for(fn=0,i=fq.length;fn<i;fn++){fp=fq[fn];fp.dest=fo}return bp._upload(fq,T)}}},_recursive_upload:function(fw,fu){var fy,ft,i,fn,fo,fv,fs,fz,T,fx,fp,fr,fq;T=[];fq=[];ft=function(j,fA){j.dest=fw+aA.parent_dir(fA.fullPath);return T.push(j)};for(fp=0,fr=fu.length;fp<fr;fp++){fx=fu[fp];fv=fx.webkitGetAsEntry();if(fv!==null){if(fv.isDirectory){if(Z.is_quicksend_dest(fw)){ah.error(eB("Please select files instead of folders."))}else{fq.push(fv)}}else{ft(fx.getAsFile(),fv)}}}fo=0;fz=0;i=function(j,fB){var fA;fA=eB('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fB.name});ah.error(new fi(fA));return bF("#use-advanced-uploader").on("click",function(fC){fC.preventDefault();return dD.show_upload()})};fy=3000;fs=0;fn=function(){var j;while(fq.length){fv=fq.pop();if(fv!==null){if(fv.isDirectory){(function(fB){var fA;fA=fB.createReader();fo+=1;return fA.readEntries(function(fC){var fF,fD,fE;if(fC.length!==0){for(fD=0,fE=fC.length;fD<fE;fD++){fF=fC[fD];fq.push(fF)}return fA.readEntries(arguments.callee)}else{return fo-=1}},function(fC){fo-=1;return i(fC,fB)})})(fv)}else{fz+=1;j=function(fA){return function(fB){ft(fB,fA);return fz-=1}};fv.file(j(fv),function(fA){fz-=1;return i(fA,fv)})}}}if(T.length>fy&&!fs){fs=1;ah.error(eB("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fy}));return}if(fo||fz){return fn.defer()}else{if(T.length){return bp._upload(T)}}};return fn()},_upload:function(fn,j){var i,T;if(j==null){j=null}if(j){i=this._parse_upload_items(j)}T=function(){var fr,fp,fo,fs,fq;fq=[];for(fp=0,fo=fn.length;fp<fo;fp++){fr=fn[fp];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(i!=null?(fs=i[fr.name])!=null?fs.isDirectory:void 0:void 0)){fr.is_directory=true}fr.id=p.guid();fq.push(cC.PLU.addFile(fr))}return fq};if($("modal").visible()){return T()}else{dD.show_upload(T);return fd.hide(null,true)}},_parse_upload_items:function(T){var fo,fp,fn,i;fo={};for(fn=0,i=T.length;fn<i;fn++){fp=T[fn];if(fp.getAsEntry){fp=fp.getAsEntry()}else{if(fp.webkitGetAsEntry){fp=fp.webkitGetAsEntry()}}fo[fp.name]=fp}return fo}};dT=E.OverQuotaUploads={disabled:false,init:function(i){this.disabled=i;if(this.disabled){return bF("body").addClass("uploads-disabled")}}};var dD;dD=INLINE_JS.FileOps=E.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(fn){var fp,T,i,fo;fo=fd.vars.apps;for(T=0,i=fo.length;T<i;T++){fp=fo[T];if(fp.app_id!==fn){continue}return fp}return null},create_album_from_folder:function(j,i){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:j,album_name:i},job:true,job_user:cM.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:eB("Creating album..."),onSuccess:function(T){var fn;fn=JSON.parse(T.responseText);return window.location.href=fn.url}})},dir_handler:function(fn,T){var j,i;if(typeof T==="string"){T=$(T)}j=$$(".treeview .highlight")[0];if(j){j.removeClassName("highlight")}i=T.up("div");i.addClassName("highlight");fd.selected_div=i;if(fd.shown()){T.blur()}document.fire("db:dir_click",{path:fn});return fd.vars.selected_path=fn},show_folder_pick:function(fp,fn,T,fo,i){var j;dv.fillVal(aA.filename(fn).escapeHTML(),"folder-pick-file");b2.move("copy-move-treeview","folder-pick-treeview",{user:ct.active_user});j=(i?eB("Move"):eB("Copy"));dv.fillVal(j,"folder-pick-action-text");fd.show(fp,$("folder-pick"),{fq_path:fn,action:T,folder:fo});return bF("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fq,fp,fn,fo){var j,i,T;T=a6.profile_files(fn);i=a6.profile_summary(T);dv.fillVal(i,"bulk-folder-pick-file");b2.move("copy-move-treeview","bulk-folder-pick-treeview",{user:ct.active_user});if(fp==="move"){j=eB("Move")}else{if(fp==="copy"){j=eB("Copy")}else{j=eB("Restore")}}dv.fillVal(j,"bulk-folder-pick-action-text");fd.show(fq,$("bulk-folder-pick"),{files:fn,action:fo});return bF("#first-treeview-link").trigger("click")},show_copy:function(i,j){var T;T=(j?eB("Copy folder to..."):eB("Copy file to..."));b2.set_params({disable_read_only:true});return dD.show_folder_pick(T,i,dD.do_copy,j,false)},show_copy_bulk:function(i){var j;j=bd("Copy %(item_count)s item to...","Copy %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dD.show_bulk_folder_pick(j,"copy",i,dD.do_bulk_copy)},show_compress_bulk:function(i,j){b2.set_params({disable_read_only:true});return dM.show({title_text:bd("Compress file?","Compress files?",j.length),body_html:bd("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",j.length).format({file_count:j.length,filename:bx.escape(j.first().filename)}),confirm_text:eB("Compress"),cancel_text:eB("Cancel"),confirm_callback:function(){return dD.do_bulk_compress(i,j)}})},do_bulk_compress:function(i,T){var j;ah.clear();j=T.pluck("fq_path");return cE.WebProgressRequest({url:"/cmd/compress",data:{files:j},subject_user:i,progress_text:eB("Compressing..."),success:function(fq){var fp,fo,fn;fn=JSON.parse(fq);fp=fn.compressed_files;cL(fp.length>0,"Must have at least 1 compressed file");fo=bx.escape(aA.filename(fp.first().fq_path));ah.success(bd("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",fp.length).format({file_count:fp.length,filename:fo}));return bF(document).trigger(aH.COMPRESS,{original_files:T,compressed_files:fp})}})},show_move_bulk:function(i){var j;j=bd("Move %(item_count)s item to...","Move %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dD.show_bulk_folder_pick(j,"move",i,dD.do_bulk_move)},show_move:function(i,j){var T;T=(j?eB("Move folder to..."):eB("Move file to..."));b2.set_params({disable_read_only:true});return dD.show_folder_pick(T,i,dD.do_move,j,true)},show_delete:function(i,T,fn,j,fq,fp){var fo;if(fq==null){fq=null}if(fp==null){fp=false}if(fp){fo=eB("Are you sure you want to delete the shared folder \u2018<strong>%(items)s</strong>\u2019? This shared folder will stay shared with other members and you can rejoin it later.").format({items:aA.filename(T).escapeHTML()})}else{if(fq){fo=eB("Are you sure you want to delete <strong>%(items)s</strong> from the shared folder \u2018%(sf_name)s\u2019?").format({items:aA.filename(T).escapeHTML(),sf_name:fq.escapeHTML()})}else{fo=eB("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(T).escapeHTML()})}}return dM.show({title_text:fn?eB("Delete folder?"):eB("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fo+"</div>",confirm_text:eB("Delete"),cancel_text:eB("Cancel"),confirm_callback:function(){if(j){return dD.do_nonbrowse_delete(i,[T])}else{return dD.do_delete(i,T)}}})},show_bulk_delete:function(i,j,fn){var T;if(fn==null){fn=null}if(fn){T=bd("Are you sure you want to delete %(item_count)s item from the shared folder \u2018%(sf_name)s\u2019?","Are you sure you want to delete %(item_count)s items from the shared folder \u2018%(sf_name)s\u2019?",j.length).format({item_count:j.length,sf_name:fn.escapeHTML()})}else{T=bd("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",j.length).format({item_count:j.length})}return dM.show({title_text:bd("Delete %(item_count)s item?","Delete %(item_count)s items?",j.length).format({item_count:j.length}),body_html:T,confirm_text:eB("Delete"),cancel_text:eB("Cancel"),confirm_callback:function(){return dD.do_bulk_delete(i,j)}})},show_purge:function(i,j){return dM.show({title_text:j?eB("Permanently delete folder?"):eB("Permanently delete file?"),body_html:eB("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(i).escapeHTML()}),confirm_text:eB("Permanently delete"),cancel_text:eB("Cancel"),confirm_callback:function(){return dD.do_purge(ct.find_file(i))}})},show_bulk_purge:function(i){return dM.show({title_text:bd("Permanently delete %d item?","Permanently delete %d items?",i.length).format(i.length),body_html:bd("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",i.length).format({item_count:i.length}),confirm_text:eB("Permanently delete"),cancel_text:eB("Cancel"),confirm_callback:function(){return dD.do_bulk_purge(i)}})},show_bulk_restore:function(j,i){return dM.show({title_text:bd("Restore %d item...","Restore %d items...",j.length).format(j.length),body_html:bd("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",j.length).format({item_count:j.length}),confirm_text:eB("Restore"),cancel_text:eB("Cancel"),confirm_callback:function(){return dD.do_bulk_restore(j)}})},wrap_strong:function(i){if(ct.containing_fq_path()===""){return i.escapeHTML()}else{return"<strong>"+i.escapeHTML()+"</strong>"}},upload_snippet:function(T){var i,j;if(T==null){T=1000}if(cM.get_viewer().is_paired&&ct.active_user.is_team){j=bU.em_snippet(cM.get_viewer().team_name,T).escapeHTML()}if(ct.containing_fq_path()===""){if(cM.get_viewer().is_paired){if(ct.active_user.is_team){return eB(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:j})}else{return eB(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return eB(" upload to your Dropbox")}}else{i=bU.em_snippet(aA.filename(ct.containing_fq_path()),T).escapeHTML();if(cM.get_viewer().is_paired){if(ct.active_user.is_team){return eB(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i,team_name:j})}else{return eB(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}else{return eB(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}},upload_short_snippet:function(T){var j,i;if(T==null){T=1000}i=ct.containing_fq_path();if(!i){return eB("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}j=bU.em_snippet(aA.filename(i),T);return eB("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:j})},upload_plain_snippet:function(i){if(i==null){i=1000}return this.upload_snippet(i).replace("<strong>","'").replace("</strong>","'")},show_upload:function(ft,i,fr){var fo,fp,fq,fs,fn,T;fo=ct.containing_fq_path();if(dT.disabled){dv.fillVal(this.wrap_strong(aA.filename(fo)),"disabled-upload-foldername");fn=this.upload_short_snippet(20);fd.show(fn,$("disabled-upload-modal"),{},false);return}bF(document).trigger(this.SHOW_UPLOAD_EVT,{source:i,has_callback:ft!=null});if((!FlashDetect.versionAtLeast(9))&&cC.runtimes==="flash"){dD.show_basic_upload();$("enhanced-upload-toggle").hide();return}dv.fillVal(this.upload_snippet(20),"upload-foldername");dv.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bp.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}fn=this.upload_short_snippet(20);fd.show(fn,dv.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,aq.num_files());T=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(fp=0,fq=T.length;fp<fq;fp++){fs=T[fp];if(fs!=null){fs.observe("click",function(){dD.show_basic_upload();return false})}}if(!aq.num_files()){cC.init(aA.normalize(fo),true,ft,fr)}else{cC.set_dest(aA.normalize(fo))}return c1.hide()},show_basic_upload:function(){dv.fillVal(this.upload_snippet(20),"basic-upload-foldername");fd.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dD.show_upload();return false});cC.set_dest(aA.normalize(ct.containing_fq_path()));return cC.init_basic()},show_undelete:function(i){var j,T,fn;dv.fillVal(i.filename.escapeHTML(),"undelete_filename");j=cx.make("web",i.icon,{});j.addClassName("link-img");j.style.backgroundColor="transparent";T=dD.build_revisions_uri(i.fq_path,ct.active_user,{undelete:1});$$(".undelete-icon").invoke("update",j);$$(".undelete-other-versions")[0].href=T;$$(".undelete-link")[0].href=T;fn=eB("Restore file?");return fd.show(fn,$("undelete-modal"),{file:i})},do_undelete:function(j){var i,T;i=fd.vars.file;T=eB("Restored '%(file_name)s'").format({file_name:i.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[i.fq_path]},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eB("Restoring..."),onSuccess:function(fn){fd.hide();ah.success(T);return document.fire(aH.RESTORE,{files:[i]})}});return false},do_copy:function(T,j){var i;T=T||fd.vars.fq_path;j=j||fd.vars.selected_path;i=ct.find_file(T);cL(i,"Trying to copy a file we couldn't find.");return dD.do_bulk_copy([i],j)},do_bulk_copy:function(fs,fn){var fq,fr,fp,fo,T;ct.pre_action_selection=eY.get_selected_fq_paths();fs=fs||fd.vars.files;cL(fs.length>0,"Tried to copy 0 files");if(typeof fn==="undefined"){if(typeof fd.vars.selected_path==="undefined"){ah.error(eB("You need to select a destination for the file."));return}else{fn=fd.vars.selected_path}}fn=aA.normalize(fn);fp=0;for(fo=0,T=fs.length;fo<T;fo++){fq=fs[fo];if(fq.dir){if((fn+"/").indexOf(fq.fq_path+"/")===0){ah.error(eB("You cannot copy a folder into itself."));return}}}fr=fs.pluck("fq_path");ah.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fr,to_path:fn},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eB("Copying..."),onSuccess:function(fy){var fu,fx,i,fv,fw,fz,ft,j;fu=fy.responseText.evalJSON().changesets;fx=fr.length;fz=bU.em_snippet(aA.filename(fn),dD.NOTIFICATION_SNIPPET_LEN).escapeHTML();ft=bd("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fx);ft=ft.format({count:fx,location:fz});X.notifyWithUndo(new fi(ft),fu,dD.do_rollback);i=[];j=fy.responseText.evalJSON().new_browse_files;for(fv=0,fw=j.length;fv<fw;fv++){fq=j[fv];i.push(fq.fq_path)}ct.select_fq_paths=i;$("reload-link").observe("click",function(){return a4.set_path_url(null,fn)});b2.schedule_reset();return document.fire(aH.COPY,{files:fs,to_fq_path:fn})}})},bulk_move_error:function(i,fs){var fq,fn,ft,fo,fu,fp,j,T,fr;ft=ct.find_file(fs);fo=a6.profile_files(i);T=void 0;fp=void 0;fr=void 0;if(ft){fp=ft.dir;T=ft.fq_path;fr=ft.target_ns||ft.ns_id}else{if(ct.inside_dir&&ct.can_get_details_from_fq_path(fs)){fn=ct.details_from_fq_path(fs);fp=true;T=fn.fq_path;fr=fn.ns_id}else{fp=true;T=fs;fr=void 0}}fu=i.pluck("fq_path").collect(aA.normalize);if(-1!==fu.indexOf(aA.normalize(T))){return eB("You cannot copy a folder into itself.")}fq=j=function(fv){var fw;fw=aA.parent_dir(fv.fq_path);return fw===(T||"/")};if(i.all(fq)){return bd("That file already exists in that folder.","Those files already exist in that folder.",i.length)}if(!fp){return eB("You cannot put files inside one another.")}if(fo.target_namespaces>0&&fr&&fr!==Constants.root_ns&&ft){if(fo.sandboxes>0){if(ft.is_sandbox()){return eB("You're not allowed to put an application folder inside another application folder.")}else{if(ft.is_shared_folder()){return eB("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fo.shared_folders>0){if(ft.is_sandbox()){return eB("You're not allowed to put a shared folder inside an application folder.")}else{if(ft.allows_nesting&&fo.team_shared_folders===0){return}else{if(ft.is_shared_folder()){return eB("You're not allowed to put a shared folder inside another shared folder.")}}}}}return eB("You're not allowed to nest special folders.")}if(ct.public_folder_enabled){if(T==="/Public"&&fo.target_namespaces>0){return eB("You're not allowed to move shared folders to your Public folder.")}}if(fo.public_folder>0){return eB("You're not allowed to move your Public folder.")}if(fo.deleted>0){return eB("Moving deleted folders or files isn\u2019t allowed.")}},do_move:function(T,j){var i;T=T||fd.vars.fq_path;j=j||fd.vars.selected_path;i=ct.find_file(T);cL(i,"Trying to move a file we couldn't find.");return dD.do_bulk_move([i],j)},do_nonbrowse_move:function(fn,fo,j){var i,T;i=bF.Deferred();T="/cmd/move";new Ajax.DBRequest(T,{parameters:{files:fo,to_path:j},subject_user:fn,job:true,html_in_error_msg:true,progress_text:eB("Moving\u2026"),onSuccess:i.resolve,onFailure:i.reject});return i.promise()},do_bulk_move:function(fn,fp){var j,T,fo,i;ct.pre_action_selection=eY.get_selected_fq_paths();fn=fn||fd.vars.files;if(!fn){return}cL(fn.length>0,"Tried to move 0 files");i=fp||fd.vars.selected_path||"";i=aA.normalize(i);j=dD.bulk_move_error(fn,i);if(j){ah.error(j);return}T=fn.pluck("fq_path");ah.clear();fo=function(ft){var fs,fr,fq,fu;fs=ft.responseText.evalJSON().changesets;fr=T.length;fq=bU.em_snippet(aA.filename(i),dD.NOTIFICATION_SNIPPET_LEN).escapeHTML();fu=bd('Moved %(count)d item to \u2018<a id="reload-link">%(location)s</a>\u2019.','Moved %(count)d items to \u2018<a id="reload-link">%(location)s</a>\u2019.',fr);fu=fu.format({count:fr,location:fq});X.notifyWithUndo(new fi(fu),fs,dD.do_rollback);$("reload-link").observe("click",function(){return a4.set_path_url(null,i)});b2.schedule_reset();return document.fire(aH.MOVE,{files:fn,to_fq_path:i})};return dD.do_nonbrowse_move(ct.active_user.id,T,i).then(fo)},do_rollback:function(i){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(i)},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eB("Undoing..."),onSuccess:function(j){var T;T=eB("Undo complete.");ah.success(T);cL(ct.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(ct.in_search_mode()){cb.select_fq_paths=ct.pre_action_selection;cb.force_reload()}else{ct.select_fq_paths=ct.pre_action_selection;ct.force_reload()}return ct.pre_action_selection=false}})},do_bulk_delete:function(i,fn){var j,T;ct.pre_action_selection=eY.get_selected_fq_paths();fn=fn||fd.vars.files;cL(fn.length>0,"Tried to delete 0 files");T=(function(){var fp,fo,fq;fq=[];for(fp=0,fo=fn.length;fp<fo;fp++){j=fn[fp];fq.push(j.fq_path)}return fq})();ah.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:T},subject_user:i,job:true,html_in_error_msg:true,progress_text:eB("Deleting..."),onSuccess:function(fo){var fq,fp;fp=fo.responseText.evalJSON();fq=bd("Deleted %d item.","Deleted %d items.",T.length).format(T.length);X.notifyWithUndo(fq,fp.changesets,dD.do_rollback);b2.schedule_reset();return document.fire(aH.DELETE,{files:fn})}})},do_delete:function(i,T){var j;j=ct.find_file(T||fd.vars.fq_path);cL(j,"Trying to delete a file we couldn't find.");return dD.do_bulk_delete(i,[j])},do_nonbrowse_delete:function(j,fn){var i,T;i=bF.Deferred();T=bd("Deleted %(file_count)s item","Deleted %(file_count)s items",fn.length);T=T.format({file_count:fn.length});ah.success(T);new Ajax.DBRequest("/cmd/delete",{parameters:{files:fn},subject_user:j,html_in_error_msg:true,onSuccess:function(fo){document.fire(aH.DELETE,{fq_paths:fn});return i.resolve(fo)},onFailure:function(fo){ah.error(eB("Failed to perform the delete. Please try again later."));return i.reject(fo)}});return i.promise()},do_nonbrowse_rename:function(T,fn,j){var i;i=bF.Deferred();new Ajax.DBRequest("/cmd/rename"+encodeURIComponent(fn),{parameters:{to_path:j},subject_user:T,html_in_error_msg:true,onSuccess:function(fo){return i.resolve(fo)},onFailure:function(fo){return i.reject(fo)}});return i.promise()},do_purge:function(i){cL(i,"Trying to purge a file we couldn't find.");return dD.do_bulk_purge([i])},do_bulk_purge:function(j){var i,T;cL(j.length>0,"Tried to purge 0 files");i=j.collect(function(fn){return fn.fq_path});T=bd("Permanently deleted %d item","Permanently deleted %d items",i.length).format(i.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:i},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eB("Deleting..."),onSuccess:function(fn){ah.success(T);b2.schedule_reset();return document.fire(aH.PURGE,{files:j})}})},do_bulk_restore:function(T){var j,fn,i;T=T||fd.vars.files;i=fd.vars.user;cL(T.length>0,"Tried to restore 0 files");j=T.collect(function(fo){return fo.fq_path});fn=bd("Restored %d item","Restored %d items",j.length,{comment:"meaning, successfully restored x files and folders"}).format(j.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:j},subject_user:ct.active_user,job:true,html_in_error_msg:true,progress_text:eB("Restoring..."),onSuccess:function(fo){ah.success(fn);b2.schedule_reset();return document.fire(aH.RESTORE,{files:T})}})},do_folder_restore:function(j,i){var T;T=function(fn){var fp,fo;fp=eB("Restoring '%(folder_name)s'").format({folder_name:aA.filename(j)});fo=fn.responseText;if(fo.startsWith("err:")){fo=fo.substring(4);bF("#async-result").html(fo);ah.error(new fi(fo),60)}else{fp=eB("Restored '%(folder_name)s'").format({folder_name:aA.filename(j)});bF("#status-of-files").text(eB("Restored files"));ah.success(fp,60)}bF("#restore-done-heading").text(fp);bF(".pre-restore").hide();return bF(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[j]},job:true,html_in_error_msg:true,progress_text:eB("Restoring..."),onSuccess:T,onFailure:T,subject_user:i})},do_bulk_download:function(fo){var fp,fn,T,i;fp=new Element("form",{action:G({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(a9.UID_PARAM_NAME,ct.active_user.id).toString(),method:"post"});for(T=0,i=fo.length;T<i;T++){fn=fo[T];bT.add_vars(fp,{files:fn.fq_path})}bT.add_vars(fp,{parent_path:ct.block_hash_param||"/",w:ct.block_hash});$(document.body).__sert(fp);return fp.submit()},do_bulk_photo_view:function(T,i){var fp,fo,j,fn;if(i==="carousel"||i==="carousel_as_dropbox_photos"){fn={};fn[a9.UID_PARAM_NAME]=cM.get_viewer().personal_user.id;fp=String(G({scheme:"https",authority:fl.WEBSERVER,path:"/app/view_in_timeline",query:fn}))}else{fp=String(G({scheme:"https",authority:fl.WEBSERVER,path:"/photos"}))}fo=new Element("form",{action:fp,method:"post"});bT.add_vars(fo,{t:bw.read(aK.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fr,fq,fs;fs=[];for(fr=0,fq=T.length;fr<fq;fr++){j=T[fr];fs.push(j.ns_id)}return fs})()),ns_paths:JSON.stringify((function(){var fr,fq,fs;fs=[];for(fr=0,fq=T.length;fr<fq;fr++){j=T[fr];fs.push(j.ns_path)}return fs})())});$(document.body).__sert(fo);return fo.submit()},build_revisions_uri:function(T,i,j){if(j==null){j={}}j[a9.UID_PARAM_NAME]=String(i);if(az.getGandalfRule("revision-history-web")){return G({path:"/history"+T}).updateQuery(j)}else{return G({path:"/revisions"+T}).updateQuery(j)}}};var bT,dk={}.hasOwnProperty;bT=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=E.Forms={submitOnlyOnce:function(){var i;i=bT.submitted!==true;bT.submitted=true;return i},disable:function(i){if(i){return setTimeout((function(){return i.disabled=true}),0)}},enable:function(i){if(i){return setTimeout((function(){return i.disabled=false}),0)}},show_button_on_change:function(i,fn){var T,fo,fp,j;T=bF(i);T.hide();if(fn==null){fn=T.closest("form")}fo=fn[0];if(this.next_id==null){this.next_id=0}fp=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[fp]=this.collect_form_vars(fo);T.attr("data-id",fp);fn.data("button-id",fp);j=(function(fq){return function(){var ft,fr,fs;T.hide();fr=fq.collect_form_vars(fo);if(Object.keys(fr).length!==Object.keys(fq.initial_vars[fp]).length){T.show()}fs=[];for(ft in fr){if(fr[ft]!==fq.initial_vars[fp][ft]){fs.push(T.show())}else{fs.push(void 0)}}return fs}})(this);fn.change(j);fn.find("input").filter(":text").on("input",j);return fn.find("textarea").on("input",j)},add_vars:function(T,fn){var fo,i,j;T=$(T);j=[];for(i in fn){if(!dk.call(fn,i)){continue}fo=new Element("input",{type:"hidden",name:i});fo.setValue(fn[i]);j.push(T.__sert(fo))}return j},collect_form_vars:function(fq,fp){var fs,fo,fn,j,T,fr;if(fp==null){fp=false}fq=fq||$(document.body);fo=fq.select("input").concat(fq.select("textarea")).concat(fq.select("select"));T={};for(fn=0,j=fo.length;fn<j;fn++){fs=fo[fn];if(fs.name&&fs.name!=="t"){fr=fs.getValue();if(fr||fp){if(typeof fr!=="string"){fr=fr.join(",")}if(T[fs.name]!=null){if(typeof T[fs.name]==="string"){T[fs.name]=[T[fs.name],fr]}else{T[fs.name].push(fr)}}else{T[fs.name]=fr}}}}return T},add_loading:function(T,i){var j;if(T){T=$(T);j=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});j.addClassName("text-img ajax_submit_loading");if(i==="after"){return bF(T).after(j)}else{return bF(T).before(j)}}},remove_loading:function(i){return bF(".ajax_submit_loading").remove()},ui_form_submit:function(j,i){i=i||j.action;if(j.ajax_submitted){return false}j.ajax_submitted=true;return new by(bF(j),i,{data:bT.collect_form_vars(j),success:(function(T){return function(fq,fn,fr){var fp,fo;fo=bF(j).data("button-id");if(fo!=null){fp=bF(j).find("*[type='submit'][data-id='"+fo+"']");T.initial_vars[fo]=T.collect_form_vars(j);return fp.hide()}}})(this),complete:(function(T){return function(fo,fn){return j.ajax_submitted=false}})(this)})},ajax_submit_obj:function(fv){var fs,fu,T,fn,j,fo,fq,fr,fp,ft,i;fn=fv.form,i=fv.url,ft=fv.success_callback,T=fv.fail_callback,fs=fv.button,fq=fv.more_vars,fr=fv.position,fo=fv.job,j=fv.html_response,fu=fv.complete_callback,fp=fv.progress_text;return bT.ajax_submit(fn,i,ft,T,fs,fq,fr,fo,j,fu,fp)},ajax_submit:function(fo,T,fy,fn,fv,ft,fw,fp,j,fA,fr){var fz,fu,fx,fs,fq;if(j==null){j=false}if(fo.ajax_submitted){return false}fo.ajax_submitted=true;fq=bF(fo).find(".suggestion-input");for(fu=0,fx=fq.length;fu<fx;fu++){fz=fq[fu];c5.blank(fz.identify())()}if(fv){bT.add_loading(fv,fw)}fs=bT.collect_form_vars(fo);if(ft){Object.extend(fs,ft)}new Ajax.DBRequest(T||fo.action,{noAutonotify:true,parameters:fs,job:fp,progress_text:fr,evalJSON:false,onSuccess:function(i){bT.remove_loading();if(fy&&typeof fy==="function"){return fy(i)}},onFailure:function(fC){var i,fB;if(fC){if(fC.responseText.indexOf("err:")===0){i=fC.responseText.substr(4);if(i.indexOf("{")===0){fB=i.evalJSON(true);bT.fill_errors(fo,fB)}else{if(j){i=new fi(i)}ah.error(i)}}else{ah.error()}bT.remove_loading();if(fn&&typeof fn==="function"){return fn(fC)}}},onComplete:function(fD){var fC,fB,i;i=fo.select(".suggestion-input");for(fC=0,fB=i.length;fC<fB;fC++){fz=i[fC];c5.blur_elm(fz)}fo.ajax_submitted=false;if(fA&&typeof fA==="function"){return fA(fD)}}});return false},clear_errors:function(i){i=i||$(document.body);this.hide_errors(i);return i.select(".error-removable").invoke("remove")},fill_errors:function(fp,fo){var T,fr,j,fn,fq,i;fo=fo||{};fp=fp||$(document.body);bT.clear_errors(fp);for(fq in fo){if(!dk.call(fo,fq)){continue}fr=fp.down("[data-error-field-name='"+fq+"']")||fp.down("[name='"+fq+"']");if(fr){T=new Element("br",{"class":"error-removable"});j=new Element("span",{"class":"error-message error-removable"});fn=fo[fq];cL(fn.message_html||fn.message_text,"Error message must have a message_html or message_text property");if(fn.message_html){j.update(fn.message_html)}else{j.__date(fn.message_text)}bF(fr).before(j);bF(fr).before(T);i=bF(fp).find("input[name='"+fq+"'], textarea[name='"+fq+"']");if(i){i.addClass("input-error")}}}return this.show_errors(fp)},value:function(fo){var fp,fn,T,j,fq;T=$$('input[name="'+fo+'"]');fq=null;for(fp=0,j=T.length;fp<j;fp++){fn=T[fp];fq=$(fn).getValue()||fq}return fq},postRequest:function(T,fn,i){var j;if(fn==null){fn={}}if(i==null){i={}}cL(T!=null,"postRequest missing action");fn.t=bw.read(aK.JS_CSRF_COOKIE);j=new Element("form",{action:T,method:"POST"});if(i.target){j.target=i.target}document.body.appendChild(j);bT.add_vars(j,fn);return j.submit()},hide_errors:function(fo){var fq,fn,j,T,fp;fq=this.get_errors(fo);T=[];for(fn=0,j=fq.length;fn<j;fn++){fp=fq[fn];if(fp.down("span.error-message")){T.push(fp.hide())}else{T.push(void 0)}}return T},show_errors:function(fn){var fp,T,j,fo;fp=this.get_errors(fn);for(T=0,j=fp.length;T<j;T++){fo=fp[T];if(fo.down("span.error-message")){fo.show()}}return bF(".sick-input").find("label").css("top","")},get_errors:function(j){var T,i;i=".error-bubble, .error-plain-text";T=j?j.select(i):$$(i);return T}};bF(function(){return bT.show_errors()});var V;V=E.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(fp,fq){var fn,j,fo,T;if(fq==null){fq=document.body}fo=$(fq).getElementsByClassName("act_as_block");T=[];for(fn=0,j=fo.length;fn<j;fn++){fp=fo[fn];T.push(this.resize(fp))}return T},resize:function(fo){var i,T,fn,j;fo=$(fo);T=fo.up();i=d6.sumStyles(fo,this.elm_list);fn=d6.sumStyles(T,this.parent_list);fo.style.width="1px";j=T.getWidth()-i-fn;if(j>0){return fo.style.width=j+"px"}}};var bf;bf=E.BrowseStyleRows={register_all:function(){var T,j,fn,fo;fn=$$(".bs-row");for(T=0,j=fn.length;T<j;T++){fo=fn[T];this.register(fo)}Event.observe(document,"click",this.kill_current.bind(this));return bF(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(j){var i;j=$(j);j.db_observe("mouseover",this.mouseover.bind(this));j.db_observe("mouseout",this.mouseout.bind(this));i=j.down(".action-button");if(i){return i.db_observe("click",this.click.bind(this))}},mouseover:function(j,i){if(!i.hasClassName("no-hover")){return i.addClassName("hover")}},mouseout:function(j,i){return i.removeClassName("hover")},click:function(fn,j){var i,fo,T;if(fn.target.tagName==="A"){return}fo=j.up(".bs-row");Event.stop(fn);if(fo.hasClassName("selected")){this.kill_current(false);return}bF(document).trigger("dropdown-opened");this.kill_current(false);T=$(fn.target);if(!T.match(".bs-actions-list *")){fo.addClassName("selected")}i=(T.hasClassName("bs-row")?T:T.up(".bs-row"));return i.style.zIndex=9},kill_current:function(fp){var fq,fn,j,fo,T;fo=$$(".bs-row.selected");T=[];for(fn=0,j=fo.length;fn<j;fn++){fq=fo[fn];fq.removeClassName("selected");T.push(fq.style.zIndex="")}return T}};var en;en=E.Bubble={make:function(fx,fI,fA,fv,fr){var fo,fy,fF,fn,T,fH,fC,fw,fu,fp,ft,fz,fE,fs,i,fq,j,fG,fD,fB;if(fI==null){fI="left"}fr=fr!=null?fr:{};if(["left","right"].contains(fI)){fA=fA||"middle";cL(["top","middle","bottom"].contains(fA),"expected tail position ['top', 'middle', 'bottom'], got "+fA)}else{if(["bottom","top"].contains(fI)){fA=fA||"center";cL(["left","center","right"].contains(fA),"expected tail position ['left', 'center', 'right'], got "+fA)}else{if(!["none"].contains(fI)){cL(false,"unexpected tail side, got "+fI)}}}fz=new Element("table");if(fr.style==="titled"){fz.addClassName("bluebubble");fE="bluebubble"}else{fz.addClassName("bubble");fE="bubble"}if(fv){fz.style.width=fv+"px"}i=new Element("tbody");fG=new Element("tr");fq=new Element("td");fq.addClassName("tl");ft=new Element("td");ft.addClassName("t");if(fr.style==="titled"){if(fv){ft.style.width=(fv-42)+"px"}}j=new Element("td");j.addClassName("tr");if(fI==="top"){fs=new Element("img",{src:"/static/images/"+fE+"_arrow_top.png"});fs.addClassName("tarrow");if(fr.style==="titled"){fs.addClassName("arrow-"+fA);fy=new Element("div");fy.addClassName("arrow-container");if(fv){fy.style.width=(fv-42)+"px"}fy.__sert(fs);ft.__sert(fy)}else{ft.style.textAlign=fA;ft.__sert(fs)}}fG.__sert(fq);fG.__sert(ft);fG.__sert(j);i.__sert(fG);fD=new Element("tr");fw=new Element("td");fw.addClassName("l");if(fI==="left"){if(fr.style==="titled"){fo=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fo=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fo.addClassName("arrow");fw.__sert(fo);fw.vAlign=fA}fC=new Element("td");fC.addClassName("c");fC.update(fx);fu=new Element("td");fu.addClassName("r");if(fI==="right"){fp=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});fp.addClassName("rarrow");fu.__sert(fp);fu.vAlign=fA}fD.__sert(fw);fD.__sert(fC);fD.__sert(fu);i.__sert(fD);fB=new Element("tr");T=new Element("td");T.addClassName("bl");fF=new Element("td");fF.addClassName("b");if(fI==="bottom"){fn=new Element("img",{src:"/static/images/"+fE+"_arrow_bottom.png"});fn.addClassName("barrow");if(fr.style==="titled"){fn.addClassName("arrow-"+fA);fy=new Element("div");fy.addClassName("arrow-container");if(fv){fy.style.width=(fv-42)+"px"}fy.__sert(fn);fF.__sert(fy)}else{fF.style.textAlign=fA;fF.__sert(fn)}}fH=new Element("td");fH.addClassName("br");fB.__sert(T);fB.__sert(fF);fB.__sert(fH);i.__sert(fB);fz.__sert(i);return fz}};var eU;eU=INLINE_JS.FreshDropdown=E.FreshDropdown={show:function(fq,fn,T,j){var fp,fo,fr,i;if(j==null){j=false}bF(document).trigger("dropdownOpened",[1]);fp=bF(fn);if(!T){T=fp[0].offsetHeight+10}this.hide_all();fo=bF(fq).show();i=fo[0].offsetWidth;fr=fp[0].offsetWidth;fo.clonePosition(fp,{setHeight:false,setWidth:false,offsetLeft:-1*(i-fr)+22,offsetTop:T});if(j){fo.width(i)}fp.addClass("pressed");return((function(fs){return function(){return document.observe("click",eU.hide_all)}})(this)).defer()},hide_all:function(T){var j,i;i=bF(".freshdropdown-menu");j=0;i.each(function(){if(bF(this).is(":visible")){return j+=1}});i.hide();bF(document).trigger("dropdownClosed",[j]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eU.hide_all)}};var ac;ac=E.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&ac.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=G.parse(window.location.href).fragment}},report:function(){clearInterval(ac.interval);return cL(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var dO;dO=E.LoginDropdown={init:function(){var i;i=bF("#login-hover-link");if(!(i.length>0)){return}this.login_link=i;return this.register()},register:function(i){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(i){return this.clicking=true},click:function(i){i.preventDefault();if(this.clicking&&i.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bF(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bF("input[name='login_email']").focus()},unclick:function(j){var i;if(j){i=bF(j.target);if(i[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bF(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var fd;fd=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=E.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fw,fs,ft,fy,T,fu,fq,fr,fx){var j,fo,fv,i,fn,fp;if(ft==null){ft=false}if(fy==null){fy=false}if(T==null){T=false}if(fu==null){fu=false}if(fq==null){fq=""}if(fr==null){fr=true}if(fx==null){fx=false}if(fd.shown()){fd._cleanup()}T=T||this.width;fo="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fo).invoke("hide");if(aq.uploading&&!fu){ca(eB("You can't do this while uploading."));return false}cL(fs,"Missing modal content!");fn=this.vars._prev_scope;this.vars=ft||{};this.vars._prev_scope=fn;$("modal").setStyle({width:T+"px",margin:"0 0 0 "+(Math.floor(-T/2).toString())+"px"});this.vars.extra_class="";if(fq){$("modal").addClassName(fq);this.vars.extra_class=fq}if(!fu){if(aq.num_files()){cC.reset();aq.clear()}i=d6.childElement($("modal-content"),0);if(i&&i!==fs){$("grave-yard").__sert(i)}j=new Element("div");j.update(fs);$("modal-content").__sert(j);if(fs.show){fs.show()}Element.show("modal")}bF("#modal-overlay").off("click");if(fr){bF("#modal-overlay").on("click",function(fz){fd.hide(null,false,true);fz.preventDefault();return fz.stopPropagation()})}else{bF("#modal-overlay").on("click",function(fz){fz.preventDefault();return fz.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:(T+20)+"px",margin:"0 0 0 "+(Math.floor(-T/2-10).toString())+"px"});bF("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fy){$("modal-content").select("#"+fy.id).first().focus()}else{if(!d6.ie){fv=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fv){fv.focus()}}}if(!this.track_id){this.track_resizes()}if(fw){if(d6.isElm(fw)){bF("#modal-title").html(fw)}else{bF("#modal-title").text(fw)}bF("#modal-title").show();fp=bF("#modal-title").text();eJ("Modal.show:",fp)}else{bF("#modal-title").hide();eJ("Modal.show")}V.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fx;bF("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;C.scroll_lock_document()}bF(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var T,i,j,fo,fn;T=bF("#modal");i=T.height();fn=T.width();j=C.viewport_dimensions();fo=C.viewport_offset(T);return fo.left>0&&fo.top>0&&fo.left+fn<j.width&&fo.top+i<j.height},fix_position:function(T){var j,i;i=document.viewport.getScrollOffsets().top+this.vertical_offset;j=parseInt($("modal").getStyle("height"),10);if(j+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(j+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:i+"px"});return $("modal-behind").setStyle({position:"absolute",height:(j+20)+"px",top:(i-10)+"px"})}},keydown:function(fn){var fo,i,T,j;T=fn.keyCode||fn.which||fn.charCode;if(T===27||(T===8&&!C.focus_in_input())){fn.preventDefault();this.hide(null,false,true)}if(T===9&&!C.focus_in_input()){i=$("modal").down("input[type=text], input[type=email]");j=$("modal").down(".modal-tabs");fo=j;while(fo&&fo.next()){fo=fo.next();if(fo.visible()){i=fo.down("input[type=text], input[type=email]");break}}if(i){fn.preventDefault();return i.focus()}}},shown:function(){return $("modal").visible()},hide:function(T,i,j){if(T){Event.stop(T)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(j);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!i&&!aq.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(aq.uploading){c1.show()}}fd._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return eJ("Modal.hide")},_cleanup:function(){bF(document).trigger("modalClosed",[1]);if(this.scroll_locked){return C.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&bx.some(bF("#modal form"),function(i){return i.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var i;i=$("modal").getHeight();if(this.old_height!==i||$("modal-behind").getHeight()<i){this.old_height=i;return this.fix_position()}},vars:{}};var cj;cj=E.SickInput={init:function(){var fp,fn,j,fo,T;fo=$$(".sick-input");T=[];for(fn=0,j=fo.length;fn<j;fn++){fp=fo[fn];if(!fp.hasClassName("sickified")){T.push(this._create(fp))}}return T},_create:function(fn){var j,T,i;if(fn==null){return}T=fn.identify();i=fn.down("input")||fn.down("textarea")||fn.down("select");i.observe("focus",function(){return fn.addClassName("focused")});i.observe("blur",function(){return fn.removeClassName("focused")});j=function(){if(fn.hasClassName("populated")&&i.getValue()===""){fn.removeClassName("populated")}else{if(!fn.hasClassName("populated")&&i.getValue()!==""){fn.addClassName("populated")}}if(T in cj._handler_map){return cj._handler_map[T]()}};bT.show_errors();j();return setInterval(j,100)},_handler_map:{},add_interval_handler:function(j,i){var T;T=j.identify();return this._handler_map[T]=i},remove_interval_handler:function(j,i){var T;T=j.identify();if(this._handler_map[T]===i){return delete this._handler_map[T]}}};var c5;c5=E.SuggestionInput={register:function(j){var i;j=$(j);i=j.up("form");if(c5.defaulted(j)||j.getValue()===""){j.setValue(j.title)}else{j.addClassName("suggestion-input-unfaded")}j.observe("blur",this.blur.bind(this));j.observe("focus",this.focus.bind(this));j.observe("db:value_change",this.focus.bind(this));if(i){if(!j.id){j.id="r_elm_id_"+(Math.random().toString())}return i.observe("submit",c5.blank(j.id).bind(this))}},register_all:function(){var fo,T,j,fp,fn;fp=$$(".suggestion-input");fn=[];for(fo=0,j=fp.length;fo<j;fo++){T=fp[fo];fn.push(this.register(T))}return fn},blank:function(i){return(function(j){return function(){var T;T=$(i);if(!T){return}if(j.defaulted(T)){return T.setValue("")}}})(this)},defaulted:function(i){i=$(i);return i.getValue()===i.title},do_blank:function(i){return this.blank(i)()},clear:function(i){var j;j={target:i};return this.focus(j)},focus:function(i){var j;j=$(i.target);if(!j){return}if(this.defaulted(j)){j.addClassName("suggestion-input-unfaded");return j.setValue("")}},blur_elm:function(i){if(i.getValue()===""){i.removeClassName("suggestion-input-unfaded");i.setValue(i.title)}return i.blur()},blur:function(i){var j;j=$(i.target);if(!j){return}return this.blur_elm(j)},reset:function(j){var i;i=$(j);if(!i){return}i.removeClassName("suggestion-input-unfaded");i.setValue(i.title);i.defaulted=true;return i.blur()},setValue:function(i,j){var T;T=$(i);if(!T){return}T.addClassName("suggestion-input-unfaded");T.setValue(j);return T.defaulted=false}};var bo;bo=E.TitleBubble=(function(){var T,j,fq,fn,fo,i,fp;fp=0;T=0;i=function(fr){return fp=fr};fo=function(fx){var fC,fA,fu,fy,ft,fr,fz,fw,fs,fv,fB;fy=bF(fx.currentTarget);fB=fy.attr("title");if(fB!=null?fB.length:void 0){fy.attr("data-title",fB);fy.removeAttr("title")}fu=parseInt(fy.data("title-delay"));fA="title-bubble-"+(T++);fy.data("bubble-id",fA);fC=bF("<div/>",{id:fA,"class":"title_bubble_container"});if(!fu){fC.css({opacity:0});fC.addClass("has-transition")}if(fy.hasClass("white")){fC.addClass("white")}if(fy.hasClass("black")){fC.addClass("black")}fC.text(fy.attr("data-title"));fz=fy.attr("data-title-html");fC.html(fz);fs=fy.attr("data-title-hide-tail")!=="yes";if(fs){fv=bF("<div/>",{"class":"tail"});fC.append(fv)}bF(document.body).append(fC);fr=fq(fy[0],fC[0]);ft=j(fr,fC[0],fy[0]);fC.clonePosition(fy,{setWidth:false,setHeight:false,offsetTop:ft.top-fp,offsetLeft:ft.left});fC.addClass("position-"+fr);if(fs){fv.clonePosition(fy,{setWidth:false,setHeight:false,setTop:false,offsetLeft:ft.left+ft.tail_offset_left+(bF(fC).outerWidth()/2)})}fw=function(){var fD;if(!((fC.data("pending-delay"))&&(fy.data("bubble-id")===fA))){return}fD=(parseInt(fy.data("title-fade-time")))||400;return fC.fadeIn(fD)};if(fu){fC.hide();fC.data("pending-delay",true);return setTimeout(fw,fu)}else{return fC.css({opacity:""})}};fq=function(fv,fr){var fu,ft,fs;fv=$(fv);fs=fv.getAttribute("data-title-position");fu=document.viewport.getDimensions();ft=fv.viewportOffset();if(!(fs==="above"||fs==="below"||fs==="right"||fs==="left")){fs="above"}if(fs==="left"){if(ft.left<fr.width){return"right"}}else{if(fs==="right"){if(fu.width-(ft.left+fv.getWidth())<fr.width){return"left"}}else{if(fs==="below"){if(fu.height-(ft.top+fv.getHeight())<fr.height){return"above"}}else{if(fs==="above"){if(ft.top<fr.height){return"below"}}}}}return fs};j=function(ft,fA,fw){var fy,fu,fB,fx,fz,fv,fr,fD,fC,fs;fA=$(fA);fw=$(fw);fB=document.viewport.getDimensions();fy=fA.getDimensions();fx=fw.viewportOffset();fu=6;fz=0;fv=0;fC=0;fs=0;if(ft==="below"||ft==="above"){if(ft==="below"){fv=fw.getHeight()+fu}else{fv=(-1*fy.height)-fu}fr=fw.getWidth()/2-fy.width/2;if(fx.left+fr+fy.width>fB.width){fz=fB.width-fx.left-fy.width;fC=fr-fz-5}else{fz=fr;fC=-5}}if(ft==="left"||ft==="right"){if(ft==="right"){fz=fw.getWidth()+fu}else{fz=(-1*fy.width)-fu}fD=fw.getHeight()/2-fy.height/2;if(fx.top+fD+fy.height>fB.height){fv=fB.height-fx.top-fy.height;fs=fD-fv-5}else{fv=fD;fs=-5}}return{left:fz,top:fv,tail_offset_left:fC,tail_offset_top:fs}};fn=function(fs){var fr,ft,fu;fu=bF(fs!=null?fs.currentTarget:void 0);fr=bF("#"+fu.data("bubble-id"));if(fr.data("pending-delay")){fr.removeData("pending-delay");ft=(parseInt(fu.data("title-fade-time")))||400;return fr.fadeOut(ft,function(){return fr.remove()})}else{return fr.remove()}};return{init:function(){bF(document).on("mouseenter",".title_bubble",fo);bF(document).on("mouseleave",".title_bubble",fn).on("mouseup",".title_bubble",fn);bF(document).on("mouseenter",".title_bubble_sticky",fo);return bF(document).on("mouseleave",".title_bubble_sticky",fn)},set_vertical_space:i,hide_all:function(){return bF(".title_bubble_container").remove()}}})();var ej;ej=INLINE_JS.Tooltip=E.Tooltip={attach:function(fp,T,i,j){var fo,fn;if(j==null){j={}}fp=$(fp);i=(i?$(i):null);fo=en.make(T,fp.tail_position,j.tail_position,j.width,j);fo.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fo);if(fp.match("#modal-content *")||fp.match(".db-modal-content *")){fo.style.zIndex="13001"}else{fo.style.zIndex=""}if(fp.tail_position==="right"){fn=(d6.ie?32:12);fo.style.marginLeft=-(fo.getWidth()+fp.getWidth()+fn)+"px"}fp.tooltip=fo;fp.out_target=(i?true:false);fp.observe("mouseout",this.mouseout("target",fp));fp.observe("mouseover",this.mouseover("target",fp));fp.out_trigger=(i?false:true);if(i){i.observe("mouseout",this.mouseout("trigger",fp));i.observe("mouseover",this.mouseover("trigger",fp))}fp.out_tooltip=true;fo.observe("mouseout",this.mouseout("tooltip",fp));return fo.observe("mouseover",this.mouseover("tooltip",fp))},update:function(j,i){if(j.tooltip){return $(j.tooltip).update(i)}},mouseover:function(i,j){return function(){return j["out_"+i]=false}},mouseout:function(i,j){return function(){j["out_"+i]=true;return ej.hide_if_out.defer(j)}},show_by:function(j){var T,i;T=bF(j.tooltip);j=bF(j);T.show();i=Math.floor(T[0].offsetHeight/2);return T.clonePosition(j,{setWidth:false,setHeight:false,offsetTop:Math.floor(j[0].offsetHeight/2)-i,offsetLeft:j[0].offsetWidth+1})},hide_if_out:function(i){var j;if(!i.out_target||!i.out_trigger||!i.out_tooltip){return}j=$(i.tooltip);return j.hide()},show:function(fo,fn,j,i,T){if(i==null){i="left"}fo=$(fo);if(!fo.tail_position){fo.tail_position=i}j=(j?$(j):null);if(!fo.tooltip){this.attach(fo,fn,j,T)}return this.show_by(fo)}};var b2;b2=INLINE_JS.TreeView=E.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(i){return this.ajax_params=i},init:function(T,i,fn){var j;if(fn==null){fn="treeview"}this.tv[fn]={};j=this.tv[fn];j.autohide=(i===null?true:i);j.handler=T;j.viewdiv=$(fn);j.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bE.ADD,(function(fo){return function(fp){return fo.schedule_reset()}})(this));document.observe(bE.REMOVE,(function(fo){return function(fp){return fo.schedule_reset()}})(this));return document.observe(bE.MOVE,(function(fo){return function(fp){return fo.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(fp){var T,fq,fn,j,fr,i,fo;T={url:"/ajax_subtreeview",type:"post",data:bF.extend({},this.ajax_params),success:(function(fs){return function(ft){var fu,fv;fu=[];for(fv in fs.tv){if(fs.tv.hasOwnProperty(fv)){fs.tv[fv].viewdiv.down(".treeview-folders").update(ft);if(fp&&fp.onSuccess){fu.push(fp.onSuccess(ft))}else{fu.push(void 0)}}else{fu.push(void 0)}}return fu}})(this)};if(fp!=null?fp.user:void 0){if(fp.user.id!==((fq=this.user)!=null?fq.id:void 0)){fr=bF("<p />",{id:"treeview-loading"});i=bF("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fr.append(i);fo=" "+eB("Loading your folders");fr.append(fo);bF("#dest-treeview .treeview-folders").html(fr);this.user=fp.user}T.subject_user=fp.user;j=cM.get_role_title(fp.user);if(cM.get_viewer().is_paired){if(fp.user.is_team){fn="s_briefcase"}else{fn="s_house"}}else{fn="dropbox"}if(!j){j=eB("Dropbox")}bF("#first-treeview-link span").text(j);cx.replace(bF("#root-img")[0],"web",this.role_icon,fn);this.role_icon=fn}else{bF("#first-treeview-link span").text(eB("Dropbox"))}return bF.ajax(T)},toggle:function(T,j){var i;Event.stop(T);i=this.tv[j||"treeview"];if(i.shown){i.shown=false;this.hide(T,j)}else{i.shown=true;this.show(T.target,j)}return false},hide:function(T,j){var i;i=this.tv[j||"treeview"];if(!T||!$(T.target).descendantOf(i.viewdiv)){i.viewdiv.hide();Event.stopObserving(window,"click",i.hidefunc);return i.shown=false}},show:function(T,j){var fn,i;i=this.tv[j||"treeview"];T=$(T);T.blur();fn=T.cumulativeOffset();i.viewdiv.setStyle({top:(fn.top+T.getHeight())+"px",left:(fn.left-4)+"px"});i.viewdiv.show();return Event.observe(window,"click",i.hidefunc)},toggleNode:function(j){var i;j=$(j);i=j.down("img");if(i.className.match("bullet_plus")){cx.replace(i,"web","bullet_plus","bullet_minus")}else{cx.replace(i,"web","bullet_minus","bullet_plus")}j.up().next("div").toggle();j.blur();return false},toggleNodeAjax:function(fn,i,j){var T,fo;if(fn.fetched_children){return this.toggleNode(fn)}fn=$(fn);T=fn.down("img");fo=cx._get(T);T.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bF.ajax({url:"/ajax_subtreeview"+i,type:"post",data:bF.extend({},this.ajax_params),subject_user:j,success:(function(fp){return function(fq){var fr;fr=new Element("div",{style:"display: none;"}).update(fq);fn.up().__sert({after:fr});fn.fetched_children=true;cx._set(T,fo);return fp.toggleNode(fn)}})(this),complete:function(){if(/loading/.match(T.src)){return cx._set(T,fo)}}});return false},handle:function(T,j){var fn,i;fn=$H(this.tv).keys();i=$(j).ancestors().find(function(fo){return fn.include(fo.id)});if(!i){return}i=this.tv[i.id];bF(document).trigger("db:treeview_selected",[T]);if(i.handler){i.handler(T,j)}if(i.autohide){this.hide(i.id)}return false},move:function(T,fn,j){var i;i=$(T);if(!this.loaded){this.reset({onSuccess:(function(fo){return function(){fo.loaded=1;return fo.move(T,fn,j)}})(this),user:j!=null?j.user:void 0})}else{if(j&&j.onSuccess){j.onSuccess()}}cL(i,"Couldn't find tree_id");cL($(fn),"Couldn't find location_id");$(fn).appendChild(i);return i.show()}};var aS;aS=E.ULSelectMenu=(function(){var fn,fr,T,fs,ft,fo,fq,i,fp,j,fu;fn=function(fv){return fv.removeClassName("shown")};fu=function(fv){return fv.toggleClassName("shown")};fq=function(){return this.removeClassName("hover")};fo=function(){return this.addClassName("hover")};i=function(fA,fz){var fy,fw,fx,fv;fx=[];for(fy=0,fw=fz.length;fy<fw;fy++){fv=fz[fy];fx.push(fA.insert(fv))}return fx};fs=function(fx,fv,fw){i(fx,fw);if(fx.firstChild!==fv){return fx.__sert({top:fv})}};fp=function(fw,fx){var fv;fv="selected";bF(fw).find("."+fv).removeClass(fv);return bF(fx).addClass(fv)};j=function(fy,fA){var fB,fx,fv,fz,fw;fz=fy.select("li");fw=[];for(fx=0,fv=fz.length;fx<fv;fx++){fB=fz[fx];if(fB.getAttribute("data-value")===fA){fw.push(fp(fy,fB))}else{fw.push(void 0)}}return fw};ft=function(fv,fx,fw){return function(fy){if(!fv.hasClassName("selected")){fp(fx,fv);fx.fire("db:change",fv.getAttribute("data-value"));return fn(fx)}else{fs(fx,fv,fw);return fu(fx)}}};fr=function(fx){var fB,fz,fA,fD,fy,fw,fC,fv;fD=fx.select("li");cL(fD.length,"Empty list of options "+fx.identify());fy=void 0;if(fD.length===1){fx.addClassName("one")}else{for(fz=0,fA=fD.length;fz<fA;fz++){fB=fD[fz];fC=fB.getAttribute("data-value");cL(fC,fB.identify()+" missing data value");fB.observe("click",ft(fB,fx,fD));fB.observe("mouseenter",fo);fB.observe("mouseleave",fq);if(fB.hasClassName("selected")){fy=fB}}$(document.body).observe("click",function(fE){if($(fE.target).up(".ul_select_menu")===fx){return}return fn(fx)})}if(!fy){fy=fD[0]}fy.addClassName("selected");fv=new Element("span");fw=fy.getDimensions();fv.setStyle({width:fw.width+"px",height:fw.height+"px",position:"relative",display:"inline-block"});return fx.wrap(fv)};T=function(){var fz,fx,fv,fy,fw;fy=$$(".ul_select_menu");fw=[];for(fx=0,fv=fy.length;fx<fv;fx++){fz=fy[fx];fw.push(fr(fz))}return fw};bF(T);return{init:function(fv){return fr(fv)},set_selected_by_value:j}})();var I;I=E.DBCalendar=Class.create({initialize:function(j,i){this.options=i||{};this.container=$(j);cL(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=d6.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=d6.start_of_day(this.options.first_day||this.today)}this.view_date=d6.start_of_day(this.options.selected_date||this.today);this.selected_date=d6.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(j,i){Event.stop(j);this.view_date.setMonth(i);return this.render()},is_valid_date:function(fn,fp,fo,T,i){var j;fn=parseInt(fn,10);fp=parseInt(fp,10);fo=parseInt(fo,10);T=parseInt(T,10);i=parseInt(i,10);T=T||1970;i=i||(new Date()).getFullYear()+1;fp+=1;if(fo<T){return false}if(fo>i){return false}if(fp<1||fp>12){return false}if(fn<=0){return false}if(fp===2){j=((fo%4)===0)&&(((fo%100)!==0)||((fo%400)===0));if(j){return fn<=29}else{return fn<=28}}else{if(fp===4||fp===6||fp===9||fp===11){return fn<=30}else{return fn<=31}}},change_date:function(i,fn,j){var T;if(!this.is_valid_date(i,fn,j)){return}T=j!==this.view_date.getFullYear()||fn!==this.view_date.getMonth();this.selected_date=new Date(j,fn,i);if(T){this.view_date.setMonth(fn);this.view_date.setFullYear(j);this.render()}else{bF(this.container).find(".selected").removeClass("selected");bF(this.container).find("a#day"+i+"-"+fn).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var fn,ft,fr,fp,fo,j,fq,T,fs,i;ft=this.render_days();fp=bF(".current-month",ft);fq=fp.first().data("date");j=fp.last().data("date");i=fq<=this.options.first_day;fs=j>=this.options.last_day;fn=new Element("div");fn.addClassName("calendar clearfix");if(!fs){this._next_month=(function(fu){return this._change_month(fu,this.view_date.getMonth()+1)}).bind(this);fo=new Element("a");fo.addClassName("changemonth next");fo.update(cx.make("web","arrowright",{}));Event.observe(fo,"click",this._next_month);fn.__sert(fo)}if(!i){this._prev_month=(function(fu){return this._change_month(fu,this.view_date.getMonth()-1)}).bind(this);T=new Element("a");T.addClassName("changemonth prev");T.update(cx.make("web","arrowleft",{}));Event.observe(T,"click",this._prev_month);fn.__sert(T)}fr=new Element("h5");fr.update(eB("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:b6.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));fn.__sert(fr);fn.__sert(ft);return this.container.__date(fn)},render_days:function(){var ft,fp,fs,fn,fq,fr,fu,T,fo;fp=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);T=fp.getDay();ft=new Element("div");ft.addClassName("days");for(fs=fq=fo=T;fo<=0?fq<0:fq>0;fs=fo<=0?++fq:--fq){fu=new Date(fp.getFullYear(),fp.getMonth(),fp.getDate());fu.setDate(fu.getDate()-fs);ft.__sert(this.render_day(fu,true))}fn=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fn.getMonth()===this.view_date.getMonth()){ft.__sert(this.render_day(fn));fn=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fn.getDate()+1)}fr=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(fr.getDay()!==6){fr=new Date(fr.getFullYear(),fr.getMonth(),fr.getDate()+1);ft.__sert(this.render_day(fr,true))}return ft},render_day:function(j,fn){var i,T;T=!fn;if(this.options.last_day){fn=fn||j>this.options.last_day}if(this.options.first_day){fn=fn||j<this.options.first_day}i=new Element(fn?"span":"a");bF(i).data("date",j);if(T){i.addClassName("current-month")}i.update(j.getDate());i.addClassName("date");i.writeAttribute("id","day"+j.getDate()+"-"+j.getMonth());if(this.selected_date.getDate()===j.getDate()&&this.selected_date.getMonth()===j.getMonth()&&this.selected_date.getFullYear()===j.getFullYear()){i.addClassName("selected")}if(fn){i.addClassName("inactive")}else{this._handler=(function(fp){var fo;fo=fp.target.identify().substr(3).split("-");return this.change_date(fo[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(i,"click",this._handler)}return i}});var aU;aU=E.DatePickerInput=Class.create({initialize:function(i,T){var fp,fn,fo,j;this.container=i;this.options={};Object.extend(this.options,T||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");j=(this.input.value?d6.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fo=d6.from_mysql_date(this.container.getAttribute("data-first"))}fp=this.options.disable_future!=null?this.options.disable_future:true;fn=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fo,disable_future:fp,disable_past:fn,selected_date:j});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(j)},show_cal:function(j){var i;if(j){Event.stop(j)}i=$(j.target);if(i.match(".cal-container")||i.up(".cal-container")){return}bF(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(i){this.input.value=d6.to_mysql_date(i,false);this.display.update(N.localize(i));return this.hide_cal()}});var fj;fj=E.TextInputDatePicker=Class.create({initialize:function(fn,T){var fp,fo,j,i;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,T||{});this.input=$(fn);cL(this.input,"Couldn't find the element "+fn.toString());j=new Date();i=(this.input.value?d6.from_mysql_date(this.input.value):false);fo=new Date(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate());this.cal_icon=cx.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+fn,style:"display: none; position: absolute; z-index: 1"});this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fo,selected_date:i});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));fp=bF(this.input);bF(this.cal_container).clonePosition(fp,{setWidth:false,setHeight:false,offsetTop:fp[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(i){if(i){Event.stop(i)}return this.cal_container.toggle()},hide_cal:function(i){if(i){Event.stop(i)}return this.cal_container.hide()},onDateChange:function(i){if(this.options.choose_eod){i.setTime(d6.start_of_day(i).getTime()+86399999)}this.input.value=d6.to_mysql_date(i,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});an.window_load(V.register.bind(V));bF(cj.init.bind(cj));bF(c5.register_all.bind(c5));Event.observe(window,"scroll",function(){return bo.hide_all()});bF(function(){ac.interval=setInterval(ac.check.bind(ac),500);dO.init();return bo.init()});var bg,fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;bg=INLINE_JS.ChangeNameModal=E.ChangeNameModal=(function(i){fe(j,i);function j(){j.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(T){return function(fq){var fp,fn,fo;fq.preventDefault();fp=bF(fq.target);fn=fp.closest("form");fo=function(){T.hide();return location.reload()};return bT.ajax_submit(fn[0],false,fo,null,fp[0])}})(this)}return j})(d8);var bW,et,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;et=E.ManageAliasModal=(function(j){fe(i,j);function i(T){this.options=T;this._poll_until_verified=b3(this._poll_until_verified,this);this._get_params_from_target=b3(this._get_params_from_target,this);this._on_load=b3(this._on_load,this);this._show_action_panel=b3(this._show_action_panel,this);this._input_enter_handler=b3(this._input_enter_handler,this);this.resend_verify=b3(this.resend_verify,this);this.remove_alias=b3(this.remove_alias,this);this.add_alias=b3(this.add_alias,this);this.refresh_alias=b3(this.refresh_alias,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.options)}i.prototype.before_show=function(T){i.__super__.before_show.call(this,T);this.polling=0;T.find(".alias-action").on("click",this._show_action_panel);T.find(".alias-action-submit").on("click",this.add_alias);T.find("form").submit(function(){return false});return T.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};i.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};i.prototype.refresh_alias=function(fn,T){if(fn==null){fn=true}if(fn){bT.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fo){return function(fp){fo.$modal_window.find(".dynamic-content").html(fp.responseText);fo._on_load(fp);if(typeof T==="function"){return T()}}})(this),onFailure:(function(fo){return function(fp){return fo.hide()}})(this)})};i.prototype.add_alias=function(fp){var fo,T,fn,fq;fp.preventDefault();T=bF(fp.currentTarget).closest("form");fo=T.find(".alias-action-submit");fq={};fq[a9.UID_PARAM_NAME]=this.options.subject_user.id;fn=(function(fr){return function(){var fs;fr.$modal_window.find(".alias-action-inputs input").val("");fr.polling=0;fs=fr.polling?null:fr._poll_until_verified;return fr.refresh_alias(true,fs)}})(this);return bT.ajax_submit(T[0],false,fn,false,fo[0],fq,"before")};i.prototype.remove_alias=function(T){var fn;T.preventDefault();fn=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:fn,onSuccess:(function(fo){return function(fp){return fo.refresh_alias()}})(this)})};i.prototype.resend_verify=function(T){var fn;T.preventDefault();fn=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:fn,onSuccess:(function(fo){return function(fp){return fo.refresh_alias()}})(this)})};i.prototype._input_enter_handler=function(T){T.preventDefault();T.stopPropagation();if(T.which===13){return this.add_alias(T)}};i.prototype._show_action_panel=function(fo){var fn,T;fo.preventDefault();T=bF(fo.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();fn=this.$modal_window.find("#"+T).show();return fn.find("input:visible:enabled:first").focus()};i.prototype._on_load=function(T){bf.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(fn){return function(fo){return fn.remove_alias(fo)}})(this));return this.$dynamic.on("click",".alias-verify",(function(fn){return function(fo){return fn.resend_verify(fo)}})(this))};i.prototype._get_params_from_target=function(fo){var T,fn,fp;T=bF(fo);fp=T.data("alias-type");fn=T.closest(".alias-row").find(".alias-text").text();return{alias:fn,alias_type:fp}};i.prototype._poll_until_verified=function(){var fo,fp,fn,T;fp=5;fo=60;fn=(function(fq){return function(){return fq.refresh_alias(false,fq._poll_until_verified)}})(this);T=this.$dynamic.find(".alias-verify").length;if(T&&this.polling<fo){this.polling++;return setTimeout(fn,fp*1000)}else{return this.polling=0}};return i})(d8);bW=INLINE_JS.AliasManager=E.AliasManager={show:function(fo){var T,fn,j,i;i=cM.get_viewer().get_user_by_role(fo);if(i==null){return}if(!i.is_email_verified){if(fo===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}j=cM.get_viewer().is_paired?fo:"";fn=eB("Manage your %(role_show)s contact methods").format({role_show:j});T=new et({element_id:"manage-alias",title:fn,subject_user:i,role:i.role});T.show()}};var dy;dy=INLINE_JS.BonusTable=E.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(i){this.user_id=i;if(dy._inited){return}dy._inited=true;$("bonus-loading").show();dy._tmpl=fi.tmpl("bonus_row_tmpl");dy.listen();return dy.get_next_page()},_render:function(fo){var fn,T,j,fp;fn=[];for(T=0,j=fo.length;T<j;T++){fp=fo[T];fn.push(dy._tmpl({row:fp,Sprite:cx}))}return $("bonus-table").__sert(fn)},get_next_page:function(){if(dy._fetching_page){return}dy._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dy._next_page,{onSuccess:function(j){var fn,i,T;fn=j.responseText.evalJSON();T=fn.rows;i=fn.has_more;dy._render(T);$("bonus-loading").hide();if(i){dy._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dy._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(j){var i,fn,T;fn=bF(j.currentTarget);T=eB("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");i=bF(en.make(T,"right","middle"));Element.absolutize(i[0]);fn.append(i);i.clonePosition(fn,{setWidth:false,setHeight:false});return i.css({width:"200px",left:(parseInt(i.css("left"),10)-210)+"px",top:(parseInt(i.css("top"),10)-55)+"px"})},_max_referral_out:function(fq){var T,fo,j,fp,fn;fp=bF(".reached-max-referral-bonus .bubble");fn=[];for(fo=0,j=fp.length;fo<j;fo++){T=fp[fo];fn.push(T.remove())}return fn},listen:function(){bF("#load-more-bonus").on("click",dy.get_next_page.bind(dy));bF(document).on("mouseenter",".reached-max-referral-bonus",dy._max_referral_over);return bF(document).on("mouseleave",".reached-max-referral-bonus",dy._max_referral_out)},toggle:function(){if(bF("#bonus-list").is(":visible")){this.hide();return bF("#space-earned-link").text(eB("View all space earned"))}else{this.show();return bF("#space-earned-link").text(eB("Hide space earned"))}},show:function(){return bF("#bonus-list").slideDown(150)},hide:function(){return bF("#bonus-list").slideUp(150)}};var D,v,c;D=INLINE_JS.DowngradeReasons=E.DowngradeReasons={reasons:{},addReason:function(i){return this.reasons[i]=true},addReasons:function(T){var fp,fn,j,fo;fo=[];for(fp=0,j=T.length;fp<j;fp++){fn=T[fp];fo.push(this.addReason(fn))}return fo},change:function(fp,T,j){var fq,fs,fr,fn,fo,i;fp=parseInt(fp,10);fs=$(T);cL(fs,"Couldn't find container for DowngradeReason");fq=false;fo=this.reasons;for(fn in fo){fr=fo[fn];i=$(j+fn);cL(i,"Couldn't find container for ",j+fn);if(fr&&parseInt(fn,10)===fp){i.show();fq=true}else{i.hide()}}if(fq){return fs.show()}else{return fs.hide()}}};v=E.DowngradeReasons2={init:function(){var fn,j,T,fo;fo=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(fn=0,j=fo.length;fn<j;fn++){T=fo[fn];bF(T).change(function(fp){var i;i=fp.target.id.indexOf("other")>=0;return v.change(i,fp.target.getValue())})}return bF(".shared-additional-info").attr("name","shared_additional_info")},change:function(T,i){var j;bF(".downgrade-other-reason .error-message").hide();if(T){return}j="#downgrade-info-"+i;bF(".downgrade-info").hide();bF(j).show();bF(".downgrade-info textarea").removeAttr("name");bF(j+" textarea").attr("name","additional_info");return bF("input[name=other_reason_id]").removeAttr("checked")}};c=E.DowngradeSurvey={init:function(){var i;i="#downgrade-survey-form";return bF(""+i).on("submit",(function(j){return function(fo){var fn,T;T=bF(i+" input[name=other_reason_id]:checked").length;fn=bF(i+" input[id=downgrade-radio-8]");if(fn.is(":checked")&&T===0){bF(".downgrade-other-reason .error-message").show();return fo.preventDefault()}}})(this))}};var cc;cc=INLINE_JS.GetSpace=E.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(T,j,fn){var i;cc._current_space=T;cc._why_msg=j;cc._twitter_url=fn;$("space-actions").on("click",".space-action",cc.perform_action);i=G.parse(window.location.href).fragment;if(i){return cc.highlight_offer(i)}},highlight_offer:function(j){var i,T;i=bF("#"+j);T=i.css("background-color");return i.css("background-color",cc.offer_highlight_color).delay(2000).animate({"background-color":T}).queue(function(){return i.css("background-color","")})},perform_action:function(j){var T,i;i={contact_sales:cc._contact_sales,contact_support:cc._contact_support,teams:cc._teams,upgrade:cc._upgrade,plans:cc._plans,refer:cc._refer,get_started:cc._get_started,fb_link:cc._fb_link,twitter_link:cc._twitter_link,twitter_follow:cc._twitter_follow,why_like:cc._why_like,mailbox_link:cc._mailbox_link};T=$(j.target);if(!T.hasClassName("space-action")){T=T.up(".space-action")}return i[T.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return er.do_auth(function(){cc._refresh_link_bonuses();return cc._completed($("fb_link"))},cM.get_viewer().personal_user.id)},_twitter_link:function(){return cG.do_auth(function(){cc._refresh_link_bonuses();cG.set_is_authed(cM.get_viewer().personal_user.id,true);return cc._completed($("twitter_link"))},cM.get_viewer().personal_user.id)},_twitter_follow:function(){if(cG.is_authed(cM.get_viewer().personal_user.id)){return cc.follow_dropbox()}else{return cG.do_auth(cc.follow_dropbox,cM.get_viewer().personal_user.id)}},_why_like:function(){fd.show(eB("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return d6._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cG.is_authed(cM.get_viewer().personal_user.id)){cc._refresh_link_bonuses();cG.set_is_authed(cM.get_viewer().personal_user.id,true)}return cG.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(eB("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(eB("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){cc._completed($("twitter_link"))}return cc._completed($("twitter_follow"))}},cM.get_viewer().personal_user.id)},submit_why:function(){cc._why_msg=$F("why-i-like-input");return bT.ajax_submit($("why-i-like-form"),false,(function(){fd.hide();return cc._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(j){var i;j.addClassName("completed");j.down(".icon-col").__date(Element("img",{src:"/static/images/check_36-vflimxFPn.png"}));bF(j).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bF(j).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);i=parseInt(j.down(".space").readAttribute("data-space"),10);cc._current_space+=i;$("current-space").__date(aF.format_bytes(cc._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bz;bz=E.Help={toggle_more_help:false,show_os:function(j,T,i){T=$(T);$$(".os-filter").invoke("removeClassName","selected");T.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+i).invoke("show");return Event.stop(j)},vote:function(i,j){new Ajax.DBRequest("/help/"+i+"/vote/"+j);bF("#help-vote-cont").fadeOut();return ah.success(eB("Thanks for your feedback!"))}};var ew,dV,ag,u,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;dV=INLINE_JS.Hosts=E.Hosts={attach_host_listener:function(fo,T){var j,fn,fp,i;j=bF("#"+fo);fp=j.data("host-ids");fn=j.data("display-name");i=function(){return new ag(fp,fn,T,null,null).show()};bF(".unlink-host-link",j).on("click",i);return j.on("dblclick",(function(){return dV.edit(fp,fo)}))},edit:function(fq,fn){var T,fr,fs,fp,fo,j;fs=bF("#"+fn+" .host-item .sprite-text");if(fs.data("editing")==="true"){return false}fs.data("editing","true");fr=fs.text();fs.data("previous",fr);fq=bx.values(fq);fp=bF('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fr);j=bF('<input type="button" class="button">').val(eB("Save"));j.on("click",function(){return dV.doneEditing(fq,fn)});T=bF('<input type="button" class="button grayed">').val(eB("Cancel"));T.on("click",function(){return dV.cancelEditing(fn)});fs.empty();fs.append(fp,"&nbsp;",j,"&nbsp;",T);fo=bF("input",fs);fo.on("keydown",function(){return dV.checkKey(fq,fn)});fo.focus();return false},doneEditing:function(T,j){var fn,i;fn=bF("#"+j+" .host-item .sprite-text");i=bF("input",fn).val();return bF.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(T),name:i},type:"POST"}).success(function(fo){return dV.unedit(fn,JSON.parse(fo).display_name)})},cancelEditing:function(i){var j;j=bF("#"+i+" .host-item .sprite-text");return dV.unedit(j,j.data("previous"))},unedit:function(j,i){j.data("editing","false");return j.text(i)},dismiss:function(T,j,fn,i,fo){new bF.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:T,user_id:j,team_id:fn},subject_user:fo,success:function(fp){return i.remove()}});return false},checkKey:function(j,i){return function(T){T=T||window.event;if(T.keyCode===Event.KEY_RETURN){dV.doneEditing(j,i)}if(T.keyCode===Event.KEY_ESC){return dV.cancelEditing(i)}}},show_device_unlink_modal:function(j,T,i,fr,fo,fn){var fq,fp;fq=bF("#unlink-device-modal-"+fo);fp={both:bx.values(fr),personal:[fr[Constants.ROLE_PERSONAL]],work:[fr[Constants.ROLE_WORK]]};fd.show(i,fq[0]);if(bx.values(fr).length>1){fq.addClass("show-selector")}return bF("form input[type=submit]",fq).on("click",function(fs){fs.preventDefault();fr=fp[bF(".unlink-select select",fq).val()];bT.add_vars(bF("form",fq)[0],{user_ids:JSON.stringify(fr),app_id:T,device_id:JSON.stringify(j),device_name:fn});return bF("form",fq).submit()})}};ew=E.DeleteFailuresModal=(function(i){fe(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};j.prototype.on_show=function(fn){var T;T=bd("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(T)};return j})(d8);u=INLINE_JS.show_delete_failures_modal=E.show_delete_failures_modal=function(T,j,i){var fn;fn=new ew({element_id:"delete-failures-modal"});fn.host_id=T;fn.name=j;fn.num_failures=i;fn.show();return false};ag=INLINE_JS.UnlinkHostModal=E.UnlinkHostModal=(function(j){fe(i,j);function i(T,fq,fo,fn,fp){this.host_ids=T;this.name=fq;this.delete_support_type=fo;this.owner_id=fn;this.team_id=fp;this.on_show=b3(this.on_show,this);this._set_delete_text=b3(this._set_delete_text,this);this.fail_callback=b3(this.fail_callback,this);this.success_callback=b3(this.success_callback,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=bx(this.host_ids).values().length>1}i.prototype.on_confirm_button_click=function(fp){var fn,fo,T;fp.preventDefault();fo=this.$modal_window.find(".unlink_host_form")[0];fn=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");T={host_ids:JSON.stringify(this.get_selected_hosts())};return bT.ajax_submit(fo,false,this.success_callback,this.fail_callback,fn,T)};i.prototype.success_callback=function(){return window.location.reload()};i.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};i.prototype._set_delete_text=function(T){return this.$modal_window.find(".delete_data_label").text(T)};i.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};i.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};i.prototype.on_show=function(fn){var T;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_PERSONAL){return fo.$modal_window.find(".new_client").hide()}else{return fo.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eB("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cM.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_WORK){return fo.$modal_window.find(".new_client").hide()}else{return fo.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eB("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(eB("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_PERSONAL){return fo._set_delete_text(eB("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fo._get_unlink_select()===Constants.ROLE_WORK){return fo._set_delete_text(eB("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cM.get_viewer().team_name}))}else{return fo._set_delete_text(eB("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){T="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(eB("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:T}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};i.prototype.get_selected_hosts=function(){var T;if(bx.values(this.host_ids).length===1){return bx.values(this.host_ids)}T=bF(".unlink-choice").val();if(T==="both"){return bx.values(this.host_ids)}else{return[this.host_ids[T]]}};return i})(d8);var eM;eM=E.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(j,T){var i;if(T.hasAttribute("data-div")){j.preventDefault();i=T.readAttribute("data-div");return eE.push_state("/news/"+i)}});return eE.add_callback("/news",eM.history_change)},change_tab:function(i){var j;j=$$("#nav a[data-div="+i+"]").first();if($(j)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(j).addClassName("selected");return $(i).addClassName("selected")}},history_change:function(i){i=i||eM.DEFAULT_TAB;return eM.change_tab(i)}};var dH;dH=E.Recover={init:function(){var i;i=$("recover-form");return i.observe("submit",this.form_submit.bind(this))},form_submit:function(i){this.clear_error();i.preventDefault();return bT.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(j){var i;i=JSON.parse(j.responseText);if(i.status==="error"){this.show_error(i.msg)}if(i.status==="ok"){this.show_hosts(i)}if(i.status==="redirect"){return window.location.href=i.url}},show_hosts:function(fs){var fr,fo,fn,fp,T,j,fq;bT.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fs.filename);fo=$("trusted-hosts");fo.update();fq=fs.hosts;for(fn=0,T=fq.length;fn<T;fn++){fr=fq[fn];j=new Element("li");fp="lnx";if(fr.platform==="mac"){fp="osx"}if(fr.platform==="win"){fp="win"}j.__sert(cx.make("web",fp));j.__sert(new fi(fr.display_name.escapeHTML()));fo.appendChild(j)}$("login-step").hide();return $("hosts-step").show()},show_error:function(i){$("error-messages").update(i);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var dq;dq=E.Restore={next:function(i,fn){var T,j;j=bF("ul.selected");T=j.next("ul");T.addClass("selected");j.removeClass("selected");if(T.next("ul").length){bF("#next-page").show()}else{bF("#next-page").hide()}bF("#prev-page").show();return dq.inc_page(1)},prev:function(i,fn){var T,j;j=bF("ul.selected");T=j.prev("ul");T.addClass("selected");j.removeClass("selected");if(T.prev("ul").length){bF("#prev-page").show()}else{bF("#prev-page").hide()}bF("#next-page").show();return dq.inc_page(-1)},inc_page:function(T){var j,i;j=parseInt(bF("#page_num").text(),10);i=j+T;return bF("#page_num").text(i)},init:function(fn,i,j){var T;T=cM.get_viewer().get_user_by_id(j);bF("#next-page").on("click",function(fo){dq.next(fo);return false});bF("#prev-page").on("click",function(fo){dq.prev(fo);return false});bF("#restore-submit-button").on("click",function(fo){dD.do_folder_restore(fn,T);return false});bF("#restore-cancel-button").on("click",function(fo){return b1.redirect(i)});return bF("#restore-back-button").on("click",function(fo){return b1.redirect(i)})}};var cg,dz,cI,aT,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;cg=E.SelectRoleModal=(function(i){fe(j,i);function j(){this.on_show=b3(this.on_show,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=null;j.prototype.on_show=function(){return bF(".role-options li").click((function(T){return function(fo){var fn,fp;fn=bF(fo.target).closest("li");fp=fn.data("role");cL(T.on_select_role,"missing on_select_role implementation");T.on_select_role(fp);return T.hide()}})(this))};return j})(d8);cI=E.SharedFolderSelectRoleModal=(function(i){fe(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fn){var T;T=function(){bZ.role_picker.ensure_role_is_visible(fn);return s.start_wizard_for_user(cM.get_viewer().get_user_by_role(fn))};if(fn===bO.logged_out_role){return bO.show_modal({role:fn,on_success:T})}else{return T()}};return j})(cg);aT=E.ShmodelC2DSelectRoleModal=(function(i){fe(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fn){var T;T=function(){return am.show_c2d_modal(fn)};if(!cM.get_viewer().is_role_signed_in(fn)){return bO.show_modal({role:fn,on_success:T})}else{return T()}};return j})(cg);dz=E.ShareShmodelSelectRoleModal=(function(i){fe(j,i);function j(){this.on_select_role=b3(this.on_select_role,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(T){return am.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,T)};return j})(cg);var cQ;cQ=E.TabController=Class.create({initialize:function(T,j){var i;i=$(T);cL(i,T+" is missing.");this.container=i;this.options={killEvent:true};Object.extend(this.options,j);return this.listen()},listen:function(){var fq,fn,j,fp,T,fo;fo=this;fp=this.container.select("a");T=[];for(fn=0,j=fp.length;fn<j;fn++){fq=fp[fn];cL(fq.id&&fq.id.length>0,"Element is missing an id");T.push(fq.observe("click",(function(i){return this.click(i)}).bindAsEventListener(fo)))}return T},click:function(i){if(this.options.killEvent){Event.stop(i)}return this.toggle($(i.target))},toggle:function(j){var fo,i,fn,fp,T;T=this.container.down("a.selected");if(T){fp=$(T.id+"-content");if(fp){fp.hide()}}this.container.select(".selected").invoke("removeClassName","selected");i=false;if(!j){j=this.container.down("a");i=true}j.addClassName("selected");fo=$(j.id+"-content");if(fo){fo.show()}if(this.options.onTabChange){this.options.onTabChange(j,T)}if(this.options.url_prefix){fn=this.options.url_prefix;if(!i){fn+="/"+j.id}return eE.push_state(fn)}}});var dQ;dQ=E.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bF((function(i){return function(){i.add_auto_completer=new Autocompleter.ContactsTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(j){return j.excludeTeamMembers().excludeFacebook().excludeNewStyleGroups().excludeMe()}});i.add_auto_completer.clearTokens();i.tokenAdd=bF.proxy(i._tokenAdd,i);i.tokenRemove=bF.proxy(i._tokenRemove,i);bF("#team-invite-new-collab-input")[0].on("token:add",i.tokenAdd);bF("#team-invite-new-collab-input")[0].on("token:remove",i.tokenRemove);i.reset_licenses();i.update_free_licenses_message();i.initialized=true;i.setup_tab_support(bF);return cj.init()}})(this))},set_emails:function(i){if(i==null){return}return bF((function(j){return function(){var fn,fq,fp,T,fo;j.init();fo=[];for(fp=0,T=i.length;fp<T;fp++){fn=i[fp];fq=j.add_auto_completer.createTokenInfo(null,fn,W.EMAIL);fo.push(j.add_auto_completer.addContact(fq))}return fo}})(this))},rebind_modal_submit_autocompleter:function(){var i,j;i=this.invite_modal.$modal_window;j=i.find(".tokenizer-submit-button");j.on("mousedown",(function(T){return function(){return T.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(i)},setup_tab_support:function(i){return i.find("#team-invite-new-collab-input").first().on("keyup change",function(){var j;j=i.find(".new-collab-input").first();if(j.val()!==""){return j.attr("tabindex",-1)}else{return j.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T,j,i;i=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(T=(j=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof j.get_total_licenses==="function"?j.get_total_licenses():void 0:void 0)!=null?T:this.total_licenses;this.update_used_licenses(i);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(i){this.available_licenses--;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(i){this.available_licenses++;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(j){var fn,T,i;if(window.active_team_member_table){fn=window.active_team_member_table.data.users;for(i in fn){T=fn[i];if(T.email===j){return true}}}},update_license_count:function(){var i,j;i=bF("#license-count-message");if(this.available_licenses<0){j=eB("You need more licenses for this invitation.");i.addClass("over")}else{if(this.available_licenses===0){j=eB("You have no remaining licenses.");i.removeClass("over")}else{if(this.available_licenses>0){j=bd("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});i.removeClass("over")}else{j="You have \u00a0 remaining licenses."}}}return i.text(j)},init_modal_licenses:function(T,j,i){if(!this.invite_modal){this.invite_modal=new w(i)}this.total_licenses=T;this.is_trial=j;return bF("body").trigger("invite-modal-initialized")},update_used_licenses:function(i){this.used_licenses=i;return this.reset_licenses()},init_form_licenses:function(T,i,j){this.total_licenses=T;this.used_licenses=i;this.is_trial=j;return dQ.reset_licenses()},add_total_licenses:function(i){i=i||0;if(i>0){this.total_licenses+=i;this.available_licenses+=i;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(i)}}},on_add_licenses_exit:function(T,i){var j;if((j=this.invite_modal)!=null?j.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(i)},reset_modal:function(){var i;i=this.invite_modal.$modal_window;c5.reset(i.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens();this.add_auto_completer.update.hide()}this.reset_modal_licenses();return i.find(".new-collab-input").val("")},on_add_licenses_click:function(j){var i;j.preventDefault();if(this.is_trial){if((i=this.invite_modal)!=null){i.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){d1.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bF.proxy(this.on_add_licenses_exit,this);d1.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return d1.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var i;i=this.invite_as_limited();bF(".team-invite-add-licenses").toggle(!i);bF("#license-count-message").toggle(!i);return bF("#license-free-message").toggle(i)},invite_as_limited:function(){var i;i=bF('input[name="membership_type"]');return i&&i.is(":checked")}};var w,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;w=E.InviteModal=(function(j){fe(i,j);function i(T){this.transition_view_model=T;this._reset=b3(this._reset,this);this._update_form_pricing_information=b3(this._update_form_pricing_information,this);this._update_remaining_licenses_message=b3(this._update_remaining_licenses_message,this);this._make_transition_info_request=b3(this._make_transition_info_request,this);this._handle_token_change=b3(this._handle_token_change,this);this._licenses_total=b3(this._licenses_total,this);this.is_making_transition_info_request=b3(this.is_making_transition_info_request,this);this.on_hide=b3(this.on_hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input",title:eB("Invite team members")});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new fh([this.transition_view_model]);this.probability=Math.random()}this.skip_reset=false;this.making_transition_info_request=false;this.transition_info_callback=null}i.prototype.on_confirm_button_click=function(fn){var T;if(dQ.invite_as_limited()){T=0}else{T=this.add_qty}return dU.add_users(fn,T)};i.prototype.on_show=function(){var fn,T;this._reset();T=bF('input[name="membership_type"]');if(T!=null){T.attr("checked",false)}if(T!=null){T.click((function(fo){return function(){dQ.update_free_licenses_message();return fo._updated_charges_messages(dQ.invite_as_limited())}})(this))}fn=bF("#team-invite-wizard .team-invite-add-licenses");fn.on("click",bF.proxy(dQ.on_add_licenses_click,dQ));bF(window).on("token:changed",this._handle_token_change);if(dQ.initialized){dQ.update_license_count();dQ.update_free_licenses_message()}return d1.register(d1.CLEAR,function(){return dQ.reset_modal()})};i.prototype.on_hide=function(){return bF(window).off("token:changed",this._handle_token_change)};i.prototype.is_making_transition_info_request=function(){return this.making_transition_info_request};i.prototype._licenses_to_add=function(){return -1*dQ.available_licenses};i.prototype._licenses_total=function(){return dQ.total_licenses+this._licenses_to_add()};i.prototype._getInvitesCount=function(){return dQ.total_licenses-dQ.used_licenses-dQ.available_licenses};i.prototype._handle_token_change=function(fn,T){this._updateConfirmButton();this._update_remaining_licenses_message(T.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fo){return function(){fo._make_transition_info_request();return fo.fetch_transition_timeout_id=null}})(this),100)}};i.prototype._make_transition_info_request=function(){var fo,fn,T,fp;this.making_transition_info_request=true;fn=Math.floor(Math.random()*1000000);this.current_callback_token=fn;fo=this._licenses_to_add();T=this._licenses_total();fp=(function(fq){return function(fr){return fq._update_form_pricing_information(fn,fo,T,fr!=null?fr[0]:void 0)}})(this);if(fo>0){return this.transition_info_fetcher.get(fp,{total_users:this._licenses_total()})}else{return fp(null)}};i.prototype._update_remaining_licenses_message=function(T){var fn;this.remaining_licenses=T;fn=this._get_remaining_licenses_message(this.remaining_licenses);return this.$modal_window.find("#license-count-message").text(fn)};i.prototype._get_remaining_licenses_message=function(T){var fn;if(T<0){fn=eB("You need more licenses for this invitation.")}else{if(T===0){fn=eB("After this invitation, you'll have no remaining licenses.")}else{fn=bd("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",T).format({count:T})}}return fn};i.prototype._update_form_pricing_information=function(fp,fq,T,ft){var fn,fs,fr,fo;if(fp!==this.current_callback_token){return}if(ft&&fq>0){this.add_qty=fq;fn=this.transition_view_model.state.currency;fr=ft.current_total.amount;fs=fg.formatCurrency(fr,fn);fo=fg.formatCurrency(ft.recurring_total.amount,fn);bF(".new-amount").text(fs);bF(".add-qty").text(fq);bF(".recurring-amount").text(fo);bF(".total-qty").text(T);bF("#expected_price").val(fr);this._updated_charges_messages(dQ.invite_as_limited())}else{this._reset()}return this.making_transition_info_request=false};i.prototype._updateConfirmButton=function(){var T;T=bd("Send invite","Send invites",this._getInvitesCount());return bF(".team-invite-buttons .confirm-button").val(T)};i.prototype._reset=function(){this.add_qty=0;bF(".charges-section").hide();bF("#expected_price").val(0);return this._updateConfirmButton()};i.prototype._updated_charges_messages=function(T){if(this.inline_add_license&&this.add_qty>0&&!T){bF(".charges-section").show();return bF(".team-invite-buttons .confirm-button").val(eB("Invite and buy"))}else{bF(".charges-section").hide();return this._updateConfirmButton()}};return i})(d8);var bJ,aw,aB,U,ef,e1,bu,eK,dU,fc,bh,cs,q,b3=function(i,j){return function(){return i.apply(j,arguments)}},fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty;dU=INLINE_JS.Team=E.Team={_use_async_reset:false,team_id:cM.get_viewer().team_id,set_team_id:function(i){this.team_id=i},setup_beta_modal_listeners:function(){var fr,fu,fs,T,fq,fn,ft,fo,fp;fu=bF(".feature-list .enroll-button");T=bF(".feature-list .feedback-button");for(fq=0,ft=fu.length;fq<ft;fq++){fr=fu[fq];fs=bF(fr).data("feature");bF(fr).click((function(i){return function(){return new aw(i).show()}})(fs));fr.disabled=false}fp=[];for(fn=0,fo=T.length;fn<fo;fn++){fr=T[fn];fs=bF(fr).data("feature");fp.push(bF(fr).click((function(i){return function(){return new aB(i).show()}})(fs)))}return fp},invite_modal_show:function(i){if(!dQ.invite_modal){return bF("body").one("invite-modal-initialized",(function(j){return function(){return j.invite_modal_show(i)}})(this))}if(!this.invite_modal_already_initialized){dQ.invite_modal.show();dQ.init();this.invite_modal_already_initialized=true}else{dQ.invite_modal.show();dQ.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dQ.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dQ.set_emails(i)},init_admin:function(){bo.set_vertical_space(2);return bF("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bF(".team_name_change_notice .hide_link").click((function(i){return function(j){return i.hide_team_name_change_banner()}})(this))},add_users:function(fn,j){var fo,T,i;Event.stop(fn);T=$("team-invite-form");cL(T,"Couldn't find the team invite form.");fo=bF(T).find("input[name='emails']");if(fo.length===0){ah.error(eB("You haven't included anyone to invite! Please invite at least one person."));return}i=(function(fp){return function(){var fq;fq=bT.collect_form_vars(T);bF.extend(fq,{team_id:fp.team_id});bT.add_loading(fn.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:fq,subject_user:cM.get_viewer().work_user,progress_text:eB("Inviting members..."),noAutonotify:true,onSuccess:function(fw){var fu,ft,fs,fv,fr;bT.remove_loading();dQ.reset_modal();dQ.add_total_licenses(j);dQ.invite_modal.hide();fv=bF(".team_admin_members_table");fs=JSON.parse(fw.responseText);if(fs){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fs!=null?fs.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fs!=null?fs.num_invited:void 0)}}}fu=(function(){var fy,fx;fy=fs!=null?fs.users:void 0;fx=[];for(ft in fy){fr=fy[ft];fx.push(fr)}return fx})();if(fu.length===1){return ah.success(eB("Invited %(user_email)s.").format({user_email:fu[0].email}))}else{if(fu.length>1){return ah.success(eB("Invited %(user_count)d people.").format({user_count:fu.length}))}else{return ah.error(bd("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fo.length).format({num_skipped:fo.length}))}}}else{return ah.error()}},onFailure:function(ft){var fr,fs;if(ft){if(ft.responseText.indexOf("err:")===0){fr=ft.responseText.substr(4);if(fr.indexOf("{")===0){fs=fr.evalJSON(true);bT.fill_errors(T,fs)}else{fr=new fi(fr);ah.error(fr)}}else{ah.error()}}bT.remove_loading();return bF("input[type='submit']").prop("disabled",false)},cleanUp:function(){bT.remove_loading();dQ.reset_modal();return dQ.invite_modal.hide()}})}})(this);return setTimeout(function(){if(!dQ.invite_modal.is_making_transition_info_request()){return i()}},100)},show_demo_signup_modal:function(T,fn,fo,j,fp){var i,fs,fr,fq;this.webinar_key=T;this.webinar_iso_datetime=fn;this.webinar_date=fo;this.webinar_title=j;this.tab_url=fp;fq=eB("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fs=new U({element_id:"demo-signup-modal",title:fq});fs.show();fs.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fs.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fs.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fs.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fr=fs.$modal_window.find("input[name=retURL]");fr.attr("value",fr.val()+"#"+this.tab_url);i=fs.$modal_window.find("#demo-signup-form")[0];return i.on("submit",fs.on_confirm_button_click)},show_unsuspend_modal:function(fn,i,j,T){var fo;fo=new bu({element_id:"dfe-unsuspend-modal",focus:"confirm"});fo.user_name=fn||j;fo.email=j;fo.user_id=i;fo.team_id=this.team_id;fo.refresh_cb=T;fo.show();return false},show_remove_or_deactivate_modal:function(j,T,fs,fn,fo,fq,i,fp){var fr;fr=new ef({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});fr.user_name=T||fn;fr.email=fn;fr.user_id=fs;fr.team_id=this.team_id;fr.invited=fo;fr.limited=fq;fr.hide_transfer_wipe=i;fr.refresh_cb=fp;fr.show();return false},show_remove_modal:function(fn,fo,ft,fp,fq,i,j,T,fr){var fs;fs=new e1({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fs.user_name=fo||fp;fs.email=fp;fs.user_id=ft;fs.team_id=this.team_id;fs.invited=fq;fs.num_api_apps=i;fs.hide_transfer_setting=j;fs.hide_remote_wipe_setting=T;fs.refresh_cb=fr;fs.show();return false},remove_user:function(fn,fo){var T,j,i;alert("in remove_user");Event.stop(fn);j=bF("input[type=submit]","#remove-user-modal");j.attr("disabled",1);i=fd.vars.user_id;if(fo){T=true}else{T=bF("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:i,should_disable:T},onSuccess:(function(fp){return function(ft){var fs,fr,fq;fq=JSON.parse(ft.responseText);if((fs=window.active_team_member_table)!=null){fs.remove_user(fd.vars.user_id)}if((fr=window.removed_team_member_table)!=null){fr.add_users(fq)}fp.decrement_used_licenses();return ah.success(eB("User removed."))}})(this),cleanUp:function(){fd.hide();return j.removeAttr("disabled")}})},show_reinvite_modal:function(T,fn,i,j){var fo;dv.fillVal(j,"reinvite-user-email");dv.fillVal(fn,"reinvite-user-team");fo=eB("Resend invite to '%(email_address)s'").format({email_address:bU.em_snippet(j,18)});return fd.show(fo,$("reinvite-user-modal"),{user_id:i,button:T})},email_verification:this.email_verification=new d4("work"),show_email_verification_modal:function(){return this.email_verification.show_verify_modal(null,es.NEW_DFB_TEAM)},reinvite_user:function(j){var i;Event.stop(j);i=fd.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(fq){var fn,fp,fo,T;ah.success(eB("Invite sent."));if((fp=$("team-member-info"))!=null){fp.update(fq.responseText)}fn=window.active_team_member_table;if(fn){T=fn.data.users[i];T.invite_expired=false;fo={};fo[i]=T;return fn.update_user_data(fo)}},cleanUp:function(){return fd.hide()}})},show_request_license_modal:function(j,i){var T;T=eB("Send upgrade request?");return fd.show(T,$("request-license-modal"),{user_id:i,button:j})},request_license:function(j){var i;Event.stop(j);i=fd.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){bF("#request_license_text").hide();bF("#request-license-section").hide();return ah.success(eB("Request sent."))},cleanUp:function(){return fd.hide()}})},show_user_activity_log_modal:function(i,T,fn){var j;j=bF("#activity-log-modal");j.find(".activity-log-email").text(T);j.find(".activity-log-name").text(fn);j.find("#activity-log-user-message").show();return fd.show(eB("Create activity report"),j[0],{user_id:i})},show_team_activity_log_modal:function(j,T){var i;i=bF("#activity-log-modal");i.find(".activity-log-email").text(j);i.find(".activity-log-name").text(T);i.find("#activity-log-team-message").show();return fd.show(eB("Create full activity report"),i[0])},generate_activity_log:function(fr){var fp,fn,fq,fo,i,T,j;Event.stop(fr);fn=bF("#activity-log-modal");fq=fn.find("input[name='from_date']").val();i=fn.find("input[name='to_date']").val();if(fq>i){ah.error(eB("Your start date is after your end date."));return}fo=this.team_id;j=fd.vars.user_id;T=new Date().getTimezoneOffset().toString();fp=bF(".activity-report-generator .freshbutton-blue");fp.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fq,to_date:i,team_id:fo,user_id:j,tzoffset:T},onSuccess:function(fs){return ah.success(eB("Report started. We'll email you when it's ready."))},cleanUp:function(){fd.hide();return fp.prop("disabled",false)}})},show_reset_password_modal:function(j,T,i){var fn;bF("#reset-password-modal .member-name").text(T);fn=eB("Reset password for '%(user_name)s'").format({user_name:T});return fd.show(fn,$("reset-password-modal"),{user_id:i,button:j})},reset_password:function(j){var i;Event.stop(j);i=fd.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){return ah.success(eB("User's password reset."))},cleanUp:function(){return fd.hide()}})},show_reset_all_passwords_modal:function(){return fd.show(eB("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(i){return this._use_async_reset=i},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cM.get_viewer().work_user,progress_text:eB("Resetting all passwords..."),onSuccess:function(i){return ah.success(eB("All passwords reset."))},cleanUp:function(){return fd.hide()}})},show_admin_status_modal:function(T,fr,ft,fo,fs,fp){var j,i,fn,fq;i=fs.strip()||fo;fn=void 0;j=void 0;fq=void 0;if(fp){fq=eB("Add admin permissions for '%(person_name)s'").format({person_name:i.escapeHTML()});fn=eB("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eB("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fq=eB("Remove admin privileges from '%(person_name)s'").format({person_name:i.escapeHTML()});fn=eB("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eB("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}dv.fillVal(fo,"admin-status-email");dv.fillVal(fn,"admin-status-action");dv.fillVal(j,"admin-status-button-action");fd.show(fq,$("admin-status-modal"),{user_id:ft,button:T,admin_on:fp});return false},set_admin_status:function(j){var i;Event.stop(j);i=fd.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:i,on:(fd.vars.admin_on?"yes":"no")},onSuccess:function(fn){var fo,T;fo=(fd.vars.admin_on?eB("User's admin status granted."):eB("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){T=JSON.parse(fn.responseText);window.active_team_member_table.update_user_data(T);return ah.success(fo)}else{if(fd.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(fd.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(fd.vars.user_id)}}}},cleanUp:function(){return fd.hide()}})},show_disable_2fa_modal:function(T,i,j){bF("#disable-2fa-modal .member-name").text(j);return fd.show(eB("Disable two-step verification"),$("disable-2fa-modal"),{user_id:i,elm:T})},show_reset_2fa_modal:function(T,i,j){bF("#reset-2fa-modal .member-name").text(j);return fd.show(eB("Reset two-step verification"),$("reset-2fa-modal"),{user_id:i,user_name:j,elm:T})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:fd.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eB("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eB("Two-step verification reset for %(user_name)s").format({user_name:fd.vars.user_name}));return fd.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:fd.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eB("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eB("Two-step verification disabled."));return fd.hide()}})},show_sso_preview_email:function(i){return fd.show(eB("Email preview"),$(i))},show_sso_sample_email:function(i){return fd.show(eB("Sample email"),$(i))},show_user_message_modal:function(T,j,i){var fn;dv.fillVal(i,"user-message-email");fn=eB("Send email to '%(user_name)s'").format({user_name:T});$("user-message").value="";fd.show(fn,$("user-message-modal"),{user_name:T,user_id:j});return d6.focus.defer("user-message")},send_user_message:function(){var j,i;i=fd.vars.user_id;j=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:i,team_id:this.team_id,message:j},onSuccess:function(){var T;T=fd.vars.user_name;ah.success(eB("Message successfully sent to %(user_name)s.").format({user_name:T}));return fd.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bF(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bF(".pin_notice").hide()},hide_pin_banner_with_user_id:function(i,j){var T;T=function(fn){return bF(j).closest("span").removeClass("on").addClass("off")};if(i===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:T})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:i},onSuccess:T})}},get_pin_with_user_id:function(i,T,j){var fn;if(j==null){j=null}if(j===null){j=function(fp,fo){bF(fo).closest("span").find(".pin-value").text(fp.pin+" -");return bF(fo).closest("span").removeClass("off").addClass("on")}}fn=function(fp){var fo;fo=JSON.parse(fp.responseText);return j(fo,T)};if(i===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:fn})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:i},onSuccess:fn})}},send_team_message:function(j){var i;Event.stop(j);i=$F("team-message").strip();if(i){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:i},onSuccess:function(T){ah.success(eB("Message successfully sent to team."));return fd.hide()}})}},show_security_message_modal:function(){return new fc().show()},send_team_security_message:function(T){var j,i;Event.stop(T);i=$F("team-security-message").strip();j=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:j.serialize(true),onSuccess:function(fn){ah.success(eB("Message successfully sent."));return fd.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(i,j){this.used_licenses=i;return this.total_licenses=j},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(i,j){$("migration-url").value=j;fd.show(eB("Migration link for '%(email)s'").format({email:bU.em_snippet(i,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(j,i,T){bo.hide_all();bF("#end-session-modal .member-name").text(bF("#member-name").text());return fd.show(eB("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:j,user_id:i,elm:T})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:fd.vars.login_id,team_id:this.team_id,user_id:fd.vars.user_id},onSuccess:function(){fd.hide();dU.remove_closest_row(fd.vars.elm);return ah.success(eB("Web session closed."))}})},unlink_device:function(i,fn,fr,j,fs,T,fo){var fq,fp;bo.hide_all();fq=$("unlink-device-modal-"+T);fp=eB("Unlink %(device_name)s").format({device_name:fr});return fd.show(fp,fq,{app_id:fn,user_id:fs,elm:fo,device_id:i,display_name:fr})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:fd.vars.app_id,team_id:this.team_id,user_id:fd.vars.user_id,device_id:JSON.stringify(fd.vars.device_id)},subject_user:cM.get_viewer().work_user,onSuccess:function(){fd.hide();dU.remove_closest_row(fd.vars.elm);return ah.success(eB("%(device_name)s unlinked.").format({device_name:fd.vars.display_name}))}})},disable_app:function(j,T,i,fn){bo.hide_all();bF("#disable-app-modal .app-name").text(T);bF("#disable-app-modal .member-name").text(bF("#member-name").text());return fd.show(eB("Disable '%(app_name)s'?").format({app_name:T}),$("disable-app-modal"),{app_id:j,user_id:i,elm:fn})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fd.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:fd.vars.user_id},subject_user:cM.get_viewer().work_user,onSuccess:function(i){fd.hide();dU.remove_closest_row(fd.vars.elm);return ah.success(i.responseText)}})},remove_closest_row:function(fn){var T,j,i;T=bF(fn).closest(".team_admin_table_row");j=bF(T).closest(".team_admin_table");if(j.find(".team_admin_table_row").length===1){i=j.prev(".team_admin_table_title");if(!i.length){i=bF(".team_apps_table_panel")}i.remove();return j.remove()}else{return T.remove()}},submit_report_form:function(i){bF(i.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};aw=E.BetaEnrollConfirmationModal=(function(j){fe(i,j);function i(T){this.feature_name=T;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}i.prototype.on_confirm_button_click=function(T){bF("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return i})(d8);aB=E.BetaFeedbackModal=(function(j){fe(i,j);function i(T){this.feature_name=T;this.success=b3(this.success,this);i.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(fn){return function(fr){var fq,fp,fo;fr.preventDefault();fq=bF(fr.target);fp=fq.closest("form");fo={feature_name:fn.feature_name};return bT.ajax_submit(fp[0],false,fn.success,fn.error,fq[0],fo)}})(this)}i.prototype.success=function(T){ah.success(eB("Thank you for your feedback."));return this.$modal_window.hide()};i.prototype.error=function(T){if(T.status!==200){return ah.error(eB("Failed to submit feedback. Please try again."))}};return i})(d8);U=E.DemoSignupModal=(function(i){fe(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fq){var fy,fv,fr,T,ft,fo,fx,fw,fn,fu,fs,fp;fq.preventDefault();fs=$("demo-signup-form");fw=$("1210");fo=bF(fs).find("input[name='first_name']").val();bF(fw).find("input[name='FirstName']").attr("value",fo);fx=bF(fs).find("input[name='last_name']").val();bF(fw).find("input[name='LastName']").attr("value",fx);ft=bF(fs).find("input[name='email']").val();bF(fw).find("input[name='Email']").attr("value",ft);fu=bF(fs).find("input[name='phone_number']").val();bF(fw).find("input[name='Phone']").attr("value",fu);fy=bF(fs).find("input[name='company_name']").val();bF(fw).find("input[name='Company']").attr("value",fy);fr=bF(fs).find("select[name='company_size']");fv=fr.find("option:selected").val();bF(fw).find("input[name='Company_size__c']").attr("value",fv);T=$(this.$modal_window.find(".confirm-button")[0]);fp=(function(fz){return function(fA){fz.$modal_window.hide();return fw.submit()}})(this);fn=bT.collect_form_vars(fs,true);return bT.ajax_submit(fs,false,fp,false,T,fn,true)};j.prototype.on_show=function(T){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return cj.init()};return j})(d8);bJ=E.AccountTransferBaseModal=(function(j){fe(i,j);function i(T,fo,fn){this.file_action_selector=fo;this.transfer_choice_selector=fn;this._clearInput=b3(this._clearInput,this);this._markInputInvalid=b3(this._markInputInvalid,this);this._markInputValid=b3(this._markInputValid,this);this._tokenRemove=b3(this._tokenRemove,this);this._tokenAdd=b3(this._tokenAdd,this);this._selectChange=b3(this._selectChange,this);this._isTransferSelected=b3(this._isTransferSelected,this);this.checkAndApproveMemberRemoval=b3(this.checkAndApproveMemberRemoval,this);this.on_cancel_button_click=b3(this.on_cancel_button_click,this);this.execute_form=b3(this.execute_form,this);this.get_cancel_button=b3(this.get_cancel_button,this);this.get_confirm_button=b3(this.get_confirm_button,this);this.get_button_class=b3(this.get_button_class,this);this.set_modal_class=b3(this.set_modal_class,this);this.handleAjaxFailure=b3(this.handleAjaxFailure,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,T,this.file_action_selector,this.transfer_choice_selector)}i.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cM.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(T){return function(fn){return fn.excludeNonTeam().excludeNewStyleGroups().excludeByEmail(T.email?[T.email.toLowerCase()]:[])}})(this),exclude_emails:[this.email]});this.tokenAdd=bF.proxy(this._tokenAdd,this);this.tokenRemove=bF.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bF.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};i.prototype.handleAjaxFailure=function(T){if(T.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};i.prototype.set_modal_class=function(fp){var fn,T,fo;fn="suspending deleting approve_transfer_to_suspended";T=this.get_form();T.removeClass(fn);if(fp!=null){T.addClass(fp)}if((fo=bF(".suspend_option_content"))!=null){fo.removeClass("title_bubble limited")}if((this.limited!=null)&&this.limited){bF(".suspend_option_content").addClass("title_bubble limited");return bF(".suspend_option_content").attr("data-title","Limited members can not be suspended")}};i.prototype.get_button_class=function(){var T;T=this.get_form();if(T.hasClass("suspending")){return".confirm_deactivate_button"}else{if(T.hasClass("deleting")){return".confirm_delete_button"}else{if(T.hasClass("approve_transfer_to_suspended")){return".confirm_transfer_to_suspended_button"}}}};i.prototype.get_confirm_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .confirm-button"))}else{return $(this.$modal_window.find(".confirm-button"))}};i.prototype.get_cancel_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .cancel-button"))}else{return $(this.$modal_window.find(".cancel-button"))}};i.prototype.execute_form=function(){var T,fn;fn=this.get_form()[0];T=this.get_confirm_button();return bT.ajax_submit(fn,false,this.success_callback,this.handleAjaxFailure,T)};i.prototype.on_cancel_button_click=function(fn){var T;fn.preventDefault();T=this.get_form();if(T.hasClass("approve_transfer_to_suspended")){this.reset_button_click(this.$confirm_button,this.on_confirm_button_click);return this.reset_button_click(this.$cancel_button,this.on_cancel_button_click)}else{return i.__super__.on_cancel_button_click.apply(this,arguments)}};i.prototype.reset_button_click=function(T,fn){T.off("click");if(fn!=null){return T.on("click",fn)}};i.prototype.checkAndApproveMemberRemoval=function(fo){var T,fn;if(!bF("#deactivate_option").is(":checked")&&bF("#transfer_files_on").is(":checked")&&!this.invited){T=bF(".tokenized_autocompleter_container .token-display-text");fn=bF(".tokenized_autocompleter_container .token-suspended");if(T.length&&fn.length){this.set_modal_class("approve_transfer_to_suspended");this.$modal_window.find(".target_user_name").text(T.text());this.$confirm_button=this.get_confirm_button();this.reset_button_click(this.$confirm_button,(function(fp){return function(fq){return fp.execute_form()}})(this));this.$cancel_button=this.get_cancel_button();this.$cancel_button.on("click",fo);return}}return this.execute_form()};i.prototype._isTransferSelected=function(){return bF(this.transfer_choice_selector).prop("checked")};i.prototype._selectChange=function(T){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};i.prototype._tokenAdd=function(T){this.$collab_input.hide();if(T.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};i.prototype._tokenRemove=function(T){this.$collab_input.show();return this._clearInput()};i.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};i.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};i.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return i})(d8);fc=E.TwoFactorMessageModal=(function(j){fe(i,j);function i(){i.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}i.prototype.on_confirm_button_click=function(T){dU.send_team_security_message(T);return this.hide()};return i})(d8);bu=E.DfeUnsuspendUserModal=(function(i){fe(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);j.__super__.constructor.call(this,T)}j.prototype.before_show=function(){var T;j.__super__.before_show.call(this);T=eB("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(T);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};j.prototype.success_callback=function(fn){var T;if((T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){T.refresh_member_stats()}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb("unsuspended"):void 0};j.prototype.on_confirm_button_click=function(fo){var T,fn;fo.preventDefault();fn=this.$modal_window.find(".dfe-unsuspend-modal")[0];T=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fn,false,this.success_callback,false,T)};return j})(d8);ef=E.DfeRemoveOrDeactivateUserModal=(function(j){fe(i,j);function i(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);this.handle_change_action=b3(this.handle_change_action,this);this.switch_to_uninvite_mode=b3(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=b3(this.switch_to_deactivation_mode,this);this.show_removal_content=b3(this.show_removal_content,this);this.show_deactivation_content=b3(this.show_deactivation_content,this);i.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")};i.prototype.set_form_action_to_deactivate=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/suspend_user")};i.prototype.set_form_action_to_remove=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};i.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};i.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};i.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};i.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};i.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};i.prototype.handle_change_action=function(T){T.preventDefault();if(bF("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};i.prototype.on_show=function(T){var fn;i.__super__.on_show.call(this);bF("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){fn=eB("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{fn=eB("Suspend or delete %(user_name)s").format({user_name:this.user_name});if(this.limited){bF("#deactivate_option").prop("disabled",true);bF("#delete_option").attr("checked","checked");this.switch_to_removal_mode()}else{bF("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}}this.$modal_window.find(".db-modal-title-text").text(fn);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};i.prototype.success_callback=function(T){var fn;if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}fn="";if(this.invited){fn="uninvited"}else{if(bF("#deactivate_option").is(":checked")){fn="suspended"}else{fn="deleted"}}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fn):void 0};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return i})(bJ);e1=E.DfeRemoveUserModal=(function(i){fe(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);j.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}j.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-user-modal")};j.prototype.on_show=function(fn){var T,fo;j.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fo=eB("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fo=eB("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fo);if(this.num_api_apps){T=bd("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(T)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".transfer_files_option").remove();this.$modal_window.find(".remote_wipe_setting").remove();this.get_form().addClass("invited")}if(this.hide_transfer_setting){this.$modal_window.find(".transfer_files_option").remove()}if(this.hide_remote_wipe_setting){return this.$modal_window.find(".remote_wipe_setting").remove()}};j.prototype.success_callback=function(fp){var fq,fo,fn,T;T=JSON.parse(fp.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fo=window.active_team_member_table)!=null){fo.remove_user(this.user_id)}if((fn=window.removed_team_member_table)!=null){fn.add_users(T)}}fq="";if(this.invited){fq="uninvited"}else{fq="deleted"}dU.decrement_used_licenses();this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fq):void 0};j.prototype.switch_to_removal_mode=function(){return this.set_modal_class()};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return j})(bJ);eK=E.ManageFilesModal=(function(j){fe(i,j);function i(fn,T,fo){this.source_user_id=fn;this.source_user_name=T;this.options=fo;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_manage_files=b3(this.switch_to_manage_files,this);this.success_callback=b3(this.success_callback,this);i.__super__.constructor.call(this,this.options,"input[name=file_action]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".manage-files-modal")};i.prototype.on_show=function(){var T;i.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);T=eB("Manage %(team_member)s's files").format({team_member:this.source_user_name});return this.$modal_window.find(".db-modal-title-text").text(T)};i.prototype.success_callback=function(fn){var T;T=JSON.parse(fn.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}if(bF("#move-files").prop("checked")){ah.success(eB("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ah.success(eB("Permanently deleted files"))}return this.hide()};i.prototype.switch_to_manage_files=function(){return this.set_modal_class("manage-files-modal")};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_manage_files)};return i})(bJ);cs=E.show_manage_files_modal=function(i,j){var T;T=new eK(i,j,{element_id:"manage-files-modal",focus:".new-collab-input"});return T.show()};q=function(){var i;i=function(fn,T){var j,fo;bF(T).css("display","none");j=bF(T).closest("#user_generate_liveops_pin");fo=j.find(".user_generate_liveops_pin_value");fo.text(fn.pin);bF(T).addClass("liveops_pin_elem_invisible");return j.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dU.get_pin_with_user_id(null,this,i);return false};bF("#user_generate_liveops_pin_button").click(q);bh=function(){bF("#help_callus_title").hide();bF("#help_callus_details").show();return false};bF("#help_callus_trigger").click(bh);var bE;bE=E.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var b9;b9=E.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var a6;a6=E.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(j,T){var i;if(T==null){T=null}i=Object.clone(j);if(i.is_dir){i.ago="";i.ts=0}else{i.target_ns=false}i.sort_key=d6.decode_sort_key(i.sort_key);i.request_id=T!=null?T:null;return new cS(i)},filepreview_from_selected:function(fq,fp,fo,fn){var i,T,fr,j;if(fp==null){fp=false}if(fo==null){fo=false}if(fn==null){fn=Constants.BROWSE_UNKNOWN}if(fq.bytes<0||fq.preview_type==="download"){window.open(fq.href,"_blank");return}if(az.getGandalfRule("file-viewer-react")){T=this.getIndexOfFileInArray(ct.files,fq);e2.open(ct.files,T,ct.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewContext:aX.FileViewContextType.PRIVATE})}else{j=eE.get_url();fr=eE.deconstruct_url(j);i=j.indexOf("/s/")===0;n.show(fq,ct.active_user,{files:ct.files,file_view_mode:aX.FileViewModeType.BROWSE,should_focus_comment_input:fo},fn);if(!(fp||i||fr.qargs.preview===fq.filename)){n.set_preview_url()}}},profile_files:function(T){var fn,j,i,fo,fp;fo={files:0,folders:0,shared_folders:0,team_shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(j=0,i=T.length;j<i;j++){fn=T[j];if(fn.dir){fo.folders+=1}else{fo.files+=1}if(fn.is_sandbox()){fo.sandboxes+=1}if(fn.is_shared_folder()){fo.shared_folders+=1}if(fn.is_team_shared_folder()){fo.team_shared_folders+=1}if(fn.bytes===-1){fo.deleted+=1}if(fn.target_ns){fo.target_namespaces+=1}if(fn.fq_path.toLowerCase()==="/public"&&ct.public_folder_enabled){fo.public_folder=1}if(fn.in_root_coll){fo.in_root_coll+=1}if(fn.compressible){fo.compressible_count+=1}if(!((fp=ct.permanent_delete_is_disabled_by_ns_id)!=null?fp[fn.ns_id]:void 0)){fo.can_permanently_delete+=1}}return fo},profile_summary:function(j){var T,i;T=bd("%d file","%d files",j.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.files);i=bd("%d folder","%d folders",j.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.folders);if(j.files&&j.folders){return eB("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:T,y_folders:i})}else{if(j.files){return T}else{if(j.folders){return i}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fr,fp,fn,T,j,i,fq,fo;fr=bF("#browse");fn=fr.find("#browse-root-actions");T=fr.find("#browse-sort");fp=fr.find("#browse-header-status");fo=this.SPECIAL_MODES;for(j=0,i=fo.length;j<i;j++){fq=fo[j];fr.removeClass(fq);fn.removeClass(fq);T.removeClass(fq);fp.removeClass(fq)}cb.reset_fulltext_search(true);fr.removeClass("fulltext_search");fn.removeClass("fulltext_search");T.removeClass("fulltext_search");fp.removeClass("fulltext_search");bF("#fulltext-search-loading").hide();return bF("#fulltext-search-all-link").hide()},set_special_mode:function(fr){var T,fo,fs,i,fn,fq,fp,j;T=bF("#browse");fs=T.find("#browse-root-actions");i=T.find("#browse-sort");fo=T.find("#browse-header-status");cL(this.SPECIAL_MODES.indexOf(fr)!==-1,"unknown mode");j=this.SPECIAL_MODES;for(fn=0,fq=j.length;fn<fq;fn++){fp=j[fn];if(fp!==fr){T.removeClass(fp);fs.removeClass(fp);i.removeClass(fp);fo.removeClass(fp)}}T.addClass(fr);fs.addClass(fr);i.addClass(fr);fo.addClass(fr);if(fr===this.SEARCH_MODE){T.addClass("fulltext_search");fs.addClass("fulltext_search");i.addClass("fulltext_search");return fo.addClass("fulltext_search")}},get_mode:function(){var T,j,fo,fn,i;i=this.BROWSE_MODE;fn=this.SPECIAL_MODES;for(T=0,j=fn.length;T<j;T++){fo=fn[T];if(bF("#browse").hasClass(fo)){i=fo}}return i},load_visible_thumbs:function(){var fx,fz,fp,fu,fA,fB,fy,fo,ft,fr,fq,fv,fs,T,fn,fw;fo=this.get_files_in_view();fz=fo[1]-fo[0];fy=[Math.max(fo[0]-fz,0),fo[0]];fB=[Math.min(fo[1],ct.files.length),Math.min(fo[1]+fz,ct.files.length)];fx=[];fn=[fo,fB,fy];for(fr=0,fv=fn.length;fr<fv;fr++){fA=fn[fr];fu=fA[0],ft=fA[1];fw=ct.files.slice(fu,+ft+1||9000000000);for(fq=0,fs=fw.length;fq<fs;fq++){fp=fw[fq];if(fp.get_div()){fx.push(fp.get_div().down("img"))}}}T=function(i){if(!i.src.endsWith(cx.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bs.batch_load_thumbs(fx,this.THUMBS_BATCH_SIZE,T)},get_files_in_view:function(){var fs,fp,fu,fq,fr,fo,T,fv,ft,fn,fw;T=[0,ct.files.length-1];fn=C.viewport_dimensions().height;fw=C.scroll_offsets().top;fo=this._get_elm_height();if(!fo){return T}fs=bF("#browse-files");fq=parseInt(fs.css("padding-top"),10);if(!fs.length||isNaN(fq)){return T}if(bF("body").hasClass("absolutize")){fp=fs.offset().top+fq;fu=fp-fw;if(fu>0){fv=0;fr=fn-fu;ft=fr/fo}else{fv=Math.abs(fu/fo);ft=Math.abs(fn-fu)/fo}}else{fv=fw/fo;fr=fn-fq;ft=(fr+fw)/fo}fv=Math.max(Math.floor(fv),0);ft=Math.min(Math.floor(ft),ct.files.length-1);return[fv,ft]},_get_elm_height:function(){var j,i;if(ct.files.length>=3&&ct.files[1].get_div()){j=bF(ct.files[1].get_div());i=j.outerHeight()+parseInt(j.css("margin-bottom"))+parseInt(j.css("margin-top"));return i}else{return null}},append_ellipsis:function(i){return eB("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:i})},getIndexOfFileInArray:function(fq,fp){var fo,fn,T,j,i;i=-1;for(fn=T=0,j=fq.length;T<j;fn=++T){fo=fq[fn];if(fo.sjid===fp.sjid){i=fn}}return i}};var bq;bq=E.Sort=(function(){var fq,i,fn,fp,fo,T,j;fn=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){return fr*d6.sort_by_rank_or_key(ft,fu)}};fp=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){if(ft.bytes>fu.bytes){return fr}else{if(ft.bytes<fu.bytes){return -fr}else{return fr*bq.FILES_BY_NAME(ft,fu)}}}};fq=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){return fr*(ft.fq_path.toLowerCase()>fu.fq_path.toLowerCase()?1:-1)}};i=function(fs){var fr;fr=fs?1:-1;return function(fu,fv){var ft;ft=fu.ts===fv.ts?0:fu.ts>fv.ts?1:-1;return fr*ft}};T=function(fr){return function(fu){var ft,fs;fs=fr(fu);ft=fn(true);return function(fv,fw){if(fv.dir^fw.dir){return(fv.dir?1:0)-(fw.dir?1:0)}else{return fs(fv,fw)||ft(fv,fw)}}}};fo=function(fr){return function(fu){var fs,ft;if(!bq.FOLDERS_FIRST){return fr(fu)}ft=fr(fu);fs=fu?1:-1;return function(fw,fx){var fv;if(fw.dir^fx.dir){fv=(fw.dir?0:1)-(fx.dir?0:1);return fs*fv}else{return ft(fw,fx)}}}};j=function(fr){return function(fu){var fs,ft;ft=bq.FILES_BY_NAME(fu);fs=fu?1:-1;return function(fw,fx){var fv;if(fw.is_deleted^fx.is_deleted){return(fw.is_deleted?1:0)-(fx.is_deleted?1:0)}fv=0;if(fr){if(fw.get_category()!==fx.get_category()){fv=fw.get_category()<fx.get_category()?-1:1}else{if(fw.get_extension()!==fx.get_extension()){fv=fw.get_extension()<fx.get_extension()?-1:1}}}else{if(fw.get_extension()!==fx.get_extension()){fv=fw.get_extension()<fx.get_extension()?-1:1}else{if(fw.get_category()!==fx.get_category()){fv=fw.get_category()<fx.get_category()?-1:1}}}return(fs*fv)||ft(fw,fx)}}};return{FILES_BY_NAME:fo(fn),SHARED_WITH:fo(fn),FILES_BY_SIZE:T(fp),FILES_BY_LOCATION:T(fq),FILES_BY_KIND:T(j(true)),FILES_BY_EXTENSION:T(j(false)),FILES_BY_MODIFIED:T(i),FOLDERS_FIRST:!d6.is_mac(),ALL_BY_MODIFIED:i}})();var ds,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};ds=E.FlexColumn=(function(){var fs,fq,T,fr,fp,fn,fo,j;fs=[{label:"SHARED_WITH",func:bq.FILES_BY_NAME,display:eB("Shared With"),is_asc:true},{label:"FILES_BY_KIND",func:bq.FILES_BY_KIND,display:eB("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bq.FILES_BY_EXTENSION,display:eB("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bq.FILES_BY_SIZE,display:eB("Size"),is_asc:false}];fq={};T={};fp=[];fr=[];for(fo=0,j=fs.length;fo<j;fo++){fn=fs[fo];fp.push(fn.func);fq[fn.label]=fn.display;T[fn.label]=fn.is_asc;fr.push(fn.label)}return{SORT_FUNCTIONS:fp,DISPLAY:fq,IS_ASC:T,LABELS:fr,has_label:function(i){return cT.call(this.LABELS,i)>=0},has_sort:function(i){return cT.call(this.SORT_FUNCTIONS,i)>=0},next:function(ft){var i;i=ds.LABELS.indexOf(ft)+1;if(i===ds.LABELS.length){i=0}return fs[i]}}})();var cb;cb=E.FileSearch={MAX_RESULTS:100,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(i,j){this.firefly_enabled=i;return this.fulltext_search_enabled=j},get_state:function(){var i;i={};i.query_unnormalized=this.get_basic_query();i.query=i.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");i.last_fq_path=this.last_fq_path!=null?this.last_fq_path:"";return i},set_state:function(i){this.last_fq_path=i.last_fq_path!=null?i.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";ct.inside_dir=this.scoped_search;this.set_basic_query(i.query_unnormalized);return this.do_search(false,true)},state_changed:function(){var j,i;j=this.get_state();i=this.last_state;if(i===false){return !!j.query}return(j.query!==i.query)||(j.last_fq_path!==i.last_fq_path)},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(i){if(i===this.get_basic_query()){return}return this._get_browse_search_input().val(i)},set_title:function(){var i,j;i=this.get_state();j=eB("Search - Dropbox");if(i.query_unnormalized){j=i.query_unnormalized+" - "+j}return document.title=j},_set_scope_path_to_browse_location:function(){if(ct.inside_dir){return this.last_fq_path=ct.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(T,i){var fo,fp,fn,j;if(i==null){i=false}if(typeof ct.entered_search==="function"){ct.entered_search()}j=!i&&!ct.in_search_mode();if(j){this._set_scope_path_to_browse_location()}fn=this.get_state();fp=""===this.get_basic_query();if(fp){if(ct.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=fn;this._clear_on_reload=true;eY.deselect_all();ct.clear();a6.set_special_mode("search");this.scoped_search=this.last_fq_path!=="";if(!i){fo=null;eE.push_state("/search/"+ct.active_user.role,fn)}this.set_title();this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bF("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",T,0,this.MAX_RESULTS,false);return eJ("search")},search:function(i){if(i==null){i=false}if(i!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&i;if(!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var i;if(!this.end_of_results){i=this.search_pos;if(this.end_of_active_results){i=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,i,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},update_empty:function(){var i;i=eB("No results found");if(this.scoped_search){i=eB("No results found in '%(path)s'").format({path:aA.filename(this.last_fq_path)})}bF("#noresults-header").text(i);bF("#fulltext-search-all-link").hide();bF("#noresults-directions").toggle(!this.scoped_search);return bF("#noresults-search-all-link").toggle(this.scoped_search)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(i){eY.deselect_all();ct.clear();ct.reset_state();ct.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=i;return bF("#fulltext-search-all-link").hide()},exit_search:function(){var i;if(ct.in_search_mode()){i=[ct.inside_deleted_dir,ct.inside_deleted_sandbox,ct.inside_deleted_shared_folder];if(!bx.any(i)){ct.deleted_shown=false}}$("browse").removeClassName("pending-search");this.hide_empty();return a4.set_path_url(null,this.last_fq_path,ct.deleted_shown)},force_reload:function(){return this.search()},ask_server:function(j,fq,T,fr,fo){var fp,fu,fs,fn,ft,i;i=this.get_state();ft=null;fn=new Date();if(fo){ft=eD.DELETED}else{if(fq){ft=eD.COMPLETION}else{ft=eD.FULLTEXT}}fp={firefly:this.firefly_enabled,infinite_scroll:T>0?true:false,path_scoped:false,search_type:ft,query_string:i.query};ba.SearchClientActivityLogger.log("query_started",ct.active_user.id,fp);if(!T){bF("#web-search-results").html(eB("Searching..."))}bF("#browse").addClass("pending-search");fu={query:i.query};if(T){fu.start=T}if(fr){fu.max_results=fr}if(fo){fu.deleted=fo}if(this.scoped_search){fu.fq_path=this.last_fq_path}if(!fq){this.last_fulltext_query=i.query}if(fq){fu.filename_only=true}fs=false;return new Ajax.DBRequest(j,{no_watch:true,evalJSON:false,parameters:fu,log_timing:true,onSuccess:(function(fv){return function(fy){var fz,fw,fx,fB,fA;if(!ct.in_search_mode()){return}fB=fy.request.parameters.parent_request_id;fz=JSON.parse(fy.responseText);fA=fz.file_info.length;if(i.query===fv.last_fulltext_query&&fn>=fv.last_new_search_ts){fv.search_pos=fv.search_pos+fA;if(fv.end_of_active_results){fv.deleted_search_pos=fv.deleted_search_pos+fA}if(fA<fv.MAX_RESULTS){fv.end_of_results=true&&fv.end_of_active_results;fv.end_of_active_results=true;if(!fv.end_of_results){fs=true}else{bF("#fulltext-search-loading").hide()}}fv.update_results(fz,fs,fB)}if(fz.file_info.length>0){fw=fz.file_info[0]}else{fw=null}fp=ba.SearchClientActivityLogger.create_completion_log_dict(fp,fB,fy.request.start_time,i.query,i.query===((fx=fv.last_state)!=null?fx.query:void 0),fA,null,fw);return ba.SearchClientActivityLogger.log("query_completed",ct.active_user.id,fp)}})(this),onFailure:(function(fv){return function(fx){var fw;fp=ba.SearchClientActivityLogger.create_completion_log_dict(fp,fx.request.parameters.parent_request_id,fx.request.start_time,i.query,i.query===((fw=fv.last_state)!=null?fw.query:void 0),null,fx.status);return ba.SearchClientActivityLogger.log("query_failed",ct.active_user.id,fp)}})(this),cleanUp:(function(fv){return function(){if(fs){return fv.load_more_results()}else{return bF("#browse").removeClass("pending-search")}}})(this),subject_user:ct.active_user})},update_results:function(j,i,fn){var T;if(i==null){i=false}if(fn==null){fn=null}T=this.get_state();ct.update(j,fn);ct.set_selection_from_fq_paths_or_index(cb);if(!i){this._update_number_results(this.search_pos);if(ct.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(j){var i,T;if(j===0){i=""}else{if(this.end_of_results){i=this.fulltext_search_enabled?bd("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",j).format({num_results:j})}else{i=this.fulltext_search_enabled?bd("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",j).format({num_results:j})}}T=eB("Search")+" - "+i;ct.update_header_status(i);T=eB("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){T=eB("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:aA.filename(this.last_fq_path+"'")})}bF("#web-search-results").text(T);if(this.scoped_search){return bF("#fulltext-search-all-link").show()}},history_change_handler:function(i,fn){var fo,j,T;j=typeof this._get_browse_search_input().find("input").attr("value")==="string";T=j&&!this.is_loaded;if(fn){this.last_state=fn}if(!this.last_state){a4.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||T){this.set_state(this.last_state)}if(!n.shown()){key.setScope(ct.KEY_SCOPE)}if(eY.get_selected_files().length){fo=eY.get_selected_files()[0].get_div();ct.scrollToWithPadding(fo,fo.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bF("#browse-search-input")}};var eo;eo=E.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var T,i,j;j=this.advanced_dict;for(i in j){T=j[i];key(T.key,ct.KEY_SCOPE,T.onPress)}this.customize_chart();if(d6.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(fn){return function(fo){if(fo.charCode===63&&!C.focus_in_input()){return fn.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var fo,j,fn,T;fo=(d6.is_mac()?".key-windows":".key-macos");fn=0;j=void 0;T=[];while(true){j=$("keys-chart").down(fo,fn++);if(!j){break}T.push(j.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var i,j;i=$("keys-chart");i.style.position="fixed";j=$("browse-sort");if(ct.in_search_mode()){j=$("browse-header-wrapper")}else{if(j.getStyle("display")==="none"){j=$("browse-root-actions")}}bF(i).clonePosition(bF(j),{setHeight:false});i.style.top=j.cumulativeOffset()[1]+j.getHeight()+"px";i.setOpacity(0.9);return i.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:eB("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(j,T){var i;i=eY.get_selected_files();if(i.length){return i.first().edit()}}},"delete":{title:eB("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(fn,fo){var i,T,j;Event.stop(fn);if(ct.inside_read_only_shared_folder){ah.warning(eB("You don't have permission to delete files in this folder."))}j=eY.get_selected_files();if(j.length===1){i=j.first();if(i.is_deleted){return dD.show_purge(i.fq_path,i.dir)}else{return dD.show_delete(ct.active_user,i.fq_path,i.dir)}}else{if(j.length>1){T=a6.profile_files(j);if(T.deleted===j.length){return dD.show_bulk_purge(j)}else{if(T.deleted===0){return dD.show_bulk_delete(ct.active_user,j)}}}}}},help:{title:eB("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return eo.toggle_chart()}},close_help:{title:eB("Hide keyboard shorcuts"),key:"escape",onPress:function(){return eo.hide_chart()}},up_dir:{title:eB("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var i,j;ct.keyboard_nav=true;if(!ct.reloading){if(ct.inside_dir){if(!ct.containing_ns_path()&&ct.containing_ns_id()!==Constants.root_ns){j=Constants.root_ns;i=aA.normalize(aA.parent_dir(ct.containing_fq_path()))}else{j=ct.containing_ns_id();i=aA.normalize(aA.parent_dir(ct.containing_ns_path()))}if(ct.containing_ns_path()!==i||ct.containing_ns_id()!==j){ct.select_fq_paths=[ct.containing_fq_path()];return a4.set_path_url(j,i)}else{return eY.flicker_selected()}}else{return eY.flicker_selected()}}}},open_file:{title:eB("Open highlighted file"),key:"enter",onPress:function(){var i,j;j=eY.get_selected_files();if(j.length===1){i=j[0];ct.open_file(i,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:eB("Open highlighted folder"),key:"right",onPress:function(){var i,j;ct.keyboard_nav=true;j=eY.get_selected_files();if(j.length===1){i=j[0];if(i.dir){ct.select_index=0;ct.open_folder(i)}else{eY.flicker_selected()}}return false}},undo:{title:eB("Undo recent move/copy/rename/delete"),key:(key.main_modifier())+"+z",onPress:function(){X.perform_undo();return false}},search:{title:eB("Search"),key:"/",onPress:function(){bF(document).trigger("db:searchbar:focus");return false}}}};var af;af=E.BrowseSharedLink={store_shared_link_info:function(T,i,j){if(T.charAt(0)==="/"){T=T.substring(1)}this._shared_link_fq_dir=T;this._shared_link_file=j;return this._shared_link_url=i},shared_link_handler:function(i,j){if(af._shared_link_url==="/s/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fi")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));ct.open_preview(af._shared_link_file)}else{if(af._shared_link_url==="/sh/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fo")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));if(af._shared_link_file){ct.open_preview(af._shared_link_file)}}else{location.reload()}}return af.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return a4.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(ct.active_user.role===Constants.ROLE_WORK){bF("#work-nav-item").addClass("selected");return bF("#personal-nav-item").removeClass("selected")}else{bF("#personal-nav-item").addClass("selected");return bF("#work-nav-item").removeClass("selected")}}};var a4;a4=E.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(i){var j;j=eE.deconstruct_url().qargs;if(i in j){return !!j[i]}else{cL(i in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[i]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(i,T){var j;if(i!==ct.active_user.root_ns&&(!(i in ct.ns_id_to_mount_point))){i=ct.active_user.root_ns}if(i===ct.active_user.root_ns){return T}else{j=ct.ns_id_to_mount_point[i];return j+T}},_make_url:function(i,fp,fq){var fr,fo,j,fn,T;if(fq==null){fq={}}if(!i){i=ct.active_user.root_ns}cL(typeof i==="number","expected ns_id as a number");cL(typeof fp==="string","expected explicit ns_path string");fr=this.ns_to_fq_path(i,fp);fn=G({path:fk.get_browse_root(ct.active_user)+fr});j=eE.deconstruct_url().qargs;for(fo in fq){T=fq[fo];if(fo in this._DEFAULTS&&!!T!==this._DEFAULTS[fo]){j[fo]=T}}for(fo in j){if(!(fo in this._DEFAULTS)){delete j[fo]}}return eE.construct_url(String(fn),j)},set_path_url:function(i,fp,fn){var fo,T,j;if(!i){i=ct.active_user.root_ns}else{T=parseInt(i,10);i=!isNaN(T)?T:Constants.root_ns}fp=aA.normalize(fp);j=fn!=null?this._make_url(i,fp,{d:fn?1:0}):this._make_url(i,fp);fo=eE.deconstruct_url(j);return eE.push_state(fo.path,fo.qargs)},set_del_url:function(i){var T,fn,j;j=eE.deconstruct_url();T=j.path;fn=j.qargs;if(i){fn.d="1"}else{delete fn.d}return eE.push_state(T,fn)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(i,fn,j){var fo,fp,T;if(j==null){j=false}key.setScope(ct.KEY_SCOPE);fn=aA.normalize(fn);T=false;if(!this._first_load){T=(!ct.inside_dir)||(fn!==this._last_ns_dir)||(i!==this._last_ns_id)||ct.in_search_mode()}fo=j!==ct.deleted_shown;ct.deleted_shown=j;if(this._first_load||T||fo){ct.reload(i,fn,true)}this._first_load=false;this._last_ns_dir=fn;this._last_ns_id=i;if(eY.get_selected_files().length){fp=eY.get_selected_files()[0].get_div();if(fp){return ct.scrollToWithPadding(fp,fp.getHeight()*2)}}},history_change_handler:function(fp,fq){var fn,fo,T,i,j;i=fq.ns;j=fq.d==="1";this.load_browse_view(i,fp,j);if(fq.preview!=null){fo="/"+G.encode(fq.preview);if(!!fp){fo="/"+fp+fo}fn=ct.find_file(G.decode(fo));if(fn!=null){if(az.getGandalfRule("file-viewer-react")){T=a6.getIndexOfFileInArray(ct.files,fn);return e2.open(ct.files,T,ct.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewContext:aX.FileViewContextType.PRIVATE})}else{if(!(n.shown()&&n.file===fn)){return ct.open_preview(fn,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}}else{ba.UserActivityLogger.log("web","browse_preview_does_not_exist");return eE.replace_state(fk.get_browse_root(ct.active_user))}}else{if(!az.getGandalfRule("file-viewer-react")&&n.shown()){return n.hide()}else{if(az.getGandalfRule("file-viewer-react")&&e2.isShown()){return e2.close()}}}},parse_b2_hash:function(fo){var T,j,fn,i,fp;i=fo.split(":");if(i.length!==4){return false}fn=i[0];T=i[2]==="1";j=i[3];fp=!j||d6.isNumber(j);if(!fp){return false}j=parseInt(j,10)||Constants.root_ns;return{ns_id:j,ns_path:fn,deleted:T}}};var cS;cS=E.BrowseFile=Class.create({initialize:function(fn){var T,fo,j,i;T=aA.filename(fn.fq_path);this.allows_nesting=fn.allows_nesting;this.icon=fn.icon;this.filename=T;this.filename_highlights=(fo=fn.filename_highlights)!=null?fo:[];this.unresolved_comment_count=fn.unresolved_comment_count;this.unseen_comment_count=fn.unseen_comment_count;this.update_caption();this.ns_id=fn.ns_id;this.ns_path=fn.ns_path;this.fq_path=fn.fq_path;this.mount_point=fn.mount_point;this.hash=fn.hash;this.href=fn.href;this.size=fn.size!=="None"?fn.size:"";this.bytes=fn.bytes;this.is_deleted=this.bytes===-1;this.ago=fn.ago;this.ts=fn.ts;this.dir=fn.is_dir?1:0;this.target_ns=fn.target_ns;this.sort_rank=fn.sort_rank;this.sort_key=fn.sort_key||[""];this.sjid=fn.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=fn.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=fn.large_thumbnail_url_tmpl;this.type=fn.type;this.preview_type=fn.preview_type;if(fn.last_modified_fname){this.last_modified_fname=bU.em_snippet(fn.last_modified_fname,cV)}this.htmlified_link=fn.htmlified_link;this.linkfile_link=fn.linkfile_link;this.direct_blockserver_link=fn.direct_blockserver_link;this.doc_preview_status=fn.doc_preview_status;this.in_root_coll=fn.in_root_coll;this.compressible=fn.compressible;this.user_id=fn.user_id;this.sf_perm_role=fn.sf_perm_role;this.fulltext_search=fn.fulltext_search;this.read_only=fn.read_only?true:false;this.is_read_only_mount=fn.is_read_only_mount?true:false;this.request_id=(j=fn.request_id)!=null?j:null;return this.match_type=(i=fn.match_type)!=null?i:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cS._file_index)){ct.add_file(this);return cS._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b9.SHARED_FOLDER||this.type===b9.TEAM_SHARED_FOLDER},is_team_shared_folder:function(){return this.type===b9.TEAM_SHARED_FOLDER},could_be_shared_folder:function(){var T,fn,i,j;fn=ct.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");j=ct.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";i=this.target_ns;T=this.ns_id!==Constants.root_ns;return this.type===b9.FOLDER&&!i&&!fn&&!j&&!this.is_sandbox()&&(!T||(ct.golden_gate_aware&&this.allows_nesting&&!ct.inside_read_only_shared_folder))},is_shared_single_file:function(){var i;i=this.ns_id!==Constants.root_ns;return this.type===b9.FILE&&i},could_be_shared_single_file:function(){var j,T,i;T=ct.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");i=ct.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";j=this.ns_id!==Constants.root_ns;return this.type===b9.FILE&&!(j||T||i)},is_sandbox:function(){return this.type===b9.SANDBOX},video_transcode_url:function(){return bt.video_transcode_url(this.fq_path,this.hash,ct.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fo,fq,T,fn,fp,fr){var fs,i,j;i=this.fq_path;ct.pre_action_selection=[i];fs=ct.find_file(fo);if(fs){ct.remove_file(fs)}this.filename=aA.filename(fo);this.update_caption();this.fq_path=fo;this.ns_path=fq;this.htmlified_link=fr;this.hash=T;this.sort_key=fn;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){j=this.href.split("/");j[j.length-1]=d6.urlquote(this.filename)+("?w="+T);this.href=j.join("/");this.icon=fp}else{this.href="/home"+d6.urlquote(fo);if(this.target_ns){ct.ns_id_to_mount_point[this.target_ns]=fo}}if(ct.in_search_mode()){this.filename_highlights=[]}cS._file_index[this.to_key()]=this;ct.update_file_pos(this);return bF(document).trigger(aH.RENAME,{old_fq_path:i,file:this})},edit:function(){var T,i,fn,j,fo;this.editing=true;ct.selectable();fo=(function(fp){return function(fx){var fr,fq,fu,fz,fw,ft,fA,fy,fv,fs;fs=fx.responseText.evalJSON(true);cL(fs.new_browse_files.length===1,"No new file data returned.");fu=fs.new_browse_files.first();fz=fu.fq_path;fw=fu.hash;fv=d6.decode_sort_key(fu.sort_key);fA=fu.icon;fy=fu.ns_path;ft=fu.htmlified_link;fr=fs.changesets;fq=eB("Rename complete.");X.notifyWithUndo(fq,fr,dD.do_rollback);fp.rename(fz,fy,fw,fv,fA,ft);eY.set_selected_files([fp]);fp.get_div().smoothScrollIntoView();a6.load_visible_thumbs();return ct.fire_visible_change_callbacks()}})(this);i=G({path:"/cmd/rename"+this.fq_path}).updateQuery(a9.UID_PARAM_NAME,ct.active_user).toString();fn=ct.in_search_mode()?".filename-col":".filename-col a";T=new Ajax.InPlaceEditor(this.get_div().down(fn),i,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(fp){return function(){return fp.editing=false}})(this),onFailure:function(){},savingText:eB("Saving..."),ajaxOptions:{job:true,subject_user:ct.active_user,html_in_error_msg:true,progress_text:eB("Renaming..."),method:"POST",onCreate:ah.clear,onSuccess:fo,onUninitialized:ct.unselectable},callback:(function(fp){return function(fq,fr){return{to_path:fr||"",folder:(fp.dir?"yes":"")}}})(this)});T.enterEditMode();j=this.get_div().down(".editor_field");if("selectionEnd" in j&&this.filename.lastIndexOf(".")>-1){return j.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return this.ns_id+"_"+this.sjid},get_category:function(){var j,i;if(this.dir){if(ct.inside_dir&&ct.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&ct.public_folder_enabled){j="PUBLIC_FOLDER"}}if(j==null){if(this.type===b9.FOLDER){j="FOLDER"}else{if(this.type===b9.PACKAGE){j="FOLDER"}else{if(this.type===b9.TEAM_SHARED_FOLDER){j="TEAM_SHARED_FOLDER"}else{if(this.type===b9.SHARED_FOLDER){j="SHARED_FOLDER"}else{if(this.type===b9.SANDBOX){j="SANDBOX"}else{if(this.target_ns){j="SHARED_FOLDER"}else{j="FOLDER"}}}}}}}}if(j==null){j=cS.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}i=this.is_deleted?cS.CATEGORY_TO_DELETED_TRANSLATION[j]:cS.CATEGORY_TO_TRANSLATION[j];cL(i,"CATEGORY MISSING FOR "+j);return i},get_icon_alt:function(){if(this.dir){if(this.is_shared_folder()){if(this.is_team_shared_folder()){if(this.is_read_only_mount){return eB("Read-only team folder")}else{return eB("Team folder")}}else{if(this.is_read_only_mount){return eB("Read-only shared folder")}else{return eB("Shared folder")}}}else{if(this.is_read_only_mount){return eB("Read-only folder")}else{return eB("Folder")}}}else{return""}},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return aA.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&ct.is_shmodelable_path(this.fq_path)},update_caption:function(){var i;i=ct.inside_dir?dp:cm;if(this.unresolved_comment_count>0){i-=aL}return this.caption=bU.em_snippet(this.filename,i)}});cS._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cS.EXTENSION_TO_CATEGORY={};cS.CATEGORY_TO_TRANSLATION={FILE:eB("file"),FOLDER:eB("folder"),SHARED_FOLDER:eB("shared folder"),TEAM_SHARED_FOLDER:eB("team folder"),PUBLIC_FOLDER:eB("folder"),IMAGE:eB("image"),VIDEO:eB("video"),AUDIO:eB("audio"),DOCUMENT:eB("document"),COMPRESSED_FILE:eB("archive"),CODE:eB("code"),DISK_IMAGE:eB("disk image"),EXECUTABLE:eB("executable"),SHORTCUT:eB("shortcut"),LINK:eB("link"),FONT:eB("font"),SANDBOX:eB("app folder")};cS.CATEGORY_TO_DELETED_TRANSLATION={FILE:eB("deleted file"),FOLDER:eB("deleted folder"),SHARED_FOLDER:eB("deleted shared folder"),TEAM_SHARED_FOLDER:eB("deleted team folder"),PUBLIC_FOLDER:eB("deleted folder"),IMAGE:eB("deleted image"),VIDEO:eB("deleted video"),AUDIO:eB("deleted audio"),DOCUMENT:eB("deleted document"),COMPRESSED_FILE:eB("deleted archive"),CODE:eB("deleted code"),DISK_IMAGE:eB("deleted disk image"),EXECUTABLE:eB("deleted executable"),SHORTCUT:eB("deleted shortcut"),LINK:eB("deleted link"),FONT:eB("deleted font"),SANDBOX:eB("deleted app folder")};(function(){var fn,fo,j,T,i;T=cS._CATEGORIES;i=[];for(fn in T){j=T[fn];i.push((function(){var fs,fr,fp,fq;fp=j.trim().split(" ");fq=[];for(fs=0,fr=fp.length;fs<fr;fs++){fo=fp[fs];fq.push(cS.EXTENSION_TO_CATEGORY[fo]=fn)}return fq})())}return i})();cS._file_index={};cS.from_key=function(i){return cS._file_index[i]};cS.from_elem=function(j){var i;if(!j){return}i=j.readAttribute("data-identity");if(i){return cS.from_key(i)}else{return cS.from_elem(j.up("[data-identity]"))}};var a,eI,aj,fa,bN,dG,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};a=INLINE_JS.BrowseActions=E.BrowseActions=Class.create({initialize:function(i){return this._set_files(i)},firefly_logging_helper:function(i){if(ct.in_search_mode()&&i){this._firefly_log_values.action_type=i;return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var i;i=this.get_files();if(i.length<2){return this._get_actions_single(i.first())}else{return this._get_actions_multi(i)}},get_files:function(){return this._files},get_action_by_name:function(i){return this.evaluate_action(a.option_dict[i],i)},evaluate_action:function(T,j){var fn,fo,i;fn=(function(fp){return function(fr,fq){if((fq!=null)&&(fr==null)){return fq}if(bF.isFunction(fr)){return fr.call(fp)}else{if(fr!=null){return fr}else{return fq}}}})(this);i={icon_href:T.icon_href,target:T.target,click_handler:T.click_handler,type:T.type,name:j||T.name,is_dropdown:!!T.is_dropdown,icon:fn(T.icon),text:fn(T.text),detail_text:fn(T.detail_text),href:fn(T.href,""),kind:fn(T.kind,"icon"),button_label:fn(T.button_label,T.text)};if(bF.isFunction(T.subactions)){i.subactions=T.subactions.call(this)}else{if(bF.isArray(T.subactions)){i.subactions=(function(){var fq,fp,fs,fr;fs=T.subactions;fr=[];for(fq=0,fp=fs.length;fq<fp;fq++){fo=fs[fq];fr.push(this.get_action_by_name(fo))}return fr}).call(this)}else{if(T.subactions){cL(0,"subactions must be a function or an array of actions")}}}return i},_set_files:function(j){var i;this._files=$A(j);this._log_extras={};if(this.get_files().length>0){i=j.first();this._log_extras={path:i.fq_path,ns_id:i.ns_id};return this._firefly_log_values={file_nsid:i.ns_id,file_sjid:i.sjid,firefly:cb.firefly_enabled,match_type:i.match_type,position:i.sort_rank,request_id:i.request_id,viewport:"full-view"}}},_get_actions_single:function(fE){var fq,ft,fu,fz,T,fs,fn,fF,fr,fy,fo,fp,fA,fB,fC,i,fx,fv,fD,fw;ft=[];if(!fE){return[]}fz=ct.public_folder_enabled&&fE.fq_path.toLowerCase().startsWith("/public/");fy=ct.public_folder_enabled&&fE.fq_path.toLowerCase()==="/public";fF=fE.target_ns;fu=fE.ns_id!==Constants.root_ns;fp=fE.type===b9.SHARED_FOLDER;fo=fE.type===b9.SANDBOX;fr=fE.type===b9.PACKAGE;fn=fE.in_root_coll;fs=fE.compressible;if(fE.is_deleted){ft=ft.concat(["restore"]);if(!((i=ct.permanent_delete_is_disabled_by_ns_id)!=null?i[fE.ns_id]:void 0)){ft.push("purge")}}else{fw=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((fx=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fx.is_cached_and_locally_available(fE.ns_id,fE.ns_path):void 0);fC=fw?"open":"download";if(fE.dir){if(fo){ft.push("app_info")}else{if(ct.simple_sharing_enabled){ft.push("share_folder_and_token")}else{if(fp){ft.push("sharing_options")}else{if(!(fu||fF||fz||fy)){ft.push("share")}}}}if(fE.is_shmodelable()&&!ct.simple_sharing_enabled){ft.push("token_share")}ft.push(fC);if(!fy){ft=ft.concat(["delete","rename","move"]);if(!(fr||fF)){ft.push("copy")}}if(ct.can_use_photos_features){if(ct.can_use_photos_features){ft.push("album_from_folder")}}}else{if(fz||ct.public_app_token){ft.push("copy_url")}else{if(ct.simple_sharing_react_member_list_enabled){ft.push("share_folder_and_token")}else{if(fE.is_shmodelable()){ft.push("token_share")}}}ft.push(fC);if(ct.can_show_preview(fE)&&ct.browser_supports_comments){ft.push("comment")}ft=ft.concat(["delete","rename","move","copy","revisions"]);if(fn&&ct.can_use_photos_features){if(ct.photos_experience==="carousel"){ft.push("view_in_carousel")}else{ft.push("view_in_photos")}}if(fs){ft.push("compress")}}if(!ct.simple_sharing_enabled){fD=false;fv=["sharing_options","share","token_share"];for(fA=0,fB=fv.length;fA<fB;fA++){fq=fv[fA];T=ft.indexOf(fq);if(T>-1){ft.splice(T,1);fD=true}}if(fE.is_shared_folder()||fE.could_be_shared_folder()){ft.unshift("single_entry_share_dropdown_variant_menu")}else{ft.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return ft},_get_actions_multi:function(fn){var i,j,T;if(Constants.send_a_copy_enabled){i=["send_copy","download"]}else{i=["download"]}i=i.concat(["delete","move","copy","restore","purge"]);if(ct.photos_experience==="carousel"){i.push("view_in_carousel")}else{i.push("view_in_photos")}j=a6.profile_files(fn);if(j.deleted>0||j.public_folder>0){i.removeItem("move");i.removeItem("copy");i.removeItem("delete")}if(j.shared_folders>0){i.removeItem("copy")}if(j.deleted>0){i.removeItem("send_copy");i.removeItem("delete");i.removeItem("download")}if(!ct.inside_dir){i.removeItem("download")}if(!(j.deleted===fn.length&&(j.shared_folders===0||((j.shared_folders===(T=fn.length)&&T===1))))){i.removeItem("restore")}if(!(j.deleted===fn.length&&j.can_permanently_delete===fn.length)){i.removeItem("purge")}if(j.in_root_coll!==fn.length||!ct.can_use_photos_features){i.removeItem("view_in_photos");i.removeItem("view_in_carousel")}return i},_show_appropriate_sharing_modals:function(j,i){var T;if((ct.simple_sharing_enabled&&j.dir)||ct.simple_sharing_react_member_list_enabled){if(d4.get_for_user(ct.active_user).verified_or_show()){eG.createAndShowInbandModalFromBrowseFile(ct.active_user,j)}return}if(j.is_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,ct.active_user)}else{if(j.could_be_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,ct.active_user)}else{ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cL(T,"token_share: expected non-root fq_path");return dx.shmodel(T,i+"_token_share")}}},get_disabled_action_names:function(){var T,fo,fn,i,fp;T=false;fp=this.get_files();for(fn=0,i=fp.length;fn<i;fn++){fo=fp[fn];T=true;if(!fo.read_only){T=false;break}}if(ct.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(i){if(ct.inside_read_only_shared_folder){if(i==="move"){return ah.warning(eB("You don't have permission to move files in this folder."))}else{if(i==="rename"){return ah.warning(eB("You don't have permission to rename files in this folder."))}else{if(i==="delete"){return ah.warning(eB("You don't have permission to delete files in this folder."))}else{if(i==="restore"){return ah.warning(eB("You don't have permission to restore files in this folder."))}else{if(i==="purge"){return ah.warning(eB("You don't have permission to permanently delete files in this folder."))}else{if(i==="upload"){return ah.warning(eB("You don't have permission to upload files into this folder."))}else{if(i==="new_folder"){return ah.warning(eB("You don't have permission to create a new folder in this folder."))}else{if(i==="compress"){return ah.warning(eB("You don't have permision to create a compressed file in this folder."))}else{return ah.warning(eB("You only have permission to view this folder."))}}}}}}}}}else{return ah.warning(eB("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(j){var i,T;fd.show(a6.append_ellipsis(eB("Copy public link")),dv.fromElm("copy-public-url"),{wit_group:"copy_public_link"});fd.onHide=function(){$("flash_copy_container").remove();delete fd.onHide;return fd.hide()};i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eB("Link copied to clipboard!"));return fd.hide()});i.css({zIndex:1001});T=$("modal-content").down("#public_url");cL(T,"Text element not found for copy pulic link");T.setValue(j);return T.select()},shortenPublicLink:function(){var i;d6.shorten_url($F("public_url"),a.updatePublicLink);i=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(i)},updatePublicLink:function(j){var i;$("public_url").setValue(j);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eB("Link copied to clipboard!"));return fd.hide()});return i.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:eB("New folder"),click_handler:function(i){return ct.new_folder()}},global_restore:{icon:"restore",text:function(){cL(ct.inside_deleted_dir,"Global restore from not a deleted dir");if(ct.inside_deleted_shared_folder){return a6.append_ellipsis(eB("Rejoin shared folder"))}else{if(ct.inside_deleted_sandbox){return eB("Restore app folder")}else{return eB("Restore folder")}}},click_handler:function(){var fn,fo,j,i,T;fn=ct.containing_fq_path();j=fn.toLowerCase();if(ct.inside_deleted_sandbox){cL(ct.old_path_to_ns_id[j],"Deleted sandbox missing nsid");return bi.restore_sandbox(ct.active_user,fn,ct.old_path_to_ns_id[j])}else{if(ct.inside_deleted_shared_folder){cL(ct.old_path_to_ns_id[j],"Deleted shared folder missing nsid");return s.show_rejoin_modal(ct.active_user,fn,ct.old_path_to_ns_id[j])}else{fo=G.parse(location.href).setFragment("").toString();i={prev:fo};i[a9.UID_PARAM_NAME]=ct.active_user;T=G({path:"/restore"+fn}).updateQuery(i);return window.location.href=String(T)}}}},restore:{icon:"restore",text:function(){var j,i;j=this.get_files();i=a6.profile_files(j);if(i.shared_folders===j.length){return a6.append_ellipsis(bd("Rejoin shared folder","Rejoin shared folders",j.length,{comment:"BUTTON"}))}else{return a6.append_ellipsis(eB("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var T,fq,j,fr,fp,i,fo,fn;fq=this.get_files();if(fq.length===0){}else{if(fq.length===1){T=fq.first();if(!T.is_deleted){return}fr=T.fq_path;j=fr.toLowerCase();if(T.type===b9.SANDBOX){cL(ct.old_path_to_ns_id[j],"Restore missing ns");bi.restore_sandbox(ct.active_user,fr,ct.old_path_to_ns_id[j])}else{if((fo=T.type)===b9.SHARED_FOLDER||fo===b9.TEAM_SHARED_FOLDER){cL(ct.old_path_to_ns_id[j],"Rejoin missing ns");s.show_rejoin_modal(ct.active_user,fr,ct.old_path_to_ns_id[j])}else{if(T.dir){fp=G.parse(location.href).updateQuery({select:T.filename});i={prev:String(fp)};i[a9.UID_PARAM_NAME]=ct.active_user;fn=G({path:"/restore"+T.fq_path}).updateQuery(i);window.location=String(fn)}else{dD.show_undelete(T)}}}}else{return dD.show_bulk_restore(fq,ct.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(ct.inside_shared_folder){return a6.append_ellipsis(eB("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(ct.containing_fq_path()===""){return a6.append_ellipsis(eB("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a6.append_ellipsis(eB("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(T){var j,i;T.preventDefault();if(ct.containing_fq_path()===""){return s.start_wizard_for_user(ct.active_user)}else{if(ct.simple_sharing_enabled){if(d4.get_for_user(ct.active_user).verified_or_show()){j=ct.inside_shared_folder&&!ct.containing_ns_path();i=j?ct.containing_ns_id():void 0;return eG.createAndShowInbandModal(ct.active_user,ct.containing_fq_path(),true,i,j,!ct.inside_shared_folder,ct.containing_sf_perm_role())}}else{if(ct.inside_shared_folder){return s.show_shared_folder_options_modal(ct.containing_mount_point(),ct.active_user)}else{return s.show_share_existing_modal(ct.containing_fq_path(),ct.active_user)}}}}},sharing_options:{icon:"rainbow_16",text:a6.append_ellipsis(eB("Shared folder options",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,ct.active_user)}},share:{icon:"rainbow_16",text:a6.append_ellipsis(eB("Invite to folder",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,ct.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a6.append_ellipsis(eB("Share",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();return this._show_appropriate_sharing_modals(j,i)}},revisions:{icon:"previous_versions",click_handler:function(){return window.location.href=dD.build_revisions_uri(this.get_files().first().fq_path,ct.active_user)},text:eB("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a6.append_ellipsis(eB("Share link",{comment:"BUTTON"})),click_handler:function(fn,i){var j,T;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cL(T,"token_share: expected non-root fq_path");return dx.shmodel(T,i+"_token_share")}},global_token_share:{icon:"s_link",text:a6.append_ellipsis(eB("Share link",{comment:"BUTTON"})),click_handler:function(j,i){ba.ShmodelUILogger.log("via-global-toolbar");return dx.shmodel(ct.containing_fq_path(),i+"_global_token_share")}},copy_url:{icon:"world_link",text:a6.append_ellipsis(eB("Copy public link",{comment:"BUTTON"})),click_handler:function(T){var j,i;j=this.get_files().first();if(ct.public_app_token){i="/spa/"+ct.public_app_token+j.ns_path}else{i="/u/"+ct.active_user.id+j.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new G({scheme:"https",authority:Constants.PUBSERVER,path:i})))}},download:{icon:"download",text:function(){return eB("Download",{comment:"BUTTON"})},click_handler:function(){var fo,fn,i,fq,fs,fr,fp,T,j;i=this.get_files();if(i.length===1&&!i[0].dir){fn=i.first();T=[Constants.protocol,Constants.BLOCK_CLUSTER,fn.fq_path,fn.hash],fr=T[0],fo=T[1],fs=T[2],fq=T[3];fp={w:fq,dl:1};j=G({scheme:fr,authority:fo,path:"/get"+fs,query:fp});return window.location=String(j.updateQuery(a9.UID_PARAM_NAME,ct.active_user))}else{return dD.do_bulk_download(i)}}},view:{href:function(){var fp,i,fn,T,fo,j;i=this.get_files().first();j=[Constants.protocol,Constants.BLOCK_CLUSTER,d6.urlquote(i.fq_path),i.hash],fo=j[0],fp=j[1],T=j[2],fn=j[3];return fo+"://"+fp+"/get"+T+"?w="+fn},icon:"page_white_magnify",text:eB("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return s.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:eB("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(i){return ct.toggle_deleted()},icon:"trash-can",text:eB("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(i){return ct.toggle_deleted()},icon:"trash-can-open",text:eB("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a6.append_ellipsis(eB("Copy",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_copy(i.fq_path,i.dir)}else{if(j.length>1){return dD.show_copy_bulk(j)}}}},move:{icon:"move_16",text:a6.append_ellipsis(eB("Move",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_move(i.fq_path,i.dir)}else{if(j.length>1){return dD.show_move_bulk(j)}}}},rename:{icon:"rename",text:eB("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a6.append_ellipsis(eB("Delete",{comment:"BUTTON"})),click_handler:function(ft){var fq,fp,T,fs,fr,fo,fu,fn;T=this.get_files();fu=T.length;if(fu>=1){fo=T[0].mount_point;if(fo){for(fs=fr=1,fn=fu;1<=fn?fr<fn:fr>fn;fs=1<=fn?++fr:--fr){if(T[fs].mount_point!==fo){fo="";break}}}if(fo){fq=aA.filename(fo)}else{fq=null}if(fu>1){return dD.show_bulk_delete(ct.active_user,T,fq)}else{if(fu===1){fp=T[0];return dD.show_delete(ct.active_user,fp.fq_path,fp.dir,void 0,fq,fp.is_shared_folder())}}}}},global_purge:{icon:"cancel",text:a6.append_ellipsis(eB("Permanently delete folder")),click_handler:function(){return dD.show_purge(ct.containing_fq_path(),true)}},purge:{icon:"cancel",text:a6.append_ellipsis(eB("Permanently delete",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dD.show_purge(i.fq_path,i.dir)}else{return dD.show_bulk_purge(j)}}},upload:{icon:"upload_16",text:a6.append_ellipsis(eB("Upload")),click_handler:function(i){return dD.show_upload()}},app_info:{icon:"application_double",text:a6.append_ellipsis(eB("Application info")),click_handler:function(i){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:eB("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:eB("More actions"),click_handler:function(){bN.show_secondary();return document.body.observe("click",bN.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return eB("View in Photos")},click_handler:function(){var i;i=this.get_files();return dD.do_bulk_photo_view(i,ct.photos_experience)}},compress:{icon:"s_photo",text:function(){return eB("Compress (experimental)")},click_handler:function(){var i;i=this.get_files();return dD.show_compress_bulk(ct.active_user,i)}},view_in_carousel:{icon:"s_carousel",text:function(){return eB("View in Timeline")},click_handler:function(){var i;i=this.get_files();return dD.do_bulk_photo_view(i,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return eB("Create album")},click_handler:function(){var j,i;j=this.get_files();i=j.first();return dD.create_album_from_folder(i.fq_path,i.filename)}},open:{icon:"open",text:function(){return eB("Open")},click_handler:function(){var i;i=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(i.ns_id,i.ns_path,i.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(j){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return eB("Comment",{comment:"BUTTON"})},click_handler:function(i){var j;j=this.get_files().first();return ct.open_preview(j,i,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a6.append_ellipsis(eB("Share")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("single_entry_share_click",i,j);return dx.shmodel(j.fq_path,i)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a6.append_ellipsis(eB("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(T,i){var j;j=this.get_files().first();return ba.ShmodelUILogger.log_with_target_file("single_entry_share_hover",i,j)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a6.append_ellipsis(eB("Invite people to collaborate")),click_handler:function(fp,i){var T,fn,fo,j;T=this.get_files().first();if(T.is_shared_folder()){if(d4.get_for_user(ct.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,T);fn=new dg(ct.active_user,T.fq_path);return fn.show()}}else{j=ct.verify_email_after_share_experiment_variant;fo=j&&j==="VERIFY_LAST";if(fo){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(j){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fo||d4.get_for_user(ct.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,T);fn=new cp(ct.active_user,{folder_name:T.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+ct.active_user.id,must_check_verified:fo});return fn.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a6.append_ellipsis(eB("Send link")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);return dx.shmodel(j.fq_path,i)}}}});aj=E.BrowseActionsContext=Class.create(a,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bF("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bF("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bF("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bF("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(fn,j){var T,i;T=j.readAttribute("data-value");if(cT.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}ba.TimeToFirstActionLogger.log(ct.active_user.id,T);this.firefly_logging_helper(T);i=a.option_dict[T];ba.BrowseActionsContextMenuLogger.log(this.get_files(),T);if(!i.is_dropdown||j.hasAttribute("submenu-index")){bn.hide()}fn.preventDefault();i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,fn,"browse_actions_context");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_options",ct.active_user,this._log_extra,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_share_existing",ct.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bF("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(i){return bF(i).removeClass("hover")},_enter:function(fn){var T,i,j;T=bF(fn.currentTarget).data("value");cL(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);return(j=i.hover_handler)!=null?j.call(this,fn,"browse_actions_context"):void 0},_over:function(i){if(bF(i.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bF(i.currentTarget).addClass("hover")}},_out:function(i){if(bF(i.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(j){return function(){return j._reset_submenu(i.currentTarget)}})(this),300)}}});eI=E.BrowseActionsBasic=Class.create(a,{initialize:function($super){var i;i=eY.get_selected_files();$super(i);this._render();return this._listen()},_listen:function(){var i;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eY.UPDATED_EVT,this.bound_update);document.observe(bn.SHOW_EVT,this.bound_disable);document.observe(bn.HIDE_EVT,this.bound_enable);i=$("browse-root-actions");i.stopObserving("click");return i.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eY.UPDATED_EVT,this.bound_update);document.stopObserving(bn.SHOW_EVT,this.bound_disable);document.stopObserving(bn.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eY.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(T){var j,i;i="#browse-root-actions #"+T+"_action_button";j=bF(i);j.addClass("disabled");return j.click((function(fn){return function(fo){fn.show_disabled_action_warning(T);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fN,fF,fI,fv,fM,fO,fP,fE,fH,fy,i,fp,fq,ft,fr,fJ,fG,fC,fK,fu,fs,fL,fo,fQ,fB,T,fz,fx,fw,fA,fD,fn;fp=this.get_files();fI=this.get_action_names();if(!ct.simple_sharing_enabled){fw=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fJ=0,fK=fw.length;fJ<fK;fJ++){fF=fw[fJ];fr=fI.indexOf(fF);if(fr>-1){fI.splice(fr,1);break}}}fN=13.5;fH="";fq="";if(fp.length===1){fH=bU.em_snippet(fp[0].filename,fN);if(!fp[0].dir&&fp[0].bytes>=0){fq=fp[0].size}}else{if(1<fp.length){T=a6.profile_files(fp);fL=[];if(T.files){fo=bd("%d file","%d files",T.files).format(T.files);fL.push(fo)}if(T.folders){fo=bd("%d folder","%d folders",T.folders).format(T.folders);fL.push(fo)}fH=d6.nice_list(fL)}}fO=$("browse-root-actions");fM=fO.getLayout().get("width");ft=fO.getStyle("font-size");cL(ft.endsWith("px"),"Invalid font size "+ft);ft=parseInt(ft,10);fy=new bU(fH).length*ft;fA=new bU(fq).length*ft;fM-=fy+fA;fD=[];fx=[];fM-=30;for(fG=0,fu=fI.length;fG<fu;fG++){fQ=fI[fG];fF=this.get_action_by_name(fQ);fn=new bU(fF.text).length*ft;fP=fn+16+8+10+9;if(fM>fP){fD.push(fQ)}else{if(fx.length===0){fB=fD.pop();fx.push(fB)}fx.push(fQ)}fM-=fP}if(fx.length){fD.push("more_actions")}fv=(function(){var j,fR,fS;fS=[];for(j=0,fR=fD.length;j<fR;j++){fQ=fD[j];fS.push(this.get_action_by_name(fQ))}return fS}).call(this);if(fx.length){fv[fv.length-1].subactions=(function(){var j,fR,fS;fS=[];for(j=0,fR=fx.length;j<fR;j++){fQ=fx[j];fS.push(this.get_action_by_name(fQ))}return fS}).call(this)}fE=fi.tmpl("actions_bar_tmpl",{context:this,description:fH,filesize:fq,has_actions:!!fI.length,actions:fv,_:eB,Sprite:cx});$("browse-root-actions").__date(fE);i=this.get_disabled_action_names();fz=[];for(fC=0,fs=i.length;fC<fs;fC++){fF=i[fC];fz.push(this._disable_action(fF))}return fz},_click:function(fn,j){var T,i;T=j.readAttribute("data-value");cL(T);this.firefly_logging_helper(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);fn.preventDefault();ba.TimeToFirstActionLogger.log(ct.active_user.id,T);i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,fn,"browse_actions_basic");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",ct.active_user,this._log_extras,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",ct.active_user,this._log_extras,true)}}});Object.extend(eI,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});fa=E.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var i;if(!ct.inside_dir){return[]}i=[];if(!ct.inside_deleted_dir){i=i.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){i.push("global_share")}if(this._should_show_share_link()){i.push("global_token_share")}if(!Constants.can_see_trash){i.push((ct.deleted_shown?"hide_del":"show_del"))}}else{i=i.concat(["global_restore"])}return i},_should_show_shared_folder_options:function(){return !ct.is_in_subfolder_of_shared_folder()&&!ct.inside_sandbox},_should_show_share_link:function(){return ct.is_shmodelable_path(ct.containing_fq_path())}});bN=E.GlobalActionsBasic=Class.create(fa,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bn.SHOW_EVT,this._disable.bind(this));return document.observe(bn.HIDE_EVT,this._enable.bind(this))},_render:function(){var fn,fo,fs,fw,fx,fp,ft,i,T,fr,fq,fv,fu;fo=this.get_action_names();fu=fo.intersect(bN.STANDARD_ACTIONS);fq=fo.without.apply(fo,bN.STANDARD_ACTIONS);if(fq.length===1){fu=fo;fq=[]}if(fq.length){fu.push("more_global_actions")}fv=(function(){var fz,fy,fA;fA=[];for(fz=0,fy=fu.length;fz<fy;fz++){i=fu[fz];fA.push(this.get_action_by_name(i))}return fA}).call(this);fs=(function(){var fz,fy,fA;fA=[];for(fz=0,fy=fv.length;fz<fy;fz++){fn=fv[fz];if(fn.kind==="button"){fA.push(fn)}}return fA})();T=(function(){var fz,fy,fA;fA=[];for(fz=0,fy=fv.length;fz<fy;fz++){fn=fv[fz];if(fn.kind!=="button"){fA.push(fn)}}return fA})();fw=fi.tmpl("global_actions_tmpl",{context:this,standard_actions:fs.concat(T),secondary_actions:(function(){var fz,fy,fA;fA=[];for(fz=0,fy=fq.length;fz<fy;fz++){i=fq[fz];fA.push(this.get_action_by_name(i))}return fA}).call(this),Sprite:cx});$("global-actions").__date(fw);bF(document).trigger(dN.GA_RENDERED);fx=this.get_disabled_action_names();fr=[];for(fp=0,ft=fx.length;fp<ft;fp++){fn=fx[fp];fr.push(this._disable_action(fn))}return fr},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(T){var j,i;i="#global-actions #"+T+"_button";j=bF(i);j.addClass("disabled");return j.click((function(fn){return function(fo){fn.show_disabled_action_warning(T);return false}})(this))},_enable:function(){var fo,fp,T,i,fn;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");fp=this.get_disabled_action_names();fn=[];for(T=0,i=fp.length;T<i;T++){fo=fp[T];fn.push(this._disable_action(fo))}return fn},_click:function(fn,j){var T,i;T=j.readAttribute("data-value");cL(T);i=a.option_dict[T];cL(i,"Action info is missing for "+T);bN.hide_secondary();eY.deselect_all();fn.preventDefault();i.click_handler.call(this,fn,"global_actions_basic");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_share_button",ct.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_share_button",ct.active_user,this._log_extras,true)}}}});Object.extend(bN,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var i,j;j=$("secondary-actions");i=$("more_global_actions_button");j.show();return i.addClassName("down")},hide_secondary:function(){var i,j;j=$("secondary-actions");if(!j){return}i=$("more_global_actions_button");j.hide();return i.removeClassName("down")}});dG=E.GlobalActionsContext=Class.create(fa,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fn,j){var T,i;T=j.readAttribute("data-value");if(cT.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}this.firefly_logging_helper(T);i=a.option_dict[T];eY.deselect_all();if(!i.is_dropdown){bn.hide()}fn.preventDefault();i.click_handler.call(this,fn,"global_actions_context");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_right_click_share",ct.active_user,this._log_extras,true)}else{if(ct.inside_shared_folder){return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_options",ct.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_share",ct.active_user,this._log_extras,true)}}}}});var y;y=E.BrowseClipboard=(function(){var fs,fp,T,fq,fo,fu,fw,fr,j,i,ft,fn,fv;fs=0;fp=1;fo=[];T=null;fv=function(){var fA,fB,fz,fy,fx,fC;if(C.focus_in_input()){return}fz=eY.get_selected_files();if(fz&&fz.length){for(fy=0,fx=fz.length;fy<fx;fy++){fB=fz[fy];if(fB.bytes<0){ah.error(eB("Deleted files cannot be added to the clipboard"));return false}else{if(fB.target_ns){fC=eB("'%(filename)s' cannot be added to the clipboard");fC=fC.format({filename:fB.filename});ah.error(fC);return false}}}fo=fz;fA=fz.length;fC=bd("Added %d item to clipboard","Added %d items to clipboard",fA).format(fA);ah.success(fC);return true}};fu=function(){if(fv()){T=fs;return false}};fw=function(){if(fv()){T=fp;return false}};fr=function(fx){var fy;cL(typeof fx!=="undefined","BrowseClipboard _paste got an undefined path");if(fo.length){fy=T===fs?dD.do_bulk_copy:dD.do_bulk_move;fy(fo,fx);return true}};fn=function(fx){var fy;if(C.focus_in_input()||ct.in_search_mode()||ct.inside_deleted_dir){return}fy=fr(ct.containing_fq_path());if(fy){return false}};fq=function(){return fo=[]};i=function(fE){var fD,fB,fC,fA,fz,fx,fy;fC=fE.memo.files;for(fA=0,fx=fC.length;fA<fx;fA++){fB=fC[fA];for(fz=0,fy=fo.length;fz<fy;fz++){fD=fo[fz];if(fD.fq_path===fB.fq_path||fD.fq_path.startsWith(fB.fq_path+"/")){fq();return}}}};j=function(fx){cL((fx.memo.file!=null)&&(fx.memo.files==null));fx.memo.files=[fx.memo.file];return i(fx)};ft=function(){var fB,fz,fy,fx,fA;bF(document).on(aH.RENAME,(function(fC){return function(fD,fE){fD.memo=fE;return j(fD)}})(this));fA=[aH.DELETE,aH.MOVE];for(fz=0,fy=fA.length;fz<fy;fz++){fB=fA[fz];document.observe(fB,i)}fx=key.main_modifier();key(fx+"+c",ct.KEY_SCOPE,fu);key(fx+"+x",ct.KEY_SCOPE,fw);return key(fx+"+v",ct.KEY_SCOPE,fn)};return{init:function(){return ft()}}})();var eY,aE;eY=E.BrowseSelection=(function(){var fK,fQ,fN,fJ,fq,fp,fG,fL,fy,fo,fP,fI,fC,fB,fs,fE,j,i,fx,fD,fR,fw,fu,fz,ft,fn,fr,fH,fF,T,fO,fM,fv,fA;fr=[];fJ=null;fo=null;fL=null;fp=[];fM=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eY.get_selected_files().invoke("get_div").findAll(function(fS){return fS}).invoke("addClassName","file-select");if(eY.get_selected_files().length===1){return eY.get_selected_files().invoke("get_div").findAll(function(fS){return fS}).invoke("addClassName","file-select-one")}};fv=function(){if(fL){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(ct.in_search_mode()){return}return eY.get_selected_files().filter(function(fS){return !fS.editing}).invoke("get_div").findAll(function(fS){return fS}).invoke("writeAttribute","draggable","true")};fA=function(fS){fS.apply(null,$A(arguments).slice(1));return document.fire(eY.UPDATED_EVT)};fH=function(fU,fT){var fV,fS;fS=fr.length;fr=(fU instanceof cS?[fU]:$A(fU));if(fr.length!==fS){eJ("Selected",fr.length,"files")}fV=fT||fr.last();cL(!fV||fV instanceof cS,"Invalid anchor type"+fV);return fJ=fV};fH=fH.wrap(fA);fK=function(fT,fS){if(fT){fr.push(fT)}return fJ=fS||fT};fK=fK.wrap(fA);fu=function(fS){var fT;fT=fr.indexOf(fS);if(fT===-1){return}return fr.splice(fT,1)};fu=fu.wrap(fA);fz=function(){return fr=[]};fz=fz.wrap(fA);fF=function(fS){fp=fS;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fS.invoke("get_div").findAll(function(fT){return fT}).invoke("addClassName","context-select")};j=function(f1){var fY,fW,fV,fX,f4,fU,f3,f5,fS,f0,f2,fZ,fT;fZ=$(f1.target);f5=fZ.match("li.browse-file")?fZ:fZ.up("li.browse-file");fY=fZ.match("a")?fZ:fZ.up("a");fV=cS.from_elem(f5);if(f1.isRightClick()||!f5||fY||f5.hasClassName("unselectable")){return}ct.keyboard_nav=false;if(fp.length){return}fU=d6.is_mac();if((fU&&f1.metaKey)||(!fU&&f1.ctrlKey)){if(fr.indexOf(fV)===-1){return fK(fV)}else{return fu(fV)}}else{if(f1.shiftKey){fW=ct.files.indexOf(fJ);fT=ct.files.indexOf(fV);f3=ct.files.indexOf(fr.last());f0=fr.slice(0);f4=f3<fW?-1:1;fX=fW;while(fX!==f3){fX+=f4;f2=f0.indexOf(ct.files[fX]);if(f2!==-1){f0.splice(f2,1)}}f4=fT<fW?-1:1;fX=fW;while(fX!==fT){fX+=f4;fS=f0.indexOf(ct.files[fX]);if(fS!==-1){f0.splice(fS,1)}f0.push(ct.files[fX])}return fH(f0,fJ)}else{return fH(fV)}}};i=function(fY){var f1,fU,fV,fX,f0,fZ,fT,fS,fW;if(fY.isRightClick()||fp.length||d6.in_scrollbar(fY.pointerX())){return}fZ=$(fY.target);if(Element.match(fZ,"object")){fZ=fZ.parentNode}fW=["browse-box","context-menu-container","modal","modal-overlay"];fT=false;for(fV=0,fX=fW.length;fV<fX;fV++){fS=fW[fV];if(fZ.descendantOf(fS)||fZ.match("#"+fS)){fT=true;break}}if(!fT){fH();return}f0=fZ.match("li.browse-file")?fZ:fZ.up("li.browse-file");fU=cS.from_elem(f0);f1=fZ.match("[draggable]")||fZ.up("[draggable]");if(fU&&!f1){fo=fJ;if(!fY.shiftKey){if(fU){fo=fU}else{if(fZ.match("#browse-files")){fo=ct.files.last()}}}fL=[];if(fY.metaKey||fY.ctrlKey){return fL=eY.get_selected_files()}}};T=function(fU){var fT,fS;fT=cS.from_elem(fE(fU));fU.preventDefault();if(!fT){return}fS="browse_file_row";ba.ShmodelUILogger.log_with_target_file("token_share",fS,fT);return dx.shmodel(fT.fq_path,fS)};fE=function(fT){var fS;fS=$(fT.target);if(fS.match("li.browse-file")){return fS}else{return fS.up("li.browse-file")}};fs=(function(fS){return function(f1){var f4,fV,fT,fW,f3,f2,fU,fZ,f5,f0,fX,fY;f0=ct.sharing_single_file_collaboration&&ct.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";f3=fE(f1);fV=cS.from_elem(f3);f1.preventDefault();if(!fV){return}f2="browse_file_row";fY=ba.ShmodelUILogger.get_target_item(fV);ba.ShmodelUILogger.log("single_entry_share",f2,fY);fW=ct.simple_sharing_enabled;fZ=bF(f3).find(".inline-share-button")[0];if(!ct.in_search_mode()){fZ=bF(f3).find(".sharing .inline-share-button")[0]}fX=fV.dir&&(fV.is_shared_folder()||fV.could_be_shared_folder());f4=d4.get_for_user(ct.active_user).verified_or_show();if(ct.simple_sharing_react_member_list_enabled&&f4){return eG.createAndShowInbandModalFromBrowseFile(ct.active_user,fV)}else{if(ct.simple_sharing_individual_files_enabled&&!fV.dir&&f4){return eG.createAndShowInbandModalFromBrowseFile(ct.active_user,fV)}else{if(fX){if(fW){if(f4){return eG.createAndShowInbandModalFromBrowseFile(ct.active_user,fV)}}else{return aE.open(fV.fq_path,fV.is_shared_folder(),fZ,ct.active_user,fY)}}else{if(ct.simple_sharing_to_file_enabled&&((fU=__CONDITIONAL_JS__.OpenWith)!=null?fU.file_supported(fV):void 0)){if(f4){return eG.createAndShowInbandModalFromBrowseFile(ct.active_user,fV)}}else{if(f0&&(fV.is_shared_single_file()||fV.could_be_shared_single_file())&&!fW){return aE.open(fV.fq_path,fV.is_shared_single_file(),fZ,ct.active_user,fY,fT=true,fV.mount_point)}else{f5=function(){return dx.shmodel(fV.fq_path,f2)};eY.firefly_logging_helper(fV,"single_entry_share_button_file_link");return cy.show_modal(f1,ct.active_user.id,f5)}}}}}}})(this);fq=function(fV){var fT,fS,fU;fU=$(fV.target);fS=fU.match("li.browse-file")?fU:fU.up("li.browse-file");fT=cS.from_elem(fS);if(fT){return j(fV)}};fB=null;fP=function(){var fS;clearInterval(fB);fS=function(){ct.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fB=setTimeout(fS,100)};fG=function(){if(!ct.keyboard_nav){ct.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fx=function(fZ){var fV,fU,fT,fX,f0,fW,fY,fS;fP();if(!eY.is_selecting()){return}fV=ct.files.indexOf(fo);fS=ct.files.indexOf(cS.from_elem(fZ.target));cL(fV<ct.files.length&&fV>=0,"anchor_index: "+fV+" "+fo);cL(fS<ct.files.length&&fS>=0,"target_index: "+fS);fU=ct.files.slice(Math.min(fV,fS),Math.max(fV,fS)+1);fT=fL.slice(0);for(fW=0,fY=fU.length;fW<fY;fW++){f0=fU[fW];fX=fT.indexOf(f0);if(fX===-1){fT.push(f0)}else{fT.splice(fX,1)}}return fH(fT)};fy=function(fS){fo=null;return fL=null};fw=function(fU){var fS,fT;if(typeof P!=="undefined"&&P!==null){P.reset()}fG();if(fU){Event.extend(fU).preventDefault()}fT=fr.length?fr.last()===ct.files.first()?ct.files.first():(fS=ct.files.indexOf(fr.last())-1,ct.files[fS]):ct.files.last();fH(fT);if(fT){return ct.scrollTo(fT.get_div())}};fD=function(fU){var fS,fT;if(typeof P!=="undefined"&&P!==null){P.reset()}fG();if(fU){Event.extend(fU).preventDefault()}fT=fr.length?fr.last()===ct.files.last()?ct.files.last():(fS=ct.files.indexOf(fr.last())+1,ct.files[fS]):ct.files.first();fH(fT);if(fT){return ct.scrollTo(fT.get_div())}};fN=function(f0){var fT,fU,fY,fW,fZ,fV,fS,fX;if(typeof P!=="undefined"&&P!==null){P.reset()}fG();if(f0){Event.extend(f0).preventDefault()}if(fr.length>0){fZ=ct.files.indexOf(fr.last());fT=ct.files.indexOf(fJ);if(fJ===fr.last()||fT>fZ){if(fZ>0){fX=[];for(fY=fW=fS=fZ-1;fS<=0?fW<=0:fW>=0;fY=fS<=0?++fW:--fW){fU=ct.files[fY];fV=fr.indexOf(fU);fK(fU,fJ);if(fV!==-1){fX.push(fr.splice(fV,1))}else{ct.scrollTo(fU.get_div());break}}return fX}}else{fu(fr.last());return ct.scrollTo(fr.last().get_div())}}else{return fw()}};fQ=function(f1){var fT,fU,fY,fW,fZ,fV,fS,f0,fX;if(typeof P!=="undefined"&&P!==null){P.reset()}fG();if(f1){Event.extend(f1).preventDefault()}if(fr.length>0){fZ=ct.files.indexOf(fr.last());fT=ct.files.indexOf(fJ);if(fJ===fr.last()||fT<fZ){fX=[];for(fY=fW=fS=fZ+1,f0=ct.files.length;fS<=f0?fW<f0:fW>f0;fY=fS<=f0?++fW:--fW){fU=ct.files[fY];fV=fr.indexOf(fU);fK(fU,fJ);if(fV!==-1){fX.push(fr.splice(fV,1))}else{ct.scrollTo(fU.get_div());break}}return fX}else{fu(fr.last());return ct.scrollTo(fr.last().get_div())}}else{return fD()}};ft=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}fH(ct.files);return false};fn=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}return fH(null,null,null)};fC=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(fM,100)};fR=function(fS){return fS.memo.files.each(function(fT){var fU;fU=fr.indexOf(fT[0]);if(fU!==-1){fr.splice(fU,1);return fK(fT[1])}})};fI=function(fS,fT){var fU;if(ct.in_search_mode()&&fS&&fT){fU={file_nsid:fS.ns_id,file_sjid:fS.file_sjid,firefly:cb.firefly_enabled,match_type:fS.match_type,position:fS.sort_rank,request_id:fS.request_id,viewport:"full-view",action_type:fT};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fU)}};fO=function(fT,fS,fU,fW,f0){var fZ,fY,fX,fV;fY="file_row_sharing_menu";if(fS){if(d4.get_for_user(fT).verified_or_show()){ba.ShmodelUILogger.log("sf_options",fY,fU);fI("single_entry_share_button_folder_options");fZ=new dg(fT,fW);if(typeof f0==="function"){f0()}return fZ.show()}}else{fV=ct.verify_email_after_share_experiment_variant;fX=fV&&fV==="VERIFY_LAST";if(fX){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fV){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fX||d4.get_for_user(fT).verified_or_show()){ba.ShmodelUILogger.log("sf_invite",fY,fU);fI("single_entry_share_button_folder_invite");fZ=new cp(fT,{folder_name:fW,element_id:"invite-to-new-sf-wizard-modal-"+fT.id,must_check_verified:fX});if(typeof f0==="function"){f0()}return fZ.show()}}};document.observe(bE.REMOVE,function(fS){return fS.memo.files.each(fu)});document.observe(bE.MOVE,fR);return{UPDATED_EVT:"db:select:updated",init:function(){var fS;document.observe("click",fq);document.observe("mousedown",i);document.observe("mouseup",fy);document.observe("dragend",fy);document.observe("mouseup",fv);$("browse-files").on("mouseover","li.browse-file",fx);$("browse-files").on("click",".shmodel-file",T);$("browse-files").on("click",".inline-share-button",fs);document.observe(eY.UPDATED_EVT,fM);document.observe(eY.UPDATED_EVT,fv);document.observe(dN.RENDER,fM);document.observe(dN.RENDER,fv);document.observe(dN.UPDATE,fH.bind(null,null,null));fS=key.main_modifier();key("up",ct.KEY_SCOPE,fw);key("down",ct.KEY_SCOPE,fD);key(fS+"+a",ct.KEY_SCOPE,ft);key("escape",ct.KEY_SCOPE,fn);key("shift+up",ct.KEY_SCOPE,fN);return key("shift+down",ct.KEY_SCOPE,fQ)},set_selected_files:function(fS){return fH(fS)},get_selected_files:function(){return fr.slice(0)},get_selected_fq_paths:function(){return fr.map(function(fS){return fS.fq_path})},has_selected_files:function(){return fr.length},is_selected:function(fS){return fr.indexOf(fS)!==-1},is_selecting:function(){return !!fo},deselect_all:fz,set_context_selected:function(fS){return fF(fS)},flicker_selected:fC,firefly_logging_helper:function(fS,fT){return fI(fS,fT)},show_share_modal_if_email_verified:fO}})();aE=E.SharingGrowthExperimentsDropdown={open:function(fq,T,fn,fr,fp,j,fo){var i;this.fq_path=fq;this.existing_sf=T;this.button=fn;this.user=fr;this.target_item=fp;this.is_file=j;this.mount_point=fo;this.$menu=bF("#sharing-growth-experiments-dropdown-menu");i=this.$button&&this.$button.length;if(i){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var i;this.$menu.show();this.$button=bF(this.button);this.$button.addClass("pressed");i={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};C.clone_position(this.$menu,this.$button,i);bF("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(i){return i.stopPropagation()});bF(document).on("mousedown",bF.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bF.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bF(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bF.proxy(this._share_link_click,this))},_add_share_file_logging:function(T,fn){var j,i;i={path:this.fq_path};j=this.existing_sf?T:fn;return ba.SharedFolderActivityLogger.log("web",j,this.user,i)},_sf_click:function(j){var i;i=(function(T){return function(){var fn;if(T.is_file){if(d4.get_for_user(T.user).verified_or_show()){T._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(T.existing_sf){fn=new d7(T.user,{folder_name:aA.filename(T.mount_point),folder_path:T.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{fn=new cp(T.user,{folder_name:T.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+T.user.id})}return fn.show()}}else{return eY.show_share_modal_if_email_verified(T.user,T.existing_sf,T.target_item,T.fq_path)}}})(this);this._hide();return cy.show_modal(j,this.user.id,i)},_share_link_click:function(j){var i;i=(function(T){return function(){var fn;fn="file_row_sharing_menu";ba.ShmodelUILogger.log("token_share",fn,T.target_item);T._firefly_logging_helper("single_entry_share_button_folder_link");dx.shmodel(T.fq_path,fn);if(T.is_file){return T._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}}})(this);this._hide();return cy.show_modal(j,ct.active_user.id,i)},_firefly_logging_helper:function(i){return eY.firefly_logging_helper(ct.find_file(this.fq_path),i)},_clicked:function(i,j){return i.is(j.target)||i.has(j.target).length},_click_outside_menu_callback:function(i){if(!(this._clicked(this.$menu,i)||this._clicked(this.$button,i))){return this._hide()}},_hide:function(i){this._unlisten();bF("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");return this.$button=null}};var A;A=E.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(i,j){this._exclude_move_event=i;if(j!=null){return this._scroll_window=j}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(j){var i;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(j):void 0){return this._mouse_y=0}else{i=j.pointerY();return this._mouse_y=i-C.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var i;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}i=0;if(this._mouse_y<this._scroll_window){i=-1*this._scroll_amount}else{if(this._mouse_y>C.viewport_dimensions().height-this._scroll_window){i=this._scroll_amount}}if(i){return C.scroll_to(C.scroll_offsets().left,C.scroll_offsets().top+i)}}};var bR;bR=E.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var i;if(!Modernizr.draganddrop){return}this.listen();i=function(T){var j;j=bF(T.target);return j.closest("#browse-location").length||j.attr("id")==="browse-location"};return A.init(i,bF("#browse-header").height())},listen:function(){var i;i=$(document.body);document.observe(dN.UPDATE,this._update_body_data.bind(this));i.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));i.on("dragend",this._body_dragend.bind(this));i.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){i.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));i.on("mousedown",this._ie_start_drags.bind(this));i.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}i.observe("dragover",this._body_dragover.bind(this));i.observe("dragleave",this._body_dragleave.bind(this));i.observe("dragstart",this._body_dragstart.bind(this));i.observe("mousemove",this._body_mousemove.bind(this));i.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eY.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(dN.RENDER,this._build_selected_drag_icon.bind(this));i.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return i.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(j){var i;if(!window.event||window.event.button!==1){return}i=j.findElement("[draggable]");if(i&&i!==document&&i.dragDrop){i.dragDrop();return bR._ie_end_drags()}},_ie_start_drags:function(i,j){if(j.tagName!=="OBJECT"&&$(j).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var j,i;j=ct.inside_dir?"copy move":false;i=ct.inside_dir?ct.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",j);return $(document.documentElement).writeAttribute("data-fq_path",i)},_body_dragover:function(j){var i;i=this._get_event_browse_files();if(i.length){return this._update_status_position(j,i)}else{if(!this._drag_from_window&&this._can_drop_transfer(j.dataTransfer)){return bp.show_drop_indicators(j)}}},_body_dragleave:function(T){var j,i,fn;i=T.x||T.clientX;fn=T.y||T.clientY;j=C.viewport_dimensions();if(!((0<i&&i<j.width)&&(0<fn&&fn<j.height))){return bp.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bp.hide_drop_indicators();A.end();return this._drag_from_window=false},_body_mousemove:function(){return bp.hide_drop_indicators()},_ie_mouseover:function(j,i){if(!C.focus_in_input()){return i.focus()}},_dropzone_dragover:function(fp,i){var j,T,fn,fo;if(!cN.isFileDragEnabled()){return true}fp.preventDefault();fn=this._get_event_browse_files();fo=this._target_fq_path(i);if(!fn.pluck("fq_path").indexOf(fo===-1)){return}if(!this._can_drop(fp,i)){i.addClassName("drag_nodrop");return}try{T=fp.dataTransfer.effectAllowed}catch(fq){}if(T==="move"||T==="copyMove"||T==="linkMove"||T==="all"){fp.dataTransfer.dropEffect="move"}else{fp.dataTransfer.dropEffect="copy"}fp.preventDefault();j=$$(".dragover");j.removeItem(i);j.invoke("removeClassName","dragover");if(!dT.disabled){i.addClassName("dragover")}return bp.folder_dragover(fo)},_dropzone_dragleave:function(j,i){return this._clear_hover_state(i)},_file_dragstart:function(fr,fu){var fv,i,fw,ft,j,fq,fo,fn,fs,T;d6.clear_selected();if(eY.is_selecting()){return fr.preventDefault()}fr.dataTransfer.effectAllowed="copyMove";fr.dataTransfer.setData("URL","about:blank");fq=cS.from_elem(fu);this._set_event_browse_files(fq);fo=this._get_event_browse_files();if(fo.length<=1&&!fq.dir){T=fq.href;fn=(fq.filename||eB("file")).replace(/:/g,"-");fs="application/octet-stream";try{fr.dataTransfer.setData("DownloadURL",[fs,fn,T].join(":"))}catch(fp){}}fw=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});fv=true;try{fr.dataTransfer.setDragImage(fw,150,150)}catch(ft){j=ft;fv=d6.ie8}this._add_drop_indicators(fr);A.start();if(fv){this._update_status_position(fr,fo);i=$("drag-status");i.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fo.length>1){i.addClassName("rotatein")}if(this._is_dragging_selection()){i.addClassName("selection")}return i.addClassName("fadein")}},_add_drop_indicators:function(fp){var fq,T,i,fo,fn;$(document.body).addClassName(this._STATUS_CLASS);if(!dT.disabled){fo=$$('[dropzone="copy move"]');fn=[];for(T=0,i=fo.length;T<i;T++){fq=fo[T];if(this._can_drop(fp,fq)){fn.push(fq.addClassName("can_drop"))}else{fn.push(void 0)}}return fn}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,fq,fv,fp,fs,fw,fr,fu,ft,fo,fn;fn=eY.get_selected_files();fv=new Element("div",{id:"drag-selection-status"});fo=fn.slice(0,4);for(fs=fr=0,fu=fo.length;fr<fu;fs=++fr){fq=fo[fs];T=fq.get_div();if(!T){continue}ft=T.down(".icon");ft.stopObserving("load");ft.observe.bind(ft).defer("load",bR._build_selected_drag_icon);fw=ft.cloneNode(false);Element.addClassName(fw,"icon icon"+fs);fv.__sert(fw)}fp=new Element("span",{className:"badge"});fp.__date(fn.length);fv.appendChild(fp);return $("drag-selection-status").replace(fv)},_build_file_drag_icon:function(fo,i){var j,fp,fn,T;j=cS.from_elem(i);T=j.get_div().down(".icon").cloneNode(false);Element.addClassName(T,"icon icon0");fn=new Element("span",{className:"badge"});fn.__date("1");fp=new Element("div",{id:"drag-file-status"});fp.__date(T).__sert(fn);return $("drag-file-status").replace(fp)},_drop:function(fu,fx){var fv,fp,fA,fy,fB,fs,fz,fr,fo,fq,ft,T,fw,i,fn;fp=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fs=cN.getDraggedLink(fu.dataTransfer)}if(fs!=null){i=cN.buildUrlLinkfileContents(fs);fw=new Blob([i],{type:"text/plain"});T=G.parse(fs).getAuthority();fw.name=ct.unused_filename(T+".url");fw.overwrite=false;fz=[fw];ba.LinkfileActivityLogger.log("droplink","url",T,true,"browse",{})}else{fz=fu.dataTransfer.files;fr=fu.dataTransfer.items}fu.preventDefault();if(fx.readAttribute("quicksend")){if(fz&&fz.length){fA=function(){return bp.upload(Z.DEST_FOLDER,fz,fr)};Z.get_folder_name(fA)}else{if(fp.length){for(fq=0,ft=fp.length;fq<ft;fq++){fo=fp[fq];fo.id=p.guid();Z.add_dropbox_file(fo)}}}return}if(this._is_read_only(fx)){fn=eB("You don't have permission to add to this folder.");ah.error(fn);return}fy=null;fB=cS.from_elem(fx);fv=fx.readAttribute("data-fq_path");if(fB){fy=fB.fq_path}else{if(fv||fv===""){fy=fv}}if(fz&&fz.length){if(!bp.supported()){ah.error(eB("Drag and drop not supported. Please try the simple uploader."))}else{if(!bp.browse_indicators_enabled()&&!bp.modal_indicators_enabled()){if(cC.choose_button_id.startsWith("wizard-")){ah.error(eB("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ah.error(eB("You can't drag and drop upload right now."))}}else{bp.upload(fy,fz,fr)}}}else{if(fp.length){if((fu.dataTransfer.dropEffect==="copy")||(fu.dataTransfer.effectAllowed==="copy")){dD.do_bulk_copy(fp,fy)}else{if(!ct.inside_dir||ct.containing_fq_path()!==fy){dD.do_bulk_move(fp,fy)}}}}this._remove_drop_indicators();return bp.hide_drop_indicators()},_set_event_browse_files:function(i){var j;j=eY.is_selected(i);return this._current_item_key=j?this._SELECTION_CONST:i.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var i,fn,T,j;try{j=this._current_item_key;if(this._is_dragging_selection()){return eY.get_selected_files()}else{if(j){T=cS.from_key(j);return(T?[T]:[])}}}catch(i){fn=i;console.log(fn)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(i){if(i.readAttribute("read_only")){return true}if(i.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return az.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(j){var i;i=["Files"];if(this._linkfile_drop_enabled()){i.push.apply(i,["text/x-moz-url","text/uri-list","Url"])}return bx.intersection(j!=null?j.types:void 0,i).length>0},_can_drop:function(fn,j){var i,T;if(j.readAttribute("quicksend")){return true}if(this._is_read_only(j)){return false}i=this._target_fq_path(j);T=this._get_event_browse_files();if(T.length){return !dD.bulk_move_error(T,i)}else{if(this._can_drop_transfer(fn.dataTransfer)){bp.supported();return true}else{return false}}},_target_fq_path:function(i){var j;j=cS.from_elem(i);if(j){return j.fq_path}else{return i.readAttribute("data-fq_path")}},_clear_hover_state:function(fo){var fp,T,i,fn;fn=$$("#browse .dragover");for(T=0,i=fn.length;T<i;T++){fp=fn[T];if(fp!==fo){fp.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(i){i=Event.extend(i);return d6.scry("drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var P;P=E.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(i){return i.charCodeAt(0)}),update:function(){var fo,fq,fn,T,i,fp;if(!P._listening){P.listen();P._listening=true}fo=[];fp=ct.files;for(T=0,i=fp.length;T<i;T++){fn=fp[T];fq=P.to_codepoint_list(fn.filename);fo.push([fq,fn])}fo.sort(function(fr,j){return P.cmp_codepoints(fr[0],j[0])});return P._CODEPOINTS=fo},reset:function(){return P._active=""},is_active:function(){return P._active},jump:function(i){if(i){eY.set_selected_files([i]);return ct.scrollTo(i.get_div())}},listen:function(){var fp,T,i,fo,fn;document.observe("keypress",function(fq){var j;if(key.getScope()!==ct.KEY_SCOPE){return}if(C.focus_in_input()||fq.metaKey||fq.altKey||fq.altGraphKey||fq.ctrlKey){return}j=fq.charCode||fq.keyCode;if(j<32){return}if((33<=j&&j<=40)){return}if(j===32){if(P._active){fq.preventDefault()}else{return}}if(P._BLACKLIST.indexOf(j)!==-1){return}clearTimeout(P._RESET_TIMER_ID);P._active+=String.fromCharCode(j).toLowerCase();P.jump(P.nearest_file(P._active));return P._RESET_TIMER_ID=setTimeout(P.reset,P._RESET_WAIT)});fo=[aH.DELETE,aH.COPY,aH.MOVE,aH.RENAME,aH.PURGE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_LEAVE,aH.SF_UNSHARE,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,bE.ADD,bE.REMOVE,bE.MOVE];fn=[];for(T=0,i=fo.length;T<i;T++){fp=fo[T];document.observe(fp,function(j){return P.update()});fn.push(bF(document).on(fp,function(j){return P.update()}))}return fn},nearest_file:function(ft){var fp,fn,i,fo,fr,T,fs,fq;if((T=P._CODEPOINTS)!=null?T.length:void 0){fp=P.to_codepoint_list(ft);fs=P._CODEPOINTS;for(fo=0,fr=fs.length;fo<fr;fo++){fq=fs[fo],i=fq[0],fn=fq[1];if(P.cmp_codepoints(fp,i)<1){return fn}}P._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fq,fp){var fn,T,fo;cL(fq.length>0&&fp.length>0,"bad input to cmp_codepoints");for(fn=T=0,fo=fq.length;0<=fo?T<fo:T>fo;fn=0<=fo?++T:--T){if(fp[fn]==null){return 1}if(fq[fn]!==fp[fn]){return(fq[fn]<fp[fn]?-1:1)}}if(fp.length>fq.length){return -1}else{return 0}},to_codepoint_list:function(fn){var fp,fo,fq,T;fn=fn.toLowerCase();T=[];for(fp=fo=0,fq=fn.length;0<=fq?fo<fq:fo>fq;fp=0<=fq?++fo:--fo){T.push(fn.charCodeAt(fp))}return T}};var bn;bn=E.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bF(document).click(this.hide_on_click);bF(document).on(dN.UPDATE,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(i){return function(j){return bn.hide()}})(this))},unlisten:function(){bF(document).off("click",this.hide_on_click);return bF(document).off(dN.UPDATE,this.hide_on_click)},hide_on_click:function(i){if(!(i.which===3||bF(i.target).parents("#context-menu").length)){return bn.hide()}},show_for_file:function(i,fn,T){var fo,j;ct.keyboard_nav=false;this.hide();fo=cS.from_elem(T);j=eY.is_selected(fo)?eY.get_selected_files():(eY.deselect_all(),[fo]);eY.set_context_selected(j);return this._show(fn,new i(j))},show_global:function(i,j){this.hide();return this._show(j,new i())},show_shmodel:function(fq){var fp,j,i,T,fn,fo;fp=["get_original"];fn=fq.findElement("img");if((fn.readAttribute("enable-download"))==="true"){T=fn.readAttribute("data-original-href");j=[]}else{T="";j=["get_original"]}this.hide();fo={get_original:{icon:"download",text:eB("Download original"),href:T}};i=Class.create({get_action_names:function(){return fp},get_disabled_action_names:function(){return j},get_action_by_name:function(fr){var fs;fs=fo[fr];fs.name=fr;return fs}});return this._show(fq,new i())},show_for_lightbox:function(fr){var fq,j,i,fo,T,fp,fn;fq=["download","view_original"];this.hide();T=fr.findElement("img");if((T.readAttribute("enable-download"))==="false"){j=["download","view_original"];fo="";fn=""}else{j=[];fo=G.parse(T.readAttribute("data-original-href")).updateQuery({dl:1}).toString();fn=T.readAttribute("data-original-href")}fp={download:{icon:"download",text:eB("Download"),href:fo},view_original:{icon:"view_original",text:a6.append_ellipsis(eB("View original")),href:fn,target:"_blank"}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){var fs;fs=$("context-menu-container");fs.stopObserving("click");fs.stopObserving("contextmenu");fs.on("click",".action button",this._click.bind(this));return fs.on("contextmenu",".action button",this._click.bind(this))},_click:function(fw,ft){var fv,fs,fu;fv=ft.readAttribute("data-value");fs=fp[fv];bn.hide();fw.preventDefault();return(fu=fs.click_handler)!=null?fu.call(this,fw):void 0},get_action_names:function(){return fq},get_disabled_action_names:function(){return j},get_action_by_name:function(fs){var ft;ft=fp[fs];ft.name=fs;return ft}});return this._show(fr,new i())},show_photos:function(fs,fw){var fv,j,fp,fo,fu,ft,i,T,fn,fr,fq;this.hide();fo={divider:{type:"divider"},choose_album:{icon:"album_16",text:a6.append_ellipsis(eB("Add %(num_photos)s to album").format({num_photos:fw.length})),click_handler:function(fx){cJ.show_add_to_album_modal(fx,fw);return g.log_interaction(em.ADD_TO_OTHER_ALBUM,dc.PCM,{num_photos:fw.length})}},remove:{icon:"album_delete_16",text:eB("Remove %(num_photos)s from album").format({num_photos:fw.length}),click_handler:function(){cJ.show_remove_photos_modal(bQ.get_current_collection(),fw);return g.log_interaction(em.REMOVE,dc.PCM,{num_photos:fw.length})}},set_cover:{icon:"album_16",text:eB("Set as cover"),click_handler:function(){bQ.get_current_collection().set_cover(fw[0]);return g.log_interaction(em.SET_AS_COVER,dc.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bQ.show_timestamps_modal(fw)}}};if(bQ.in_single_collection_view()){fv=["share","choose_album","remove"];if(fw.length===1){fv.unshift("divider");fv.unshift("set_cover")}}else{fv=["share","choose_album"];fv.push("divider");fv.push("delete");if(bQ.timestamp_edit_enabled){fu=(function(){var fz,fx,fy;fy=[];for(fz=0,fx=fw.length;fz<fx;fz++){T=fw[fz];if(T.time_taken==null){fy.push(T)}}return fy})();if(fu.length===0){fv.push("edit_timestamp")}else{if(fu.length===fw.length){fo.edit_timestamp.text="Set timestamp";fv.push("edit_timestamp")}}}}if(fw.length===1){fn=c9.categorize_files(fw),ft=fn[0],i=fn[1];if(ft){fq=a6.append_ellipsis(eB("Share photo"))}else{fq=a6.append_ellipsis(eB("Share video"))}Object.extend(fo,{share:{icon:"s_link",text:fq,click_handler:function(fx){eA.show(fw,false);return g.log_interaction(em.SHARE,dc.PCM,{num_photos:1})}},"delete":{text:a6.append_ellipsis(eB("Delete")),click_handler:function(){bQ.show_delete_photos_modal(fw);return g.log_interaction(em.DELETE,dc.PCM,{num_photos:1})}},show_in_folder:{text:a6.append_ellipsis(eB("Show in folder")),click_handler:function(){bQ.show_in_folder(fw[0]);return g.log_interaction(em.SHOW_IN_FOLDER,dc.PCM,{num_photos:1})}}});if(bQ.in_single_collection_view()){fv.push("divider")}fv.push("show_in_folder")}else{fr=c9.categorize_files(fw),ft=fr[0],i=fr[1];if(ft&&i){fq=bd("Share %(file_count)s item","Share %(file_count)s items",fw.length);fp=bd("Delete %(file_count)s item","Delete %(file_count)s items",fw.length)}else{if(ft){fq=bd("Share %(file_count)s photo","Share %(file_count)s photos",fw.length);fp=bd("Delete %(file_count)s photo","Delete %(file_count)s photos",fw.length)}else{fq=bd("Share %(file_count)s video","Share %(file_count)s videos",fw.length);fp=bd("Delete %(file_count)s video","Delete %(file_count)s videos",fw.length)}}fq=fq.format({file_count:fw.length});fp=fp.format({file_count:fw.length});Object.extend(fo,{share:{icon:"s_link",text:fq,click_handler:function(fx){bQ._share_selected();return g.log_interaction(em.SHARE,dc.PCM,{num_photos:fw.length})}},"delete":{text:fp,click_handler:function(fx){bQ.show_delete_photos_modal(fw);return g.log_interaction(em.DELETE,dc.PCM,{num_photos:fw.length})}}})}j=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fB,fz){var fA,fy,fx;fA=fz.readAttribute("data-value");fy=fo[fA];if(fB.clientX===0&&fB.clientY===0){return}bn.hide();return(fx=fy.click_handler)!=null?fx.call(this,fB):void 0},get_action_names:function(){return fv},get_disabled_action_names:function(){return[]},get_action_by_name:function(fx){var fy;fy=fo[fx];fy.name=fx;return fy}});return this._show(fs,new j())},show_photo_collection:function(fn,fo,fp){var T,i,j;this.hide();if(fo.is_anonymous){T=["go_to_link","unshare"]}else{if(fo.is_creator){T=["share","rename"];if(fo.share_tkey!=null){T.push("unshare")}T.push("delete")}else{T=["share"]}}j={share:{icon:"s_link",text:a6.append_ellipsis(eB("Share album")),click_handler:function(fq){if(fo.num_items===0){ah.error(eB("This album is empty. Add some photos before you share it!"));return}eA.show(fo,true);return g.log_interaction(em.SHARE_ALBUM,dc.CCM,{num_photos:fo.num_photos})}},unshare:{icon:"lock",text:a6.append_ellipsis(fo.is_anonymous?eB("Unshare"):eB("Unshare album")),click_handler:function(fq){cJ.show_unshare_modal(fo);return g.log_interaction(em.UNSHARE_ALBUM,dc.CCM,{num_photos:fo.num_photos})}},rename:{icon:"pencil",text:eB("Rename album"),click_handler:function(fq){fo.rename(fp.down(".collection-name"));return g.log_interaction(em.RENAME_ALBUM,dc.CCM,{num_photos:fo.num_photos})}},"delete":{icon:"album_delete_16",text:a6.append_ellipsis(eB("Delete album")),click_handler:function(fq){cJ.show_delete_modal(fo);return g.log_interaction(em.DELETE_ALBUM,dc.CCM,{num_photos:fo.num_photos})}},go_to_link:{icon:"s_link",text:eB("Go to link"),click_handler:function(fq){cJ.go_to_link(fo);return g.log_interaction(em.GO_TO_ALBUM_LINK,dc.CCM,{num_photos:fo.num_photos})}}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fu,fr){var ft,fq,fs;ft=fr.readAttribute("data-value");fq=j[ft];bn.hide();return(fs=fq.click_handler)!=null?fs.call(this):void 0},get_action_names:function(){return T},get_disabled_action_names:function(){return[]},get_action_by_name:function(fq){var fr;fr=j[fq];fr.name=fq;return fr}});return this._show(fn,new i())},_show:function(fB,fq,fz){var fw,fy,fn,fC,T,fv,fx,fA,fp,fu,fo,fs,fr,fD,ft;if(fz==null){fz=false}ft=((fB!=null?(fo=fB.target)!=null?fo.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fB!=null?(fs=fB.target)!=null?fs.type.toUpperCase():void 0:void 0)==="TEXT")||((fB!=null?(fr=fB.target)!=null?fr.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");fv=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#react-file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fD=$(fB.target);if(bF(fD).parents("#context-menu").length){return}fw=bF("#file-preview-modal");if(!(fw.find(fD).length&&bF(fD).is("img"))){for(fy=0,fA=fv.length;fy<fA;fy++){T=fv[fy];fC=$$(T);if(fC){for(fx=0,fp=fC.length;fx<fp;fx++){fn=fC[fx];if(fD.descendantOf(fn)||fD.match(T)){return}}}}}if((fB!=null?fB.shiftKey:void 0)||ft){return}else{Event.stop(fB)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=fi.tmpl("context_menu_tmpl")}if(!fq.get_action_names().length){return}eU.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fq,actions:(function(){var fE,j,i,fF;i=fq.get_action_names();fF=[];for(fE=0,j=i.length;fE<j;fE++){fu=i[fE];fF.push(fq.get_action_by_name(fu))}return fF})(),disabled_actions:fq.get_disabled_action_names(),big:fz,Sprite:cx}));this.position_at(fB.clientX,fB.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(T,fp){var j,i,fn,fo;fo=C.viewport_dimensions();i=parseInt($("context-menu").getStyle("width"),10);j=parseInt($("context-menu").getStyle("height"),10);fn=15;if(T+i>fo.width-fn){$("context-menu").setStyle({left:(fo.width-i-fn)+"px"})}else{$("context-menu").setStyle({left:T+"px"})}if(fp+j>fo.height-fn){return $("context-menu").setStyle({top:(fo.height-j-fn)+"px"})}else{return $("context-menu").setStyle({top:fp+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eY.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dp,ct,k,aL,ay,cV,cm,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};dp=E.BROWSE_SNIPPET_LEN=25;cm=E.SEARCH_SNIPPET_LEN=20;aL=E.COMMENT_COUNT_SNIPPET_LEN=3;cV=E.LAST_MODIFIED_FNAME_SNIPPET=4;ay=[bq.FILES_BY_NAME,true,"FILES_BY_NAME"];ct=INLINE_JS.Browse=E.Browse={KEY_SCOPE:"browse",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:ay,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(j,fq,fn,fp,i,fo,T){this.browse_actions_ctor=fq;this.global_actions_ctor=fn;this.browse_actions_context_ctor=fp;this.global_actions_context_ctor=i;this.ns_id_to_mount_point=fo;cL(typeof T==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cM.get_viewer().get_user_by_id(T);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cL(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();C.viewport_dimensions();if(b1.chrome){this.browser_supports_previews=j&&d6.pdf_plugins().length}else{this.browser_supports_previews=j}this.compiled_search_tmpl=fi.tmpl("search_list_item_tmpl");cE.AuthenticatedRequest({url:G({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(fn,fr){var fq,fp,T,i,fo;if(fr==null){fr=null}this.ns_id_to_mount_point=fn.ns_id_to_mount_point;this.old_path_to_ns_id=fn.old_path_to_ns_id;this.compiled_tmpl=fi.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=fn.containing_fq_path==="";this.inside_dir=fn.inside_dir;this.inside_deleted_dir=fn.inside_deleted_dir;this.inside_shared_folder=fn.inside_shared_folder;this.is_nested_shared_folder=fn.is_nested_shared_folder;this.is_nested_in_team_folder=fn.is_nested_in_team_folder;this.inside_read_only_shared_folder=fn.inside_read_only_shared_folder;this.inside_sandbox=fn.inside_sandbox;this.public_app_token=fn.public_app_token;this.public_folder_enabled=fn.public_folder_enabled;this.inside_deleted_sandbox=fn.inside_deleted_sandbox;this.inside_deleted_shared_folder=fn.inside_deleted_shared_folder;this.inside_team_folder=fn.inside_team_folder;this.golden_gate_aware=fn.golden_gate_aware;this.is_read_only=fn.is_read_only;this.ns_map=fn.ns_map;this.permanent_delete_is_disabled_by_ns_id=fn.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=fn.contents_cache_key;fp="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(fp)}else{$("browse").removeClassName(fp)}this.block_hash=fn.block_hash;this.block_hash_param=fn.block_hash_param;if(this.inside_dir){this._containing_ns_id=fn.containing_ns_id;this._containing_ns_path=fn.containing_ns_path;this._containing_fq_path=fn.containing_fq_path;this._containing_mount_point=fn.containing_mount_point;this._containing_sf_perm_role=fn.containing_sf_perm_role;this.breadcrumb();fo=[this.browse_actions,this.global_actions];for(T=0,i=fo.length;T<i;T++){fq=fo[T];if(fq!=null){fq.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(fn.file_info||fn.paginated)){this.show_message(eB('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(fn.paginated){return this._start_pagination(fn.first_page)}else{return this._push_files(fn.file_info,fr)}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(j){var i;if(j.unsupported_sort!=null){this.reset_sort()}this.paginating=true;i=ct.active_user.id;this.pagination_manager=new fm();this.pagination_manager.initialize(j,"sjid","/browse_get_next",i,(function(T){return function(fn,fo){return T._new_data_available(fn,fo)}})(this));this.pagination_manager.startAutoFetching();bF("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bF("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(fn,j){var T,i;if(!this.paginating){return}i=this._push_files(j);if(az.getGandalfRule("file-viewer-react")){e2.updateFiles(this.files)}if(!this.in_search_mode()){this.smartfill();a6.load_visible_thumbs();this.fire_visible_change_callbacks()}T=fn.loadedPageCount()===1;if(!T){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||fn.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(ct)}}document.fire(dN.NEW_PAGE,{page_files:i});bF(document).trigger(dN.NEW_PAGE,{page_files:i})}if(fn.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(i){var ft,fu,fr,fp,fo,fs,fq,fn,T;if(i==null){i=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){T=this.select_fq_paths;for(fp=0,fs=T.length;fp<fs;fp++){ft=T[fp];fr=false;fn=ft.toLowerCase();for(fo=0,fq=i.length;fo<fq;fo++){fu=i[fo];if(fu.fq_path.toLowerCase()===fn){fr=true;break}}if(!fr){return false}}return true}else{if(this.select_index>-1){return this.select_index<i.length}}return cL(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){bF("#waiting-for-items").show();bF("#global-actions").addClass("disabled");return bF("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){bF("body").removeClass("waiting_for_items");bF("#global-actions").removeClass("disabled");return bF("#waiting-for-items").hide()},_push_files:function(fo,fr){var fq,T,fp,fn,i;if(fr==null){fr=null}T=[];for(fn=0,i=fo.length;fn<i;fn++){fp=fo[fn];fq=a6.make_browsefile(fp,fr);fq.track_in_browse();T.push(fq)}P.update();return T},_get_helper:function(i){cL(this.inside_dir,"accessed "+i+", but not inside a directory");return ct[i]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fA,fy,T,fp,ft,fs,fw,fu,fr,fo,fn,fx,fv,fq,fz,i;bF("#fulltext-search-all-link").click(this.unscoped_search);bF("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bn.show_for_file.bind(bn,this.browse_actions_context_ctor));this.enable_sorting();fq="#browse-sort a.sortable-column-header";d6.add_sort_arrow_mouseover($("name-sorter"),true,fq,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bn.show_global.bind(bn,this.global_actions_context_ctor));document.observe(eY.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aH.COPY,(function(j){return function(fB){if(j.inside_dir&&fB.memo.to_fq_path===j.containing_fq_path()){return j.force_reload()}}})(this));fn=[aH.MOVE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,aH.LINKS_ADD];for(ft=0,fw=fn.length;ft<fw;ft++){T=fn[ft];fp=(function(j){return function(fB){if(j.inside_dir&&!ct.in_search_mode()){return j.force_reload()}}})(this);document.observe(T,fp);bF(document).on(T,fp)}fx=[aH.SF_LEAVE,aH.SF_UNSHARE];for(fs=0,fu=fx.length;fs<fu;fs++){T=fx[fs];document.observe(T,(function(j){return function(fB){if(j.inside_dir){if(fB.memo.target_ns_id===j.containing_ns_id()){if(fB.memo.folder_deleted){return j.reload_fqpath("")}else{return j.reload_fqpath(j.containing_fq_path())}}else{return j.force_reload()}}}})(this))}fv=[aH.DELETE,aH.PURGE];for(fo=0,fr=fv.length;fo<fr;fo++){T=fv[fo];document.observe(T,(function(j){return function(fJ){var fE,fG,fF,fD,fB,fC,fI,fH;if(j.inside_dir){if(fJ.eventName===aH.PURGE||(fJ.eventName===aH.DELETE&&!a4.get_del())){for(fG=fD=fI=j.files.length-1;fI<=0?fD<=0:fD>=0;fG=fI<=0?++fD:--fD){if(fJ.memo.files.indexOf(j.files[fG])===-1){fB=j.files[fG]}else{break}}eY.deselect_all();fH=fJ.memo.files;for(fC=0,fF=fH.length;fC<fF;fC++){fE=fH[fC];fE.get_div().remove();j.files.removeItem(fE)}if(j.files.length){if(fB!=null){return eY.set_selected_files(fB)}else{return eY.set_selected_files(j.files.last())}}else{return j.show_empty()}}else{if(j.keyboard_nav){j.select_fq_paths=[j.containing_fq_path()+"/"+fJ.memo.files.last().filename]}return j.force_reload()}}}})(this))}document.observe(bn.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bn.HIDE_EVT,this.enable_sorting.bind(this));fA=function(){var fB,j;fB=$("browse-header");j=fB.cumulativeOffset().top+fB.getHeight();return C.viewport_dimensions().height-j};key("pagedown",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,fA())});key("pageup",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,-1*fA())});fz=function(){var j;j=ct.in_search_mode()?cb:ct;if(ct.files.length===0){return j.show_empty()}else{return j.hide_empty()}};document.observe(bE.ADD,(function(j){return function(fE){var fD,fC,fF,fB;fB=fE.memo.files;for(fF=0,fC=fB.length;fF<fC;fF++){fD=fB[fF];j.insert_file(fD,true)}return fz()}})(this));document.observe(bE.REMOVE,(function(j){return function(fE){var fD,fC,fF,fB;fB=fE.memo.files;for(fF=0,fC=fB.length;fF<fC;fF++){fD=fB[fF];j.remove_file(fD)}return fz()}})(this));document.observe(bE.MOVE,(function(j){return function(fH){var fK,fB,fE,fC,fI,fG,fF,fD,fJ;fB=j.in_search_mode();fG=fH.memo.files;fD=[];for(fC=0,fE=fG.length;fC<fE;fC++){fF=fG[fC],fK=fF[0],fJ=fF[1];if(fB){if(fK!=null){fI=j.get_file_pos(fK)}else{continue}}j.remove_file(fK);j.insert_file(fJ);if(fB&&fI>=0){fD.push(j.update_file_pos(fJ,fI))}else{fD.push(void 0)}}return fD}})(this));bF(document).on(aH.COMPRESS,(function(j){return function(fD,fC){var fB;j.force_reload();if(fC.compressed_files.length===1&&fC.original_files.length===1){fB=a6.make_browsefile(fC.compressed_files.first());return j.preview_compressed(fB,fC.original_files.first())}}})(this));fy=this.fire_visible_change_callbacks.bind(this);bF(window).on("resize",fy);this._last_visible_change_timeout_id=null;i=(function(j){return function(fB){clearTimeout(j._last_visible_change_timeout_id);return j._last_visible_change_timeout_id=setTimeout(fy,250)}})(this);return bF(window).on("scroll",i)},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(T,fo){var i,j,fn;i=bF(T.target);if(i.is("img.icon")||i.closest("a.filename-link").length>0||i.closest(".filename-col__comment-count-bubble").length>0){this._click(T,fo)}if(i.is("a.parent-dir")){j=cS.from_elem(fo);if(j){fn={file_nsid:j.ns_id,file_sjid:j.sjid,firefly:cb.firefly_enabled,match_type:j.match_type,position:j.sort_rank,request_id:j.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fn)}}},dblclick:function(i,j){if($(i.target).match("a")){return}return this._click(i,j)},open_file:function(fn,i,T,j){var fo,fp;if(T==null){T=false}if(j==null){j=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fo={user_id:ct.active_user.id,context:aX.FileViewContextType.PRIVATE,platform:aX.FileViewPlatformType.WEB,ns_id:fn.ns_id,sjid:fn.sjid,ns_path:fn.ns_path,shared_link_url:null,extra:{mode:aX.FileViewModeType.BROWSE,file_ext:aA.file_extension_for_logging(fn.filename),file_bytes:fn.bytes,file_mtime:fn.ts}};fp={file_nsid:fn.ns_id,file_sjid:fn.sjid,firefly:cb.firefly_enabled,match_type:fn.match_type,position:fn.sort_rank,request_id:fn.request_id,viewport:T?"dropdown-view":"full-view"};if(fn.dir){if(this.in_search_mode()||T){fp.action_type="folder_open";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fp)}if(i){this.open_folder_in_new_window(fn)}else{this.open_folder(fn)}return ba.TimeToFirstActionLogger.log(ct.active_user.id,"folder_open")}else{if(!i&&this.can_show_preview(fn)){if(this.in_search_mode()||T){fp.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fp)}ba.TimeToFirstActionLogger.log(ct.active_user.id,"file_view");return this.open_preview(fn,j,T)}else{if(this.in_search_mode()||T){fp.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fp)}ba.FileViewLogger.log(fo);ba.TimeToFirstActionLogger.log(ct.active_user.id,"file_view");return window.open(fn.href,"_blank")}}},close_preview_callback:function(){bF(document).off("db:filepreview:close",this.close_preview_callback);af.close_shared_link_view();return ct.set_title()},preview_compressed:function(j,i){return n.show(j,ct.active_user,{files:[j,i],file_view_mode:aX.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(T,i,fn,j){if(i==null){i=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(fn==null){fn=false}if(j==null){j=false}if(this.can_show_preview(T)){a6.filepreview_from_selected(T,fn,j,i);return bF(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(T,fn){var j,i;this.keyboard_nav=false;j=cS.from_elem(fn);if(j.editing){return}i=(T.which===2)||(d6.is_mac()&&T.metaKey);ct.open_file(j,i,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);T.preventDefault()},crumb_click:function(fn,i){var T,j;this.keyboard_nav=false;fn.preventDefault();j=i.readAttribute("data-fq_path");T=this.details_from_fq_path(j);return a4.set_path_url(T.ns_id,T.ns_path)},parent_click:function(fo,fn){var T,fp,i,j;this.keyboard_nav=false;fo.preventDefault();j=fn.readAttribute("data-parent_ns_path");i=parseInt(fn.readAttribute("data-parent_ns_id"),10);a4.set_path_url(i,j);T=cS.from_elem(fn);if(T){fp={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:cb.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",ct.active_user.id,fp)}},selection_handler:function(){if(eY.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var i,T,j,fn;if(this.in_search_mode()&&!cb.end_of_results){j=a6.get_files_in_view(),fn=j[0],T=j[1];i=this.files.length-(fn+T);if(i<=50&&!$("browse").hasClassName("pending-search")){cb.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a6.load_visible_thumbs.bind(a6),this.POST_SCROLL_WAIT)},unscoped_search:function(){return cb.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var j,i;this.last_sort=ay;i="#browse-sort a.sortable-column-header";j=$$(i)[0];d6.add_sort_arrow_mouseover(j,true,i,false);$("kind-sorter-label").__date(ds.DISPLAY.FILES_BY_KIND);return cx.src(j.down("img"),"web","arrow-up-gray")},sort_handler:function(fq,T,fp){var fo,fn,i,j;T=$(T);T.blur();j=T.readAttribute("data-sort");if(fp!=null){}else{if(this.last_sort[0]===bq[j]){fp=T.readAttribute("data-ascending")==="false"}else{fp=j!=="FILES_BY_MODIFIED"}}if(ds.has_label(j)){fn=ds.next(j);$("sharing-sorter-label").__date(fn.display);j=fn.label;T.writeAttribute("data-sort",j);fp=ds.IS_ASC[j]}else{T.writeAttribute("data-ascending",(fp?"true":"false"))}i="#browse-sort a.sortable-column-header";d6.add_sort_arrow_mouseover(T,fp,i,true);fo=bq[j];this.sort(fo,fp,j);if(fq){return fq.stop()}},toggle_deleted:function(){var i;i=!a4.get_del();return a4.set_del_url(i)},unused_filename:function(fw,fB){var T,fC,fn,fu,fv,fp,fy,fo,fx,fz,fs,fq,fr,ft,fD,fA;if(fB==null){fB=false}fA=aA.filename_without_extension(fw);fD=aA.file_extension(fw,T=true);fu=[];fr=ct.files;for(fx=0,fz=fr.length;fx<fz;fx++){fC=fr[fx];fq=aA.filename_without_extension(fC.filename);fs=aA.file_extension(fC.filename,T=true);fp=fq.toLowerCase().indexOf(fA.toLowerCase())===0;fv=fD.toLowerCase()===fs.toLowerCase();fo=!fB||fC.dir;if(fp&&fv&&fo){fu.push(fC.filename.toLowerCase())}}if(fD){fD="."+fD}else{fD=""}fn=fA+fD;fy=1;while(true){if(ft=fn.toLowerCase(),cT.call(fu,ft)<0){break}fn=fA+" ("+fy+")"+fD;fy++}return fn},new_folder:function(){var fv,fn,T,fo,fs,i,j,fq,ft,fu,fp,fr;if(this.reloading||this.creating_folder){return}if(ct.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fs=new a2(ct.active_user,{element_id:"create-and-share-new-folder-modal-"+ct.active_user.id,destination_dir:this.containing_fq_path()});fs.show();return}this.hide_empty();this.selectable();T=this.unused_filename(eB("New folder"),ft=true);fr=fi.tmpl("new_folder_tmpl",{name:T,Sprite:cx,_:eB});fo=-1;if(this.files.length){fp=C.scroll_offsets();if(fp.top>0){fu=this.files[0].get_div().getLayout().get("margin-box-height");fo=Math.floor(fp.top/fu)}}if(fo>0){this.files[fo].get_div().__sert({after:fr})}else{$("browse-files").__sert({top:fr})}i=$$("#browse-files .browse-new-folder .name").first();cL(i!=null,"expected new_folder_name to be defined");fv=this.containing_fq_path();fq=(function(fw){return function(fz){var fy,fx,fA;fA=fz.responseText.evalJSON(true);cL(fA.new_browse_files.length===1,"No new file data returned.");fy=aA.filename(fA.new_browse_files.first().fq_path);fx=eB("Created folder '%(folder_name)s'");fx=fx.format({folder_name:bU.em_snippet(fy,25)});ah.success(fx);fw.select_fq_paths=[fA.new_browse_files.first().fq_path];return fw.force_reload()}})(this);j=(function(fw){return function(fy){var fx;fx=$$("#browse-files li.browse-new-folder").first();if(fx){fx.remove()}return fw.creating_folder=false}})(this);fn=new Ajax.InPlaceEditor(i,"/cmd/new"+(d6.urlquote(fv)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:j,savingText:eB("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fq,subject_user:ct.active_user},callback:(function(fw){return function(fx,fy){fw.creating_folder=true;return{to_path:fy||"",folder:"yes"}}})(this)});return fn.enterEditMode()},open_folder:function(j){var fn,i,T;cL(j.dir,"Only open directories, not files");if(ct.inside_dir&&ct.containing_ns_path()===j.ns_path&&!this.in_search_mode()){return}if(!(eY.get_selected_files().length===1&&eY.get_selected_files().indexOf(j)===0)){eY.deselect_all();fn=typeof j.get_div==="function"?j.get_div():void 0;if(fn){fn.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fo){return function(){var fp;if(!fo.reloading){return}fp=eB("Loading %(filename)s...");fp=fp.format({filename:bU.em_snippet(j.filename,50)});return fo.folder_loading_notification=ah.success(fp,60,true)}})(this),1000);if(j.target_ns){i=j.target_ns;T=""}else{i=j.ns_id;T=j.ns_path}if(j.is_deleted){return a4.set_path_url(i,T,true)}else{return a4.set_path_url(i,T)}},open_folder_in_new_window:function(i){return window.open(a4._make_url(i.ns_id,i.ns_path),"_blank")},show_message:function(T){var j,i;if((typeof T)!==(typeof"string")){i=$("browse-files").down(".browse-message");if(i){i.show()}return}this.msg=T;j=new Element("div",{"class":"browse-message"});j.__date(T);return $("browse-files").__sert(j)},sort:function(j,fo,i,fn){var T;if(!fn&&j===this.last_sort[0]&&fo===this.last_sort[1]){return}this.last_sort=[j,fo,i];T=j(fo);this.files.sort(T);this.smartfill();a6.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var fn,i,T,j;i=this.last_sort;T=i[0];fn=i[1];j=i[2];return this.sort(T,fn,j,true)},in_search_mode:function(){return bF("#browse").hasClass("search")},flex_column:function(){return $("sharing-sorter").readAttribute("data-sort")},smartfill:function(){var T,fq,fo,fr,fn,i,fs,fp;T=$("browse-files");fp=[];fr=this.in_search_mode();fs=this.files;for(fn=0,i=fs.length;fn<i;fn++){fq=fs[fn];fo=this.flex_column();fp.push(this.compiled_tmpl({file:fq,in_search_mode:fr,flex_column:fo,Browse:ct,Sprite:cx,Constants:Constants,FilePath:aA,Emstring:bU,GandalfUtil:az,_:eB}))}T.__date(fp);document.fire(dN.RENDER);return bF(document).trigger(dN.RENDER)},search_smartfill:function(ft,fn){var i,fs,fq,T,fo,fr,fp;if(fn==null){fn=null}fp=[];for(fo=0,fr=ft.length;fo<fr;fo++){fs=ft[fo];T=a6.make_browsefile(fs,fn);T.track_in_browse();fq=this.compiled_search_tmpl({file:T,BrowseInterface:fk,Browse:ct,Sprite:cx,Constants:Constants,_:eB,searchHelpers:ap,HTML:fi,FilePath:aA,Emstring:bU,Util:d6});i=bF(fq.toHTML());fp.push(i)}bF("#browse-files").append(fp);document.fire(dN.RENDER);bF(document).trigger(dN.RENDER);a6.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(i){this.files.push(i);if(i.target_ns){ct.ns_id_to_mount_point[i.target_ns]=i.fq_path}if(i.bytes<0){return this.deleted_shown=true}},insert_file:function(T,j){var i;if(!T){return}j=j||0;i=this.find_file(T.fq_path);if(i&&i!==T){this.remove_file(i)}cS._file_index[T.to_key()]=T;this.update_file_pos(T);if(j){T.get_div().setStyle({display:"none"})}document.fire(dN.RENDER);return bF(document).trigger(dN.RENDER)},add_files:function(i){return ct._push_files(i.file_info)},get_file_pos:function(i){var j;j=this.files.indexOf(i);cL(j!==-1,"file not present in @files");cL(i.to_key() in cS._file_index,"file not present in BrowseFile._file_index");return j},remove_file:function(i){var T,j;if(!i){return}T=this.files.indexOf(i);if(T!==-1){this.files.splice(T,1);delete cS._file_index[i.to_key()];return(j=i.get_div())!=null?j.remove():void 0}},update_file_pos:function(fp,fr){var i,ft,fn,fo,fq,T,j,fs;if(fr==null){fr=-1}fs=this.files.indexOf(fp);if(fs!==-1){this.files.splice(fs,1)}delete fp.sort_rank;T=this.last_sort[0];fq=this.last_sort[1];if(fr>=0){fs=fr}fo=this.in_search_mode()?fs:d6.bsearch(this.files,fp,T(fq),true);this.files.splice(fo,0,fp);fn=fp.get_div();i=$("browse-files");if(fn){fn.remove()}if(this.in_search_mode()){j=this.compiled_search_tmpl({file:fp,Browse:ct,BrowseInterface:fk,Constants:Constants,Emstring:bU,FilePath:aA,HTML:fi,searchHelpers:ap,Sprite:cx,Util:d6,_:eB})}else{j=this.compiled_tmpl({file:fp,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),Browse:ct,Constants:Constants,Emstring:bU,FilePath:aA,Sprite:cx,GandalfUtil:az,_:eB})}ft=i.childElements();if(fo<ft.length){return i.childElements()[fo].__sert({before:j})}else{return i.__sert(j)}},find_file:function(i){return this.files.find(function(j){return j.fq_path.toLowerCase()===i.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cS._file_index={};return bR._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return cb.hide_empty()},show_empty:function(){var i;this.hide_empty();if(bF("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){i="#browse-empty-team-folder"}else{i="#browse-empty"}bF(i+" .drag-prompt").toggle(!this.is_read_only);if(!ct.in_search_mode()){return bF(i).show()}},hide_empty:function(){return bF("#browse-empty, #browse-empty-team-folder").hide()},update:function(i,j){if(j==null){j=null}$("browse-box").show();if(this.in_search_mode()){return this.search_smartfill(i.file_info,j)}else{this.clear();if(typeof i==="string"){i=JSON.parse(i)}this.setup(i,j);this.resort();document.fire(dN.UPDATE);return bF(document).trigger(dN.UPDATE)}},reload_fqpath:function(j,i){return this.reload(null,d6.urlquote(j),i)},force_reload:function(){return this.reload(this.containing_ns_id(),d6.urlquote(this.containing_ns_path()),true)},set_title:function(){var i;if(ct.in_search_mode()){cb.set_title();return}if(!ct.inside_dir){return}i=this.containing_fq_path();return document.title=i?aA.filename(i)+" - Dropbox":cM.get_viewer().is_paired&&ct.active_user.role===Constants.ROLE_WORK?cM.get_viewer().team_name+" - Dropbox":cM.get_viewer().is_paired&&ct.active_user.role===Constants.ROLE_PERSONAL?eB("Personal")+" - Dropbox":eB("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(ft){var fn,T,fs,fq,fr,fp,i,fo;i=ft.select_fq_paths;fo=ft.select_index;if(i||fo>-1){T=[];if(i){for(fq=0,fr=i.length;fq<fr;fq++){fs=i[fq];fp=this.find_file(fs);if(fp){T.push(fp)}}}if(!T.length&&fo>-1){fn=this.files[fo];if(fn){T.push(fn)}}if(T.length){eY.set_selected_files(T);this.scrollToWithPadding(T.first().get_div(),100)}ft.select_fq_paths=false;return ft.select_index=-1}},set_selection_from_item_counters:function(){var fn,fs,fp,fq,fo,ft,fr,T,fu,fv;if(this.select_item_counters!=null){fp={};T=this.select_item_counters;for(fq=0,ft=T.length;fq<ft;fq++){fs=T[fq];fp[fs]=true}fv=[];fu=this.files;for(fo=0,fr=fu.length;fo<fr;fo++){fn=fu[fo];if(fn.root_coll_item_counter in fp){fv.push(fn)}}eY.set_selected_files(fv);return this.select_item_counters=null}},reload:function(fn,fs,j){var fu,fo,ft,T,fq,fp,fr,i;T="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fs+")";cL(fs.search(eE.URL_ESCAPE_REGEX)===-1,T);if(fn==null){fn=ct.active_user.root_ns}fs=aA.normalize(fs);if(a6.get_mode()!==a6.BROWSE_MODE){this.clear();a6.set_browse_mode()}if(cb._clear_on_reload){cb.clear_searchbox()}if(!aq.uploading){c1.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fs===this.containing_ns_path()&&fn===this.containing_ns_id()&&!j){return}fr=this.first_load?Constants.referrer:"";ft=this.deleted_shown?"?show_deleted=yes":"";fp={ns_id:fn,referrer:fr,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bq.FOLDERS_FIRST};fp=Object.extend(fp,this.extra_reload_args);eJ("Browse.reload:",fs);this.reloading=true;i="/browse"+fs+ft;fu=2;fo=["browse",fn,fs,ft,ct.active_user.id,fu];fq=(function(fv){return function(fw){fv.reset_state();fv.update(fw);(fv.files.length?fv.hide_empty.bind(fv):fv.show_empty.bind(fv))();clearTimeout(fv.folder_loading_timeout);if(ah.isShown()&&ah.current()===fv.folder_loading_notification){ah.clear()}C.scroll_clear_cache();if(fv._is_item_selection_needed()){if(fv.paginating&&!fv._are_all_selected_items_fetched()){fv._wait_for_items()}else{fv.set_selection_from_fq_paths_or_index(ct)}}if(!n.shown()){return fv.set_title()}}})(this);bF(document).trigger(dN.BEFORE_UPDATE,{ns_id:fn,ns_path:G.decode(fs)});new Ajax.DBRequest(i,{allow_retries:true,subject_user:ct.active_user,parameters:fp,log_timing:true,on304:function(fv){},onSuccess:(function(fv){return function(fC){var fz,fw,fy,fE,fA,fx,fB,fD;if(fv.in_search_mode()){return}fE=JSON.parse(fC.responseText);fD=null;fB=null;fq(fE);if(fD){fx=[];for(fy=0,fA=fD.length;fy<fA;fy++){fz=fD[fy];fx.push(ct.find_file(fz.fq_path))}eY.set_selected_files(fx);window.scrollTo(fB[0],fB[1])}else{ct.set_selection_from_item_counters()}if(ct.sharing_autoselect_first_file_enabled&&!eY.has_selected_files()){fw=fv.files[0];eY.set_selected_files([fw])}if(fv.first_load){return eh.mark_time_to_interactive()}}})(this),onFailure:(function(fv){return function(){if(fv.first_load){fv.reload.bind(fv).defer(Constants.root_ns,"")}return clearTimeout(fv.folder_loading_timeout)}})(this),cleanUp:(function(fv){return function(){fv.first_load=false;return fv.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return ct.inside_shared_folder&&ct.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return ct.inside_team_folder&&ct.containing_ns_path()},is_shmodelable_path:function(i){var j;if(ct.public_app_token){return false}if(i===""){return false}if(ct.public_folder_enabled){j=i.toLowerCase();if(j.startsWith("/public/")){return false}}return true},can_show_preview:function(i){var j;return this.browser_supports_previews||((j=i.preview_type)==="photo"||j==="video")},can_get_details_from_fq_path:function(T){var j,i;j=this.containing_fq_path();i=this.containing_mount_point();return(i&&T.startsWith(i))||j.startsWith(T)},details_from_fq_path:function(fn){var fo,j,i,T;cL(this.can_get_details_from_fq_path(fn));j=this.containing_mount_point();if(j&&fn.startsWith(j)){i=this.containing_ns_id();T=fn.slice(j.length);fo=aA.filename(fn,this._get_root_name())}else{i=Constants.root_ns;T=fn;fo=aA.filename(fn,this._get_root_name())}return{ns_id:i,ns_path:T,fq_path:fn,folder_name:fo||this._get_root_name(),url:String(fk.browse_uri_for_fq_path(ct.active_user,fn)),icon:(fn.length?"folder_32":this._get_root_icon())}},update_header_status:function(i){return bF("#browse-header-status").text(i)},update_header_height:function(){var j,fn,T,i;fn=bF("#browse-header");j=bF("#browse-files");i=0;if(fn.css("position")==="fixed"){i=bF(window).scrollTop()}if(!C.is_page_scrollable()){i=Math.abs(parseFloat(bF("html").css("top"))||0)}T=fn.offset().top+fn.height()-j.offset().top-i;return j.css("padding-top",T)},_make_breadcrumbs_data:function(){var fr,fs,fo,fn,fq,T,fp;fs=this.containing_fq_path();fr=[];T=fs.split("/");for(fo=fn=0,fp=T.length;0<=fp?fn<fp:fn>fp;fo=0<=fp?++fn:--fn){fq=aA.normalize(T.slice(0,fo+1).join("/"));fr.push(this.details_from_fq_path(fq))}return fr},_get_root_icon:function(){if(!cM.get_viewer().is_paired){return"glyph"}if(ct.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(ct.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cM.get_root_name(ct.active_user)},_get_max_breadcrumb_width:function(fn){var j,T,i;T=fn?this._DROPDOWN_WIDTH:new bU(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){j=bF("#browse-rightmenu").width();i=bF("#browse-global-actions-bar").width();return((i-j)*this._FUDGE_FACTOR/this._PX_TO_EM)-T}else{return this._MAX_BREADCRUMB_WIDTH-T}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var fv,fn,fq,fx,fs,fr,fu,T,fw,fo,ft,fp;fn=this._make_breadcrumbs_data();fp=fn.collect(function(i){return new bU(i.fq_path?i.folder_name:"").length});ft=0;fq=0;cL(fn.length>0,"expected at least one breadcrumb");fw=this._get_max_breadcrumb_width();for(fs=fr=fo=fn.length-1;fo<=0?fr<=0:fr>=0;fs=fo<=0?++fr:--fr){ft+=fp[fs];if(ft>fw){break}fq+=1;ft+=this._CONNECT_WIDTH}fx=fn.slice(0,fn.length-Math.max(1,fq));fn=fn.slice(fx.length,fn.length);if(!fx.length&&fn.length>1){fn.shift()}fu=fn.pop();fv=fi.tmpl("breadcrumb_tmpl",{breadcrumbs:fn,dropdown:fx,containing_fq_path:this.containing_fq_path(),url_root:fk.get_browse_root(ct.active_user),root_name:this._get_root_name(),Sprite:cx});T=fu.folder_name;if(fu.fq_path!==""){T=bU.em_snippet(T,this._get_max_breadcrumb_width(fx.length>1))}$("browse-location").__date(fv);$("browse-location").__sert(" "+T);if(fx.length>1){return this._render_breadcrumbs_dropdown(fx)}},_render_breadcrumbs_dropdown:function(fo){var fn,i,T,j;i=$("breadcrumbs-box");fo.reverse();j=fi.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fo,Sprite:cx,Emstring:bU});$("browse-location").__sert(j);T=$("breadcrumb-dropdown");fn=function(fq){var fp;fq.stopPropagation();T.show();fp=bF(i);return bF(T).clonePosition(fp,{setWidth:0,setHeight:0,offsetTop:fp[0].offsetHeight,offsetLeft:parseInt(fp.css("padding-left"),10)})};i.observe("click",fn);i.observe("dragover",fn);return document.observe("click",function(){i.removeClassName("down");return T.hide()})},viewportOffset:function(){var i,T,j;if(!this.files.length){return}if(!this.div_parent){T=this.files[0].get_div().offsetParent;if(!T){return}this._viewportOffset={};this.div_parent=$(T);this._cumulativeOffset=this.div_parent.cumulativeOffset()}i=d6.scrollLeft(this.div_parent);j=d6.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==j||this.scrollLeft!==i){this._viewportOffset.top=this._cumulativeOffset.top-j;this._viewportOffset.left=this._cumulativeOffset.left-i;this.scrollLeft=i;this.scrollTop=j}return this._viewportOffset},selectable:function(){return d6.enableSelection($("browse-files"))},unselectable:function(){return d6.disableSelection($("browse-files"))},_header_offset:(function(){var i;i=$("browse-header");return i.getHeight()+i.cumulativeOffset().top}).cached(1000),scrollTo:function(i){return this.scrollToWithPadding(i,3)},scrollToWithPadding:function(fn,fp){var T,fq,j,fo,i;if(!fn){return}fo=C.viewport_dimensions();i=C.scroll_offsets();fq=fn.cumulativeOffset().top-i.top;T=fn.getHeight();j=this._header_offset();if(fq<j){C.scroll_to(0,i.top+fq-j-fp)}else{if(fq+T>fo.height){C.scroll_to(0,i.top+fq+T-fo.height+fp)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return fd.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(i){this._visible_change_callbacks[this._next_visible_change_callback_id]=i;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(i){return delete this._visible_change_callbacks[i]},fire_visible_change_callbacks:function(){var T,fq,fn,fo,i,j,fp;if(!bF.isEmptyObject(this._visible_change_callbacks)){fo=a6.get_files_in_view(),fp=fo[0],T=fo[1];i=this._visible_change_callbacks;j=[];for(fn in i){fq=i[fn];j.push(fq(this.files,this.active_user.id,fp,T))}return j}}};k=E.BrowseUpdate=(function(){var i,fr,fq,fn,fp,fo,T,j;T=function(ft){var fu,fv,fs;if(!ct.inside_dir){return}fv=ft.parent_changes;if(fv.change_to_fq_path!=null){if(fv.change_type==="moved"){if(fv.is_changing_view){fu=eB("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fu=fu.format(fv.old_fq_path.escapeHTML(),d6.urlquote(fv.new_fq_path))}else{fu=eB("This folder has been moved")}}else{if(fv.change_type==="renamed"){if(fv.is_changing_view){fu=eB("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fu=fu.format(fv.old_fq_path.escapeHTML(),d6.urlquote(fv.new_fq_path))}else{fu=eB("This folder has been renamed to '%s'.");fs=fv.change_to_fq_path.split("/");fu=fu.format(fs[fs.length-1].escapeHTML())}}else{fu=eB("The folder '%s' has been deleted.");fu=fu.format(fv.old_fq_path.escapeHTML())}}if(fv.is_changing_view){ah.error(new fi(fu))}else{if(fv.old_fq_path===ct.containing_fq_path()){ah.success(new fi(fu))}}ct.reload_fqpath(fv.change_to_fq_path);return}return fo(ft)};j=function(fw){var fu,fv,fy,fB,fA,ft,fC,fs,fz,fx;fB=[];fx=[];if(!ct.in_search_mode()){return}cb.clear_cache();for(ft in ct.ns_id_to_mount_point){if(!(ft in fw.mount_points)){fw.mount_points[ft]=null}}fs=fw.mount_points;for(ft in fs){fA=fs[ft];ft=parseInt(ft,10);fC=ct.ns_id_to_mount_point[ft];if(fA===fC){continue}if(fA){ct.ns_id_to_mount_point[ft]=fA}else{delete ct.ns_id_to_mount_point[ft]}fz=ct.files;for(fv=0,fy=fz.length;fv<fy;fv++){fu=fz[fv];if(fu.fq_path.indexOf(fC)===0&&fu.target_ns!==ft){if(fA){fu.fq_path=fA+fu.fq_path.slice(fC.length);fu.href=fk.get_browse_root(ct.active_user)+fA+fu.href.slice(5+fC.length);fB.push([fu,fu])}else{fx.push(fu)}}}}return fo(fw,[],fx,fB)};fo=function(fP,fw,fM,fv){var fD,fs,fN,fE,fI,ft,fK,fJ,fL,fy,fx,fH,fu,fC,fB,fA,fG,fF,fO,fz;if(fw==null){fw=[]}if(fM==null){fM=[]}if(fv==null){fv=[]}fu=fP.added;for(fK=0,fL=fu.length;fK<fL;fK++){fN=fu[fK];fs=aA.normalize(aA.parent_dir(fN.ns_path));if(ct.in_search_mode()||(fN.ns_id===ct.containing_ns_id()&&fs===ct.containing_ns_path())){fD=a6.make_browsefile(fN);fD.track_in_browse();fw.push(fD)}}fC=fP.removed;for(fJ=0,fy=fC.length;fJ<fy;fJ++){fE=fC[fJ];fM.push(ct.find_file(fE))}fB=fP.moved;for(fH=0,fx=fB.length;fH<fx;fH++){fA=fB[fH],fI=fA[0],fz=fA[1];fO=aA.normalize(aA.parent_dir(fz.ns_path));fF=null;fG=ct.in_search_mode()||(fz.ns_id===ct.containing_ns_id()&&fO===ct.containing_ns_path());ft=ct.in_search_mode();if(fG&&!(ft&&ct.find_file(fz.ns_path))){fF=a6.make_browsefile(fz);fF.track_in_browse()}fv.push([ct.find_file(fI),fF])}document.fire(bE.ADD,{files:fw});bF(document).trigger(bE.ADD,{files:fw});document.fire(bE.MOVE,{files:fv});a6.load_visible_thumbs();ct.fire_visible_change_callbacks();return fp(fw,fM,fv)};i=function(fv,ft,fu,fs){fv.css("background","");bF(document).trigger(dN.UPDATE_RENDERED);return document.fire(bE.REMOVE,{files:fu})};fp=function(fD,fB,fE){var fv,fG,fA,fx,fC,fz,fw,fu,fs,ft,fy,fF;fy=(fD.length+fB.length)<=10;for(fA=0,fC=fD.length;fA<fC;fA++){fv=fD[fA];if(!(fv&&fv.get_div())){continue}fr(fv,fy,fD,fB,fE)}for(fx=0,fz=fB.length;fx<fz;fx++){fv=fB[fx];if(!(fv&&fv.get_div())){continue}fn(fv,fy,fD,fB,fE)}ft=[];for(fu=0,fw=fE.length;fu<fw;fu++){fs=fE[fu],fG=fs[0],fF=fs[1];if(fG){fn(fG,fy,fD,fB,fE)}if(fF){ft.push(fr(fF,fy,fD,fB,fE))}else{ft.push(void 0)}}return ft};fq=function(fs){var ft;ft=eY.is_selected(fs)?"#83B8DC":"#CCEAFF";return bF(fs.get_div()).css("background-color",ft)};fn=function(fs,fv,fu,fw,ft){var fx;fq(fs);fx=bF(fs.get_div());if(fv){return fx.show().slideUp("normal",function(){return i(fx,fu,fw,ft)})}else{fx.hide();return i(fx,fu,fw,ft)}};fr=function(fs,fv,fu,fw,ft){var fx;fq(fs);fx=bF(fs.get_div());if(fv){return fx.hide().slideDown("normal",function(){return i(fx,fu,fw,ft)})}else{fx.show();return i(fx,fu,fw,ft)}};return{init:function(){var ft,fs;fs=d9[ct.active_user.id];return ft=fs.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fA,fx,fz,fw,fu,fy,fv;fw=ct.in_search_mode();fA=fw?j:T;fv=fw?"/update/list_search":"/update/list_dir";if(!(ct.inside_dir||fw)){fs.handler_failure(ft);return}if(fw){fy=cb.get_state();fz={all_terms:fy.query}}else{fz={fq_dir:ct.containing_fq_path(),show_deleted:ct.deleted_shown}}fz.ns_map=((function(){var fC,fB;fC=fs.get_ns_map();fB=[];for(fx in fC){fu=fC[fx];fB.push(fx+"_"+fu)}return fB})()).join(",");cL(ct.active_user,"No active_user was set before calling "+fv+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);return new bF.ajax(fv,{data:fz,dataType:"json",type:"POST",subject_user:ct.active_user,success:function(fB){fA(fB);return fs.handler_success(ft,{ns_map:fB.ns_map})},error:function(){return fs.handler_failure(ft)}})}})}}})();var ed;ed=E.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(j,fo){var fn,T,i;if(j.async_task_id){if(!j.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}T=j.async_task_id}else{T=j.job_id}ed.job_info[T]={};fn=ed.job_info[T];fn.subject_user=j.subject_user||((i=j.parameters)!=null?i[a9.UID_PARAM_NAME]:void 0);fn.req=j;fn.is_async_task=!!j.async_task_id;fn.poll_int=ed.INIT_POLL_INT;fn.poll_count=0;fn.int_id=setInterval(ed.update_for(T),fn.poll_int);fn.failures=0;fn.start_time=b6.time();return fn.dont_hide=fo},update_for:function(i){return function(){return ed.update(i)}},backoff:function(j){var i;i=ed.job_info[j];clearInterval(i.int_id);i.poll_int=Math.min(Math.floor(i.poll_int*1.5),30000);return i.int_id=setInterval(ed.update_for(j),i.poll_int)},update:function(T){var i,j;j=ed.job_info[T];if(dl.peek(T)){return ed.done(T)}j.poll_count++;if(j.poll_count%10===0){ed.backoff(T)}if(!j.modaled&&b6.time()-j.start_time>ed.MODAL_WAIT_MS){i=j.req.options;eC.show(i.progress_text);i.onProgress=eC.update;if(i.on_modal_shown!=null){i.on_modal_shown()}j.modaled=true}if(j.is_async_task){return ed.get_async_task_status(T)}else{return ed.get_job_status(T)}},get_job_status:function(i){return new Ajax.DBRequest("/job_status/"+i,{method:"post",subject_user:ed.job_info[i].subject_user,onSuccess:function(T){var fn,j;fn=ed.job_info[i];j=T.responseText;if(j.indexOf("err")===0){ed.done(i);if(fn.req.options.onFailure&&!dl.handled(i)){fn.req.options.onFailure(T)}return}if(j.indexOf("done")===0){fn.req.options.job=false;if(!dl.peek(i)){new Ajax.Request("/job_results/"+i,{method:"post",parameters:{t:bw.read(aK.JS_CSRF_COOKIE)},onSuccess:function(fp){if(dl.handled(i)){return}ar.clearWorkingMessage();if(fn.req.options.onSuccess){return fn.req.options.onSuccess(fp)}},onFailure:function(fp){if(dl.handled(i)){return}ar.clearWorkingMessage();if(fn.req.options.onFailure){return fn.req.options.onFailure(fp)}}})}return ed.done(i)}else{try{if(fn.req.options.onProgress){return fn.req.options.onProgress(T.responseText)}}catch(fo){}}},onFailure:function(j){var T;T=ed.job_info[i];T.failures++;if(T.failures>=ed.FAILS_MEAN_FAIL){if(T.req.options.onFailure){T.req.options.onFailure(j,true)}ar.remove(T.req);return ed.done(i)}}})},get_async_task_status:function(i){return new Ajax.DBRequest("/async_task_status/"+i,{method:"post",subject_user:ed.job_info[i].subject_user,onSuccess:function(T){var fn,j;fn=ed.job_info[i];j=T.responseText;if(j.indexOf("done:")===0||j.indexOf("err:")===0){dl.handled(i);ar.clearWorkingMessage();if(j.indexOf("done:")===0){T.responseText=j.substr(5)}if(fn.req.options.onSuccess){fn.req.options.onSuccess(T)}if(fn.req.options.onComplete){fn.req.options.onComplete(T)}return ed.done(i)}else{if(j.indexOf("async_task_err:")===0){ah.error(new fi(j.substr(15)));dl.handled(i);ar.clearWorkingMessage();ed.done(i);return ct.force_reload()}else{try{if(fn.req.options.onProgress){return fn.req.options.onProgress(T.responseText)}}catch(fo){}}}},onFailure:function(j){var T;T=ed.job_info[i];T.failures++;if(T.failures>=ed.FAILS_MEAN_FAIL){try{if(T.req.options.onFailure){T.req.options.onFailure(j,true)}}catch(fn){}ar.remove(T.req);return ed.done(i)}}})},done:function(j){var i;i=ed.job_info[j];clearInterval(i.int_id);if(!i.dont_hide){delete ed.job_info[j];if(!(i.req.async_task_id&&i.req.async_task_id!==j)){return eC.hide(j)}}else{return eC.update("1/1")}}};var du,bY,bC,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};bC=E.NamespaceEvents=(function(){function i(j){this.ns_id=j;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return i})();du=E.EventDatePicker=(function(){function i(T){var j,fn,fo;this.on_change=T;bF(document.body).on("click",(function(fp){return function(fq){return fp.hide_calendar(fq)}})(this));fo=new Element("div",{id:"cal_container"});bF(fo).bind("click",function(fp){return fp.preventDefault()});bF(document.body).append(fo);this.calendar=new I("cal_container",{onDateChange:(function(fp){return function(fq){return fp.on_change(fq)}})(this),disable_future:true});bF(fo).css("position","fixed");fn=bF("#cal_date");j=bF("#cal_container");j.clonePosition(fn,{setWidth:false,setHeight:false,offsetTop:fn.height(),offsetLeft:fn.width()-j.children().first()[0].offsetWidth});this.hide_calendar()}i.prototype.show_calendar=function(j){if(this.shown){bF("#cal_container").hide();this.shown=false;return}bF("#cal_container").show();return this.shown=true};i.prototype.hide_calendar=function(j){if(j&&bF(j.target).closest("#cal_date").length>0){return}bF("#cal_container").hide();this.shown=false;return true};return i})();bY=INLINE_JS.Events=E.Events={ns:null,role:"all",now:Number(new Date()),timestamp:d6.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(i,fp,fr,T,fq){var fn,fo,j;if(fq==null){fq=false}this.awaitingFirstRender=true;j=eE.deconstruct_url();this.first_event_map=i;this.roles=fp;this.rss_data=fr;this.role_has_events=T;this.deletions_only=fq;this.role_picker=C.controller(bF("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(j.qargs.role){this.role=j.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new du((function(fs){return function(ft){fs.change_date(ft);fs.set_url();return ba.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fs){return function(){fs.role=fs.role_picker.get_state();if(fs.ns&&!bx(fs.valid_roles()).any(function(ft){return ft.ns_ids.contains(fs.ns.ns_id)})){fs.ns=null;aS.set_selected_by_value(bF("#namespace-list")[0],"false")}fs.set_url();return fs.get_more(true)}})(this);bO.set_during_login_callback((function(fs){return function(fu,ft){return window.location.reload()}})(this));bF(window).bind("beforeunload",(function(fs){return function(){fs.user_navigated_away=true;return void 0}})(this));if(bF("#namespace-list-container")[0]){bF("#namespace-list-container")[0].observe("db:change",(function(fs){return function(ft){fs.ns=fs.namespaces[JSON.parse(ft.memo)];fs.set_url();fs.get_more(true);return ba.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bF(window).on("scroll",(function(fs){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-C.viewport_dimensions().height-10);return fs.get_more()}})(this));if(j.qargs.ns){aS.set_selected_by_value(bF("#namespace-list")[0],j.qargs.ns);this.ns=this.namespaces[j.qargs.ns]}if(j.qargs.date){fo=j.qargs.date.split("-").map(Number);fn=new Date(fo[2],fo[1]-1,fo[0]);this.date_picker.calendar.selected_date=fn;this.change_date(fn)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var fs,fr,fn,fq,T,ft,fp,fo;this.namespaces={};ft=bx(this.roles).values();for(fs=0,fn=ft.length;fs<fn;fs++){fo=ft[fs];fp=fo.ns_ids;for(fr=0,fq=fp.length;fr<fq;fr++){T=fp[fr];this.namespaces[T]=new bC(T)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(i){this.timestamp=Number(i)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bF("#cur_date_text").text(N.localize(i));return this.get_more(true)},is_scrolled_down:function(){var i,T,j;j=C.scroll_offsets().top;T=C.viewport_dimensions().height;i=bF("#events").height();return j+T+50>=i},get_more:function(fn){var i,j,T;if(this.request_in_flight){return}if(bx(this.valid_nss()).all(function(fo){return fo.done})){this.render();return}if(!(fn||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();j=(function(fo){return function(){return bx(fo.valid_nss()).map(function(fp){return fp.ns_id}).join(",")}})(this);i=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));T={page_size:25,ns_ids:j(),timestamp:i};if(this.deletions_only){T.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:T,onSuccess:(function(fo){return function(fD){var fw,fp,fx,fu,ft,fz,fv,fs,fC,fr,fB,fq,fA,fy;fw=JSON.parse(fD.responseText);fo.request_in_flight=false;fq=fw.events;for(fx=0,fz=fq.length;fx<fz;fx++){fp=fq[fx];fp.html=bF(fp.html)[0];fB=fp.pkey+" "+(fp.html.textContent||fp.html.innerText);fC=fo.namespaces[fp.ns_id];if(!fC.seen[fB]){fC.events.push(fp);fC.seen[fB]=true;fC.earliest=fp.timestamp}}if(fw.events.length>0){fA=fw.ns_ids;for(fu=0,fv=fA.length;fu<fv;fu++){fr=fA[fu];fo.namespaces[fr].earliest=bx(fw.events).map(function(fE){return fE.timestamp}).min()}}fo.render();if(fw.events.last()){fo.get_more()}else{if(bx(fw.ns_ids).join(",")!==j()){fo.get_more()}else{fy=fw.ns_ids;for(ft=0,fs=fy.length;ft<fs;ft++){fr=fy[ft];fo.namespaces[fr].done=true}}}return at.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fo){return function(){fo.request_in_flight=false;if(!fo.user_navigated_away){return ah.error(eB("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return bx(this.roles).filter((function(i){return function(j){return j.role===i.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().map((function(i){return function(j){return i.namespaces[j]}})(this)).uniq()}},earliest:function(){return bx(this.valid_nss()).map((function(i){return function(j){return j.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=d6.start_of_day(new Date(bx(this.valid_nss()).map((function(i){return function(j){return i.first_event_map[j.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=d6.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var T,fn,j,i;j=new Date(this.timestamp-this.one_day);fn=this.now-this.timestamp>0;T={};if(this.ns){T.ns=this.ns.ns_id}if(this.role!=="all"){T.role=this.role}if(fn){T.date=(j.getDate())+"-"+(j.getMonth()+1)+"-"+(j.getFullYear())}i=this.deletions_only?"/deleted_files":"/events";return eE.push_state(i,T)},on_preview_open:function(j){var i;i=cM.get_viewer().get_user_by_id(j.user_id);bF(document).on("db:filepreview:close",this.on_preview_close);n.show(j,i);return false},on_preview_close:function(){bF(document).off("db:filepreview:close",this.on_preview_close);return document.title=eB("Recent events - Dropbox")},render:function(){var fn,fC,fG,fF,fu,fD,fH,fB,fE,fv,ft,fr,fx,fI,fz,fo,fs,fw,fq,fy,fA,T,fp;if(this.role_has_events[this.role]){this.update_calendar_first_day()}fn=bx(this.valid_nss()).map((function(i){return function(j){return j.events}})(this)).flatten();fC=this.earliest();T=bx(fn).sortBy(function(i){return -i.timestamp});fu=bx(T).filter((function(i){return function(j){return j.timestamp>=fC&&j.timestamp<i.timestamp/1000&&(i.ns!==null||!j.is_dup)}})(this));if(this.role_has_events[this.role]){bF("#event-table").empty();for(fD=0,fE=fu.length;fD<fE;fD++){fs=fu[fD];fG=bF(fs.html);fw=bx(this.valid_roles()).filter((function(i){return function(j){return j.ns_ids.contains(fs.ns_id)}})(this)).map((function(i){return function(j){return j.name}})(this)).join(" & ");if(this.deletions_only){fG.find("span.role-path").text(fw)}else{fG.find("span.role-label > span").text(fw)}bF("#event-table").append(fG);if(fs.preview_jsinfo!=null){fF=fs.preview_jsinfo;ft=fG.find("#prev_link");ft.on("click",this.on_preview_open.bind(this,fF));fA=fG.find(".inline-button");fA.on("click",this._inline_share_button.bind(this,fF))}}bF("#events-container").show();bF("#events-sub-header").show();bF("#events-sub-header").css("visibility","visible");bF("#events-empty-state").hide();bF(".empty-explanation").hide()}else{if(!this.request_in_flight){bF("#events-container").hide();bF("#events-sub-header").hide();bF("#events-empty-state").show();bF(".empty-explanation").show()}}if(!this.request_in_flight){if(this.awaitingFirstRender){this.awaitingFirstRender=false;ba.WebMiscActivityLogger.log("events-first-load",{time:Number(new Date())-this.now})}bF("#more-loading").hide()}else{bF("#more-loading").show()}bF("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fr=bF("#namespace-list > li");for(fB=0,fv=fr.length;fB<fv;fB++){fH=fr[fB];fo=bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().any((function(i){return function(j){return j===bF(fH).data("value")}})(this));fz=bF(fH).data("value")===false;fp=fz||fo;bF(fH).css("display",fp?"":"none")}fy=cT.call((function(){var fJ,j,i,fK;i=this.valid_roles();fK=[];for(fJ=0,j=i.length;fJ<j;fJ++){fI=i[fJ];fK.push(fI.ns_ids.length>1)}return fK}).call(this),true)>=0;if(!this.request_in_flight){if(fy){bF("#namespace-list-container").css("visibility","visible");bF("#namespace-list-container").show()}else{bF("#namespace-list-container").hide()}fq=this.rss_data[(fx=this.ns)!=null?fx.ns_id:void 0]||this.rss_data[this.role];if(fq&&this.role_has_events[this.role]){bF("#rss-feed a").attr("data-title",fq.title);bF("#rss_url").val(fq.url);bF("#reset-rss-link").on("click",(function(i){return function(j){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fq.ns_id},onSuccess:function(){ah.success(eB("RSS feed url successfully reset."));return b1.redirect("/events")}});return false}})(this));bF("#rss_url").focus();bF("#rss-feed").show();return bF("#rss-feed").css("visibility","visible")}else{return bF("#rss-feed").hide()}}},show_rss_modal:function(){var i,j;fd.show(eB("Subscribe to this RSS feed"),bF("#rss-modal")[0]);j=bF("#rss_url").val();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eB("Link copied to clipboard!"));return fd.hide()},bF(".modal-buttons"));return i.css({zIndex:1001})},_inline_share_button:function(j,fn){var i,T;fn.preventDefault();i="events_table_row";T=ba.ShmodelUILogger.get_target_item(j);ba.ShmodelUILogger.log("single_entry_share",i,T);return new dh(j.user_id,j.fq_path,i).show()}};var N;N=E.DateUtil={fromSecondsSinceEpochUTC:function(i){var j;j=new Date(1970,0,1);j.setSeconds(i);return j},applyTimezoneOffset:function(j,fn){var i,T;i=parseInt(fn,10);T=60*(fn-i);j.setHours(j.getHours()+i);return j.setMinutes(j.getMinutes()+T)},contextualFormat:function(j){var fn,fp,i,T,fo;i=new Date(Date.now());T=(i.getTime()-j.getTime())/1000;fn=0;if(T<8*3600){return b6.ago(j)}this.applyTimezoneOffset(i,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(j,Constants.TIMEZONE_OFFSET);fo=new Date(Date.now());this.applyTimezoneOffset(fo,Constants.TIMEZONE_OFFSET);fo.setDate(fo.getDate()-1);if(j.getYear()===i.getYear()&&j.getMonth()===i.getMonth()&&j.getDate()===i.getDate()){fp=eB("Today %(time)s");return fp.format({time:N.format(j,Constants.time_format)})}else{if(j.getYear()===fo.getYear()&&j.getMonth()===fo.getMonth()&&j.getDate()===fo.getDate()){fp=eB("Yesterday %(time)s");return fp.format({time:N.format(j,Constants.time_format)})}else{return N.format(j,Constants.datetime_format)}}},toUTCDate:function(i){return new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())},differenceStr:function(fn,fq){var fs,fr,j,T,fo,i,fp;fo=(fn.getTime()-fq.getTime())/1000;if(fo<60){return bd("%d sec","%d secs",fo).format(fo)}else{if(fo<3600){j=parseInt(fo/60,10);return bd("%d min","%d mins",j).format(j)}else{if(fo<86400){fr=parseInt(fo/3600,10);return bd("%d hour","%d hours",fr).format(fr)}else{if(fo<2592000){fs=parseInt(fo/(60*60*24),10);return bd("%d day","%d days",fs).format(fs)}else{if(fo<4838400){i=parseInt(fo/(60*60*24*7),10);return bd("%d week","%d weeks",i).format(i)}else{if(fo<31536000){T=parseInt(fo/(60*60*24*30),10);return bd("%d month","%d months",T).format(T)}else{fp=parseInt(fo/(60*60*24*365),10);return bd("%d year","%d years",fp).format(fp)}}}}}}},localize:function(i){cL(Constants.date_format!=null,"Date format missing.");return N.format(i,Constants.date_format)},format:function(i,j){var T;cL(typeof j==="string","Date format requires a format string");T={yy:(function(fn){return function(){return i.getFullYear().toString().substring(2)}})(this),yyyy:(function(fn){return function(){return i.getFullYear().toString()}})(this),M:(function(fn){return function(){return(i.getMonth()+1).toString()}})(this),MM:(function(fn){return function(){return(i.getMonth()+1).toString().lpad(2)}})(this),d:(function(fn){return function(){return i.getDate().toString()}})(this),dd:(function(fn){return function(){return i.getDate().toString().lpad(2)}})(this),h:(function(fn){return function(){return(i.getHours()%12||12).toString()}})(this),H:(function(fn){return function(){return i.getHours().toString()}})(this),HH:(function(fn){return function(){return i.getHours().toString().lpad(2)}})(this),m:(function(fn){return function(){return i.getMinutes().toString()}})(this),mm:(function(fn){return function(){return i.getMinutes().toString().lpad(2)}})(this),a:(function(fn){return function(){if(i.getHours()>11){return eB("PM",{comment:"PM as in evening"})}else{return eB("AM",{comment:"AM as in morning"})}}})(this)};return j.replace(/([a-zA-Z]+)/g,function(fn){if(T[fn]!=null){return T[fn]()}else{return fn}})}};var eR;eR=INLINE_JS.Timezone=E.Timezone={check_timezone:function(){var i;if(!cM.get_viewer().is_signed_in){return}i=eR.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==i){return eR.update(i)}},get_current_timezone:function(){var fn,T,i,j;T=new Date();T.setSeconds(0);T.setMilliseconds(0);j=T.toGMTString();fn=new Date(j.substring(0,j.lastIndexOf(" ")));i=(T-fn)/(1000*60*60);return i},update:function(i){cL(typeof i==="number","Timezone offset was not a number: "+i);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:i},noAutonotify:true})},update_timezones_dropdown:function(j,fn){var T,i;if(fn==null){fn=null}i=eR.timezones_by_country[j];bF("#timezone_id").empty();return bF("#timezone_id").append((function(){var fq,fo,fp;fp=[];for(fq=0,fo=i.length;fq<fo;fq++){T=i[fq];fp.push(bF('<option value="'+T.id+'">'+T.name+"</option>").prop("selected",T.id===fn))}return fp})())},auto:function(){var i;i=$F("timezone_auto");if(i){return bF("#tz").hide()}else{if(eR.default_country){bF("#timezone_country").val(eR.default_country);eR.update_timezones_dropdown(eR.default_country)}return bF("#tz").show()}},load_data:function(j,i){eR.timezones_by_country=j;return eR.default_country=i}};var bi,bK;bK=E.CreateApp={init:function(fn,j){var T,fo,i;this.accepted_tos_by_uid=fn;this.form=T=bF("#create-app-form");this.email_verification=null;if(!cM.get_viewer().is_paired){i=cM.get_viewer().get_users()[0];this.select_user(i.id)}fo=(function(fp){return function(fq){var fr;fr=fq.target.name;return T.find("input[name="+fr+"]").each(function(){bF(this).parents("label").removeClass("active");return T.removeClass(bF(this).data("next"))})}})(this);T.find("input[type=radio]").change(function(fp){fo(fp);bF(fp.target).parents("label").addClass("active");return T.addClass(bF(this).data("next"))});T.find("input[type=checkbox]").change(function(fp){var fq;if(bF(this).filter("#accept-tos").length){return}bF(fp.target).parents("label").toggleClass("active");fq=T.find("input[name="+(bF(this).attr("name"))+"]:checked");T.toggleClass(bF(this).data("next"),fq.length!==0)});T.find(".role-choice input").change((function(fp){return function(fr){var fq,fs;fq=T.find(".role-choice input:checked");fs=fq.val();if(!cM.get_viewer().is_uid_signed_in(fs)){fq.prop("checked",false);fo(fr);bO.show_modal({user_id:fs,on_success:function(){return fq.prop("checked",true).trigger("change")}});return false}else{return fp.select_user(fs)}}})(this));T.find("input:checked").trigger("change");T.find("input[name=tos_accept]").change((function(fp){return function(fq){return fp.update_submit_enabled()}})(this));T.find("#send-verify-email, #resend-verify-email").click((function(fp){return function(fq){fp.email_verification.send_email(j,function(){T.addClass("verify-email-sent");fp.email_verification.flash_email_sent_notification();return fp.email_verification.ensure_polling(function(){if(!fp.email_verification.user.is_email_verified){return}T.addClass("email-verified");T.removeClass("verifiy-email-sent");T.removeClass("email-unverified");return fp.update_submit_enabled()})});return false}})(this));return T.submit(function(fp){T=bF(fp.target);bT.ajax_submit(T[0],false,(function(fq){return window.location.href=fq.responseText}));return false})},select_user:function(i){this.email_verification=d4.get_for_user(cM.get_viewer().get_user_by_id(i));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[i]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var j,i;i=this.email_verification.user;j=this.accepted_tos_by_uid[i.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!j)}};bi=INLINE_JS.Apps=E.Apps={init_apps:function(){return bF("#show-disabled-apps").click(function(){bF(this).parent().hide();bF("#disabled-apps").show();return false})},init_app_info:function(j,T,i){this.user_email=i;bF("#app-info .icon-container").each(function(fo,fp){var fn;fn=bF(fp);return fn.append(Dropbox.createChooseButton({success:function(fq){fn.find(".icon").attr("src",fq[0].thumbnailLink);return fn.find("input[type=hidden]").val(fq[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=fi.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=fi.tmpl("webhook_info_row_tmpl");bF("#domain-list").on("click",".img-container",function(fn){bi.remove_domain(fn.currentTarget.parentNode,j)});bF("#oauth-uri-list").on("click",".img-container",function(fn){bi.remove_oauth_uri(fn.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".img-container",function(fn){bi.remove_webhook(fn.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(fn){bi.update_webhook_url(fn.currentTarget,j,false)});bF("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(fn){bi.update_webhook_url(fn.currentTarget,j,true)});bF("#generate-token-button").on("click",function(fn){bi.generate_access_token(j)});bF("#delete-app-button").on("click",function(fn){bi.confirm_disable(T,j,0)});bF("#webhook_url").on("click change paste focus",function(fn){bF("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bF("#oauth2-allow-implicit-grant").on("change",function(fn){return bi.set_oauth2_allow_implicit_grant(fn.currentTarget,j)})},init_app_info_add_redirect_uri:function(){var i,j,T,fn;j=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!j){return}fn=window.decodeURIComponent(j[1]);i=bF("#oauth-add-uri-form");bF("input[name=oauth_uri]",i).val(fn);T=bF("#add-redirect-uri-modal")[0];bF("#add-redirect-uri-modal-uri").text(fn);fd.show(eB("Add OAuth redirect URI"),T,{doit:function(){var fo;if(window.history&&window.history.replaceState){fo=window.location.href;fo=fo.substring(0,fo.indexOf("#"));window.history.replaceState({},document.title,fo)}else{window.location.hash=""}fd.hide();return bi.submit_new_oauth_uri(bF("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(i){this.ds_info=i;if(cM.get_viewer().is_paired){this.role_picker=C.controller(bF("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bO.set_during_login_callback((function(j){return function(fn,T){return j.app_datastores_browse_reload_info(function(){return T()},function(){T("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(j,i){bF.ajax({url:"/developers/apps/datastores/info",success:(function(T){return function(fn){T.ds_info=fn;T.app_datastores_browse_render();return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(fn){return typeof i==="function"?i(fn):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var fn,T,j,i;T=bF("#no_apps_container").empty();if(bF("#apps_developed_container").children().length!==0||bF("#apps_used_container").children().length!==0){return}fn=bF("<div class='empty-state'></div>").appendTo(T);switch((j=this.role_picker)!=null?j.get_state():void 0){case d2.PERSONAL:case d2.WORK:i=cM.get_viewer().get_user_by_role(this.role_picker.get_state());return fn.append("You don't have any datastores in your "+cM.get_role_title(i)+" Dropbox.");default:return fn.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fs){var fn,fr,fo,fq,T,i,fp;fq=this.app_datastores_browse_get_id_info(fs);fr=bF(fs);fr.empty();fn="";for(T=0,i=fq.length;T<i;T++){fo=fq[T];if(this.app_datastores_should_render(fo.uid)){fn+=fo.html}}if(fn){fr.append(this.app_datastores_browse_get_id_header(fs));fp=bF("<div class='app-list clearfix'/>").appendTo(fr);return fp.html(fn)}},app_datastores_should_render:function(j){var i;if(this.role_picker!=null){i=cM.get_viewer().get_user_by_id(j);return this.role_picker.is_role_visible(i.role)}else{return true}},app_datastores_browse_get_id_info:function(i){switch(i){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cL(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(i){switch(i){case"#apps_developed_container":return bF("<h2>Apps you develop</h2>");case"#apps_used_container":return bF("<h2>Apps you use</h2>");default:return cL(false,"invalid ds group id")}},generate_access_token:function(j){var fn,T,i;i=this;fn=bF("#generate-token-button");T=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fn.replaceWith(T);return bF.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:j},dataType:"json",success:function(fp){var fo;if(fp.status==="ok"){fo=bF("<div>").append(bF("<input>").attr("id","generated-token").attr("type","text").attr("value",fp.token).prop("readonly",true).click(function(){return bF(this).select()}));fo.append(bF("<div>").addClass("detail-text").text(fp.warning))}else{if(fp.status==="error"){fo=bF("<div>").addClass("detail-text").addClass("error").text(fp.msg)}}return T.replaceWith(fo)},error:function(){return ah.error("Unable to complete your request.")}})},confirm_disable:function(fn,T,j){var fo,i;fo=(j?eB("Are you sure you want to disable '%(app_name)s'?"):eB("Are you sure you want to delete '%(app_name)s'?"));dv.fillVal(fo.format({app_name:fn.escapeHTML()}),"app-disable-text");fd.show((j?eB("Confirm disable"):eB("Confirm delete")),$("app-disable-modal"));i="/developers/disable_app/"+T;$("app-disable-modal").down("form").action=i;return $("disable-app-button").setValue((j?eB("Disable"):eB("Delete")))},enable_app:function(j){var i;i="/developers/enable_app/"+j;return window.location.href=i},show_uninstall:function(fp,fo,T,j,fn,i){var fq;if(fp){Event.stop(fp)}fd.vars={app_id:T,user_id:i};fq=bF("#delete-"+j+"-app-confirm");if(j==="sandbox"){if(!fn){bi.do_uninstall();return}bF(".app_folder",fq).text(fn)}bF(".app_name",fq).text(fo);fd.show(eB("Remove %(app_name)s?").format({app_name:bU.em_snippet(fo,22)}),fq[0],fd.vars);return null},do_uninstall:function(){var i;i=fd.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fd.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(j){var T;ah.success(j.responseText);T=bF(".apps-"+i);bF("#inst-app-"+fd.vars.app_id+"-row",T).hide().removeClass("active_app");if(bF(".active_app",T).length===0){T.hide()}if(bF(".active_app").length===0){bF("#empty-explanation").text(eB("You have no apps linked to your Dropbox."));return bF("#applications-explanation",T).remove()}},subject_user:i});return fd.hide()},enable_users_in_dev:function(i,j){new Ajax.DBRequest("/developers/enable_users_in_dev/"+i,{onSuccess:function(T){fd.show(eB("Limit raised to %d users").format(j),$("increased-dev-user-limit-modal"));bF("#users-in-dev-none, #users-in-dev-some").hide();return bF("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(i){fd.show(eB("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+i,{onSuccess:function(j){bF("#current-app-users-1, #current-app-users-2").text("0");return fd.hide()}})}});return false},unlink_all_teams_in_dev:function(i){fd.show(eB("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bF.ajax({url:"/developers/unlink_all_teams/"+i,type:"POST",success:function(j){bF("#current-app-teams").text("0");return fd.hide()}})}});return false},restore_sandbox:function(j,fn,i){var fp,T,fo;fp=bF("#restore-sandbox")[0];fd.show(eB("Restore app folder '%(filename)s'").format({filename:bU.em_snippet(aA.filename(fn),17)}),fp);fo=bF("#restore-sandbox-form")[0];T={ns_id:i};T[a9.UID_PARAM_NAME]=j.id;return bT.add_vars(fo,T)},submit_restore_sandbox:function(j){var i;i=$("restore-sandbox-form");bT.ajax_submit(i,false,(function(T){fd.hide();ah.success(eB("Restored app folder"));if(T.responseText.length){return ct.reload_fqpath(T.responseText)}else{return ct.reload("","",true)}}),false,j.target);return false},submit_app_info:function(i){var j;j=bF(i).find("input[name=name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App info updated.");if(j){return bF("#app-info h1").text(j)}}))},submit_folder_name:function(i){var j;j=bF(i).find("input[name=folder]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App folder name updated.");bF("#folder-name .text").text(j);return bi.hide_folder_input()}))},submit_new_webhook:function(j){var T,fw,fu,fp,fr,fq,fv,ft,fo,fs,fn,i;fw=bF(j);fr=bF("#webhook-list");fp=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fu=fw.find("input[name=webhook_url]");fn=function(fy,fx){if(fx){fx.remove()}if(fr.find(".hoverable-url").length===0){fr.addClass("hide-status")}bF("#webhook-form-error").text(fy);return bF("#webhook-form").addClass("error")};fv=fu.val();if(fv===""){fn("Empty URI");return}ft=G.parse(fv);if((fo=ft.scheme)!=="http"&&fo!=="https"){fn("URI scheme must be http or https");return}if(!ft.authority){fn("Improperly formatted URI (typo maybe?)");return}if(((fs=ft.authority)==="localhost"||fs==="127.0.0.1")||ft.authority.indexOf("[::1]")===0){fn("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fr.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){fn("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}T=bF(this._webhook_info_row_tmpl({url:fv,status:"Verifying"}).toHTML());T.find(".status").append(fp);T.find(".webhook-actions").removeClass("disabled").addClass("enabled");fr.append(T);fr.removeClass("hide-status");bF("#webhook-form").removeClass("error");fq=bT.collect_form_vars(j);fu.val("");i=new Date().getTime();return bF.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fq,success:function(fz){var fx,fy;if(fz.status==="invalid"){fn(fz.failure_text,T);return fu.val(fv)}else{fy=new Date().getTime()-i;fx=Math.max(0,1000-fy);return setTimeout((function(){if(fz.status==="ok"){return T.find(".status").text("Enabled")}else{if(fz.status==="error"){T.find("textarea").text(fz.failure_text);T.find(".status").text(fz.status_text).addClass("error");T.find(".timestamp").text("Just now");return T.find(".webhook-failure-info").css("display","")}}}),fx)}},error:function(){ah.error("Unable to complete your request.");T.remove();return fu.val(fv)}})},remove_webhook:function(T,j){var fn,i;bF("#webhook-form").removeClass("error");i=bF(T).find(".value").text();fn=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bF(T).find(".status").text("Removing").removeClass("error").append(fn);return bF.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:j,webhook_url:i},dataType:"json",success:function(fq){var fo,fp;fo=T.parentNode;fp=fo.parentNode;fp.removeChild(fo);if(fp.getElementsByClassName("hoverable-url").length===0){bF(fp).addClass("hide-status")}if(!bF("#webhook_url").val()){return bF("#webhook_url").val(i)}},error:function(){return ah.error("Unable to complete your request.")}})},update_webhook_url:function(fp,fn,T){var fq,i,fo,fr,j;j=bF(fp.parentNode.parentNode).find(".value").text();bF("#webhook-form").removeClass("error");fo=fp.parentNode.parentNode.parentNode;fq=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");i=bF(fo).find(".status").text();T=i==="Disabled";fr=T?"Enabling":"Disabling";bF(fo).find(".status").text(fr).removeClass("error").append(fq);return bF.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:fn,webhook_url:j,enable:T},dataType:"json",success:function(ft){var fs;i=bF(fo).find(".status").text();fs=i==="Disabling"?"Disabled":"Enabled";bF(fo).find(".status").text(fs).removeClass("error").removeClass("img");if(i==="Disabling"){return bF(fo).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bF(fo).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fs){return ah.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(j,i){return bF.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:i,allow:bF(j).val()},dataType:"json",success:function(T){return ah.success("OAuth 2 allow implicit grant updated.")},error:function(){return ah.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(j){var i;i=bF(j).find("input[name=oauth_uri]").val();bT.clear_errors(j);return bT.ajax_submit(j,false,(function(){ah.success("OAuth URI added.");bi.add_oauth_uri(i);return bF(j).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(j){var i;i=bF("#oauth-uri-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_oauth_uri:function(j,i){var T,fn;fn=bF(j).find(".value").text();T=function(fp){var fo;ah.success("OAuth URI removed.");fo=j.parentNode;fo.removeChild(j);if(fo.getElementsByTagName("div").length===0){return fo.hide()}};return bF.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:i,oauth_uri:fn},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},submit_new_domain:function(i){var j;j=bF(i).find("input[name=domain_name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("Domain added.");bi.add_domain(j);return bF(i).find("input[name=domain_name]").val("")}))},add_domain:function(j){var i;i=bF("#domain-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_domain:function(j,i){var T,fn;fn=bF(j).find(".value").text();T=function(fp){var fo;ah.success("Domain removed.");fo=j.parentNode;fo.removeChild(j);if(fo.getElementsByTagName("div").length===0){return fo.hide()}};return bF.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:i,domain_name:fn},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},show_need_users_modal:function(i){fd.show(eB("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(i){return fd.show(eB("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(i){fd.show(eB("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(i){fd.show(eB("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){bF("#folder-name").show();return bF("#folder-input").hide()},show_folder_input:function(){bF("#folder-name").hide();bF("#folder-input").show();return bF("#folder-input input[name=folder]").focus()}};var cG,dF;dF=INLINE_JS.twitter_auth_complete=function(i){cL(i!=null,"user_id must be provided");if(cG.onLoginSuccessCallback){cG.onLoginSuccessCallback(i)}else{window.location.reload()}return false};cG=E.Twitter={is_authed:function(i){i=parseInt(i);if(cG._authed_users==null){cG._authed_users={}}return cG._authed_users[i]},set_is_authed:function(i,j){i=parseInt(i);if(cG._authed_users==null){cG._authed_users={}}return cG._authed_users[i]=j},get_progress_container:function(){var i;cL(cG.progress_container,"Twitter is missing progress_container");i=$(cG.progress_container);cL(i,"Missing progress_container elm");return i},follow_dropbox:function(j,i){var T;cL(i!=null,"user_id must be provided");if(j.showWorking){j.showWorking()}T=function(){if(j.onFailure){return j.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(fn){if(!fn.responseText.startsWith("ok")){return T()}else{if(j.onSuccess){return j.onSuccess()}}},onFailure:function(){return T()},subject_user:i})},do_auth:function(fn,i){var T,j;cL(i!=null,"user_id must be provided");j=G({path:"/twitter/request_token"}).updateQuery(a9.UID_PARAM_NAME,i).toString();window.open(j,"twitter_auth","width=800,height=400");T=function(fo){cG.set_is_authed(fo,true);return typeof fn==="function"?fn(fo):void 0};return cG.onLoginSuccessCallback=T},show_auth:function(i){if(i){cG.onLoginSuccessCallback=i}return dv.updateFromElm(cG.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cG.should_hide_modal()){fd.hide()}return cG.get_progress_container().update(dv.fromElm("sharing-progress"))},show_complete:function(j){var i;i=cG.get_progress_container();i.update(dv.fromElm("sharing-posted"));return cG.show_complete_into(j,i)},show_complete_into:function(fq,i){var fn,fo,T,fp,j;fn="twitter";fp=eB("View tweet");j=void 0;if(fq.startsWith("ok")){j="http://www.twitter.com/"}else{j=fq}fo=i.down("#view-post");fo.href=j;fo.update(fp);T=cx.make("web",fn);return fo.__sert({top:T})},post:function(fn,fp,T,i){var fo,j;cL(i!=null,"user_id must be provided");cL(fn,"Twitter message is empty");fo={message:fn,from_referrals:cG.from_referrals,from_getspace:cG.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fo,onSuccess:function(fq){var fr,fs;if(fq.responseText==="login"){cG.onLoginSuccessCallback=function(){return cG.post(fn,null,null,i)};fr=cG.custom_show_auth||cG.show_auth;return fr()}else{if(cG.should_hide_modal()){fd.hide()}fs=cG.onPostSuccessCallback||cG.show_complete;return fs(fq.responseText)}},subject_user:i});j=cG.custom_show_posting||cG.show_posting;return j()},custom_post:function(j,T,i){cL(i!=null,"user_id must be provided");if(T){cG.onPostSuccessCallback=T}if(!j){return}cL(j,"Twitter message doesn't exist");if(!cM.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(j))}else{return cG.post(j,null,null,i)}},get_user_info:function(j,i){cL(i!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(T){return j(JSON.parse(T.responseText))},subject_user:i})},should_hide_modal:function(){if(typeof cG.hide_modal==="undefined"){return true}else{return cG.hide_modal}}};var dt,e4,dE,Y,eT,au,bH,ao,e3,bD,fe=function(fn,j){for(var i in j){if(dk.call(j,i)){fn[i]=j[i]}}function T(){this.constructor=fn}T.prototype=j.prototype;fn.prototype=new T();fn.__super__=j.prototype;return fn},dk={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dE=E.LightboxPreviewBase=(function(){function i(j){this.link_hash=j.link_hash;this.filename=j.filename;this.fq_path=j.fq_path;this.thumbnail_url_tmpl=j.thumbnail_url_tmpl;this.dl_url=j.dl_url;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.display_time=j.display_time||null;this.more_actions_item_tmpl=fi.tmpl("lightbox_more_actions_item_tmpl")}i.prototype.shutdown=function(){};i.prototype.preload=function(){};i.prototype.render=function(){};i.prototype.image_size=function(){var j;j=document.viewport.getDimensions();return aG(j.width,j.height)};i.prototype.get_more_actions_above_divider=function(T){var fn,j;j=[];fn=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:eB("Download"),more_classes:"more-actions-item",Sprite:cx});j.push(fn);return j};i.prototype.get_more_actions_below_divider=function(j){return[]};i.prototype.is_a_timeline_preview=function(){return this instanceof eT||this instanceof dt||this instanceof au||this instanceof e4};i.prototype.is_an_album_preview=function(){return this instanceof eT||this instanceof au};i.prototype.is_a_photo_preview=function(){return this instanceof Y};i.prototype.is_a_video_preview=function(){return this instanceof bH};i.prototype.get_actions=function(fn){var fp,fr,fs,T,fo,j,fq;j=[];if(!this.is_a_timeline_preview()&&fn.enable_sublinks){if(fn.share_button_experiment_variant==="WHITE_BUTTON"){fs=bF("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fo=(function(ft){return function(fu){ba.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(G.parse(ft.shmodel_link).updateQuery("m","1"))}})(this)}else{fo=(function(ft){return function(fu){fu.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dx.shmodel(ft.fq_path,"browse_lightbox")}})(this)}}else{fs=bF("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fs.html(cx.make("web","link_white"));if(this.is_a_photo_preview()){fs.attr("title",eB("Share link to photo"))}else{if(this.is_a_video_preview()){fs.attr("title",eB("Share link to video"))}else{cL(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fs.attr("href",G.parse(this.shmodel_link).updateQuery("m","1"));fs.attr("target","_blank");fo=(function(ft){return function(fu){return ba.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fs.attr("href","#");fo=(function(ft){return function(fu){fu.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dx.shmodel(ft.fq_path,"browse_lightbox")}})(this)}}fs.on("click",fo);j.push(fs[0])}if(fn.include_delete){fq=bQ.in_single_collection_view()?eB("Remove"):eB("Delete");if(fn.share_button_experiment_variant==="WHITE_BUTTON"){fp=bF("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");fp.find(".sprite-text-inner").text(fq);fp.on("click",(function(ft){ft.preventDefault();return aM.delete_current()}))}else{fp=bF("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fq});fp.html(cx.make("web","lightbox_delete_16"));fp.on("click",(function(ft){ft.preventDefault();return aM.toggle_delete()}))}j.push(fp[0])}if(fn.share_button_experiment_variant==="WHITE_BUTTON"){T=(function(ft){return function(fu){fu.preventDefault();return aM.toggle_more_actions_menu()}})(this);fr=bF("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",T);j.push(fr[0])}else{cL(aM.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");j.push(aM.more_actions_button)}return j};i.prototype.delete_pressed=function(){var j;j=eB("Deleting...");if(this.is_a_timeline_preview()){if(bQ.in_single_collection_view()){j=eB("Removing...");bQ.get_current_collection().remove_photos([this.photo])}else{bQ._delete_photos([this.photo])}}else{document.fire(aM.PHOTO_DELETE_EVT,this)}return ah.success(j)};i.prototype.set_more_actions_event_handlers=function(j){};i.prototype.replace_dl_action_with_open_action_if_file_available=function(){var T,fo,fn,j;if(__CONDITIONAL_JS__.UnityFeatures==null){return}j=ct.active_user.id;fn=(function(fp){return function(fq,ft,fr){var fu,fs;fu=bF("#lightbox_download_link");if(!(fu.data("ns-id")===fq&&fu.data("ns-path")===ft)){return}fs=bF(fp.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fq,_ns_path:ft,sprite_name:"lightbox_open",item_text:eB("Open"),more_classes:"more-actions-item",Sprite:cx}).toHTML());fu.replaceWith(fs);return fs.on("click",function(fv){return __CONDITIONAL_JS__.UnityFeatures.open_file(fq,ft,fr,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fw){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fo=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fo.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return fn(this.ns_id,this.ns_path,j)}else{T=(function(fp){return function(fq){if(fq.is_locally_available){return fn(fp.ns_id,fp.ns_path,j)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,j,T)}};return i})();Y=INLINE_JS.PhotoPreview=E.PhotoPreview=(function(j){fe(i,j);function i(T){i.__super__.constructor.call(this,T);this.original_url=String(G.parse(T.original_url).updateQuery(a9.UID_PARAM_NAME,ct.active_user));this.shmodel_link=T.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=T.enable_download}i.prototype.show_fail=function(fn){var T;return T=bF(fn).find(".lightbox_fail_text").text(eB("Unable to preview this item."))};i.prototype.fallback=function(fn){var T,fo;T=$(fn.target);T.writeAttribute({src:this.fail_image_src,width:128,height:128});fo=T.up("div.content-item");if(fo){return this.show_fail(fo)}};i.prototype.is_gif=function(){return"gif"===aA.file_extension(this.filename).toLowerCase()};i.prototype.preload=function(fo){var fn,fp,T;T=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){T=this.thumbnail_url_tmpl}fp=(function(fq){return function(){if(typeof fo==="function"){fo()}return fq.loaded=true}})(this);d6.preload_image(T,this.fallback.bind(this),fp);fn=$(d6.preloaded_images[T]);fn.writeAttribute("data-original-href",this.original_url);fn.setAttribute("enable-download",this.enable_download);fn.writeAttribute("class","thumbnail");return fn};i.prototype.render=function(fr,fo){var fp,fn,fq,T,fs;if(this.loaded){fo()}fn=this.preload(fo);fs=bF("<div />",{"class":"content-item"}).append(fn);fp=bF("<div />",{"class":"lightbox_fail_text"});fs.append(fp);fq=fn.getAttribute("src").length;T=fn.getAttribute("src").substring(fq-this.fail_image_src.length,fq);if(T===this.fail_image_src){this.show_fail(fs)}fr.appendChild(fs[0]);return fs[0]};i.prototype.advance_on_click=true;i.prototype.get_more_actions_above_divider=function(fo){var fn,T;T=i.__super__.get_more_actions_above_divider.call(this,fo);fn=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:eB("View original"),more_classes:"more-actions-item",Sprite:cx});T.push(fn);return T};return i})(dE);bH=E.VideoPreview=(function(i){fe(j,i);function j(T){this._player_error=b3(this._player_error,this);this._player_ready=b3(this._player_ready,this);j.__super__.constructor.call(this,T);this.preview_url=T.preview_url;this.shmodel_link=T.shmodel_link;this.thumbnail_div=null;this.metadata_link=T.metadata_link!=null?T.metadata_link:void 0;this.metadata=null;this.player=null}j.prototype.render_error=function(fp){var fr,fn,T,fo,fq;fn=bF("<div/>");T=bF("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fo=bF("<div/>",{"class":"video-preview-fail"});if(fp==="needflash"){fo.html(eB('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fo.text(eB("Unable to preview this item.",fq="web",fr="preview means showing the item in the same browser window without downloading a copy."))}fn.append(T,fo);return fn[0]};j.prototype._player_ready=function(){var T;T=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return T.defer()};j.prototype._onPlay=function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()};j.prototype._onEnded=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()};j.prototype._player_error=function(T){this.shutdown();this.div=this.render_error(T);return bF("#file-preview-modal .content-item").html(this.div)};j.prototype.preload=function(){};j.prototype.render=function(fn,T){this.div=this.render_video(fn);return this.div};j.prototype.render_video=function(fs){var T,fq,fo,fn,fr,fp;fp=new Element("div",{"class":"video-player content-item"});fr=this.image_size().split("x")[0]*0.8;fn=parseInt(fr*0.55,10);fq=false;fo=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();T=(function(ft){return function(fu){return ft.metadata=fu}})(this);this.player=bt.embed(fp,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fr,height:fn,controls:true,preload:"auto",poster:fo,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:T});fs.appendChild(fp);bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return fp};j.prototype.shutdown=function(){var fn,fo,T;bF(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((T=this.player.tech.sourceBuffer)!=null){T.abort()}}this.player.dispose()}catch(fo){fn=fo}return this.player=null}};return j})(dE);ao=function(T){var i,j;i=(function(fo){fe(fn,fo);function fn(fp){fp.ns_id=fp.photo.ns_id;fp.ns_path=fp.photo.ns_path;fn.__super__.constructor.call(this,fp);this.photo=fp.photo;bo.set_vertical_space(3);if(bQ.in_single_collection_view()){bF("#lightbox-delete-photo").val(eB("Remove"))}else{bF("#lightbox-delete-photo").val(eB("Delete"))}}fn.prototype.get_more_actions_above_divider=function(fr){var fq,fp;fp=fn.__super__.get_more_actions_above_divider.call(this,fr);fq=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:eB("Add to album"),more_classes:"more-actions-item",Sprite:cx});fp.push(fq);return fp};fn.prototype.toggle_select_button_off=function(fp){if(this.is_a_photo_preview()){fp.attr("title",eB("Select photo"))}else{if(this.is_a_video_preview()){fp.attr("title",eB("Select video"))}}fp.html(cx.make("web","lightbox_unselected"));fp.removeClass("selected");fp.addClass("elbboggiw");return setTimeout((function(){return fp.removeClass("elbboggiw")}),540)};fn.prototype.toggle_select_button_on=function(fp){if(this.is_a_photo_preview()){fp.attr("title",eB("Un-select photo"))}else{if(this.is_a_video_preview()){fp.attr("title",eB("Un-select video"))}}fp.html(cx.make("web","lightbox_selected"));fp.addClass("selected");fp.addClass("wiggobble");return setTimeout((function(){return fp.removeClass("wiggobble")}),540)};fn.prototype.toggle_select=function(fq){var fp;fq.preventDefault();fp=bF("#lightbox-select-button");bo.hide_all();if(eW.contains(this.photo)){eW._remove(this.photo);return this.toggle_select_button_off(fp)}else{eW._add(this.photo);return this.toggle_select_button_on(fp)}};fn.prototype.get_actions=function(fr){var fq,fp,fs;fq=[];fs=bF("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aM.update_share_button_text(null,bF(fs));fs.on("click",((function(ft){return function(fv){var fu;fv.preventDefault();fu=eW.get();if(fu.length===0){return eA.show([ft.photo],false)}else{return eA.show(eW.get(),false)}}})(this)));fp=bF("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:eB("Select this photo")});if(eW.contains(this.photo)){fp.html(cx.make("web","lightbox_selected"))}else{fp.html(cx.make("web","lightbox_unselected"))}fp.on("click",this.toggle_select.bind(this));fq.push(fs[0]);fq.push(fp[0]);return fq.concat(fn.__super__.get_actions.call(this,fr))};fn.prototype.set_more_actions_event_handlers=function(fp){$("lightbox_add_to_album").observe("click",((function(fq){return function(fr){fr.preventDefault();return cJ.show_add_to_album_modal(fr,[fq.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fq){return function(fr){fr.preventDefault();return bQ.show_in_folder(fq.photo)}})(this)));return fn.__super__.set_more_actions_event_handlers.call(this,fp)};fn.prototype.get_more_actions_below_divider=function(fr){var fq,fp;fq=[];fp=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:eB("Show in folder"),more_classes:"more-actions-item",Sprite:cx});fq.push(fp);fq=fq.concat(fn.__super__.get_more_actions_below_divider.call(this,fr));return fq};return fn})(T);j=(function(fo){fe(fn,fo);function fn(){return fn.__super__.constructor.apply(this,arguments)}fn.prototype.get_more_actions_below_divider=function(fr){var fp,fq;fq=[];fp=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:eB("Remove from album"),more_classes:"more-actions-item",Sprite:cx});fq.push(fp);fq=fq.concat(fn.__super__.get_more_actions_below_divider.call(this,fr));return fq};fn.prototype.set_more_actions_event_handlers=function(fp){$("lightbox_remove_from_album").observe("click",((function(fq){return function(fr){fr.preventDefault();return cJ.show_remove_photos_modal(bQ.get_current_collection(),[fq.photo])}})(this)));return fn.__super__.set_more_actions_event_handlers.call(this,fp)};return fn})(i);return[i,j]};e3=ao(Y),dt=e3[0],eT=e3[1];bD=ao(bH),e4=bD[0],au=bD[1];var aM;aM=INLINE_JS.Lightbox=E.Lightbox=(function(){var i,fK,fT,gf,fn,f9,fs,fS,f4,fA,f3,fP,fY,ge,fz,fQ,fx,f2,f6,fr,f5,fq,fI,f8,fC,fR,fu,fL,fZ,fM,fV,fo,fE,j,fU,f7,gd,f1,fB,fH,fp,fG,fX,T,fv,f0,fN,fO,fy,fJ,fw,gc,fF,fD,gb,ga,fW,ft;ga=[];fF=0;fW=false;gb=true;fN=void 0;i=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;ft=false;f8=void 0;f4=void 0;fX=-1;T=null;fY=null;fQ=false;j=false;fr=false;fx=null;fz=function(gg){return gg.complete!==false};fp=function(){var gg;if($$("#file-preview-modal .loading-image").length){return}gg=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(gg)};fP=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fM=function(){var gm,gl,gi,gg,gk,gj,gh;gl=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!gl||!fz(gl)){return}gg=$$("#file-preview-modal .preview").first().getDimensions();gm=void 0;if(!gl.naturalHeight){gm=gl.getDimensions();gl.naturalHeight=gm.height;gl.naturalWidth=gm.width}else{gm={width:gl.naturalWidth,height:gl.naturalHeight}}gi=gm.width/gg.width;gh=gm.height/gg.height;gj=Math.max(gi,gh);gl.style.visibility="";if(gj<1){gl.style.width="";gl.style.height=""}else{gl.style.width=Math.floor(gm.width/gj)+"px";gl.style.height=Math.floor(gm.height/gj)+"px"}gk=bF("#file-preview-modal .paging-block").position().left-16;return bF("#file-preview-modal .filename").css("max-width",gk)};fS=void 0;f5=function(){var gn,gi,gm,gh,gg,gl,gk,gj;gi=$("file-preview-modal");gl=gi.down(".menu");gm=gi.down(".header");gk=$$(".lightbox-not-important");gj=[];for(gh=0,gg=gk.length;gh<gg;gh++){gn=gk[gh];gj.push(gn.addClassName("opacity-zero"))}return gj};fG=function(){var gk,gh,gg,gj,gi;if(fS){clearTimeout(fS)}gj=$$(".lightbox-not-important");gi=[];for(gh=0,gg=gj.length;gh<gg;gh++){gk=gj[gh];gi.push(gk.removeClassName("opacity-zero"))}return gi};fV=function(gh){var gg;fG();gg=gh&&$(gh.target).descendantOf("file-preview-menu");if(fS!=null){clearTimeout(fS)}if(gb){if(!ft&&!gg){return fS=setTimeout(f5,3112)}}};f0=function(){if(fS!=null){clearTimeout(fS)}return gb=false};fv=function(){gb=true;return fV()};ge=function(gh){var gg;gg=ga.length;return(gg+(fF+gh)%gg)%gg};fR=function(gh){var gi,gg;if(f8.no_preload){return}gg=fB.bind(null,gh);return typeof(gi=ga[gh]).preload==="function"?gi.preload(gg):void 0};fu=function(){var gi,gh,gg,gk,gj;gk=[1,2,3,4,5,6,-1,-2];gj=[];for(gi=0,gh=gk.length;gi<gh;gi++){gg=gk[gi];if(Math.abs(gg)<ga.length){gj.push(fR(ge(gg)))}else{gj.push(void 0)}}return gj};fE=function(gg){if(!f8.filename_in_url){return}if(gg!=null){a3.replace_hash("lh",gg)}else{a3.replace_hash("")}return fx=gg};fZ=function(){var gg,gh;gg=bF("#file-preview-modal");gh=(f8!=null?f8.num_previews:void 0)||ga.length;if(fQ&&j&&fr){gg.find(".lightbox-index-text-container").text(eB("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fQ){if(j){gg.find(".lightbox-index-text-container").text(eB("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{gg.find(".lightbox-index-text-container").text("")}}else{gg.find(".lightbox-index-text-container").text(eB("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fF+1,num_total_files:gh}))}}if(ga.length===1){gg.find(".prev").addClass("opacity-zero");return gg.find(".next").addClass("opacity-zero")}else{if(fF===0&&f8.no_wrap){gg.find(".prev").addClass("opacity-zero");return gg.find(".next").removeClass("opacity-zero")}else{if(fF===ga.length-1&&f8.no_wrap){gg.find(".prev").removeClass("opacity-zero");return gg.find(".next").addClass("opacity-zero")}else{gg.find(".prev").removeClass("opacity-zero");return gg.find(".next").removeClass("opacity-zero")}}}};fn=function(gk,gh,gj,gg,gi){var gl;gl={user_id:null,context:gh,platform:aX.FileViewPlatformType.WEB,ns_id:gk.ns_id,sjid:null,ns_path:gk.ns_path,shared_link_url:gj,extra:{mode:gg,file_ext:gi}};return gl};fU=function(gh,gF){var gs,gt,gv,gA,go,gi,gq,gj,gk,gw,gg,gB,gr,gl,gE,gD,gz,gp,gy,gn,gx,gC,gm,gu;fX=b6.time();cL(fF<ga.length,"Invalid index "+fF);gx=ga[fF];if(typeof gx!=="object"){if(T){clearTimeout(T)}T=setTimeout((function(){if((aM.shown!=null)&&aM.shown){return fU(gh,gF)}}),100);return}bF("#file-preview-modal").trigger(aM.LIGHTBOX_SHOW_EVT,{preview:gx});gi=aA.file_extension_for_logging(gx.filename);gj=aX.FileViewModeType.PHOTOS_LIGHTBOX;gq=aX.FileViewContextType.PRIVATE;gk=null;gl="lightbox";if(gx.fq_path!=null){gj=aX.FileViewModeType.BROWSE_LIGHTBOX;gq=aX.FileViewContextType.PRIVATE;gl="browse_lightbox"}else{if(gx.shmodel_link!=null){gj=aX.FileViewModeType.SHARED_LINK_LIGHTBOX;gq=aX.FileViewContextType.SHARED_LINK;gk=gx.shmodel_link;gl="shmodel_lightbox"}}gw=fn(gx,gq,gk,gj,gi);ba.FileViewLogger.log(gw);ba.WebLightboxLogger.log(ba.WebLightboxLogger.VIEW,{context:gl,file_ext:gi});gD=bF("#file-preview-modal");gC=gD.find(".preview-content");gn=gh?f1:fB;gC.empty();go=gx.render(gC[0],gn);gD=gD[0];if(!fY){fY=gD.on("contextmenu","img.thumbnail",bn.show_for_lightbox.bind(bn))}fE(gx.link_hash);fZ();if(gx.display_time){if(gx.filename.match(i)){gD.down(".filename").__date(gx.display_time)}else{gD.down(".filename").__date(gx.display_time+" - "+gx.filename)}}else{gD.down(".filename").__date(gx.filename)}gD.down(".filename").writeAttribute("title",gx.filename);if(bQ.in_single_collection_view()&&((gm=bQ.get_current_collection().member_fnames)!=null?gm.length:void 0)>1&&(((gu=gx.photo)!=null?gu.item_owner_fname:void 0)!=null)){gA="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gA+=eB("Added by %(fname)s").format({fname:bU.em_snippet(gx.photo.item_owner_fname,7)});gD.down(".added-by").__date(new fi(gA));gD.down(".added-by").show()}else{gD.down(".added-by").hide()}gp=fi.tmpl("lightbox_more_actions_item_tmpl");gz=gx.get_more_actions_above_divider(f8);gv=gx.get_more_actions_below_divider(f8);if(gv.length){gz.push(gp({divider:true,Sprite:cx}));gz=gz.concat(gv)}$("lightbox-more-actions-list").__date(gz);gx.set_more_actions_event_handlers(f8);if(bF(gD).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gx.replace_dl_action_with_open_action_if_file_available()}gt=gx.get_actions(f8);gg=document.createDocumentFragment();for(gB=0,gr=gt.length;gB<gr;gB++){gs=gt[gB];gg.appendChild(gs)}gD.down(".actions").__date();gD.down(".actions").appendChild(gg);if(f8.share_button_experiment_variant==="WHITE_BUTTON"){gy=bF("#lightbox-more-actions-button .sprite-div").width();bF("#lightbox-more-actions-menu").css("right",gy/2)}document.fire(aM.ACTIONS_ADDED);if(bQ.in_single_collection_view()){gD.down(".album-name").show().__date(bU.em_snippet(bQ.get_current_collection().name,15,1));gD.down(".filename").addClassName("faded")}else{gD.down(".album-name").hide();gD.down(".filename").removeClassName("faded")}go=go.down("img.thumbnail");if(go){if(!fz(go)){go.hide();fp();go.observe("load",function(){fP();go.style.visibility="hidden";go.show();return fM()})}else{go.show();fM()}}gE={preview_obj:gx,index:fF,direction:gF};return document.fire(aM.PHOTO_CHANGE_EVT,gE)};gd=function(gl){var gh,gi,gg,gj,gk;if(fX===-1){return}gk=b6.time()-fX;if(typeof g!=="undefined"&&g!==null){gh=g.get_current_view()}else{if(typeof am!=="undefined"&&am!==null?am.is_album:void 0){gh="album_shmodel"}else{gh="not_photos"}}gi={current_view:gh};gg=bF("#file-preview-modal .content-item img.thumbnail")[0];if((gg!=null)&&(gg.src!=null)){gj=G.parse(gg.src).getQuery();if("size" in gj){gi.size=gj.size}}eh.log_ajax_transition(gk,gl,gi);fX=-1;return fu()};f1=function(){return gd("file-preview-lightbox-load-initial")};fB=function(gg){var gh;if(typeof gg==="number"){if((gh=ga[gg])!=null){gh.loaded=true}if(gg===fF){return gd("file-preview-lightbox-load")}}else{return gd("file-preview-lightbox-load")}};f7=function(gg){var gh;gh=bF("#lightbox-click-catcher");if(!gh.length){gh=bF("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});gh.appendTo("#file-preview-modal .modal-preview-content");if(b1.msie_version_at_most(10)){gh.css("background","black");gh.fadeTo(0,0)}}gh.off("click");gh.on("click",(function(gi){gi.preventDefault();return gg()}));return gh.show()};fA=function(){return bF("#lightbox-click-catcher").hide()};gf=function(){var gg;gg=bF("#lightbox-more-actions-button");if(gg.hasClass("toggled")){fA();gg.removeClass("toggled");$("lightbox-more-actions-menu").hide();bF(document).trigger("dropdownClosed",[1]);fv();return true}return false};fI=function(){var gg;gg=bF("#lightbox-more-actions-button");if(!gg.hasClass("toggled")){f3();gg.addClass("toggled");bo.hide_all();bF("#lightbox-more-actions-menu").show();bF(document).trigger("dropdownOpened",[1]);f0();return f7(aM.close_more_actions_menu)}};fy=function(){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gf()}else{return fI()}};fq=function(gh){var gg;if(fQ){j=true;fZ()}gf();if(gh){gh.preventDefault()}if(fF===ga.length-1&&f8.no_wrap){return}if((gg=ga[fF])!=null){gg.shutdown()}fF=ge(1);if(fF===0){fV()}return fU(null,aM.NEXT)};fL=function(gh){var gg;if(fQ){j=true;fZ()}gf();if(gh){gh.preventDefault()}if(fF===0&&f8.no_wrap){return}if((gg=ga[fF])!=null){gg.shutdown()}fF=ge(-1);return fU(null,aM.PREV)};fT=function(gg){if(gg){gg.preventDefault()}if(ga[fF].advance_on_click){if(gg.clientX<bF(window).width()/10){return fL()}else{return fq()}}};f9=function(gm){var gj,gg,gl,gn,gi,gh,gk;gj=ga.dict_by("fq_path");gn=void 0;if(gm.memo.files){gn=gm.memo.files.collect(function(go){return go.fq_path})}else{gn=gm.memo.fq_paths}gk=[];for(gi=0,gh=gn.length;gi<gh;gi++){gl=gn[gi];if(gj[gl]){gg=ga.indexOf(gj[gl]);ga.splice(gg,1);if(f8.num_previews){f8.num_previews--}if(!f8.num_previews&&!ga.length){gk.push(f4())}else{if(gg===ga.length){gk.push(fL())}else{gk.push(fU())}}}else{gk.push(void 0)}}return gk};fo=function(gg){if(ga[fF].is_a_timeline_preview()){return ga[fF].toggle_select(gg)}};fJ=function(){Event.stopObserving(document,"mousemove",fV);Event.stopObserving(document,"click",fV);document.stopObserving(aM.PHOTO_DELETE_EVT,fC);document.stopObserving(aH.DELETE,f9);document.stopObserving(eW.CHANGE_EVT,fw);return clearInterval(fN)};f4=function(gk){var gj,gi,gh,gg;if(gk){gk.preventDefault()}if(!aM.shown){return}if((gi=ga[fF])!=null){gi.shutdown()}gj=$("file-preview-modal");gj.hide();gj.down(".preview-content").__date();C.scroll_unlock_document();fJ();fE();aM.shown=0;gj.stopObserving("click",aM.back);if((gh=$$(".preview-content"))!=null){if((gg=gh.first())!=null){gg.stopObserving("click")}}return bF("#file-preview-modal").trigger(aM.LIGHTBOX_HIDE_EVT)};fD="db:filepreview:exitselect";fK=function(gh){var gg;if(f8.keep_url){f4()}else{if((gg=ga[fF])!=null){gg.shutdown()}window.history.go(-1)}if(gh!=null){if(gh.originalEvent){gh=gh.originalEvent}Event.extend(gh).stop()}return document.fire(fD,ga[fF])};fC=function(gg){return dD.do_delete(ct.active_user,gg.memo.fq_path)};f6=function(){var gg;if(!fW){gg=bF("#file-preview-modal");gg.on("click",".close",fK);key("esc",aM.KEY_SCOPE,(function(gh){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gf()}else{if(ft){return f3()}else{return fK(gh)}}}));gg.on("click",".next",fq);gg.on("click",".prev",fL);gg.on("click",".preview-container",fT);key("left, k",aM.KEY_SCOPE,function(gh){return fL()});key("right, j",aM.KEY_SCOPE,function(gh){fq();return false});key("up, down",aM.KEY_SCOPE,function(gh){return false});key("x, s, space",aM.KEY_SCOPE,function(gh){fo(gh);return false});if(f8.include_delete&&f8.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aM.KEY_SCOPE,function(gh){Event.extend(gh).preventDefault();return aM.toggle_delete()});bF("#lightbox-delete-photo").on("click",(function(gh){fO();return ga[fF].delete_pressed()}));bF("#lightbox-delete-cancel").on("click",f3)}eE.add_exit_callback("/lightbox",function(){return f4()});d6.disableSelection(gg.find(".preview-container")[0]);d6.disableSelection(gg.find(".header")[0]);fW=true}Event.observe(document,"mousemove",fV);Event.observe(document,"click",fV);document.observe(aH.DELETE,f9);document.observe(aM.PHOTO_DELETE_EVT,fC);document.observe(eW.CHANGE_EVT,fw);key.setScope(aM.KEY_SCOPE);return fN=setInterval(fM,500)};f2=function(){var gj,gh,gg,gk,gi;if(!fx){return}gi=[];for(gj=gh=0,gg=ga.length;gh<gg;gj=++gh){gk=ga[gj];if(gk.link_hash&&gk.link_hash.toLowerCase()===fx.toLowerCase()){fF=gj;if(!aM.shown){gi.push(aM.show())}else{gi.push(fU())}}else{gi.push(void 0)}}return gi};gc=function(){return on_script_loaded(function(){a3.watch("lh",function(gg){fx=gg;return f2()});return a3.watch("f",function(gg){var gk,gi,gh,gl,gj;gj=[];for(gk=gi=0,gh=ga.length;gi<gh;gk=++gi){gl=ga[gk];if(gl.filename.toLowerCase()===gg.toLowerCase()){fF=gk;if(!aM.shown){gj.push(aM.show())}else{gj.push(fU())}}else{gj.push(void 0)}}return gj})})};fw=function(gk,gm){var gi,gl,gj,gg,gh;if(gm==null){gm=bF("#lightbox_share")}gh=eW.get();gj=c9.categorize_files(gh),gi=gj[0],gl=gj[1];if(gh.length===0){gm.text(eB("Share"));return(gg=ga[fF])!=null?gg.toggle_select_button_off(bF("#lightbox-select-button")):void 0}else{if(gh.length===1){if(gi){return gm.text(eB("Share 1 photo"))}else{return gm.text(eB("Share 1 video"))}}else{if(gi&&gl){return gm.text(eB("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:gh.length}))}else{if(gi){return gm.text(eB("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:gh.length}))}else{return gm.text(eB("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:gh.length}))}}}}};fH=function(){bo.hide_all();bF("#file-preview-modal .delete-file-prompt").show();bF(document).trigger("dropdownOpened",[1]);fG();ft=true;f7(aM.toggle_delete);return bF("#lightbox-delete-photo").focus()};f3=function(){var gh,gg;if(ft){gh=bF("#file-preview-modal .delete-file-prompt");gh.hide();bF(document).trigger("dropdownClosed",[1]);if((gg=gh.find(":focus")[0])!=null){gg.blur()}fV();ft=false;return fA()}};fO=function(){gf();if(ft){return f3()}else{return fH()}};fs=function(){return ga[fF].delete_pressed()};return{init_from_preview_objs:function(gk,gn,gh){var gm,gj,gi,gl,gg;if(gh==null){gh=true}gg=[];for(gj=0,gi=gk.length;gj<gi;gj++){gm=gk[gj];if(gm.is_video){gl=new bH({filename:gm.filename,fq_path:gm.path,thumbnail_url_tmpl:gm.thumbnail_url,preview_url:gm.preview_url,dl_url:gm.dl_url,shmodel_link:gm.shmodel_link,ns_id:gm.ns_id,ns_path:gm.path,link_hash:gm.item_id+"-"+gm.filename,metadata_link:gm.metadata_link})}else{gl=new Y({filename:gm.filename,fq_path:gm.path,thumbnail_url_tmpl:gm.thumbnail_url,dl_url:gm.dl_url,original_url:gm.orig_url,shmodel_link:gm.shmodel_link,ns_id:gm.ns_id,ns_path:gm.ns_path,link_hash:gm.item_id+"-"+gm.filename,enable_download:gm.enable_download})}gg.push(gl)}aM.init(gg,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:gh});return document.on(aM.EXIT_SELECT_EVT,function(gp){var go;key.setScope("all");go=bF(gn)[gg.indexOf(gp.memo)];d6.scroll_to_thumb(go);bF(go).addClass("wiggobble");return setTimeout((function(){return bF(go).removeClass("wiggobble")}),1000)})},init:function(gg,gh){if(aM.shown){return}aM.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:eB("More actions")});aM.more_actions_button.observe("click",(function(gi){gi.preventDefault();return aM.toggle_more_actions_menu()}));aM.more_actions_button.__date(cx.make("web","lightbox_more"));gh=gh||{};f8={include_delete:gh.include_delete||false,keep_url:gh.keep_url||false,num_previews:gh.num_previews||null,filename_in_url:gh.filename_in_url||false,no_wrap:(gh.no_wrap||false)||true,no_preload:gh.no_preload||false,enable_sublinks:gh.enable_sublinks!=null?gh.enable_sublinks:true,share_button_experiment_variant:gh.share_button_experiment_variant||false};fQ=gh.is_loading||false;cL(!f8.filename_in_url||f8.keep_url,"filename_in_url cannot be used with keep_url off");ga=gg;if(gh.start_index!=null){aM.show(gh.start_index)}if(f8.filename_in_url){gc()}return $(document.body).on("click",".more-actions-item",function(gi,gj){if(gj.down("a").getAttribute("href").length<2){gi.preventDefault()}return aM.close_more_actions_menu()})},update_previews:function(gg){return ga=gg},show:function(gg){var gh,gi;if(aM.shown){return}cL(ga&&ga.length,"Lightbox.show() requires file preview objects to show");f6();if(gg!=null){fF=gg}bF("#file-preview-modal").trigger("lightbox-init-show",{preview:ga[fF]});if((gi=ga[fF])!=null?gi.enable_download:void 0){aM.more_actions_button.show()}else{aM.more_actions_button.hide()}cL(!aM.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();C.scroll_lock_document();fU(true);aM.shown=1;if(!f8.keep_url){gh=eE.deconstruct_url(eE.get_url());if(gh.path.indexOf("/lightbox/")!==0){eE.push_state("/lightbox"+gh.path,gh.qargs)}}return fV()},jump_to:function(gg){cL(aM.shown,"Lightbox should be showing");fF=gg;fU();return fV()},set_no_wrap:function(gg){return f8.no_wrap=gg},update_with_error:function(){fr=true;return fZ()},num_previews:function(){return f8.num_previews||ga.length},get_previews:function(){return ga},current_index:function(){return fF},close_more_actions_menu:gf,toggle_more_actions_menu:fy,update_share_button_text:fw,toggle_delete:fO,delete_current:fs,back:fK,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fD,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bG;bG=E.Tour=(function(){var fn,T,fp,fq,fu,fs,ft,fr,fo,fv,j,i;T=6;fn=0;j=function(fw){var fH,fF,fE,fD,fB,fy,fx,fz,fG,fA,fC;$$(".page-end").each(Element.remove);fx=fw;fC=T-fw-1;fH=document.createDocumentFragment();for(fF=fD=0,fz=fx;0<=fz?fD<fz:fD>fz;fF=0<=fz?++fD:--fD){fy=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fy.style.left=(28-fF*5)+"px";fy.style.zIndex=T-fF;fH.appendChild(fy)}for(fE=fB=0,fG=fC;0<=fG?fB<fG:fB>fG;fE=0<=fG?++fB:--fB){fA=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fA.style.right=(31-fE*5)+"px";fA.style.zIndex=T-fE;fH.appendChild(fA)}return $("book").appendChild(fH)};i=function(fw){(fw>0?Element.show:Element.hide)("tour-page-back");return(fw+1<T?Element.show:Element.hide)("tour-page-forward")};fo=function(fw){$$(".pages").invoke("hide");return $("page-"+fw).show()};fp=function(fw){i(fw);j(fw);fo(fw);return fn=fw};fr=function(fx){var fw;Event.extend(fx).preventDefault();fw=fn-1;if(fw<0){return}fp(fw);return eE.push_state("/tour/"+fw)};fs=function(fx){var fw;Event.extend(fx).preventDefault();fw=fn+1;if(fw>=T){return}fp(fw);return eE.push_state("/tour/"+fw)};fv=function(fx,fy){var fw;fx.preventDefault();fw=parseInt(fy.href.split("/").last(),10);fp(fw);return eE.push_state("/tour/"+fw)};fu=function(){$("tour-page-back").observe("click",fr);$("tour-page-forward").observe("click",fs);key("right",fs);key("left",fr);return $("toc").on("click","a",fv)};fq=function(fx,fy){var fw;fw=parseInt(fx,10)||0;if(fw<0||fw>=T){fw=0}return fp(fw)};ft=function(){var fA,fx,fw,fz,fy;fz=$$(".page-right img");fy=[];for(fx=0,fw=fz.length;fx<fw;fx++){fA=fz[fx];fy.push(d6.preload_image(fA.src))}return fy};return{setup:function(){return bF(function(){eE.add_callback("/tour",fq);fu();return ft()})}}})();var bQ,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};bQ=INLINE_JS.Photos=E.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fr,T,fo,fv,fs,fn,j,ft,fx,i){var fq,fu,fw,fp;this.event_metadata_cache=j;this._root_collection_gid=i;this.initialized=true;this.disable_selection();d6.disable_ie_image_dragging();this._tmpl=fi.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=fi.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fs!=null?fs.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=ft.include_shared_folders;this.show_hidden=ft.show_hidden;this.timestamp_edit_enabled=fx.timestamp_edit_enabled;this.undo_enabled=fx.undo_enabled;this.local_storage_enabled=fx.local_storage_enabled;fu=eE.deconstruct_url();fp="share" in fu.qargs;for(fw in fv){if(fv.hasOwnProperty(fw)){eW.inc_num_loading_events_before_select(fp)}}this._init_timeline(fr,T,fo,fv);this._init_lightbox();fq=[];if(fs!=null){fq.push(new ad(fs,false))}cJ.init(fq,fn);eW.drag_select_enabled=fx.drag_select_enabled;if(ft.show_photos_tour){aO.next()}delete fu.qargs.selr;delete fu.qargs.user_email;delete fu.qargs.uid;delete fu.qargs.share;delete fu.qargs.m;if("uuid" in fu.qargs){delete fu.qargs.uuid;delete fu.qargs.id}if(dL){eE.replace_state(fu.path,fu.qargs)}else{if(!G.parse(window.location.href).fragment){eE.push_state("/photos",fu.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aM.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aM.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aM.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aM.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bn.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eE.add_callback("/photos",this._history_change_handler.bind(this));document.observe(dd.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(dd.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(ck.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(ck.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bF("#photos-nav-item").on("click",this.show_all_photos.bind(this));bF("#back-to-photos").on("click",this._back_to_photos.bind(this));bF("#back-to-albums").on("click",this._back_to_albums.bind(this));bF("#share-selected").on("click",this._share_selected.bind(this));bF("#clear-selected").on("click",this._clear_selected.bind(this));bF("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bF("#do-include-shared-folders").prop("checked",true)}else{bF("#dont-include-shared-folders").prop("checked",true)}cJ.listen();eW.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bF(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fs){var fq,fr,fn,i,T,fp,fo;fr=$(fs.target).up(".cu-month-header").identify().slice(2);fq=this.get_timeline().events.valueFromKey(fr);fp=fq.photos;fo=[];for(fn=0,i=fp.length;fn<i;fn++){T=fp[fn];fo.push(eW._add(T))}return fo},_share_event:function(fr){var fp,fq,fn,i,T,fo;fq=$(fr.target).up(".cu-month-header").identify().slice(2);fp=this.get_timeline().events.valueFromKey(fq);fo=fp.photos;for(fn=0,i=fo.length;fn<i;fn++){T=fo[fn];eW._add(T)}return this._share_selected()},_add_event_to_album:function(fr){var fp,fq,fn,i,T,fo;fq=$(fr.target).up(".cu-month-header").identify().slice(2);fp=this.get_timeline().events.valueFromKey(fq);fo=fp.photos;for(fn=0,i=fo.length;fn<i;fn++){T=fo[fn];eW._add(T)}return cJ.show_add_to_album_modal(fr,eW.get())},_init_timeline:function(fq,T,fo,ft){var j,fu,fr,i,fn,fs,fv,fp;if(!fq.length){this.show_empty_state();return}j=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");fp=$("cu-view").cumulativeOffset().top+j.getLayout().get("margin-top")+j.getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){fp+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fr=$("cu-view").cumulativeOffset().left+j.getLayout().get("margin-left")+j.getLayout().get("padding-left");fu={top_offset:fp,left_offset:fr,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};i={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fv=new ck(j,null,fq,T,fo,ft,this._tmpl,fu,i);if(this.in_single_collection_view()){if((fn=this._single_collection_timeline)!=null){fn.unlisten()}this._single_collection_timeline=fv}else{if((fs=this._all_photos_timeline)!=null){fs.unlisten()}this._all_photos_timeline=fv}return this.get_timeline().render()},_init_lightbox:function(){var j,i;if(this.get_timeline()==null){return}if(aM.shown){i=this.get_timeline().get_preview_objs();if(i.length){aM.update_previews(i);j=Math.min(aM.current_index(),i.length-1);return aM.jump_to(j)}else{return aM.back()}}else{return aM.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(j){var i;if((i=this.get_timeline())!=null){i.unlisten()}eW.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(j);return window.scrollTo(0,0)},_refresh_photo_events:function(i){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(j){return function(T){var fn;fn=JSON.parse(T.responseText);if(fn==="deleted_collection"){j._current_collection_gid=null;cJ.reload();j.show_all_collections();ah.error(eB("This album has been deleted!"));return}j._init_timeline(fn.header_ids,fn.header_id_to_name,fn.header_id_to_num_photos,{});j._init_lightbox();return typeof i==="function"?i():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(i){if(i.duplicates_info!=null){return this._show_duplicates_modal(i,false)}else{return window.open(this._get_browse_link(i),"_blank")}},_get_browse_link:function(j){var i;i=fk.get_browse_root(cM.get_viewer().photos_user);return String(G({path:""+i+(aA.normalize(aA.parent_dir(j.fq_path))),query:{select:j.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cJ.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return d6.enableSelection($(document.body))},disable_selection:function(){return d6.disableSelection($(document.body))},show_collection:function(T){var j,i;g.log_transition_to(cn.SINGLE_COLLECTION_VIEW);i=eE.deconstruct_url();j="/lightbox";if(i.path.indexOf(j)===0){i.path=i.path.slice(j.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(cT.call(i.path,"/album/")<0){if(i.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(T!=null){i.path=cJ.get(T).url}return eE.push_state(i.path,i.qargs)},show_all_collections:function(){g.log_transition_to(cn.ALBUMS_VIEW);return eE.push_state("/photos/all_albums")},show_all_photos:function(j){var i;j.preventDefault();g.log_transition_to(cn.PHOTOS_VIEW);i=eE.deconstruct_url();if(i.path==="/photos"){return this._refresh_view()}else{eW.clear();return eE.push_state("/photos")}},_back_to_photos:function(i){eW.clear();return this.show_all_photos(i)},_back_to_albums:function(i){eW.clear();return this.show_all_collections()},get_thumb_click_event_data:function(T,i){var j;j=T.event;return{timeline_photo_index:i,event_photo_index:j.photos.indexOf(T),num_photos_in_event:j.photos.length,event_index:this.get_timeline().events.list.indexOf(j.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(j){var i;i=this.get_timeline().get_photo_for_thumb_elm($(j.target));if(eW._drag_drop.ignore_next_click){return eW._drag_drop.ignore_next_click=false}else{return eW.photo_click(j,i)}},_thumb_double_click:function(fn){var T,j,i;j=this.get_timeline().get_photo_for_thumb_elm($(fn.target));i=this.get_timeline().index_of_photo(j);this._preview(i);T=this.get_thumb_click_event_data(j,i);return g.log_interaction(em.OPEN_LIGHTBOX,dc.DBL_CLICK,T)},_thumb_context_menu:function(fq){var fn,i,T,fr,fp,fo;T=this.get_timeline().get_photo_for_thumb_elm($(fq.target));if(fq.shiftKey){eW.photo_click(fq,T);return}if(eW.contains(T)){fr=eW.get()}else{fr=[T]}bn.show_photos(fq,fr);fo=[];for(fn=0,i=fr.length;fn<i;fn++){T=fr[fn];fo.push((fp=this.get_timeline().get_thumb_elm_for_photo(T))!=null?fp.addClassName("context-selected"):void 0)}return fo},_context_menu_hide:function(i){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(j){var i;i=eW.get();if(!i.length){return}eA.show(i,false);return g.log_interaction(em.SHARE,dc.SAH,{num_photos:i.length})},_clear_selected:function(j){var i;i=eW.get().length;eW.clear();return g.log_interaction(em.CLEAR_SELECTED,dc.SAH,{num_photos:i})},_share_collection:function(j){var i;cL(this.in_single_collection_view(),"_share_collection can only happen in single collection view");i=this.get_current_collection();if(i.num_items===0){ah.error(eB("This album is empty. Add some photos before you share it!"));return}eA.show(this.get_current_collection(),true);return g.log_interaction(em.SHARE_ALBUM,dc.SCA)},toggle_mem_lane_settings:function(i){var T,j;if(i){Event.extend(i).preventDefault()}if(!bF("#memory-lane-settings-menu").visible()){j=bF("#memory-lane-settings-menu");eU.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));T=function(fn){return fn.stopPropagation()};j.off("mousedown");j.off("click");j.on("mousedown",T);return j.on("click",T)}},show_delete_photos_modal:function(ft){var fu,fr,fp,fq,fo,fs,i,T,fn;if(ft.length===1){T=ft[0];if(T.duplicates_info!=null){this._show_duplicates_modal(T,true);return}}else{fu=[];for(fp=0,fq=ft.length;fp<fq;fp++){T=ft[fp];if(T.duplicates_info!=null){fr=T.duplicates_info.slice(0);fr.push(T);fr.sort(function(fv,j){return j.mtime-fv.mtime});fu=fu.concat(fr)}}if(fu.length){this._show_delete_multiple_duplicates_modal(ft,fu);return}}fn=c9.categorize_files(ft),fs=fn[0],i=fn[1];if(fs&&i){fo=bd("Delete %(file_count)s item?","Delete %(file_count)s items?",ft.length)}else{if(fs){fo=bd("Delete %(file_count)s photo?","Delete %(file_count)s photos?",ft.length)}else{fo=bd("Delete %(file_count)s video?","Delete %(file_count)s videos?",ft.length)}}return dM.show({title_text:fo.format({file_count:ft.length}),body_html:eB("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:c9.file_desc(ft)}),confirm_text:eB("Delete"),cancel_text:eB("Cancel"),confirm_callback:(function(j){return function(){return j._delete_photos(ft)}})(this)})},_delete_photos:function(fA){var fs,fu,fw,ft,fn,fr,fp,fv,fq,fy,i,T,fz,fo,fx;fA=fA.slice(0);fz=[];for(fr=0,fv=fA.length;fr<fv;fr++){T=fA[fr];fz.push(T.fq_path);if(T.duplicates_info!=null){fo=T.duplicates_info;for(fp=0,fq=fo.length;fp<fq;fp++){fn=fo[fp];fz.push(fn.fq_path)}}}fx=c9.categorize_files(fA),fy=fx[0],i=fx[1];if(fy&&i){ft=bd("Deleting file","Deleting files",fz.length);fw=bd("Deleted file.","Deleted files.",fz.length)}else{if(fy){ft=bd("Deleting photo","Deleting photos",fz.length);fw=bd("Deleted photo.","Deleted photos.",fz.length)}else{ft=bd("Deleting video","Deleting videos",fz.length);fw=bd("Deleted video.","Deleted videos.",fz.length)}}fu=function(j){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(j)},html_in_error_msg:true,progress_text:eB("Undoing..."),onSuccess:function(fB){var fC;fC=eB("Undo complete");ah.success(fC);return bQ._all_photos_timeline.restore_removed_photos()},subject_user:cM.get_viewer().photos_user})};fs=(function(j){return function(fB){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fz},job:fz.length>bQ.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cM.get_viewer().photos_user,progress_text:ft,onSuccess:function(fE){var fC,fF,fD;fF=fE.responseText.evalJSON();fD=bQ.undo_enabled&&(bQ._all_photos_timeline!=null);fC=fD?fF.changesets:null;X.notifyWithUndo(ft,fC,fu);bQ.get_timeline().remove_photos(fA);if(fB.length>0){return cJ.refresh_album_views(fB)}},subject_user:cM.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fz)},onSuccess:(function(j){return function(fD){var fC,fB,fE,fF;fB=JSON.parse(fD.responseText);fE=[];for(fF in fB){fC=fB[fF];fE=fE.concat(fC)}return fs(fE)}})(this)})},_preview:function(i){return aM.show(i)},_lightbox_delete:function(i){var j;j=i.memo.photo;g.log_interaction(em.DELETE,dc.LIGHTBOX);return this.show_delete_photos_modal([j])},_lightbox_remove:function(j){var i;i=j.memo.photo;this.get_current_collection().remove_photos([i]);return g.log_interaction(em.REMOVE,dc.LIGHTBOX)},_show_duplicates_modal:function(T,fB){var fu,fA,fr,fw,fv,fp,fy,fq,ft,fo,fs,fx,i,fn,fz;fv=T.duplicates_info.slice(0);fv.push(T);fv.sort(function(fC,j){return j.mtime-fC.mtime});fw=$("cu-duplicate-files");fp=[];for(fq=0,ft=fv.length;fq<ft;fq++){fr=fv[fq];fA="Dropbox"+aA.normalize(aA.parent_dir(fr.fq_path));fp.push(this._cu_duplicate_tmpl({thumbnail_url:fr.thumbnail_url,filename_snippet:bU.em_snippet(fr.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fA,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fr)}))}fw.__date(fp);if(fv.length>=5){fw.addClassName("scroll")}else{fw.removeClassName("scroll")}fn=c9.categorize_files([T]),fx=fn[0],i=fn[1];if(fx){fo=eB("There are multiple copies of this photo.");fs=eB("Delete all copies of this photo?")}else{fo=eB("There are multiple copies of this video.");fs=eB("Delete all copies of this video?")}if(fB){fy="delete_32";fz=fs;fu=fo+" "+eB("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fy="folder_32";fz=eB("Show in folder");fu=fo+" "+eB("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}dv.fillVal(fu,"cu-duplicates-desc");return fd.show(fz,$("cu-duplicates-modal"),{action:this._delete_photos.curry([T])})},_show_delete_multiple_duplicates_modal:function(fy,fu){var fx,fr,fv,fo,fp,ft,fn,fs,fq,fw,i,T;fv=$("cu-multiple-duplicate-files");fo=[];for(fp=0,ft=fu.length;fp<ft;fp++){fr=fu[fp];fx="Dropbox"+aA.normalize(aA.parent_dir(fr.fq_path));fo.push(this._cu_duplicate_tmpl({thumbnail_url:fr.thumbnail_url,filename_snippet:bU.em_snippet(fr.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fx,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fr)}))}fv.__date(fo);if(fu.length>=5){fv.addClassName("scroll")}else{fv.removeClassName("scroll")}T=c9.categorize_files(fy),fw=T[0],i=T[1];if(fw&&i){fn=eB("Delete %(num_files)s files and all copies?").format({num_files:fy.length});fs=eB("There are multiple copies of these files in your Dropbox.");fq=eB("Show files with multiple copies")}else{if(fw){fn=eB("Delete %(num_photos)s photos and all copies?").format({num_photos:fy.length});fs=eB("There are multiple copies of these photos in your Dropbox.");fq=eB("Show photos with multiple copies")}else{fn=eB("Delete %(num_videos)s videos and all copies?").format({num_videos:fy.length});fs=eB("There are multiple copies of these videos in your Dropbox.");fq=eB("Show videos with multiple copies")}}dv.fillVal(fs,"cu-multiple-duplicates-desc");dv.fillVal(fq,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return fd.show(fn,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fy)})},show_timestamps_modal:function(fp){var j,T,fn,i,fo;fp.sort_by_key((function(fq){return fq.time_taken}),true);i=(function(){var fr,fq,fs;fs=[];for(fr=0,fq=fp.length;fr<fq;fr++){fn=fp[fr];fs.push(fn.time_taken)}return fs})();j=(function(){var fr,fq,fs;fs=[];for(fr=0,fq=fp.length;fr<fq;fr++){fn=fp[fr];fs.push(fn.item_counter)}return fs})();T=(function(){var fr,fq,fs;fs=[];for(fr=0,fq=i.length;fr<fq;fr++){fo=i[fr];if(fo==null){fs.push(fo)}}return fs})();if(T.length===i.length){return this._show_add_timestamps_modal(fp,i,j)}else{if(T.length===0){return this._show_edit_timestamps_modal(fp,i,j)}else{return cL(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(i,j){return this._refresh_photo_events((function(T){return function(){var fn,fo;fo=("m_"+(j.getFullYear()))+(""+(j.getMonth()+1)).lpad(2);fn=T.get_timeline().events.valueFromKey(fo);cL(fn!=null,"Event is missing after a timestamp edit!");eC.update("2/3");fn.on_load_all_metadata=function(){T.get_timeline().scroll_to_photo_with_key(i.uniqueness_key);eC.hide();return ah.success("New timestamps have been saved!")};if(fn.has_loaded_metadata()){fn.on_load_all_metadata();return fn.on_load_all_metadata=null}else{return fn.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fo,j,i){var fn,T;T=bF("#add-timestamp-modal");fn=new I("date_picker",{disable_future:true});return fd.show("Set Timestamps",T[0],{action:(function(fp){return function(){var ft,fu,fx,fs,fq,fv,fw,fr;fv=d6.to_iso8601_date(fn.selected_date,false,true);fw=(function(){var fy,fA,fz;fz=[];for(ft=fy=0,fA=fo.length;0<=fA?fy<fA:fy>fA;ft=0<=fA?++fy:--fy){fz.push(fv)}return fz})();fr={};for(fu=fs=0,fq=i.length;fs<fq;fu=++fs){fx=i[fu];fr[fx]=fw[fu]}eC.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fr)},onSuccess:function(fy){eC.update("1/3");return fp._scroll_to_photo_after_timestamp_edit(fo[0],fn.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fs,fr,fn){var fp,j,i,fq,T,fo;fq=bF("#edit-timestamp-modal");i=(function(){var fu,ft,fv;fv=[];for(fu=0,ft=fr.length;fu<ft;fu++){fo=fr[fu];fv.push(N.toUTCDate(new Date(fo)))}return fv})();T={year:0,month:0,day:0,hour:0};fp=function(ft){return eB("%(date)s at %(time)s").format({date:N.localize(ft),time:N.format(ft,Constants.time_format)})};j=function(ft,fx,fy,fw){var fv,fu;if(ft==null){ft=0}if(fx==null){fx=0}if(fy==null){fy=0}if(fw==null){fw=0}T.year+=ft;T.month+=fx;T.day+=fy;T.hour+=fw;fu=b6.increment_date(new Date(i[0]),T.year,T.month,T.day,T.hour,0);fv=b6.increment_date(new Date(i[i.length-1]),T.year,T.month,T.day,T.hour,0);if(fs.length===1){return fq.find("#timestamp-new").text(fp(fu))}else{fq.find("#timestamp-new-start").text(fp(fu));return fq.find("#timestamp-new-end").text(fp(fv))}};if(fs.length===1){fq.find("#edit-timestamp-single").show();fq.find("#edit-timestamp-multi").hide();fq.find("#timestamp-current").text(fp(i[0]))}else{fq.find("#edit-timestamp-single").hide();fq.find("#edit-timestamp-multi").show();fq.find("#timestamp-current-start").text(fp(i[0]));fq.find("#timestamp-current-end").text(fp(i[i.length-1]))}j();bF("#timestamp-year-plus").on("click",j.curry(1,0,0,0));bF("#timestamp-year-minus").on("click",j.curry(-1,0,0,0));bF("#timestamp-month-plus").on("click",j.curry(0,1,0,0));bF("#timestamp-month-minus").on("click",j.curry(0,-1,0,0));bF("#timestamp-day-plus").on("click",j.curry(0,0,1,0));bF("#timestamp-day-minus").on("click",j.curry(0,0,-1,0));bF("#timestamp-hour-plus").on("click",j.curry(0,0,0,1));bF("#timestamp-hour-minus").on("click",j.curry(0,0,0,-1));fd.onHide=function(){var fu,fv,ft,fw;fw=["year","month","day","hour"];for(fv=0,ft=fw.length;fv<ft;fv++){fu=fw[fv];bF("#timestamp-"+fu+"-plus").off("click");bF("#timestamp-"+fu+"-minus").off("click")}fd.onHide=null;return fd.hide()};return fd.show("Edit Timestamps",fq[0],{action:(function(ft){return function(){var fE,fy,fu,fx,fC,fv,fz,fw,fD,fB,fF,fA;if((((T.year===(fB=T.month)&&fB===(fD=T.day))&&fD===(fw=T.hour))&&fw===0)){return}g.log_interaction(em.EDIT_TIMESTAMP,dc.PCM,{num_photos:fs.length});fv=(function(){var fH,fG,fI;fI=[];for(fH=0,fG=i.length;fH<fG;fH++){fE=i[fH];fI.push(b6.increment_date(fE,T.year,T.month,T.day,T.hour,0))}return fI})();fz=(function(){var fH,fG,fI;fI=[];for(fH=0,fG=fv.length;fH<fG;fH++){fF=fv[fH];fI.push(d6.to_iso8601_date(fF,false,true))}return fI})();fA={};for(fy=fx=0,fC=fn.length;fx<fC;fy=++fx){fu=fn[fy];fA[fu]=fz[fy]}eC.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fA)},job:fs.length>ft.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cM.get_viewer().photos_user,onSuccess:function(fG){eC.update("1/3");return ft._scroll_to_photo_after_timestamp_edit(fs[0],fv[0])}})}})(this)})},_preload_file_previews:function(fo){var fw,ft,fq,fp,fn,fv,fr,T,fA,fz,fx,fu,fs,fy;fy=this.get_timeline().get_photos();if(fo[0]<=fo[fo.length-1]){fu=null;for(fq=0,fv=fo.length;fq<fv;fq++){ft=fo[fq];T=fy[ft];if(T.status!==K.PLACEHOLDER){continue}fA=T.event;if(fu==null){fu=fA;fx=T}if(fA===fu){continue}if(fu.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fu.load_metadata();fu=fA;fx=T}if((fu!=null)&&!fu.has_loaded_metadata()){fw=fu.photos.indexOf(fx);fn=fu.photos.indexOf(T);if(fu.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fu.load_metadata_range(fw,fn)}}else{fs=[];for(fp=0,fr=fo.length;fp<fr;fp++){ft=fo[fp];T=fy[ft];if(T.status!==K.PLACEHOLDER){continue}fA=T.event;fz=fA.photos.indexOf(T);fs.push(fA.load_metadata(fz))}return fs}},_lightbox_photo_change:function(ft){var fq,fp,fn,fv,fo,fu,i,fs,fr,T;this._last_lightbox_photo=ft.memo.preview_obj.photo;fn=ft.memo.index;fo=aM.num_previews();if(fn===0||fn===fo-1){return}if(ft.memo.direction===aM.NEXT||(ft.memo.direction==null)){fv=Math.min(fn+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fo-1);return this._preload_file_previews((function(){fr=[];for(var fw=i=fn+1;i<=fv?fw<=fv:fw>=fv;i<=fv?fw++:fw--){fr.push(fw)}return fr}).apply(this))}else{if(ft.memo.direction===aM.PREV){fu=Math.max(fn-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){T=[];for(var j=fs=fn-1;fs<=fu?j<=fu:j>=fu;fs<=fu?j++:j--){T.push(j)}return T}).apply(this))}}},_lightbox_exit:function(i){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var j,fn,T,i;i=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){i+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}j=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((fn=this._all_photos_timeline)!=null){fn.update_offsets(i,j)}return(T=this._single_collection_timeline)!=null?T.update_offsets(i,j):void 0},_history_change_handler:function(fy,fx){var fr,ft,fw,fo,fu,fn,i,fv,fs,fq,fp,T;if(this._init_finished){if(fd.shown()){fd.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((i=this.get_timeline())!=null){i.unlisten()}if(fy==="all_albums"){cJ.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((fv=$("all-albums-sidebar"))!=null){fv.addClassName("selected")}eW.clear();document.title=eB("Albums")+" - Dropbox";cJ.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fy.startsWith("album/")){fr=cJ.get_from_url("/photos/"+fy);fs=$$(".sidebar-album");for(fo=0,fu=fs.length;fo<fu;fo++){fw=fs[fo];if(fw.readAttribute("data-gid")===fr.gid){fw.addClassName("selected");break}}$("single-collection-title").__date(bU.em_snippet(fr.name,cJ.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fr.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fr.shmodel_url);if(((fq=fr.member_fnames)!=null?fq.length:void 0)>1){ft=eB("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:c9.album_desc(fr),album_members:d6.nice_list(fr.member_fnames)});$("single-collection-share-status").__date(ft)}else{$("single-collection-share-status").__date(eB("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fr.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=fr.name+" - Dropbox";cA.log_event("show_collection",fr.gid,fr.num_photos,fr.is_anonymous)}else{fr=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=eB("Photos")+" - Dropbox"}fn=false;if(fr!=null){if(fr.gid!==this._current_collection_gid){fn=true}}else{if(this._all_photos_timeline==null){fn=true}}this._current_collection_gid=fr!=null?fr.gid:null;if(fn){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){T=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(T);if((fp=$(T))!=null){fp.addClassName("wiggobble")}setTimeout((function(){return $(T).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aO;aO=INLINE_JS.PhotosTour=E.PhotosTour={_frame:0,next:function(){var i;fd.show("",bF("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);i=this._frame;g.log_interaction(a8.SHOW_MODAL,"",{frame:i});bF("#modal-x").off("click");bF("#modal-x").on("click",((function(j){return function(){return g.log_interaction(a8.EXIT_MODAL,"",{frame:i})}})(this)));return this._frame=(this._frame+1)%4},hide:function(i){g.log_interaction(i,"");return fd.hide()}};var c9;c9=E.PhotosUtil={categorize_files:function(j){var T,i;T=j.filter(function(fn){return fn.preview_type==="photo"});i=j.filter(function(fn){return fn.preview_type==="video"});return[T.length,i.length]},file_desc:function(fp,fn,i){var j,fo,T;if(fn==null){fn=false}if(i==null){i=false}T=this.categorize_files(fp),j=T[0],fo=T[1];return this._photo_video_desc(j,fo,fn,i)},album_desc:function(T,j,i){if(j==null){j=false}if(i==null){i=false}return this._photo_video_desc(T.num_photos,T.num_videos,j,i)},_photo_video_desc:function(j,fq,T,i){var fn,fp,fo;fp=bd("%d photo","%d photos",j,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(j);fo=bd("%d video","%d videos",fq,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fq);if(j&&fq){if(T){fn=j+fq;return bd("%d item","%d items",fn).format(fn)}else{if(i){return new fi(fp+"<br/>"+fo)}else{return eB("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:fp,num_videos:fo})}}}else{if(j){return fp}else{if(fq){return fo}else{return""}}}}};var eW,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};eW=INLINE_JS.PhotosSelection=E.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&i._last_mouseover&&!C.focus_in_input()){return i._highlight_range(i._last_selected,i._last_mouseover)}}})(this));$(document.body).on("keyup",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&!i._marquee.active){return i.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bQ.KEY_SCOPE,(function(i){return function(j){j.preventDefault();if(bQ.in_single_collection_view()){if(i._selected.length){return cJ.show_remove_photos_modal(bQ.get_current_collection(),i._selected)}}else{if(i._selected.length){return bQ.show_delete_photos_modal(i._selected)}}}})(this));key("esc",bQ.KEY_SCOPE,(function(i){return function(T){var j;if(typeof T.preventDefault==="function"){T.preventDefault()}if(i._drag_drop.active){i._drag_drop.active=false;if((j=$("albums-sidebar-list"))!=null){j.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{i.clear();return g.log_interaction(em.CLEAR_SELECTED,dc.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return A.init(null,bF("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(j){var T,i,fn;fn=(function(){var fp,fo,fr,fq;fr=this._selected;fq=[];for(fp=0,fo=fr.length;fp<fo;fp++){i=fr[fp];fq.push(i.uniqueness_key)}return fq}).call(this);return T=j.uniqueness_key,cT.call(fn,T)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eU.hide_all();return document.fire(eW.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(j,i){if(j.isRightClick()&&!j.shiftKey){return}if(j.shiftKey){return this._select_highlighted()}else{if(this.contains(i)){return this._remove(i)}else{return this._add(i)}}},num_selected:function(){return this._selected.length},refresh:function(T){var fq,fo,fn,fr,fp,i,fs;fs=(function(){var fu,ft,fw,fv;fw=this._selected;fv=[];for(fu=0,ft=fw.length;fu<ft;fu++){i=fw[fu];fv.push(i.uniqueness_key)}return fv}).call(this);fp=[];for(fo=0,fn=T.length;fo<fn;fo++){fr=T[fo];fq=fs.indexOf(fr.uniqueness_key);if(fq>=0){fp.push(this._selected[fq]=fr)}else{fp.push(void 0)}}return fp},inc_num_loading_events_before_select:function(i){if(!this._show_share_after_loading_selected){eC.show(eB("Loading photos..."))}this._show_share_after_loading_selected=i;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;eC.update((this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){eC.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bQ._share_selected()}}}},_photo_mouseover:function(i){this._last_mouseover=bQ.get_timeline().get_photo_for_thumb_elm($(i.target));if(i.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(i){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(fn){var i,T,j;if(bQ.in_all_collections_view()||fn.isRightClick()||this._invalid_mouse_target($(fn.target))){return}bn.hide();eU.hide_all();i=(T=bQ.get_timeline())!=null?T.get_photo_for_thumb_elm($(fn.target)):void 0;if(i!=null){if(this.contains(i)||!eW.drag_select_enabled){j=C.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=fn.clientX+j.left;this._drag_drop.start_y=fn.clientY+j.top;this._drag_drop.anchor=$(fn.target);this._drag_drop.single_photo=this.contains(i)?null:i;this._build_drag_status(i);this._update_drag_status_position(fn)}else{this._drag_select.active=true;this._drag_select.anchor=i}}else{j=C.scroll_offsets();if((fn.clientX+j.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=fn.clientX+j.left;this._marquee.start_y=fn.clientY+j.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return A.start()},_body_mousemove:function(fn){var T,j,i,fo;j=C.scroll_offsets();i=fn.clientX+j.left;fo=fn.clientY+j.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(i-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fo-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=i;this._marquee.end_y=fo;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(i-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fo-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(fn);$$(".sidebar-album").invoke("removeClassName","album-flash");if((T=$("albums-sidebar-list"))!=null){T.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(T){var j,i;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();j=this._highlighted.length;this._select_highlighted();if(j){g.log_interaction(em.MARQUEE_SELECT,dc.DRAG,{num_selected:j})}}if(this._drag_drop.active){if($(T.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((i=$("albums-sidebar-list"))!=null){i.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return A.end()},_body_double_click:function(i){if(bQ.get_timeline().get_photo_for_thumb_elm($(i.target))||this._invalid_mouse_target($(i.target))){return}this.clear();return g.log_interaction(em.CLEAR_SELECTED,dc.DBL_CLICK)},_draw_marquee:function(){var i,fo,fn,T,j;j=Math.abs(this._marquee.start_x-this._marquee.end_x);i=Math.abs(this._marquee.start_y-this._marquee.end_y);fn=Math.min(this._marquee.start_y,this._marquee.end_y);fo=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:j+"px",height:i+"px",top:fn+"px",left:fo+"px"});$("marquee").show();T=false;if(bQ.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);T=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);T=true}if(T){return this._update_marquee_highlight(fn,fo,j,i)}}},_update_marquee_highlight:function(fy,fp,T,fz){var fv,ft,fq,fw,fs,fr,fn,fx,fu,fo;this.clear_highlighted();fo=[];fw=bQ.get_timeline().grid.photo_col_offsets.length;fn=bQ.get_timeline().grid.photo_col_offsets.slice(0,fw-1);for(fv=ft=0,fs=fn.length;ft<fs;fv=++ft){fr=fn[fv];if(fr<=fp+T&&bQ.get_timeline().grid.photo_col_offsets[fv+1]>=fp){fo.push(fv)}}fu=[];for(fv=fq=0,fx=bQ.get_timeline().events.length();0<=fx?fq<fx:fq>fx;fv=0<=fx?++fq:--fq){fu.push(bQ.get_timeline().events.valueAtIndex(fv).marquee_highlight(fy,fy+fz,fo))}return fu},_update_marquee_x_bounds:function(T){var fq,fo,fn,fs,ft,fr,fp;fs=$(document.body).getWidth();if(T<bQ.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bQ.get_timeline().grid.photo_col_offsets.first()}else{if(T>bQ.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fs}else{fr=bQ.get_timeline().grid.photo_col_offsets;fp=[];for(fq=fo=0,fn=fr.length;fo<fn;fq=++fo){ft=fr[fq];if(ft>T){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets[fq-1];this._marquee.x_max_boundary=ft;break}else{fp.push(void 0)}}return fp}}},_update_marquee_y_bounds:function(ft){var T,fr,fo,fn,fq,fs,fp;fq=$(document.body).getHeight();if(ft<bQ.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bQ.get_timeline().grid.photo_row_offsets.first()}else{if(ft>bQ.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=fq}else{fs=bQ.get_timeline().grid.photo_row_offsets;fp=[];for(fr=fo=0,fn=fs.length;fo<fn;fr=++fo){T=fs[fr];if(T>ft){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets[fr-1];this._marquee.y_max_boundary=T;break}else{fp.push(void 0)}}return fp}}},_build_drag_status:function(fn){var T,i,j;i=bQ.get_timeline().get_thumb_elm_for_photo(fn);j=i.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(j);T=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(c9.file_desc(T,false,true))},_update_drag_status_position:function(i){return $("photos-drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fA,fz,fo){var fy,T,fq,ft,fr,fw,fu,fp,fx,fv,fs,fn;if(fo==null){fo=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fA;this._last_highlight_to_photo=fz;fq=bQ.get_timeline().index_of_photo(fA);fn=bQ.get_timeline().index_of_photo(fz);fy=!fo&&this.contains(fz)&&!this.contains(fA);fs=[];for(ft=fr=fp=fq,fx=fn;fp<=fx?fr<=fx:fr>=fx;ft=fp<=fx?++fr:--fr){fu=bQ.get_timeline().photo_at_index(ft);if(fu.status===K.PLACEHOLDER){if(fu.event!==fw){T=fu.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(fv=T.unique_id,cT.call(this._events_highlighting,fv)<0){this._events_highlighting.push(T.unique_id)}fs.push(fw=T)}else{fs.push(void 0)}}else{fs.push(void 0)}}else{if(this.contains(fu)){if(fy){fs.push(this._dehighlight(fu))}else{fs.push(void 0)}}else{if(!fy){fs.push(this._highlight(fu))}else{fs.push(void 0)}}}}return fs},_highlight_range_incremental:function(T){var fv,fo,fw,fr,fq,fs,fp,ft,fn,fu;fw=this._last_highlight_from_photo;fu=this._last_highlight_to_photo;if(!((fw!=null)&&(fu!=null))){return}fo=bQ.get_timeline().index_of_photo(fw);fn=bQ.get_timeline().index_of_photo(fu);for(fr=fq=fp=fo,ft=fn;fp<=ft?fq<=ft:fq>=ft;fr=fp<=ft?++fq:--fq){fs=bQ.get_timeline().photo_at_index(fr);if(fs.status!==K.PLACEHOLDER&&!this.contains(fs)&&this._highlighted.indexOf(fs)===-1){this._highlight(fs)}}fv=this._events_highlighting.indexOf(T.unique_id);if(fv>=0){this._events_highlighting.splice(fv,1)}if(this._select_highlighted_waiting){eC.update((this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(fo){var fn,T,i,fp;this.clear_highlighted();fp=[];for(fn=0,T=fo.length;fn<T;fn++){i=fo[fn];if(!this.contains(i)){fp.push(this._highlight(i))}else{fp.push(void 0)}}return fp},_select_highlighted:function(){var fq,fn,fp,T,fo,fr,i;if(this._events_highlighting.length>0){eC.show(eB("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fr=this._highlighted;for(fq=0,fp=fr.length;fq<fp;fq++){fo=fr[fq];this._add(fo)}i=this._dehighlighted;for(fn=0,T=i.length;fn<T;fn++){fo=i[fn];this._remove(fo)}if(this._select_highlighted_waiting){eC.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(j){var i;this._highlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("highlighted"):void 0},_dehighlight:function(j){var i;this._dehighlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("dehighlighted"):void 0},_add:function(j){var i;cL(j.status!==K.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);i=bQ.get_timeline().get_thumb_elm_for_photo(j);if(i!=null){i.addClassName("selected")}this._selected.push(j);this._last_selected=j;dv.fillVal(c9.file_desc(this._selected,true),"selected-desc");dv.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eW.CHANGE_EVT)},_remove:function(T){var j,i;i=bQ.get_timeline().get_thumb_elm_for_photo(T);if(i!=null){i.removeClassName("selected")}j=this._selected.indexOf(T);if(j!==-1){this._selected.splice(j,1);this._last_selected=T;if(this._selected.length){dv.fillVal(c9.file_desc(this._selected,true),"selected-desc");dv.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eW.CHANGE_EVT)},_invalid_mouse_target:function(fn){var T,i,j;j=fn.classNames().toArray().concat(fn.up().classNames().toArray());return(cT.call(j,"freshbutton")>=0)||(cT.call(j,"freshbutton-blue")>=0)||(cT.call(j,"freshbutton-lightblue")>=0)||(cT.call(j,"freshbutton-blue-on-gray")>=0)||(cT.call(j,"timeline-elm")>=0)||(fn.up(".no-marquee")!=null)||(fn.up("#context-menu")!=null)||(fn.up(".freshdropdown-menu")!=null)||fn.nodeName==="A"||((T=fn.tagName.toUpperCase())==="INPUT"||T==="TEXTAREA"||T==="SELECT")||fd.shown()||((i=$("modal-progress-content"))!=null?i.visible():void 0)||aM.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cJ,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};cJ=INLINE_JS.PhotosCollections=E.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new fi('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(j,i){this._collections=j;this._gid_to_collection=j.dict_by("gid");this._url_to_collection=j.dict_by("url");this._collection_list_item_tmpl=fi.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=fi.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var i;i=eE.deconstruct_url();if(i.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(i){if(this._num_loading_collections!==null&&(this._num_loading_collections<i||i===null)){this._num_loading_collections=i;return cE.WebRequest({url:"/collections",data:{limit:i},subject_user:cM.get_viewer().photos_user,success:(function(j){return function(fs){var fr,fq,fo,T,fp,fn;fn=JSON.parse(fs);for(fo=0,T=fn.length;fo<T;fo++){fq=fn[fo];if(!(fq.gid in j._gid_to_collection)&&!(fp=fq.gid,cT.call(j._removed_pre_load,fp)>=0)){fr=new ad(fq,false);j._collections.push(fr);j._gid_to_collection[fr.gid]=fr;j._url_to_collection[fr.url]=fr}}if(i===null||fn.length<i){j._all_collections_loaded=true;j._sidebar_collections_loaded=true}if(i>=5){j._sidebar_collections_loaded=true}return j.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(i){return function(j){if(!bQ.get_current_collection().is_creator){return}i.header_rename();return g.log_interaction(em.RENAME_ALBUM,dc.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bn.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(ad.CREATE_EVT,this._collection_created.bind(this));document.observe(ad.ADD_EVT,this._collection_photos_added.bind(this));document.observe(ad.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(ad.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(ad.RENAME_EVT,this._collection_renamed.bind(this));document.observe(ad.DELETE_EVT,this._collection_deleted.bind(this));document.observe(ad.SHARE_EVT,this._collection_shared.bind(this));document.observe(ad.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(ad.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var fp,fn,T,i,fo;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}fn=[];fo=this._collections;for(T=0,i=fo.length;T<i;T++){fp=fo[T];fn.push(this._collection_list_item_tmpl({collection:fp,additional_class:"albums-list-item show-collection-target",Sprite:cx,Emstring:bU}))}$("albums-list").__date(fn);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fq,fn,fp,T,i,fo;fn=[];fp={name:eB("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};fn.push(this._collection_list_item_tmpl({collection:fp,additional_class:"create-album-target",hide_icons:true,Sprite:cx,Emstring:bU}));fo=this._collections;for(T=0,i=fo.length;T<i;T++){fq=fo[T];fn.push(this._collection_list_item_tmpl({collection:fq,additional_class:"add-to-album-target",Sprite:cx,Emstring:bU}))}$("add-to-album-modal-list").__date(fn);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fs,T,fq,ft,i,fr,fp,fo,fn;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();ft=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:eB,Sprite:cx,PhotosCollections:cJ});if((i=$("albums-sidebar"))!=null){i.__date(ft)}if((fr=$("all-albums-sidebar"))!=null){fr.observe("click",bQ.show_all_collections)}if((fp=$("all-albums-sidebar"))!=null){fp.observe("mouseup",(function(j){return function(fu){var fv;if(!eW._drag_drop.active){return}if(eW._drag_drop.single_photo!=null){fv=[eW._drag_drop.single_photo]}else{fv=eW.get()}j.show_add_to_album_modal(fu,fv);return g.log_interaction(em.ADD_TO_OTHER_ALBUM,dc.DROP_TARGET,{num_photos:eW.get().length})}})(this))}if(bQ.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bQ.in_single_collection_view()){fo=$$(".sidebar-album");fn=[];for(T=0,fq=fo.length;T<fq;T++){fs=fo[T];if(fs.readAttribute("data-gid")===bQ.get_current_collection().gid){fs.addClassName("selected");break}else{fn.push(void 0)}}return fn}}},refresh_album_views:function(j){var i;if(j==null){j=null}i=(function(T){return function(){T.render_all_albums_view();T.render_albums_sidebar();return T.render_add_to_album_modal()}})(this);if(j!=null?j.length:void 0){return cE.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(j.unique())},subject_user:cM.get_viewer().photos_user,success:(function(T){return function(fp){var fx,fu,fo,ft,fs,fq,fv,fr,fn,fw;fn=JSON.parse(fp);for(fs=0,fv=fn.length;fs<fv;fs++){fo=fn[fs];fu=new ad(fo,false);T._gid_to_collection[fu.gid]=fu;T._url_to_collection[fu.url]=fu;fw=T._collections;for(ft=fq=0,fr=fw.length;fq<fr;ft=++fq){fx=fw[ft];if(fx.gid===fu.gid){T._collections[ft]=fu;break}}}return i()}})(this)})}else{return i()}},show_add_to_album_modal:function(i,j){if(j!==eW.get()&&(eW._drag_drop.single_photo==null)){eW._context_selected=j}fd.onHide=function(){eW._context_selected=null;delete fd.onHide;return fd.hide()};fd.show(eB("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(T,fo,j){var i,fn;if(j==null){j=true}fn=bQ.get_current_collection_gid();i=fo.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ah.success(eB("Adding to album..."));return T.add_photos(fo,fn,i,j)},show_remove_photos_modal:function(fn,fp){var T,i,fo,j;j=c9.categorize_files(fp),i=j[0],fo=j[1];if(i&&fo){T=bd("Remove %(file_count)s item?","Remove %(file_count)s items?",fp.length)}else{if(i){T=bd("Remove %(file_count)s photo?","Remove %(file_count)s photos?",fp.length)}else{T=bd("Remove %(file_count)s video?","Remove %(file_count)s videos?",fp.length)}}T=T.format({file_count:fp.length});dv.fillVal(c9.file_desc(fp),"collection-remove-files");dv.fillVal(fn.name.escapeHTML(),"collection-remove-name");return fd.show(T,dv.fromElm("collection-remove-modal"),{action:(function(fq){return function(){var fr;fp=fp.slice(0);fr=fp.length>fq.NUM_PHOTOS_LONG_RUNNING_REMOVES;return fn.remove_photos(fp,fr)}})(this)})},header_rename:function(){if(bF("#single-collection-title-container").hasClass("editing")){return}bF("#single-collection-title-container").addClass("editing");return bQ.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(j){var i;dv.fillVal(j.name.escapeHTML(),"collection-delete-name");i=eB("Delete album?");return fd.show(i,dv.fromElm("collection-delete-modal"),{action:function(){if(j.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ah.success(eB("Deleting '%(collection_name)s'...").format({collection_name:j.name}),100)}return j["delete"]()}})},show_unshare_modal:function(j){var i;dv.fillVal(j.name.escapeHTML(),"collection-unshare-name");i=eB("Unshare album?");return fd.show(i,dv.fromElm("collection-unshare-modal"),{action:function(){return j.unshare()}})},create:function(fs,fr,fw,j){var fn,fo,T,fp,fu,fv,ft,i,fq;if(j==null){j=false}if(fs){Event.extend(fs).preventDefault();fq=$(fs.target);if(fq.hasClassName("inplaceeditor-form")||(fq.up(".inplaceeditor-form")!=null)){return}if(fq.up("#context-menu")){fn=true}else{if(fq.up(".freshdropdown-menu")){T=true}}}bQ.enable_selection();if(!fw){fw=eW.get()}fp=(function(){var fy,fx,fz;fz=[];for(fy=0,fx=fw.length;fy<fx;fy++){i=fw[fy];fz.push(i.item_counter)}return fz})();fw.sort_by_key(function(fx){return fx.time_taken});fu=fw.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ft=(function(fx){return function(fz){var fC,fA,fy,fB;fA=JSON.parse(fz.responseText);fC=new ad(fA);eW.clear();eU.hide_all();bn.hide();fd.hide();bQ.disable_selection();fB=eB("Created '%(collection_name)s'");fy=fC.name.escapeHTML();fB=fB.format({collection_name:"<a data-gid='"+fC.gid+"' class='show-collection-target'>"+fy+"</a>"});ah.success(new fi(fB));return fx.flash_sidebar_album(fC.gid)}})(this);fv=function(){if(!T){eU.hide_all()}if(!fn){bn.hide()}cJ.render_albums_sidebar();return bQ.disable_selection()};fo=new Ajax.InPlaceEditor(fr,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:j,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fv,onFailure:function(){},savingText:eB("Creating..."),onLeaveEditMode:bQ.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:ft,job:fu,job_user:cM.get_viewer().photos_user,progress_text:eB("Creating album...")},callback:function(fx,fz){var fy;ah.success(eB("Creating album..."));fy={collection_name:fz,item_counters:JSON.stringify(fp),source_collection_gid:bQ.get_current_collection_gid()};return fy}});fo.enterEditMode();if(!j){return fo._controls.editor.observe("blur",fv)}},toggle_more_selected_actions:function(i){if(i){Event.extend(i).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eU.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(i){var j;if(i){Event.extend(i).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bQ.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(b1.msie_version_at_most(10)){j=bF("#more-collection-actions-menu");if(!j.parent().is("body")){bF(document.body).append(j.remove())}}return eU.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(i){var j;j=i.memo.collection;if(!j.is_anonymous){this._collections.unshift(j)}this._gid_to_collection[j.gid]=j;this._url_to_collection[j.url]=j;return this.refresh_album_views()},_collection_changed:function(i){this._collections.removeItem(i);this._collections.unshift(i);return this.refresh_album_views()},_collection_photos_added:function(fr){var fq,fp,fo,fs,ft,T,i,j,fu,fn;fq=fr.memo.collection;fu=fr.memo.photos;fs=fr.memo.num_items_added;T=fr.memo.num_photos_added;j=fr.memo.num_videos_added;if(fr.memo.promote_collection&&fs>0){this._collection_changed(fq)}else{this.refresh_album_views()}if(fu===eW.get()){eW.clear()}if(fs<1){fn=c9.categorize_files(fu),ft=fn[0],i=fn[1];if(ft&&i){fo=bd("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fu.length)}else{if(ft){fo=bd("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fu.length)}else{fo=bd("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fu.length)}}}else{if(T&&j){fo=bd("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fu.length)}else{if(T){fo=bd("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fu.length)}else{fo=bd("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fu.length)}}}fp=fq.name.escapeHTML();fo=fo.format({collection_name:"<a data-gid='"+fq.gid+"' class='show-collection-target'>"+fp+"</a>"});return ah.success(new fi(fo))},_collection_photos_removed:function(j){var T,fn,i;T=j.memo.collection;fn=j.memo.photos;i=bQ.undo_enabled?j.memo.undo_changeset:null;bQ.get_timeline().remove_photos(fn);this._collection_changed(T);return ah.success(eB("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:c9.file_desc(fn),collection_name:T.name}),null,null,i,(function(){return T.undo_remove(i)}))},_collection_undid_remove:function(i){var j;j=i.memo.collection;bQ.get_timeline().restore_removed_photos();cJ.refresh_album_views([j.gid]);return ah.success(eB("Undo complete"))},_collection_renamed:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-title").text(bU.em_snippet(T.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=T.name+" - Dropbox"}this._collection_changed(T);return ah.success(eB("Renamed '%(collection_name)s'").format({collection_name:T.name}))},_collection_deleted:function(j){var T,i;T=j.memo.collection;this._collections.removeItem(T);if(!this._all_collections_loaded){this._removed_pre_load.push(T.gid)}this.refresh_album_views();if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bQ.show_all_collections()}delete this._gid_to_collection[T.gid];delete this._url_to_collection[T.url];return ah.success(eB("Deleted '%(collection_name)s'").format({collection_name:T.name}))},_collection_shared:function(j){var T,i;T=j.memo.collection;this._collection_changed(T);if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text(eB("Shared"));return bF("#single-collection-share-status").attr("href",T.shmodel_url)}},_collection_unshared:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text("")}return ah.success(eB("Unshared '%(collection_name)s'").format({collection_name:T.name}))},_collection_cover_changed:function(i){var T,j;T=i.memo.collection;this._collection_changed(T);j=eB("Changed cover photo for '%(collection_name)s'");j=j.format({collection_name:T.name.escapeHTML()});return ah.success(j)},_albums_list_item_contextmenu:function(j,i){bn.show_photo_collection(j,this.get(i.readAttribute("data-gid")),i);i.removeClassName("album-flash");return i.addClassName("context-selected")},_show_collection_click:function(T,i){var j;j=$(T.target);if(j.hasClassName("inplaceeditor-form")||(j.up(".inplaceeditor-form")!=null)){return}return bQ.show_collection(i.readAttribute("data-gid"))},_collection_shmodel_click:function(j,i){return this.go_to_link(this.get(i.readAttribute("data-gid")))},_add_to_album_click:function(j,i){if(eW._context_selected){this.add_photos(this.get(i.readAttribute("data-gid")),eW._context_selected);eW._context_selected=null}else{this.add_photos(this.get(i.readAttribute("data-gid")),eW.get())}delete fd.onHide;fd.hide();return g.log_interaction(em.ADD_TO_RECENT_ALBUM,dc.SAH,{num_photos:eW.get().length})},_drop_target_mouseover:function(j,i){if(eW._drag_drop.active){i.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(j,i){if(eW._drag_drop.active){i.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(j,i){var T;if(i.hasClassName("hovered")){i.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eW._drag_drop.single_photo!=null){T=[eW._drag_drop.single_photo]}else{T=eW.get()}if(i.readAttribute("data-gid")!=null){this.add_photos(this.get(i.readAttribute("data-gid")),T,false)}if(i.identify()==="add-to-album-sidebar-new"){return g.log_interaction(em.ADD_TO_NEW_ALBUM,dc.DROP_TARGET,{num_photos:eW.get().length})}else{if(i.identify()==="all-albums-sidebar"){return g.log_interaction(em.ADD_TO_OTHER_ALBUM,dc.DROP_TARGET,{num_photos:eW.get().length})}else{return g.log_interaction(em.ADD_TO_RECENT_ALBUM,dc.DROP_TARGET,{num_photos:eW.get().length})}}}},_create_album_click:function(i,j){if(eW._context_selected){this.create(i,j.down(".collection-name"),eW._context_selected,true);return eW._context_selected=null}else{return this.create(i,j.down(".collection-name"),eW.get(),true)}},_window_scroll:function(){if(bQ.in_all_collections_view()){return this._all_albums_scroll_position=C.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(i){return this._url_to_collection[i]},get:function(i){return this._gid_to_collection[i]},go_to_link:function(i){return window.open(i.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(T,j){var i,fo,fn;i=bU.em_snippet(T,j,1);fo=i.lastIndexOf(" ");if(fo===-1){return i}else{i=i.slice(0,+fo+1||9000000000);fn=bU.em_snippet(T.slice(fo+1),j,1);return i+fn}},get_default_album_name:function(){var i;i=eB("Untitled album");return this.increment_collection_name_until_valid(i)},collection_name_in_use:function(fn){var fp,T,i,fo;fo=this.get_all();for(T=0,i=fo.length;T<i;T++){fp=fo[T];if(fp.name===fn.trim()){return true}}return false},increment_collection_name_until_valid:function(j){var T,i;T=this.collection_name_in_use(j);i=0;while(T){i++;T=this.collection_name_in_use(j+(" ("+i+")"))}return(i===0?j:j+(" ("+i+")"))},flash_sidebar_album:function(fp){var fq,T,i,fo,fn;fo=$$(".sidebar-album");fn=[];for(T=0,i=fo.length;T<i;T++){fq=fo[T];if(fq.readAttribute("data-gid")===fp){fq.removeClassName("album-flash");fq.addClassName("album-flash");break}else{fn.push(void 0)}}return fn}};var ck;ck=E.PhotoTimeline=(function(){i.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";i.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";i.prototype.THUMB_SIZE=null;i.prototype.HEADER_HEIGHT=null;i.prototype.THUMBS_PER_ROW=4;i.prototype.RENDER_SCROLL_WAIT=100;i.prototype.RENDER_SCROLL_MAX_WAIT=750;i.prototype.HIDE_TIMELINE_NAV_DELAY=1500;i.prototype.THUMBS_BATCH_SIZE=12;i.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;i.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;i.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;i.prototype.TIMELINE_NAV_ELM_HEIGHT=20;i.prototype.TIMELINE_DOT_HTML=cx.html("web","timeline_dot");i.container;i.scroll_container;i.events;i.current_event;i.key_to_photo;i.preview_objs;i.tmpl;i.last_render_scroll_timeout;i.start_render_scroll_time;i.last_scroll_position;i.hide_timeline_nav_timeout;i.grid;i._skip_scroll_update;i.header_id_to_sel_items;i.event_remove_info;i.opts;function i(T,fn,fq,fo,fp,fr,fs,ft,j){this.container=T;this.scroll_container=fn;this.tmpl=fs;this.opts=j;this.THUMB_SIZE=ft.thumb_size;this.HEADER_HEIGHT=ft.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fr;this.event_remove_info=[];this._init_events(fq,fo,fp);this.update_offsets(ft.top_offset,ft.left_offset);this.listen();dA.start_capture(this.scroll_container)}i.prototype._init_events=function(fu,fo,fq){var fn,fs,fx,fp,fr,ft,fv,fw,T;if(fu.length<1){this.events=new a0([],{});return}fs=[];fr={};fx=false;for(ft=0,fv=fu.length;ft<fv;ft++){fp=fu[ft];fp=String(fp);T=fp in this.header_id_to_sel_items?this.header_id_to_sel_items[fp]:[];fw=false;if(T.length&&!fx){fx=true;fw=true}fn=new dd(this,fp,fo[fp],fq[fp],T,fw);fs.push(fp);fr[fp]=fn}return this.events=new a0(fs,fr)};i.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(dd.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};i.prototype.unlisten=function(){var fn,T,j;if((fn=this._body_mousemove_handler)!=null){fn.stop()}if((T=this._timeline_elm_click_handler)!=null){T.stop()}if((j=this._show_missing_timestamp_bucket_handler)!=null){j.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(dd.EVENT_MISCOUNT_EVT)};i.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};i.prototype.update_offsets=function(fn,T){var fq,fo,fr,fp;cL(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=fn;this.refresh_row_offsets();this.left_offset=T;this.grid.photo_col_offsets=[];fp=[];for(fq=fo=0,fr=this.THUMBS_PER_ROW;0<=fr?fo<=fr:fo>=fr;fq=0<=fr?++fo:--fo){fp.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fq))}return fp};i.prototype.refresh_row_offsets=function(){var ft,fs,fq,fp,fo,T,fr,fn;this.grid.photo_row_offsets=[];ft=this.top_offset;fr=this.events.getValues();for(fp=0,T=fr.length;fp<T;fp++){fs=fr[fp];fs.top_offset=ft;ft+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(ft);for(fq=fo=0,fn=fs.get_num_rows();0<=fn?fo<fn:fo>fn;fq=0<=fn?++fo:--fo){ft+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(ft)}}};i.prototype._render_empty_grid=function(){var fp,fn,T,fq,fo;this.container.__date();fo=this.events.getValues();for(fn=0,T=fo.length;fn<T;fn++){fp=fo[fn];if(!(fp.is_missing_timestamp_bucket()&&this.events.length()>1)){fp.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fq=bF('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(eB("Show photos with missing dates"));return bF(this.container).append(fq)}};i.prototype._render_viewport=function(fn){var T,fz,fp,fu,fs,fq,fv,fx,ft,fr,fo,fy,fw,fA;if(fn==null){fn=false}this.start_render_scroll_time=-1;fA=this.get_viewport_info();fz=[];fo=this.events.getValues();for(fu=0,fx=fo.length;fu<fx;fu++){T=fo[fu];if(!(T.has_loaded_metadata()||T.loading_metadata||(T.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(T.in_current_viewport(fA,false)){fz.unshift(T)}else{if(T.in_current_viewport(fA,true)){fz.push(T)}}}}for(fs=0,ft=fz.length;fs<ft;fs++){T=fz[fs];fy=T.get_photo_range_to_render(fA,true),fp=fy[0],fv=fy[1];T.load_metadata_range(fp,fv)}if(fn){fA=this.get_viewport_info();fw=this.events.getValues();for(fq=0,fr=fw.length;fq<fr;fq++){T=fw[fq];if(T.in_current_viewport(fA,false)){T.timing_stopped_scrolling_on_event=b6.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};i.prototype._load_metadata_for_sel_events=function(){var fo,fp,fn,T,j;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fn=this.header_id_to_sel_items;T=[];for(fp in fn){j=fn[fp];fo=this.events.valueFromKey(fp);if(fo!=null){fo.load_metadata()}T.push(cL(fo!=null,"Missing "+fp+" in list of events with selected photos"))}return T};i.prototype._load_visible_photos=function(){var fq,fn,T,fp,fo;fp=this.events.getValues();fo=[];for(fn=0,T=fp.length;fn<T;fn++){fq=fp[fn];if(!(fq.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){fo.push(fq.update_photo_divs())}else{fo.push(void 0)}}return fo};i.prototype._body_mousemove=function(j){if(!this.opts.uses_timeline_nav){return}if((j.clientX+C.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};i.prototype._timeline_elm_click=function(fo,fn){var j,T;T=fn.readAttribute("data-event-id");if(T){j=this.events.valueFromKey(T)}this._update_timeline_position(j);if(j.is_missing_timestamp_bucket()){g.log_interaction(cn.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(j)};i.prototype._scroll_to_event=function(fn,j){var T;if(j==null){j=false}T=fn.top_offset-this.top_offset;if(fn&&(C.scroll_offsets().top!==T)){if(j){return bF("html, body").animate({scrollTop:T},200)}else{this._skip_scroll_update=true;return window.scrollTo(C.scroll_offsets().left,T)}}};i.prototype._window_scroll=function(){var fr,fo,T,fn,fq,fp,fs;fn=b6.time();bs.clear_all_pending_batches();if(this.start_render_scroll_time===-1||fn-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=fn}fs=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fs);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(j){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=C.scroll_offsets().top;bQ.scroll_count++;fq=this.events.getValues();fp=[];for(fo=0,T=fq.length;fo<T;fo++){fr=fq[fo];fp.push(fr.logged_thumbs_arrived=false)}return fp};i.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};i.prototype.init_timeline_nav=function(){var fp,fn,T,fo;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();fo=this.events.getValues().reverse();for(fn=0,T=fo.length;fn<T;fn++){fp=fo[fn];fp.add_to_timeline_nav(fp===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};i.prototype._resize_timeline_nav=function(){var j;if(!this.opts.uses_timeline_nav){return}j=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:j+"px"})};i.prototype._update_timeline_position=function(fr){var fw,fu,T,fp,fo,fs,fq,fn,ft,fv;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fr==null){fv=this.get_viewport_info();if(this.scroll_container==null){fv.top=document.viewport.getScrollOffsets().top}fw=fv.top+fv.height/2;fn=this.events.getValues();for(fp=0,fs=fn.length;fp<fs;fp++){T=fn[fp];if(T.top_offset>fw){break}fr=T}}if((fr==null)||fr===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");ft=$$(".timeline-elm");for(fo=0,fq=ft.length;fo<fq;fo++){fu=ft[fo];if(fu.readAttribute("data-event-id")===fr.unique_id){fu.addClassName("current");break}}return this.current_event=fr};i.prototype._show_hide_timeline_elms=function(){var ft,fs,fo,fn,T,fr,fq,fp;if(!this.opts.uses_timeline_nav){return}fo=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fs=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fq=$$(".timeline-elm");fp=[];for(fn=0,T=fq.length;fn<T;fn++){ft=fq[fn];ft.show();fr=ft.cumulativeOffset();if(fr.top<fs&&fr.left<fo){fp.push(ft.hide())}else{fp.push(void 0)}}return fp};i.prototype._event_miscount=function(j){this.refresh_row_offsets();return this._load_visible_photos()};i.prototype.remove_photos=function(ft){var fq,fr,fs,fp,T,fo,fn;ft=ft.slice(0);this.event_remove_info=[];fs={};for(fp=0,T=ft.length;fp<T;fp++){fo=ft[fp];fr=fo.event.unique_id;if(fr in fs){fs[fr].push(fo)}else{fs[fr]=[fo]}}for(fr in fs){ft=fs[fr];fq=this.events.valueFromKey(fr);fn=fq.remove_photos(ft);this.event_remove_info.push({event:fq,remove_info:fn})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_REMOVED_EVT,this)};i.prototype.restore_removed_photos=function(){var T,fB,fy,fs,fr,fp,fv,ft,fq,fA,fo,fw,fu,fz,fn,fx;eW.clear();fo=this.event_remove_info.reverse();for(fs=0,fv=fo.length;fs<fv;fs++){fB=fo[fs];T=fB.event;fz=fB.remove_info;if(fz.removed_event_index!=null){this.events.insertAtIndex(fz.removed_event_index,T.unique_id,T);T.restore()}T.add_photos(fz.removed_photos_and_indexes.reverse());fw=fz.removed_photos_and_indexes;for(fr=0,ft=fw.length;fr<ft;fr++){fA=fw[fr];eW._add(fA.photo)}}fn=null;fx=null;fu=this.event_remove_info;for(fp=0,fq=fu.length;fp<fq;fp++){fB=fu[fp];T=fB.event;fz=fB.remove_info;fy=this.events.indexOfKey(T.unique_id);if((fn==null)||fn>fy){fn=fy;fx=fz.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fx!=null){this.scroll_to_photo_with_key(fx.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_ADDED_EVT,this)};i.prototype.get_photos=function(){var fp,fn,T,fq,fo;fq=[];fo=this.events.getValues();for(fn=0,T=fo.length;fn<T;fn++){fp=fo[fn];fq=fq.concat(fp.photos)}return fq};i.prototype.num_photos=function(){var fq,fn,T,fo,fp;fo=0;fp=this.events.getValues();for(fn=0,T=fp.length;fn<T;fn++){fq=fp[fn];fo+=fq.photos.length}return fo};i.prototype.get_preview_objs=function(){var T,fq,fp,fs,fr,fn,ft,fo,fu;ft=[];fo=this.events.getValues();for(fq=0,fs=fo.length;fq<fs;fq++){T=fo[fq];fu=T.photos;for(fp=0,fr=fu.length;fp<fr;fp++){fn=fu[fp];ft.push(fn.preview_obj)}}return ft};i.prototype.index_of_photo=function(fp){var fr,fo,fn,T,fq;fo=0;fq=this.events.getValues();for(fn=0,T=fq.length;fn<T;fn++){fr=fq[fn];if(fr===fp.event){fo+=fr.photos.indexOf(fp);break}else{fo+=fr.photos.length}}return fo};i.prototype.photo_at_index=function(fp){var fn,fr,fo,T,fq;fn=0;fq=this.events.getValues();for(fo=0,T=fq.length;fo<T;fo++){fr=fq[fo];if(fn+fr.photos.length>fp){return fr.photos[fp-fn]}else{fn+=fr.photos.length}}return null};i.prototype.get_thumb_elm_for_photo=function(j){return $(j.uniqueness_key)};i.prototype.get_photo_for_thumb_elm=function(j){if(!j.hasClassName("cu-thumb")){j=j.up(".cu-thumb")}if(j){return this.key_to_photo[j.identify()]}else{return null}};i.prototype.get_viewport_info=function(){var j,T;if(this.scroll_container!=null){T=this.scroll_container.scrollTop;j=this.scroll_container.getHeight()}else{T=C.scroll_offsets().top;j=C.viewport_dimensions().height}return{top:T,height:j,bottom:T+j}};i.prototype.scroll_to_photo_with_key=function(T){var fq,fn,j,fp,fo;C.scroll_unlock_document();fq=$(T);if(fq!=null?fq.visible():void 0){d6.scroll_to_thumb(fq)}else{j=this.key_to_photo[T];fn=j.event;if(j.event!=null){fp=Math.floor(fn.photos.indexOf(j)/this.THUMBS_PER_ROW);fo=this.get_viewport_info().height;C.scroll_to(0,fn.top_offset+this.HEADER_HEIGHT+fp*this.THUMB_SIZE-fo/2)}}return this._load_visible_photos()};i.prototype.restore_scroll_position=function(){C.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};i.prototype.visible_thumbs_loaded=function(){var fp,fn,T,fo;fo=this.events.getValues();for(fn=0,T=fo.length;fn<T;fn++){fp=fo[fn];if(!fp.visible_thumbs_loaded()){return false}}return true};i.prototype.has_missing_timestamp_bucket=function(){var j;j=this.events.getValues();return j[j.length-1].is_missing_timestamp_bucket()};i.prototype.is_missing_timestamp_bucket_shown=function(){var j,T;if(!this.has_missing_timestamp_bucket()){return false}j=this.events.getValues();T=j[j.length-1].unique_id;return bF("#p-"+T).length>0};i.prototype._show_missing_timestamp_bucket=function(j,fo){var fn,T;if(j==null){j=true}if(fo==null){fo=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}T=this.events.getValues();fn=T[T.length-1];bF("#show-missing-timestamps-button").hide();fn.add_html_elements_to(this.container);if(!fo){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(fn,j);this._render_viewport()}return this.init_timeline_nav()};return i})();var dd;dd=E.PhotoEvent=(function(){i.EVENT_MISCOUNT_EVT="db:photoevent:miscount";i.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";i.prototype.MONTH_PREFIX="m_";i.prototype.COLLECTION_PREFIX="c_";i.prototype.EVENT_PREFIX="e_";i.prototype.MISSING_TIMESTAMP_PREFIX="a_";i.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;i.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;i.timeline;i.unique_id;i.name;i.init_num_photos;i.photos;i.header_html;i.placeholder_html;i.top_offset;i.loading_metadata;i.cursor;i.num_photos_loaded;i.prototype.LOADING_ORDER_NOT_DECIDED=-1;i.prototype.LOADING_ORDER_TOP_DOWN=0;i.prototype.LOADING_ORDER_BOTTOM_UP=1;i.loading_order;i.num_photos_to_load;i.on_load_all_metadata;i.init_sel_items;i.scroll_to_first_sel;i.num_to_select;i.logged_thumbs_arrived;i.timing_metadata_received;i.timing_stopped_scrolling_on_event;i.scroll_count;function i(fu,fs,fn,ft,T,fr){var fp,fv,fo,fq;this.timeline=fu;this.unique_id=fs;this.name=fn;this.init_num_photos=ft;this.photos=(function(){var fw,fy,fx;fx=[];for(fp=fw=0,fy=ft;0<=fy?fw<fy:fw>fy;fp=0<=fy?++fw:--fw){fx.push(new K(this))}return fx}).call(this);this.init_sel_items={};for(fo=0,fq=T.length;fo<fq;fo++){fv=T[fo];this.init_sel_items[fv]=true}this.num_to_select=T.length;this.scroll_to_first_sel=fr;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(ft===0){$("single-album-empty").show()}}i.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};i.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};i.prototype.get_month=function(){var j;cL(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(6,8),10);cL(!isNaN(j),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.get_year=function(){var j;cL(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(2,6),10);cL(!isNaN(j),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};i.prototype.get_collection_gid=function(){cL(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};i.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};i.prototype._generate_container_html=function(){var fo,T,fp,fr,fn,j,fq;fr=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fr);fo=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fo.__date(cx.html("web","event_add_to_album"));this.header_html.__sert(fo);fq=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fq.__date(cx.html("web","event_share"));this.header_html.__sert(fq);j=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});j.__date(cx.html("web","event_select"));this.header_html.__sert(j)}else{this.header_html=new fi("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fr+"</span></h1>")}T=this.get_content_height();fn=this.photos.length%this.timeline.THUMBS_PER_ROW;fp=fn===0?0:(this.timeline.THUMBS_PER_ROW-fn)*this.timeline.THUMB_SIZE;return this.placeholder_html=new fi('<div style="height: '+T+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+T+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+fp+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};i.prototype.add_html_elements_to=function(T){var j;if(this.is_event()){j=new Element("div",{"class":"photo-event"});j.__sert(this.header_html);j.__sert(this.placeholder_html);return T.__sert(j)}else{T.__sert(this.header_html);return T.__sert(this.placeholder_html)}};i.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};i.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};i.prototype.add_to_timeline_nav=function(fs){var j,fq,ft,T,fu,fp,fo,fr,fn;if(fs==null){fs=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}fn=this.timeline.get_viewport_info().height;fu=this.timeline.TIMELINE_NAV_ELM_HEIGHT;fp=$(document.body).getHeight();fo=this.top_offset/fp*100;if(this.is_event()){T=this.name}else{if(this.is_missing_timestamp_bucket()){T=eB("Missing dates")}else{T=b6.month_abbr_with_year(this.get_month()-1,this.get_year())}}ft=false;for(fr in this.timeline.grid.side_nav){j=Math.abs(this.timeline.events.valueFromKey(fr).top_offset-this.top_offset);if(j/fp*fn<fu){ft=true;if(fs){bF("#timeline-nav-"+fr).remove()}}}fq=bF("#timeline-nav-"+this.unique_id);if(!ft||fs){if(fq.length){fq.css("top",fo+"%")}else{fq=bF("<div/>");fq.addClass("timeline-elm");fq.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fq.css("top",fo+"%");fq.text(T);bF("#timeline-nav").append(fq)}return this.timeline.grid.side_nav[this.unique_id]=fo}else{if(fq.length){return fq.remove()}}};i.prototype.marquee_highlight=function(fn,fu,fr){var fo,fv,ft,fs,fw,T,fq,fy,fx,fz,fp;if(this.top_offset>fu||this.top_offset+this.get_height()<fn){return}if(fn<this.top_offset){fu-=this.top_offset;if(fu<this.timeline.HEADER_HEIGHT){return}fp=0;fz=Math.floor((fu-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fu>this.top_offset+this.get_height()){fn-=this.top_offset;fz=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(fn<this.timeline.HEADER_HEIGHT){fp=0}else{fp=Math.floor((fn-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{fn-=this.top_offset;fu-=this.top_offset;if(fn<this.timeline.HEADER_HEIGHT&&fu<this.timeline.HEADER_HEIGHT){return}else{if(fn<this.timeline.HEADER_HEIGHT){fp=0;fz=Math.floor((fu-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{fp=Math.floor((fn-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fz=Math.floor((fu-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fx=ft=fq=fp,fy=fz;fq<=fy?ft<=fy:ft>=fy;fx=fq<=fy?++ft:--ft){for(fs=0,fw=fr.length;fs<fw;fs++){fo=fr[fs];fv=this.timeline.THUMBS_PER_ROW*fx+fo;if(fv<this.photos.length){T=this.photos[fv];if(T.status!==K.PLACEHOLDER&&!eW.contains(T)){eW._highlight(T)}}}}};i.prototype.add_photos=function(fq){var fp,fo,T,fn,fr;for(fo=0,T=fq.length;fo<T;fo++){fr=fq[fo];fn=fr.photo;fp=fr.index;cL(fp<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(fp,0,fn);if(fn.status>=K.LOADED){fn.status=K.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};i.prototype.remove_photos=function(fu){var fs,fp,fr,fn,fq,fo,ft,T;fs=this.timeline.events.indexOfKey(this.unique_id);T=[];for(fp=0,fr=fu.length;fp<fr;fp++){fn=fu[fp];fq=this.photos.indexOf(fn);cL(fq>-1,"Photo not found in the photos array!");this.photos.splice(fq,1);if(fn.status>=K.LOADED){this.num_photos_loaded--;if((fo=$(fn.uniqueness_key))!=null){fo.remove()}fn.status=K.LOADED}eW._remove(fn);T.push({photo:fn,index:fq})}this._num_photos_changed();ft={removed_photos_and_indexes:T};if(this.photos.length===0){ft.removed_event_index=fs}return ft};i.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};i.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};i.prototype._update_placeholder_container=function(){var T,j;$("p-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});j=this.photos.length%this.timeline.THUMBS_PER_ROW;T=j!==0?(this.timeline.THUMBS_PER_ROW-j)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:T+"px"})};i.prototype.load_metadata=function(fs){var fn,T,fr,j,fp,fq,fo;j=0;if((!this._is_valid_photo_index(fs))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}j=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fs*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}j=this._is_loading_from_bottom()?this.photos.length-fs:fs+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,j);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;fp={show_hidden:bQ.show_hidden};if(this.cursor!=null){fp.cursor=this.cursor}if(this._is_loading_from_bottom()){fp.chron_order=true}fp.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(fp.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){fp.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fq=this.unique_id.split("_");fn=fq[2];T=fq[1];fp.filters=JSON.stringify({date_begin:fn,date_end:T},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){fp.filters=JSON.stringify({other:true})}else{if(this.is_month()){fo=this.get_year();fr=this.get_month();fn=d6.to_iso8601_date(new Date(fo,fr-1,1,0,0,0,0),false,true);T=d6.to_iso8601_date(new Date(fo,fr,1,0,0,0),false,true);fp.filters=JSON.stringify({date_begin:fn,date_end:T},{year:fo,month:fr})}else{if(this.is_collection()){fp.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cL(false,"invalid photo event id: "+this.unique_id)}}}}return new cE.WebRequest({url:"/photos_event_metadata",data:fp,dataType:"json",success:(function(ft){return function(fu){ft.timing_metadata_received=b6.time();ft.cursor=fu.cursor;return ft._load_metadata_callback(fu.photos,fu.key_to_duplicates,(fu.more!=null)&&fu.more)}})(this)})};i.prototype.load_metadata_range=function(T,j){if(!(this._is_valid_photo_index(T)&&this._is_valid_photo_index(j))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=T*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(T)}else{return this.load_metadata(j)}};i.prototype.load_cached_metadata=function(){var j,T;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((T=bQ.event_metadata_cache)!=null?T[this.unique_id]:void 0)==null)){return false}j=bQ.event_metadata_cache[this.unique_id];this.cursor=j.cursor;this._load_metadata_callback(j.photos,j.key_to_duplicates,j.more);return true};i.prototype._load_metadata_callback=function(fz,fp,fq){var fy,fr,fx,fw,fD,fA,ft,fs,fE,T,fu,fC,fo,fB,fn,fv;fs=[];fo=[];fv=false;for(fy=fx=0,fA=fz.length;fx<fA;fy=++fx){fu=fz[fy];if(this.has_loaded_metadata()){T=new K(this);if(this._is_loading_from_bottom()){this.photos.unshift(T)}else{this.photos.push(T)}fv=true}else{if(this.num_photos_loaded<this.photos.length){fr=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;T=this.photos[fr]}else{cL(false,"num_photos_loaded should never be greater than photos.length")}}T.init_metadata(fu);if(T.uniqueness_key in fp){T.set_duplicates(fp[T.uniqueness_key])}if(fy<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fo.push(T.preview_obj)}fs.push(T)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var j,fF,fH,fG;fG=[];for(j=0,fF=fo.length;j<fF;j++){fH=fo[j];fG.push(fH.preload())}return fG}),500)}eW.refresh(fs);for(fw=0,ft=fs.length;fw<ft;fw++){T=fs[fw];if(T.item_counter in this.init_sel_items){eW._add(T);this.num_to_select--;if(this.num_to_select===0){eW.dec_num_loading_events_before_select()}delete this.init_sel_items[T.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fn=this.timeline;fD=T.uniqueness_key;bF(document).ready(function(){return fn.scroll_to_photo_with_key(fD)})}}}if(!fq){if(this.num_photos_loaded<this.photos.length){fE=this.photos.length-this.num_photos_loaded;fB=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fB,fE);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fv||fE){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(i.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fC=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fC)}};i.prototype._fix_photo_miscount=function(){var fn,T,j;fn=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);T=this.get_num_rows()-fn;if(typeof g!=="undefined"&&g!==null){g.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}j=C.scroll_offsets().top;if(this.top_offset+this.get_height()<j){C.scroll_to(0,j+T*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(i.EVENT_MISCOUNT_EVT,this)};i.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};i.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};i.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};i.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};i.prototype.visible_thumbs_loaded=function(fu){var fo,fp,fr,T,fq,fn,ft,fs;if(fu==null){fu=this.timeline.get_viewport_info()}fn=this.get_photo_range_to_render(fu,false),fo=fn[0],fr=fn[1];if(fo===null&&fr===null){return true}for(fq=fp=ft=fo,fs=fr;ft<=fs?fp<=fs:fp>=fs;fq=ft<=fs?++fp:--fp){T=this.photos[fq];if((T==null)||!(T.status>=K.RENDERED)){return false}}return true};i.prototype._is_loaded=function(j){var T,fn;if(this._is_loading_from_bottom()){fn=this.photos.length-this.num_photos_loaded;T=this.photos.length-1}else{fn=0;T=this.num_photos_loaded-1}return(fn<=j&&j<=T)};i.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};i.prototype._is_valid_photo_index=function(j){return(j!=null)&&(j>=0)&&(j<=this.photos.length-1)};i.prototype.update_photo_divs=function(){var fn,T,fu,fL,fK,fJ,ft,fM,fy,fH,fG,fx,fI,fv,fr,fp,fw,fE,fD,fC,fB,fA,fF,fq,fo,fN,fs,fz;if(!this.num_photos_loaded){return}fz=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fz)){return}fw=this.get_photo_range_to_render(fz),fu=fw[0],ft=fw[1];cL((fu!=null)&&(ft!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fu))||(!this._is_loaded(ft)))){this.load_metadata_range(fu,ft);if(this._is_loading_from_bottom()){fu=Math.max(fu,this.photos.length-this.num_photos_loaded)}else{ft=Math.min(ft,this.num_photos_loaded-1)}if(fu>ft){return}}fI=Math.floor(fu/this.timeline.THUMBS_PER_ROW);fs=fI*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fs+"px"});fx=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(ft/this.timeline.THUMBS_PER_ROW);T=fx*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:T+"px"});this._hide_photos((function(){fF=[];for(var fO=0;0<=fu?fO<fu:fO>fu;0<=fu?fO++:fO--){fF.push(fO)}return fF}).apply(this));this._hide_photos((function(){fq=[];for(var fO=fE=ft+1,j=this.photos.length;fE<=j?fO<j:fO>j;fE<=j?fO++:fO--){fq.push(fO)}return fq}).apply(this));this._show_photos((function(){fo=[];for(var j=fu;fu<=ft?j<=ft:j>=ft;fu<=ft?j++:j--){fo.push(j)}return fo}).apply(this));fC=eW.get();for(fH=0,fM=fC.length;fH<fM;fH++){fr=fC[fH];if((fB=$(fr.uniqueness_key))!=null){fB.addClassName("selected")}}this.scroll_count=bQ.scroll_count;fn=[];fA=this.get_thumb_indexes_to_load(fz);for(fG=0,fy=fA.length;fG<fy;fG++){fp=fA[fG];fr=this.photos[fp];if((fr!=null)&&fr.status>=K.RENDERED){fN=$(fr.uniqueness_key);if((fN!=null?fN.down("img"):void 0)!=null){fn.push(fN.down("img"))}}}fv=function(j){return j.up(".cu-thumb").addClassName("thumb-loaded")};return bs.batch_load_thumbs(fn,this.timeline.THUMBS_BATCH_SIZE,fv,this.log_thumb_load.bind(this))};i.prototype._hide_photos=function(fq){var fp,fn,T,fo;fo=[];for(fn=0,T=fq.length;fn<T;fn++){fp=fq[fn];fo.push(this._hide_photo(fp))}return fo};i.prototype._hide_photo=function(j){var T;T=this.photos[j];if((T==null)||!(T.status===K.DISPLAYED)){return}$(T.uniqueness_key).hide();return T.status=K.RENDERED};i.prototype._show_photos=function(fC){var fy,fx,fB,fn,fA,fv,ft,fq,fz,fu,fs,fp,fo,fw,fr,T;fn=[];for(fv=0,fz=fC.length;fv<fz;fv++){fx=fC[fv];fA=this._get_photo_insert_info(fx);if(!fA){continue}fB=fA[0],T=fA[1];fr=false;for(ft=0,fu=fn.length;ft<fu;ft++){fy=fn[ft];if(fy.after===fB){fy.photos.push(T);fr=true;break}}if(!fr){fn.push({after:fB,photos:[T]})}}for(fq=0,fs=fn.length;fq<fs;fq++){fy=fn[fq];fy.after.__sert({after:fy.photos})}fw=[];for(fo=0,fp=fC.length;fo<fp;fo++){fx=fC[fo];fw.push(this.photos[fx].status=K.DISPLAYED)}return fw};i.prototype._get_photo_insert_info=function(T){var fq,fn,fp,fo,ft,fs,fr;fo=this.photos[T];if((fo==null)||fo.status===K.DISPLAYED){return}if(fo.status===K.RENDERED){$(fo.uniqueness_key).show()}else{fn=$("p-top-"+this.unique_id);if(T!==0){for(fq=fp=fr=T-1;fr<=0?fp<=0:fp>=0;fq=fr<=0?++fp:--fp){ft=this.photos[fq];if((ft!=null)&&ft.status>=K.RENDERED){fs=$(ft.uniqueness_key);cL(fs!=null,"photo "+fq+" was marked as rendered, but its thumb elm doesn't exist");fn=fs;break}}}return[fn,fo.thumb_html]}};i.prototype.in_y_range=function(T,j){return !(this.top_offset+this.timeline.HEADER_HEIGHT>j||this.top_offset+this.get_height()<T)};i.prototype.in_current_viewport=function(fo,fp){var fn,j,T;if(fo==null){fo=this.timeline.get_viewport_info()}if(fp==null){fp=true}T=fo.top;j=fo.top+fo.height;if(fp){fn=this._blur_range(T,j,fo),T=fn[0],j=fn[1]}return this.in_y_range(T,j)};i.prototype.hide_photos_if_not_in_current_viewport=function(fs){var fq,fp,fo,fr,fn,T;if(!this.in_current_viewport(fs)){if(this._is_loading_from_bottom()){for(fq=fp=fr=this.photos.length-this.num_photos_loaded,fn=this.photos.length;fr<=fn?fp<fn:fp>fn;fq=fr<=fn?++fp:--fp){this._hide_photo(fq)}}else{for(fq=fo=0,T=this.num_photos_loaded;0<=T?fo<T:fo>T;fq=0<=T?++fo:--fo){this._hide_photo(fq)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};i.prototype._blur_range=function(fo,j,fq){var fn,T,fp;if(fq==null){fq=this.timeline.get_viewport_info()}fp=dA.get();if(fp>=0){T=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;fn=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(fp<0){T=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;fn=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fo-=T*fq.height;j+=fn*fq.height;return[fo,j]};i.prototype.get_photo_range_to_render=function(ft,fo){var fr,fn,fq,T,fs,fp,j;if(fo==null){fo=true}j=ft.top;fp=ft.bottom;if(fo){T=this._blur_range(j,fp,ft),j=T[0],fp=T[1]}if(!this.in_y_range(j,fp)){return[null,null]}fs=Math.floor((j-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fr=Math.floor((fp-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fn=Math.min(this.photos.length-1,fs*this.timeline.THUMBS_PER_ROW);fq=Math.min(this.photos.length-1,(fr+1)*this.timeline.THUMBS_PER_ROW-1);cL(!isNaN(fq),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+ft.bottom+" ")+("viewport_data.height="+ft.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fr+" "),true,["photo_event_nan_limit"]);return[Math.max(0,fn),fq]};i.prototype.get_photo_range_to_render_with_blur=function(fp){var j,fr,fn,fq,fo,T;fo=this.get_photo_range_to_render(fp,true),fr=fo[0],fq=fo[1];T=this.get_photo_range_to_render(fp,false),j=T[0],fn=T[1];return[fr,j,fn,fq]};i.prototype.get_thumb_indexes_to_load=function(fu){var fG,fr,fE,fD,fC,fq,fp,fB,fy,fF,fv,fz,fs,fx,fw,fA,fo,fn,T,ft;fs=this.get_photo_range_to_render_with_blur(fu),fr=fs[0],fG=fs[1],fq=fs[2],fp=fs[3];if(fG==null){fy=(function(){fA=[];for(var fH=fr;fr<=fp?fH<=fp:fH>=fp;fr<=fp?fH++:fH--){fA.push(fH)}return fA}).apply(this);if(this.top_offset>fu.bottom){return fy}else{return fy.reverse()}}fz=(function(){fo=[];for(var j=fG;fG<=fq?j<=fq:j>=fq;fG<=fq?j++:j--){fo.push(j)}return fo}).apply(this);fF=[];fv=[];if(fr<fG){fF=(function(){fn=[];for(var j=fx=fG-1;fx<=fr?j<=fr:j>=fr;fx<=fr?j++:j--){fn.push(j)}return fn}).apply(this)}if(fp>fq){fv=(function(){T=[];for(var j=fw=fq+1;fw<=fp?j<=fp:j>=fp;fw<=fp?j++:j--){T.push(j)}return T}).apply(this)}ft=dA.get();if(ft>=0){return fz.concat(fv).concat(fF)}else{return fz.concat(fF).concat(fv)}};i.prototype.log_thumb_load=function(T,fo){var fp,fn,j;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bQ.scroll_count&&!this.logged_thumbs_arrived){if((T+1)%this.timeline.THUMBS_PER_ROW===0||T+1===fo){if(this.visible_thumbs_loaded()){j=this.timeline.get_viewport_info();fp=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<j.bottom&&j.bottom<this.top_offset+this.get_height())||fp){if(bQ.scroll_count<2&&((fn=g.get_current_view())===cn.PHOTOS_VIEW||fn===cn.CAMERA_VIEW)){this.log_timing_event(J.viewport_initial_load);bQ.scroll_count+=2}else{this.log_timing_event(J.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};i.prototype.log_timing_event=function(fo){var j,T,fn,fp;T=b6.time();j={};if(fo===J.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(fn=performance.timing)!=null?fn.navigationStart:void 0:void 0)!=null){fp=b6.time()-performance.timing.navigationStart;j={current_view:g.get_current_view()};eh.log_ajax_transition(fp,fo,j,fo)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fo===J.viewport_loaded){fp=T-this.timing_stopped_scrolling_on_event}return eh.log_ajax_transition(fp,fo,j,fo)};return i})();var K;K=E.Photo=(function(){i.PLACEHOLDER=0;i.LOADED=1;i.RENDERED=2;i.DISPLAYED=3;i.uniqueness_key;i.item_counter;i.filename;i.ns_id;i.ns_path;i.fq_path;i.href;i.thumbnail_url;i.large_thumbnail_url;i.time_taken;i.display_time_taken;i.preview_type;i.mtime;i.video_streaming_url;i.is_visible;i.user_id;i.event;i.status;i.thumb_html;i.preview_obj;i.duplicates_info;function i(j){this.event=j;this.status=i.PLACEHOLDER;this.preview_obj=j.unique_id}i.prototype.init_metadata=function(j){this.uniqueness_key=j.uniqueness_key;this.item_counter=j.item_counter;this.filename=j.filename;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.fq_path=j.path;this.href=j.href;this.thumbnail_url=j.thumbnail_url;this.large_thumbnail_url=j.large_thumbnail_url;this.time_taken=j.time_taken;this.display_time_taken=j.display_time_taken;this.preview_type=j.preview_type;this.mtime=j.mtime;this.video_streaming_url=j.video_streaming_url;this.is_visible=j.is_visible;this.user_id=j.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cx});this.preview_obj=this._get_preview_obj();this.status=i.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};i.prototype.set_duplicates=function(fo){var fn,T,j;for(T=0,j=fo.length;T<j;T++){fn=fo[T];fn.fq_path=fn.path}return this.duplicates_info=fo};i.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bQ.in_single_collection_view()){return new eT({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dt({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bQ.in_single_collection_view()){return new au({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new e4({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};i.prototype._get_display_date=function(){var j;if(this.time_taken!=null){j=new Date(this.time_taken);return b6.nice_date_with_month_name(j,j.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return i})();var ad;ad=E.PhotoCollection=(function(){i.CREATE_EVT="db:photocollection:create";i.ADD_EVT="db:photocollection:add";i.REMOVE_EVT="db:photocollection:remove";i.UNDO_REMOVE_EVT="db:photocollection:undo_remove";i.RENAME_EVT="db:photocollection:rename";i.DELETE_EVT="db:photocollection:delete";i.SHARE_EVT="db:photocollection:share";i.UNSHARE_EVT="db:photocollection:unshare";i.COVER_CHANGE_EVT="db:photocollection:cover_change";i.gid;i.name;i.num_items;i.num_photos;i.num_videos;i.thumbnail_url_32;i.thumbnail_url_256;i.is_anonymous;i.share_tkey;i.shmodel_url;i.short_url;i.is_creator;i.member_fnames;function i(T,j){if(j==null){j=true}cL((T.gid!=null)&&(T.url!=null)&&(T.name!=null)&&(T.num_items!=null)&&(T.num_photos!=null)&&(T.num_videos!=null),"missing required PhotoCollection params");this.gid=T.gid;this.url=T.url;this.name=T.name;this.num_items=T.num_items;this.num_photos=T.num_photos;this.num_videos=T.num_videos;this.thumbnail_url_32=T.thumbnail_url_32||null;this.thumbnail_url_256=T.thumbnail_url_256||null;this.is_anonymous=T.is_anonymous!=null?T.is_anonymous:false;this.share_tkey=T.share_tkey||null;this.shmodel_url=T.shmodel_url||null;this.short_url=T.short_url||null;this.is_creator=T.is_creator!=null?T.is_creator:true;this.member_fnames=T.member_fnames||[eB("You")];if(j){document.fire(i.CREATE_EVT,{collection:this})}}i.prototype.add_photos=function(fr,fq,fn,fp){var j,fo,T;if(fn==null){fn=false}if(fp==null){fp=true}j=(function(){var fu,fs,ft;ft=[];for(fu=0,fs=fr.length;fu<fs;fu++){T=fr[fu];ft.push(T.item_counter)}return ft})();cL(j.length,"Have to add at least one photo");fo={collection_gid:this.gid,item_counters:JSON.stringify(j),source_collection_gid:fq};return new Ajax.DBRequest("/collection_add",{parameters:fo,job:fn,job_user:cM.get_viewer().photos_user,progress_text:eB("Adding to album..."),onSuccess:(function(fs){return function(fv){var ft,fw,fu,fx;fx=JSON.parse(fv.responseText);fs.thumbnail_url_32=fx.thumbnail_url_32;fs.thumbnail_url_256=fx.thumbnail_url_256;fw=fx.new_num_photos-fs.num_photos;fu=fx.new_num_videos-fs.num_videos;ft=fx.new_num_items-fs.num_items;fs.num_photos=fx.new_num_photos;fs.num_videos=fx.new_num_videos;fs.num_items=fx.new_num_items;return document.fire(i.ADD_EVT,{collection:fs,photos:fr,num_items_added:ft,num_photos_added:fw,num_videos_added:fu,promote_collection:fp})}})(this)})};i.prototype.remove_photos=function(fo,fn){var j,T;if(fn==null){fn=false}j=(function(){var fr,fp,fq;fq=[];for(fr=0,fp=fo.length;fr<fp;fr++){T=fo[fr];fq.push(T.item_counter)}return fq})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(j),is_shared:this.share_tkey!=null,num_items:this.num_items},job:fn,job_user:cM.get_viewer().photos_user,progress_text:eB("Removing from album..."),onSuccess:(function(fp){return function(fq){var fr;fr=JSON.parse(fq.responseText);fp.thumbnail_url_32=fr.thumbnail_url_32;fp.thumbnail_url_256=fr.thumbnail_url_256;fp.num_photos=fr.new_num_photos;fp.num_videos=fr.new_num_videos;fp.num_items=fr.new_num_items;return document.fire(i.REMOVE_EVT,{collection:fp,photos:fo,undo_changeset:fr.undo_changeset})}})(this)})};i.prototype.undo_remove=function(j){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:j},html_in_error_msg:true,progress_text:eB("Undoing..."),onSuccess:(function(T){return function(){return document.fire(i.UNDO_REMOVE_EVT,{collection:T})}})(this)})};i.prototype.rename=function(T){var j;bQ.enable_selection();j=new Ajax.InPlaceEditor(T,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bF("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:eB("Saving..."),onLeaveEditMode:bQ.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(fn){return function(fo){fn.name=fo.responseText;return document.fire(i.RENAME_EVT,{collection:fn})}})(this)},callback:(function(fn){return function(fo,fp){return{collection_gid:fn.gid,new_collection_name:fp,is_shared:fn.share_tkey!=null}}})(this)});return j.enterEditMode()};i.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cM.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cM.get_viewer().photos_user,onSuccess:(function(j){return function(){return document.fire(i.DELETE_EVT,{collection:j})}})(this)})};i.prototype.attach_to_token=function(fn,fp,T,fo,j){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:fn,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fq){return function(){fq.share_tkey=fn;fq.shmodel_url=fp;fq.short_url=T;if(typeof fo==="function"){fo()}return document.fire(i.SHARE_EVT,{collection:fq})}})(this),onFailure:function(){return typeof j==="function"?j():void 0}})};i.prototype.send_link=function(T,fo,fs,fn,fr,j){var fq,fp;fq=(function(ft){return function(){ft.share_tkey=fo;ft.shmodel_url=fs;ft.short_url=fn;if(typeof fr==="function"){fr()}return document.fire(i.SHARE_EVT,{collection:ft})}})(this);fp={collection_gid:this.gid,share_tkey:fo,num_items:this.num_items};return bT.ajax_submit(T,"/collection_share",fq,j,T.down(".tokenizer-submit-button"),fp)};i.prototype.unshare=function(){cL(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(j){return function(){j.share_tkey=null;j.shmodel_url=null;j.short_url=null;return document.fire(i.UNSHARE_EVT,{collection:j})}})(this),subject_user:cM.get_viewer().photos_user})};i.prototype.set_cover=function(j){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:j.item_counter},onSuccess:(function(T){return function(fn){var fo;fo=JSON.parse(fn.responseText);T.thumbnail_url_32=fo.thumbnail_url_32;T.thumbnail_url_256=fo.thumbnail_url_256;return document.fire(i.COVER_CHANGE_EVT,{collection:T})}})(this)})};return i})();var b7,l;b7=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=E.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,pdfLink:null,_pdfLoader:new ax(),init_pdf:function(fp,fo,T,i,fq){var j,fn;this.pdfLink=i;this.iframe_src=fo;this._log_pdf_render_time(fp);if(fp==="pdf-native"||fp==="pdf-embedded"||fp==="pdf-js"){window.addEventListener("message",l,false);bF((function(fr){return function(){var fv,fu,ft,fs;fs=G.parse(fo);fv=bF("#pdf-embed-container");if(fv.attr("data-docpreview-annotation-marker-enabled")==="True"){fs=fs.updateQuery("annotation_marker","1")}if(fv.attr("data-docpreview-annotation-highlight-enabled")==="True"){fs=fs.updateQuery("annotation_highlight","1")}if(fv.attr("data-docpreview-annotation-region-enabled")==="True"){fs=fs.updateQuery("annotation_region","1")}if(fp==="pdf-js"){ft=fs.getQuery();fr._pdfLoader.startListening();fr._pdfLoader.openFile(ft.file,{presentationMode:fq});delete ft.file;fs.setQuery(ft)}fu=bF("#pdf-embed-iframe");fu.attr("src",String(fs));fu.attr("type","application/pdf");fu.attr("allowfullscreen","");fu.addClass("pdfjs");bF("html, body").addClass("full_height");return fr._fire_pdf_render_event()}})(this));this.preview_status=T;if(b1.chrome){fn=function(){var fr;fr=bF('link[rel="shortcut icon"]').remove();return bF("head").append(fr)};setTimeout(fn,1000)}j=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fr){return function(){return j.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(i){window.addEventListener("message",l,false);return bF("#pdf-embed-iframe").attr("src",i)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bF((function(i){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(i){return function(){if(!window.htmlified_height){return i.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var i;if((i=$("htmlified-loading"))!=null){i.remove()}if(bF("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(fo,fq,j,fn,i,T,fp){return bF((function(fr){return function(){var fu,fs,ft;ft=fp.width()*0.9;fs=ft*0.55;fu=fr._video_preview_failed;if(fn==="hls"){fr.player=bt.embed("#video",{src:j,type:"application/vnd.apple.mpegurl",width:ft,height:fs,controls:true,poster:i,onError:fu,onReady:fr._player_ready,metadata_link:T})}else{bF("#video").empty();if(fo){if(fq){fr.player=bt.embed("#video",{src:j,type:"video/mp4",width:ft,height:fs,controls:true,poster:i,onError:fu,onReady:fr._player_ready,metadata_link:T})}else{fu()}}else{fr.player=bt.embed("#video",{src:j,type:"video/flv",width:ft,height:fs,controls:true,poster:i,onError:fu,onReady:fr._player_ready,metadata_link:T})}}bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();fr.player.on("play",fr._onPlay);return fr.player.on("ended",fr._onEnded)}})(this))},photo_loaded:function(T){var j,i;if((j=window.performance)!=null?(i=j.timing)!=null?i.navigationStart:void 0:void 0){T=T-window.performance.timing.navigationStart;return eh.log_ajax_transition(T,"file-preview-photo")}},switch_preview:function(fv,fo,ft,fs,T){var fu,fn,i,fr,fq,fp,j;if(this.iframe_src){i=INLINE_JS.URI.parse(this.iframe_src);j=INLINE_JS.URI.parse(i.getQuery().file);fp=j.updateQuery({revision_id:fv}).toString();fn=G.parse(this.iframe_src).updateQuery({file:fp});if(fo){fn.updateQuery({annotation_marker:"1"});fn.updateQuery({annotation_highlight:"1"});fn.updateQuery({annotation_region:"1"})}else{fn.removeQuery("annotation_marker");fn.removeQuery("annotation_highlight");fn.removeQuery("annotation_region")}fu=bF("#pdf-embed-iframe");fu.attr("src",fn.toString());fu.on("load",ft);return this._fire_pdf_render_event()}else{fq={thumbnailUrl:fs,commentActivity:T};fr={action:"switch-preview",parameters:fq};return window.postMessage(JSON.stringify(fr),"*")}},_player_ready:function(){var i;i=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return i.defer()},_onPlay:function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()},_onEnded:function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()},_video_preview_failed:function(i){if(i==="needflash"){bF("#video-preview-flash-message").show()}return b7.preview_failed()},preview_failed:function(){var i;i=bF(document.body);if(i.hasClass("shmodel-body")){i.removeClass("file-preview-body")}ah.error(eB("Preview failed."));return bF(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var i;if(document.createEvent&&window.dispatchEvent){i=document.createEvent("UIEvents");i.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(i)}},_log_pdf_render_time:function(j){var i;i=function(fp){var fo,T,fn;if((fo=window.performance)!=null?(T=fo.timing)!=null?T.navigationStart:void 0:void 0){fn=b6.time()-window.performance.timing.navigationStart;return eh.log_ajax_transition(fn,fp)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return i(j)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return i(j+"-parse")})}};l=function(fo){var fn,j,T,i,fp;j={"https://dl.dropbox.com":true};j["https://"+fl.DL_DOC_DOMAIN]=true;j["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;j["https://"+Constants.PUBSERVER]=true;j["https://"+Constants.WEB_STATIC_DROPBOX_HOST]=true;if(j[fo.origin]){T={};try{T=JSON.parse(fo.data);fn=T.action}catch(fp){i=fp;fn=fo.data}switch(fn){case"failed":return b7.preview_failed()}}};var aD;aD=E.ClientDownload=(function(){function i(){}i.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(j){var T;T=bF("<div",{"class":"brodal-header",text:eB("Install Dropbox")});return fd.show(T[0],$("client-download"),{},false,450)},subject_user:ct.active_user})};return i})();var cA,em,g,J,a8,dc,cn;cA=E.AlbumsLogger={log_share:function(j,fo,fn,T,i){return cA.log(j,fo,true,fn,T,i)},log_event:function(i,fn,T,j){return cA.log(i,fn,false,T,j)},log:function(j,fq,fn,fp,fo,i){var T;T={evt:j,collection_gid:fq,is_anonymous:fo};if(fn!=null){T.share_event=fn}if(fp!=null){T.num_items=fp}if(i!=null){T.on_create=i}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:T})}};em=INLINE_JS.PhotosEvents=E.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a8=INLINE_JS.PhotosTourEvents=E.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};dc=INLINE_JS.PhotosTriggers=E.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cn=E.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};g=INLINE_JS.PhotosLogger=E.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var i,j,T;i=((j=$("modal"))!=null?j.visible():void 0)&&$("shmodal").visible();T=i?"-foshmodal":"";if(bQ.in_single_collection_view()){return cn.SINGLE_COLLECTION_VIEW+T}else{if(bQ.in_all_collections_view()){return cn.ALBUMS_VIEW+T}else{if(bQ.initialized){return cn.PHOTOS_VIEW+T}else{return cn.NOT_PHOTOS}}}},log_interaction:function(i,j,T){return g.log(i,j,null,g.get_current_view(),T)},log_transition_to:function(i){return g.log(i,null,null,g.get_current_view(),null,true)},log:function(j,T,i,fq,fo,fp){var fn;fn={evt:j,trigger:T,view:i};if(fo!=null){fn.data=JSON.stringify(fo)}if(fq!=null){fn.start_view=fq}if(fp!=null){fn.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:fn})}};J=E.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dK,aQ;aQ=E.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(i){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:i,url:window.location.href}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){aQ.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};dK=E.RegistrationLogger={log:function(i){var j;j=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:i,url:j}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){dK.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};var f;f=E.ModalFlow=(function(){function i(fp,ft,fv,fo,T,fs,fu){var fq,fr,fn,j;this.title=fp;this.icon=ft;this.states=fv;this.next_state_table=fo;this.previous_state_table=T;this.initial=fs;this.onStart=fu;this._state_map={};fn=this.states;for(fq=0,fr=fn.length;fq<fr;fq++){j=fn[fq];this._state_map[j.name]=j}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}i.prototype.start=function(){var T,j,fn,fo;this.vars={};fn=this.states;for(T=0,j=fn.length;T<j;T++){fo=fn[T];fo.next=this._next.bind(this,fo);fo.back=this._back.bind(this,fo);if(fo.onSubmit){fo.onSubmitFn=(function(fp,fq){fp.onSubmit(this,fp,fq);return false}).bind(this,fo)}else{fo.onSubmitFn=((function(fp){return function(fq,fr){fq.next();return false}})(this)).bind(this,fo)}fo.contents.on("submit",fo.onSubmitFn);fo.contents.find(".backbutton").on("click",fo.back)}fd.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};i.prototype.to_state=function(T){var j;this.state=this._state_map[T];j=this.title;if(this.state.title!=null){j=this.state.title}fd.show(j,this.state.contents[0]);return this.state.enter(this)};i.prototype._next=function(j){var T;if(j===this.state){T=this.next_state_table[this.state.name](this);if(T==="__exit__"){return this.exit()}else{return this.to_state(T)}}};i.prototype._back=function(j){var T;if(j===this.state){T=this.previous_state_table[this.state.name](this);if(T==="__cancel__"){return this.exit()}else{if(T){return this.to_state(T)}}}};i.prototype.exit=function(){return this._onExit()};i.prototype._onExit=function(fu){var fr,fp,fs,fq,fn,fo,ft,T;fo=this.states;for(fr=0,fs=fo.length;fr<fs;fr++){T=fo[fr];T.contents.off("submit",T.onSubmitFn)}this._cleanUpExitListeners();ft=this._exit_listeners;for(fp=0,fq=ft.length;fp<fq;fp++){fn=ft[fp];fn(fu)}fd.onHide=null;return fd.hide()};i.prototype.addExitListener=function(j){return this._exit_listeners.push(j)};i.prototype.removeExitListener=function(j){return this._cleanup_queue.push(j)};i.prototype._cleanUpExitListeners=function(){var fq,fp,T,j,fr,fo;fr=this._cleanup_queue;fo=[];for(fp=0,j=fr.length;fp<j;fp++){fq=fr[fp];T=this._exit_listeners.indexOf(fq);fo.push(this._exit_listeners.splice(T,1))}return fo};return i})();var cH;cH=E.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(i){this._user=cM.get_viewer().get_user_by_id(i);cL(this._user,i+" is invalid");return bF("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bF("#resend-link").on("click",this.resend_phone_code.bind(this));return bF("#code").focus()},init:function(j,i){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();d6.async_load_script(j);return d6.async_load_script(i)},account_listen:function(){var fz,T,fx,fu,fv,ft,fq,fy,i,j,fn,fp,fo,fw,fs,fr;fx={name:"delivery_choice",enter:(function(fA){return function(fB){var fC;fA.hide_error();fC=0;bF(".delivery-choice").each(function(){var fD;fD=bF(this).height();return fC=Math.max(fD,fC)});bF(".delivery-choice").height(fC);return bF(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bF("#twofactor-delivery-choice"),onSubmit:(function(fA){return function(fB,fC,fD){fB.vars.sms=!!(bF("#use-sms")[0].getValue()==="on");if(!fB.vars.sms){return fA.fetch_offline_key(fB,fC)}else{return fC.next()}}})(this)};fu={name:"enter_phone_number",enter:(function(fA){return function(fC){var fD,fB;fA.hide_error();fA._is_offline_setup=false;fA._phone_number=null;fD=$("twofactor-enter-phone");fB=fA.fill_phone_number_for_edit(fD,bF("#twofactor-row-"+fA._user.role+" #twofactor-sms-number").text());return fB.focus()}})(this),contents:bF("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};fv={name:"offline_setup",enter:(function(fA){return function(fB){fA.hide_error();fA._is_offline_setup=true;return fA._phone_number=null}})(this),contents:bF("#twofactor-offline-setup")};T={name:"confirm_phone",enter:(function(fA){return function(fB){var fC;fA._invalid_code_count=0;if(fA._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fC=fB.vars.phone_number;cL(fC,"expected a display_phone argument");$("phone-number-placeholder").__date(fC);$("twofactor-enable-confirm").removeClassName("offline")}fA.hide_error();$("phone-code").clear().focus();return fA.fill_delivery_choice(fC)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bF("#twofactor-enable-confirm")};fz={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bF("#twofactor-enter-backup-phone")};fp=new f(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bF("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fA){return function(fB,fC){fA.successfully_enabled=false;fB.vars.mode="ENABLE";fB.vars.passed_password=true;return fC.next()}})(this)),contents:bF("#twofactor-enter-password")},fx,fu,fv,T,fz,{name:"recovery_code",enter:(function(fA){return function(){fA.fill_backup_phone(fA._backup_phone);return fA.hide_error.bind(fA)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:bF("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:eB("Congrats! You've enabled two-step verification!"),contents:bF("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fA){if(fA.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fA){if(fA.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});fp.addExitListener((function(fA){return function(fB){if(fp.vars.passed_password&&fB&&!fA.successfully_enabled){return ah.error(eB("Two-step verification isn\u2019t enabled"))}}})(this));fn=new f(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fA){return function(fC,fD){var fB;fA.successfully_enabled=false;bF(".delivery-choice").removeClass("selected");fB=!bF("#twofactor-row").hasClass("with-sms");bF(fB?"#app-choice":"#sms-choice").addClass("selected");bF("#twofactor-recovery").addClass("edit-mode");fC.vars.passed_password=true;return fD.next()}})(this)),contents:bF("#twofactor-enter-password")},fx,fu,fv,T,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fA){if(fA.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fA){if(fA.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});fn.addExitListener((function(fA){return function(fB){if(fn.vars.passed_password&&fB&&!fA.successfully_enabled){return ah.error(eB("Two-step verification has not been changed"))}}})(this));i=new f(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fA){return function(fB,fC){fA.successfully_disabled=false;fB.vars.passed_password=true;return fC.next()}})(this)),contents:bF("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bF("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});i.addExitListener((function(fA){return function(fB){if(i.vars.passed_password&&fB&&!fA.successfully_disabled){return ah.error(eB("Two-step verification is still enabled"))}}})(this));ft=new f(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fA,fB){return fB.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");j=new f(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fA,fB){return fB.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fw=new f(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fA){return function(fB,fC){return new Ajax.DBRequest(fA.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fA._checkpoint_token,use_json:true},onSuccess:function(fE){var fD,fF;fF=JSON.parse(fE.responseText.strip());if(fF.result==="OK"){fD=fF.codes;fA.fill_recovery_codes(fD,"backup-code-list-edit");return fC.next()}else{switch(fF.result){case"EXPIRED":return fA.show_error_expired();case"ALREADY_DISABLED":bF("#twofactor-row").removeClass("twofactor-enabled");ah.success(eB("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fd.hide()}}},onFailure:fA.show_error500.bind(fA),cleanUp:fA.hide_loading.bind(fA),subject_user:fA._user})}})(this)),contents:bF("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bF("#twofactor-recovery-edit"),onSubmit:(function(fA){return function(fB,fC){fA._checkpoint_token=null;return fC.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fr=(function(fA){return function(fB){return new Ajax.DBRequest(fA.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fA._checkpoint_token,device_response:JSON.stringify(fB)},noAutonotify:true,onSuccess:function(fC){var fD;fD=fC.responseText.strip();fq.to_state("register_success");return bF(document).trigger("security-key-manager:UPDATE_KEYS",fA._user.id)},onFailure:function(fE){var fC,fD;fC=JSON.parse(fE.responseText.substr(4));fD=fC.security_key_register!=null?fC.security_key_register["message_text"]:ah.DEFAULT_ERROR;bF("#twofactor-security-key-register-error #error-msg").text(fD);return fq.to_state("register_error")},cleanUp:fA.hide_loading.bind(fA),subject_user:fA._user})}})(this);fo=(function(fA){return function(fB,fC){return new Ajax.DBRequest(fA.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fA._checkpoint_token},onSuccess:function(fD){var fE;fE=JSON.parse(fD.responseText);u2f.register(fE.registerRequests,fE.authenticateRequests,fr);return fC.next()},onFailure:fA.show_error500.bind(fA),cleanUp:fA.hide_loading.bind(fA),subject_user:fA._user})}})(this);fs=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fy=new f("Confirm password",this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fA){return function(fB,fC){bF(document).trigger("security-key-modal:PASSWORD_CONFIRMED",[fA._user.id,fA._checkpoint_token]);return fd.hide()}})(this)),contents:bF("#twofactor-enter-password")}],{password:function(){return"__exit__"}},{},"password");fq=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fA,fB){return fB.next()}),contents:bF("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-prepare-register"),onSubmit:fo},{name:"register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register-error"),onSubmit:fo},{name:"register_success",enter:(function(fA){return function(){fA.hide_error.bind(fA);return fA._checkpoint_token=null}})(this),onSubmit:function(fA,fB){ah.success(eB("Successfully added security key."));return fB.next()},contents:bF("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();bF(".enable-twofactor").on("click",(function(fA){return function(fB){return fA.start_flow(fB,fp)}})(this));bF(".disable-twofactor").on("click",(function(fA){return function(fB){return fA.start_flow(fB,i)}})(this));bF(".add-twofactor-backup-link").on("click",(function(fA){return function(fB){return fA.start_flow(fB,ft)}})(this));bF(".edit-twofactor-backup").on("click",(function(fA){return function(fB){return fA.start_flow(fB,j)}})(this));bF(".edit-twofactor-recovery").on("click",(function(fA){return function(fB){return fA.start_flow(fB,fw)}})(this));bF(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fA){return function(fB){return fA.start_flow(fB,fn)}})(this));bF(document).on("twofactor:ADD_SECURITY_KEY",(function(fA){return function(fC,fB){if(bF("#twofactor-security-key-unsupported-browser").length){return fA.start_flow(fC,fs,fB)}else{return fA.start_flow(fC,fq,fB)}}})(this));bF(document).on("twofactor:ASK_PASSWORD_CONFIRM",(function(fA){return function(fC,fB){return fA.start_flow(fC,fy,fB)}})(this));bF("#generate-new-recovery-code").on("click",(function(fA){return function(fB){fA.show_loading();return new Ajax.DBRequest(fA.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fA._checkpoint_token,use_json:true},onSuccess:function(fD){var fE,fC;fE=fD.responseText.strip();fC=JSON.parse(fE);if(fC.result==="OK"){return fA.fill_recovery_codes(fC.codes,"backup-code-list-edit")}else{switch(fE){case"EXPIRED":fw.to_state("password");return fA.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eB("Two-step verification is disabled. Did you maybe disable it in another window?"));return fd.hide()}}},onFailure:fA.show_error500.bind(fA),cleanUp:fA.hide_loading.bind(fA),subject_user:fA._user})}})(this));bF("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bF("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bF("#twofactor-delivery-choice input").change(function(){bF(".delivery-choice").removeClass("selected");return bF(this).parents(".delivery-choice").addClass("selected")});bF("#show-qr").on("click",function(fA){bF("#twofactor-offline-setup").addClass("showing-qr");return false});bF("#hide-qr").on("click",function(fA){bF("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&bF("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(ft)}},_bind_phone_input_to_save_button:function(){this.$save_button=bF("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=bF("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));this.$phone_input.on("input",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return bF("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(i){return function(){return i.submit_finish(true,i._current_flow,i._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(i,j){var T;T=bF.trim(i.val())==="";return j.prop("disabled",T)},start_flow:function(T,j,i){if(i==null){i=null}T.preventDefault();delete this._phone_number;if(i==null){i=bF(T.target).data("uid")}cH.set_user(cM.get_viewer().get_user_by_id(i));this._current_flow=j;j.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bF("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(j){var i;if(this.is_resending()){return}this.show_resending();i="/twofactor_resend";if(bF("#twofactor-confirm").hasClass("backup")){i=G.parse(i).updateQuery({backup:true}).toString()}new Ajax.DBRequest(i,{onSuccess:(function(T){return function(fn){switch(fn.responseText.strip()){case"OK":T.hide_error();return T.notify_resent();case"UNREACHABLE":return T.show_error_unreachable(true);case"BADCARRIER":return T.show_error_bad_carrier();case"INVALIDNUMBER":return T.show_error_invalid_number();case"NOTAMOBILE":return T.show_error_not_a_mobile();case"RATELIMIT":return ah.error(eB("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return ah.error(error_unreachable(true));case"BADCARRIER":return ah.error(error_bad_carrier());case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return ah.error(error_not_a_mobile());case"RATELIMIT":return ah.error(eB("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(j){return function(T){return ah.error(j.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return j.show_error_unreachable();case"BADCARRIER":return j.show_error_bad_carrier();case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return j.show_error_not_a_mobile();case"RATELIMIT":return ah.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":j._current_flow.to_state("password");return j.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:eB("Enable two-step verification"),DEFAULT_EDIT_TITLE:eB("Edit two-step verification"),DEFAULT_DISABLE_TITLE:eB("Disable two-step verification"),ADD_BACKUP_TITLE:eB("Add a backup phone number"),EDIT_BACKUP_TITLE:eB("Edit backup phone number"),EDIT_RECOVERY_TITLE:eB("View recovery code"),ADD_SECURITY_KEY_TITLE:eB("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var i;this.hide_error();bF("#twofactor-recovery").removeClass("edit-mode");i=$("twofactor-enter-password");bF("#password",i).val("").focus();return false},submit_password:function(T,fp,i,fn,fo){var j;j=$("password").getValue();if(!j){this.show_error(eB("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(T,{parameters:{password:j},onSuccess:(function(fq){return function(fr){var fs;fs=fr.responseText.strip();if(fs.startsWith("OK:")){fq._checkpoint_token=fs.substr(3);return fp(i,fn)}else{switch(fs){case"EXPIRED_PASSWORD":return fq.show_error_expired_password();case"INVALID":return fq.show_error(eB("Invalid password"));case"RATELIMIT":return fq.show_error(eB("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ah.success(eB("Two-step verification is already enabled. Did you maybe enable it in another window?"));return fd.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eB("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fd.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(T){return function(fn){var fo;fo=fn.responseText.strip();if(fo.startsWith("OK:")){T.fill_key(fo.substr(3));return j.next()}else{switch(fo){case"EXPIRED":i.to_state("password");return T.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(j){var i,fn,T;j=j.replace(new RegExp("=+$"),"");i=j.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(i);$("qr-div").__date();T=Constants.IS_PROD?"Dropbox":"DropboxDev";fn={text:"otpauth://totp/"+T+":"+this._user.email+"?secret="+j+"&issuer="+T,width:200,height:200};if(!Modernizr.canvas){fn.render="table"}bF("#qr-div").qrcode(fn);if(!Modernizr.canvas){return bF("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(j,fn,fo){var i,T;i=bF("#twofactor-enter-phone .twofactor-phone-number");if(!C.controller(i).validate_on_submit()){return}T=i.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:T},onSuccess:(function(fp){return function(fq){switch(fq.responseText.strip()){case"OK":fp._phone_number=T;j.vars.phone_number=T;return fn.next();case"EXPIRED":j.to_state("password");return fp.show_error_expired();case"UNREACHABLE":return fp.show_error_unreachable(i);case"BADCARRIER":return fp.show_error_bad_carrier(i);case"INVALIDNUMBER":return fp.show_error_invalid_number(i);case"NOTAMOBILE":return fp.show_error_not_a_mobile(i);case"RATELIMIT":return fp.show_error(eB("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(i,j,fn){var T;T=$("phone-code").getValue().strip();if(!T){this.show_error(eB("Please enter the security code"));return}if(T.search(/^\d{6}$/)===-1){this.show_error(eB("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:T,use_json:true},onSuccess:(function(fo){return function(fp){var fr,fq;fq=JSON.parse(fp.responseText.strip());if(fq.result==="OK"){fo.fill_recovery_codes(fq.codes,"backup-code-list");return j.next()}else{switch(fq.result){case"INVALID":fo._invalid_code_count+=1;fr=fo._invalid_code_count<=2?eB("Invalid code"):fo._is_offline_setup?eB("Invalid code. Check the clock on your phone: it must be accurate to the minute."):eB("Invalid code");return fo.show_error(fr);case"EXPIRED":i.to_state("password");return fo.show_error_expired();case"RATELIMIT":return fo.show_error(eB("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(fn,j){var T,i;this.hide_error();T=$("twofactor-enter-backup-phone");i=this.fill_phone_number_for_edit(T,bF("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());i.focus();if(fn==="back_next"){bF("#twofactor-backup-back-next").show();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").hide()}else{if(fn==="cancel_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").show();return bF("#twofactor-backup-back-save").hide()}else{if(fn==="back_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fo,fn,j,fp,fq){var i,T;i=bF("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!C.controller(i).validate_on_blur()){return}T=i.val();if(T){if(this.is_primary_number(T)){C.controller(i).show_error(eB("You can't use your primary phone as your backup",i));return}}else{if(fo){C.controller(i).show_error(eB("Please enter phone number",i));return}}this._backup_phone=T;if(fn==="save_backup_phone"){this.save_added_backup_phone(j,fo,T)}else{if(fn==="save_everything"){this.submit_finish(false,j,fp,fq)}else{if(fn==="save_none"){return fp.next()}}}},is_same_phone_number:function(j,i){if(!j||!i){return false}return j.replace(/\D+/g,"")===i.replace(/\D+/g,"")},is_primary_number:function(i){var j;j=bF("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this._phone_number){return this.is_same_phone_number(i,this._phone_number)}else{if(this.is_same_phone_number(i,j.data("primary_phone"))){return true}if(this.is_same_phone_number(i,bF("#twofactor-sms-number",j).text())){return true}}return false},save_added_backup_phone:function(i,T,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:j},onSuccess:(function(fn){return function(fo){var fp;switch(fo.responseText.strip()){case"OK":fn.hide_error();fp="#twofactor-row-"+fn._user.role;bF(fp+" #twofactor-backup-number").text(j);bF(fp).toggleClass("with-backup",!!j);if(!j){ah.success(eB("Backup phone number removed"))}else{if(!T){ah.success(eB("Backup phone number updated"))}else{ah.success(eB("Backup phone number added"))}}return fd.hide();case"EXPIRED":i.to_state("password");return fn.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(T,fn){var i,j;j=bF("input.text-input-input",T);if(!fn){return j.val("")}i=C.controller(bF(".phone-number-input",T));i.set(fn);j.val(i.get_local_number());if(j.length){j[0].select()}bF("#twofactor-backup-back-save").find("#skipstep").hide();bF(".text-input-wrapper").find("label").hide();return j},fill_delivery_choice:function(i){bF("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!i);bF("#twofactor-delivery-offline-label").toggle(!i);bF("#confirm-phone-primary-number").text(i);return bF("#twofactor-row-"+this._user.role).data("primary_phone",i)},fill_backup_phone:function(i){bF("#confirm-phone-backup").toggle(!!i);return bF("#confirm-phone-backup-number").text(i)},insert_spaces_into_code:function(i){return i.toLowerCase().replace(/(.{4})/g,"$1 ")},fill_recovery_codes:function(j,fp){var fs,fn,T,fq,ft,fr,fo;fs=bF("#"+fp);fs.empty();T=j[0].length;if(T===16){fs.css("column-count","1")}fr=[];for(fq=0,ft=j.length;fq<ft;fq++){fn=j[fq];fo=bF("<li/>",{"class":"twofactor-backup-list__item"});fr.push(fs.append(fo.append(bF("<span/>",{"class":"twofactor-backup-list__code",text:this.insert_spaces_into_code(fn)}))))}return fr},submit_finish:function(j,i,T,fn){var fo;this.show_loading();fo={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!j){fo.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fo,onSuccess:(function(fp){return function(fq){switch(fq.responseText.strip()){case"OK":fp.successfully_enabled=true;if(i.vars.mode!=="ENABLE"){return fp.after_enabled(i,T)}else{return T.next()}break;case"EXPIRED":i.to_state("password");return fp.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(j,fn){var i,T;this._checkpoint_token=null;this.hide_error();i=bF("#twofactor-row-"+this._user.role);i.toggleClass("with-sms",!!this._phone_number);bF("#twofactor-sms-number",i).text(this._phone_number||"");i.toggleClass("with-backup",!!this._backup_phone);bF("#twofactor-backup-number",i).text(this._backup_phone||"");i.addClass("twofactor-enabled");bF("tr[id^='session_row_']").slice(1).hide();if(j.vars.mode!=="ENABLE"){T="/account/#security";ah.success(new fi(eB('Two-step verification updated. Any <a href="%(path)s">existing sessions, devices and apps</a> can still access your Dropbox.').format({path:T})));return fn!=null?fn.next():void 0}},disable_submit:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(T){return function(fo){var fn;switch(fo.responseText.strip()){case"OK":T.successfully_disabled=true;T._checkpoint_token=null;fn=bF("#twofactor-row-"+T._user.role);fn.removeClass("twofactor-enabled with-sms with-backup");bF(document).trigger("security-key-manager:UPDATE_KEYS",T._user.id);bF("#twofactor-sms-number, #twofactor-backup-number",fn).text("");bF("tr[id^='session_row_']").slice(1).hide();ah.success(eB("Two-step verification is now disabled."));return j.next();case"EXPIRED":i.to_state("password");return T.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(T,i){var j;if(i){C.controller(i).show_error(T);return}j=$$(this._error_selector);if(T===this.error_expired_password()||T===this.error_unreachable(true)){j.invoke("update",T)}else{j.invoke("__date",T)}return j.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(i){return this.show_error(this.error_bad_carrier(),i)},show_error_invalid_number:function(i){return this.show_error(this.error_invalid_number(),i)},show_error_not_a_mobile:function(i){return this.show_error(this.error_not_a_mobile(),i)},show_error_unreachable:function(i,j){if(j==null){j=false}return this.show_error(this.error_unreachable(j),i)},show_error_expired:function(i){return this.show_error(this.error_expired(),i)},show_error_expired_password:function(i){return this.show_error(this.error_expired_password(),i)},error_500:function(){return eB("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return eB("Unfortunately, your carrier isn\u2019t supported at this time.")},error_invalid_number:function(){return eB("That isn\u2019t a valid phone number.")},error_not_a_mobile:function(){return eB("That phone number doesn\u2019t appear to be a valid mobile number.")},error_unreachable:function(i){if(i==null){i=false}if(i){return eB('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return eB("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return eB("Since it's been a while, please enter your password again.")},error_expired_password:function(){return eB('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ah.success(eB("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(j){var i,T;i=j.element();T=bF(".sick-input",i.form);bF("input",T).val("").focus();return this.fill_example_phone_number(i,T)},fill_example_phone_number:function(i,fn){var T,j;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){T=bF(i).val().substr(1);j=phone_helpers.get_example_mobile_number(T);return bF("label",fn).text(eB("Example: ")+j)}},reset_phone_field_and_backup_country:function(j){var i;this.reset_phone_field(j);if(bF("#backup-phone-number").val()===""){i=bF("#twofactor-enter-backup-phone #country-code");i.val(j.element().getValue());return this.fill_example_phone_number(i,bF(".sick-input",i[0].form))}}};var n,cT=[].indexOf||function(fn){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fn){return T}}return -1};n=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=E.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aX.FileViewModeType.UNKNOWN,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new ax(),_is_browse_drag_enabled:null,_file_view_attempts:0,globalPreviewStateModel:new el.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new el.Model({state:"hidden",file_extension:null}),_get_extension:function(j){var i;i=j.lastIndexOf(".");return(i===-1?"":j.substr(i+1))},_get_preview_type_from_extension:function(T){var j,i;j=T.substring(0,3);if(j==="rtf"||j==="odt"){i="doc"}else{if(j==="pps"){i="ppt"}else{i=j}}return i},_file_view_mode_is_browse:function(){var i;return i=this.file_view_mode,cT.call(aX.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,i)>=0},_file_view_mode_is_shared_or_member_link:function(){var j,T,i;j=aX.FileViewModeCategories;return(T=this.file_view_mode,cT.call(j.SHARED_LINK_FILE_VIEW_MODE_TYPES,T)>=0)||(i=this.file_view_mode,cT.call(j.MEMBER_LINK_FILE_VIEW_MODE_TYPES,i)>=0)},show:function(fn,i,T,j){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fp,T,fo,fn){var fq,j,i;if(fo==null){fo={}}fo=bx.defaults(fo,{files:[],force_file_unlocked:true,file_view_mode:aX.FileViewModeType.UNKNOWN,should_focus_comment_input:false,hide_comments:false,hide_restore:false});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=bF.proxy((function(){return !this.shown()}),this)}i=bF("#file-viewer");if(this.hiding){i.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{i.hide()}}fq=i.find(".file-viewer-comment-container");if(fo.hide_comments){fq.hide()}else{fq.show()}j=i.find(".restore-button");if(j.length){if(fo.hide_restore){j.hide()}else{j.show()}}this.file=fp;this.active_user=T;this.flippable_files=this._filterFlippableFiles(fo.files);this.file_view_mode=fo.file_view_mode;this.should_focus_comment_input=fo.should_focus_comment_input;this.total_files=fo.files.length;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{C.scroll_lock_document();i.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,fo.force_file_unlocked,fn)}},_getFilesToPreloadActivities:function(){var fn,fr,fp,fs,fo,T,fq;fr=[];fn=this.currentFlippableFileIndex();fq=[1,2,3,4,5,6,-1,-2];for(fo=0,T=fq.length;fo<T;fo++){fp=fq[fo];fs=fn+fp;if((0<=fs&&fs<this.flippable_files.length)){fr.push(this.flippable_files[fs])}}return fr},load:function(T,fp,j){var i,fo,fn;if(fp==null){fp=false}this.file=T;document.title=this.file.filename;i=bF("#file-viewer");if(i.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(fp){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}bF(document.activeElement).blur();this._render_viewer();fn=this.modal_type===this._MODAL_FILEINFO;fo=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,fn,j,fo])},_filterFlippableFiles:function(j){var i;return(function(){var fn,T,fo;fo=[];for(fn=0,T=j.length;fn<T;fn++){i=j[fn];if(d5.isFlippable(i.preview_type)){fo.push(i)}}return fo})()},currentFlippableFileIndex:function(){var fp,fo,fn,T,fq;fq=this.flippable_files;for(fo=fn=0,T=fq.length;fn<T;fo=++fn){fp=fq[fo];if(this.file.sjid===fp.sjid){return fo}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var fr,fo,fn,fq,T,j,fp,i;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;T=0;i=this.active_user.id;fp=this.file.fq_path;j=1000;fq=(function(fs){return function(){T++;if(T<fs.MAX_CHECK_LOCK_TRIES){if(T===2){INLINE_JS.Notify.warning(eB("Office Online is saving your file."))}else{if(T===5){INLINE_JS.Notify.warning(eB("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fs.check_lock_timeout=setTimeout(fr,j);return j=j*2}else{clearTimeout(fs.check_lock_timeout);fs.check_lock_request=null;fs.file_locked=false;return fs._render_preview(true,true)}}})(this);fn=(function(fs){return function(ft){ft=JSON.parse(ft);if(ft!=null?ft.has_lock:void 0){return fq()}else{fs.check_lock_request=null;fs.file_locked=false;return fs._render_preview(true,true)}}})(this);fo=function(fu,fs,ft){return fq()};fr=(function(fs){return function(){return fs.check_lock_request=cE.WebRequest({url:"/ow/msft/check_lock",data:{user_id:i,fq_path:fp},success:fn,error:fo})}})(this);return fr()},shown:function(){return bF("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(i){return function(){return i.set_preview_url()}})(this),250)},set_preview_url:function(){var T,j,i;T=G.parse(eE.get_url());j=T.getPath();i=T.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eE.push_state(G.encode_parts(j),i,{immediatelyRestoreState:false})},unset_preview_url:function(){var T,j,i;this.clear_preview_url_timer();T=G.parse(eE.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(T.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in T.getQuery())){return}j=T.getPath();i=T.removeQuery("select").removeQuery("preview").getQuery();return eE.push_state(G.encode_parts(j),i)},render_file_failed:function(){var i,j;j=this.file;i=this.active_user;this._teardown_and_hide();j.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(j,i,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,should_focus_comment_input:this.should_focus_comment_input});bF("#file-viewer").show();return bF("#file-viewer").trigger("preview_failed")},_log_view:function(i,j,fn){var T;if(fn==null){fn=aX.FileViewModeType.FILE_PREVIEW}this._file_view_attempts++;T={user_id:this.active_user.id,context:aX.FileViewContextType.PRIVATE,platform:aX.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,shared_link_url:null,extra:{mode:fn,file_ext:aA.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:i,in_progress:j,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return ba.FileViewLogger.log(T)},preload_office_static:function(j){var fn,T,i;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}T=this._get_extension(j);if(T in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){fn=bF("#file-viewer .open-with-static-content-container");i=bF("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[T]});return fn.html(i)}},unload_office_static:function(){var i;i=bF("#file-viewer .open-with-static-content-container");return i.empty()},_render_viewer:function(){var fr,j,fu,fv,fn,fx,i,fw,ft,fy,fo,T,fp,fs,fq;j=bF("#file-viewer");fr=j.find(".download-button");fv=G.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);fs=(function(fz){return function(fG){var fC,fE,fB,fA,fD,fF;if(fG==null){fG=true}fA=bU.em_snippet(fz.file.filename,35);fC=j.find(".title-bar .filename");fF={"class":"icon",alt:fz.file.caption};fD=cx.html("web",fz.file.icon,fF).toHTML();fE=bF("<span />",{"class":"filename-text"}).text(fA);fC.html(fD).append(fE);j.addClass("has-preview");if(cM.get_viewer().is_team_assume_user_session){j.addClass("room-for-team-assume-user-top-bar")}if(fz.file.htmlified_link){j.addClass("htmlified-preview")}else{if(fz.file.preview_type==="excel"){j.addClass("html-preview");j.find(".loading").css("z-index","-1")}else{j.addClass(fz.file.preview_type+"-preview")}}if(fG){j.find(".loading").show()}fr.on("click",function(fH){fH.preventDefault();return window.location.href=fv});if(fz.file.tkey===void 0&&n.active_user.is_email_verified){fB=function(fH){this.file.tkey=fH.tkey;return this._update_title_bar_buttons()};cE.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fz.file.fq_path},dataType:"json",subject_user:fz.active_user.id,success:fB.bind(fz)})}else{fz._update_title_bar_buttons()}fz.modal_type=fz._MODAL_PREVIEW;fz._first_render_completed=false;return fz._listen()}})(this);fx=(function(fz){return function(){j.removeClass();j.find(".loading").hide();return fz._unlisten()}})(this);fp=(function(fz){return function(fA,fF,fD,fC,fB){var fE;if(fA==null){fA=false}if(fF==null){fF=true}if(fD==null){fD=false}if(fC==null){fC=false}if(fB==null){fB=true}fz._log_view(Date.now()-fz._start_time,fC,aX.FileViewModeType.FILE_PREVIEW);fE=fz._get_extension(fz.file.filename);if(fE==="doc"||fE==="docx"||fE==="odt"||fE==="ppt"||fE==="pptx"||fE==="xls"||fE==="xlsx"||fE==="pdf"||fE==="eps"||fE==="ai"||fE==="psd"||fE==="svg"||fE==="txt"||fE==="rtf"||fE==="pspimage"||fE==="tif"||fE==="tiff"||fE==="yuv"||fE==="url"||fE==="webloc"||fE==="website"||fE==="wopitest"){fz.globalPreviewStateModel.set({state:"open",file_obj:fz.file})}if(!fA){fs(fF);fz._update_title_bar_buttons()}fz._render_preview(fD,fB);return fz._initial_resize()}})(this);T=(function(fz){return function(fB){var fA,fD,fE,fC;if(fB==null){fB=false}fA=fz.file.filename.indexOf(".");fD=fz.file.filename.substring(fA+1);if(fD==="key"&&fz.file.preview_type===null){fC="/static/images/icons128/"+(aA.file_icon("_other"))+".png"}else{fC="/static/images/icons128/"+(aA.file_icon(fz.file.filename))+".png"}fz.globalPreviewStateModel.set({state:"closed",file_obj:null});fE=bU.em_snippet(fz.file.filename,20);j.find(".title-bar .filename").text(fE);j.addClass("no-preview");j.find(".file-thumbnail img").attr({src:fC});j.find(".file-type").text(fE);j.find(".file-size").text(fz.file.size);j.find(".file-modified").text(fz.file.ago||"");fr.on("click",function(){return b1.unsafeRedirect(fv)});fz.modal_type=fz._MODAL_FILEINFO;fz._listen();fz._log_view(Date.now()-fz._start_time,fB,aX.FileViewModeType.FILE_INFO);fz._update_title_bar_buttons();return fz._initial_resize()}})(this);fn=this._get_extension(this.file.filename);fy=((fo=this.file.preview_type)==="doc"||fo==="excel"||fo==="keynote"||fo==="adobecs"||fo==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||aA.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!b1.msie_version_at_most(9);this.has_preview=d5.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fy&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked));i=fy&&this._preview_progressive_try(fn)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||i){return fp(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fw=this.file_locked||(fy&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fw){return T()}fs();ft=G({path:"/doc_preview_status"+this.file.fq_path}).toString();fq=Date.now();return(fu=(function(fz){return function(){var fA;fA=Date.now();if(fA-fq>=5000){setTimeout(bF.proxy(fz.render_file_failed,fz),0);return}return fz.preview_status_request=bF.ajax(ft,{success:function(fB){if(fz.file){return fz.file.doc_preview_status=parseInt(fB,10)}},complete:function(fB,fC){if(fC==="abort"){return}if(fz.file_locked){return}if(fz.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fz.has_preview=true;return fp(true,false,true,true)}else{if(fz.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fz.preview_status_timeout_obj=setTimeout(fu,1000)}else{fz.render_file_failed()}}},timeout:5000-(fA-fq),subject_user:fz.active_user})}})(this))()},switch_preview:function(T,j,fp,fq){var fo,fn,i;if((T!=null)||(j!=null)){if(this.file!=null){this.annotation_enabled_for_this_revision=fp;if(T!=null){this.file.href=T}if(j!=null){this.file.direct_blockserver_link=j}fo=bF("#file-viewer .preview-content-container");if(this.file.preview_type==="photo"){if((fn=this._preview_flippable_component)!=null?fn.isMounted():void 0){return this._preview_flippable_component.setProps({"thumbnail-url-tmpl":T,onLoad:fq})}}else{i="";fo.html(i);return this._render_preview(false,true,fq)}}}},_remove_loading:function(i){var j;if(i==null){i=true}j=bF("#file-viewer .loading");j.hide();j.css("z-index","");return this.is_loaded=i},_render_blank:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dC.createElement(H,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dC.render(i,j.get(0))},_render_linkfile:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dC.createElement(S,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dC.render(i,j.get(0))},_update_title_bar_buttons:function(){var T,j,ft,fD,fy,fs,fw,fz,fH,fu,fv,fp,fn,i,fB,fq,fo,fF,fG,fr,fA,fx,fC,fE,fI;fs=bF("#file-viewer");fy=fs.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fy.remove()}T=fs.find(".download-button");j=fs.find(".split-button.openwith");fD=j!=null?j.find(".main-button"):void 0;ft=j!=null?j.find(".more-button"):void 0;fH=eB("Open",{comment:"Open a file natively on the user's computer"});fz=function(){return fs.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};fw=(function(fJ){return function(fL){var fM,fK;return fs.data("is-openwith-allowed")==="True"&&((fM=__CONDITIONAL_JS__.OpenWith)!=null?fM.get_open_handler_for(fL,fJ.active_user):void 0)&&fL.bytes<((fK=__CONDITIONAL_JS__.OpenWith)!=null?fK.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fL.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fF=(function(fJ){return function(fK){return __CONDITIONAL_JS__.UnityFeatures.open_file(fJ.file.ns_id,fJ.file.ns_path,fJ.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fL){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fK)}})(this);fq=function(){return fF(false)};fo=function(){return fF(true)};fG=(function(fJ){return function(){var fL,fK,fM;fL=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fJ.file,fJ.active_user);if(fL){if((fM=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fM.log_open_button_pressed(fJ.active_user.id,aA.file_extension(fJ.file.filename).toLowerCase(),fJ.file.ns_id,fJ.file.ns_path)}fK=fL.uri+"?hpt_click_ts="+Date.now();return b1.redirect(fK)}}})(this);fI=(function(fJ){return function(fR,fS,fK){var fO,fN,fT,fM,fL,fV,fP,fQ,fU;fU=[];fP=fS!=null;if(fP&&(fS.can_open_directly||(fS.can_open_directly==null))){fO=fS.open_application_name||eB("Open");fQ=eB("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fQ=eB("Open in %(app_name)s").format({app_name:fO})}fU.push({id:"ow_desktop",label:fQ,icon:"ow_desktop",callback:fq})}if(fR){fV=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fJ.file,fJ.active_user);fU.push({id:"ow_web",label:fV.name,icon:fV.icon,callback:fG})}if(fP&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fL=fS.file_browser_display_name||eB("File Browser");fQ=eB("Show in %(file_browser)s").format({file_browser:fL});if(fP&&!fS.can_open_directly&&!fR){fH=fQ}fU.push({id:"ow_folder",label:fQ,icon:"ow_folder",callback:fo})}fx(fH,fU);if(!fR&&!fP){fT=false}else{if(fP){fT=false}else{fT=true}}if(!fT&&!fK){fJ._hide_more_button()}else{fJ._show_more_button(fK,fT)}fN=function(fW,fY,fZ,fX){if(fJ._open_button_update_state_timeout){clearTimeout(fJ._open_button_update_state_timeout)}return fJ._open_button_update_state_timeout=setTimeout((function(){fJ.globalOpenWithWebButtonStateModel.set({user_id:fW,state:fY,file_extension:fZ,target_button:fX});return fJ._open_button_update_state_timeout=null}),200)};if(fR){fM=aA.file_extension(fJ.file.filename).toLowerCase();if(fP){return fN(fJ.active_user.id,"visible",fM,ft)}else{return fN(fJ.active_user.id,"visible",fM,fD)}}else{return fN(null,"hidden",null,null)}}})(this);fC=function(fJ){if(j!=null){j.toggleClass("shown",fJ)}return T.toggle(!fJ)};fx=function(fK,fJ){if(!(fJ instanceof Array)){fJ=[fJ]}if(fJ.length===0){return fC(false)}else{if(fJ.length===1){return fp(fK,fJ[0].callback)}else{return fn(fK,fJ)}}};fp=function(fJ,fK){if((j==null)&&(fD==null)){return}fC(true);j.removeClass("split");fD.text(fJ);return fD.off("click").on("click",fK)};fn=function(fP,fK){var fO,fN,fL,fJ,fM;if((j==null)&&(fD==null)&&(ft==null)){return}fC(true);j.addClass("split");fD.text(fP);fO=fs.find(".openwith-dropdown");fD.off("click").on("click",function(fQ){return fK[0].callback(fQ)});ft.off("click").on("click",function(fR){var fQ;fQ=bF(this).parent().siblings(".openwith-dropdown");if(fQ.is(":visible")){return}fQ.removeAttr("style");eU.show(fQ,this,null,true);return fR.stopPropagation()});fO.find("li").hide();fN=function(fQ){var fR;fR=fO.find("."+fQ.id);fR.find("a .sprite-text-inner").text(fQ.label);cx.src(fR.find("a .sprite")[0],"web",fQ.icon);fR.find("a").off("click").on("click",function(fS){fS.preventDefault();return fQ.callback(fS)});return fR.show()};for(fL=0,fJ=fK.length;fL<fJ;fL++){fM=fK[fL];fN(fM)}return bF("#file-viewer-container").off("click",eU.hide_all).on("click",eU.hide_all)};fE=!!fz();fu=!!fw(this.file);fv=!!this.file.tkey;fI(fu,null,fv);if(fE){i=function(fJ){var fK,fL;fL=function(fM){fJ.file_browser_display_name=fM;return fI(fu,fJ,fv)};fK=function(){return fI(fu,null,fv)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fL,fK)};if((fr=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fr.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return i((fA=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fA.get(this.file.ns_id,this.file.ns_path):void 0)}else{fB=function(fJ){if(fJ.is_locally_available){return i(fJ)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fB)}}},_show_more_button:function(fq,j){var fo,fp,T,fn,i;i=bF("#file-viewer");fo=i.find(".more-options-button");fo.show();T=i.find(".more-options-dropdown");fo.on("click",function(fr){if(T.is(":visible")){return}eU.show(T,fo,null,true);return fr.stopPropagation()});bF("#file-viewer-container").on("click",eU.hide_all);fn=T.find(".remove-link");fn.off("click");if(fq){fn.show();fn.on("click",(function(fr){return function(fs){eU.hide_all();return am.confirm_remove(fr.file.filename,fr.file.tkey,0,0,0,fr.file.user_id)}})(this))}else{fn.hide()}fp=T.find(".download-button");return fp.toggle(j)},_hide_more_button:function(){var j,i;i=bF("#file-viewer");j=i.find(".more-options-button");j.off("click").hide();bF("#file-viewer-container").off("click",eU.hide_all);return i.find(".remove-link").off("click")},_initial_resize:function(){var i;if(this.is_loaded){return}i=function(){return bF("window").trigger("resize")};return setTimeout(i,0)},_is_pptx_slim_enabled:function(){return az.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fo,fn){var fp,i,T,j;j=this.active_user;fo=this._get_preview_type_from_extension(fo);T=G.parse(fn);i=false;if(fo==="doc"||fo==="key"||fo==="keynote"||fo==="adobecs"){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){T=T.updateQuery({post_message_on_failure:1})}}else{if(fo==="ppt"&&!this._is_pptx_slim_enabled()){fp="private_progressive_viewer";i=true}else{if(fo==="xls"){if(j.xls_edit){fp="xls/edit"}else{fp="xls/preview"}}}}if(fp){if(i){T.setAuthority(Constants.WEBSERVER)}else{T.setAuthority(T.getAuthority().replace("dl-web","dl-doc"))}T.setPath(T.getPath().replace("/pri/get/","/get/"));T.setPath(T.getPath().replace("/get/","/"+fp+"/"))}T=T.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return T},_get_pdf_js_url:function(i){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){i=G.parse(Constants.static_url_pdfjs_viewer)}return i},_preview_is_progressive:function(i){i=this._get_preview_type_from_extension(i);return i==="doc"||i==="ppt"||i==="xls"||i==="key"||i==="keynote"||i==="eps"||i==="ai"},_preview_progressive_try:function(j){var T,i;if(!this._preview_is_progressive(j)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}j=this._get_preview_type_from_extension(j);T=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED;i=j==="key"||j==="keynote";return T||i},_set_previews_sandbox_params:function(j,i){j=this._get_preview_type_from_extension(j);if(j!=="xls"){return""}else{return null}},_prepare_annotation_url:function(i){if(this._is_annotation_marker_enabled()){i=i.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){i=i.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){i=i.updateQuery("annotation_region","1")}return i},_render_preview:function(fG,fD,fq){var fn,fr,fv,fE,fA,fo,fL,fH,fw,fC,fu,fJ,fF,fI,fK,ft,fB,T,fy,fs,fz,fx,fp;if(fG==null){fG=false}if(fD==null){fD=true}if(fq==null){fq=null}ft=(function(i){return function(){i._remove_loading();return typeof fq==="function"?fq():void 0}})(this);if(fG){this._remove_loading(false)}fB=bF("#file-viewer .preview-content-container");if(fB.find("iframe").length>0){return}if(this.file.htmlified_link){fw=bF("<iframe/>",{src:this.file.htmlified_link,sandbox:"allow-scripts allow-forms"});fB.append(fw);return fw.on("load",ft)}else{if(this.file.preview_type==="doc"){fv=this._get_extension(this.file.filename);fr=this._get_preview_type_from_extension(fv);if(fr==="ppt"&&!this._is_pptx_slim_enabled()){fp=this._get_progressive_url(fv,this.file.href);fw=bF("<iframe/>",{src:fp.toString(),allowfullscreen:"",type:"application/pdf"});fB.append(fw)}else{if(az.getGandalfRule("security-primodel")){fp=this._get_progressive_url(fv,this.file.direct_blockserver_link)}else{fp=this._get_progressive_url(fv,this.file.href)}if(this.active_user.inline_commenting){bF("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});fp.setAuthority(fp.getAuthority().replace("dl-web","dl-doc"));fp.setPath(fp.getPath().replace("/get/","/dochax_private_commentless_preview/"));fA=fp.toString();fp=G.parse(Constants.static_url_pdfjs_hack_viewer);fp.setQuery({file:fA})}else{if(!fD){fp=fp.updateQuery({generate_preview:1});fp.setAuthority(fp.getAuthority().replace("dl-web","dl-doc"))}fJ=fr==="ppt"&&this._is_pptx_slim_enabled();fp.updateQuery("sjid",this.file.sjid);this._pdfLoader.openFile(fp,{presentationMode:fJ});fp=this._get_pdf_js_url()}fp=fp.updateQuery(a9.UID_PARAM_NAME,this.active_user);fp=this._prepare_annotation_url(fp);fw=bF("<iframe/>",{src:String(fp),type:"application/pdf"});fw.addClass("pdfjs");fB.append(fw)}return fw.on("load",ft)}else{if(this.file.preview_type==="html"){fw=bF("<iframe/>",{src:this.file.href,sandbox:""});fB.append(fw);return fw.on("load",ft)}else{if(this.file.preview_type==="excel"){if(az.getGandalfRule("security-primodel")){fp=this._get_progressive_url("xls",this.file.direct_blockserver_link)}else{fp=this._get_progressive_url("xls",this.file.href)}fw=bF("<iframe/>",{src:fp,sandbox:"allow-scripts allow-forms"});this._set_previews_sandbox_params("xls",fw);fB.append(fw);return fw.on("load",ft)}else{if(this.file.preview_type==="keynote"){fp=this._get_progressive_url("html",this.file.href);fp=fp.updateQuery({generate_preview:1});fp=fp.updateQuery({post_message_on_failure:1});fw=bF("<iframe/>",{src:fp,type:"text/html"});fB.append(fw);return fw.on("load",ft)}else{if(this.file.preview_type==="adobecs"){if(az.getGandalfRule("security-primodel")){fp=this._get_progressive_url("adobecs",this.file.direct_blockserver_link)}else{fp=this._get_progressive_url("adobecs",this.file.href)}fp=fp.updateQuery({generate_preview:1});this._pdfLoader.openFile(fp);fp=this._get_pdf_js_url();fp=fp.updateQuery(a9.UID_PARAM_NAME,this.active_user);fp=this._prepare_annotation_url(fp);fw=bF("<iframe/>",{src:String(fp),type:"application/pdf"});fw.addClass("pdfjs");fB.append(fw);return fw.on("load",ft)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{fn=this.currentFlippableFileIndex();fE=this._get_extension(this.file.filename);if(d5.isFlippable(this.file.preview_type)){bF("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fy=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?bt.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;fx=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"){if(fE==="gif"&&this.file.bytes<=Constants.MAX_GIF_FILE_SIZE_B){fL=G.parse(this.file.href).updateQuery({raw:1}).toString()}fx=this.file.thumbnail_url_tmpl;fC=[];fs=[1,2,3,4,5,6,-1,-2];for(fF=0,fI=fs.length;fF<fI;fF++){fH=fs[fF];fu=fn+fH;if(0<=fu&&fu<this.flippable_files.length){fC.push(this.flippable_files[fu].thumbnail_url_tmpl)}}}}fo={"preview-type":this.file.preview_type,"preview-url":fy,"thumbnail-url-tmpl":fx,gifUrl:fL,"file-extension":fE,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fC,index:fn,count:this.flippable_files.length,totalFiles:this.total_files,onPrevious:(function(i){return function(){return i.loadPreviousFlippable()}})(this),onNext:(function(i){return function(){return i.loadNextFlippable()}})(this),onLoad:ft,onError:(function(i){return function(){i._remove_loading()}})(this)};if((fz=this._preview_flippable_component)!=null?fz.isMounted():void 0){fK=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(fo)}else{T=dC.createElement(d5,fo);return this._preview_flippable_component=dC.render(T,fB.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(ft){var fs,fn,fq,fo,fr,fu,T,fp,i;fq=bF("#file-viewer .preview-content-container iframe");fp=[];for(fo=0,fr=fq.length;fo<fr;fo++){fn=fq[fo];i=fn.src;T="://";fu=i.indexOf(T);if(fu===-1){fs=i.indexOf("/")}else{fs=i.indexOf("/",fu+T.length)}if(fs!==-1){i=i.substring(0,fs)}fp.push(fn.contentWindow.postMessage(ft,i))}return fp},_watchFile:function(){if(!az.getGandalfRule("tap-to-refresh")){return}return this.subscription=aa.subscribe(this.file,this.active_user,this._onFileUpdate.bind(this))},_onFileUpdate:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}n.post_preview_message('{"action":"notify_sfj"}');return bc.when().then(function(){return ah.success(eB("Someone edited this file."))})},_unwatchFile:function(){if(!this.subscription){return}this.subscription.cancel();return delete this.subscription},loadPreviousFlippable:function(){var i;if(d5.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id,i])}},loadNextFlippable:function(){var i;if(d5.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id,i])}},_listen:function(){var j,i,T;j=bF("#file-viewer");this._pdfLoader.startListening();cN.addFileDragEnabledCheck(this._is_browse_drag_enabled);j.find(".js-close-button").on("click",bF.proxy(this._on_close,this));this._watchFile();if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(fn){return function(fo){if(eX.isFullscreen()||C.focus_in_input()||C.is_input(fo.target)){return}return fn._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(fn){return function(fo){return fn.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(fn){return function(fo){return fn.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){j.find(".share-button").on("click",bF.proxy(this._share,this));T=(function(fn){return function(fo){if(fn.file.fq_path.toLowerCase()===fo.memo.fq_path.toLowerCase()){fn.file.tkey=fo.memo.tkey;return fn._update_title_bar_buttons()}}})(this);i=(function(fn){return function(fo){if(fn.file.tkey===fo.memo.token){fn.file.tkey=null;return fn._update_title_bar_buttons()}}})(this);this.share_link_callback=T.bind(this);this.remove_link_callback=i.bind(this);document.observe(aH.LINKS_ADD,this.share_link_callback);document.observe(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){j.find(".share-button").on("click",bF.proxy(this._share,this))}}bF(window).on("resize",bF.proxy(this._resize,this));this.handleMessageFromChild=function(fn){switch(fn.action){case"failed":return n.render_file_failed();case"lock_preview":return n.preview_locked=true;case"unlock_preview":return n.preview_locked=false;case"toggle_preview_lock":return n.preview_locked=!n.preview_locked;case"hide_iframe":return n._teardown_and_hide();case"loaded":return n.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return n._handle_page_rendered(fn.parameters)}};this._frameMessenger=new eu();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bF.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(fn){if(n.preview_locked){return""}else{return void 0}}},_unlisten:function(){var i;i=bF("#file-viewer");this._pdfLoader.stopListening();i.off("click",bF.proxy(this._teardown_and_hide,this));cN.removeFileDragEnabledCheck(this._is_browse_drag_enabled);i.find("#file-viewer-container").off("click",function(j){return j.stopPropagation()});i.find(".js-close-button").off("click",bF.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){i.find(".share-button").off("click",bF.proxy(this._share,this));i.find(".download-button").off("click");bF(document).off("click",eU.hide_all);document.stopObserving(aH.LINKS_ADD,this.share_link_callback);document.stopObserving(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){i.find(".share-button").off("click",bF.proxy(this._share,this))}}bF(window).off("resize",bF.proxy(this._resize,this));key.setScope(this.prev_scope);return this._unwatchFile()},_resize:function(T){var j,i;if(!this._is_rams_ui()){j=bF("#file-viewer");i=j.find("#file-viewer-container").height()-(j.find(".title-bar").height()+1);j.find(".preview").height(i);return j.trigger("height-resize",{height:i})}},_share:function(i){ba.ShmodelUILogger.log("via-browse-file-viewer");i.preventDefault();if(az.getGandalfRule("simple-sharing")){return eG.createAndShowInbandModalFromFile(this.active_user,this.file)}else{return new dh(this.active_user.id,this.file.fq_path,"file_viewer").show()}},_on_close:function(i){i.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var i;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){eY.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){n.unset_preview_url()}C.scroll_unlock_document();i=bF("#file-viewer");return i.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(j){return function(){var fo,fn,T;if(eX.isFullscreen()){eX.exitFullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){T=eB("Download");fo=i.find(".download-button");fo.text(T);fo.off("click")}j._hide_more_button();i.removeClass("has-preview").removeClass("no-preview");fn=i.find(".preview-content-container");dC.unmountComponentAtNode(fn.get(0));j._preview_flippable_component=null;fn.empty();i.find(".file-thumbnail img").attr({src:""});i.find(".title-bar .filename").text("");i.attr({"class":""});j._unlisten();j._remove_loading();document.title=j._cached_browser_window_title;j._cached_browser_window_title=null;j.last_file=j.file;j.file=null;j.preview_locked=false;window.removeEventListener("message",j.preview_lock_listener);j.is_loaded=false;j.hiding=false;j.cancel_check_lock();i.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(i){var fn,fo,ft,fr,fu,fs,T,fp,fq;if(!this._first_render_completed){fn=aA.file_extension_for_logging(this.file.filename);fq=i.stats;fs=((T=this.file)!=null?T.bytes:void 0)!=null?this.file.bytes:0;fr=bF.extend(i.attributes,{total_time:Date.now()-this._start_time,file_ext:fn,source:"file-viewer",originalSize:fs,docPreviewStatus:this.file.doc_preview_status});for(fo=0,ft=fq.length;fo<ft;fo++){fp=fq[fo];fu=(function(){switch(fp.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fr[fu]=fp.end-fp.start}ba.UserActivityLogger.log("web","file_view_first_page_rendered",fr);ba.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:fn,extra:JSON.stringify(fr)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},_is_annotation_marker_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return bF("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return bF("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"}};var dZ;dZ=E.Index2={init:function(ft,fo){var fr,fu,fs,j,T,fp,fv,fq,i;if(fo){bF("#sign-in").on("click",function(fA){var fn,fy,fx,fw,fz;fA.preventDefault();fx=bF("#sign-in-form");fd.show(eB("Sign in"),fx[0],false,false,416,false,"sign-in-modal");fy=fx.find("#login_email");fy.focus();return new b8(fn=fy,fz=function(){fx.find("#password-field").hide();fx.find("#remember-me").hide();fx.find("#login_submit").val(eB("Continue"));fx.find("#forgot_password_link").hide();return fx.find("#sso_description_footer").show()},fw=function(){fx.find("#password-field").show();fx.find("#remember-me").show();fx.find("#login_submit").val(eB("Sign in"));fx.find("#forgot_password_link").show();return fx.find("#sso_description_footer").hide()})})}fr=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF.when(bF("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bF("#signup-container").addClass("form_shown");return bF("#signup-container .text-input input:visible").first().focus()})}};if(!ft){bF(".register").find(".login-button").on("click",function(fn){if(!bF("#signup-container").hasClass("form_shown")){fn.preventDefault();return fr()}});dZ.animate()}else{bF(".photo").show()}fu=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF(".register").find(".login-button").trigger("click")}};bF(".buttons .freshbutton-blue").on("click",function(fn){fn.preventDefault();bF("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:fu});return false});bF("#learn-more").on("click",function(fn){fn.preventDefault();bF("html, body").animate({scrollTop:bF("#divider").offset().top},{queue:false,duration:500});return false});if(bw.are_enabled()){ba.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ah.error(eB("Please enable browser-cookies to use the Dropbox website."))}i=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];fs=function(fn){return bF(fn).on("click",function(){return ba.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fn})})};for(T=0,fp=i.length;T<fp;T++){j=i[T];fs(j)}fq=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];fv={};return bF(window).scroll(function(){var fB,fC,fA,fy,fw,fn,fx,fz;fz=[];for(fn=0,fx=fq.length;fn<fx;fn++){fA=fq[fn];if(bF(fA).length&&!fv[fA]){fC=bF(window).scrollTop();fB=fC+bF(window).outerHeight();fw=bF(fA).offset().top;fy=fw+bF(fA).outerHeight();if(fy<=fB){ba.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fA});fz.push(fv[fA]=true)}else{fz.push(void 0)}}else{fz.push(void 0)}}return fz})},_animate_points:function(fs,ft,fu,fn,fw,fr,T){var fp,fo,fq,fv;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fq=fr(T);fv=[(function(){var i,fx,j;j=[];for(fp=i=0,fx=ft.length;0<=fx?i<fx:i>fx;fp=0<=fx?++i:--i){j.push([(function(){var fy,fz;fz=[];for(fo=fy=0;fy<2;fo=++fy){fz.push(ft[fp][fo]+(fu[fp][fo]-ft[fp][fo])*fq)}return fz})()])}return j})()];fs.attr("points",dZ.points_array_to_str(fv));if(T>=1){return fw.resolve()}else{return setTimeout(function(){return dZ._animate_points(fs,ft,fu,fn,fw,fr,T+(10/fn))},10)}},animate_points:function(j,fq,fp,T,fo,fn){var i;if(fn==null){fn=jQuery.easing.linear}i=bF.Deferred();dZ._animate_points(j,fq,fp,T,i,fn);return i.done(function(){return typeof fo==="function"?fo():void 0}).promise()},animate_hide_rects:function(fo,fs,ft){var T,fq,fp,j,fr;T=bF.Deferred().resolve().promise();fq=function(fn){var fy,fv,fx,fu,fw;fu=bF(fo[fn]);fy=dZ.points_str_to_array(fu.attr("points"));fw=[fy[1],fy[1],fy[2],fy[2]];fv=dZ.inverse(jQuery.easing.linear);fx=fs*(fv((fn+1)/fo.length)-fv(fn/fo.length));return T=T.then(function(){return dZ.animate_points(fu,fy,fw,fx)})};for(fp=j=0,fr=fo.length;0<=fr?j<fr:j>fr;fp=0<=fr?++j:--j){fq(fp)}return T.done(function(){return typeof ft==="function"?ft():void 0}).promise()},animate_delay:function(j){var i;i=bF.Deferred();setTimeout(i.resolve,j);return i.promise()},animate:function(){return bF.Deferred().resolve().promise().then(function(){return dZ.animate_docs()}).then(function(){return dZ.animate_graphs()}).then(function(){return dZ.animate_photos()})},inverse:function(j,i){if(i==null){i=0.000001}return function(fp){var fn,fo,T;fo=0;fn=1;while(fn-fo>i){T=(fo+fn)/2;if(j(T)<fp){fo=T}else{fn=T}}return fo}},points_str_to_array:function(fr){var fo,T,j,fq,fp,fn;fp=fr.split(" ");fn=[];for(T=0,j=fp.length;T<j;T++){fq=fp[T];fn.push((function(){var i,fu,fs,ft;fs=fq.split(",");ft=[];for(i=0,fu=fs.length;i<fu;i++){fo=fs[i];ft.push(parseFloat(fo))}return ft})())}return fn},points_array_to_str:function(j){var i;return((function(){var fn,T,fo;fo=[];for(fn=0,T=j.length;fn<T;fn++){i=j[fn];fo.push(i.join(","))}return fo})()).join(" ")},animate_docs:function(){var fq,fn,i,fo,T,fp,j;j=[[5,6],[177,1],[184,157],[13,180]];i="";for(fp=fn=0.475;fn<=0.625;fp=fn+=0.05){fq=fp+0.05;fo=[[j[0][0]+(j[3][0]-j[0][0])*fp,j[0][1]+(j[3][1]-j[0][1])*fp],[j[1][0]+(j[2][0]-j[1][0])*fp,j[1][1]+(j[2][1]-j[1][1])*fp],[j[1][0]+(j[2][0]-j[1][0])*fq,j[1][1]+(j[2][1]-j[1][1])*fq],[j[0][0]+(j[3][0]-j[0][0])*fq,j[0][1]+(j[3][1]-j[0][1])*fq]];fo=dZ.points_array_to_str(fo);i+="<polygon points='"+fo+"' style='fill:#f5f9fc;stroke:none;' />"}T=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+i+"\n</svg>");return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".comp.doc").append(T);return bF(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dZ.animate_hide_rects(T.find("polygon"),2500,function(){return T.remove()})}).then(function(){return dZ.animate_delay(500)}).then(function(){return bF(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dZ.animate_delay(1500)}).then(function(){return bF(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var j,i;j=[[83,98],[158,37],[241,77],[171,145]];i=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');i.find("polygon").attr("points",dZ.points_array_to_str(j));return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".tablet.graph .graph-grid").hide();bF(".tablet.graph").append(i);return bF(".tablet.graph").show("fade",{},500).promise()}).then(function(){var T;T=[j[0],j[1],j[1],j[0]];return dZ.animate_points(i.find("polygon"),j,T,600,function(){return i.remove()})}).then(function(){if(!b1.msie_version_at_most(8)){return bF(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dZ.animate_delay(500)}).then(function(){return bF(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dZ.animate_delay(2000)}).then(function(){return bF(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bF(".phone.photo").show();return bF.when((function(){if(!b1.msie_version_at_most(8)){return bF(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bF.Deferred().resolve().promise().then(function(){return bF(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dZ.animate_delay(750)}).then(function(){return bF(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var bB,co,eP;eP=E.UnsupportedBrowser={init:function(){return bF("#unsupported-browser-dismiss").on("click",function(i){i.preventDefault();e9.hide();return bF.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};co=E.ExpiredCCNotificationBar={init:function(i){return bF(".expired-dismiss").on("click",function(j){j.preventDefault();e9.hide();return bF.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:i}})})}};bB=E.BetaLocaleNotificationBar={init:function(i){return bF(".beta-locale-dismiss").on("click",function(j){j.preventDefault();e9.hide();return bF.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:i}})})}};var e;e=INLINE_JS.viewer=cM.get_viewer();var L,ez,ey,b4,O,cd,e3,bD;if(!Constants.is_test){bF(eR.check_timezone)}if(window._document_observe_listeners){e3=window._document_observe_listeners;for(ez=0,b4=e3.length;ez<b4;ez++){cd=e3[ez];if(document.loaded){cd.func()}else{document.observe(cd.event,cd.func)}}}if(window._jquery_ready_handlers){bD=window._jquery_ready_handlers;for(ey=0,O=bD.length;ey<O;ey++){L=bD[ey];bF(L)}}bF(function(){return Event.fire(document,"script:loaded")});return E});